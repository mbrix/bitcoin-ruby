<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Bitcoin-ruby</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.7.1/application.js' type='text/javascript'></script>    
    <link href='./assets/0.7.1/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.7.1/favicon_yellow.png" />
    <link rel="icon" type="image/png" href="./assets/0.7.1/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.7.1/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2013-06-28T06:43:53+02:00">2013-06-28T06:43:53+02:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="yellow">84.11%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         389.43
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>31</b> files in total.
    <b>3524</b> relevant lines. 
    <span class="green"><b>2964</b> lines covered</span> and
    <span class="red"><b>560</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#6291547fade947731b570fd2a9162416476301a6" class="src_link" title="lib/bitcoin.rb">lib/bitcoin.rb</a></td>
        <td class="green strong">95.95 %</td>
        <td>631</td>
        <td>247</td>
        <td>237</td>
        <td>10</td>
        <td>4546.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6ad895c6fd6140cbd279d839c3cab431fd71d2a7" class="src_link" title="lib/bitcoin/builder.rb">lib/bitcoin/builder.rb</a></td>
        <td class="green strong">91.47 %</td>
        <td>275</td>
        <td>129</td>
        <td>118</td>
        <td>11</td>
        <td>1305.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2dcb72f38404c85bd4fe44aeed3d3b7e4562fc0c" class="src_link" title="lib/bitcoin/ffi/openssl.rb">lib/bitcoin/ffi/openssl.rb</a></td>
        <td class="green strong">97.14 %</td>
        <td>225</td>
        <td>140</td>
        <td>136</td>
        <td>4</td>
        <td>76.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb82939148b5de4151cdeacc2d9ed89caee32ee5" class="src_link" title="lib/bitcoin/key.rb">lib/bitcoin/key.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>179</td>
        <td>77</td>
        <td>77</td>
        <td>0</td>
        <td>87.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5d6d97008ffec5aff3bc91103ab60ec056c27d1" class="src_link" title="lib/bitcoin/logger.rb">lib/bitcoin/logger.rb</a></td>
        <td class="yellow strong">80.56 %</td>
        <td>68</td>
        <td>36</td>
        <td>29</td>
        <td>7</td>
        <td>36.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#021236b87a55c3912ce0a2591b4797a70dc78009" class="src_link" title="lib/bitcoin/namecoin.rb">lib/bitcoin/namecoin.rb</a></td>
        <td class="yellow strong">87.72 %</td>
        <td>122</td>
        <td>57</td>
        <td>50</td>
        <td>7</td>
        <td>32.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c2066d8e979ddb719a0b52c66f77f9345bb881e3" class="src_link" title="lib/bitcoin/network/command_client.rb">lib/bitcoin/network/command_client.rb</a></td>
        <td class="yellow strong">89.8 %</td>
        <td>92</td>
        <td>49</td>
        <td>44</td>
        <td>5</td>
        <td>38.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b871e365d6f70067f23b892e8c11e21927a1af95" class="src_link" title="lib/bitcoin/network/node.rb">lib/bitcoin/network/node.rb</a></td>
        <td class="red strong">30.4 %</td>
        <td>473</td>
        <td>250</td>
        <td>76</td>
        <td>174</td>
        <td>4.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#097a63ca9e1638fe6b84d7fad2f0982e08134c36" class="src_link" title="lib/bitcoin/protocol.rb">lib/bitcoin/protocol.rb</a></td>
        <td class="red strong">74.73 %</td>
        <td>154</td>
        <td>91</td>
        <td>68</td>
        <td>23</td>
        <td>458.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7232aa03263e2a301dcf3642c61bc0272ac13cbf" class="src_link" title="lib/bitcoin/protocol/address.rb">lib/bitcoin/protocol/address.rb</a></td>
        <td class="green strong">95.0 %</td>
        <td>50</td>
        <td>20</td>
        <td>19</td>
        <td>1</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7d06569f2eaac3f62f37ef5987a9d46ed2181b70" class="src_link" title="lib/bitcoin/protocol/alert.rb">lib/bitcoin/protocol/alert.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>46</td>
        <td>26</td>
        <td>26</td>
        <td>0</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#72c96e47888f7a4335d66634fcf4f59c7b9ac9a3" class="src_link" title="lib/bitcoin/protocol/aux_pow.rb">lib/bitcoin/protocol/aux_pow.rb</a></td>
        <td class="red strong">74.29 %</td>
        <td>123</td>
        <td>70</td>
        <td>52</td>
        <td>18</td>
        <td>3.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b85bdf561b3dc51ecfd89215f675dc4ae6ab50a3" class="src_link" title="lib/bitcoin/protocol/block.rb">lib/bitcoin/protocol/block.rb</a></td>
        <td class="green strong">91.2 %</td>
        <td>254</td>
        <td>125</td>
        <td>114</td>
        <td>11</td>
        <td>586.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec26a72c762bc13eda908614b56e96d8669a4d80" class="src_link" title="lib/bitcoin/protocol/handler.rb">lib/bitcoin/protocol/handler.rb</a></td>
        <td class="red strong">58.82 %</td>
        <td>39</td>
        <td>17</td>
        <td>10</td>
        <td>7</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#557ee148bb367f942116155fdc327b5fa7942241" class="src_link" title="lib/bitcoin/protocol/parser.rb">lib/bitcoin/protocol/parser.rb</a></td>
        <td class="red strong">73.79 %</td>
        <td>172</td>
        <td>103</td>
        <td>76</td>
        <td>27</td>
        <td>5.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#50420e37470493cafba8f41ed05b633a062fcdf4" class="src_link" title="lib/bitcoin/protocol/tx.rb">lib/bitcoin/protocol/tx.rb</a></td>
        <td class="green strong">94.63 %</td>
        <td>299</td>
        <td>149</td>
        <td>141</td>
        <td>8</td>
        <td>463.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1535735601f850f0edb630e497ee3ca0f6253a95" class="src_link" title="lib/bitcoin/protocol/txin.rb">lib/bitcoin/protocol/txin.rb</a></td>
        <td class="green strong">95.16 %</td>
        <td>120</td>
        <td>62</td>
        <td>59</td>
        <td>3</td>
        <td>675.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#925463098a998a603cae90a61e90032defc0f861" class="src_link" title="lib/bitcoin/protocol/txout.rb">lib/bitcoin/protocol/txout.rb</a></td>
        <td class="green strong">98.04 %</td>
        <td>94</td>
        <td>51</td>
        <td>50</td>
        <td>1</td>
        <td>1097.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#64138ab3345824464f68bf4ae98e60bd0dbb4ca8" class="src_link" title="lib/bitcoin/protocol/version.rb">lib/bitcoin/protocol/version.rb</a></td>
        <td class="green strong">96.77 %</td>
        <td>74</td>
        <td>31</td>
        <td>30</td>
        <td>1</td>
        <td>2.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9997f171293226ec441ccaa33d726c508ff07a39" class="src_link" title="lib/bitcoin/script.rb">lib/bitcoin/script.rb</a></td>
        <td class="green strong">96.7 %</td>
        <td>1052</td>
        <td>575</td>
        <td>556</td>
        <td>19</td>
        <td>428.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#029576e2a52c9778712ac74b945fbe9db0bb13e7" class="src_link" title="lib/bitcoin/storage/dummy/dummy_store.rb">lib/bitcoin/storage/dummy/dummy_store.rb</a></td>
        <td class="red strong">25.74 %</td>
        <td>166</td>
        <td>101</td>
        <td>26</td>
        <td>75</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a5b4193a8f28e1aea5ab2063c2b6e6b27fea99ad" class="src_link" title="lib/bitcoin/storage/models.rb">lib/bitcoin/storage/models.rb</a></td>
        <td class="green strong">90.7 %</td>
        <td>183</td>
        <td>86</td>
        <td>78</td>
        <td>8</td>
        <td>349.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f4cfbc683725977ffb9e47ff8ba1229a17889eca" class="src_link" title="lib/bitcoin/storage/sequel/migrations.rb">lib/bitcoin/storage/sequel/migrations.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>99</td>
        <td>64</td>
        <td>64</td>
        <td>0</td>
        <td>84.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ff9aba8fbeb1f6439118795d4ee25ca3db6c62bc" class="src_link" title="lib/bitcoin/storage/sequel/sequel_store.rb">lib/bitcoin/storage/sequel/sequel_store.rb</a></td>
        <td class="green strong">90.67 %</td>
        <td>503</td>
        <td>268</td>
        <td>243</td>
        <td>25</td>
        <td>419.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1e47ca20dcc1dba7324b2d0287e768352d49ee12" class="src_link" title="lib/bitcoin/storage/storage.rb">lib/bitcoin/storage/storage.rb</a></td>
        <td class="yellow strong">81.01 %</td>
        <td>304</td>
        <td>158</td>
        <td>128</td>
        <td>30</td>
        <td>50.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1d2f3285b72675d82f9d16bd6660cd2e089bdc3a" class="src_link" title="lib/bitcoin/validation.rb">lib/bitcoin/validation.rb</a></td>
        <td class="green strong">95.48 %</td>
        <td>365</td>
        <td>177</td>
        <td>169</td>
        <td>8</td>
        <td>143.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#45d4f28fae6f671f74cefe8a341bf4686a58205e" class="src_link" title="lib/bitcoin/wallet/coinselector.rb">lib/bitcoin/wallet/coinselector.rb</a></td>
        <td class="green strong">93.33 %</td>
        <td>33</td>
        <td>15</td>
        <td>14</td>
        <td>1</td>
        <td>13.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5b4d2b3b2b9a07acc2e0db4dcc389a361c4af330" class="src_link" title="lib/bitcoin/wallet/keygenerator.rb">lib/bitcoin/wallet/keygenerator.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>77</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>1086.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#02f674ef66c656bec0454c93dca59c930de55849" class="src_link" title="lib/bitcoin/wallet/keystore.rb">lib/bitcoin/wallet/keystore.rb</a></td>
        <td class="green strong">92.66 %</td>
        <td>206</td>
        <td>109</td>
        <td>101</td>
        <td>8</td>
        <td>24.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e4537349f04bf547cb5970d59edb474b2c135d28" class="src_link" title="lib/bitcoin/wallet/txdp.rb">lib/bitcoin/wallet/txdp.rb</a></td>
        <td class="yellow strong">83.53 %</td>
        <td>118</td>
        <td>85</td>
        <td>71</td>
        <td>14</td>
        <td>41.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5f86fc73b1d974c21d9992a33e59689fa75b4089" class="src_link" title="lib/bitcoin/wallet/wallet.rb">lib/bitcoin/wallet/wallet.rb</a></td>
        <td class="red strong">58.14 %</td>
        <td>261</td>
        <td>129</td>
        <td>75</td>
        <td>54</td>
        <td>4.9</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
          <div class="file_list_container" id="Bitcoin">
  <h2>
    <span class="group_name">Bitcoin</span>
    (<span class="covered_percent"><span class="green">96.77%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         1687.5
       </span>
    </span> hits/line)
  </h2>
  <a name="Bitcoin"></a>
  <div>
    <b>3</b> files in total.
    <b>899</b> relevant lines. 
    <span class="green"><b>870</b> lines covered</span> and
    <span class="red"><b>29</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#6291547fade947731b570fd2a9162416476301a6" class="src_link" title="lib/bitcoin.rb">lib/bitcoin.rb</a></td>
        <td class="green strong">95.95 %</td>
        <td>631</td>
        <td>247</td>
        <td>237</td>
        <td>10</td>
        <td>4546.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb82939148b5de4151cdeacc2d9ed89caee32ee5" class="src_link" title="lib/bitcoin/key.rb">lib/bitcoin/key.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>179</td>
        <td>77</td>
        <td>77</td>
        <td>0</td>
        <td>87.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9997f171293226ec441ccaa33d726c508ff07a39" class="src_link" title="lib/bitcoin/script.rb">lib/bitcoin/script.rb</a></td>
        <td class="green strong">96.7 %</td>
        <td>1052</td>
        <td>575</td>
        <td>556</td>
        <td>19</td>
        <td>428.4</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Protocol">
  <h2>
    <span class="group_name">Protocol</span>
    (<span class="covered_percent"><span class="yellow">86.58%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         299.62
       </span>
    </span> hits/line)
  </h2>
  <a name="Protocol"></a>
  <div>
    <b>11</b> files in total.
    <b>745</b> relevant lines. 
    <span class="green"><b>645</b> lines covered</span> and
    <span class="red"><b>100</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#097a63ca9e1638fe6b84d7fad2f0982e08134c36" class="src_link" title="lib/bitcoin/protocol.rb">lib/bitcoin/protocol.rb</a></td>
        <td class="red strong">74.73 %</td>
        <td>154</td>
        <td>91</td>
        <td>68</td>
        <td>23</td>
        <td>458.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7232aa03263e2a301dcf3642c61bc0272ac13cbf" class="src_link" title="lib/bitcoin/protocol/address.rb">lib/bitcoin/protocol/address.rb</a></td>
        <td class="green strong">95.0 %</td>
        <td>50</td>
        <td>20</td>
        <td>19</td>
        <td>1</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7d06569f2eaac3f62f37ef5987a9d46ed2181b70" class="src_link" title="lib/bitcoin/protocol/alert.rb">lib/bitcoin/protocol/alert.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>46</td>
        <td>26</td>
        <td>26</td>
        <td>0</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#72c96e47888f7a4335d66634fcf4f59c7b9ac9a3" class="src_link" title="lib/bitcoin/protocol/aux_pow.rb">lib/bitcoin/protocol/aux_pow.rb</a></td>
        <td class="red strong">74.29 %</td>
        <td>123</td>
        <td>70</td>
        <td>52</td>
        <td>18</td>
        <td>3.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b85bdf561b3dc51ecfd89215f675dc4ae6ab50a3" class="src_link" title="lib/bitcoin/protocol/block.rb">lib/bitcoin/protocol/block.rb</a></td>
        <td class="green strong">91.2 %</td>
        <td>254</td>
        <td>125</td>
        <td>114</td>
        <td>11</td>
        <td>586.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec26a72c762bc13eda908614b56e96d8669a4d80" class="src_link" title="lib/bitcoin/protocol/handler.rb">lib/bitcoin/protocol/handler.rb</a></td>
        <td class="red strong">58.82 %</td>
        <td>39</td>
        <td>17</td>
        <td>10</td>
        <td>7</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#557ee148bb367f942116155fdc327b5fa7942241" class="src_link" title="lib/bitcoin/protocol/parser.rb">lib/bitcoin/protocol/parser.rb</a></td>
        <td class="red strong">73.79 %</td>
        <td>172</td>
        <td>103</td>
        <td>76</td>
        <td>27</td>
        <td>5.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#50420e37470493cafba8f41ed05b633a062fcdf4" class="src_link" title="lib/bitcoin/protocol/tx.rb">lib/bitcoin/protocol/tx.rb</a></td>
        <td class="green strong">94.63 %</td>
        <td>299</td>
        <td>149</td>
        <td>141</td>
        <td>8</td>
        <td>463.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1535735601f850f0edb630e497ee3ca0f6253a95" class="src_link" title="lib/bitcoin/protocol/txin.rb">lib/bitcoin/protocol/txin.rb</a></td>
        <td class="green strong">95.16 %</td>
        <td>120</td>
        <td>62</td>
        <td>59</td>
        <td>3</td>
        <td>675.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#925463098a998a603cae90a61e90032defc0f861" class="src_link" title="lib/bitcoin/protocol/txout.rb">lib/bitcoin/protocol/txout.rb</a></td>
        <td class="green strong">98.04 %</td>
        <td>94</td>
        <td>51</td>
        <td>50</td>
        <td>1</td>
        <td>1097.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#64138ab3345824464f68bf4ae98e60bd0dbb4ca8" class="src_link" title="lib/bitcoin/protocol/version.rb">lib/bitcoin/protocol/version.rb</a></td>
        <td class="green strong">96.77 %</td>
        <td>74</td>
        <td>31</td>
        <td>30</td>
        <td>1</td>
        <td>2.2</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Storage">
  <h2>
    <span class="group_name">Storage</span>
    (<span class="covered_percent"><span class="red">79.62%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         181.02
       </span>
    </span> hits/line)
  </h2>
  <a name="Storage"></a>
  <div>
    <b>5</b> files in total.
    <b>677</b> relevant lines. 
    <span class="green"><b>539</b> lines covered</span> and
    <span class="red"><b>138</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#029576e2a52c9778712ac74b945fbe9db0bb13e7" class="src_link" title="lib/bitcoin/storage/dummy/dummy_store.rb">lib/bitcoin/storage/dummy/dummy_store.rb</a></td>
        <td class="red strong">25.74 %</td>
        <td>166</td>
        <td>101</td>
        <td>26</td>
        <td>75</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a5b4193a8f28e1aea5ab2063c2b6e6b27fea99ad" class="src_link" title="lib/bitcoin/storage/models.rb">lib/bitcoin/storage/models.rb</a></td>
        <td class="green strong">90.7 %</td>
        <td>183</td>
        <td>86</td>
        <td>78</td>
        <td>8</td>
        <td>349.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f4cfbc683725977ffb9e47ff8ba1229a17889eca" class="src_link" title="lib/bitcoin/storage/sequel/migrations.rb">lib/bitcoin/storage/sequel/migrations.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>99</td>
        <td>64</td>
        <td>64</td>
        <td>0</td>
        <td>84.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ff9aba8fbeb1f6439118795d4ee25ca3db6c62bc" class="src_link" title="lib/bitcoin/storage/sequel/sequel_store.rb">lib/bitcoin/storage/sequel/sequel_store.rb</a></td>
        <td class="green strong">90.67 %</td>
        <td>503</td>
        <td>268</td>
        <td>243</td>
        <td>25</td>
        <td>419.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1e47ca20dcc1dba7324b2d0287e768352d49ee12" class="src_link" title="lib/bitcoin/storage/storage.rb">lib/bitcoin/storage/storage.rb</a></td>
        <td class="yellow strong">81.01 %</td>
        <td>304</td>
        <td>158</td>
        <td>128</td>
        <td>30</td>
        <td>50.9</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Wallet">
  <h2>
    <span class="group_name">Wallet</span>
    (<span class="covered_percent"><span class="red">78.9%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         234.28
       </span>
    </span> hits/line)
  </h2>
  <a name="Wallet"></a>
  <div>
    <b>5</b> files in total.
    <b>365</b> relevant lines. 
    <span class="green"><b>288</b> lines covered</span> and
    <span class="red"><b>77</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#45d4f28fae6f671f74cefe8a341bf4686a58205e" class="src_link" title="lib/bitcoin/wallet/coinselector.rb">lib/bitcoin/wallet/coinselector.rb</a></td>
        <td class="green strong">93.33 %</td>
        <td>33</td>
        <td>15</td>
        <td>14</td>
        <td>1</td>
        <td>13.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5b4d2b3b2b9a07acc2e0db4dcc389a361c4af330" class="src_link" title="lib/bitcoin/wallet/keygenerator.rb">lib/bitcoin/wallet/keygenerator.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>77</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>1086.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#02f674ef66c656bec0454c93dca59c930de55849" class="src_link" title="lib/bitcoin/wallet/keystore.rb">lib/bitcoin/wallet/keystore.rb</a></td>
        <td class="green strong">92.66 %</td>
        <td>206</td>
        <td>109</td>
        <td>101</td>
        <td>8</td>
        <td>24.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e4537349f04bf547cb5970d59edb474b2c135d28" class="src_link" title="lib/bitcoin/wallet/txdp.rb">lib/bitcoin/wallet/txdp.rb</a></td>
        <td class="yellow strong">83.53 %</td>
        <td>118</td>
        <td>85</td>
        <td>71</td>
        <td>14</td>
        <td>41.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5f86fc73b1d974c21d9992a33e59689fa75b4089" class="src_link" title="lib/bitcoin/wallet/wallet.rb">lib/bitcoin/wallet/wallet.rb</a></td>
        <td class="red strong">58.14 %</td>
        <td>261</td>
        <td>129</td>
        <td>75</td>
        <td>54</td>
        <td>4.9</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Utilities">
  <h2>
    <span class="group_name">Utilities</span>
    (<span class="covered_percent"><span class="green">93.75%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         56.45
       </span>
    </span> hits/line)
  </h2>
  <a name="Utilities"></a>
  <div>
    <b>2</b> files in total.
    <b>176</b> relevant lines. 
    <span class="green"><b>165</b> lines covered</span> and
    <span class="red"><b>11</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#2dcb72f38404c85bd4fe44aeed3d3b7e4562fc0c" class="src_link" title="lib/bitcoin/ffi/openssl.rb">lib/bitcoin/ffi/openssl.rb</a></td>
        <td class="green strong">97.14 %</td>
        <td>225</td>
        <td>140</td>
        <td>136</td>
        <td>4</td>
        <td>76.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5d6d97008ffec5aff3bc91103ab60ec056c27d1" class="src_link" title="lib/bitcoin/logger.rb">lib/bitcoin/logger.rb</a></td>
        <td class="yellow strong">80.56 %</td>
        <td>68</td>
        <td>36</td>
        <td>29</td>
        <td>7</td>
        <td>36.7</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent"><span class="red">69.03%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         304.9
       </span>
    </span> hits/line)
  </h2>
  <a name="Ungrouped"></a>
  <div>
    <b>5</b> files in total.
    <b>662</b> relevant lines. 
    <span class="green"><b>457</b> lines covered</span> and
    <span class="red"><b>205</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#6ad895c6fd6140cbd279d839c3cab431fd71d2a7" class="src_link" title="lib/bitcoin/builder.rb">lib/bitcoin/builder.rb</a></td>
        <td class="green strong">91.47 %</td>
        <td>275</td>
        <td>129</td>
        <td>118</td>
        <td>11</td>
        <td>1305.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#021236b87a55c3912ce0a2591b4797a70dc78009" class="src_link" title="lib/bitcoin/namecoin.rb">lib/bitcoin/namecoin.rb</a></td>
        <td class="yellow strong">87.72 %</td>
        <td>122</td>
        <td>57</td>
        <td>50</td>
        <td>7</td>
        <td>32.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c2066d8e979ddb719a0b52c66f77f9345bb881e3" class="src_link" title="lib/bitcoin/network/command_client.rb">lib/bitcoin/network/command_client.rb</a></td>
        <td class="yellow strong">89.8 %</td>
        <td>92</td>
        <td>49</td>
        <td>44</td>
        <td>5</td>
        <td>38.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b871e365d6f70067f23b892e8c11e21927a1af95" class="src_link" title="lib/bitcoin/network/node.rb">lib/bitcoin/network/node.rb</a></td>
        <td class="red strong">30.4 %</td>
        <td>473</td>
        <td>250</td>
        <td>76</td>
        <td>174</td>
        <td>4.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1d2f3285b72675d82f9d16bd6660cd2e089bdc3a" class="src_link" title="lib/bitcoin/validation.rb">lib/bitcoin/validation.rb</a></td>
        <td class="green strong">95.48 %</td>
        <td>365</td>
        <td>177</td>
        <td>169</td>
        <td>8</td>
        <td>143.1</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.7.1 
        and simplecov-html v0.7.1<br/>
        using RSpec
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="6291547fade947731b570fd2a9162416476301a6">
  <div class="header">
    <h3>lib/bitcoin.rb</h3>
    <h4><span class="green">95.95 %</span> covered</h4>
    <div>
      <b>247</b> relevant lines. 
      <span class="green"><b>237</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Bitcoin Utils and Network Protocol in Ruby.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;digest/sha2&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;digest/rmd160&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;openssl&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Connection, &#39;bitcoin/connection&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Protocol,   &#39;bitcoin/protocol&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :P,          &#39;bitcoin/protocol&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Script,     &#39;bitcoin/script&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :VERSION,    &#39;bitcoin/version&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Storage,    &#39;bitcoin/storage/storage&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Logger,     &#39;bitcoin/logger&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Key,        &#39;bitcoin/key&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Config,     &#39;bitcoin/config&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Builder,    &#39;bitcoin/builder&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Validation, &#39;bitcoin/validation&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Namecoin,   &#39;bitcoin/namecoin&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  module Network</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :ConnectionHandler,  &#39;bitcoin/network/connection_handler&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :CommandHandler,     &#39;bitcoin/network/command_handler&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :CommandClient,     &#39;bitcoin/network/command_client&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Node,               &#39;bitcoin/network/node&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  module Wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :KeyGenerator,          &#39;bitcoin/wallet/keygenerator&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :SimpleKeyStore,        &#39;bitcoin/wallet/keystore&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :DeterministicKeyStore, &#39;bitcoin/wallet/keystore&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :SimpleCoinSelector,    &#39;bitcoin/wallet/coinselector&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Wallet,                &#39;bitcoin/wallet/wallet&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :TxDP,                &#39;bitcoin/wallet/txdp&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  module Gui</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Gui,        &#39;bitcoin/gui/gui&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Connection, &#39;bitcoin/gui/connection&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.require_dependency name, opts = {}</code>
        </li>
      
        <li class="covered" data-hits="93" data-linenumber="47">
          <span class="hits">93</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="93" data-linenumber="48">
          <span class="hits">93</span>
          
          <code class="ruby">      require name.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    rescue LoadError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      return false if name.to_s == &quot;log4r&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      print &quot;Cannot load #{opts[:exit] == false ? &#39;optional&#39; : &#39;required&#39;} dependency &#39;#{name}&#39;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      (opts[:gem] == false) ? puts(&quot;&quot;) :</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        puts(&quot; - install with `gem install #{opts[:gem] || name}`&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      puts opts[:message]  if opts[:message]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      exit 1  unless opts[:exit] == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="93" data-linenumber="58">
          <span class="hits">93</span>
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  module Util</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4632" data-linenumber="63">
          <span class="hits">4632</span>
          
          <code class="ruby">    def address_version; Bitcoin.network[:address_version]; end</code>
        </li>
      
        <li class="covered" data-hits="2349" data-linenumber="64">
          <span class="hits">2349</span>
          
          <code class="ruby">    def p2sh_version; Bitcoin.network[:p2sh_version]; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    # hash160 is a 20 bytes (160bits) rmd610-sha256 hexdigest.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160(hex)</code>
        </li>
      
        <li class="covered" data-hits="2112" data-linenumber="68">
          <span class="hits">2112</span>
          
          <code class="ruby">      bytes = [hex].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2112" data-linenumber="69">
          <span class="hits">2112</span>
          
          <code class="ruby">      Digest::RMD160.hexdigest Digest::SHA256.digest(bytes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    # checksum is a 4 bytes sha256-sha256 hexdigest.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    def checksum(hex)</code>
        </li>
      
        <li class="covered" data-hits="4338" data-linenumber="74">
          <span class="hits">4338</span>
          
          <code class="ruby">      b = [hex].pack(&quot;H*&quot;) # unpack hex</code>
        </li>
      
        <li class="covered" data-hits="4338" data-linenumber="75">
          <span class="hits">4338</span>
          
          <code class="ruby">      Digest::SHA256.hexdigest( Digest::SHA256.digest(b) )[0...8]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    # verify base58 checksum for given +base58+ data.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    def base58_checksum?(base58)</code>
        </li>
      
        <li class="covered" data-hits="2344" data-linenumber="80">
          <span class="hits">2344</span>
          
          <code class="ruby">      hex = decode_base58(base58) rescue nil</code>
        </li>
      
        <li class="covered" data-hits="2344" data-linenumber="81">
          <span class="hits">2344</span>
          
          <code class="ruby">      return false unless hex</code>
        </li>
      
        <li class="covered" data-hits="2342" data-linenumber="82">
          <span class="hits">2342</span>
          
          <code class="ruby">      Bitcoin.checksum( hex[0...42] ) == hex[-8..-1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">    alias :address_checksum? :base58_checksum?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    # check if given +address+ is valid.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    # this means having a correct version byte, length and checksum.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    def valid_address?(address)</code>
        </li>
      
        <li class="covered" data-hits="2370" data-linenumber="89">
          <span class="hits">2370</span>
          
          <code class="ruby">      hex = decode_base58(address) rescue nil</code>
        </li>
      
        <li class="covered" data-hits="2370" data-linenumber="90">
          <span class="hits">2370</span>
          
          <code class="ruby">      return false unless hex &amp;&amp; hex.bytesize == 50</code>
        </li>
      
        <li class="covered" data-hits="2345" data-linenumber="91">
          <span class="hits">2345</span>
          
          <code class="ruby">      return false unless [address_version, p2sh_version].include?(hex[0...2])</code>
        </li>
      
        <li class="covered" data-hits="2338" data-linenumber="92">
          <span class="hits">2338</span>
          
          <code class="ruby">      address_checksum?(address)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    # get hash160 for given +address+. returns nil if address is invalid.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160_from_address(address)</code>
        </li>
      
        <li class="covered" data-hits="1168" data-linenumber="97">
          <span class="hits">1168</span>
          
          <code class="ruby">      return nil  unless valid_address?(address)</code>
        </li>
      
        <li class="covered" data-hits="1166" data-linenumber="98">
          <span class="hits">1166</span>
          
          <code class="ruby">      decode_base58(address)[2...42]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    # get type of given +address+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    def address_type(address)</code>
        </li>
      
        <li class="covered" data-hits="347" data-linenumber="103">
          <span class="hits">347</span>
          
          <code class="ruby">      return nil unless valid_address?(address)</code>
        </li>
      
        <li class="covered" data-hits="344" data-linenumber="104">
          <span class="hits">344</span>
          
          <code class="ruby">      case decode_base58(address)[0...2]</code>
        </li>
      
        <li class="covered" data-hits="341" data-linenumber="105">
          <span class="hits">341</span>
          
          <code class="ruby">      when address_version; :hash160</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="106">
          <span class="hits">3</span>
          
          <code class="ruby">      when p2sh_version;    :p2sh</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    def sha256(hex)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">      Digest::SHA256.hexdigest([hex].pack(&quot;H*&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160_to_address(hex)</code>
        </li>
      
        <li class="covered" data-hits="1942" data-linenumber="115">
          <span class="hits">1942</span>
          
          <code class="ruby">      hex = address_version + hex</code>
        </li>
      
        <li class="covered" data-hits="1942" data-linenumber="116">
          <span class="hits">1942</span>
          
          <code class="ruby">      encode_base58(hex + checksum(hex))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    def pubkey_to_address(pubkey)</code>
        </li>
      
        <li class="covered" data-hits="806" data-linenumber="120">
          <span class="hits">806</span>
          
          <code class="ruby">      hash160_to_address( hash160(pubkey) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    def int_to_base58(int_val, leading_zero_bytes=0)</code>
        </li>
      
        <li class="covered" data-hits="1968" data-linenumber="124">
          <span class="hits">1968</span>
          
          <code class="ruby">      alpha = &quot;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&quot;</code>
        </li>
      
        <li class="covered" data-hits="1968" data-linenumber="125">
          <span class="hits">1968</span>
          
          <code class="ruby">      base58_val, base = &#39;&#39;, alpha.size</code>
        </li>
      
        <li class="covered" data-hits="1968" data-linenumber="126">
          <span class="hits">1968</span>
          
          <code class="ruby">      while int_val &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="65669" data-linenumber="127">
          <span class="hits">65669</span>
          
          <code class="ruby">        int_val, remainder = int_val.divmod(base)</code>
        </li>
      
        <li class="covered" data-hits="65669" data-linenumber="128">
          <span class="hits">65669</span>
          
          <code class="ruby">        base58_val = alpha[remainder] + base58_val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1968" data-linenumber="130">
          <span class="hits">1968</span>
          
          <code class="ruby">      base58_val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">    def base58_to_int(base58_val)</code>
        </li>
      
        <li class="covered" data-hits="6282" data-linenumber="134">
          <span class="hits">6282</span>
          
          <code class="ruby">      alpha = &quot;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&quot;</code>
        </li>
      
        <li class="covered" data-hits="6282" data-linenumber="135">
          <span class="hits">6282</span>
          
          <code class="ruby">      int_val, base = 0, alpha.size</code>
        </li>
      
        <li class="covered" data-hits="6282" data-linenumber="136">
          <span class="hits">6282</span>
          
          <code class="ruby">      base58_val.reverse.each_char.with_index do |char,index|</code>
        </li>
      
        <li class="covered" data-hits="213303" data-linenumber="137">
          <span class="hits">213303</span>
          
          <code class="ruby">        raise ArgumentError, &#39;Value not a valid Base58 String.&#39; unless char_index = alpha.index(char)</code>
        </li>
      
        <li class="covered" data-hits="213296" data-linenumber="138">
          <span class="hits">213296</span>
          
          <code class="ruby">        int_val += char_index*(base**index)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="6275" data-linenumber="140">
          <span class="hits">6275</span>
          
          <code class="ruby">      int_val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">    def encode_base58(hex)</code>
        </li>
      
        <li class="covered" data-hits="1954" data-linenumber="144">
          <span class="hits">1954</span>
          
          <code class="ruby">      leading_zero_bytes  = (hex.match(/^([0]+)/) ? $1 : &#39;&#39;).size / 2</code>
        </li>
      
        <li class="covered" data-hits="1954" data-linenumber="145">
          <span class="hits">1954</span>
          
          <code class="ruby">      (&quot;1&quot;*leading_zero_bytes) + int_to_base58( hex.to_i(16) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    def decode_base58(base58_val)</code>
        </li>
      
        <li class="covered" data-hits="6281" data-linenumber="150">
          <span class="hits">6281</span>
          
          <code class="ruby">      s = base58_to_int(base58_val).to_s(16); s = (s.bytesize.odd? ? &#39;0&#39;+s : s)</code>
        </li>
      
        <li class="covered" data-hits="6274" data-linenumber="151">
          <span class="hits">6274</span>
          
          <code class="ruby">      s = &#39;&#39; if s == &#39;00&#39;</code>
        </li>
      
        <li class="covered" data-hits="6274" data-linenumber="152">
          <span class="hits">6274</span>
          
          <code class="ruby">      leading_zero_bytes = (base58_val.match(/^([1]+)/) ? $1 : &#39;&#39;).size</code>
        </li>
      
        <li class="covered" data-hits="6274" data-linenumber="153">
          <span class="hits">6274</span>
          
          <code class="ruby">      s = (&quot;00&quot;*leading_zero_bytes) + s  if leading_zero_bytes &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="6274" data-linenumber="154">
          <span class="hits">6274</span>
          
          <code class="ruby">      s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">    alias_method :base58_to_hex, :decode_base58</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    # target compact bits (int) to bignum hex</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">    def decode_compact_bits(bits)</code>
        </li>
      
        <li class="covered" data-hits="1404" data-linenumber="160">
          <span class="hits">1404</span>
          
          <code class="ruby">      bytes = Array.new(size=((bits &gt;&gt; 24) &amp; 255), 0)</code>
        </li>
      
        <li class="covered" data-hits="1404" data-linenumber="161">
          <span class="hits">1404</span>
          
          <code class="ruby">      bytes[0] = (bits &gt;&gt; 16) &amp; 255 if size &gt;= 1</code>
        </li>
      
        <li class="covered" data-hits="1404" data-linenumber="162">
          <span class="hits">1404</span>
          
          <code class="ruby">      bytes[1] = (bits &gt;&gt;  8) &amp; 255 if size &gt;= 2</code>
        </li>
      
        <li class="covered" data-hits="1404" data-linenumber="163">
          <span class="hits">1404</span>
          
          <code class="ruby">      bytes[2] = (bits      ) &amp; 255 if size &gt;= 3</code>
        </li>
      
        <li class="covered" data-hits="1404" data-linenumber="164">
          <span class="hits">1404</span>
          
          <code class="ruby">      bytes.pack(&quot;C*&quot;).unpack(&quot;H*&quot;)[0].rjust(64, &#39;0&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    # target bignum hex to compact bits (int)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    def encode_compact_bits(target)</code>
        </li>
      
        <li class="covered" data-hits="305" data-linenumber="169">
          <span class="hits">305</span>
          
          <code class="ruby">      bytes = OpenSSL::BN.new(target, 16).to_mpi</code>
        </li>
      
        <li class="covered" data-hits="305" data-linenumber="170">
          <span class="hits">305</span>
          
          <code class="ruby">      size = bytes.size - 4</code>
        </li>
      
        <li class="covered" data-hits="305" data-linenumber="171">
          <span class="hits">305</span>
          
          <code class="ruby">      nbits = size &lt;&lt; 24</code>
        </li>
      
        <li class="covered" data-hits="305" data-linenumber="172">
          <span class="hits">305</span>
          
          <code class="ruby">      nbits |= (bytes[4] &lt;&lt; 16) if size &gt;= 1</code>
        </li>
      
        <li class="covered" data-hits="305" data-linenumber="173">
          <span class="hits">305</span>
          
          <code class="ruby">      nbits |= (bytes[5] &lt;&lt;  8) if size &gt;= 2</code>
        </li>
      
        <li class="covered" data-hits="305" data-linenumber="174">
          <span class="hits">305</span>
          
          <code class="ruby">      nbits |= (bytes[6]      ) if size &gt;= 3</code>
        </li>
      
        <li class="covered" data-hits="305" data-linenumber="175">
          <span class="hits">305</span>
          
          <code class="ruby">      nbits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">    def decode_target(target_bits)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      case target_bits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      when Fixnum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">        [ decode_compact_bits(target_bits).to_i(16), target_bits ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      when String</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">        [ target_bits.to_i(16), encode_compact_bits(target_bits) ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">    def bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="1744" data-linenumber="188">
          <span class="hits">1744</span>
          
          <code class="ruby">      ::OpenSSL::PKey::EC.new(&quot;secp256k1&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate_key</code>
        </li>
      
        <li class="covered" data-hits="1102" data-linenumber="192">
          <span class="hits">1102</span>
          
          <code class="ruby">      key = bitcoin_elliptic_curve.generate_key</code>
        </li>
      
        <li class="covered" data-hits="1102" data-linenumber="193">
          <span class="hits">1102</span>
          
          <code class="ruby">      inspect_key( key )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">    def inspect_key(key)</code>
        </li>
      
        <li class="covered" data-hits="1103" data-linenumber="197">
          <span class="hits">1103</span>
          
          <code class="ruby">      [ key.private_key_hex, key.public_key_hex ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate_address</code>
        </li>
      
        <li class="covered" data-hits="801" data-linenumber="201">
          <span class="hits">801</span>
          
          <code class="ruby">      prvkey, pubkey = generate_key</code>
        </li>
      
        <li class="covered" data-hits="801" data-linenumber="202">
          <span class="hits">801</span>
          
          <code class="ruby">      [ pubkey_to_address(pubkey), prvkey, pubkey, hash160(pubkey) ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">    def bitcoin_hash(hex)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">      Digest::SHA256.digest(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">        Digest::SHA256.digest( [hex].pack(&quot;H*&quot;).reverse )</code>
        </li>
      
        <li class="covered" data-hits="54862" data-linenumber="208">
          <span class="hits">54862</span>
          
          <code class="ruby">      ).reverse.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">    def bitcoin_byte_hash(bytes)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="212">
          <span class="hits">4</span>
          
          <code class="ruby">      Digest::SHA256.digest(Digest::SHA256.digest(bytes))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="681" data-linenumber="215">
          <span class="hits">681</span>
          
          <code class="ruby">    def bitcoin_mrkl(a, b); bitcoin_hash(b + a); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="217">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_hash(prev_block, mrkl_root, time, bits, nonce, ver)</code>
        </li>
      
        <li class="covered" data-hits="54182" data-linenumber="218">
          <span class="hits">54182</span>
          
          <code class="ruby">      h = &quot;%08x%08x%08x%064s%064s%08x&quot; %</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">            [nonce, bits, time, mrkl_root, prev_block, ver]</code>
        </li>
      
        <li class="covered" data-hits="54181" data-linenumber="220">
          <span class="hits">54181</span>
          
          <code class="ruby">      bitcoin_hash(h)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">    # get merkle tree for given +tx+ list.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash_mrkl_tree(tx)</code>
        </li>
      
        <li class="covered" data-hits="773" data-linenumber="225">
          <span class="hits">773</span>
          
          <code class="ruby">      return [nil]  if tx != tx.uniq</code>
        </li>
      
        <li class="covered" data-hits="771" data-linenumber="226">
          <span class="hits">771</span>
          
          <code class="ruby">      chunks = [ tx.dup ]</code>
        </li>
      
        <li class="covered" data-hits="771" data-linenumber="227">
          <span class="hits">771</span>
          
          <code class="ruby">      while chunks.last.size &gt;= 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">        chunks &lt;&lt; chunks.last.each_slice(2).map {|a, b|</code>
        </li>
      
        <li class="covered" data-hits="542" data-linenumber="229">
          <span class="hits">542</span>
          
          <code class="ruby">          Bitcoin.bitcoin_mrkl( a, b || a ) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="771" data-linenumber="231">
          <span class="hits">771</span>
          
          <code class="ruby">      chunks.flatten</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">    # get merkle branch connecting given +target+ to the merkle root of +tx+ list</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash_mrkl_branch(tx, target)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="236">
          <span class="hits">17</span>
          
          <code class="ruby">      return [ nil ]  if tx != tx.uniq</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="237">
          <span class="hits">17</span>
          
          <code class="ruby">      branch, chunks = [], [ tx.dup ]</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="238">
          <span class="hits">17</span>
          
          <code class="ruby">      while chunks.last.size &gt;= 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">        chunks &lt;&lt; chunks.last.each_slice(2).map {|a, b|</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="240">
          <span class="hits">138</span>
          
          <code class="ruby">          hash = Bitcoin.bitcoin_mrkl( a, b || a )</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="241">
          <span class="hits">138</span>
          
          <code class="ruby">          next hash  unless [a, b].include?(target)</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="242">
          <span class="hits">57</span>
          
          <code class="ruby">          branch &lt;&lt; (a == target ? (b || a) : a)</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="243">
          <span class="hits">57</span>
          
          <code class="ruby">          target = hash</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="244">
          <span class="hits">57</span>
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="246">
          <span class="hits">17</span>
          
          <code class="ruby">      branch</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">    # get merkle root from +branch+ and +target+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="250">
          <span class="hits">1</span>
          
          <code class="ruby">    def mrkl_branch_root(branch, target, idx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      branch.map do |hash|</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="252">
          <span class="hits">57</span>
          
          <code class="ruby">        a, b = *( idx &amp; 1 == 0 ? [target, hash] : [hash, target] )</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="253">
          <span class="hits">57</span>
          
          <code class="ruby">        idx &gt;&gt;= 1; target = Bitcoin.bitcoin_mrkl( a, b )</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="254">
          <span class="hits">17</span>
          
          <code class="ruby">      end.last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">    def sign_data(key, data)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="258">
          <span class="hits">3</span>
          
          <code class="ruby">      key.dsa_sign_asn1(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="261">
          <span class="hits">1</span>
          
          <code class="ruby">    def verify_signature(hash, signature, public_key)</code>
        </li>
      
        <li class="covered" data-hits="102" data-linenumber="262">
          <span class="hits">102</span>
          
          <code class="ruby">      key  = bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="102" data-linenumber="263">
          <span class="hits">102</span>
          
          <code class="ruby">      key.public_key = ::OpenSSL::PKey::EC::Point.from_hex(key.group, public_key)</code>
        </li>
      
        <li class="covered" data-hits="101" data-linenumber="264">
          <span class="hits">101</span>
          
          <code class="ruby">      key.dsa_verify_asn1(hash, signature)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">    rescue OpenSSL::PKey::ECError, OpenSSL::PKey::EC::Point::Error</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="266">
          <span class="hits">2</span>
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="269">
          <span class="hits">1</span>
          
          <code class="ruby">    def open_key(private_key, public_key=nil)</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="270">
          <span class="hits">54</span>
          
          <code class="ruby">      key  = bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="271">
          <span class="hits">54</span>
          
          <code class="ruby">      key.private_key = ::OpenSSL::BN.from_hex(private_key)</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="272">
          <span class="hits">54</span>
          
          <code class="ruby">      public_key = regenerate_public_key(private_key) unless public_key</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="273">
          <span class="hits">54</span>
          
          <code class="ruby">      key.public_key  = ::OpenSSL::PKey::EC::Point.from_hex(key.group, public_key)</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="274">
          <span class="hits">54</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="277">
          <span class="hits">1</span>
          
          <code class="ruby">    def regenerate_public_key(private_key)</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="278">
          <span class="hits">50</span>
          
          <code class="ruby">      Bitcoin::OpenSSL_EC.regenerate_key(private_key)[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">    RETARGET_INTERVAL = 2016</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">    # block count when the next retarget will take place.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="285">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_next_retarget(block_height)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="286">
          <span class="hits">3</span>
          
          <code class="ruby">      (block_height + (RETARGET_INTERVAL-block_height.divmod(RETARGET_INTERVAL).last)) - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">    # current difficulty as a multiple of the minimum difficulty (highest target).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="290">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_difficulty(target_nbits)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      # max_target      = 0x00000000ffff0000000000000000000000000000000000000000000000000000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">      # current_target  = Bitcoin.decode_compact_bits(target_nbits).to_i(16)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">      # &quot;%.7f&quot; % (max_target / current_target.to_f)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="294">
          <span class="hits">1</span>
          
          <code class="ruby">      bits, max_body, scaland = target_nbits, Math.log(0x00ffff), Math.log(256)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="295">
          <span class="hits">1</span>
          
          <code class="ruby">      &quot;%.7f&quot; % Math.exp(max_body - Math.log(bits&amp;0x00ffffff) + scaland * (0x1d - ((bits&amp;0xff000000)&gt;&gt;24)))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">    # average number of hashes required to win a block with the current target. (nbits)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="299">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_hashes_to_win(target_nbits)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="300">
          <span class="hits">3</span>
          
          <code class="ruby">      current_target  = Bitcoin.decode_compact_bits(target_nbits).to_i(16)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="301">
          <span class="hits">3</span>
          
          <code class="ruby">      0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff / current_target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">    # probability of a single hash solving a block with the current difficulty.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="305">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_probability(target_nbits)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="306">
          <span class="hits">1</span>
          
          <code class="ruby">      current_target  = Bitcoin.decode_compact_bits(target_nbits).to_i(16)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="307">
          <span class="hits">1</span>
          
          <code class="ruby">      &quot;%.55f&quot; % (current_target.to_f / 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">    # average time to find a block in seconds with the current target. (nbits)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="311">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_average_hashing_time(target_nbits, hashes_per_second)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="312">
          <span class="hits">2</span>
          
          <code class="ruby">      block_hashes_to_win(target_nbits) / hashes_per_second</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">    # average mining time (in days) using Mh/s to get btc</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="316">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_average_mining_time(block_nbits, block_height, mega_hashes_per_second, target_btc=1.0)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="317">
          <span class="hits">1</span>
          
          <code class="ruby">      seconds = block_average_hashing_time(block_nbits, mega_hashes_per_second * 1_000_000)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="318">
          <span class="hits">1</span>
          
          <code class="ruby">      reward  = block_creation_reward(block_height) / Bitcoin::COIN # satoshis to btc</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">      (days = seconds / 60 / 60 / 24) * (target_btc / reward)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">    # shows the total number of Bitcoins in circulation, reward era and reward in that era.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="323">
          <span class="hits">1</span>
          
          <code class="ruby">    def blockchain_total_btc(height)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="324">
          <span class="hits">6</span>
          
          <code class="ruby">      reward, interval = 5000000000, 210000</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="325">
          <span class="hits">6</span>
          
          <code class="ruby">      total_btc = reward</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="326">
          <span class="hits">6</span>
          
          <code class="ruby">      reward_era, remainder = (height).divmod(interval)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="327">
          <span class="hits">6</span>
          
          <code class="ruby">      reward_era.times{</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="328">
          <span class="hits">12</span>
          
          <code class="ruby">        total_btc += interval * reward</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="329">
          <span class="hits">12</span>
          
          <code class="ruby">        reward = reward / 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="331">
          <span class="hits">6</span>
          
          <code class="ruby">      total_btc += remainder * reward</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="332">
          <span class="hits">6</span>
          
          <code class="ruby">      [total_btc, reward_era+1, reward, height]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="335">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_creation_reward(block_height)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="336">
          <span class="hits">7</span>
          
          <code class="ruby">      5000000000 / (2 ** (block_height / 210000.0).floor)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="340">
          <span class="hits">1</span>
          
          <code class="ruby">  extend Util</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="343">
          <span class="hits">1</span>
          
          <code class="ruby">  module  BinaryExtensions</code>
        </li>
      
        <li class="covered" data-hits="114841" data-linenumber="344">
          <span class="hits">114841</span>
          
          <code class="ruby">    def hth; unpack(&quot;H*&quot;)[0]; end</code>
        </li>
      
        <li class="covered" data-hits="113235" data-linenumber="345">
          <span class="hits">113235</span>
          
          <code class="ruby">    def reverse_hth; reverse.hth; end</code>
        </li>
      
        <li class="covered" data-hits="3979" data-linenumber="346">
          <span class="hits">3979</span>
          
          <code class="ruby">    def htb; [self].pack(&quot;H*&quot;); end</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="347">
          <span class="hits">123</span>
          
          <code class="ruby">    def htb_reverse; htb.reverse; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="350">
          <span class="hits">1</span>
          
          <code class="ruby">  class ::String</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="351">
          <span class="hits">1</span>
          
          <code class="ruby">    include Bitcoin::BinaryExtensions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="355">
          <span class="hits">1</span>
          
          <code class="ruby">  module ::OpenSSL</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="356">
          <span class="hits">1</span>
          
          <code class="ruby">    class BN</code>
        </li>
      
        <li class="covered" data-hits="584" data-linenumber="357">
          <span class="hits">584</span>
          
          <code class="ruby">      def self.from_hex(hex); new(hex, 16); end</code>
        </li>
      
        <li class="covered" data-hits="9417" data-linenumber="358">
          <span class="hits">9417</span>
          
          <code class="ruby">      def to_hex; to_i.to_s(16); end</code>
        </li>
      
        <li class="covered" data-hits="325" data-linenumber="359">
          <span class="hits">325</span>
          
          <code class="ruby">      def to_mpi; to_s(0).unpack(&quot;C*&quot;); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="361">
          <span class="hits">1</span>
          
          <code class="ruby">    class PKey::EC</code>
        </li>
      
        <li class="covered" data-hits="1154" data-linenumber="362">
          <span class="hits">1154</span>
          
          <code class="ruby">      def private_key_hex; private_key.to_hex.rjust(64, &#39;0&#39;); end</code>
        </li>
      
        <li class="covered" data-hits="1154" data-linenumber="363">
          <span class="hits">1154</span>
          
          <code class="ruby">      def public_key_hex;  public_key.to_hex.rjust(130, &#39;0&#39;); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="365">
          <span class="hits">1</span>
          
          <code class="ruby">    class PKey::EC::Point</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="366">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hex(group, hex)</code>
        </li>
      
        <li class="covered" data-hits="380" data-linenumber="367">
          <span class="hits">380</span>
          
          <code class="ruby">        new(group, BN.from_hex(hex))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1594" data-linenumber="369">
          <span class="hits">1594</span>
          
          <code class="ruby">      def to_hex; to_bn.to_hex; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="370">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.bn2mpi(hex) BN.from_hex(hex).to_mpi; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="374">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :OpenSSL_EC, &quot;bitcoin/ffi/openssl&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="376">
          <span class="hits">1</span>
          
          <code class="ruby">  @network = :bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="378">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.network</code>
        </li>
      
        <li class="covered" data-hits="8172" data-linenumber="379">
          <span class="hits">8172</span>
          
          <code class="ruby">    NETWORKS[@network]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="382">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.network_name</code>
        </li>
      
        <li class="covered" data-hits="265" data-linenumber="383">
          <span class="hits">265</span>
          
          <code class="ruby">    @network</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="386">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.network_project</code>
        </li>
      
        <li class="covered" data-hits="11111" data-linenumber="387">
          <span class="hits">11111</span>
          
          <code class="ruby">    @network_project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="390">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.network= name</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="391">
          <span class="hits">198</span>
          
          <code class="ruby">    raise &quot;Network descriptor &#39;#{name}&#39; not found.&quot;  unless NETWORKS[name.to_sym]</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="392">
          <span class="hits">198</span>
          
          <code class="ruby">    @network = name.to_sym</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="393">
          <span class="hits">198</span>
          
          <code class="ruby">    @network_project = network[:project] rescue nil</code>
        </li>
      
        <li class="covered" data-hits="207" data-linenumber="394">
          <span class="hits">207</span>
          
          <code class="ruby">    Script.class_eval { include Namecoin::Script }  if namecoin?</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="395">
          <span class="hits">198</span>
          
          <code class="ruby">    @network</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="398">
          <span class="hits">1</span>
          
          <code class="ruby">  [:bitcoin, :namecoin, :litecoin, :ppcoin, :freicoin].each do |n|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="399">
          <span class="hits">5</span>
          
          <code class="ruby">    instance_eval &quot;def #{n}?; network_project == :#{n}; end&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="403">
          <span class="hits">1</span>
          
          <code class="ruby">  CENT =   1_000_000</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="404">
          <span class="hits">1</span>
          
          <code class="ruby">  COIN = 100_000_000</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="405">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_MONEY = 21_000_000 * COIN</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="406">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_BLOCK_SIZE = 1_000_000</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="407">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_BLOCK_SIZE_GEN = MAX_BLOCK_SIZE/2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="408">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_BLOCK_SIGOPS = MAX_BLOCK_SIZE/50</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="409">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_ORPHAN_TRANSACTIONS = MAX_BLOCK_SIZE/100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="411">
          <span class="hits">1</span>
          
          <code class="ruby">  MIN_FEE_MODE     = [ :block, :relay, :send ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="412">
          <span class="hits">1</span>
          
          <code class="ruby">  MIN_TX_FEE       = 50_000</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="413">
          <span class="hits">1</span>
          
          <code class="ruby">  MIN_RELAY_TX_FEE = 10_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="415">
          <span class="hits">1</span>
          
          <code class="ruby">  NETWORKS = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">    :bitcoin =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">      :project =&gt; :bitcoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xF9\xBE\xB4\xD9&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">      :address_version =&gt; &quot;00&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;05&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;80&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby">      :default_port =&gt; 8333,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">      :protocol_version =&gt; 70001,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby">      :dns_seeds =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">        &quot;seed.bitcoin.sipa.be&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">        &quot;dnsseed.bluematt.me&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby">        &quot;dnsseed.bitcoin.dashjr.org&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby">        &quot;bitseed.xf2.org&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">      ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0x1d00ffff,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">      :alert_pubkeys =&gt; [&quot;04fc9702847840aaf195de8442ebecedf5b095cdbb9bc716bda9110971b28a49e0ead8564ff0db22209e0374782c093bb899692d524e9d6a6956e7c5ecbcd68284&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby">      :known_nodes =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby">        &#39;relay.eligius.st&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">        &#39;mining.bitcoin.cz&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby">        &#39;blockchain.info&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">        &#39;blockexplorer.com&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">      ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby">      :checkpoints =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">         11111 =&gt; &quot;0000000069e244f73d78e8fd29ba2fd2ed618bd6fa2ee92559f542fdb26e7c1d&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">         33333 =&gt; &quot;000000002dd5588a74784eaa7ab0507a18ad16a236e7b1ce69f00d7ddfb5d0a6&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">         74000 =&gt; &quot;0000000000573993a3c9e41ce34471c079dcf5f52a0e824a81e7f953b8661a20&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">        105000 =&gt; &quot;00000000000291ce28027faea320c8d2b054b2e0fe44a773f3eefb151d6bdc97&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby">        134444 =&gt; &quot;00000000000005b12ffd4cd315cd34ffd4a594f430ac814c91184a0d42d2b0fe&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby">        168000 =&gt; &quot;000000000000099e61ea72015e79632f216fe6cb33d7899acb35b75c8303b763&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">        193000 =&gt; &quot;000000000000059f452a5f7340de6682a977387c17010ff6e6c3bd83ca8b1317&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby">        210000 =&gt; &quot;000000000000048b95347e83192f69cf0366076336c639f9b7228e9ba171342e&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby">        216116 =&gt; &quot;00000000000001b4f4b433e81ee46494af945cf96014816a4e2370f11b23df4e&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby">        225430 =&gt; &quot;00000000000001c108384350f74090433e7fcf79a606b8e797f065b130575932&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby">    :testnet =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">      :project =&gt; :bitcoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xFA\xBF\xB5\xDA&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">      :address_version =&gt; &quot;6f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;c4&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;ef&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby">      :default_port =&gt; 18333,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">      :dns_seeds =&gt; [ &quot;testseed.bitcoin.interesthings.de&quot; ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;00000007199508e34a9ff81e6ec0c477a4cccff2a4767a8eee39c11db367b008&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0x1d07fff8,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">      :alert_pubkeys =&gt; [&quot;04302390343f91cc401d56d68b123028bf52e5fca1939df127f63c6467cdf9c8e2c14b61104cf817d0b780da337893ecc4aaff1309e536162dabbdb45200ca2b0a&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">      :known_nodes =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">      :checkpoints =&gt; {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby">    :testnet3 =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">      :project =&gt; :bitcoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\x0b\x11\x09\x07&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">      :address_version =&gt; &quot;6f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;c4&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;ef&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">      :default_port =&gt; 18333,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby">      :protocol_version =&gt; 70001,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby">      :dns_seeds =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="478">
          
          
          <code class="ruby">        &quot;testnet-seed.bitcoin.petertodd.org&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">        &quot;bitcoin-seednode.bluematt.me&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="480">
          
          
          <code class="ruby">      ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;000000000933ea01ad0ee984209779baaec3ced90fa3f408719526f8d77f4943&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0x1d07fff8,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">      :alert_pubkeys =&gt; [&quot;04302390343f91cc401d56d68b123028bf52e5fca1939df127f63c6467cdf9c8e2c14b61104cf817d0b780da337893ecc4aaff1309e536162dabbdb45200ca2b0a&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="484">
          
          
          <code class="ruby">      :known_nodes =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby">      :checkpoints =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">        # 542 contains invalid transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby">        542 =&gt; &quot;0000000083c1f82cf72c6724f7a317325806384b06408bce7a4327f418dfd5ad&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby">        71018 =&gt; &quot;000000000010dd93dc55541116b2744eb8f4c3b706df6e8512d231a03fb9e435&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">    :ppcoin =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">      :project =&gt; :ppcoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xe6\xe8\xe9\xe5&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby">      :address_version =&gt; &quot;37&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="496">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;75&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;b7&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby">      :default_port =&gt; 9901,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="499">
          
          
          <code class="ruby">      :protocol_version =&gt; 60002,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">      :dns_seeds =&gt; [ &quot;seed.ppcoin.net&quot; ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;0000000032fe677166d54963b62a4677d8957e87c508eaa4fd7eb1c880cd27e3&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="503">
          
          
          <code class="ruby">      :alert_pubkeys =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="504">
          
          
          <code class="ruby">      :known_nodes =&gt; [ &quot;theseven.bounceme.net&quot;, &quot;cryptocoinexplorer.com&quot; ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="505">
          
          
          <code class="ruby">      :checkpoints =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="506">
          
          
          <code class="ruby">        19080 =&gt; &quot;000000000000bca54d9ac17881f94193fd6a270c1bb21c3bf0b37f588a40dbd7&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="507">
          
          
          <code class="ruby">        30583 =&gt; &quot;d39d1481a7eecba48932ea5913be58ad3894c7ee6d5a8ba8abeb772c66a6696e&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="509">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="510">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="511">
          
          
          <code class="ruby">    :ppcoin_testnet =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">      :project =&gt; :ppcoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xcb\xf2\xc0\xef&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="514">
          
          
          <code class="ruby">      :address_version =&gt; &quot;6f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="515">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;c4&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;ef&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby">      :default_port =&gt; 9903,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="518">
          
          
          <code class="ruby">      :protocol_version =&gt; 60002,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="519">
          
          
          <code class="ruby">      :dns_seeds =&gt; [ &quot;tnseed.ppcoin.net&quot; ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="520">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;00000001f757bb737f6596503e17cd17b0658ce630cc727c0cca81aec47c9f06&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="521">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="522">
          
          
          <code class="ruby">      :alert_pubkeys =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="523">
          
          
          <code class="ruby">      :known_nodes =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="524">
          
          
          <code class="ruby">      :checkpoints =&gt; {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="525">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="526">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="527">
          
          
          <code class="ruby">    :litecoin =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="528">
          
          
          <code class="ruby">      :project =&gt; :litecoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="529">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xfb\xc0\xb6\xdb&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="530">
          
          
          <code class="ruby">      :address_version =&gt; &quot;30&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="531">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;05&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="532">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;ef&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby">      :default_port =&gt; 9333,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="534">
          
          
          <code class="ruby">      :protocol_version =&gt; 60002,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="535">
          
          
          <code class="ruby">      :dns_seeds =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="536">
          
          
          <code class="ruby">        &quot;dnsseed.litecoinpool.org&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="537">
          
          
          <code class="ruby">        &quot;dnsseed.bytesized-vps.com&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="538">
          
          
          <code class="ruby">        &quot;dnsseed.ltc.xurious.com&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="539">
          
          
          <code class="ruby">      ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="540">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;12a765e31ffd4059bada1e25190f6e98c99d9714d334efa41a195a7e7e04bfe2&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="541">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="542">
          
          
          <code class="ruby">      :alert_pubkeys =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby">      :known_nodes =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="544">
          
          
          <code class="ruby">      :checkpoints =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="545">
          
          
          <code class="ruby">             1 =&gt; &quot;80ca095ed10b02e53d769eb6eaf92cd04e9e0759e5be4a8477b42911ba49c78f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="546">
          
          
          <code class="ruby">             2 =&gt; &quot;13957807cdd1d02f993909fa59510e318763f99a506c4c426e3b254af09f40d7&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="547">
          
          
          <code class="ruby">          1500 =&gt; &quot;841a2965955dd288cfa707a755d05a54e45f8bd476835ec9af4402a2b59a2967&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="548">
          
          
          <code class="ruby">          4032 =&gt; &quot;9ce90e427198fc0ef05e5905ce3503725b80e26afd35a987965fd7e3d9cf0846&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="549">
          
          
          <code class="ruby">          8064 =&gt; &quot;eb984353fc5190f210651f150c40b8a4bab9eeeff0b729fcb3987da694430d70&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="550">
          
          
          <code class="ruby">         16128 =&gt; &quot;602edf1859b7f9a6af809f1d9b0e6cb66fdc1d4d9dcd7a4bec03e12a1ccd153d&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="551">
          
          
          <code class="ruby">         23420 =&gt; &quot;d80fdf9ca81afd0bd2b2a90ac3a9fe547da58f2530ec874e978fce0b5101b507&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="552">
          
          
          <code class="ruby">         50000 =&gt; &quot;69dc37eb029b68f075a5012dcc0419c127672adb4f3a32882b2b3e71d07a20a6&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="553">
          
          
          <code class="ruby">         80000 =&gt; &quot;4fcb7c02f676a300503f49c764a89955a8f920b46a8cbecb4867182ecdb2e90a&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="554">
          
          
          <code class="ruby">        120000 =&gt; &quot;bd9d26924f05f6daa7f0155f32828ec89e8e29cee9e7121b026a7a3552ac6131&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="555">
          
          
          <code class="ruby">        161500 =&gt; &quot;dbe89880474f4bb4f75c227c77ba1cdc024991123b28b8418dbbf7798471ff43&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="556">
          
          
          <code class="ruby">        179620 =&gt; &quot;2ad9c65c990ac00426d18e446e0fd7be2ffa69e9a7dcb28358a50b2b78b9f709&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="557">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="558">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="559">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="560">
          
          
          <code class="ruby">    :litecoin_testnet =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="561">
          
          
          <code class="ruby">      :project =&gt; :litecoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="562">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xfc\xc1\xb7\xdc&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="563">
          
          
          <code class="ruby">      :address_version =&gt; &quot;6f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="564">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;c4&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="565">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;ef&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="566">
          
          
          <code class="ruby">      :default_port =&gt; 19333,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="567">
          
          
          <code class="ruby">      :protocol_version =&gt; 60002,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="568">
          
          
          <code class="ruby">      :dns_seeds =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;f5ae71e26c74beacc88382716aced69cddf3dffff24f384e1808905e0188f68f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="570">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="571">
          
          
          <code class="ruby">      :alert_pubkeys =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="572">
          
          
          <code class="ruby">      :known_nodes =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="573">
          
          
          <code class="ruby">      :checkpoints =&gt; {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="574">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="575">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="576">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="577">
          
          
          <code class="ruby">    :freicoin =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="578">
          
          
          <code class="ruby">      :project =&gt; :freicoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="579">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\x2c\xfe\x7e\x6d&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="580">
          
          
          <code class="ruby">      :address_version =&gt; &quot;00&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;05&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="582">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;80&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="583">
          
          
          <code class="ruby">      :default_port =&gt; 8639,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="584">
          
          
          <code class="ruby">      :protocol_version =&gt; 60002,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="585">
          
          
          <code class="ruby">      :dns_seeds =&gt; [ &quot;seed.freico.in&quot;, &quot;fledge.freico.in&quot; ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="586">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;000000005b1e3d23ecfd2dd4a6e1a35238aa0392c0a8528c40df52376d7efe2c&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="587">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="588">
          
          
          <code class="ruby">      :alert_pubkeys =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="589">
          
          
          <code class="ruby">      :known_nodes =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="590">
          
          
          <code class="ruby">      :checkpoints =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="591">
          
          
          <code class="ruby">        10080 =&gt; &quot;00000000003ff9c4b806639ec4376cc9acafcdded0e18e9dbcc2fc42e8e72331&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby">        15779 =&gt; &quot;000000000003eb31742b35f5efd8ffb5cdd19dcd8e82cdaad90e592c450363b6&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="593">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="594">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="595">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="596">
          
          
          <code class="ruby">    :namecoin =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="597">
          
          
          <code class="ruby">      :project =&gt; :namecoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="598">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xF9\xBE\xB4\xFE&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="599">
          
          
          <code class="ruby">      :address_version =&gt; &quot;34&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="600">
          
          
          <code class="ruby">      :default_port =&gt; 8334,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="601">
          
          
          <code class="ruby">      :protocol_version =&gt; 35000,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="602">
          
          
          <code class="ruby">      :dns_seeds =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="603">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;000000000062b72c5e2ceb45fbc8587e807c155b0da735e6483dfba2f0a9c770&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="604">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0x1d00ffff,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="605">
          
          
          <code class="ruby">      :known_nodes =&gt; [&quot;bitcoin.tunl.in&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="606">
          
          
          <code class="ruby">      :checkpoints =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="607">
          
          
          <code class="ruby">        0 =&gt; &quot;000000000062b72c5e2ceb45fbc8587e807c155b0da735e6483dfba2f0a9c770&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="608">
          
          
          <code class="ruby">        19200 =&gt; &quot;d8a7c3e01e1e95bcee015e6fcc7583a2ca60b79e5a3aa0a171eddd344ada903d&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="609">
          
          
          <code class="ruby">        24000 =&gt; &quot;425ab0983cf04f43f346a4ca53049d0dc2db952c0a68eb0b55c3bb64108d5371&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="610">
          
          
          <code class="ruby">        97778 =&gt; &quot;7553b1e43da01cfcda4335de1caf623e941d43894bd81c2af27b6582f9d83c6f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="611">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="612">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="613">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="614">
          
          
          <code class="ruby">    :namecoin_testnet =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="615">
          
          
          <code class="ruby">      :project =&gt; :namecoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="616">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xFA\xBF\xB5\xFE&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="617">
          
          
          <code class="ruby">      :address_version =&gt; &quot;34&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="618">
          
          
          <code class="ruby">      :default_port =&gt; 18334,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="619">
          
          
          <code class="ruby">      :protocol_version =&gt; 35000,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="620">
          
          
          <code class="ruby">      :dns_seeds =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="621">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;00000001f8ab0d14bceaeb50d163b0bef15aecf62b87bd5f5c864d37f201db97&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="622">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0x1d00ffff,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby">      :known_nodes =&gt; [&quot;178.32.31.41&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="624">
          
          
          <code class="ruby">      :checkpoints =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="625">
          
          
          <code class="ruby">        0 =&gt; &quot;000000000062b72c5e2ceb45fbc8587e807c155b0da735e6483dfba2f0a9c770&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="626">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="627">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="628">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="629">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="630">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6ad895c6fd6140cbd279d839c3cab431fd71d2a7">
  <div class="header">
    <h3>lib/bitcoin/builder.rb</h3>
    <h4><span class="green">91.47 %</span> covered</h4>
    <div>
      <b>129</b> relevant lines. 
      <span class="green"><b>118</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # Optional DSL to help create blocks and transactions.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # see also BlockBuilder, TxBuilder, TxInBuilder, TxOutBuilder, ScriptBuilder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  module Builder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # build a Bitcoin::Protocol::Block matching the given +target+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # see BlockBuilder for details.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    def build_block(target = &quot;00&quot;.ljust(64, &#39;f&#39;))</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="13">
          <span class="hits">205</span>
          
          <code class="ruby">      c = BlockBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="14">
          <span class="hits">205</span>
          
          <code class="ruby">      yield c</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="15">
          <span class="hits">205</span>
          
          <code class="ruby">      c.block(target)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    alias :blk :build_block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # build a Bitcoin::Protocol::Tx.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # see TxBuilder for details.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    def build_tx</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="22">
          <span class="hits">33</span>
          
          <code class="ruby">      c = TxBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="23">
          <span class="hits">33</span>
          
          <code class="ruby">      yield c</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="24">
          <span class="hits">33</span>
          
          <code class="ruby">      c.tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    alias :tx :build_tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # build a Bitcoin::Script.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # see ScriptBuilder for details.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    def script</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="31">
          <span class="hits">3</span>
          
          <code class="ruby">      c = ScriptBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="32">
          <span class="hits">3</span>
          
          <code class="ruby">      yield c</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="33">
          <span class="hits">3</span>
          
          <code class="ruby">      c.script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    # DSL to create a Bitcoin::Protocol::Block used by Builder#blk.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    #  block = blk(&quot;00&quot;.ljust(32, &#39;f&#39;)) do |b|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    #    b.prev_block &quot;\x00&quot;*32</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    #    b.tx do |t|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    #      t.input {|i| i.coinbase }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    #      t.output do |o|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    #        o.value 5000000000;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    #        o.script do |s|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    #          s.type :address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    #          s.recipient Bitcoin::Key.generate.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    #        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    #      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    #    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    #  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    class BlockBuilder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="53">
          <span class="hits">205</span>
          
          <code class="ruby">        @block = Bitcoin::P::Block.new(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      # specify block version. this is usually not necessary. defaults to 1.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">      def version v</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        @version = v</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      # set the hash of the previous block.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      def prev_block hash</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="63">
          <span class="hits">205</span>
          
          <code class="ruby">        @prev_block = hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      # set the block timestamp (defaults to current time).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">      def time time</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="68">
          <span class="hits">44</span>
          
          <code class="ruby">        @time = time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      # add transactions to the block (see TxBuilder).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">      def tx</code>
        </li>
      
        <li class="covered" data-hits="218" data-linenumber="73">
          <span class="hits">218</span>
          
          <code class="ruby">        c = TxBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="218" data-linenumber="74">
          <span class="hits">218</span>
          
          <code class="ruby">        yield c</code>
        </li>
      
        <li class="covered" data-hits="218" data-linenumber="75">
          <span class="hits">218</span>
          
          <code class="ruby">        @block.tx &lt;&lt; c.tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      # create the block according to values specified via DSL.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">      def block target</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="80">
          <span class="hits">205</span>
          
          <code class="ruby">        @block.ver = @version || 1</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="81">
          <span class="hits">205</span>
          
          <code class="ruby">        @block.prev_block = [@prev_block].pack(&quot;H*&quot;).reverse</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="82">
          <span class="hits">205</span>
          
          <code class="ruby">        @block.mrkl_root = @mrkl_root</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="83">
          <span class="hits">205</span>
          
          <code class="ruby">        @block.time = @time || Time.now.to_i</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="84">
          <span class="hits">205</span>
          
          <code class="ruby">        @block.nonce = 0</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="85">
          <span class="hits">205</span>
          
          <code class="ruby">        @block.mrkl_root = [Bitcoin.hash_mrkl_tree(@block.tx.map {|t|</code>
        </li>
      
        <li class="covered" data-hits="218" data-linenumber="86">
          <span class="hits">218</span>
          
          <code class="ruby">              t.hash }).last].pack(&quot;H*&quot;).reverse</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="87">
          <span class="hits">205</span>
          
          <code class="ruby">        find_hash(target)</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="88">
          <span class="hits">205</span>
          
          <code class="ruby">        Bitcoin::P::Block.new(@block.to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      # increment nonce/time to find a block hash matching the +target+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">      def find_hash target</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="95">
          <span class="hits">205</span>
          
          <code class="ruby">        @block.bits = Bitcoin.encode_compact_bits(target)</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="96">
          <span class="hits">205</span>
          
          <code class="ruby">        t = Time.now</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="97">
          <span class="hits">205</span>
          
          <code class="ruby">        @block.recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="98">
          <span class="hits">205</span>
          
          <code class="ruby">        until @block.hash &lt; target</code>
        </li>
      
        <li class="covered" data-hits="51502" data-linenumber="99">
          <span class="hits">51502</span>
          
          <code class="ruby">          @block.nonce += 1</code>
        </li>
      
        <li class="covered" data-hits="51502" data-linenumber="100">
          <span class="hits">51502</span>
          
          <code class="ruby">          @block.recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="51502" data-linenumber="101">
          <span class="hits">51502</span>
          
          <code class="ruby">          if @block.nonce == 100000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">            if t</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">              tt = 1 / ((Time.now - t) / 100000) / 1000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">              print &quot;\r%.2f khash/s&quot; % tt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">            t = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">            @block.time = Time.now.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">            @block.nonce = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">            $stdout.flush</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    # DSL to create Bitcoin::Protocol::Tx used by Builder#tx.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    # tx = tx do |t|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    #   t.input do |i|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    #     i.prev_out prev_tx  # previous transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    #     i.prev_out_index 0  # index of previous output</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    #     i.signature_key key # Bitcoin::Key used to sign the input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    #   t.output do |o|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    #     o.value 12345 # 0.00012345 BTC</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    #     o.script {|s| s.type :address; s.recipient key.addr }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxBuilder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="131">
          <span class="hits">251</span>
          
          <code class="ruby">        @tx = Bitcoin::P::Tx.new(nil)</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="132">
          <span class="hits">251</span>
          
          <code class="ruby">        @tx.ver, @tx.lock_time = 1, 0</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="133">
          <span class="hits">251</span>
          
          <code class="ruby">        @ins, @outs = [], []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      # specify tx version. this is usually not necessary. defaults to 1.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">      def version n</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">        @tx.ver = n</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      # specify tx lock_time. this is usually not necessary. defaults to 0.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">      def lock_time n</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">        @tx.lock_time = n</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      # add an input to the transaction (see TxInBuilder).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">      def input</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="148">
          <span class="hits">251</span>
          
          <code class="ruby">        c = TxInBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="149">
          <span class="hits">251</span>
          
          <code class="ruby">        yield c</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="150">
          <span class="hits">251</span>
          
          <code class="ruby">        @ins &lt;&lt; c</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      # add an output to the transaction (see TxOutBuilder).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">      def output</code>
        </li>
      
        <li class="covered" data-hits="263" data-linenumber="155">
          <span class="hits">263</span>
          
          <code class="ruby">        c = TxOutBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="263" data-linenumber="156">
          <span class="hits">263</span>
          
          <code class="ruby">        yield c</code>
        </li>
      
        <li class="covered" data-hits="263" data-linenumber="157">
          <span class="hits">263</span>
          
          <code class="ruby">        @outs &lt;&lt; c</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      # create the transaction according to values specified via DSL and sign inputs.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">      def tx</code>
        </li>
      
        <li class="covered" data-hits="502" data-linenumber="162">
          <span class="hits">502</span>
          
          <code class="ruby">        @ins.each {|i| @tx.add_in(i.txin) }</code>
        </li>
      
        <li class="covered" data-hits="514" data-linenumber="163">
          <span class="hits">514</span>
          
          <code class="ruby">        @outs.each {|o| @tx.add_out(o.txout) }</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="164">
          <span class="hits">251</span>
          
          <code class="ruby">        @ins.each_with_index do |inc, i|</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="165">
          <span class="hits">251</span>
          
          <code class="ruby">          if @tx.in[i].coinbase?</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="166">
          <span class="hits">205</span>
          
          <code class="ruby">            script_sig = [inc.coinbase_data].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="167">
          <span class="hits">205</span>
          
          <code class="ruby">            @tx.in[i].script_sig_length = script_sig.bytesize</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="168">
          <span class="hits">205</span>
          
          <code class="ruby">            @tx.in[i].script_sig = script_sig</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="169">
          <span class="hits">205</span>
          
          <code class="ruby">            next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="171">
          <span class="hits">46</span>
          
          <code class="ruby">          prev_tx = inc.instance_variable_get(:@prev_out)</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="172">
          <span class="hits">46</span>
          
          <code class="ruby">          sig_hash = @tx.signature_hash_for_input(i, prev_tx)</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="173">
          <span class="hits">46</span>
          
          <code class="ruby">          sig = inc.key.sign(sig_hash)</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="174">
          <span class="hits">46</span>
          
          <code class="ruby">          script_sig = Bitcoin::Script.to_signature_pubkey_script(sig, [inc.key.pub].pack(&quot;H*&quot;))</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="175">
          <span class="hits">46</span>
          
          <code class="ruby">          @tx.in[i].script_sig_length = script_sig.bytesize</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="176">
          <span class="hits">46</span>
          
          <code class="ruby">          @tx.in[i].script_sig = script_sig</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="177">
          <span class="hits">46</span>
          
          <code class="ruby">          raise &quot;Signature error&quot;  unless @tx.verify_input_signature(i, prev_tx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="179">
          <span class="hits">251</span>
          
          <code class="ruby">        Bitcoin::P::Tx.new(@tx.to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">    # create a Bitcoin::Protocol::TxIn used by TxBuilder#input.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    # inputs can be either &#39;coinbase&#39;, in which case they only need to specify #coinbase,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    # or they have to define a #prev_out, #prev_out_index and #signature key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxInBuilder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :key, :coinbase_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="191">
          <span class="hits">251</span>
          
          <code class="ruby">        @txin = Bitcoin::P::TxIn.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      # previous transaction that contains the output we want to use.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="195">
          <span class="hits">1</span>
          
          <code class="ruby">      def prev_out tx</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="196">
          <span class="hits">46</span>
          
          <code class="ruby">        @prev_out = tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      # index of the output in the #prev_out transaction.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">      def prev_out_index i</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="201">
          <span class="hits">46</span>
          
          <code class="ruby">        @prev_out_index = i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">      # specify sequence. this is usually not needed.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">      def sequence s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">        @sequence = s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      # Bitcoin::Key used to sign the signature_hash for the input.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      # see Bitcoin::Script.signature_hash_for_input and Bitcoin::Key.sign.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">      def signature_key key</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="212">
          <span class="hits">46</span>
          
          <code class="ruby">        @key = key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">      # specify that this is a coinbase input. optionally set +data+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">      def coinbase data = nil</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="217">
          <span class="hits">205</span>
          
          <code class="ruby">        @coinbase_data = data || OpenSSL::Random.random_bytes(32)</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="218">
          <span class="hits">205</span>
          
          <code class="ruby">        @prev_out = nil</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="219">
          <span class="hits">205</span>
          
          <code class="ruby">        @prev_out_index = 4294967295</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      # create the txin according to values specified via DSL</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">      def txin</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="224">
          <span class="hits">251</span>
          
          <code class="ruby">        @txin.prev_out = (@prev_out ? @prev_out.binary_hash : &quot;\x00&quot;*32)</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="225">
          <span class="hits">251</span>
          
          <code class="ruby">        @txin.prev_out_index = @prev_out_index</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="226">
          <span class="hits">251</span>
          
          <code class="ruby">        @txin.sequence = @sequence || &quot;\xff\xff\xff\xff&quot;</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="227">
          <span class="hits">251</span>
          
          <code class="ruby">        @txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">    # create a Bitcoin::Script used by TxOutBuilder#script.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">    class ScriptBuilder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="236">
          <span class="hits">266</span>
          
          <code class="ruby">        @type = :address</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="237">
          <span class="hits">266</span>
          
          <code class="ruby">        @script = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">      # script type (:pubkey, :address/hash160, :multisig).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">      def type type</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="242">
          <span class="hits">33</span>
          
          <code class="ruby">        @type = type.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      # recipient(s) of the script.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">      # depending on the #type, either an address, hash160 pubkey, etc.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">      def recipient *data</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="248">
          <span class="hits">266</span>
          
          <code class="ruby">        @script = Bitcoin::Script.send(&quot;to_#{@type}_script&quot;, *data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">    # create a Bitcoin::Protocol::TxOut used by TxBuilder#output.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxOutBuilder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="256">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="263" data-linenumber="257">
          <span class="hits">263</span>
          
          <code class="ruby">        @txout = Bitcoin::P::TxOut.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">      # set output value (in base units / &quot;satoshis&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="261">
          <span class="hits">1</span>
          
          <code class="ruby">      def value value</code>
        </li>
      
        <li class="covered" data-hits="263" data-linenumber="262">
          <span class="hits">263</span>
          
          <code class="ruby">        @txout.value = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">      # add a script to the output (see ScriptBuilder).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">      def script &amp;block</code>
        </li>
      
        <li class="covered" data-hits="263" data-linenumber="267">
          <span class="hits">263</span>
          
          <code class="ruby">        c = ScriptBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="263" data-linenumber="268">
          <span class="hits">263</span>
          
          <code class="ruby">        yield c</code>
        </li>
      
        <li class="covered" data-hits="263" data-linenumber="269">
          <span class="hits">263</span>
          
          <code class="ruby">        @txout.pk_script = c.script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2dcb72f38404c85bd4fe44aeed3d3b7e4562fc0c">
  <div class="header">
    <h3>lib/bitcoin/ffi/openssl.rb</h3>
    <h4><span class="green">97.14 %</span> covered</h4>
    <div>
      <b>140</b> relevant lines. 
      <span class="green"><b>136</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># autoload when you need to re-generate a public_key from only its private_key.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># ported from: https://github.com/sipa/bitcoin/blob/2d40fe4da9ea82af4b652b691a4185431d6e47a8/key.h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">Bitcoin.require_dependency :ffi, exit: false, message: &quot;Skipping FFI needed for OpenSSL_EC methods.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">module OpenSSL_EC</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  extend FFI::Library</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  ffi_lib &#39;ssl&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  NID_secp256k1 = 714</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  POINT_CONVERSION_COMPRESSED = 2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  POINT_CONVERSION_UNCOMPRESSED = 4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :SSL_library_init, [], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :ERR_load_crypto_strings, [], :void</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :SSL_load_error_strings, [], :void</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :RAND_poll, [], :int</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_CTX_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_CTX_new, [], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_add, [:pointer, :pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_bin2bn, [:pointer, :int, :pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_bn2bin, [:pointer, :pointer], :void</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_cmp, [:pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_copy, [:pointer, :pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_dup, [:pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_mod_inverse, [:pointer, :pointer, :pointer, :pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_mod_mul, [:pointer, :pointer, :pointer, :pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_mod_sub, [:pointer, :pointer, :pointer, :pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_mul_word, [:pointer, :int], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_new, [], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_rshift, [:pointer, :pointer, :int], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_set_word, [:pointer, :int], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_GROUP_get_curve_GFp, [:pointer, :pointer, :pointer, :pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_GROUP_get_degree, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_GROUP_get_order, [:pointer, :pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_get0_group, [:pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_get0_private_key, [:pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_new_by_curve_name, [:int], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_set_conv_form, [:pointer, :int], :void</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_set_private_key, [:pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_set_public_key,  [:pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_is_at_infinity, [:pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_mul, [:pointer, :pointer, :pointer, :pointer, :pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_new, [:pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_set_compressed_coordinates_GFp, [:pointer, :pointer, :pointer, :int, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :d2i_ECPrivateKey, [:pointer, :pointer, :long], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :i2d_ECPrivateKey, [:pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :i2o_ECPublicKey, [:pointer, :pointer], :uint</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  # resolve public from private key, using ffi and libssl.so</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  # example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  #   keypair = Bitcoin.generate_key; Bitcoin::OpenSSL_EC.regenerate_key(keypair.first) == keypair</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.regenerate_key(private_key)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="62">
          <span class="hits">333</span>
          
          <code class="ruby">    private_key = [private_key].pack(&quot;H*&quot;) if private_key.bytesize &gt;= (32*2)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="63">
          <span class="hits">333</span>
          
          <code class="ruby">    private_key_hex = private_key.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    #private_key = FFI::MemoryPointer.new(:uint8, private_key.bytesize)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    #                .put_bytes(0, private_key, 0, private_key.bytesize)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="67">
          <span class="hits">333</span>
          
          <code class="ruby">    private_key = FFI::MemoryPointer.from_string(private_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="69">
          <span class="hits">333</span>
          
          <code class="ruby">    init_ffi_ssl</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="70">
          <span class="hits">333</span>
          
          <code class="ruby">    eckey = EC_KEY_new_by_curve_name(NID_secp256k1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    #priv_key = BN_bin2bn(private_key, private_key.size, BN_new())</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="72">
          <span class="hits">333</span>
          
          <code class="ruby">    priv_key = BN_bin2bn(private_key, private_key.size-1, BN_new())</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="74">
          <span class="hits">333</span>
          
          <code class="ruby">    group, order, ctx = EC_KEY_get0_group(eckey), BN_new(), BN_CTX_new()</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="75">
          <span class="hits">333</span>
          
          <code class="ruby">    EC_GROUP_get_order(group, order, ctx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="77">
          <span class="hits">333</span>
          
          <code class="ruby">    pub_key = EC_POINT_new(group)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="78">
          <span class="hits">333</span>
          
          <code class="ruby">    EC_POINT_mul(group, pub_key, priv_key, nil, nil, ctx)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="79">
          <span class="hits">333</span>
          
          <code class="ruby">    EC_KEY_set_private_key(eckey, priv_key)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="80">
          <span class="hits">333</span>
          
          <code class="ruby">    EC_KEY_set_public_key(eckey, pub_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="82">
          <span class="hits">333</span>
          
          <code class="ruby">    BN_free(order)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="83">
          <span class="hits">333</span>
          
          <code class="ruby">    BN_CTX_free(ctx)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="84">
          <span class="hits">333</span>
          
          <code class="ruby">    EC_POINT_free(pub_key)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="85">
          <span class="hits">333</span>
          
          <code class="ruby">    BN_free(priv_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="88">
          <span class="hits">333</span>
          
          <code class="ruby">    length = i2d_ECPrivateKey(eckey, nil)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="89">
          <span class="hits">333</span>
          
          <code class="ruby">    buf = FFI::MemoryPointer.new(:uint8, length)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="90">
          <span class="hits">333</span>
          
          <code class="ruby">    ptr = FFI::MemoryPointer.new(:pointer).put_pointer(0, buf)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="91">
          <span class="hits">333</span>
          
          <code class="ruby">    priv_hex = if i2d_ECPrivateKey(eckey, ptr) == length</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="92">
          <span class="hits">333</span>
          
          <code class="ruby">      size = buf.get_array_of_uint8(8, 1)[0]</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="93">
          <span class="hits">333</span>
          
          <code class="ruby">      buf.get_array_of_uint8(9, size).pack(&quot;C*&quot;).rjust(32, &quot;\x00&quot;).unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      #der_to_private_key( ptr.read_pointer.read_string(length).unpack(&quot;H*&quot;)[0] )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="97">
          <span class="hits">333</span>
          
          <code class="ruby">    if priv_hex != private_key_hex</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      raise &quot;regenerated wrong private_key, raise here before generating a faulty public_key too!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="102">
          <span class="hits">333</span>
          
          <code class="ruby">    length = i2o_ECPublicKey(eckey, nil)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="103">
          <span class="hits">333</span>
          
          <code class="ruby">    buf = FFI::MemoryPointer.new(:uint8, length)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="104">
          <span class="hits">333</span>
          
          <code class="ruby">    ptr = FFI::MemoryPointer.new(:pointer).put_pointer(0, buf)</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="105">
          <span class="hits">333</span>
          
          <code class="ruby">    pub_hex = if i2o_ECPublicKey(eckey, ptr) == length</code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="106">
          <span class="hits">333</span>
          
          <code class="ruby">      buf.read_string(length).unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="109">
          <span class="hits">333</span>
          
          <code class="ruby">    EC_KEY_free(eckey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="333" data-linenumber="111">
          <span class="hits">333</span>
          
          <code class="ruby">    [ priv_hex, pub_hex ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  # extract private key from uncompressed DER format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.der_to_private_key(der_hex)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">    init_ffi_ssl</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    #k  = EC_KEY_new_by_curve_name(NID_secp256k1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    #kp = FFI::MemoryPointer.new(:pointer).put_pointer(0, eckey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">    buf = FFI::MemoryPointer.from_string([der_hex].pack(&quot;H*&quot;))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">    ptr = FFI::MemoryPointer.new(:pointer).put_pointer(0, buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    #ec_key = d2i_ECPrivateKey(kp, ptr, buf.size-1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    ec_key = d2i_ECPrivateKey(nil, ptr, buf.size-1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">    return nil if ec_key.null?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">    bn = EC_KEY_get0_private_key(ec_key)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    BN_bn2bin(bn, buf)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">    buf.read_string(32).unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  # Given the components of a signature and a selector value, recover and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  # return the public key that generated the signature according to the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  # algorithm in SEC1v2 section 4.1.6.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  # rec_id is an index from 0 to 3 that indicates which of the 4 possible</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">  # keys is the correct one. Because the key recovery operation yields</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  # multiple potential keys, the correct key must either be stored alongside</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  # the signature, or you must be willing to try each rec_id in turn until</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  # you find one that outputs the key you are expecting.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  # If this method returns nil, it means recovery was not possible and rec_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  # should be iterated.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  # Given the above two points, a correct usage of this method is inside a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  # for loop from 0 to 3, and if the output is nil OR a key that is not the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  # one you expect, you try again with the next rec_id.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">  #   message_hash = hash of the signed message.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  #   signature = the R and S components of the signature, wrapped.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  #   rec_id = which possible key to recover.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  #   is_compressed = whether or not the original pubkey was compressed.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.recover_public_key_from_signature(message_hash, signature, rec_id, is_compressed)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="153">
          <span class="hits">5</span>
          
          <code class="ruby">    return nil if rec_id &lt; 0 or signature.bytesize != 65</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="154">
          <span class="hits">5</span>
          
          <code class="ruby">    init_ffi_ssl</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="156">
          <span class="hits">5</span>
          
          <code class="ruby">    signature = FFI::MemoryPointer.from_string(signature)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    #signature_bn = BN_bin2bn(signature, 65, BN_new())</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="158">
          <span class="hits">5</span>
          
          <code class="ruby">    r = BN_bin2bn(signature[1], 32, BN_new())</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="159">
          <span class="hits">5</span>
          
          <code class="ruby">    s = BN_bin2bn(signature[33], 32, BN_new())</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="161">
          <span class="hits">5</span>
          
          <code class="ruby">    n, i = 0, rec_id / 2</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="162">
          <span class="hits">5</span>
          
          <code class="ruby">    eckey = EC_KEY_new_by_curve_name(NID_secp256k1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="164">
          <span class="hits">5</span>
          
          <code class="ruby">    EC_KEY_set_conv_form(eckey, POINT_CONVERSION_COMPRESSED) if is_compressed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="166">
          <span class="hits">5</span>
          
          <code class="ruby">    group = EC_KEY_get0_group(eckey)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="167">
          <span class="hits">5</span>
          
          <code class="ruby">    order = BN_new()</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="168">
          <span class="hits">5</span>
          
          <code class="ruby">    EC_GROUP_get_order(group, order, nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="169">
          <span class="hits">5</span>
          
          <code class="ruby">    x = BN_dup(order)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="170">
          <span class="hits">5</span>
          
          <code class="ruby">    BN_mul_word(x, i)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="171">
          <span class="hits">5</span>
          
          <code class="ruby">    BN_add(x, x, r)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="173">
          <span class="hits">5</span>
          
          <code class="ruby">    field = BN_new()</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="174">
          <span class="hits">5</span>
          
          <code class="ruby">    EC_GROUP_get_curve_GFp(group, field, nil, nil, nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="176">
          <span class="hits">5</span>
          
          <code class="ruby">    if BN_cmp(x, field) &gt;= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">      [r, s, order, x, field].each{|i| BN_free(i) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">      EC_KEY_free(eckey)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="182">
          <span class="hits">5</span>
          
          <code class="ruby">    big_r = EC_POINT_new(group)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="183">
          <span class="hits">5</span>
          
          <code class="ruby">    EC_POINT_set_compressed_coordinates_GFp(group, big_r, x, rec_id % 2, nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="185">
          <span class="hits">5</span>
          
          <code class="ruby">    big_q = EC_POINT_new(group)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="186">
          <span class="hits">5</span>
          
          <code class="ruby">    n = EC_GROUP_get_degree(group)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="187">
          <span class="hits">5</span>
          
          <code class="ruby">    e = BN_bin2bn(message_hash, message_hash.bytesize, BN_new())</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="188">
          <span class="hits">5</span>
          
          <code class="ruby">    BN_rshift(e, e, 8 - (n &amp; 7)) if 8 * message_hash.bytesize &gt; n</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="190">
          <span class="hits">5</span>
          
          <code class="ruby">    ctx = BN_CTX_new()</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="191">
          <span class="hits">5</span>
          
          <code class="ruby">    zero, rr, sor, eor = BN_new(), BN_new(), BN_new(), BN_new()</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="192">
          <span class="hits">5</span>
          
          <code class="ruby">    BN_set_word(zero, 0)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="193">
          <span class="hits">5</span>
          
          <code class="ruby">    BN_mod_sub(e, zero, e, order, ctx)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="194">
          <span class="hits">5</span>
          
          <code class="ruby">    BN_mod_inverse(rr, r, order, ctx)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="195">
          <span class="hits">5</span>
          
          <code class="ruby">    BN_mod_mul(sor, s, rr, order, ctx)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="196">
          <span class="hits">5</span>
          
          <code class="ruby">    BN_mod_mul(eor, e, rr, order, ctx)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="197">
          <span class="hits">5</span>
          
          <code class="ruby">    EC_POINT_mul(group, big_q, eor, big_r, sor, ctx)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="198">
          <span class="hits">5</span>
          
          <code class="ruby">    EC_KEY_set_public_key(eckey, big_q)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="199">
          <span class="hits">5</span>
          
          <code class="ruby">    BN_CTX_free(ctx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="55" data-linenumber="201">
          <span class="hits">55</span>
          
          <code class="ruby">    [r, s, order, x, field, e, zero, rr, sor, eor].each{|i| BN_free(i) }</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="202">
          <span class="hits">15</span>
          
          <code class="ruby">    [big_r, big_q].each{|i| EC_POINT_free(i) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="204">
          <span class="hits">5</span>
          
          <code class="ruby">    length = i2o_ECPublicKey(eckey, nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="205">
          <span class="hits">5</span>
          
          <code class="ruby">    buf = FFI::MemoryPointer.new(:uint8, length)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="206">
          <span class="hits">5</span>
          
          <code class="ruby">    ptr = FFI::MemoryPointer.new(:pointer).put_pointer(0, buf)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="207">
          <span class="hits">5</span>
          
          <code class="ruby">    pub_hex = if i2o_ECPublicKey(eckey, ptr) == length</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="208">
          <span class="hits">5</span>
          
          <code class="ruby">      buf.read_string(length).unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="211">
          <span class="hits">5</span>
          
          <code class="ruby">    EC_KEY_free(eckey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="213">
          <span class="hits">5</span>
          
          <code class="ruby">    pub_hex</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.init_ffi_ssl</code>
        </li>
      
        <li class="covered" data-hits="339" data-linenumber="217">
          <span class="hits">339</span>
          
          <code class="ruby">    return if @ssl_loaded</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">    SSL_library_init()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">    ERR_load_crypto_strings()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">    SSL_load_error_strings()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">    RAND_poll()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="222">
          <span class="hits">1</span>
          
          <code class="ruby">    @ssl_loaded = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="eb82939148b5de4151cdeacc2d9ed89caee32ee5">
  <div class="header">
    <h3>lib/bitcoin/key.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>77</b> relevant lines. 
      <span class="green"><b>77</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # Elliptic Curve key as used in bitcoin.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  class Key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # Generate a new keypair.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    #  Bitcoin::Key.generate</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.generate</code>
        </li>
      
        <li class="covered" data-hits="95" data-linenumber="11">
          <span class="hits">95</span>
          
          <code class="ruby">      k = new; k.generate; k</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # Import private key from base58 fromat as described in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # https://en.bitcoin.it/wiki/Private_key#Base_58_Wallet_Import_format and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # https://en.bitcoin.it/wiki/Base58Check_encoding#Encoding_a_private_key.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # See also #to_base58</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.from_base58(str)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="19">
          <span class="hits">45</span>
          
          <code class="ruby">      hex = Bitcoin.decode_base58(str)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="20">
          <span class="hits">45</span>
          
          <code class="ruby">      compressed = hex.size == 76</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="21">
          <span class="hits">45</span>
          
          <code class="ruby">      version, key, flag, checksum = hex.unpack(&quot;a2a64a#{compressed ? 2 : 0}a8&quot;)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="22">
          <span class="hits">45</span>
          
          <code class="ruby">      raise &quot;Invalid version&quot;   unless version == Bitcoin.network[:privkey_version]</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="23">
          <span class="hits">45</span>
          
          <code class="ruby">      raise &quot;Invalid checksum&quot;  unless Bitcoin.checksum(version + key + flag) == checksum</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="24">
          <span class="hits">45</span>
          
          <code class="ruby">      key = new(key, nil, compressed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    def == other</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="28">
          <span class="hits">7</span>
          
          <code class="ruby">      self.priv == other.priv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    # Create a new key with given +privkey+ and +pubkey+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    #  Bitcoin::Key.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    #  Bitcoin::Key.new(privkey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    #  Bitcoin::Key.new(nil, pubkey)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize privkey = nil, pubkey = nil, compressed = false</code>
        </li>
      
        <li class="covered" data-hits="486" data-linenumber="36">
          <span class="hits">486</span>
          
          <code class="ruby">      @key = Bitcoin.bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="486" data-linenumber="37">
          <span class="hits">486</span>
          
          <code class="ruby">      @pubkey_compressed = compressed</code>
        </li>
      
        <li class="covered" data-hits="486" data-linenumber="38">
          <span class="hits">486</span>
          
          <code class="ruby">      set_priv(privkey)  if privkey</code>
        </li>
      
        <li class="covered" data-hits="486" data-linenumber="39">
          <span class="hits">486</span>
          
          <code class="ruby">      set_pub(pubkey)  if pubkey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    # Generate new priv/pub key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate</code>
        </li>
      
        <li class="covered" data-hits="100" data-linenumber="44">
          <span class="hits">100</span>
          
          <code class="ruby">      @key.generate_key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    # Get the private key (in hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    def priv</code>
        </li>
      
        <li class="covered" data-hits="159" data-linenumber="49">
          <span class="hits">159</span>
          
          <code class="ruby">      return nil  unless @key.private_key</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="50">
          <span class="hits">111</span>
          
          <code class="ruby">      @key.private_key.to_hex.rjust(64, &#39;0&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    # Set the private key to +priv+ (in hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    def priv= priv</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      set_priv(priv)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    # Get the public key (in hex).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    # In case the key was initialized with only</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    # a private key, the public key is regenerated.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    def pub</code>
        </li>
      
        <li class="covered" data-hits="515" data-linenumber="62">
          <span class="hits">515</span>
          
          <code class="ruby">      @pubkey_compressed ? pub_compressed : pub_uncompressed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    def pub_compressed</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="66">
          <span class="hits">12</span>
          
          <code class="ruby">      regenerate_pubkey unless @key.public_key</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="67">
          <span class="hits">12</span>
          
          <code class="ruby">      return nil        unless @key.public_key</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="68">
          <span class="hits">12</span>
          
          <code class="ruby">      @key.public_key.group.point_conversion_form = :compressed</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="69">
          <span class="hits">12</span>
          
          <code class="ruby">      hex = @key.public_key.to_hex.rjust(66, &#39;0&#39;)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="70">
          <span class="hits">12</span>
          
          <code class="ruby">      @key.public_key.group.point_conversion_form = :uncompressed</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="71">
          <span class="hits">12</span>
          
          <code class="ruby">      hex</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    def pub_uncompressed</code>
        </li>
      
        <li class="covered" data-hits="507" data-linenumber="75">
          <span class="hits">507</span>
          
          <code class="ruby">      regenerate_pubkey unless @key.public_key</code>
        </li>
      
        <li class="covered" data-hits="507" data-linenumber="76">
          <span class="hits">507</span>
          
          <code class="ruby">      return nil        unless @key.public_key</code>
        </li>
      
        <li class="covered" data-hits="428" data-linenumber="77">
          <span class="hits">428</span>
          
          <code class="ruby">      @key.public_key.group.point_conversion_form = :uncompressed</code>
        </li>
      
        <li class="covered" data-hits="428" data-linenumber="78">
          <span class="hits">428</span>
          
          <code class="ruby">      @key.public_key.to_hex.rjust(130, &#39;0&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def compressed</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="82">
          <span class="hits">5</span>
          
          <code class="ruby">      @pubkey_compressed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    # Set the public key (in hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    def pub= pub</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">      set_pub(pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # Get the hash160 of the public key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160</code>
        </li>
      
        <li class="covered" data-hits="319" data-linenumber="92">
          <span class="hits">319</span>
          
          <code class="ruby">      Bitcoin.hash160(pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    # Get the address corresponding to the public key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    def addr</code>
        </li>
      
        <li class="covered" data-hits="316" data-linenumber="97">
          <span class="hits">316</span>
          
          <code class="ruby">      Bitcoin.hash160_to_address(hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    # Sign +data+ with the key.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    #  key1 = Bitcoin::Key.generate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    #  sig = key.sign(&quot;some data&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">    def sign(data)</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="104">
          <span class="hits">54</span>
          
          <code class="ruby">      @key.dsa_sign_asn1(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    # Verify signature +sig+ for +data+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    #  key2 = Bitcoin::Key.new(nil, key1.pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    #  key2.verify(&quot;some data&quot;, sig)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    def verify(data, sig)</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="111">
          <span class="hits">65</span>
          
          <code class="ruby">      @key.dsa_verify_asn1(data, sig)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    # Thanks to whoever wrote http://pastebin.com/bQtdDzHx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    # for help with compact signatures</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    # Given +data+ and a compact signature (65 bytes, base64-encoded to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    # a larger string), recover the public components of the key whose</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    # private counterpart validly signed +data+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    # If the signature validly signed +data+, create a new Key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    # having the signing public key and address. Otherwise return nil.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    # Be sure to check that the returned Key matches the one you were</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    # expecting! Otherwise you are merely checking that *someone* validly</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    # signed the data.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.recover_compact_signature_to_key(data, signature_base64)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="128">
          <span class="hits">4</span>
          
          <code class="ruby">      signature = signature_base64.unpack(&quot;m0&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="129">
          <span class="hits">4</span>
          
          <code class="ruby">      return nil if signature.size != 65</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="131">
          <span class="hits">4</span>
          
          <code class="ruby">      version = signature.unpack(&#39;c&#39;)[0]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="132">
          <span class="hits">4</span>
          
          <code class="ruby">      return nil if version &lt; 27 or version &gt; 34</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="134">
          <span class="hits">4</span>
          
          <code class="ruby">      compressed = (version &gt;= 31) ? (version -= 4; true) : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="136">
          <span class="hits">4</span>
          
          <code class="ruby">      hash = Bitcoin.bitcoin_byte_hash(Bitcoin::Key.wrap_message_in_magic(data))</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="137">
          <span class="hits">4</span>
          
          <code class="ruby">      pub_hex = Bitcoin::OpenSSL_EC.recover_public_key_from_signature(hash, signature, version-27, compressed)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="138">
          <span class="hits">4</span>
          
          <code class="ruby">      return nil unless pub_hex</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="140">
          <span class="hits">4</span>
          
          <code class="ruby">      Key.new(nil, pub_hex)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    # Export private key to base58 format.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    # See also Key.from_base58</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_base58</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="146">
          <span class="hits">8</span>
          
          <code class="ruby">      data = Bitcoin.network[:privkey_version] + priv</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="147">
          <span class="hits">8</span>
          
          <code class="ruby">      data += &quot;01&quot;  if @pubkey_compressed</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="148">
          <span class="hits">8</span>
          
          <code class="ruby">      hex  = data + Bitcoin.checksum(data)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="149">
          <span class="hits">8</span>
          
          <code class="ruby">      Bitcoin.int_to_base58( hex.to_i(16) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.wrap_message_in_magic(message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      # TODO: this will fail horribly on messages with len &gt; 255. It&#39;s a cheap implementation of Bitcoin&#39;s CDataStream.</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="156">
          <span class="hits">4</span>
          
          <code class="ruby">      &quot;\x18Bitcoin Signed Message:\n#{message.length.chr}#{message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    # Regenerate public key from the private key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">    def regenerate_pubkey</code>
        </li>
      
        <li class="covered" data-hits="107" data-linenumber="161">
          <span class="hits">107</span>
          
          <code class="ruby">      return nil unless @key.private_key</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="162">
          <span class="hits">28</span>
          
          <code class="ruby">      set_pub(Bitcoin::OpenSSL_EC.regenerate_key(priv)[1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    # Set +priv+ as the new private key (converting from hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">    def set_priv(priv)</code>
        </li>
      
        <li class="covered" data-hits="149" data-linenumber="167">
          <span class="hits">149</span>
          
          <code class="ruby">      @key.private_key = OpenSSL::BN.from_hex(priv)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    # Set +pub+ as the new public key (converting from hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">    def set_pub(pub)</code>
        </li>
      
        <li class="covered" data-hits="224" data-linenumber="172">
          <span class="hits">224</span>
          
          <code class="ruby">      @pubkey_compressed ||= [&quot;02&quot;,&quot;03&quot;].include?(pub[0..1])</code>
        </li>
      
        <li class="covered" data-hits="224" data-linenumber="173">
          <span class="hits">224</span>
          
          <code class="ruby">      @key.public_key = OpenSSL::PKey::EC::Point.from_hex(@key.group, pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f5d6d97008ffec5aff3bc91103ab60ec056c27d1">
  <div class="header">
    <h3>lib/bitcoin/logger.rb</h3>
    <h4><span class="yellow">80.56 %</span> covered</h4>
    <div>
      <b>36</b> relevant lines. 
      <span class="green"><b>29</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">if Bitcoin.require_dependency :log4r, exit: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # monkey-patch Log4r to accept level names as symbols</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  class Log4r::Logger</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    def level= l = 0</code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="7">
          <span class="hits">147</span>
          
          <code class="ruby">      _level = l.is_a?(Fixnum) ? l : Log4r::LNAMES.index(l.to_s.upcase)</code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="8">
          <span class="hits">147</span>
          
          <code class="ruby">      Log4r::Log4rTools.validate_level(_level)</code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="9">
          <span class="hits">147</span>
          
          <code class="ruby">      @level = _level</code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="10">
          <span class="hits">147</span>
          
          <code class="ruby">      LoggerFactory.define_methods(self)</code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="11">
          <span class="hits">147</span>
          
          <code class="ruby">      Log4r::Logger.log_internal {&quot;Logger &#39;#{@fullname}&#39; set to #{LNAMES[@level]}&quot;}</code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="12">
          <span class="hits">147</span>
          
          <code class="ruby">      @level</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # this is a very simple logger that is used if log4r is not available</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  module Logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    class Logger</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      LEVELS = [:debug, :info, :warn, :error, :fatal]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :level</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        @name, @level = name, :info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">      def level= level</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        @level = level.is_a?(Fixnum) ? LEVELS[level] : level.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      LEVELS.each do |level|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="35">
          <span class="hits">5</span>
          
          <code class="ruby">        define_method(level) do |*msg, &amp;block|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">          return  if LEVELS.index(level.to_sym) &lt; LEVELS.index(@level.to_sym)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">          msg = block ? block.call : msg.join</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">          puts &quot;#{level.to_s.upcase.ljust(5)} #{@name}: #{msg}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # wrap a logger and prepend a special name in front of the messages</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    class LogWrapper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(name, log); @name, @log = name, log; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">      def method_missing(m, *a, &amp;blk)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        @log.send(m, *a, &amp;proc{ &quot;#{@name} #{blk.call}&quot; })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    # create a logger with given +name+. if log4r is installed, the logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    # will have a stdout and a fileout outputter to `log/&lt;name&gt;.log`.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    # otherwise, the internal dummy logger is used which only logs to stdout.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.create name, level = :info</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="55">
          <span class="hits">60</span>
          
          <code class="ruby">      if defined?(Log4r)</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="56">
          <span class="hits">60</span>
          
          <code class="ruby">        FileUtils.mkdir_p(&quot;log&quot;)</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="57">
          <span class="hits">60</span>
          
          <code class="ruby">        @log = Log4r::Logger.new(name.to_s)</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="58">
          <span class="hits">60</span>
          
          <code class="ruby">        @log.level = level</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="59">
          <span class="hits">60</span>
          
          <code class="ruby">        @log.outputters &lt;&lt; Log4r::Outputter.stdout</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="60">
          <span class="hits">60</span>
          
          <code class="ruby">        @log.outputters &lt;&lt; Log4r::FileOutputter.new(&quot;fout&quot;, :filename =&gt; &quot;log/#{name}.log&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        @log = Bitcoin::Logger::Logger.new(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="64">
          <span class="hits">60</span>
          
          <code class="ruby">      @log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="021236b87a55c3912ce0a2591b4797a70dc78009">
  <div class="header">
    <h3>lib/bitcoin/namecoin.rb</h3>
    <h4><span class="yellow">87.72 %</span> covered</h4>
    <div>
      <b>57</b> relevant lines. 
      <span class="green"><b>50</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Namecoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  module Script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.included(base)</code>
        </li>
      
        <li class="covered" data-hits="909" data-linenumber="8">
          <span class="hits">909</span>
          
          <code class="ruby">      base.constants.each {|c| const_set(c, base.const_get(c)) unless constants.include?(c) }</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="9">
          <span class="hits">9</span>
          
          <code class="ruby">      base.class_eval do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">        # get the hash160 for this hash160, namecoin or pubkey script</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="12">
          <span class="hits">9</span>
          
          <code class="ruby">        def get_hash160</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="13">
          <span class="hits">23</span>
          
          <code class="ruby">          return @chunks[2..-3][0].unpack(&quot;H*&quot;)[0]  if is_hash160?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="14">
          <span class="hits">6</span>
          
          <code class="ruby">          return @chunks[-3].unpack(&quot;H*&quot;)[0]        if is_namecoin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">          return Bitcoin.hash160(get_pubkey)        if is_pubkey?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        # get all addresses this script corresponds to (if possible)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="19">
          <span class="hits">9</span>
          
          <code class="ruby">        def get_addresses</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">          return [get_pubkey_address]    if is_pubkey?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">          return [get_hash160_address]   if is_hash160? || is_namecoin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">          return get_multisig_addresses  if is_multisig?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        # get type of this tx</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="26">
          <span class="hits">9</span>
          
          <code class="ruby">        def type</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="27">
          <span class="hits">29</span>
          
          <code class="ruby">          if is_name_new?;            :name_new</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="28">
          <span class="hits">27</span>
          
          <code class="ruby">          elsif is_name_firstupdate?; :name_firstupdate</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="29">
          <span class="hits">21</span>
          
          <code class="ruby">          elsif is_name_update?;      :name_update</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="30">
          <span class="hits">17</span>
          
          <code class="ruby">          elsif is_hash160?;          :hash160</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">          elsif is_pubkey?;           :pubkey</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">          elsif is_multisig?;         :multisig</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">          elsif is_p2sh?;             :p2sh</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">          else;                       :unknown</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        # is namecoin name_new script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        # OP_1 name_hash OP_2DROP &lt;hash160_script&gt;</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="40">
          <span class="hits">9</span>
          
          <code class="ruby">        def is_name_new?</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="41">
          <span class="hits">48</span>
          
          <code class="ruby">          return false  if @chunks.size &lt; 8</code>
        </li>
      
        <li class="covered" data-hits="186" data-linenumber="42">
          <span class="hits">186</span>
          
          <code class="ruby">          [-8, -6, -5, -4, -2, -1].map {|i| @chunks[i] } ==</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="43">
          <span class="hits">31</span>
          
          <code class="ruby">            [OP_1, OP_2DROP, OP_DUP, OP_HASH160, OP_EQUALVERIFY, OP_CHECKSIG]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        # is namecoin name_firstupdate script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        # OP_2 name rand value OP_2DROP OP_2DROP &lt;hash160_script&gt;</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="48">
          <span class="hits">9</span>
          
          <code class="ruby">        def is_name_firstupdate?</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="49">
          <span class="hits">52</span>
          
          <code class="ruby">          return false  if @chunks.size &lt; 11</code>
        </li>
      
        <li class="covered" data-hits="168" data-linenumber="50">
          <span class="hits">168</span>
          
          <code class="ruby">          [-11, -7, -6, -5, -4, -2, -1].map {|i| @chunks[i] } ==</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="51">
          <span class="hits">24</span>
          
          <code class="ruby">            [82, OP_2DROP, OP_2DROP, OP_DUP, OP_HASH160, OP_EQUALVERIFY, OP_CHECKSIG]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">        # is namecoin name_update script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        # OP_3 name value OP_2DROP OP_DROP &lt;hash160_script&gt;</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="56">
          <span class="hits">9</span>
          
          <code class="ruby">        def is_name_update?</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="57">
          <span class="hits">32</span>
          
          <code class="ruby">          return false  if @chunks.size &lt; 10</code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="58">
          <span class="hits">105</span>
          
          <code class="ruby">          [-10, -7, -6, -5, -4, -2, -1].map {|i| @chunks[i] } ==</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="59">
          <span class="hits">15</span>
          
          <code class="ruby">            [83, OP_2DROP, OP_DROP, OP_DUP, OP_HASH160, OP_EQUALVERIFY, OP_CHECKSIG]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        # is any kind of namecoin script</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="63">
          <span class="hits">9</span>
          
          <code class="ruby">        def is_namecoin?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="64">
          <span class="hits">12</span>
          
          <code class="ruby">          is_name_new? || is_name_firstupdate? || is_name_update?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        # get the name_hash of a namecoin name_new script</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="68">
          <span class="hits">9</span>
          
          <code class="ruby">        def get_namecoin_hash</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="69">
          <span class="hits">4</span>
          
          <code class="ruby">          return @chunks[-7].hth  if is_name_new?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="70">
          <span class="hits">2</span>
          
          <code class="ruby">          if is_name_firstupdate?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="71">
          <span class="hits">2</span>
          
          <code class="ruby">            name = @chunks[-10].to_s.hth</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="72">
          <span class="hits">2</span>
          
          <code class="ruby">            rand = @chunks[-9].to_s.hth</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="73">
          <span class="hits">2</span>
          
          <code class="ruby">            return Bitcoin.hash160(rand + name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">          nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        # get the name of a namecoin name_firstupdate or name_update script</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="80">
          <span class="hits">9</span>
          
          <code class="ruby">        def get_namecoin_name</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="81">
          <span class="hits">5</span>
          
          <code class="ruby">          return @chunks[-10]  if is_name_firstupdate?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="82">
          <span class="hits">2</span>
          
          <code class="ruby">          return @chunks[-9]  if is_name_update?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        # get the value of a namecoin name_firstupdate or name_update script</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="86">
          <span class="hits">9</span>
          
          <code class="ruby">        def get_namecoin_value</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="87">
          <span class="hits">5</span>
          
          <code class="ruby">          @chunks[-8]  if is_name_firstupdate? || is_name_update?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        # generate name_new tx for given +name+ and +address+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        # the +caller+ should be the object that creates the script.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        # it gets the used random value passed to #set_rand.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        # OP_1 name_hash OP_2DROP &lt;hash160_script&gt;</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="94">
          <span class="hits">9</span>
          
          <code class="ruby">        def self.to_name_new_script(caller, name, address)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="95">
          <span class="hits">2</span>
          
          <code class="ruby">          rand = rand(2**64).to_s(16).rjust(16, &#39;0&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="96">
          <span class="hits">2</span>
          
          <code class="ruby">          name_hash = Bitcoin.hash160(rand + name.unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">          caller.set_rand rand # TODO: this is still ugly</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="98">
          <span class="hits">2</span>
          
          <code class="ruby">          [ [ &quot;51&quot;, &quot;14&quot;,   name_hash, &quot;6d&quot; ].join ].pack(&quot;H*&quot;) + to_address_script(address)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        # generate name_firstupdate tx for given +name+, +rand+, +value+ and +address+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        # OP_2 name rand value OP_2DROP OP_2DROP &lt;hash160_script&gt;</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="103">
          <span class="hits">9</span>
          
          <code class="ruby">        def self.to_name_firstupdate_script(name, rand, value, address)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">          [ [ &quot;52&quot;, name.bytesize.to_s(16).rjust(2, &#39;0&#39;), name.hth,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">              rand.htb.bytesize.to_s(16).rjust(2, &#39;0&#39;), rand,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">              value.bytesize.to_s(16).rjust(2, &#39;0&#39;), value.hth,</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="107">
          <span class="hits">3</span>
          
          <code class="ruby">              &quot;6d&quot;, &quot;6d&quot; ].join ].pack(&quot;H*&quot;) + to_address_script(address)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        # generate name_update script for given +name+, +value+ and +address+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        # OP_3 name value OP_2DROP OP_DROP &lt;hash160_script&gt;</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="112">
          <span class="hits">9</span>
          
          <code class="ruby">        def self.to_name_update_script(name, value, address)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          [ [ &quot;53&quot;, name.bytesize.to_s(16).rjust(2, &#39;0&#39;), name.hth,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">              value.bytesize.to_s(16).rjust(2, &#39;0&#39;), value.hth,</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="115">
          <span class="hits">2</span>
          
          <code class="ruby">              &quot;6d&quot;, &quot;75&quot; ].join ].pack(&quot;H*&quot;) + to_address_script(address)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="c2066d8e979ddb719a0b52c66f77f9345bb881e3">
  <div class="header">
    <h3>lib/bitcoin/network/command_client.rb</h3>
    <h4><span class="yellow">89.8 %</span> covered</h4>
    <div>
      <b>49</b> relevant lines. 
      <span class="green"><b>44</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Client to connect to CommandHandler and issue requests or register for events</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">class Bitcoin::Network::CommandClient &lt; EM::Connection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # create new client connecting to +host+:+port+ and executing callbacks from +block+,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # passing +args+ in.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  #  CommandClient.connect(host, port) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #    on_connected { request(&quot;info&quot;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #    on_info {|i| p i}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize host, port, block, *args</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="13">
          <span class="hits">37</span>
          
          <code class="ruby">    @host, @port = host, port</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="14">
          <span class="hits">37</span>
          
          <code class="ruby">    @args = args</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="15">
          <span class="hits">37</span>
          
          <code class="ruby">    @callbacks = {}</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="16">
          <span class="hits">37</span>
          
          <code class="ruby">    @block = block</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="17">
          <span class="hits">37</span>
          
          <code class="ruby">    instance_eval &amp;block  if block</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="18">
          <span class="hits">37</span>
          
          <code class="ruby">    @buffer = BufferedTokenizer.new(&quot;\x00&quot;)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="19">
          <span class="hits">37</span>
          
          <code class="ruby">    @connection_attempts = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def log;</code>
        </li>
      
        <li class="covered" data-hits="316" data-linenumber="23">
          <span class="hits">316</span>
          
          <code class="ruby">    @log ||= Bitcoin::Logger.create(:client)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.connect host, port, *args, &amp;block</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="27">
          <span class="hits">37</span>
          
          <code class="ruby">    client = EM.connect(host, port.to_i, self, host, port.to_i, block, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  # call +connected+ callback</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def post_init</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="32">
          <span class="hits">42</span>
          
          <code class="ruby">    log.debug { &quot;Connected&quot; }</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="33">
          <span class="hits">42</span>
          
          <code class="ruby">    callback :connected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  # call +disconnected+ callback and try to reconnect</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  def unbind</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="38">
          <span class="hits">42</span>
          
          <code class="ruby">    log.debug { &quot;Disconnected.&quot; }</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="39">
          <span class="hits">42</span>
          
          <code class="ruby">    callback :disconnected</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="40">
          <span class="hits">42</span>
          
          <code class="ruby">    EM.add_timer(@connection_attempts) do</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="41">
          <span class="hits">5</span>
          
          <code class="ruby">      @connection_attempts += 1</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="42">
          <span class="hits">5</span>
          
          <code class="ruby">      reconnect(@host, @port)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="43">
          <span class="hits">5</span>
          
          <code class="ruby">      post_init</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  # request command +cmd+ with +args+ from the server</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def request cmd, *args</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="49">
          <span class="hits">42</span>
          
          <code class="ruby">    log.debug { &quot;request: #{cmd} #{args.inspect}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="50">
          <span class="hits">42</span>
          
          <code class="ruby">    register_monitor_callbacks  if cmd.to_sym == :monitor</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="51">
          <span class="hits">42</span>
          
          <code class="ruby">    send_data([cmd, args].to_json + &quot;\x00&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  # receive response from server</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  def receive_data data</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="56">
          <span class="hits">37</span>
          
          <code class="ruby">    @connection_attempts = 0</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="57">
          <span class="hits">37</span>
          
          <code class="ruby">    @buffer.extract(data).each do |packet|</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="58">
          <span class="hits">37</span>
          
          <code class="ruby">      cmd, *data = *JSON.load(packet)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="59">
          <span class="hits">37</span>
          
          <code class="ruby">      log.debug { d = data.inspect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        &quot;response: #{cmd} #{d[0...50]}#{d.size &gt; 50 ? &#39;...&#39; : &#39;&#39;}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="61">
          <span class="hits">37</span>
          
          <code class="ruby">      callback(:response, cmd, *data)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="62">
          <span class="hits">37</span>
          
          <code class="ruby">      callback(cmd.to_sym, *data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  # call the callback specified by +name+ passing in +args+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def callback name, *args</code>
        </li>
      
        <li class="covered" data-hits="158" data-linenumber="68">
          <span class="hits">158</span>
          
          <code class="ruby">    cb = @callbacks[name.to_sym]</code>
        </li>
      
        <li class="covered" data-hits="158" data-linenumber="69">
          <span class="hits">158</span>
          
          <code class="ruby">    return  unless cb</code>
        </li>
      
        <li class="covered" data-hits="79" data-linenumber="70">
          <span class="hits">79</span>
          
          <code class="ruby">    log.debug { &quot;callback: #{name}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="79" data-linenumber="71">
          <span class="hits">79</span>
          
          <code class="ruby">    cb.call(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  # register callback methods</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def method_missing(name, *args, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="76">
          <span class="hits">74</span>
          
          <code class="ruby">    if name =~ /^on_/</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="77">
          <span class="hits">74</span>
          
          <code class="ruby">      @callbacks[name.to_s.split(&quot;on_&quot;)[1].to_sym] = block</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="78">
          <span class="hits">74</span>
          
          <code class="ruby">      log.debug { &quot;callback #{name} registered&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">      super(name, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  # register callbacks for monitor</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">  def register_monitor_callbacks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    on_monitor do |type, data|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      type, *params = type.split(&quot;_&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      callback(type, *((data || []) + (params || [])))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b871e365d6f70067f23b892e8c11e21927a1af95">
  <div class="header">
    <h3>lib/bitcoin/network/node.rb</h3>
    <h4><span class="red">30.4 %</span> covered</h4>
    <div>
      <b>250</b> relevant lines. 
      <span class="green"><b>76</b> lines covered</span> and
      <span class="red"><b>174</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">Bitcoin.require_dependency :eventmachine</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">Bitcoin.require_dependency :json</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Network</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  class Node</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # configuration hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # logger</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # connections to other peers (Array of ConnectionHandler)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :connections</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # command connections (Array of CommandHandler)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :command_connections</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # storage queue (blocks/tx waiting to be stored)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :queue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    # inventory queue (blocks/tx waiting to be downloaded)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :inv_queue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # inventory cache (blocks/tx recently downloaded)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :inv_cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    # Bitcoin::Storage backend</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    # peer addrs (Array of Bitcoin::Protocol::Addr)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :addrs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # clients to be notified for new block/tx events</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :notifiers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    # our external ip addresses we got told by peers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :external_ips</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    # time when the last main chain block was added</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :last_block_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :relay_propagation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    DEFAULT_CONFIG = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      :network =&gt; :bitcoin,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      :listen =&gt; &quot;0.0.0.0:#{Bitcoin.network[:default_port]}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      :connect =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      :command =&gt; &quot;127.0.0.1:9999&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      :storage =&gt; &quot;sequel::sqlite://~/.bitcoin-ruby/&lt;network&gt;/blocks.db&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      :mode =&gt; :full,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      :dns =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      :epoll =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      :epoll_limit =&gt; 10000,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      :epoll_user =&gt; nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      :addr_file =&gt; &quot;~/.bitcoin-ruby/&lt;network&gt;/peers.json&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      :log =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        :network =&gt; :info,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        :storage =&gt; :info,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      :max =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        :connections_out =&gt; 8,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        :connections_in =&gt; 32,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        :connections =&gt; 8,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        :addr =&gt; 256,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">        :queue =&gt; 501,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        :inv =&gt; 501,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">        :inv_cache =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        :unconfirmed =&gt; 3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      :intervals =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        :queue =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        :inv_queue =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        :addrs =&gt; 5,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        :connect =&gt; 5,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        :relay =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      :import =&gt; nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize config = {}</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="86">
          <span class="hits">21</span>
          
          <code class="ruby">      @config = DEFAULT_CONFIG.deep_merge(config)</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="87">
          <span class="hits">21</span>
          
          <code class="ruby">      @log = Bitcoin::Logger.create(:network, @config[:log][:network])</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="88">
          <span class="hits">21</span>
          
          <code class="ruby">      @connections, @command_connections = [], []</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="89">
          <span class="hits">21</span>
          
          <code class="ruby">      @queue, @queue_thread, @inv_queue, @inv_queue_thread = [], nil, [], nil</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="90">
          <span class="hits">21</span>
          
          <code class="ruby">      set_store</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="91">
          <span class="hits">21</span>
          
          <code class="ruby">      load_addrs</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="92">
          <span class="hits">21</span>
          
          <code class="ruby">      @timers = {}</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="93">
          <span class="hits">21</span>
          
          <code class="ruby">      @inv_cache = []</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="94">
          <span class="hits">21</span>
          
          <code class="ruby">      @notifiers = {}</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="95">
          <span class="hits">21</span>
          
          <code class="ruby">      @relay_propagation, @last_block_time, @external_ips = {}, Time.now, []</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="96">
          <span class="hits">21</span>
          
          <code class="ruby">      @unconfirmed = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">    def set_store</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="100">
          <span class="hits">21</span>
          
          <code class="ruby">      backend, config = @config[:storage].split(&#39;::&#39;)</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="101">
          <span class="hits">21</span>
          
          <code class="ruby">      @store = Bitcoin::Storage.send(backend, {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">          db: config, mode: @config[:mode], cache_head: true}, -&gt;(locator) {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">          peer = @connections.select(&amp;:connected?).sample</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          peer.send_getblocks(locator)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        })</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="106">
          <span class="hits">21</span>
          
          <code class="ruby">      @store.log.level = @config[:log][:storage]</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="107">
          <span class="hits">21</span>
          
          <code class="ruby">      if @config[:import]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        @importing = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        EM.defer do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">            @store.import(@config[:import]); @importing = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">          rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">            log.fatal { $!.message }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">            stop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">    def load_addrs</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="121">
          <span class="hits">21</span>
          
          <code class="ruby">      file = @config[:addr_file].sub(&quot;~&quot;, ENV[&quot;HOME&quot;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">        .sub(&quot;&lt;network&gt;&quot;, Bitcoin.network_name.to_s)</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="123">
          <span class="hits">21</span>
          
          <code class="ruby">      unless File.exist?(file)</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="124">
          <span class="hits">21</span>
          
          <code class="ruby">        @addrs = []</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="125">
          <span class="hits">21</span>
          
          <code class="ruby">        FileUtils.mkdir_p(File.dirname(file))</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="126">
          <span class="hits">21</span>
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      @addrs = JSON.load(File.read(file)).map do |a|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">        addr = Bitcoin::P::Addr.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">        addr.time, addr.service, addr.ip, addr.port =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          a[&#39;time&#39;], a[&#39;service&#39;], a[&#39;ip&#39;], a[&#39;port&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">        addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">      log.info { &quot;Initialized #{@addrs.size} addrs from #{file}.&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      @addrs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">      log.warn { &quot;Error loading addrs from #{file}.&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_addrs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      return  if !@addrs || !@addrs.any?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      file = @config[:addr_file].sub(&quot;~&quot;, ENV[&quot;HOME&quot;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        .sub(&quot;&lt;network&gt;&quot;, Bitcoin.network_name.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      FileUtils.mkdir_p(File.dirname(file))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      File.open(file, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">        addrs = @addrs.map {|a|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">          Hash[[:time, :service, :ip, :port].zip(a.entries)] rescue nil }.compact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">        f.write(JSON.pretty_generate(addrs))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      log.info { &quot;Stored #{@addrs.size} addrs to #{file}.&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      log.warn { &quot;Error storing addrs to #{file}.&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    def stop</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      log.info { &quot;Shutting down...&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">      EM.next_tick { EM.stop }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">    def uptime</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      (Time.now - @started).to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    def start_timers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      return EM.add_timer(1) { start_timers }  if @importing</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      [:queue, :inv_queue, :addrs, :connect, :relay].each do |name|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">        interval = @config[:intervals][name].to_f</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">        next  if !interval || interval == 0.0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">        @timers[name] = EM.add_periodic_timer(interval, method(&quot;work_#{name}&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">    def run</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      @started = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">      EM.add_shutdown_hook do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">        store_addrs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">        log.info { &quot;Bye&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      init_epoll  if @config[:epoll]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      EM.run do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">        start_timers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">        if @config[:command]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">          host, port = *@config[:command].split(&quot;:&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">          log.debug { &quot;Trying to bind command socket to #{host}:#{port}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">          EM.start_server(host, port, CommandHandler, self)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">          log.info { &quot;Command socket listening on #{host}:#{port}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">        if @config[:listen]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">          host, port = *@config[:listen].split(&quot;:&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">          log.debug { &quot;Trying to bind server socket to #{host}:#{port}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">          EM.start_server(host, port.to_i, ConnectionHandler, self, host, port.to_i, :in)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">          log.info { &quot;Server socket listening on #{host}:#{port}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">        @config[:connect].each{|h, p| connect_peer(h, p) }  if @config[:connect].size &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">        work_connect if @addrs.any?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">        connect_dns  if @config[:dns]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    # connect to peer at given +host+ / +port+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect_peer host, port</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">      return  if @connections.map{|c| c.host }.include?(host)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">      log.debug { &quot;Attempting to connect to #{host}:#{port}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">      EM.connect(host, port.to_i, ConnectionHandler, self, host, port.to_i, :out)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">      log.debug { &quot;Error connecting to #{host}:#{port}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">      log.debug { $!.inspect }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">    # query addrs from dns seed and connect</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect_dns</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">      unless Bitcoin.network[:dns_seeds].any?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">        log.warn { &quot;No DNS seed nodes available&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">        return connect_known_peers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">      connect_dns_resolver(Bitcoin.network[:dns_seeds].sample) do |addrs|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">        log.debug { &quot;DNS returned addrs: #{addrs.inspect}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">        addrs.sample(@config[:max][:connections_out] / 2).uniq.each do |addr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">          connect_peer(addr, Bitcoin.network[:default_port])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect_known_peers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">      log.debug { &quot;Attempting to connecting to known nodes&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">      Bitcoin.network[:known_nodes].shuffle[0..3].each do |node|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">        connect_peer node, Bitcoin.network[:default_port]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">    # get peer addrs from given dns +seed+ using em/dns_resolver.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">    # fallback to using `nslookup` if it is not installed or fails.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect_dns_resolver(seed)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">      if Bitcoin.require_dependency &quot;em/dns_resolver&quot;, gem: &quot;em-dns&quot;, exit: false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">        log.info { &quot;Querying addresses from DNS seed: #{seed}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">        dns = EM::DnsResolver.resolve(seed)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">        dns.callback {|addrs| yield(addrs) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">        dns.errback do |*a|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">          log.error { &quot;Cannot resolve DNS seed #{seed}: #{a.inspect}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">          connect_dns_nslookup(Bitcoin.network[:dns_seeds].sample) {|a| yield(a) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">        log.info { &quot;Falling back to nslookup resolver.&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">        connect_dns_nslookup(seed) {|a| yield(a) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">    # get peers from dns via nslookup</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect_dns_nslookup(seed)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">      log.info { &quot;Querying addresses from DNS seed: #{seed}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">      addrs = `nslookup #{seed}`.scan(/Address\: (.+)$/).flatten</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      #  exit  if @config[:dns] &amp;&amp; hosts.size == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">      yield(addrs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">    # check if there are enough connections and try to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    # establish new ones if needed</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="267">
          <span class="hits">1</span>
          
          <code class="ruby">    def work_connect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">      log.debug { &quot;Connect worker running&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">      desired = @config[:max][:connections_out] - @connections.select(&amp;:outgoing?).size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">      return  if desired &lt;= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">      desired = 32  if desired &gt; 32 # connect to max 32 peers at once</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">      if addrs.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">        addrs.sample(desired) do |addr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">          Time.now.tv_sec + 10800 - addr.time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">        end.each do |addr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">          connect_peer(addr.ip, addr.port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">      elsif @config[:dns]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">        connect_dns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">      log.error { &quot;Error during connect: #{$!.inspect}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    # query blocks from random peer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="286">
          <span class="hits">1</span>
          
          <code class="ruby">    def getblocks locator = store.get_locator</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">      peer = @connections.select(&amp;:connected?).sample</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">      return  unless peer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">      log.info { &quot;querying blocks from #{peer.host}:#{peer.port}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">      case @config[:mode]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      when /lite/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">        peer.send_getheaders locator  unless @queue.size &gt;= @config[:max][:queue]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">      when /full|pruned/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">        peer.send_getblocks locator  unless @inv_queue.size &gt;= @config[:max][:inv]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">    # check if the addr store is full and request new addrs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">    # from a random peer if it isn&#39;t</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="300">
          <span class="hits">1</span>
          
          <code class="ruby">    def work_addrs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">      log.debug { &quot;addr worker running&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">      @addrs.delete_if{|addr| !addr.alive? }  if @addrs.size &gt;= @config[:max][:addr]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">      return  if !@connections.any? || @config[:max][:connections] &lt;= @connections.size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">      connections = @connections.select(&amp;:connected?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">      return  unless connections.any?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">      log.info { &quot;requesting addrs&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">      connections.sample.send_getaddr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">    # check for new items in the queue and process them</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="311">
          <span class="hits">1</span>
          
          <code class="ruby">    def work_queue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">      @log.debug { &quot;queue worker running&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">      return  if @queue.size == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">      while obj = @queue.shift</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">          if obj[0].to_sym == :block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">            if res = @store.send(&quot;new_#{obj[0]}&quot;, obj[1])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">              if res[1] == 0  &amp;&amp; obj[1].hash == @store.get_head.hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">                @last_block_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">                push_notification(:block, [obj[1], res[0]])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">                obj[1].tx.each {|tx| @unconfirmed.delete(tx.hash) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">              getblocks  if res[1] == 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">            drop = @unconfirmed.size - @config[:max][:unconfirmed] + 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">            drop.times { @unconfirmed.shift }  if drop &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">            @unconfirmed[obj[1].hash] = obj[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">            push_notification(:tx, [obj[1], 0])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">            if @notifiers[:output]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">              obj[1].out.each do |out|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">                address = Bitcoin::Script.new(out.pk_script).get_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">                push_notification(:output, [obj[1].hash, address, out.value, 0])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">        rescue Bitcoin::Validation::ValidationError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">          @log.warn { &quot;ValiationError storing #{obj[0]} #{obj[1].hash}: #{$!.message}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">          # File.open(&quot;./validation_error_#{obj[0]}_#{obj[1].hash}.bin&quot;, &quot;w&quot;) {|f|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">          #   f.write(obj[1].to_payload) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">          # EM.stop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">        rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">          @log.warn { $!.inspect }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">          puts *$@</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">    # check for new items in the inv queue and process them,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">    # unless the queue is already full</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="353">
          <span class="hits">1</span>
          
          <code class="ruby">    def work_inv_queue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">      return  if @inv_queue.size == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">      @log.debug { &quot;inv queue worker running&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">      return  if @queue.size &gt;= @config[:max][:queue]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">      while inv = @inv_queue.shift</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">        next  if !@store.in_sync? &amp;&amp; inv[0] == :tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="359">
          
          
          <code class="ruby">        next  if @queue.map{|i|i[1]}.map(&amp;:hash).include?(inv[1])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">        inv[2].send(&quot;send_getdata_#{inv[0]}&quot;, inv[1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">    # queue inv, caching the most current ones</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="365">
          <span class="hits">1</span>
          
          <code class="ruby">    def queue_inv inv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">      hash = inv[1].unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">      return  if @inv_queue.include?(inv) || @queue.select {|i| i[1].hash == hash }.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">      return  if @store.send(&quot;has_#{inv[0]}&quot;, hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">#      @inv_cache.shift(128)  if @inv_cache.size &gt; @config[:max][:inv_cache]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">#      return  if @inv_cache.include?([inv[0], inv[1]]) ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">#        @inv_queue.size &gt;= @config[:max][:inv] ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">#        (!@store.in_sync? &amp;&amp; inv[0] == :tx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">#      @inv_cache &lt;&lt; [inv[0], inv[1]]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">      @inv_queue &lt;&lt; inv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">    # initiate epoll with given file descriptor and set effective user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="381">
          <span class="hits">1</span>
          
          <code class="ruby">    def init_epoll</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">      log.info { &quot;EPOLL: Available file descriptors: &quot; +</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">        EM.set_descriptor_table_size(@config[:epoll_limit]).to_s }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">      if @config[:epoll_user]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">        EM.set_effective_user(@config[:epoll_user])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">        log.info { &quot;EPOLL: Effective user set to: #{@config[:epoll_user]}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">      EM.epoll</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="391">
          <span class="hits">1</span>
          
          <code class="ruby">    def relay_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">      return false  unless @store.in_sync?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">      log.info { &quot;relaying tx #{tx.hash}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">      @store.store_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">      @connections.select(&amp;:connected?).sample((@connections.size / 2) + 1).each do |peer|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">        peer.send_inv(:tx, tx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">    rescue Bitcoin::Validation::ValidationError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">      @log.warn { &quot;ValiationError storing tx #{tx.hash}: #{$!.message}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="403">
          <span class="hits">1</span>
          
          <code class="ruby">    def work_relay</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">      log.debug { &quot;relay worker running&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">      @store.get_unconfirmed_tx.each do |tx|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">        relay_tx(tx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="411">
          <span class="hits">1</span>
          
          <code class="ruby">    def external_ip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">      @external_ips.inject({}) {|a, b| a[b] ||= 0; a[b] += 1; a }.sort_by {|k, v| v}[-1][0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">      @config[:listen].split(&quot;:&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="417">
          <span class="hits">1</span>
          
          <code class="ruby">    def push_notification channel, message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">      @notifiers[channel.to_sym].push(message)  if @notifiers[channel.to_sym]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="421">
          <span class="hits">1</span>
          
          <code class="ruby">    def subscribe channel</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">      @notifiers[channel.to_sym] ||= EM::Channel.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">      @notifiers[channel.to_sym].subscribe {|*data| yield(*data) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="429">
          <span class="hits">1</span>
          
          <code class="ruby">class Array</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="430">
          <span class="hits">1</span>
          
          <code class="ruby">  def random(weights=nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">    return random(map {|n| yield(n) })  if block_given?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">    return random(map {|n| n.send(weights) })  if weights.is_a? Symbol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">    weights ||= Array.new(length, 1.0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="435">
          
          
          <code class="ruby">    total = weights.inject(0.0) {|t,w| t+w}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">    point = rand * total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">    zip(weights).each do |n,w|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby">      return n if w &gt;= point</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">      point -= w</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="444">
          <span class="hits">1</span>
          
          <code class="ruby">  def weighted_sample(n, weights = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="445">
          
          
          <code class="ruby">    src = dup</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="446">
          
          
          <code class="ruby">    buf = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">    n = src.size  if n &gt; src.size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">    while buf.size &lt; n</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="449">
          
          
          <code class="ruby">      if block_given?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="450">
          
          
          <code class="ruby">        item = src.random {|n| yield(n) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="452">
          
          
          <code class="ruby">        item = src.random(weights)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">      buf &lt;&lt; item; src.delete(item)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby">    buf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="459">
          <span class="hits">1</span>
          
          <code class="ruby">  class ::Hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="460">
          <span class="hits">1</span>
          
          <code class="ruby">    def deep_merge(hash)</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="461">
          <span class="hits">63</span>
          
          <code class="ruby">      target = dup</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="462">
          <span class="hits">63</span>
          
          <code class="ruby">      hash.keys.each do |key|</code>
        </li>
      
        <li class="covered" data-hits="189" data-linenumber="463">
          <span class="hits">189</span>
          
          <code class="ruby">        if hash[key].is_a? Hash and self[key].is_a? Hash</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="464">
          <span class="hits">42</span>
          
          <code class="ruby">          target[key] = target[key].deep_merge(hash[key])</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="465">
          <span class="hits">42</span>
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="467">
          <span class="hits">147</span>
          
          <code class="ruby">        target[key] = hash[key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="469">
          <span class="hits">63</span>
          
          <code class="ruby">      target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="097a63ca9e1638fe6b84d7fad2f0982e08134c36">
  <div class="header">
    <h3>lib/bitcoin/protocol.rb</h3>
    <h4><span class="red">74.73 %</span> covered</h4>
    <div>
      <b>91</b> relevant lines. 
      <span class="green"><b>68</b> lines covered</span> and
      <span class="red"><b>23</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;socket&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;digest/sha2&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :TxIn,    &#39;bitcoin/protocol/txin&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :TxOut,   &#39;bitcoin/protocol/txout&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Tx,      &#39;bitcoin/protocol/tx&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Block,   &#39;bitcoin/protocol/block&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Addr,    &#39;bitcoin/protocol/address&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Alert,   &#39;bitcoin/protocol/alert&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Version, &#39;bitcoin/protocol/version&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :AuxPow,  &#39;bitcoin/protocol/aux_pow&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Handler, &#39;bitcoin/protocol/handler&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Parser,  &#39;bitcoin/protocol/parser&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    DNS_Seed = [ &quot;bitseed.xf2.org&quot;, &quot;bitseed.bitcoin.org.uk&quot; ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    Uniq = rand(0xffffffffffffffff)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="108" data-linenumber="26">
          <span class="hits">108</span>
          
          <code class="ruby">      case payload.unpack(&quot;C&quot;)[0] # TODO add test cases</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      when 0xfd; payload.unpack(&quot;xva*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      when 0xfe; payload.unpack(&quot;xVa*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      when 0xff; payload.unpack(&quot;xQa*&quot;) # TODO add little-endian version of Q</code>
        </li>
      
        <li class="covered" data-hits="108" data-linenumber="30">
          <span class="hits">108</span>
          
          <code class="ruby">      else;      payload.unpack(&quot;Ca*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_int_from_io(io)</code>
        </li>
      
        <li class="covered" data-hits="6141" data-linenumber="35">
          <span class="hits">6141</span>
          
          <code class="ruby">      uchar = io.read(1).unpack(&quot;C&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="6140" data-linenumber="36">
          <span class="hits">6140</span>
          
          <code class="ruby">      case uchar</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="37">
          <span class="hits">11</span>
          
          <code class="ruby">      when 0xfd; io.read(2).unpack(&quot;v&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      when 0xfe; io.read(4).unpack(&quot;V&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      when 0xff; io.read(8).unpack(&quot;Q&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="6129" data-linenumber="40">
          <span class="hits">6129</span>
          
          <code class="ruby">      else;      uchar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.pack_var_int(i)</code>
        </li>
      
        <li class="covered" data-hits="21884" data-linenumber="45">
          <span class="hits">21884</span>
          
          <code class="ruby">      if    i &lt;  0xfd;                [      i].pack(&quot;C&quot;)</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="46">
          <span class="hits">49</span>
          
          <code class="ruby">      elsif i &lt;= 0xffff;              [0xfd, i].pack(&quot;Cv&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      elsif i &lt;= 0xffffffff;          [0xfe, i].pack(&quot;CV&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      elsif i &lt;= 0xffffffffffffffff;  [0xff, i].pack(&quot;CQ&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      else raise &quot;int(#{i}) too large!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_string(payload)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="54">
          <span class="hits">12</span>
          
          <code class="ruby">      size, payload = unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="55">
          <span class="hits">12</span>
          
          <code class="ruby">      size &gt; 0 ? (string, payload = payload.unpack(&quot;a#{size}a*&quot;)) : [nil, payload]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_string_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">      size = unpack_var_int_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">      size &gt; 0 ? buf.read(size) : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.pack_var_string(payload)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="64">
          <span class="hits">7</span>
          
          <code class="ruby">      pack_var_int(payload.bytesize) + payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_string_array(payload) # unpacks set&lt;string&gt;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="68">
          <span class="hits">2</span>
          
          <code class="ruby">      size, payload = unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="69">
          <span class="hits">2</span>
          
          <code class="ruby">      return [nil, payload] if size == 0</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="70">
          <span class="hits">4</span>
          
          <code class="ruby">      [(0...size).map{ s, payload = unpack_var_string(payload); s }, payload]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_int_array(payload) # unpacks set&lt;int&gt;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="74">
          <span class="hits">2</span>
          
          <code class="ruby">      size, payload = unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="75">
          <span class="hits">2</span>
          
          <code class="ruby">      return [nil, payload] if size == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      [(0...size).map{ i, payload = unpack_var_int(payload); i }, payload]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    BINARY = Encoding.find(&#39;ASCII-8BIT&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.pkt(command, payload)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="82">
          <span class="hits">17</span>
          
          <code class="ruby">      cmd      = command.ljust(12, &quot;\x00&quot;)[0...12]</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="83">
          <span class="hits">17</span>
          
          <code class="ruby">      length   = [payload.bytesize].pack(&quot;V&quot;)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="84">
          <span class="hits">17</span>
          
          <code class="ruby">      checksum = Digest::SHA256.digest(Digest::SHA256.digest(payload))[0...4]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="86">
          <span class="hits">17</span>
          
          <code class="ruby">      [Bitcoin.network[:magic_head].force_encoding(BINARY), cmd.force_encoding(BINARY), length, checksum, payload.force_encoding(BINARY)].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.version_pkt(from_id, from=nil, to=nil, last_block=nil, time=nil, user_agent=nil, version=nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      opts = if from_id.is_a?(Hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        from_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        STDERR.puts &quot;Bitcoin::Protocol.version_pkt - API deprecated. please change it soon..&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">          :nonce =&gt; from_id, :from =&gt; from, :to =&gt; to, :last_block =&gt; last_block,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">          :time =&gt; time, :user_agent =&gt; user_agent, :version =&gt; version</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      version = Protocol::Version.new(opts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      version.to_pkt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.ping_pkt(nonce = rand(0xffffffff))</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="104">
          <span class="hits">2</span>
          
          <code class="ruby">      pkt(&quot;ping&quot;, [nonce].pack(&quot;Q&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.pong_pkt(nonce)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">      pkt(&quot;pong&quot;, [nonce].pack(&quot;Q&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.verack_pkt</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">      pkt(&quot;verack&quot;, &quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    TypeLookup = Hash[:tx, 1, :block, 2, nil, 0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.getdata_pkt(type, hashes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      return if hashes.size &gt;= 256</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      t = [ TypeLookup[type] ].pack(&quot;V&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">      pkt(&quot;getdata&quot;, [hashes.size].pack(&quot;C&quot;) + hashes.map{|hash| t + hash[0..32].reverse }.join)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.inv_pkt(type, hashes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      return if hashes.size &gt;= 256</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      t = [ TypeLookup[type] ].pack(&quot;V&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      pkt(&quot;inv&quot;, [hashes.size].pack(&quot;C&quot;) + hashes.map{|hash| t + hash[0..32].reverse }.join)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    DEFAULT_STOP_HASH = &quot;00&quot;*32</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.locator_payload(version, locator_hashes, stop_hash)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="132">
          <span class="hits">3</span>
          
          <code class="ruby">      payload = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">        [version].pack(&quot;V&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        pack_var_int(locator_hashes.size),</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="135">
          <span class="hits">6</span>
          
          <code class="ruby">        locator_hashes.map{|l| l.htb_reverse }.join,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        stop_hash.htb_reverse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      ].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.getblocks_pkt(version, locator_hashes, stop_hash=DEFAULT_STOP_HASH)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="141">
          <span class="hits">3</span>
          
          <code class="ruby">      pkt &quot;getblocks&quot;,  locator_payload(version, locator_hashes, stop_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.getheaders_pkt(version, locator_hashes, stop_hash=DEFAULT_STOP_HASH)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      pkt &quot;getheaders&quot;, locator_payload(version, locator_hashes, stop_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.read_binary_file(path)</code>
        </li>
      
        <li class="covered" data-hits="950" data-linenumber="149">
          <span class="hits">950</span>
          
          <code class="ruby">      File.open(path, &#39;rb&#39;){|f| f.read }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">  P = Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7232aa03263e2a301dcf3642c61bc0272ac13cbf">
  <div class="header">
    <h3>lib/bitcoin/protocol/address.rb</h3>
    <h4><span class="green">95.0 %</span> covered</h4>
    <div>
      <b>20</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class Addr &lt; Struct.new(:time, :service, :ip, :port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      # # IP Address / Port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      # attr_reader :ip, :port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      # # Time the node was last active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # attr_reader :time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # # Services supported by this node</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # attr_reader :service</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # create addr from raw binary +data+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data = nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="19">
          <span class="hits">5</span>
          
          <code class="ruby">        if data</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">          self[:time], self[:service], self[:ip], self[:port] = data.unpack(&quot;VQx12a4n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">          self[:ip] = ip.unpack(&quot;C*&quot;).join(&quot;.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="23">
          <span class="hits">3</span>
          
          <code class="ruby">          self[:time], self[:service] = Time.now.to_i, 1</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="24">
          <span class="hits">3</span>
          
          <code class="ruby">          self[:ip], self[:port] = &quot;127.0.0.1&quot;, Bitcoin.network[:default_port]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      # is this address alive?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      def alive?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">        (Time.now.tv_sec-7200) &lt;= self[:time]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="34">
          <span class="hits">4</span>
          
          <code class="ruby">        ip = self[:ip].split(&quot;.&quot;).map(&amp;:to_i)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="35">
          <span class="hits">4</span>
          
          <code class="ruby">        [ time, service, (&quot;\x00&quot;*10)+&quot;\xff\xff&quot;, *ip, port ].pack(&quot;VQa12C4n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">      def string</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        &quot;#{self[:ip]}:#{self[:port]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.pkt(*addrs)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="43">
          <span class="hits">2</span>
          
          <code class="ruby">        addrs = addrs.select{|i| i.is_a?(Bitcoin::Protocol::Addr) &amp;&amp; i.ip =~ /^\d+\.\d+\.\d+\.\d+$/ }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">        length = Bitcoin::Protocol.pack_var_int(addrs.size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">        Bitcoin::Protocol.pkt(&quot;addr&quot;, length + addrs.map(&amp;:to_payload).join)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7d06569f2eaac3f62f37ef5987a9d46ed2181b70">
  <div class="header">
    <h3>lib/bitcoin/protocol/alert.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>26</b> relevant lines. 
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  class Alert &lt; Struct.new(:version, :relay_until, :expiration, :id, :cancel, :set_cancel,</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">                           :min_ver, :max_ver, :set_sub_ver, :priority, :comment, :status_bar, :reserved)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :payload, :signature</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(values, alert_payload=nil, alert_signature=nil)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">      @payload, @signature = alert_payload, alert_signature</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">      super(*values)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    def valid_signature?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">      return false unless @payload &amp;&amp; @signature</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">      hash = Digest::SHA256.digest(Digest::SHA256.digest(@payload))</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="19">
          <span class="hits">4</span>
          
          <code class="ruby">      Bitcoin.network[:alert_pubkeys].any?{|public_key| Bitcoin.verify_signature(hash, @signature, public_key) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.parse(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">      count,             payload = Bitcoin::Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">      alert_payload,     payload = payload.unpack(&quot;a#{count}a*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="26">
          <span class="hits">2</span>
          
          <code class="ruby">      count,             payload = Bitcoin::Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="27">
          <span class="hits">2</span>
          
          <code class="ruby">      alert_signature,   payload = payload.unpack(&quot;a#{count}a*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="29">
          <span class="hits">2</span>
          
          <code class="ruby">      version, relay_until, expiration, id, cancel, payload = alert_payload.unpack(&quot;VQQVVa*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="31">
          <span class="hits">2</span>
          
          <code class="ruby">      set_cancel,        payload = Bitcoin::Protocol.unpack_var_int_array(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="32">
          <span class="hits">2</span>
          
          <code class="ruby">      min_ver, max_ver,  payload = payload.unpack(&quot;VVa*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="33">
          <span class="hits">2</span>
          
          <code class="ruby">      set_sub_ver,       payload = Bitcoin::Protocol.unpack_var_string_array(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="34">
          <span class="hits">2</span>
          
          <code class="ruby">      priority,          payload = payload.unpack(&quot;Va*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="35">
          <span class="hits">2</span>
          
          <code class="ruby">      comment,           payload = Bitcoin::Protocol.unpack_var_string(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">      status_bar,        payload = Bitcoin::Protocol.unpack_var_string(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="37">
          <span class="hits">2</span>
          
          <code class="ruby">      reserved,          payload = Bitcoin::Protocol.unpack_var_string(payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="39">
          <span class="hits">2</span>
          
          <code class="ruby">      values = [ version, relay_until, expiration, id, cancel, set_cancel, min_ver, max_ver, set_sub_ver, priority, comment, status_bar, reserved ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="41">
          <span class="hits">2</span>
          
          <code class="ruby">      new(values, alert_payload, alert_signature)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="72c96e47888f7a4335d66634fcf4f59c7b9ac9a3">
  <div class="header">
    <h3>lib/bitcoin/protocol/aux_pow.rb</h3>
    <h4><span class="red">74.29 %</span> covered</h4>
    <div>
      <b>70</b> relevant lines. 
      <span class="green"><b>52</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    # Auxiliary Proof-of-Work for merge-mined blockchains</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    class AuxPow</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      # Coinbase transaction linking the aux to its parent block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # Hash of the block header</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :block_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # Merkle branches to bring the transaction to the block&#39;s merkle root</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :branch</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # Index of this transaction in the merkle tree</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :mrkl_index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      # Merkle branches linking this aux chains to the aux root</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :aux_branch</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      # Index of &quot;this&quot; block chain in the aux chain list</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :aux_index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      # Parent block header</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :parent_block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="31">
          <span class="hits">7</span>
          
          <code class="ruby">        parse_data (data) if data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        @tx = P::Tx.new(nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        payload = @tx.parse_data(data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        @block_hash, payload = payload.unpack(&quot;a32a*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        branch_count, payload = P.unpack_var_int(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        @branch = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        branch_count.times {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          b, payload = payload.unpack(&quot;a32a*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          @branch &lt;&lt; b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        @mrkl_index, payload = payload.unpack(&quot;Ia*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        @aux_branch = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        aux_branch_count, payload = P.unpack_var_int(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        aux_branch_count.times {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">          b, payload = payload.unpack(&quot;a32a*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">          @aux_branch &lt;&lt; b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        @aux_index, payload = payload.unpack(&quot;Ia*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        block, payload = payload.unpack(&quot;a80a*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        @parent_block = P::Block.new(block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data_from_io(data)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="62">
          <span class="hits">5</span>
          
          <code class="ruby">        @tx = P::Tx.new(nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="63">
          <span class="hits">5</span>
          
          <code class="ruby">        @tx.parse_data_from_io(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="65">
          <span class="hits">5</span>
          
          <code class="ruby">        @block_hash = data.read(32)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="66">
          <span class="hits">5</span>
          
          <code class="ruby">        branch_count = P.unpack_var_int_from_io(data)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="67">
          <span class="hits">5</span>
          
          <code class="ruby">        @branch = []</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="68">
          <span class="hits">25</span>
          
          <code class="ruby">        branch_count.times{ @branch &lt;&lt; data.read(32) }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="69">
          <span class="hits">5</span>
          
          <code class="ruby">        @mrkl_index = data.read(4).unpack(&quot;I&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="71">
          <span class="hits">5</span>
          
          <code class="ruby">        @aux_branch = []</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="72">
          <span class="hits">5</span>
          
          <code class="ruby">        aux_branch_count = P.unpack_var_int_from_io(data)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="73">
          <span class="hits">5</span>
          
          <code class="ruby">        aux_branch_count.times{ @aux_branch &lt;&lt; data.read(32) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="75">
          <span class="hits">5</span>
          
          <code class="ruby">        @aux_index = data.read(4).unpack(&quot;I&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="76">
          <span class="hits">5</span>
          
          <code class="ruby">        block = data.read(80)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="77">
          <span class="hits">5</span>
          
          <code class="ruby">        @parent_block = P::Block.new(block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="79">
          <span class="hits">5</span>
          
          <code class="ruby">        data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="84">
          <span class="hits">10</span>
          
          <code class="ruby">        payload = @tx.to_payload</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="85">
          <span class="hits">10</span>
          
          <code class="ruby">        payload &lt;&lt; @block_hash</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="86">
          <span class="hits">10</span>
          
          <code class="ruby">        payload &lt;&lt; P.pack_var_int(@branch.count)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="87">
          <span class="hits">10</span>
          
          <code class="ruby">        payload &lt;&lt; @branch.join</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="88">
          <span class="hits">10</span>
          
          <code class="ruby">        payload &lt;&lt; [@mrkl_index].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="89">
          <span class="hits">10</span>
          
          <code class="ruby">        payload &lt;&lt; P.pack_var_int(@aux_branch.count)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="90">
          <span class="hits">10</span>
          
          <code class="ruby">        payload &lt;&lt; @aux_branch.join</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="91">
          <span class="hits">10</span>
          
          <code class="ruby">        payload &lt;&lt; [@aux_index].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="92">
          <span class="hits">10</span>
          
          <code class="ruby">        payload &lt;&lt; @parent_block.to_payload</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="93">
          <span class="hits">10</span>
          
          <code class="ruby">        payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash h</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">        aux_pow = new(nil)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="98">
          <span class="hits">2</span>
          
          <code class="ruby">        aux_pow.instance_eval do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="99">
          <span class="hits">2</span>
          
          <code class="ruby">          @tx = P::Tx.from_hash(h[&#39;tx&#39;])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="100">
          <span class="hits">2</span>
          
          <code class="ruby">          @block_hash = h[&#39;block_hash&#39;].htb</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="101">
          <span class="hits">2</span>
          
          <code class="ruby">          @branch = h[&#39;branch&#39;].map(&amp;:htb)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="102">
          <span class="hits">2</span>
          
          <code class="ruby">          @mrkl_index = h[&#39;mrkl_index&#39;]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="103">
          <span class="hits">2</span>
          
          <code class="ruby">          @aux_branch = h[&#39;aux_branch&#39;].map(&amp;:htb)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="104">
          <span class="hits">2</span>
          
          <code class="ruby">          @aux_index = h[&#39;aux_index&#39;]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="105">
          <span class="hits">2</span>
          
          <code class="ruby">          @parent_block = P::Block.from_hash(h[&#39;parent_block&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="107">
          <span class="hits">2</span>
          
          <code class="ruby">        aux_pow</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        { &#39;tx&#39; =&gt; @tx.to_hash,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">          &#39;block_hash&#39; =&gt; @block_hash.hth,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          &#39;branch&#39; =&gt; @branch.map(&amp;:hth),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">          &#39;mrkl_index&#39; =&gt; @mrkl_index,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">          &#39;aux_branch&#39; =&gt; @aux_branch.map(&amp;:hth),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">          &#39;aux_index&#39; =&gt; @aux_index,</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="117">
          <span class="hits">2</span>
          
          <code class="ruby">          &#39;parent_block&#39; =&gt; @parent_block.to_hash }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b85bdf561b3dc51ecfd89215f675dc4ae6ab50a3">
  <div class="header">
    <h3>lib/bitcoin/protocol/block.rb</h3>
    <h4><span class="green">91.2 %</span> covered</h4>
    <div>
      <b>125</b> relevant lines. 
      <span class="green"><b>114</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class Block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      BLOCK_VERSION_DEFAULT     = (1 &lt;&lt; 0)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      BLOCK_VERSION_AUXPOW      = (1 &lt;&lt; 8)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">      BLOCK_VERSION_CHAIN_START = (1 &lt;&lt; 16)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      BLOCK_VERSION_CHAIN_END   = (1 &lt;&lt; 30)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      # block hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      # previous block hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :prev_block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      # transactions (Array of Tx)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      # merkle root</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :mrkl_root</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      # block generation time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      # difficulty target bits</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :bits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      # nonce (number counted when searching for block hash matching target)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      # version (usually 1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :ver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      # raw protocol payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      # AuxPow linking the block to a merge-mined chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :aux_pow</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :transactions :tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      # compare to another block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="covered" data-hits="429" data-linenumber="47">
          <span class="hits">429</span>
          
          <code class="ruby">        @hash == other.hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      def binary_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        [@hash].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">      def prev_block_hex</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        @prev_block_hex ||= @prev_block.reverse.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # create block from raw binary +data+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data)</code>
        </li>
      
        <li class="covered" data-hits="684" data-linenumber="60">
          <span class="hits">684</span>
          
          <code class="ruby">        @tx = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        #parse_data(data) if data</code>
        </li>
      
        <li class="covered" data-hits="684" data-linenumber="62">
          <span class="hits">684</span>
          
          <code class="ruby">        parse_data_from_io(data) if data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      # parse raw binary data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="67">
          <span class="hits">2</span>
          
          <code class="ruby">        @ver, @prev_block, @mrkl_root, @time, @bits, @nonce, payload = data.unpack(&quot;Va32a32VVVa*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="68">
          <span class="hits">2</span>
          
          <code class="ruby">        recalc_block_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="70">
          <span class="hits">2</span>
          
          <code class="ruby">        if (@ver &amp; BLOCK_VERSION_AUXPOW) &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">          @aux_pow = AuxPow.new(nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">          payload = @aux_pow.parse_data(payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="75">
          <span class="hits">2</span>
          
          <code class="ruby">        return  unless payload.size &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="77">
          <span class="hits">2</span>
          
          <code class="ruby">        tx_size, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="78">
          <span class="hits">4</span>
          
          <code class="ruby">        (0...tx_size).each{  break if payload == true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="79">
          <span class="hits">2</span>
          
          <code class="ruby">          t = Tx.new(nil)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="80">
          <span class="hits">2</span>
          
          <code class="ruby">          payload = t.parse_data(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="81">
          <span class="hits">2</span>
          
          <code class="ruby">          @tx &lt;&lt; t</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="84">
          <span class="hits">2</span>
          
          <code class="ruby">        if Bitcoin.network_project == :ppcoin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">          @block_signature, payload = Protocol.unpack_var_string(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">          @block_signature ||= &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="89">
          <span class="hits">2</span>
          
          <code class="ruby">        @payload = to_payload</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="90">
          <span class="hits">2</span>
          
          <code class="ruby">        payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      # parse raw binary data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="441" data-linenumber="95">
          <span class="hits">441</span>
          
          <code class="ruby">        buf = buf.is_a?(String) ? StringIO.new(buf) : buf</code>
        </li>
      
        <li class="covered" data-hits="441" data-linenumber="96">
          <span class="hits">441</span>
          
          <code class="ruby">        @ver, @prev_block, @mrkl_root, @time, @bits, @nonce = buf.read(80).unpack(&quot;Va32a32VVV&quot;)</code>
        </li>
      
        <li class="covered" data-hits="441" data-linenumber="97">
          <span class="hits">441</span>
          
          <code class="ruby">        recalc_block_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="440" data-linenumber="99">
          <span class="hits">440</span>
          
          <code class="ruby">        if (@ver &amp; BLOCK_VERSION_AUXPOW) &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="100">
          <span class="hits">5</span>
          
          <code class="ruby">          @aux_pow = AuxPow.new(nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="101">
          <span class="hits">5</span>
          
          <code class="ruby">          @aux_pow.parse_data_from_io(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="440" data-linenumber="104">
          <span class="hits">440</span>
          
          <code class="ruby">        return if buf.eof?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="435" data-linenumber="106">
          <span class="hits">435</span>
          
          <code class="ruby">        tx_size = Protocol.unpack_var_int_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="1118" data-linenumber="107">
          <span class="hits">1118</span>
          
          <code class="ruby">        (0...tx_size).each{  break if payload == true</code>
        </li>
      
        <li class="covered" data-hits="683" data-linenumber="108">
          <span class="hits">683</span>
          
          <code class="ruby">          t = Tx.new(nil)</code>
        </li>
      
        <li class="covered" data-hits="683" data-linenumber="109">
          <span class="hits">683</span>
          
          <code class="ruby">          payload = t.parse_data_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="683" data-linenumber="110">
          <span class="hits">683</span>
          
          <code class="ruby">          @tx &lt;&lt; t</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="435" data-linenumber="113">
          <span class="hits">435</span>
          
          <code class="ruby">        if Bitcoin.network_project == :ppcoin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="114">
          <span class="hits">2</span>
          
          <code class="ruby">          @block_signature = Protocol.unpack_var_string_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="115">
          <span class="hits">2</span>
          
          <code class="ruby">          @block_signature ||= &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="435" data-linenumber="118">
          <span class="hits">435</span>
          
          <code class="ruby">        @payload = to_payload</code>
        </li>
      
        <li class="covered" data-hits="435" data-linenumber="119">
          <span class="hits">435</span>
          
          <code class="ruby">        buf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      #alias :parse_data  :parse_data_from_io # enable soon</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      # recalculate the block hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">      def recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="54177" data-linenumber="126">
          <span class="hits">54177</span>
          
          <code class="ruby">        @hash = Bitcoin.block_hash(@prev_block.reverse_hth, @mrkl_root.reverse_hth, @time, @bits, @nonce, @ver)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      # verify mrkl tree</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">      def verify_mrkl_root</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="131">
          <span class="hits">29</span>
          
          <code class="ruby">        @mrkl_root.reverse_hth == Bitcoin.hash_mrkl_tree( @tx.map(&amp;:hash) ).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      # get the block header info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      # [&lt;version&gt;, &lt;prev_block&gt;, &lt;merkle_root&gt;, &lt;time&gt;, &lt;bits&gt;, &lt;nonce&gt;, &lt;txcount&gt;, &lt;size&gt;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">      def header_info</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="137">
          <span class="hits">2</span>
          
          <code class="ruby">        [@ver, @prev_block.reverse_hth, @mrkl_root.reverse_hth, Time.at(@time), @bits, @nonce, @tx.size, @payload.size]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      # convert to raw binary format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="1216" data-linenumber="142">
          <span class="hits">1216</span>
          
          <code class="ruby">        head = [@ver, @prev_block, @mrkl_root, @time, @bits, @nonce].pack(&quot;Va32a32VVV&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1216" data-linenumber="143">
          <span class="hits">1216</span>
          
          <code class="ruby">        head &lt;&lt; @aux_pow.to_payload  if @aux_pow</code>
        </li>
      
        <li class="covered" data-hits="1216" data-linenumber="144">
          <span class="hits">1216</span>
          
          <code class="ruby">        return head  unless @tx.any?</code>
        </li>
      
        <li class="covered" data-hits="1204" data-linenumber="145">
          <span class="hits">1204</span>
          
          <code class="ruby">        head &lt;&lt; [Protocol.pack_var_int(@tx.size), @tx.map(&amp;:to_payload).join].join</code>
        </li>
      
        <li class="covered" data-hits="1204" data-linenumber="146">
          <span class="hits">1204</span>
          
          <code class="ruby">        head &lt;&lt; Protocol.pack_var_string(@block_signature)  if Bitcoin.ppcoin?</code>
        </li>
      
        <li class="covered" data-hits="1204" data-linenumber="147">
          <span class="hits">1204</span>
          
          <code class="ruby">        head</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      # convert to ruby hash (see also #from_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="152">
          <span class="hits">37</span>
          
          <code class="ruby">        h = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">          &#39;hash&#39; =&gt; @hash, &#39;ver&#39; =&gt; @ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">          &#39;prev_block&#39; =&gt; @prev_block.reverse_hth, &#39;mrkl_root&#39; =&gt; @mrkl_root.reverse_hth,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">          &#39;time&#39; =&gt; @time, &#39;bits&#39; =&gt; @bits, &#39;nonce&#39; =&gt; @nonce,</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="156">
          <span class="hits">37</span>
          
          <code class="ruby">          &#39;n_tx&#39; =&gt; @tx.size, &#39;size&#39; =&gt; (@payload||to_payload).bytesize,</code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="157">
          <span class="hits">147</span>
          
          <code class="ruby">          &#39;tx&#39; =&gt; @tx.map{|i| i.to_hash },</code>
        </li>
      
        <li class="covered" data-hits="147" data-linenumber="158">
          <span class="hits">147</span>
          
          <code class="ruby">          &#39;mrkl_tree&#39; =&gt; Bitcoin.hash_mrkl_tree( @tx.map{|i| i.hash } )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="160">
          <span class="hits">37</span>
          
          <code class="ruby">        h[&#39;signature&#39;] = @block_signature.reverse_hth if Bitcoin.network_project == :ppcoin</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="161">
          <span class="hits">37</span>
          
          <code class="ruby">        h[&#39;aux_pow&#39;] = @aux_pow.to_hash  if @aux_pow</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="162">
          <span class="hits">37</span>
          
          <code class="ruby">        h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">      def hextarget</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">        Bitcoin.decode_compact_bits(@bits)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">      def decimaltarget</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">        Bitcoin.decode_compact_bits(@bits).to_i(16)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">      def difficulty</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        Bitcoin.block_difficulty(@bits)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">      # introduced in block version 2 by BIP_0034</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      # blockchain height as seen by the block itself.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      # do not trust this value, instead verify with chain storage.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">      def bip34_block_height</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="181">
          <span class="hits">2</span>
          
          <code class="ruby">        return nil unless @ver &gt;= 2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">        coinbase = @tx.first.inputs.first.script_sig</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">        coinbase[1..coinbase[0].ord].ljust(4, &quot;\x00&quot;).unpack(&quot;V&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">        nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">      # convert to json representation as seen in the block explorer.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      # (see also #from_json)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_json(options = {:space =&gt; &#39;&#39;}, *a)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="191">
          <span class="hits">12</span>
          
          <code class="ruby">        JSON.pretty_generate( to_hash, options )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      # write json representation to a file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">      # (see also #to_json)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_json_file(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">        File.open(path, &#39;wb&#39;){|f| f.print to_json; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      # parse ruby hash (see also #to_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash(h)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="202">
          <span class="hits">35</span>
          
          <code class="ruby">        blk = new(nil)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="203">
          <span class="hits">35</span>
          
          <code class="ruby">        blk.instance_eval{</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="204">
          <span class="hits">35</span>
          
          <code class="ruby">          @ver, @time, @bits, @nonce = h.values_at(&#39;ver&#39;, &#39;time&#39;, &#39;bits&#39;, &#39;nonce&#39;)</code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="205">
          <span class="hits">105</span>
          
          <code class="ruby">          @prev_block, @mrkl_root = h.values_at(&#39;prev_block&#39;, &#39;mrkl_root&#39;).map{|i| i.htb_reverse }</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="206">
          <span class="hits">35</span>
          
          <code class="ruby">          unless h[&#39;hash&#39;] == recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">            raise &quot;Block hash mismatch! Claimed: #{h[&#39;hash&#39;]}, Actual: #{@hash}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="209">
          <span class="hits">34</span>
          
          <code class="ruby">          @aux_pow = AuxPow.from_hash(h[&#39;aux_pow&#39;])  if h[&#39;aux_pow&#39;]</code>
        </li>
      
        <li class="covered" data-hits="350" data-linenumber="210">
          <span class="hits">350</span>
          
          <code class="ruby">          h[&#39;tx&#39;].each{|tx| @tx &lt;&lt; Tx.from_hash(tx) }</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="211">
          <span class="hits">34</span>
          
          <code class="ruby">          if h[&#39;tx&#39;].any? &amp;&amp; !Bitcoin.freicoin?</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="212">
          <span class="hits">26</span>
          
          <code class="ruby">            raise &quot;Block merkle root mismatch!&quot;  unless verify_mrkl_root</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="214">
          <span class="hits">33</span>
          
          <code class="ruby">          @block_signature = h[&#39;signature&#39;].htb_reverse if Bitcoin.ppcoin?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="216">
          <span class="hits">33</span>
          
          <code class="ruby">        blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">      # convert ruby hash to raw binary</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.binary_from_hash(h); from_hash(h).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      # parse json representation (see also #to_json)</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="223">
          <span class="hits">31</span>
          
          <code class="ruby">      def self.from_json(json_string); from_hash( JSON.load(json_string) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">      # convert json representation to raw binary</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="226">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.binary_from_json(json_string); from_json(json_string).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">      # convert header to json representation.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">      def header_to_json(options = {:space =&gt; &#39;&#39;})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">        h = to_hash</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="231">
          <span class="hits">3</span>
          
          <code class="ruby">        %w[tx mrkl_tree].each{|k| h.delete(k) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">        JSON.pretty_generate( h, options )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">      # read binary block from a file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_file(path); new( Bitcoin::Protocol.read_binary_file(path) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      # read json block from a file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_json_file(path); from_json( Bitcoin::Protocol.read_binary_file(path) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">      def validator(store, prev_block = nil)</code>
        </li>
      
        <li class="covered" data-hits="521" data-linenumber="242">
          <span class="hits">521</span>
          
          <code class="ruby">        @validator ||= Bitcoin::Validation::Block.new(self, store, prev_block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      # get the (statistical) amount of work that was needed to generate this block.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">      def block_work</code>
        </li>
      
        <li class="covered" data-hits="502" data-linenumber="247">
          <span class="hits">502</span>
          
          <code class="ruby">        target = Bitcoin.decode_compact_bits(@bits)</code>
        </li>
      
        <li class="covered" data-hits="502" data-linenumber="248">
          <span class="hits">502</span>
          
          <code class="ruby">        (2**256) / (target.to_i(16) + 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ec26a72c762bc13eda908614b56e96d8669a4d80">
  <div class="header">
    <h3>lib/bitcoin/protocol/handler.rb</h3>
    <h4><span class="red">58.82 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class Handler</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_inv_transaction(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">        p [&#39;inv transaction&#39;, hash.hth]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_inv_block(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        p [&#39;inv block&#39;, hash.hth]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_get_transaction(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        p [&#39;get transaction&#39;, hash.hth]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_get_block(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        p [&#39;get block&#39;, hash.hth]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_addr(addr)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        p [&#39;addr&#39;, addr, addr.alive?]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        p [&#39;tx&#39;, tx]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_block(block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        #p [&#39;block&#39;, block]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        puts block.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="557ee148bb367f942116155fdc327b5fa7942241">
  <div class="header">
    <h3>lib/bitcoin/protocol/parser.rb</h3>
    <h4><span class="red">73.79 %</span> covered</h4>
    <div>
      <b>103</b> relevant lines. 
      <span class="green"><b>76</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class Parser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(handler=nil)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="9">
          <span class="hits">22</span>
          
          <code class="ruby">        @h = handler || Handler.new</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="10">
          <span class="hits">22</span>
          
          <code class="ruby">        @buf = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      def log</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">        @log ||= Bitcoin::Logger.create(&quot;parser&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # handles inv/getdata packets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_inv(payload, type=:put)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="20">
          <span class="hits">5</span>
          
          <code class="ruby">        count, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="21">
          <span class="hits">5</span>
          
          <code class="ruby">        payload.each_byte.each_slice(36){|i|</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="22">
          <span class="hits">7</span>
          
          <code class="ruby">          hash = i[4..-1].reverse.pack(&quot;C32&quot;)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="23">
          <span class="hits">7</span>
          
          <code class="ruby">          case i[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          when 1</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="25">
          <span class="hits">5</span>
          
          <code class="ruby">            if type == :put</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="26">
          <span class="hits">4</span>
          
          <code class="ruby">              @h.on_inv_transaction(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">              @h.on_get_transaction(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">          when 2</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="31">
          <span class="hits">2</span>
          
          <code class="ruby">            if type == :put</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">              @h.on_inv_block(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">              @h.on_get_block(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">            p [&#39;parse_inv error&#39;, i]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_addr(payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">        count, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">        payload.each_byte.each_slice(30){|i|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">            addr = Addr.new(i.pack(&quot;C*&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">          rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">            puts &quot;Error parsing addr: #{i.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">          @h.on_addr( addr )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_headers(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        count, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        idx = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        headers = count.times.map{ Block.new(payload[idx..idx+=81]) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        @h.on_headers(headers)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_getblocks(payload)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="62">
          <span class="hits">4</span>
          
          <code class="ruby">        version, payload = payload.unpack(&#39;Va*&#39;)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="63">
          <span class="hits">4</span>
          
          <code class="ruby">        count,   payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="64">
          <span class="hits">4</span>
          
          <code class="ruby">        buf,     payload = payload.unpack(&quot;a#{count*32}a*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="65">
          <span class="hits">12</span>
          
          <code class="ruby">        hashes    = buf.each_byte.each_slice(32).map{|i| hash = i.reverse.pack(&quot;C32&quot;).hth }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="66">
          <span class="hits">4</span>
          
          <code class="ruby">        stop_hash = payload[0..32].reverse_hth</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="67">
          <span class="hits">4</span>
          
          <code class="ruby">        [version, hashes, stop_hash]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      def process_pkt(command, payload)</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="71">
          <span class="hits">21</span>
          
          <code class="ruby">        case command</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        when &#39;tx&#39;;       @h.on_tx( Tx.new(payload) )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        when &#39;block&#39;;    @h.on_block( Block.new(payload) )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        when &#39;headers&#39;;  parse_headers(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="75">
          <span class="hits">3</span>
          
          <code class="ruby">        when &#39;inv&#39;;      parse_inv(payload, :put)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="76">
          <span class="hits">2</span>
          
          <code class="ruby">        when &#39;getdata&#39;;  parse_inv(payload, :get)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">        when &#39;addr&#39;;     parse_addr(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        when &#39;getaddr&#39;;  @h.on_getaddr  if @h.respond_to?(:on_getaddr)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">        when &#39;verack&#39;;   @h.on_handshake_complete # nop</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="80">
          <span class="hits">3</span>
          
          <code class="ruby">        when &#39;version&#39;;  parse_version(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        when &#39;alert&#39;;    parse_alert(payload)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="82">
          <span class="hits">4</span>
          
          <code class="ruby">        when &#39;ping&#39;;     @h.on_ping(payload.unpack(&quot;Q&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="83">
          <span class="hits">2</span>
          
          <code class="ruby">        when &#39;pong&#39;;     @h.on_pong(payload.unpack(&quot;Q&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="84">
          <span class="hits">4</span>
          
          <code class="ruby">        when &#39;getblocks&#39;;   @h.on_getblocks(*parse_getblocks(payload))  if @h.respond_to?(:on_getblocks)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        when &#39;getheaders&#39;;  @h.on_getheaders(*parse_getblocks(payload))  if @h.respond_to?(:on_getheaders)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        when &#39;mempool&#39;;  handle_mempool_request(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="87">
          <span class="hits">2</span>
          
          <code class="ruby">        when &#39;notfound&#39;; handle_notfound_reply(payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">          p [&#39;unkown-packet&#39;, command, payload]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_version(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="94">
          <span class="hits">3</span>
          
          <code class="ruby">        @version = Bitcoin::Protocol::Version.parse(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="95">
          <span class="hits">3</span>
          
          <code class="ruby">        @h.on_version(@version)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_alert(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        return unless @h.respond_to?(:on_alert)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        @h.on_alert Bitcoin::Protocol::Alert.parse(payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      # https://en.bitcoin.it/wiki/BIP_0035</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">      def handle_mempool_request(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        return unless @version[:version] &gt;= 60002           # Protocol version &gt;= 60002</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        return unless (@version[:services] &amp; (1 &lt;&lt; 0)) == 1 # NODE_NETWORK bit set in Services</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        @h.on_mempool if @h.respond_to?(:on_mempool)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">      def handle_notfound_reply(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="111">
          <span class="hits">2</span>
          
          <code class="ruby">        return unless @h.respond_to?(:on_notfound)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="112">
          <span class="hits">2</span>
          
          <code class="ruby">        count, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="113">
          <span class="hits">2</span>
          
          <code class="ruby">        payload.each_byte.each_slice(36){|i|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="114">
          <span class="hits">2</span>
          
          <code class="ruby">          hash = i[4..-1].reverse.pack(&quot;C32&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="115">
          <span class="hits">2</span>
          
          <code class="ruby">          case i[0]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">          when 1; @h.on_notfound(:tx, hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">          when 2; @h.on_notfound(:block, hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">            p [&#39;handle_notfound_reply error&#39;, i, hash]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse(buf)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="125">
          <span class="hits">22</span>
          
          <code class="ruby">        @buf += buf</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="126">
          <span class="hits">22</span>
          
          <code class="ruby">        while parse_buffer; end</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="127">
          <span class="hits">22</span>
          
          <code class="ruby">        @buf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_buffer</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="131">
          <span class="hits">38</span>
          
          <code class="ruby">        head_magic = Bitcoin::network[:magic_head]</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="132">
          <span class="hits">38</span>
          
          <code class="ruby">        head_size  = 24</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="133">
          <span class="hits">38</span>
          
          <code class="ruby">        return false if @buf.size &lt;= head_size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="135">
          <span class="hits">22</span>
          
          <code class="ruby">        magic, cmd, length, checksum = @buf.unpack(&quot;a4A12Va4&quot;)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="136">
          <span class="hits">22</span>
          
          <code class="ruby">        payload = @buf[head_size...head_size+length]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="138">
          <span class="hits">22</span>
          
          <code class="ruby">        unless magic == head_magic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">          handle_stream_error(:close, &quot;head_magic not found&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">          @buf = &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="143">
          <span class="hits">21</span>
          
          <code class="ruby">          if Digest::SHA256.digest(Digest::SHA256.digest( payload ))[0...4] != checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">            if (length &lt; 50000) &amp;&amp; (payload.size &lt; length)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">              size_info = [payload.size, length].join(&#39;/&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">              handle_stream_error(:debug, &quot;chunked packet stream (#{size_info})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">              handle_stream_error(:close, &quot;checksum mismatch&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">            return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="152">
          <span class="hits">21</span>
          
          <code class="ruby">          @buf = @buf[head_size+length..-1] || &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="154">
          <span class="hits">21</span>
          
          <code class="ruby">          process_pkt(cmd, payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">        # not empty yet? parse more.</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="158">
          <span class="hits">22</span>
          
          <code class="ruby">        @buf[0] != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">      def handle_stream_error(type, msg)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">        case type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        when :close</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">          log.debug {&quot;closing packet stream (#{msg})&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">          log.debug { [type, msg] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    end # Parser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="50420e37470493cafba8f41ed05b633a062fcdf4">
  <div class="header">
    <h3>lib/bitcoin/protocol/tx.rb</h3>
    <h4><span class="green">94.63 %</span> covered</h4>
    <div>
      <b>149</b> relevant lines. 
      <span class="green"><b>141</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bitcoin/script&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    class Tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # transaction hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      # inputs (Array of TxIn)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      # outputs (Array of TxOut)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      # raw protocol payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      # version (usually 1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :ver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      # lock time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :lock_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :inputs  :in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :outputs :out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      # compare to another tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="33">
          <span class="hits">27</span>
          
          <code class="ruby">        @hash == other.hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      # return the tx hash in binary format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      def binary_hash</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="38">
          <span class="hits">42</span>
          
          <code class="ruby">        [@hash].pack(&quot;H*&quot;).reverse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # create tx from raw binary +data+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data=nil)</code>
        </li>
      
        <li class="covered" data-hits="3302" data-linenumber="43">
          <span class="hits">3302</span>
          
          <code class="ruby">        @ver, @lock_time, @in, @out = 1, 0, [], []</code>
        </li>
      
        <li class="covered" data-hits="3302" data-linenumber="44">
          <span class="hits">3302</span>
          
          <code class="ruby">        @time = Time.now.to_i if Bitcoin.network_project == :ppcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        #parse_data(data) if data</code>
        </li>
      
        <li class="covered" data-hits="3302" data-linenumber="46">
          <span class="hits">3302</span>
          
          <code class="ruby">        parse_data_from_io(data) if data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      # generate the tx hash for given +payload+ in hex format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      def hash_from_payload(payload)</code>
        </li>
      
        <li class="covered" data-hits="3092" data-linenumber="51">
          <span class="hits">3092</span>
          
          <code class="ruby">        Digest::SHA256.digest(Digest::SHA256.digest( payload )).reverse_hth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      alias generate_hash hash_from_payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      # add an input</code>
        </li>
      
        <li class="covered" data-hits="2597" data-linenumber="56">
          <span class="hits">2597</span>
          
          <code class="ruby">      def add_in(input); (@in ||= []) &lt;&lt; input; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # add an output</code>
        </li>
      
        <li class="covered" data-hits="3347" data-linenumber="59">
          <span class="hits">3347</span>
          
          <code class="ruby">      def add_out(output); (@out ||= []) &lt;&lt; output; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      # parse raw binary data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="63">
          <span class="hits">15</span>
          
          <code class="ruby">        @ver = data.unpack(&quot;V&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="64">
          <span class="hits">15</span>
          
          <code class="ruby">        idx = 4</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="65">
          <span class="hits">15</span>
          
          <code class="ruby">        (@time = data.unpack(&quot;x4V&quot;)[0]; idx += 4) if Bitcoin.network_project == :ppcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="67">
          <span class="hits">15</span>
          
          <code class="ruby">        in_size, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="68">
          <span class="hits">15</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize-tmp.bytesize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        # raise &quot;unkown transaction version: #{@ver}&quot; unless @ver == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="71">
          <span class="hits">15</span>
          
          <code class="ruby">        @in = (0...in_size).map{</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="72">
          <span class="hits">16</span>
          
          <code class="ruby">          txin = TxIn.new</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="73">
          <span class="hits">16</span>
          
          <code class="ruby">          idx += txin.parse_data(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="74">
          <span class="hits">16</span>
          
          <code class="ruby">          txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="77">
          <span class="hits">15</span>
          
          <code class="ruby">        out_size, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="78">
          <span class="hits">15</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize-tmp.bytesize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="80">
          <span class="hits">15</span>
          
          <code class="ruby">        @out = (0...out_size).map{</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="81">
          <span class="hits">28</span>
          
          <code class="ruby">          txout = TxOut.new</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="82">
          <span class="hits">28</span>
          
          <code class="ruby">          idx += txout.parse_data(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="83">
          <span class="hits">28</span>
          
          <code class="ruby">          txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="86">
          <span class="hits">15</span>
          
          <code class="ruby">        @lock_time = data[idx...idx+=4].unpack(&quot;V&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="88">
          <span class="hits">15</span>
          
          <code class="ruby">        @payload = data[0...idx]</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="89">
          <span class="hits">15</span>
          
          <code class="ruby">        @hash = hash_from_payload(@payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="91">
          <span class="hits">15</span>
          
          <code class="ruby">        if data[idx] == nil</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="92">
          <span class="hits">7</span>
          
          <code class="ruby">          true          # reached the end.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="94">
          <span class="hits">8</span>
          
          <code class="ruby">          data[idx..-1] # rest of buffer.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      # parse raw binary data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data_from_io(data)</code>
        </li>
      
        <li class="covered" data-hits="1085" data-linenumber="100">
          <span class="hits">1085</span>
          
          <code class="ruby">        buf = data.is_a?(String) ? StringIO.new(data) : data</code>
        </li>
      
        <li class="covered" data-hits="1085" data-linenumber="101">
          <span class="hits">1085</span>
          
          <code class="ruby">        payload_start = buf.pos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1085" data-linenumber="103">
          <span class="hits">1085</span>
          
          <code class="ruby">        @ver = buf.read(4).unpack(&quot;V&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="1085" data-linenumber="104">
          <span class="hits">1085</span>
          
          <code class="ruby">        @time = buf.read(4).unpack(&quot;V&quot;)[0] if Bitcoin.network_project == :ppcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1085" data-linenumber="106">
          <span class="hits">1085</span>
          
          <code class="ruby">        in_size = Protocol.unpack_var_int_from_io(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        # raise &quot;unkown transaction version: #{@ver}&quot; unless @ver == 1</code>
        </li>
      
        <li class="covered" data-hits="2369" data-linenumber="108">
          <span class="hits">2369</span>
          
          <code class="ruby">        @in = (0...in_size).map{ TxIn.from_io(buf) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1084" data-linenumber="110">
          <span class="hits">1084</span>
          
          <code class="ruby">        out_size = Protocol.unpack_var_int_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="3325" data-linenumber="111">
          <span class="hits">3325</span>
          
          <code class="ruby">        @out = (0...out_size).map{ TxOut.from_io(buf) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1084" data-linenumber="113">
          <span class="hits">1084</span>
          
          <code class="ruby">        @lock_time = buf.read(4).unpack(&quot;V&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1084" data-linenumber="115">
          <span class="hits">1084</span>
          
          <code class="ruby">        payload_end = buf.pos;</code>
        </li>
      
        <li class="covered" data-hits="1084" data-linenumber="116">
          <span class="hits">1084</span>
          
          <code class="ruby">        buf.seek(payload_start)</code>
        </li>
      
        <li class="covered" data-hits="1084" data-linenumber="117">
          <span class="hits">1084</span>
          
          <code class="ruby">        @payload = buf.read( payload_end-payload_start )</code>
        </li>
      
        <li class="covered" data-hits="1084" data-linenumber="118">
          <span class="hits">1084</span>
          
          <code class="ruby">        @hash = hash_from_payload(@payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1084" data-linenumber="120">
          <span class="hits">1084</span>
          
          <code class="ruby">        if buf.eof?</code>
        </li>
      
        <li class="covered" data-hits="829" data-linenumber="121">
          <span class="hits">829</span>
          
          <code class="ruby">          true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="255" data-linenumber="123">
          <span class="hits">255</span>
          
          <code class="ruby">          data.is_a?(StringIO) ? buf : buf.read</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      #alias :parse_data  :parse_data_from_io # enable soon</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      # output transaction in raw binary format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="4049" data-linenumber="131">
          <span class="hits">4049</span>
          
          <code class="ruby">        pin  =  @in.map(&amp;:to_payload).join</code>
        </li>
      
        <li class="covered" data-hits="4049" data-linenumber="132">
          <span class="hits">4049</span>
          
          <code class="ruby">        pout = @out.map(&amp;:to_payload).join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4049" data-linenumber="134">
          <span class="hits">4049</span>
          
          <code class="ruby">        in_size, out_size = Protocol.pack_var_int(@in.size), Protocol.pack_var_int(@out.size)</code>
        </li>
      
        <li class="covered" data-hits="4049" data-linenumber="135">
          <span class="hits">4049</span>
          
          <code class="ruby">        if Bitcoin.network_project == :ppcoin</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="136">
          <span class="hits">12</span>
          
          <code class="ruby">          [[@ver, @time].pack(&quot;VV&quot;), in_size, pin, out_size, pout, [@lock_time].pack(&quot;V&quot;)].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="4037" data-linenumber="138">
          <span class="hits">4037</span>
          
          <code class="ruby">          [[@ver].pack(&quot;V&quot;), in_size, pin, out_size, pout, [@lock_time].pack(&quot;V&quot;)].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">      SIGHASH_TYPE = { all: 1, none: 2, single: 3, anyonecanpay: 128 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      # generate a signature hash for input +input_idx+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      # either pass the +outpoint_tx+ or the +script_pubkey+ directly.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">      def signature_hash_for_input(input_idx, outpoint_tx, script_pubkey=nil, hash_type=nil, drop_sigs=nil, script=nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">        # https://github.com/bitcoin/bitcoin/blob/e071a3f6c06f41068ad17134189a4ac3073ef76b/script.cpp#L834</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">        # http://code.google.com/p/bitcoinj/source/browse/trunk/src/com/google/bitcoin/core/Script.java#318</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">        # https://en.bitcoin.it/wiki/OP_CHECKSIG#How_it_works</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        # https://github.com/bitcoin/bitcoin/blob/c2e8c8acd8ae0c94c70b59f55169841ad195bb99/src/script.cpp#L1058</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">        # https://en.bitcoin.it/wiki/OP_CHECKSIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="154">
          <span class="hits">145</span>
          
          <code class="ruby">        hash_type ||= SIGHASH_TYPE[:all]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="156">
          <span class="hits">145</span>
          
          <code class="ruby">        pin  = @in.map.with_index{|input,idx|</code>
        </li>
      
        <li class="covered" data-hits="186" data-linenumber="157">
          <span class="hits">186</span>
          
          <code class="ruby">          if idx == input_idx</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="158">
          <span class="hits">145</span>
          
          <code class="ruby">            script_pubkey ||= outpoint_tx.out[ input.prev_out_index ].pk_script</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="159">
          <span class="hits">145</span>
          
          <code class="ruby">            script_pubkey = Bitcoin::Script.binary_from_string(script)                if script    # force this string a script</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="160">
          <span class="hits">145</span>
          
          <code class="ruby">            script_pubkey = Bitcoin::Script.drop_signatures(script_pubkey, drop_sigs) if drop_sigs # array of signature to drop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">            #p Bitcoin::Script.new(script_pubkey).to_string</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="162">
          <span class="hits">145</span>
          
          <code class="ruby">            input.to_payload(script_pubkey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="164">
          <span class="hits">41</span>
          
          <code class="ruby">            case (hash_type &amp; 0x1f)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">            when SIGHASH_TYPE[:none];   input.to_payload(&quot;&quot;, &quot;\x00\x00\x00\x00&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">            when SIGHASH_TYPE[:single]; input.to_payload(&quot;&quot;, &quot;\x00\x00\x00\x00&quot;)</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="167">
          <span class="hits">41</span>
          
          <code class="ruby">            else;                       input.to_payload(&quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="172">
          <span class="hits">145</span>
          
          <code class="ruby">        pout = @out.map(&amp;:to_payload)</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="173">
          <span class="hits">145</span>
          
          <code class="ruby">        in_size, out_size = Protocol.pack_var_int(@in.size), Protocol.pack_var_int(@out.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="175">
          <span class="hits">145</span>
          
          <code class="ruby">        case (hash_type &amp; 0x1f)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        when SIGHASH_TYPE[:none]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">          pout = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">          out_size = Protocol.pack_var_int(0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">        when SIGHASH_TYPE[:single]</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="180">
          <span class="hits">8</span>
          
          <code class="ruby">          pout = @out[0...(input_idx+1)].map.with_index{|out,idx| (idx==input_idx) ? out.to_payload : out.to_null_payload }.join</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="181">
          <span class="hits">4</span>
          
          <code class="ruby">          out_size = Protocol.pack_var_int(input_idx+1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="184">
          <span class="hits">145</span>
          
          <code class="ruby">        if (hash_type &amp; SIGHASH_TYPE[:anyonecanpay]) != 0</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="185">
          <span class="hits">5</span>
          
          <code class="ruby">          in_size, pin = Protocol.pack_var_int(1), [ pin[input_idx] ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="188">
          <span class="hits">145</span>
          
          <code class="ruby">        if Bitcoin.network_project == :ppcoin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">          buf = [ [@ver, @time].pack(&quot;VV&quot;), in_size, pin, out_size, pout, [@lock_time, hash_type].pack(&quot;VV&quot;) ].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="191">
          <span class="hits">145</span>
          
          <code class="ruby">          buf = [ [@ver].pack(&quot;V&quot;), in_size, pin, out_size, pout, [@lock_time, hash_type].pack(&quot;VV&quot;) ].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="193">
          <span class="hits">145</span>
          
          <code class="ruby">        Digest::SHA256.digest( Digest::SHA256.digest( buf ) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      # verify input signature +in_idx+ against the corresponding</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      # output in +outpoint_tx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">      def verify_input_signature(in_idx, outpoint_tx, block_timestamp=Time.now.to_i)</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="199">
          <span class="hits">78</span>
          
          <code class="ruby">        outpoint_idx  = @in[in_idx].prev_out_index</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="200">
          <span class="hits">78</span>
          
          <code class="ruby">        script_sig    = @in[in_idx].script_sig</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="201">
          <span class="hits">78</span>
          
          <code class="ruby">        script_pubkey = outpoint_tx.out[outpoint_idx].pk_script</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="202">
          <span class="hits">78</span>
          
          <code class="ruby">        script        = script_sig + script_pubkey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="204">
          <span class="hits">78</span>
          
          <code class="ruby">        Bitcoin::Script.new(script).run(block_timestamp) do |pubkey,sig,hash_type,drop_sigs,script|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">          # this IS the checksig callback, must return true/false</code>
        </li>
      
        <li class="covered" data-hits="96" data-linenumber="206">
          <span class="hits">96</span>
          
          <code class="ruby">          hash = signature_hash_for_input(in_idx, outpoint_tx, nil, hash_type, drop_sigs, script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">          #hash = signature_hash_for_input(in_idx, nil, script_pubkey, hash_type, drop_sigs, script)</code>
        </li>
      
        <li class="covered" data-hits="96" data-linenumber="208">
          <span class="hits">96</span>
          
          <code class="ruby">          Bitcoin.verify_signature( hash, sig, pubkey.unpack(&quot;H*&quot;)[0] )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      # convert to ruby hash (see also #from_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash(options = {})</code>
        </li>
      
        <li class="covered" data-hits="170" data-linenumber="214">
          <span class="hits">170</span>
          
          <code class="ruby">        @hash ||= hash_from_payload(to_payload)</code>
        </li>
      
        <li class="covered" data-hits="170" data-linenumber="215">
          <span class="hits">170</span>
          
          <code class="ruby">        h = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">          &#39;hash&#39; =&gt; @hash, &#39;ver&#39; =&gt; @ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">          &#39;vin_sz&#39; =&gt; @in.size, &#39;vout_sz&#39; =&gt; @out.size,</code>
        </li>
      
        <li class="covered" data-hits="170" data-linenumber="218">
          <span class="hits">170</span>
          
          <code class="ruby">          &#39;lock_time&#39; =&gt; @lock_time, &#39;size&#39; =&gt; (@payload ||= to_payload).bytesize,</code>
        </li>
      
        <li class="covered" data-hits="222" data-linenumber="219">
          <span class="hits">222</span>
          
          <code class="ruby">          &#39;in&#39;  =&gt;  @in.map{|i| i.to_hash(options) },</code>
        </li>
      
        <li class="covered" data-hits="693" data-linenumber="220">
          <span class="hits">693</span>
          
          <code class="ruby">          &#39;out&#39; =&gt; @out.map{|o| o.to_hash(options) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="170" data-linenumber="222">
          <span class="hits">170</span>
          
          <code class="ruby">        h[&#39;time&#39;] = @time if Bitcoin.network_project == :ppcoin</code>
        </li>
      
        <li class="covered" data-hits="170" data-linenumber="223">
          <span class="hits">170</span>
          
          <code class="ruby">        h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">      # generates rawblock json as seen in the block explorer.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_json(options = {:space =&gt; &#39;&#39;}, *a)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="228">
          <span class="hits">10</span>
          
          <code class="ruby">        JSON.pretty_generate( to_hash(options), options )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      # write json representation to a file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">      # (see also #to_json)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_json_file(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">        File.open(path, &#39;wb&#39;){|f| f.print to_json; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">      # parse ruby hash (see also #to_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash(h)</code>
        </li>
      
        <li class="covered" data-hits="352" data-linenumber="239">
          <span class="hits">352</span>
          
          <code class="ruby">        tx = new(nil)</code>
        </li>
      
        <li class="covered" data-hits="352" data-linenumber="240">
          <span class="hits">352</span>
          
          <code class="ruby">        tx.ver, tx.lock_time = *h.values_at(&#39;ver&#39;, &#39;lock_time&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1078" data-linenumber="241">
          <span class="hits">1078</span>
          
          <code class="ruby">        h[&#39;in&#39;] .each{|input|   tx.add_in  TxIn.from_hash(input)   }</code>
        </li>
      
        <li class="covered" data-hits="1807" data-linenumber="242">
          <span class="hits">1807</span>
          
          <code class="ruby">        h[&#39;out&#39;].each{|output|  tx.add_out TxOut.from_hash(output) }</code>
        </li>
      
        <li class="covered" data-hits="358" data-linenumber="243">
          <span class="hits">358</span>
          
          <code class="ruby">        tx.instance_eval{ @time = h[&#39;time&#39;] } if Bitcoin.network_project == :ppcoin</code>
        </li>
      
        <li class="covered" data-hits="704" data-linenumber="244">
          <span class="hits">704</span>
          
          <code class="ruby">        tx.instance_eval{ @hash = hash_from_payload(@payload = to_payload) }</code>
        </li>
      
        <li class="covered" data-hits="352" data-linenumber="245">
          <span class="hits">352</span>
          
          <code class="ruby">        tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      # convert ruby hash to raw binary</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="249">
          <span class="hits">4</span>
          
          <code class="ruby">      def self.binary_from_hash(h); from_hash(h).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      # parse json representation</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="252">
          <span class="hits">31</span>
          
          <code class="ruby">      def self.from_json(json_string); from_hash( JSON.load(json_string) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">      # convert json representation to raw binary</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="255">
          <span class="hits">2</span>
          
          <code class="ruby">      def self.binary_from_json(json_string); from_json(json_string).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">      # read binary block from a file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_file(path); new( Bitcoin::Protocol.read_binary_file(path) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">      # read json block from a file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="261">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_json_file(path); from_json( Bitcoin::Protocol.read_binary_file(path) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="263">
          <span class="hits">1</span>
          
          <code class="ruby">      def validator(store, block = nil)</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="264">
          <span class="hits">36</span>
          
          <code class="ruby">        @validator ||= Bitcoin::Validation::Tx.new(self, store, block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="267">
          <span class="hits">3</span>
          
          <code class="ruby">      def minimum_relay_fee; calculate_minimum_fee(1_000, true, :relay); end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="268">
          <span class="hits">3</span>
          
          <code class="ruby">      def minimum_block_fee; calculate_minimum_fee(1_000, true, :block); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="270">
          <span class="hits">1</span>
          
          <code class="ruby">      def calculate_minimum_fee(block_size=1, allow_free=true, mode=:block)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="271">
          <span class="hits">4</span>
          
          <code class="ruby">        base_fee       = (mode == :relay) ? Bitcoin::MIN_RELAY_TX_FEE : Bitcoin::MIN_TX_FEE</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="272">
          <span class="hits">4</span>
          
          <code class="ruby">        tx_size        = to_payload.bytesize</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="273">
          <span class="hits">4</span>
          
          <code class="ruby">        new_block_size = block_size + tx_size</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="274">
          <span class="hits">4</span>
          
          <code class="ruby">        min_fee       = (1 + tx_size / 1_000) * base_fee</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="276">
          <span class="hits">4</span>
          
          <code class="ruby">        if allow_free</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="277">
          <span class="hits">4</span>
          
          <code class="ruby">          if block_size == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">            min_fee = 0 if tx_size &lt; 10_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="280">
          <span class="hits">4</span>
          
          <code class="ruby">            min_fee = 0 if new_block_size &lt; 27_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="284">
          <span class="hits">4</span>
          
          <code class="ruby">        if min_fee &lt; base_fee</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="285">
          <span class="hits">10</span>
          
          <code class="ruby">          outputs.each{|output| (min_fee = base_fee; break) if output.value &lt; Bitcoin::CENT }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="288">
          <span class="hits">4</span>
          
          <code class="ruby">        if block_size != 1 &amp;&amp; new_block_size &gt;= (Bitcoin::MAX_BLOCK_SIZE_GEN/2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">          #return Bitcoin::MAX_MONEY if new_block_size &gt;= Bitcoin::MAX_BLOCK_SIZE_GEN</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">          min_fee *= Bitcoin::MAX_BLOCK_SIZE_GEN / (Bitcoin::MAX_BLOCK_SIZE_GEN - new_block_size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="293">
          <span class="hits">4</span>
          
          <code class="ruby">        min_fee = Bitcoin::MAX_MONEY unless min_fee.between?(0, Bitcoin::MAX_MONEY)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="294">
          <span class="hits">4</span>
          
          <code class="ruby">        min_fee</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1535735601f850f0edb630e497ee3ca0f6253a95">
  <div class="header">
    <h3>lib/bitcoin/protocol/txin.rb</h3>
    <h4><span class="green">95.16 %</span> covered</h4>
    <div>
      <b>62</b> relevant lines. 
      <span class="green"><b>59</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxIn</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      # previous output hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :prev_out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      # previous output index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :prev_out_index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # script_sig input Script (signature)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :script_sig, :script_sig_length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :script   :script_sig</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :script_length  :script_sig_length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # sequence</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :sequence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      DEFAULT_SEQUENCE = &quot;\xff\xff\xff\xff&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        @prev_out, @prev_out_index, @script_sig_length,</code>
        </li>
      
        <li class="covered" data-hits="2280" data-linenumber="27">
          <span class="hits">2280</span>
          
          <code class="ruby">        @script_sig, @sequence = *args</code>
        </li>
      
        <li class="covered" data-hits="2280" data-linenumber="28">
          <span class="hits">2280</span>
          
          <code class="ruby">        @sequence ||= DEFAULT_SEQUENCE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      # compare to another txout</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        @prev_out == other.prev_out &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">          @prev_out_index == other.prev_out_index &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          @script_sig == other.script_sig &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">          @sequence == other.sequence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # parse raw binary data for transaction input</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="41">
          <span class="hits">16</span>
          
          <code class="ruby">        idx = 0</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="42">
          <span class="hits">16</span>
          
          <code class="ruby">        @prev_out, @prev_out_index = data[idx...idx+=36].unpack(&quot;a32V&quot;)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="43">
          <span class="hits">16</span>
          
          <code class="ruby">        @script_sig_length, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="44">
          <span class="hits">16</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize - tmp.bytesize</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="45">
          <span class="hits">16</span>
          
          <code class="ruby">        @script_sig = data[idx...idx+=@script_sig_length]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="46">
          <span class="hits">16</span>
          
          <code class="ruby">        @sequence = data[idx...idx+=4]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="47">
          <span class="hits">16</span>
          
          <code class="ruby">        idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="1284" data-linenumber="51">
          <span class="hits">1284</span>
          
          <code class="ruby">        txin = new; txin.parse_data_from_io(buf); txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="1284" data-linenumber="55">
          <span class="hits">1284</span>
          
          <code class="ruby">        @prev_out, @prev_out_index = buf.read(36).unpack(&quot;a32V&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1284" data-linenumber="56">
          <span class="hits">1284</span>
          
          <code class="ruby">        @script_sig_length = Protocol.unpack_var_int_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="1283" data-linenumber="57">
          <span class="hits">1283</span>
          
          <code class="ruby">        @script_sig = buf.read(@script_sig_length)</code>
        </li>
      
        <li class="covered" data-hits="1283" data-linenumber="58">
          <span class="hits">1283</span>
          
          <code class="ruby">        @sequence = buf.read(4)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :parse_payload :parse_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload(script=@script_sig, sequence=@sequence)</code>
        </li>
      
        <li class="covered" data-hits="4805" data-linenumber="64">
          <span class="hits">4805</span>
          
          <code class="ruby">        buf =  [ @prev_out, @prev_out_index ].pack(&quot;a32V&quot;)</code>
        </li>
      
        <li class="covered" data-hits="4805" data-linenumber="65">
          <span class="hits">4805</span>
          
          <code class="ruby">        buf &lt;&lt; Protocol.pack_var_int(script.bytesize)</code>
        </li>
      
        <li class="covered" data-hits="4805" data-linenumber="66">
          <span class="hits">4805</span>
          
          <code class="ruby">        buf &lt;&lt; script if script.bytesize &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="4805" data-linenumber="67">
          <span class="hits">4805</span>
          
          <code class="ruby">        buf &lt;&lt; (sequence || DEFAULT_SEQUENCE)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash(options = {})</code>
        </li>
      
        <li class="covered" data-hits="222" data-linenumber="71">
          <span class="hits">222</span>
          
          <code class="ruby">        t = { &#39;prev_out&#39;  =&gt; { &#39;hash&#39; =&gt; @prev_out.reverse_hth, &#39;n&#39; =&gt; @prev_out_index } }</code>
        </li>
      
        <li class="covered" data-hits="222" data-linenumber="72">
          <span class="hits">222</span>
          
          <code class="ruby">        if coinbase?</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="73">
          <span class="hits">43</span>
          
          <code class="ruby">          t[&#39;coinbase&#39;]  = @script_sig.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">        else # coinbase tx</code>
        </li>
      
        <li class="covered" data-hits="179" data-linenumber="75">
          <span class="hits">179</span>
          
          <code class="ruby">          t[&#39;scriptSig&#39;] = Bitcoin::Script.new(@script_sig).to_string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="222" data-linenumber="77">
          <span class="hits">222</span>
          
          <code class="ruby">        t[&#39;sequence&#39;]  = @sequence.unpack(&quot;V&quot;)[0] unless @sequence == &quot;\xff\xff\xff\xff&quot;</code>
        </li>
      
        <li class="covered" data-hits="222" data-linenumber="78">
          <span class="hits">222</span>
          
          <code class="ruby">        t</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash(input)</code>
        </li>
      
        <li class="covered" data-hits="726" data-linenumber="82">
          <span class="hits">726</span>
          
          <code class="ruby">        txin = TxIn.new([ input[&#39;prev_out&#39;][&#39;hash&#39;] ].pack(&#39;H*&#39;).reverse, input[&#39;prev_out&#39;][&#39;n&#39;])</code>
        </li>
      
        <li class="covered" data-hits="726" data-linenumber="83">
          <span class="hits">726</span>
          
          <code class="ruby">        if input[&#39;coinbase&#39;]</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="84">
          <span class="hits">37</span>
          
          <code class="ruby">          txin.script_sig = [ input[&#39;coinbase&#39;] ].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="689" data-linenumber="86">
          <span class="hits">689</span>
          
          <code class="ruby">          txin.script_sig = Script.binary_from_string(input[&#39;scriptSig&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="726" data-linenumber="88">
          <span class="hits">726</span>
          
          <code class="ruby">        txin.sequence = [ input[&#39;sequence&#39;] || 0xffffffff ].pack(&quot;V&quot;)</code>
        </li>
      
        <li class="covered" data-hits="726" data-linenumber="89">
          <span class="hits">726</span>
          
          <code class="ruby">        txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hex_hash(hash, index)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        TxIn.new([hash].pack(&quot;H*&quot;).reverse, index, 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      # previous output in hex</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">      def previous_output</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        @prev_out.reverse_hth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      # check if input is coinbase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">      def coinbase?</code>
        </li>
      
        <li class="covered" data-hits="1554" data-linenumber="103">
          <span class="hits">1554</span>
          
          <code class="ruby">        (@prev_out_index == 4294967295) &amp;&amp; (@prev_out == &quot;\x00&quot;*32)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      # set script_sig and script_sig_length</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">      def script_sig=(script_sig)</code>
        </li>
      
        <li class="covered" data-hits="2611" data-linenumber="108">
          <span class="hits">2611</span>
          
          <code class="ruby">        @script_sig_length = script_sig.bytesize</code>
        </li>
      
        <li class="covered" data-hits="2611" data-linenumber="109">
          <span class="hits">2611</span>
          
          <code class="ruby">        @script_sig = script_sig</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :script= :script_sig=</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">      def add_signature_pubkey_script(sig, pubkey_hex)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">        self.script = Bitcoin::Script.to_signature_pubkey_script(sig, [pubkey_hex].pack(&quot;H*&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="925463098a998a603cae90a61e90032defc0f861">
  <div class="header">
    <h3>lib/bitcoin/protocol/txout.rb</h3>
    <h4><span class="green">98.04 %</span> covered</h4>
    <div>
      <b>51</b> relevant lines. 
      <span class="green"><b>50</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxOut</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      # output value (in base units; &quot;satoshi&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      # pk_script output Script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :pk_script, :pk_script_length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize *args</code>
        </li>
      
        <li class="covered" data-hits="3991" data-linenumber="15">
          <span class="hits">3991</span>
          
          <code class="ruby">        if args.size == 2</code>
        </li>
      
        <li class="covered" data-hits="1459" data-linenumber="16">
          <span class="hits">1459</span>
          
          <code class="ruby">          @value, @pk_script_length, @pk_script = args[0], args[1].bytesize, args[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="2532" data-linenumber="18">
          <span class="hits">2532</span>
          
          <code class="ruby">          @value, @pk_script_length, @pk_script = *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="23">
          <span class="hits">4</span>
          
          <code class="ruby">        @value == other.value &amp;&amp; @pk_script == other.pk_script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # parse raw binary data for transaction output</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="28">
          <span class="hits">28</span>
          
          <code class="ruby">        idx = 0</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="29">
          <span class="hits">28</span>
          
          <code class="ruby">        @value = data[idx...idx+=8].unpack(&quot;Q&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="30">
          <span class="hits">28</span>
          
          <code class="ruby">        @pk_script_length, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="31">
          <span class="hits">28</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize - tmp.bytesize</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="32">
          <span class="hits">28</span>
          
          <code class="ruby">        @pk_script = data[idx...idx+=@pk_script_length]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="33">
          <span class="hits">28</span>
          
          <code class="ruby">        idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="2241" data-linenumber="37">
          <span class="hits">2241</span>
          
          <code class="ruby">        txout = new; txout.parse_data_from_io(buf); txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      # parse raw binary data for transaction output</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="2241" data-linenumber="42">
          <span class="hits">2241</span>
          
          <code class="ruby">        @value = buf.read(8).unpack(&quot;Q&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="2241" data-linenumber="43">
          <span class="hits">2241</span>
          
          <code class="ruby">        @pk_script_length = Protocol.unpack_var_int_from_io(buf)</code>
        </li>
      
        <li class="covered" data-hits="2241" data-linenumber="44">
          <span class="hits">2241</span>
          
          <code class="ruby">        @pk_script = buf.read(@pk_script_length)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :parse_payload :parse_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="7447" data-linenumber="50">
          <span class="hits">7447</span>
          
          <code class="ruby">        buf =  [ @value ].pack(&quot;Q&quot;)</code>
        </li>
      
        <li class="covered" data-hits="7447" data-linenumber="51">
          <span class="hits">7447</span>
          
          <code class="ruby">        buf &lt;&lt; Protocol.pack_var_int(@pk_script_length)</code>
        </li>
      
        <li class="covered" data-hits="7447" data-linenumber="52">
          <span class="hits">7447</span>
          
          <code class="ruby">        buf &lt;&lt; @pk_script if @pk_script_length &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="7447" data-linenumber="53">
          <span class="hits">7447</span>
          
          <code class="ruby">        buf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_null_payload</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        self.class.new(-1, &#39;&#39;).to_payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash(options = {})</code>
        </li>
      
        <li class="covered" data-hits="693" data-linenumber="61">
          <span class="hits">693</span>
          
          <code class="ruby">        script = Bitcoin::Script.new(@pk_script)</code>
        </li>
      
        <li class="covered" data-hits="693" data-linenumber="62">
          <span class="hits">693</span>
          
          <code class="ruby">        h = { &#39;value&#39; =&gt; &quot;%.8f&quot; % (@value / 100000000.0),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">          &#39;scriptPubKey&#39; =&gt; script.to_string }</code>
        </li>
      
        <li class="covered" data-hits="693" data-linenumber="64">
          <span class="hits">693</span>
          
          <code class="ruby">        h[&quot;address&quot;] = script.get_address  if script.is_hash160? &amp;&amp; options[:with_address]</code>
        </li>
      
        <li class="covered" data-hits="693" data-linenumber="65">
          <span class="hits">693</span>
          
          <code class="ruby">        h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash(output)</code>
        </li>
      
        <li class="covered" data-hits="1455" data-linenumber="69">
          <span class="hits">1455</span>
          
          <code class="ruby">        amount = output[&#39;value&#39;].gsub(&#39;.&#39;,&#39;&#39;).to_i</code>
        </li>
      
        <li class="covered" data-hits="1455" data-linenumber="70">
          <span class="hits">1455</span>
          
          <code class="ruby">        script = Script.binary_from_string(output[&#39;scriptPubKey&#39;])</code>
        </li>
      
        <li class="covered" data-hits="1455" data-linenumber="71">
          <span class="hits">1455</span>
          
          <code class="ruby">        new(amount, script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      # set pk_script and pk_script_length</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      def pk_script=(script)</code>
        </li>
      
        <li class="covered" data-hits="1921" data-linenumber="75">
          <span class="hits">1921</span>
          
          <code class="ruby">        @pk_script_length, @pk_script = script.bytesize, script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :amount   :value</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :amount=  :value=</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :script   :pk_script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :script=  :pk_script=</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      # create output spending +value+ btc (base units) to +address+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.value_to_address(value, address)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="86">
          <span class="hits">2</span>
          
          <code class="ruby">        pk_script = Bitcoin::Script.to_address_script(address)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="87">
          <span class="hits">2</span>
          
          <code class="ruby">        raise &quot;Script#pk_script nil with address #{address}&quot; unless pk_script</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="88">
          <span class="hits">2</span>
          
          <code class="ruby">        new(value, pk_script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="64138ab3345824464f68bf4ae98e60bd0dbb4ca8">
  <div class="header">
    <h3>lib/bitcoin/protocol/version.rb</h3>
    <h4><span class="green">96.77 %</span> covered</h4>
    <div>
      <b>31</b> relevant lines. 
      <span class="green"><b>30</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class Version</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :fields</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(opts={})</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="9">
          <span class="hits">4</span>
          
          <code class="ruby">        @fields = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">          :version    =&gt; Bitcoin.network[:protocol_version],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">          :services   =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">          :time       =&gt; Time.now.tv_sec,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">          :from       =&gt; &quot;127.0.0.1:8333&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">          :to         =&gt; &quot;127.0.0.1:8333&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">          :nonce      =&gt; Bitcoin::Protocol::Uniq,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">          :user_agent =&gt; &quot;/bitcoin-ruby:#{Bitcoin::VERSION}/&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">          :last_block =&gt; 0 # 188617</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="18">
          <span class="hits">5</span>
          
          <code class="ruby">        }.merge( opts.reject{|k,v| v == nil } )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">        payload = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">          @fields.values_at(:version, :services, :time).pack(&quot;VQQ&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          pack_address_field(@fields[:from]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">          pack_address_field(@fields[:to]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">          @fields.values_at(:nonce).pack(&quot;Q&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          Protocol.pack_var_string(@fields[:user_agent]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">          @fields.values_at(:last_block).pack(&quot;V&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        ].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_pkt</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">        Bitcoin::Protocol.pkt(&quot;version&quot;, to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="37">
          <span class="hits">3</span>
          
          <code class="ruby">        version, services, timestamp, to, from, nonce, payload = payload.unpack(&quot;Va8Qa26a26Qa*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="38">
          <span class="hits">3</span>
          
          <code class="ruby">        to, from = unpack_address_field(to), unpack_address_field(from)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="39">
          <span class="hits">3</span>
          
          <code class="ruby">        user_agent, payload = Protocol.unpack_var_string(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="40">
          <span class="hits">3</span>
          
          <code class="ruby">        last_block = payload.unpack(&quot;V&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="42">
          <span class="hits">3</span>
          
          <code class="ruby">        @fields = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">         :version =&gt; version, :services =&gt; services, :time =&gt; timestamp,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">         :from =&gt; from, :to =&gt; to, :nonce =&gt; nonce,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">         :user_agent =&gt; user_agent.to_s, :last_block =&gt; last_block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="47">
          <span class="hits">3</span>
          
          <code class="ruby">        self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      def unpack_address_field(payload)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="51">
          <span class="hits">6</span>
          
          <code class="ruby">        ip, port = payload.unpack(&quot;x8x12a4n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="52">
          <span class="hits">6</span>
          
          <code class="ruby">        &quot;#{ip.unpack(&quot;C*&quot;).join(&quot;.&quot;)}:#{port}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      def pack_address_field(addr_str)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="56">
          <span class="hits">2</span>
          
          <code class="ruby">        host, port = addr_str.split(&quot;:&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="57">
          <span class="hits">2</span>
          
          <code class="ruby">        port = port ? port.to_i : 8333</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="58">
          <span class="hits">2</span>
          
          <code class="ruby">        sockaddr = Socket.pack_sockaddr_in(port, host)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        #raise &quot;invalid IPv4 Address: #{addr}&quot; unless sockaddr[0...2] == &quot;\x02\x00&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">        port, host = sockaddr[2...4], sockaddr[4...8]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="61">
          <span class="hits">2</span>
          
          <code class="ruby">        [[1].pack(&quot;Q&quot;), &quot;\x00&quot;*10, &quot;\xFF\xFF&quot;,  host, port].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      def uptime</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        @fields[:time] - Time.now.tv_sec</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      def method_missing(*a); (@fields[a.first] rescue nil) or super(*a); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="70">
          <span class="hits">4</span>
          
          <code class="ruby">      def self.parse(payload); new.parse(payload); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="9997f171293226ec441ccaa33d726c508ff07a39">
  <div class="header">
    <h3>lib/bitcoin/script.rb</h3>
    <h4><span class="green">96.7 %</span> covered</h4>
    <div>
      <b>575</b> relevant lines. 
      <span class="green"><b>556</b> lines covered</span> and
      <span class="red"><b>19</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bitcoin&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">class Bitcoin::Script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_1           = 81</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_TRUE        = 81</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_0           = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_FALSE       = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_PUSHDATA0   = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_PUSHDATA1   = 76</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_PUSHDATA2   = 77</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_PUSHDATA4   = 78</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP         = 97</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_DUP         = 118</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_HASH160     = 169</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_EQUAL       = 135</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_VERIFY      = 105</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_EQUALVERIFY = 136</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CHECKSIG    = 172</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CHECKSIGVERIFY      = 173</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CHECKMULTISIG       = 174</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CHECKMULTISIGVERIFY = 175</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_TOALTSTACK   = 107</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_FROMALTSTACK = 108</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_TUCK         = 125</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_SWAP         = 124</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_BOOLAND      = 154</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_ADD          = 147</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_SUB          = 148</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_GREATERTHANOREQUAL = 162</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_DROP         = 117</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_HASH256      = 170</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_SHA256       = 168</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_SHA1         = 167</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_RIPEMD160    = 166</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP1         = 176</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP2         = 177</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP3         = 178</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP4         = 179</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP5         = 180</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP6         = 181</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP7         = 182</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP8         = 183</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP9         = 184</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP10        = 185</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CODESEPARATOR = 171</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_MIN          = 163</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_MAX          = 164</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_2OVER        = 112</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_2SWAP        = 114</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_IFDUP        = 115</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_DEPTH        = 116</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_1NEGATE      = 79</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_WITHIN         = 165</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NUMEQUAL       = 156</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NUMEQUALVERIFY = 157</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_LESSTHAN     = 159</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_LESSTHANOREQUAL = 161</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_GREATERTHAN  = 160</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOT            = 145</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_0NOTEQUAL = 146</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_ABS = 144</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_1ADD = 139</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_1SUB = 140</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NEGATE = 143</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_BOOLOR = 155</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NUMNOTEQUAL = 158</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_RETURN = 106</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_OVER = 120</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_IF = 99</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOTIF = 100</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_ELSE = 103</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_ENDIF = 104</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_PICK = 121</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_SIZE = 130</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_VER = 98</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_ROLL = 122</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_ROT = 123</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_2DROP = 109</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_2DUP = 110</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_3DUP = 111</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NIP = 119</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CAT = 126</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_SUBSTR = 127</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_LEFT = 128</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_RIGHT = 129</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_INVERT = 131</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_AND = 132</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_OR = 133</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_XOR = 134</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_2MUL = 141</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_2DIV = 142</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_MUL = 149</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_DIV = 150</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_MOD = 151</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_LSHIFT = 152</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_RSHIFT = 153</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="103">
          <span class="hits">94</span>
          
          <code class="ruby">  OPCODES = Hash[*constants.grep(/^OP_/).map{|i| [const_get(i), i.to_s] }.flatten]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES[0] = &quot;0&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES[81] = &quot;1&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES_ALIAS = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    &quot;OP_TRUE&quot;  =&gt; OP_1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    &quot;OP_FALSE&quot; =&gt; OP_0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    &quot;OP_EVAL&quot; =&gt; OP_NOP1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    #&quot;OP_NOP2&quot; =&gt; OP_CHECKHASHVERIFY,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    &quot;OP_CHECKHASHVERIFY&quot; =&gt; OP_NOP2,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">  DISABLED_OPCODES = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    OP_CAT, OP_SUBSTR, OP_LEFT, OP_RIGHT, OP_INVERT,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    OP_AND, OP_OR, OP_XOR, OP_2MUL, OP_2DIV, OP_MUL,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    OP_DIV, OP_MOD, OP_LSHIFT, OP_RSHIFT</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CHECKHASHVERIFY = 177 # disabled</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_2_16 = (82..96).to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_reader :raw, :chunks, :debug</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  # create a new script. +bytes+ is typically input_script + output_script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(bytes, offset=0)</code>
        </li>
      
        <li class="covered" data-hits="1908" data-linenumber="129">
          <span class="hits">1908</span>
          
          <code class="ruby">    @raw = bytes</code>
        </li>
      
        <li class="covered" data-hits="1908" data-linenumber="130">
          <span class="hits">1908</span>
          
          <code class="ruby">    @stack, @stack_alt, @exec_stack = [], [], []</code>
        </li>
      
        <li class="covered" data-hits="1908" data-linenumber="131">
          <span class="hits">1908</span>
          
          <code class="ruby">    @chunks = parse(bytes, offset)</code>
        </li>
      
        <li class="covered" data-hits="1908" data-linenumber="132">
          <span class="hits">1908</span>
          
          <code class="ruby">    @do_exec = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">  class ::String</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :bitcoin_pushdata</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :bitcoin_pushdata_length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  # parse raw script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse(bytes, offset=0)</code>
        </li>
      
        <li class="covered" data-hits="1908" data-linenumber="142">
          <span class="hits">1908</span>
          
          <code class="ruby">    program = bytes.unpack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1908" data-linenumber="143">
          <span class="hits">1908</span>
          
          <code class="ruby">    chunks = []</code>
        </li>
      
        <li class="covered" data-hits="1908" data-linenumber="144">
          <span class="hits">1908</span>
          
          <code class="ruby">    until program.empty?</code>
        </li>
      
        <li class="covered" data-hits="8495" data-linenumber="145">
          <span class="hits">8495</span>
          
          <code class="ruby">      opcode = program.shift(1)[0]</code>
        </li>
      
        <li class="covered" data-hits="8495" data-linenumber="146">
          <span class="hits">8495</span>
          
          <code class="ruby">      if opcode &gt;= 0xf0 and program[0]</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="147">
          <span class="hits">11</span>
          
          <code class="ruby">        opcode = (opcode &lt;&lt; 8) | program.shift(1)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8495" data-linenumber="150">
          <span class="hits">8495</span>
          
          <code class="ruby">      if (opcode &gt; 0) &amp;&amp; (opcode &lt; OP_PUSHDATA1)</code>
        </li>
      
        <li class="covered" data-hits="2482" data-linenumber="151">
          <span class="hits">2482</span>
          
          <code class="ruby">        len, tmp = opcode, program[0]</code>
        </li>
      
        <li class="covered" data-hits="2482" data-linenumber="152">
          <span class="hits">2482</span>
          
          <code class="ruby">        chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">        # 0x16 = 22 due to OP_2_16 from_string parsing</code>
        </li>
      
        <li class="covered" data-hits="2482" data-linenumber="155">
          <span class="hits">2482</span>
          
          <code class="ruby">        if len == 1 &amp;&amp; tmp &lt;= 22</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="156">
          <span class="hits">19</span>
          
          <code class="ruby">          chunks.last.bitcoin_pushdata = OP_PUSHDATA0</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="157">
          <span class="hits">19</span>
          
          <code class="ruby">          chunks.last.bitcoin_pushdata_length = len</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="6013" data-linenumber="159">
          <span class="hits">6013</span>
          
          <code class="ruby">      elsif (opcode == OP_PUSHDATA1)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="160">
          <span class="hits">24</span>
          
          <code class="ruby">        len = program.shift(1)[0]</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="161">
          <span class="hits">24</span>
          
          <code class="ruby">        chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="163">
          <span class="hits">24</span>
          
          <code class="ruby">        unless len &gt; OP_PUSHDATA1 &amp;&amp; len &lt;= 0xff</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="164">
          <span class="hits">2</span>
          
          <code class="ruby">          chunks.last.bitcoin_pushdata = OP_PUSHDATA1</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="165">
          <span class="hits">2</span>
          
          <code class="ruby">          chunks.last.bitcoin_pushdata_length = len</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="5989" data-linenumber="167">
          <span class="hits">5989</span>
          
          <code class="ruby">      elsif (opcode == OP_PUSHDATA2)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="168">
          <span class="hits">17</span>
          
          <code class="ruby">        len = program.shift(2).pack(&quot;C*&quot;).unpack(&quot;v&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="169">
          <span class="hits">17</span>
          
          <code class="ruby">        chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="171">
          <span class="hits">17</span>
          
          <code class="ruby">        unless len &gt; 0xff &amp;&amp; len &lt;= 0xffff</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="172">
          <span class="hits">7</span>
          
          <code class="ruby">          chunks.last.bitcoin_pushdata = OP_PUSHDATA2</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="173">
          <span class="hits">7</span>
          
          <code class="ruby">          chunks.last.bitcoin_pushdata_length = len</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="5972" data-linenumber="175">
          <span class="hits">5972</span>
          
          <code class="ruby">      elsif (opcode == OP_PUSHDATA4)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="176">
          <span class="hits">5</span>
          
          <code class="ruby">        len = program.shift(4).pack(&quot;C*&quot;).unpack(&quot;V&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="177">
          <span class="hits">5</span>
          
          <code class="ruby">        chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="179">
          <span class="hits">5</span>
          
          <code class="ruby">        unless len &gt; 0xffff # &amp;&amp; len &lt;= 0xffffffff</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="180">
          <span class="hits">4</span>
          
          <code class="ruby">          chunks.last.bitcoin_pushdata = OP_PUSHDATA4</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="181">
          <span class="hits">4</span>
          
          <code class="ruby">          chunks.last.bitcoin_pushdata_length = len</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="5967" data-linenumber="184">
          <span class="hits">5967</span>
          
          <code class="ruby">        chunks &lt;&lt; opcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1908" data-linenumber="187">
          <span class="hits">1908</span>
          
          <code class="ruby">    chunks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">  # string representation of the script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_string(chunks=nil)</code>
        </li>
      
        <li class="covered" data-hits="958" data-linenumber="192">
          <span class="hits">958</span>
          
          <code class="ruby">    (chunks || @chunks).map{|i|</code>
        </li>
      
        <li class="covered" data-hits="4184" data-linenumber="193">
          <span class="hits">4184</span>
          
          <code class="ruby">      case i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      when Fixnum</code>
        </li>
      
        <li class="covered" data-hits="2901" data-linenumber="195">
          <span class="hits">2901</span>
          
          <code class="ruby">        case i</code>
        </li>
      
        <li class="covered" data-hits="2817" data-linenumber="196">
          <span class="hits">2817</span>
          
          <code class="ruby">        when *OPCODES.keys;          OPCODES[i]</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="197">
          <span class="hits">72</span>
          
          <code class="ruby">        when *OP_2_16;               (OP_2_16.index(i)+2).to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">        #when *OP_2_16;               &quot;OP_&quot; + (OP_2_16.index(i)+2).to_s</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="199">
          <span class="hits">12</span>
          
          <code class="ruby">        else &quot;(opcode-#{i})&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      when String</code>
        </li>
      
        <li class="covered" data-hits="1283" data-linenumber="202">
          <span class="hits">1283</span>
          
          <code class="ruby">        if i.bitcoin_pushdata</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="203">
          <span class="hits">12</span>
          
          <code class="ruby">          &quot;#{i.bitcoin_pushdata}:#{i.bitcoin_pushdata_length}:&quot;.force_encoding(&#39;binary&#39;) + i.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">        #elsif i.bytesize == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">        #  i.unpack(&quot;c&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1271" data-linenumber="207">
          <span class="hits">1271</span>
          
          <code class="ruby">          i.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="958" data-linenumber="210">
          <span class="hits">958</span>
          
          <code class="ruby">    }.join(&quot; &quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_binary(chunks=nil)</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="214">
          <span class="hits">21</span>
          
          <code class="ruby">    (chunks || @chunks).map{|chunk|</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="215">
          <span class="hits">25</span>
          
          <code class="ruby">      case chunk</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">      when Fixnum; [chunk].pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="217">
          <span class="hits">24</span>
          
          <code class="ruby">      when String; self.class.pack_pushdata(chunk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="219">
          <span class="hits">21</span>
          
          <code class="ruby">    }.join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">  alias :to_payload :to_binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.pack_pushdata(data)</code>
        </li>
      
        <li class="covered" data-hits="3408" data-linenumber="224">
          <span class="hits">3408</span>
          
          <code class="ruby">    size = data.bytesize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3408" data-linenumber="226">
          <span class="hits">3408</span>
          
          <code class="ruby">    if data.bitcoin_pushdata</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="227">
          <span class="hits">5</span>
          
          <code class="ruby">      size = data.bitcoin_pushdata_length</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="228">
          <span class="hits">5</span>
          
          <code class="ruby">      pack_pushdata_align(data.bitcoin_pushdata, size, data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3403" data-linenumber="230">
          <span class="hits">3403</span>
          
          <code class="ruby">      head = if size &lt; OP_PUSHDATA1</code>
        </li>
      
        <li class="covered" data-hits="3357" data-linenumber="231">
          <span class="hits">3357</span>
          
          <code class="ruby">               [size].pack(&quot;C&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">             elsif size &lt;= 0xff</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="233">
          <span class="hits">31</span>
          
          <code class="ruby">               [OP_PUSHDATA1, size].pack(&quot;CC&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">             elsif size &lt;= 0xffff</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="235">
          <span class="hits">13</span>
          
          <code class="ruby">               [OP_PUSHDATA2, size].pack(&quot;Cv&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">             #elsif size &lt;= 0xffffffff</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">             else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="238">
          <span class="hits">2</span>
          
          <code class="ruby">               [OP_PUSHDATA4, size].pack(&quot;CV&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">             end</code>
        </li>
      
        <li class="covered" data-hits="3403" data-linenumber="240">
          <span class="hits">3403</span>
          
          <code class="ruby">      head + data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.pack_pushdata_align(pushdata, len, data)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="245">
          <span class="hits">30</span>
          
          <code class="ruby">    case pushdata</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">    when OP_PUSHDATA1</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="247">
          <span class="hits">2</span>
          
          <code class="ruby">      [OP_PUSHDATA1, len].pack(&quot;CC&quot;) + data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">    when OP_PUSHDATA2</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="249">
          <span class="hits">7</span>
          
          <code class="ruby">      [OP_PUSHDATA2, len].pack(&quot;Cv&quot;) + data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">    when OP_PUSHDATA4</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="251">
          <span class="hits">4</span>
          
          <code class="ruby">      [OP_PUSHDATA4, len].pack(&quot;CV&quot;) + data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">    else # OP_PUSHDATA0</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="253">
          <span class="hits">17</span>
          
          <code class="ruby">      [len].pack(&quot;C&quot;) + data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">  # script object of a string representation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.from_string(script_string)</code>
        </li>
      
        <li class="covered" data-hits="169" data-linenumber="259">
          <span class="hits">169</span>
          
          <code class="ruby">    new(binary_from_string(script_string))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="262">
          <span class="hits">1</span>
          
          <code class="ruby">  class ScriptOpcodeError &lt; StandardError; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">  # raw script binary of a string representation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="265">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.binary_from_string(script_string)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    script_string.split(&quot; &quot;).map{|i|</code>
        </li>
      
        <li class="covered" data-hits="9978" data-linenumber="267">
          <span class="hits">9978</span>
          
          <code class="ruby">      case i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">      when /^OP_PUSHDATA[124]$/;     # skip</code>
        </li>
      
        <li class="covered" data-hits="76571" data-linenumber="269">
          <span class="hits">76571</span>
          
          <code class="ruby">      when *OPCODES.values;          OPCODES.find{|k,v| v == i }.first</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="270">
          <span class="hits">27</span>
          
          <code class="ruby">      when *OPCODES_ALIAS.keys;      OPCODES_ALIAS.find{|k,v| k == i }.last</code>
        </li>
      
        <li class="covered" data-hits="186" data-linenumber="271">
          <span class="hits">186</span>
          
          <code class="ruby">      when /^([2-9]|1[0-6])$/;       OP_2_16[$1.to_i-2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">      when /^OP_([2-9]|1[0-6])$/;    OP_2_16[$1.to_i-2]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="273">
          <span class="hits">6</span>
          
          <code class="ruby">      when /\(opcode\-(\d+)\)/;      $1.to_i</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="274">
          <span class="hits">2</span>
          
          <code class="ruby">      when /^(\d+)\)/;               $1.to_i # fix invalid opcode parsing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">      when /^\(opcode$/;             # skip  # fix invalid opcode parsing</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="276">
          <span class="hits">1</span>
          
          <code class="ruby">      when /OP_(.+)$/;               raise ScriptOpcodeError, &quot;#{i} not defined!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">      when /(\d+):(\d+):(.+)?/</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="278">
          <span class="hits">25</span>
          
          <code class="ruby">        pushdata, len, data = $1.to_i, $2.to_i, $3</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="279">
          <span class="hits">25</span>
          
          <code class="ruby">        pack_pushdata_align(pushdata, len, [data].pack(&quot;H*&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      #when /^(-)?([0-9][0-9]?|1[0-1][0-9]|12[0-8])$/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">      #  negative, number = $1, $2.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">      #  data = [ negative ? -number : number ].pack(&quot;c&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">      #  pack_pushdata(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="3384" data-linenumber="285">
          <span class="hits">3384</span>
          
          <code class="ruby">        data = [i].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3384" data-linenumber="286">
          <span class="hits">3384</span>
          
          <code class="ruby">        pack_pushdata(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">    }.map{|i|</code>
        </li>
      
        <li class="covered" data-hits="9976" data-linenumber="289">
          <span class="hits">9976</span>
          
          <code class="ruby">      i.is_a?(Fixnum) ? [OpenSSL::BN.new(i.to_s,10).to_hex].pack(&quot;H*&quot;) : i</code>
        </li>
      
        <li class="covered" data-hits="2377" data-linenumber="290">
          <span class="hits">2377</span>
          
          <code class="ruby">    }.join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="293">
          <span class="hits">1</span>
          
          <code class="ruby">  def invalid?</code>
        </li>
      
        <li class="covered" data-hits="1134" data-linenumber="294">
          <span class="hits">1134</span>
          
          <code class="ruby">    @script_invalid ||= false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">  # run the script. +check_callback+ is called for OP_CHECKSIG operations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="298">
          <span class="hits">1</span>
          
          <code class="ruby">  def run(block_timestamp=Time.now.to_i, &amp;check_callback)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">    #p [to_string, block_timestamp, is_p2sh?]</code>
        </li>
      
        <li class="covered" data-hits="174" data-linenumber="300">
          <span class="hits">174</span>
          
          <code class="ruby">    @script_invalid = true if @raw.bytesize &gt; 10_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="174" data-linenumber="302">
          <span class="hits">174</span>
          
          <code class="ruby">    if block_timestamp &gt;= 1333238400 # Pay to Script Hash (BIP 0016)</code>
        </li>
      
        <li class="covered" data-hits="162" data-linenumber="303">
          <span class="hits">162</span>
          
          <code class="ruby">      return pay_to_script_hash(check_callback)  if is_p2sh?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="166" data-linenumber="306">
          <span class="hits">166</span>
          
          <code class="ruby">    @debug = []</code>
        </li>
      
        <li class="covered" data-hits="166" data-linenumber="307">
          <span class="hits">166</span>
          
          <code class="ruby">    @chunks.each{|chunk|</code>
        </li>
      
        <li class="covered" data-hits="1132" data-linenumber="308">
          <span class="hits">1132</span>
          
          <code class="ruby">      break if invalid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3436" data-linenumber="310">
          <span class="hits">3436</span>
          
          <code class="ruby">      @debug &lt;&lt; @stack.map{|i| i.unpack(&quot;H*&quot;) rescue i}</code>
        </li>
      
        <li class="covered" data-hits="1131" data-linenumber="311">
          <span class="hits">1131</span>
          
          <code class="ruby">      @do_exec = @exec_stack.count(false) == 0 ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">      #p [@stack, @do_exec]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1131" data-linenumber="314">
          <span class="hits">1131</span>
          
          <code class="ruby">      case chunk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">      when Fixnum</code>
        </li>
      
        <li class="covered" data-hits="737" data-linenumber="316">
          <span class="hits">737</span>
          
          <code class="ruby">        next unless (@do_exec || (OP_IF &lt;= chunk &amp;&amp; chunk &lt;= OP_ENDIF))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="714" data-linenumber="318">
          <span class="hits">714</span>
          
          <code class="ruby">        case chunk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">        when *DISABLED_OPCODES</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">          @script_invalid = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">          @debug &lt;&lt; &quot;DISABLED_#{OPCODES[chunk]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">        when *OPCODES_METHOD.keys</code>
        </li>
      
        <li class="covered" data-hits="653" data-linenumber="323">
          <span class="hits">653</span>
          
          <code class="ruby">          m = method( n=OPCODES_METHOD[chunk] )</code>
        </li>
      
        <li class="covered" data-hits="653" data-linenumber="324">
          <span class="hits">653</span>
          
          <code class="ruby">          @debug &lt;&lt; n.to_s.upcase</code>
        </li>
      
        <li class="covered" data-hits="653" data-linenumber="325">
          <span class="hits">653</span>
          
          <code class="ruby">          (m.arity == 1) ? m.call(check_callback) : m.call  # invoke opcode method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">        when *OP_2_16</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="327">
          <span class="hits">61</span>
          
          <code class="ruby">          @stack &lt;&lt; OP_2_16.index(chunk) + 2</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="328">
          <span class="hits">61</span>
          
          <code class="ruby">          @debug &lt;&lt; &quot;OP_#{chunk-80}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">          name = OPCODES[chunk] || chunk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">          raise &quot;opcode #{name} unkown or not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">      when String</code>
        </li>
      
        <li class="covered" data-hits="394" data-linenumber="334">
          <span class="hits">394</span>
          
          <code class="ruby">        if @do_exec</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="335">
          <span class="hits">391</span>
          
          <code class="ruby">          @debug &lt;&lt; &quot;PUSH DATA #{chunk.unpack(&quot;H*&quot;)[0]}&quot;</code>
        </li>
      
        <li class="covered" data-hits="391" data-linenumber="336">
          <span class="hits">391</span>
          
          <code class="ruby">          @stack &lt;&lt; chunk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="365" data-linenumber="340">
          <span class="hits">365</span>
          
          <code class="ruby">    @debug &lt;&lt; @stack.map{|i| i.unpack(&quot;H*&quot;) rescue i } #if @do_exec</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="166" data-linenumber="342">
          <span class="hits">166</span>
          
          <code class="ruby">    if @script_invalid</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="343">
          <span class="hits">10</span>
          
          <code class="ruby">      @stack &lt;&lt; 0</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="344">
          <span class="hits">10</span>
          
          <code class="ruby">      @debug &lt;&lt; &quot;INVALID TRANSACTION&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="166" data-linenumber="347">
          <span class="hits">166</span>
          
          <code class="ruby">    @debug &lt;&lt; &quot;RESULT&quot;</code>
        </li>
      
        <li class="covered" data-hits="166" data-linenumber="348">
          <span class="hits">166</span>
          
          <code class="ruby">    return false if @stack.empty?</code>
        </li>
      
        <li class="covered" data-hits="166" data-linenumber="349">
          <span class="hits">166</span>
          
          <code class="ruby">    return false if [0, &#39;&#39;].include?(@stack.pop)</code>
        </li>
      
        <li class="covered" data-hits="153" data-linenumber="350">
          <span class="hits">153</span>
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="353">
          <span class="hits">1</span>
          
          <code class="ruby">  def invalid</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="354">
          <span class="hits">10</span>
          
          <code class="ruby">    @script_invalid = true; nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="357">
          <span class="hits">1</span>
          
          <code class="ruby">  def codehash_script(opcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">    # CScript scriptCode(pbegincodehash, pend);</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="359">
          <span class="hits">2</span>
          
          <code class="ruby">    script    = to_string(@chunks[(@codehash_start||0)...@chunks.size-@chunks.reverse.index(opcode)])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="360">
          <span class="hits">2</span>
          
          <code class="ruby">    checkhash = Bitcoin.hash160(Bitcoin::Script.binary_from_string(script).unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="361">
          <span class="hits">2</span>
          
          <code class="ruby">    [script, checkhash]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="364">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.drop_signatures(script_pubkey, drop_signatures)</code>
        </li>
      
        <li class="covered" data-hits="235" data-linenumber="365">
          <span class="hits">235</span>
          
          <code class="ruby">    script = new(script_pubkey).to_string.split(&quot; &quot;).delete_if{|c| drop_signatures.include?(c) }.join(&quot; &quot;)</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="366">
          <span class="hits">26</span>
          
          <code class="ruby">    script_pubkey = binary_from_string(script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">  # pay_to_script_hash: https://en.bitcoin.it/wiki/BIP_0016</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">  # &lt;sig&gt; {&lt;pub&gt; OP_CHECKSIG} | OP_HASH160 &lt;script_hash&gt; OP_EQUAL</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="372">
          <span class="hits">1</span>
          
          <code class="ruby">  def pay_to_script_hash(check_callback)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="373">
          <span class="hits">8</span>
          
          <code class="ruby">    return false if @chunks.size &lt; 4</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="374">
          <span class="hits">7</span>
          
          <code class="ruby">    *rest, script, _, script_hash, _ = @chunks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="376">
          <span class="hits">21</span>
          
          <code class="ruby">    return false unless [script, script_hash].all?{|i| i.is_a?(String) }</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="377">
          <span class="hits">7</span>
          
          <code class="ruby">    return false unless Bitcoin.hash160(script.unpack(&quot;H*&quot;)[0]) == script_hash.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="378">
          <span class="hits">7</span>
          
          <code class="ruby">    rest.delete_at(0) if rest[0] == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="380">
          <span class="hits">7</span>
          
          <code class="ruby">    script = self.class.new(to_binary(rest) + script).inner_p2sh!</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="381">
          <span class="hits">7</span>
          
          <code class="ruby">    result = script.run(&amp;check_callback)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="382">
          <span class="hits">7</span>
          
          <code class="ruby">    @debug = script.debug</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="383">
          <span class="hits">7</span>
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="386">
          <span class="hits">8</span>
          
          <code class="ruby">  def inner_p2sh!; @inner_p2sh = true; self; end</code>
        </li>
      
        <li class="covered" data-hits="100" data-linenumber="387">
          <span class="hits">100</span>
          
          <code class="ruby">  def inner_p2sh?; @inner_p2sh; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="389">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_pay_to_script_hash?</code>
        </li>
      
        <li class="covered" data-hits="168" data-linenumber="390">
          <span class="hits">168</span>
          
          <code class="ruby">    return false  unless @chunks[-2].is_a?(String)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="391">
          <span class="hits">37</span>
          
          <code class="ruby">    @chunks.size &gt;= 3 &amp;&amp; @chunks[-3] == OP_HASH160 &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">      @chunks[-2].bytesize == 20 &amp;&amp; @chunks[-1] == OP_EQUAL</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="394">
          <span class="hits">1</span>
          
          <code class="ruby">  alias :is_p2sh? :is_pay_to_script_hash?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">  # check if script is in one of the recognized standard formats</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="397">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_standard?</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="398">
          <span class="hits">5</span>
          
          <code class="ruby">    is_pubkey? || is_hash160? || is_multisig? || is_p2sh?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">  # is this a pubkey tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="402">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_pubkey?</code>
        </li>
      
        <li class="covered" data-hits="718" data-linenumber="403">
          <span class="hits">718</span>
          
          <code class="ruby">    return false if @chunks.size != 2</code>
        </li>
      
        <li class="covered" data-hits="669" data-linenumber="404">
          <span class="hits">669</span>
          
          <code class="ruby">    (@chunks[1] == OP_CHECKSIG) &amp;&amp; @chunks[0].size &gt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="406">
          <span class="hits">1</span>
          
          <code class="ruby">  alias :is_send_to_ip? :is_pubkey?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">  # is this a hash160 (address) tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="409">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_hash160?</code>
        </li>
      
        <li class="covered" data-hits="2569" data-linenumber="410">
          <span class="hits">2569</span>
          
          <code class="ruby">    return false  if @chunks.size != 5</code>
        </li>
      
        <li class="covered" data-hits="2011" data-linenumber="411">
          <span class="hits">2011</span>
          
          <code class="ruby">    (@chunks[0..1] + @chunks[-2..-1]) ==</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">      [OP_DUP, OP_HASH160, OP_EQUALVERIFY, OP_CHECKSIG] &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="2011" data-linenumber="413">
          <span class="hits">2011</span>
          
          <code class="ruby">      @chunks[2].is_a?(String) &amp;&amp; @chunks[2].bytesize == 20</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">  # is this a multisig tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="417">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_multisig?</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="418">
          <span class="hits">23</span>
          
          <code class="ruby">    return false  if @chunks.size &gt; 6 || @chunks.size &lt; 4</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="419">
          <span class="hits">13</span>
          
          <code class="ruby">    @chunks[-1] == OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">  # get type of this tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="423">
          <span class="hits">1</span>
          
          <code class="ruby">  def type</code>
        </li>
      
        <li class="covered" data-hits="594" data-linenumber="424">
          <span class="hits">594</span>
          
          <code class="ruby">    if is_hash160?;     :hash160</code>
        </li>
      
        <li class="covered" data-hits="170" data-linenumber="425">
          <span class="hits">170</span>
          
          <code class="ruby">    elsif is_pubkey?;   :pubkey</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="426">
          <span class="hits">5</span>
          
          <code class="ruby">    elsif is_multisig?; :multisig</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="427">
          <span class="hits">2</span>
          
          <code class="ruby">    elsif is_p2sh?;     :p2sh</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="428">
          <span class="hits">1</span>
          
          <code class="ruby">    else;               :unknown</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">  # get the public key for this pubkey script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="433">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_pubkey</code>
        </li>
      
        <li class="covered" data-hits="170" data-linenumber="434">
          <span class="hits">170</span>
          
          <code class="ruby">    return @chunks[0].unpack(&quot;H*&quot;)[0] if @chunks.size == 1</code>
        </li>
      
        <li class="covered" data-hits="170" data-linenumber="435">
          <span class="hits">170</span>
          
          <code class="ruby">    is_pubkey? ? @chunks[0].unpack(&quot;H*&quot;)[0] : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">  # get the pubkey address for this pubkey script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="439">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_pubkey_address</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="440">
          <span class="hits">5</span>
          
          <code class="ruby">    Bitcoin.pubkey_to_address(get_pubkey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">  # get the hash160 for this hash160 or pubkey script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="444">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_hash160</code>
        </li>
      
        <li class="covered" data-hits="599" data-linenumber="445">
          <span class="hits">599</span>
          
          <code class="ruby">    return @chunks[2..-3][0].unpack(&quot;H*&quot;)[0]  if is_hash160?</code>
        </li>
      
        <li class="covered" data-hits="165" data-linenumber="446">
          <span class="hits">165</span>
          
          <code class="ruby">    return Bitcoin.hash160(get_pubkey)        if is_pubkey?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby">  # get the hash160 address for this hash160 script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="450">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_hash160_address</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="451">
          <span class="hits">13</span>
          
          <code class="ruby">    Bitcoin.hash160_to_address(get_hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby">  # get the public keys for this multisig script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="455">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_multisig_pubkeys</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="456">
          <span class="hits">35</span>
          
          <code class="ruby">    1.upto(@chunks[-2] - 80).map {|i| @chunks[i]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">  # get the pubkey addresses for this multisig script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="460">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_multisig_addresses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">    get_multisig_pubkeys.map{|pub|</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="462">
          <span class="hits">17</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="463">
          <span class="hits">17</span>
          
          <code class="ruby">        Bitcoin::Key.new(nil, pub.unpack(&quot;H*&quot;)[0]).addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">      rescue OpenSSL::PKey::ECError, OpenSSL::PKey::EC::Point::Error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="466">
          <span class="hits">7</span>
          
          <code class="ruby">    }.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby">  # get all addresses this script corresponds to (if possible)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="470">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_addresses</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="471">
          <span class="hits">19</span>
          
          <code class="ruby">    return [get_pubkey_address]    if is_pubkey?</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="472">
          <span class="hits">15</span>
          
          <code class="ruby">    return [get_hash160_address]   if is_hash160?</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="473">
          <span class="hits">5</span>
          
          <code class="ruby">    return get_multisig_addresses  if is_multisig?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="474">
          <span class="hits">1</span>
          
          <code class="ruby">    []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby">  # get single address, or first for multisig script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="478">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_address</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="479">
          <span class="hits">17</span>
          
          <code class="ruby">    addrs = get_addresses</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="480">
          <span class="hits">17</span>
          
          <code class="ruby">    addrs.is_a?(Array) ? addrs[0] : addrs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">  # generate pubkey tx script for given +pubkey+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="484">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_pubkey_script(pubkey)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="485">
          <span class="hits">3</span>
          
          <code class="ruby">    pk = [pubkey].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="486">
          <span class="hits">3</span>
          
          <code class="ruby">    [[pk.bytesize].pack(&quot;C&quot;), pk, &quot;\xAC&quot;].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby">  # generate hash160 tx for given +address+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="490">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_hash160_script(hash160)</code>
        </li>
      
        <li class="covered" data-hits="340" data-linenumber="491">
          <span class="hits">340</span>
          
          <code class="ruby">    return nil  unless hash160</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">    #  DUP   HASH160  length  hash160    EQUALVERIFY  CHECKSIG</code>
        </li>
      
        <li class="covered" data-hits="340" data-linenumber="493">
          <span class="hits">340</span>
          
          <code class="ruby">    [ [&quot;76&quot;, &quot;a9&quot;,    &quot;14&quot;,   hash160,   &quot;88&quot;,        &quot;ac&quot;].join ].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="496">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_p2sh_script(p2sh)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="497">
          <span class="hits">3</span>
          
          <code class="ruby">    return nil  unless p2sh</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby">    # HASH160  length  hash  EQUAL</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="499">
          <span class="hits">3</span>
          
          <code class="ruby">    [ [&quot;a9&quot;,   &quot;14&quot;,   p2sh, &quot;87&quot;].join ].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="502">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_address_script(address)</code>
        </li>
      
        <li class="covered" data-hits="341" data-linenumber="503">
          <span class="hits">341</span>
          
          <code class="ruby">    hash160 = Bitcoin.hash160_from_address(address)</code>
        </li>
      
        <li class="covered" data-hits="341" data-linenumber="504">
          <span class="hits">341</span>
          
          <code class="ruby">    case Bitcoin.address_type(address)</code>
        </li>
      
        <li class="covered" data-hits="339" data-linenumber="505">
          <span class="hits">339</span>
          
          <code class="ruby">    when :hash160; to_hash160_script(hash160)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="506">
          <span class="hits">1</span>
          
          <code class="ruby">    when :p2sh;    to_p2sh_script(hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="507">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="509">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="510">
          
          
          <code class="ruby">  # generate multisig tx for given +pubkeys+, expecting +m+ signatures</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="511">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_multisig_script(m, *pubkeys)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="512">
          <span class="hits">16</span>
          
          <code class="ruby">    pubs = pubkeys.map{|pk|p=[pk].pack(&quot;H*&quot;); [p.bytesize].pack(&quot;C&quot;) + p}</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="513">
          <span class="hits">5</span>
          
          <code class="ruby">    [ [80 + m.to_i].pack(&quot;C&quot;), *pubs, [80 + pubs.size].pack(&quot;C&quot;), &quot;\xAE&quot;].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="514">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="515">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">  # generate pubkey script sig for given +signature+ and +pubkey+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="517">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_pubkey_script_sig(signature, pubkey)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="518">
          <span class="hits">52</span>
          
          <code class="ruby">    hash_type = &quot;\x01&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="519">
          
          
          <code class="ruby">    #pubkey = [pubkey].pack(&quot;H*&quot;) if pubkey.bytesize != 65</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="520">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="521">
          <span class="hits">52</span>
          
          <code class="ruby">    case pubkey[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="522">
          
          
          <code class="ruby">    when &quot;\x04&quot;</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="523">
          <span class="hits">50</span>
          
          <code class="ruby">      expected_size = 65</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="524">
          
          
          <code class="ruby">    when &quot;\x02&quot;, &quot;\x03&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="525">
          <span class="hits">1</span>
          
          <code class="ruby">      expected_size = 33</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="526">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="527">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="528">
          <span class="hits">52</span>
          
          <code class="ruby">    if !expected_size || pubkey.bytesize != expected_size</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="529">
          <span class="hits">1</span>
          
          <code class="ruby">      raise &quot;pubkey is not in binary form&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="530">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="531">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="532">
          <span class="hits">51</span>
          
          <code class="ruby">    [ [signature.bytesize+1].pack(&quot;C&quot;), signature, hash_type, [pubkey.bytesize].pack(&quot;C&quot;), pubkey ].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="534">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="535">
          
          
          <code class="ruby">  # alias for #to_pubkey_script_sig</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="536">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_signature_pubkey_script(*a)</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="537">
          <span class="hits">46</span>
          
          <code class="ruby">    to_pubkey_script_sig(*a)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="538">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="539">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="540">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_multisig_script_sig(*sigs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="541">
          
          
          <code class="ruby">    from_string(&quot;0 #{sigs.map{|s|s.unpack(&#39;H*&#39;)[0]}.join(&#39; &#39;)}&quot;).raw</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="542">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="544">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_signatures_required</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="545">
          
          
          <code class="ruby">    return false unless is_multisig?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="546">
          
          
          <code class="ruby">    @chunks[0] - 80</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="547">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="548">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="549">
          
          
          <code class="ruby">  ## OPCODES</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="550">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="551">
          
          
          <code class="ruby">  # Does nothing</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="552">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="553">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop1; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="554">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop2; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="555">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop3; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="556">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop4; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="557">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop5; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="558">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop6; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="559">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop7; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="560">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop8; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="561">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop9; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="562">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop10; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="563">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="564">
          
          
          <code class="ruby">  # Duplicates the top stack item.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="565">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_dup</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="566">
          <span class="hits">81</span>
          
          <code class="ruby">    @stack &lt;&lt; (@stack[-1].dup rescue @stack[-1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="567">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="568">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby">  # The input is hashed using SHA-256.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="570">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_sha256</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="571">
          <span class="hits">1</span>
          
          <code class="ruby">    buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="572">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; Digest::SHA256.digest(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="573">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="574">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="575">
          
          
          <code class="ruby">  # The input is hashed using SHA-1.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="576">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_sha1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="577">
          <span class="hits">1</span>
          
          <code class="ruby">    buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="578">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; Digest::SHA1.digest(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="579">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="580">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby">  # The input is hashed twice: first with SHA-256 and then with RIPEMD-160.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="582">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_hash160</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="583">
          <span class="hits">71</span>
          
          <code class="ruby">    buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="584">
          <span class="hits">71</span>
          
          <code class="ruby">    @stack &lt;&lt; Digest::RMD160.digest(Digest::SHA256.digest(buf))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="585">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="586">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="587">
          
          
          <code class="ruby">  # The input is hashed using RIPEMD-160.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="588">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_ripemd160</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="589">
          <span class="hits">1</span>
          
          <code class="ruby">    buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="590">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; Digest::RMD160.digest(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="591">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="593">
          
          
          <code class="ruby">  # The input is hashed two times with SHA-256.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="594">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_hash256</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="595">
          <span class="hits">1</span>
          
          <code class="ruby">    buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="596">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; Digest::SHA256.digest(Digest::SHA256.digest(buf))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="597">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="598">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="599">
          
          
          <code class="ruby">  # Puts the input onto the top of the alt stack. Removes it from the main stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="600">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_toaltstack</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="601">
          <span class="hits">2</span>
          
          <code class="ruby">    @stack_alt &lt;&lt; @stack.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="602">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="603">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="604">
          
          
          <code class="ruby">  # Puts the input onto the top of the main stack. Removes it from the alt stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="605">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_fromaltstack</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="606">
          <span class="hits">2</span>
          
          <code class="ruby">    @stack &lt;&lt; @stack_alt.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="607">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="608">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="609">
          
          
          <code class="ruby">  # The item at the top of the stack is copied and inserted before the second-to-top item.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="610">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_tuck</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="611">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack[-2..-1] = [ @stack[-1], *@stack[-2..-1] ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="612">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="613">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="614">
          
          
          <code class="ruby">  # The top two items on the stack are swapped.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="615">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_swap</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="616">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack[-2..-1] = @stack[-2..-1].reverse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="617">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="618">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="619">
          
          
          <code class="ruby">  # If both a and b are not 0, the output is 1. Otherwise 0.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="620">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_booland</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="621">
          <span class="hits">4</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="622">
          <span class="hits">10</span>
          
          <code class="ruby">    @stack &lt;&lt; (![a,b].any?{|n| n == 0 } ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="624">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="625">
          
          
          <code class="ruby">  # If a or b is not 0, the output is 1. Otherwise 0.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="626">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_boolor</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="627">
          <span class="hits">6</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="628">
          <span class="hits">6</span>
          
          <code class="ruby">    @stack &lt;&lt; ( (a != 0 || b != 0) ? 1 : 0 )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="629">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="630">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby">  # a is added to b.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="632">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_add</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="633">
          <span class="hits">14</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="634">
          <span class="hits">14</span>
          
          <code class="ruby">    @stack &lt;&lt; a + b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="635">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="636">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="637">
          
          
          <code class="ruby">  # b is subtracted from a.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="638">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_sub</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="639">
          <span class="hits">5</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="640">
          <span class="hits">5</span>
          
          <code class="ruby">    @stack &lt;&lt; a - b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="641">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="642">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="643">
          
          
          <code class="ruby">  # Returns 1 if a is less than b, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="644">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_lessthan</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="645">
          <span class="hits">6</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="646">
          <span class="hits">6</span>
          
          <code class="ruby">    @stack &lt;&lt; (a &lt; b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="647">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="648">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="649">
          
          
          <code class="ruby">  # Returns 1 if a is less than or equal to b, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="650">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_lessthanorequal</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="651">
          <span class="hits">7</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="652">
          <span class="hits">7</span>
          
          <code class="ruby">    @stack &lt;&lt; (a &lt;= b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="653">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="654">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="655">
          
          
          <code class="ruby">  # Returns 1 if a is greater than b, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="656">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_greaterthan</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="657">
          <span class="hits">7</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="658">
          <span class="hits">7</span>
          
          <code class="ruby">    @stack &lt;&lt; (a &gt; b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="659">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="660">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="661">
          
          
          <code class="ruby">  # Returns 1 if a is greater than or equal to b, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="662">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_greaterthanorequal</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="663">
          <span class="hits">12</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="664">
          <span class="hits">12</span>
          
          <code class="ruby">    @stack &lt;&lt; (a &gt;= b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="665">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="666">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="667">
          
          
          <code class="ruby">  # If the input is 0 or 1, it is flipped. Otherwise the output will be 0.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="668">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_not</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="669">
          <span class="hits">4</span>
          
          <code class="ruby">    a = pop_int</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="670">
          <span class="hits">4</span>
          
          <code class="ruby">    @stack &lt;&lt; (a == 0 ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="671">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="672">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="673">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_0notequal</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="674">
          <span class="hits">5</span>
          
          <code class="ruby">    a = pop_int</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="675">
          <span class="hits">5</span>
          
          <code class="ruby">    @stack &lt;&lt; (a != 0 ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="676">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="677">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="678">
          
          
          <code class="ruby">  # The input is made positive.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="679">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_abs</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="680">
          <span class="hits">6</span>
          
          <code class="ruby">    a = pop_int</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="681">
          <span class="hits">6</span>
          
          <code class="ruby">    @stack &lt;&lt; a.abs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="682">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="683">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="684">
          
          
          <code class="ruby">  # The input is divided by 2. Currently disabled.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="685">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_2div</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="686">
          <span class="hits">3</span>
          
          <code class="ruby">    a = pop_int</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="687">
          <span class="hits">3</span>
          
          <code class="ruby">    @stack &lt;&lt; (a &gt;&gt; 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="688">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="689">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="690">
          
          
          <code class="ruby">  # The input is multiplied by 2. Currently disabled.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="691">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_2mul</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="692">
          <span class="hits">3</span>
          
          <code class="ruby">    a = pop_int</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="693">
          <span class="hits">3</span>
          
          <code class="ruby">    @stack &lt;&lt; (a &lt;&lt; 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="694">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="695">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="696">
          
          
          <code class="ruby">  # 1 is added to the input.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="697">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_1add</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="698">
          <span class="hits">3</span>
          
          <code class="ruby">    a = pop_int</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="699">
          <span class="hits">3</span>
          
          <code class="ruby">    @stack &lt;&lt; (a + 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="700">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="701">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="702">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_1sub</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="703">
          <span class="hits">4</span>
          
          <code class="ruby">    a = pop_int</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="704">
          <span class="hits">4</span>
          
          <code class="ruby">    @stack &lt;&lt; (a - 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="705">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="706">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="707">
          
          
          <code class="ruby">  # The sign of the input is flipped.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="708">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_negate</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="709">
          <span class="hits">7</span>
          
          <code class="ruby">    a = pop_int</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="710">
          <span class="hits">7</span>
          
          <code class="ruby">    @stack &lt;&lt; -a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="711">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="712">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="713">
          
          
          <code class="ruby">  # Removes the top stack item.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="714">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_drop</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="715">
          <span class="hits">13</span>
          
          <code class="ruby">    @stack.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="716">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="717">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="718">
          
          
          <code class="ruby">  # Returns 1 if the inputs are exactly equal, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="719">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_equal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="720">
          
          
          <code class="ruby">    #a, b = @stack.pop(2)</code>
        </li>
      
        <li class="covered" data-hits="114" data-linenumber="721">
          <span class="hits">114</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="114" data-linenumber="722">
          <span class="hits">114</span>
          
          <code class="ruby">    @stack &lt;&lt; (a == b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="723">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="724">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="725">
          
          
          <code class="ruby">  # Marks transaction as invalid if top stack value is not true. True is removed, but false is not.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="726">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_verify</code>
        </li>
      
        <li class="covered" data-hits="80" data-linenumber="727">
          <span class="hits">80</span>
          
          <code class="ruby">    res = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="80" data-linenumber="728">
          <span class="hits">80</span>
          
          <code class="ruby">    if res == 0</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="729">
          <span class="hits">4</span>
          
          <code class="ruby">      @stack &lt;&lt; res</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="730">
          <span class="hits">4</span>
          
          <code class="ruby">      @script_invalid = true # raise &#39;transaction invalid&#39; ?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="731">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="76" data-linenumber="732">
          <span class="hits">76</span>
          
          <code class="ruby">      @script_invalid = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="733">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="734">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="735">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="736">
          
          
          <code class="ruby">  # Same as OP_EQUAL, but runs OP_VERIFY afterward.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="737">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_equalverify</code>
        </li>
      
        <li class="covered" data-hits="76" data-linenumber="738">
          <span class="hits">76</span>
          
          <code class="ruby">    op_equal; op_verify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="739">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="740">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="741">
          
          
          <code class="ruby">  # An empty array of bytes is pushed onto the stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="742">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_0</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="743">
          <span class="hits">52</span>
          
          <code class="ruby">    @stack &lt;&lt; &quot;&quot; # []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="744">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="745">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="746">
          
          
          <code class="ruby">  # The number 1 is pushed onto the stack. Same as OP_TRUE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="747">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_1</code>
        </li>
      
        <li class="covered" data-hits="56" data-linenumber="748">
          <span class="hits">56</span>
          
          <code class="ruby">    @stack &lt;&lt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="749">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="750">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="751">
          
          
          <code class="ruby">  # Returns the smaller of a and b.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="752">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_min</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="753">
          <span class="hits">10</span>
          
          <code class="ruby">    @stack &lt;&lt; pop_int(2).min</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="754">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="755">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="756">
          
          
          <code class="ruby">  # Returns the larger of a and b.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="757">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_max</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="758">
          <span class="hits">8</span>
          
          <code class="ruby">    @stack &lt;&lt; pop_int(2).max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="759">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="760">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="761">
          
          
          <code class="ruby">  # Copies the pair of items two spaces back in the stack to the front.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="762">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_2over</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="763">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; @stack[-4]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="764">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; @stack[-4]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="765">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="766">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="767">
          
          
          <code class="ruby">  # Swaps the top two pairs of items.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="768">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_2swap</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="769">
          <span class="hits">1</span>
          
          <code class="ruby">    p1 = @stack.pop(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="770">
          <span class="hits">1</span>
          
          <code class="ruby">    p2 = @stack.pop(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="771">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack += p1 += p2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="772">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="773">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="774">
          
          
          <code class="ruby">  # If the input is true, duplicate it.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="775">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_ifdup</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="776">
          <span class="hits">4</span>
          
          <code class="ruby">    if cast_to_bignum(@stack.last) != 0</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="777">
          <span class="hits">2</span>
          
          <code class="ruby">      @stack &lt;&lt; @stack.last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="778">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="779">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="780">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="781">
          
          
          <code class="ruby">  # The number -1 is pushed onto the stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="782">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_1negate</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="783">
          <span class="hits">5</span>
          
          <code class="ruby">    @stack &lt;&lt; -1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="784">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="785">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="786">
          
          
          <code class="ruby">  # Puts the number of stack items onto the stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="787">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_depth</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="788">
          <span class="hits">6</span>
          
          <code class="ruby">    @stack &lt;&lt; @stack.size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="789">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="790">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="791">
          
          
          <code class="ruby">  # Returns 1 if x is within the specified range (left-inclusive), 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="792">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_within</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="793">
          <span class="hits">11</span>
          
          <code class="ruby">    bn1, bn2, bn3 = pop_int(3)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="794">
          <span class="hits">11</span>
          
          <code class="ruby">    @stack &lt;&lt; ( (bn2 &lt;= bn1 &amp;&amp; bn1 &lt; bn3) ? 1 : 0 )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="795">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="796">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="797">
          
          
          <code class="ruby">  # Returns 1 if the numbers are equal, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="798">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_numequal</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="799">
          <span class="hits">5</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="800">
          <span class="hits">5</span>
          
          <code class="ruby">    @stack &lt;&lt; (a == b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="801">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="802">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="803">
          
          
          <code class="ruby">  # Returns 1 if the numbers are not equal, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="804">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_numnotequal</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="805">
          <span class="hits">2</span>
          
          <code class="ruby">    a, b = pop_int(2)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="806">
          <span class="hits">2</span>
          
          <code class="ruby">    @stack &lt;&lt; (a != b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="807">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="808">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="809">
          
          
          <code class="ruby">  # Marks transaction as invalid.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="810">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="811">
          
          
          <code class="ruby">    @script_invalid = true; nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="812">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="813">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="814">
          
          
          <code class="ruby">  # Copies the second-to-top stack item to the top.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="815">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_over</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="816">
          <span class="hits">3</span>
          
          <code class="ruby">    item = @stack[-2]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="817">
          <span class="hits">3</span>
          
          <code class="ruby">    @stack &lt;&lt; item if item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="818">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="819">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="820">
          
          
          <code class="ruby">  # If the top stack value is not 0, the statements are executed. The top stack value is removed.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="821">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_if</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="822">
          <span class="hits">28</span>
          
          <code class="ruby">    value = false</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="823">
          <span class="hits">28</span>
          
          <code class="ruby">    if @do_exec</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="824">
          <span class="hits">21</span>
          
          <code class="ruby">      return if @stack.size &lt; 1</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="825">
          <span class="hits">21</span>
          
          <code class="ruby">      value = pop_int(1) == 1 ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="826">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="827">
          <span class="hits">28</span>
          
          <code class="ruby">    @exec_stack &lt;&lt; value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="828">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="829">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="830">
          
          
          <code class="ruby">  # If the top stack value is 0, the statements are executed. The top stack value is removed.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="831">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_notif</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="832">
          <span class="hits">5</span>
          
          <code class="ruby">    value = false</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="833">
          <span class="hits">5</span>
          
          <code class="ruby">    if @do_exec</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="834">
          <span class="hits">5</span>
          
          <code class="ruby">      return if @stack.size &lt; 1</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="835">
          <span class="hits">5</span>
          
          <code class="ruby">      value = pop_int(1) == 1 ? false : true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="836">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="837">
          <span class="hits">5</span>
          
          <code class="ruby">    @exec_stack &lt;&lt; value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="838">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="839">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="840">
          
          
          <code class="ruby">  # If the preceding OP_IF or OP_NOTIF or OP_ELSE was not executed then these statements are and if the preceding OP_IF or OP_NOTIF or OP_ELSE was executed then these statements are not.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="841">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_else</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="842">
          <span class="hits">24</span>
          
          <code class="ruby">    return if @exec_stack.empty?</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="843">
          <span class="hits">24</span>
          
          <code class="ruby">    @exec_stack[-1] = !@exec_stack[-1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="844">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="845">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="846">
          
          
          <code class="ruby">  # Ends an if/else block.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="847">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_endif</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="848">
          <span class="hits">33</span>
          
          <code class="ruby">    return if @exec_stack.empty?</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="849">
          <span class="hits">33</span>
          
          <code class="ruby">    @exec_stack.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="850">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="851">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="852">
          
          
          <code class="ruby">  # The item n back in the stack is copied to the top.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="853">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_pick</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="854">
          <span class="hits">2</span>
          
          <code class="ruby">    pos = pop_int(1)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="855">
          <span class="hits">2</span>
          
          <code class="ruby">    item = @stack[-(pos+1)]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="856">
          <span class="hits">2</span>
          
          <code class="ruby">    @stack &lt;&lt; item if item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="857">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="858">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="859">
          
          
          <code class="ruby">  # The item n back in the stack is moved to the top.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="860">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_roll</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="861">
          <span class="hits">2</span>
          
          <code class="ruby">    pos = pop_int(1)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="862">
          <span class="hits">2</span>
          
          <code class="ruby">    idx = -(pos+1)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="863">
          <span class="hits">2</span>
          
          <code class="ruby">    item = @stack[idx]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="864">
          <span class="hits">2</span>
          
          <code class="ruby">    if item</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="865">
          <span class="hits">2</span>
          
          <code class="ruby">      @stack.delete_at(idx)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="866">
          <span class="hits">2</span>
          
          <code class="ruby">      @stack &lt;&lt; item if item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="867">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="868">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="869">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="870">
          
          
          <code class="ruby">  # The top three items on the stack are rotated to the left.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="871">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_rot</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="872">
          <span class="hits">10</span>
          
          <code class="ruby">    return if @stack.size &lt; 3</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="873">
          <span class="hits">9</span>
          
          <code class="ruby">    @stack[-3..-1] = [ @stack[-2], @stack[-1], @stack[-3] ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="874">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="875">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="876">
          
          
          <code class="ruby">  # Removes the top two stack items.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="877">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_2drop</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="878">
          <span class="hits">6</span>
          
          <code class="ruby">    @stack.pop(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="879">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="880">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="881">
          
          
          <code class="ruby">  # Duplicates the top two stack items.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="882">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_2dup</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="883">
          <span class="hits">5</span>
          
          <code class="ruby">    @stack.push(*@stack[-2..-1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="884">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="885">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="886">
          
          
          <code class="ruby">  # Duplicates the top three stack items.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="887">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_3dup</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="888">
          <span class="hits">3</span>
          
          <code class="ruby">    @stack.push(*@stack[-3..-1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="889">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="890">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="891">
          
          
          <code class="ruby">  # Removes the second-to-top stack item.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="892">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nip</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="893">
          <span class="hits">2</span>
          
          <code class="ruby">    @stack.delete_at(-2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="894">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="895">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="896">
          
          
          <code class="ruby">  # Returns the length of the input string.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="897">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_size</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="898">
          <span class="hits">21</span>
          
          <code class="ruby">    item = @stack[-1]</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="899">
          <span class="hits">21</span>
          
          <code class="ruby">    size = case item</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="900">
          <span class="hits">2</span>
          
          <code class="ruby">           when String; item.bytesize</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="901">
          <span class="hits">19</span>
          
          <code class="ruby">           when Fixnum; OpenSSL::BN.new(item.to_s(16), 16).to_mpi.size - 4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="902">
          
          
          <code class="ruby">           end</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="903">
          <span class="hits">21</span>
          
          <code class="ruby">    @stack &lt;&lt; size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="904">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="905">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="906">
          
          
          <code class="ruby">  # Transaction is invalid unless occuring in an unexecuted OP_IF branch</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="907">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_ver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="908">
          
          
          <code class="ruby">    # skipped, not defined in origin script.cpp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="909">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="910">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="911">
          <span class="hits">1</span>
          
          <code class="ruby">  def pop_int(count=1)</code>
        </li>
      
        <li class="covered" data-hits="276" data-linenumber="912">
          <span class="hits">276</span>
          
          <code class="ruby">    return cast_to_bignum(@stack.pop) if count == 1</code>
        </li>
      
        <li class="covered" data-hits="644" data-linenumber="913">
          <span class="hits">644</span>
          
          <code class="ruby">    @stack.pop(count).map{|i| cast_to_bignum(i) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="914">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="915">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="916">
          <span class="hits">1</span>
          
          <code class="ruby">  def cast_to_bignum(buf)</code>
        </li>
      
        <li class="covered" data-hits="502" data-linenumber="917">
          <span class="hits">502</span>
          
          <code class="ruby">    case buf</code>
        </li>
      
        <li class="covered" data-hits="280" data-linenumber="918">
          <span class="hits">280</span>
          
          <code class="ruby">    when Fixnum; buf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="919">
          
          
          <code class="ruby">    #when String; buf.unpack(&quot;H*&quot;)[0].to_i(16)</code>
        </li>
      
        <li class="covered" data-hits="222" data-linenumber="920">
          <span class="hits">222</span>
          
          <code class="ruby">    when String; OpenSSL::BN.new([buf.bytesize].pack(&quot;N&quot;) + buf.reverse, 0).to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="921">
          
          
          <code class="ruby">    #when String; OpenSSL::BN.new(buf.unpack(&quot;H*&quot;)[0], 16).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="922">
          
          
          <code class="ruby">    else; raise &#39;cast_to_bignum: failed to cast: %s (%s)&#39; % [buf, buf.class]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="923">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="924">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="925">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="926">
          
          
          <code class="ruby">  # Same as OP_NUMEQUAL, but runs OP_VERIFY afterward.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="927">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_numequalverify</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="928">
          <span class="hits">2</span>
          
          <code class="ruby">    op_numequal; op_verify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="929">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="930">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="931">
          
          
          <code class="ruby">  # https://en.bitcoin.it/wiki/BIP_0017  (old OP_NOP2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="932">
          
          
          <code class="ruby">  # TODO: don&#39;t rely on it yet. add guards from wikipage too.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="933">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_checkhashverify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="934">
          
          
          <code class="ruby">    # unless @checkhash &amp;&amp; (@checkhash == @stack[-1].unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="935">
          
          
          <code class="ruby">    #  @script_invalid = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="936">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="937">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="938">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="939">
          
          
          <code class="ruby">  # All of the signature checking words will only match signatures</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="940">
          
          
          <code class="ruby">  # to the data after the most recently-executed OP_CODESEPARATOR.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="941">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_codeseparator</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="942">
          <span class="hits">2</span>
          
          <code class="ruby">    @codehash_start = @chunks.size - @chunks.reverse.index(OP_CODESEPARATOR)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="943">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="944">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="945">
          
          
          <code class="ruby">  # do a CHECKSIG operation on the current stack,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="946">
          
          
          <code class="ruby">  # asking +check_callback+ to do the actual signature verification.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="947">
          
          
          <code class="ruby">  # This is used by Protocol::Tx#verify_input_signature</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="948">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_checksig(check_callback)</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="949">
          <span class="hits">84</span>
          
          <code class="ruby">    return invalid if @stack.size &lt; 2</code>
        </li>
      
        <li class="covered" data-hits="83" data-linenumber="950">
          <span class="hits">83</span>
          
          <code class="ruby">    pubkey = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="83" data-linenumber="951">
          <span class="hits">83</span>
          
          <code class="ruby">    drop_sigs      = [@stack[-1].unpack(&quot;H*&quot;)[0]]</code>
        </li>
      
        <li class="covered" data-hits="83" data-linenumber="952">
          <span class="hits">83</span>
          
          <code class="ruby">    sig, hash_type = parse_sig(@stack.pop)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="953">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="83" data-linenumber="954">
          <span class="hits">83</span>
          
          <code class="ruby">    if @chunks.include?(OP_CHECKHASHVERIFY)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="955">
          
          
          <code class="ruby">      # Subset of script starting at the most recent codeseparator to OP_CHECKSIG</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="956">
          
          
          <code class="ruby">      script_code, @checkhash = codehash_script(OP_CHECKSIG)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="957">
          
          
          <code class="ruby">    elsif inner_p2sh?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="958">
          <span class="hits">3</span>
          
          <code class="ruby">      script_code = to_string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="959">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="80" data-linenumber="960">
          <span class="hits">80</span>
          
          <code class="ruby">      script_code, drop_sigs = nil, nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="961">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="962">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="83" data-linenumber="963">
          <span class="hits">83</span>
          
          <code class="ruby">    if check_callback == nil # for tests</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="964">
          <span class="hits">1</span>
          
          <code class="ruby">      @stack &lt;&lt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="965">
          
          
          <code class="ruby">    else # real signature check callback</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="966">
          
          
          <code class="ruby">      @stack &lt;&lt;</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="967">
          <span class="hits">82</span>
          
          <code class="ruby">        ((check_callback.call(pubkey, sig, hash_type, drop_sigs, script_code) == true) ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="968">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="969">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="970">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="971">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_checksigverify(check_callback)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="972">
          
          
          <code class="ruby">    op_checksig(check_callback)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="973">
          
          
          <code class="ruby">    op_verify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="974">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="975">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="976">
          
          
          <code class="ruby">  # do a CHECKMULTISIG operation on the current stack,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="977">
          
          
          <code class="ruby">  # asking +check_callback+ to do the actual signature verification.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="978">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="979">
          
          
          <code class="ruby">  # CHECKMULTISIG does a m-of-n signatures verification on scripts of the form:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="980">
          
          
          <code class="ruby">  #  0 &lt;sig1&gt; &lt;sig2&gt; | 2 &lt;pub1&gt; &lt;pub2&gt; 2 OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="981">
          
          
          <code class="ruby">  #  0 &lt;sig1&gt; &lt;sig2&gt; | 2 &lt;pub1&gt; &lt;pub2&gt; &lt;pub3&gt; 3 OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="982">
          
          
          <code class="ruby">  #  0 &lt;sig1&gt; &lt;sig2&gt; &lt;sig3&gt; | 3 &lt;pub1&gt; &lt;pub2&gt; &lt;pub3&gt; 3 OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="983">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="984">
          
          
          <code class="ruby">  # see https://en.bitcoin.it/wiki/BIP_0011 for details.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="985">
          
          
          <code class="ruby">  # see https://github.com/bitcoin/bitcoin/blob/master/src/script.cpp#L931</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="986">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="987">
          
          
          <code class="ruby">  # TODO: validate signature order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="988">
          
          
          <code class="ruby">  # TODO: take global opcode count</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="989">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_checkmultisig(check_callback)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="990">
          <span class="hits">24</span>
          
          <code class="ruby">    n_pubkeys = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="991">
          <span class="hits">24</span>
          
          <code class="ruby">    return invalid  unless (0..20).include?(n_pubkeys)</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="992">
          <span class="hits">77</span>
          
          <code class="ruby">    return invalid  unless @stack.last(n_pubkeys).all?{|e| e.is_a?(String) &amp;&amp; e != &#39;&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="993">
          
          
          <code class="ruby">    #return invalid  if ((@op_count ||= 0) += n_pubkeys) &gt; 201</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="994">
          <span class="hits">22</span>
          
          <code class="ruby">    pubkeys = @stack.pop(n_pubkeys)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="995">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="996">
          <span class="hits">22</span>
          
          <code class="ruby">    n_sigs = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="997">
          <span class="hits">22</span>
          
          <code class="ruby">    return invalid  unless (0..n_pubkeys).include?(n_sigs)</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="998">
          <span class="hits">51</span>
          
          <code class="ruby">    return invalid  unless @stack.last(n_sigs).all?{|e| e.is_a?(String) &amp;&amp; e != &#39;&#39; }</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="999">
          <span class="hits">51</span>
          
          <code class="ruby">    sigs = (drop_sigs = @stack.pop(n_sigs)).map{|s| parse_sig(s) }</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="1000">
          <span class="hits">51</span>
          
          <code class="ruby">    drop_sigs.map!{|i| i.unpack(&quot;H*&quot;)[0] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1001">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="1002">
          <span class="hits">18</span>
          
          <code class="ruby">    @stack.pop if @stack[-1] == &#39;&#39; # remove OP_NOP from stack</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1003">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="1004">
          <span class="hits">18</span>
          
          <code class="ruby">    if @chunks.include?(OP_CHECKHASHVERIFY)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1005">
          
          
          <code class="ruby">      # Subset of script starting at the most recent codeseparator to OP_CHECKMULTISIG</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="1006">
          <span class="hits">2</span>
          
          <code class="ruby">      script_code, @checkhash = codehash_script(OP_CHECKMULTISIG)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1007">
          
          
          <code class="ruby">    elsif inner_p2sh?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="1008">
          <span class="hits">4</span>
          
          <code class="ruby">      script_code = to_string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1009">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="1010">
          <span class="hits">12</span>
          
          <code class="ruby">      script_code, drop_sigs = nil, nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1011">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1012">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="1013">
          <span class="hits">18</span>
          
          <code class="ruby">    valid_sigs = 0</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="1014">
          <span class="hits">51</span>
          
          <code class="ruby">    sigs.each{|sig, hash_type| pubkeys.each{|pubkey|</code>
        </li>
      
        <li class="covered" data-hits="86" data-linenumber="1015">
          <span class="hits">86</span>
          
          <code class="ruby">        valid_sigs += 1  if check_callback.call(pubkey, sig, hash_type, drop_sigs, script_code)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1016">
          
          
          <code class="ruby">      }}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1017">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="1018">
          <span class="hits">18</span>
          
          <code class="ruby">    @stack &lt;&lt; ((valid_sigs &gt;= n_sigs) ? 1 : (invalid; 0))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1019">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1020">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1021">
          
          
          <code class="ruby">  # op_eval: https://en.bitcoin.it/wiki/BIP_0012</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1022">
          
          
          <code class="ruby">  #   the BIP was never accepted and must be handled as old OP_NOP1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1023">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1024">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1025">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1026">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES_METHOD = Hash[*instance_methods.grep(/^op_/).map{|m|</code>
        </li>
      
        <li class="covered" data-hits="3333" data-linenumber="1027">
          <span class="hits">3333</span>
          
          <code class="ruby">      [ (OPCODES.find{|k,v| v == m.to_s.upcase }.first rescue nil), m ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1028">
          
          
          <code class="ruby">    }.flatten]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1029">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES_METHOD[0]  = :op_0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1030">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES_METHOD[81] = :op_1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1031">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1032">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.is_canonical_pubkey?(pubkey)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1033">
          
          
          <code class="ruby">    return false if pubkey.bytesize &lt; 33 # &quot;Non-canonical public key: too short&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1034">
          
          
          <code class="ruby">    case pubkey[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1035">
          
          
          <code class="ruby">    when &quot;\x04&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1036">
          
          
          <code class="ruby">      return false if pubkey.bytesize != 65 # &quot;Non-canonical public key: invalid length for uncompressed key&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1037">
          
          
          <code class="ruby">    when &quot;\x02&quot;, &quot;\x03&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1038">
          
          
          <code class="ruby">      return false if pubkey.bytesize != 33 # &quot;Non-canonical public key: invalid length for compressed key&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1039">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1040">
          
          
          <code class="ruby">      return false # &quot;Non-canonical public key: compressed nor uncompressed&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1041">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1042">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1043">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1044">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1045">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1046">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1047">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_sig(sig)</code>
        </li>
      
        <li class="covered" data-hits="116" data-linenumber="1048">
          <span class="hits">116</span>
          
          <code class="ruby">    hash_type = sig[-1].unpack(&quot;C&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="116" data-linenumber="1049">
          <span class="hits">116</span>
          
          <code class="ruby">    sig = sig[0...-1]</code>
        </li>
      
        <li class="covered" data-hits="116" data-linenumber="1050">
          <span class="hits">116</span>
          
          <code class="ruby">    return sig, hash_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1051">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1052">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="029576e2a52c9778712ac74b945fbe9db0bb13e7">
  <div class="header">
    <h3>lib/bitcoin/storage/dummy/dummy_store.rb</h3>
    <h4><span class="red">25.74 %</span> covered</h4>
    <div>
      <b>101</b> relevant lines. 
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>75</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Backends</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class DummyStore &lt; StoreBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :blk, :tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize *args</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      reset</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      super(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      @blk, @tx = [], {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_block(blk)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      return false  unless blk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      if block = get_block(blk.hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        log.info { &quot;Block already stored; skipping&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      prev_block = get_block(blk.prev_block.reverse_hth)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      unless prev_block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        unless blk.hash == Bitcoin.network[:genesis_hash]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">          log.warn { &quot;INVALID BLOCK: #{blk.hash}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      blk.tx.each {|tx| store_tx(tx) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      @blk &lt;&lt; blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      log.info { &quot;NEW HEAD: #{blk.hash} DEPTH: #{get_depth}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      get_depth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      if @tx.keys.include?(tx.hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        log.info { &quot;Tx already stored; skipping&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        return tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      @tx[tx.hash] = tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_block(blk_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      !!get_block(blk_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      !!get_tx(tx_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_depth</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      @blk.size - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_head</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      wrap_block(@blk[-1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_depth(depth)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      wrap_block(@blk[depth])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_prev_hash(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      wrap_block(@blk.find {|blk| blk.prev_block == [hash].pack(&quot;H*&quot;).reverse})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block(blk_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      wrap_block(@blk.find {|blk| blk.hash == blk_hash})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_id(blk_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      wrap_block(@blk[blk_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">      wrap_block(@blk.find {|blk| blk.tx.map(&amp;:hash).include?(tx_hash) })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      transaction = @tx[tx_hash]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      return nil  unless transaction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      wrap_tx(transaction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx_by_id(tx_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      wrap_tx(@tx[tx_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txin_for_txout(tx_hash, txout_idx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      txin = @tx.values.map(&amp;:in).flatten.find {|i| i.prev_out_index == txout_idx &amp;&amp;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        i.prev_out == [tx_hash].pack(&quot;H*&quot;).reverse }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      wrap_txin(txin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_pk_script(script)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      txouts = @tx.values.map(&amp;:out).flatten.select {|o| o.pk_script == script}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      txouts.map {|o| wrap_txout(o) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_hash160(hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      @tx.values.map(&amp;:out).flatten.map {|o|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        o = wrap_txout(o)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        o.hash160 == hash160 ? o : nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      }.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_block(block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">      return nil  unless block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">      data = {:id =&gt; @blk.index(block), :depth =&gt; @blk.index(block)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">      blk = Bitcoin::Storage::Models::Block.new(self, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      [:ver, :prev_block, :mrkl_root, :time, :bits, :nonce].each do |attr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">        blk.send(&quot;#{attr}=&quot;, block.send(attr))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      block.tx.each do |tx|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">        blk.tx &lt;&lt; get_tx(tx.hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      blk.recalc_block_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_tx(transaction)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      return nil  unless transaction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      blk = @blk.find{|b| b.tx.include?(transaction)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      data = {:id =&gt; transaction.hash, :blk_id =&gt; @blk.index(blk)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      tx = Bitcoin::Storage::Models::Tx.new(self, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      tx.ver = transaction.ver</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      tx.lock_time = transaction.lock_time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      transaction.in.each {|i| tx.add_in(wrap_txin(i))}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      transaction.out.each {|o| tx.add_out(wrap_txout(o))}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">      tx.hash = tx.hash_from_payload(tx.to_payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">      tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txin(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">      return nil  unless input</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      tx = @tx.values.find{|t| t.in.include?(input)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      data = {:tx_id =&gt; tx.hash, :tx_idx =&gt; tx.in.index(input)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      txin = Bitcoin::Storage::Models::TxIn.new(self, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      [:prev_out, :prev_out_index, :script_sig_length, :script_sig, :sequence].each do |attr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">        txin.send(&quot;#{attr}=&quot;, input.send(attr))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txout(output)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      return nil  unless output</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      tx = @tx.values.find{|t| t.out.include?(output)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      data = {:tx_id =&gt; tx.hash, :tx_idx =&gt; tx.out.index(output),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">        :hash160 =&gt; Bitcoin::Script.new(output.pk_script).get_hash160 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      txout = Bitcoin::Storage::Models::TxOut.new(self, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      [:value, :pk_script_length, :pk_script].each do |attr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">        txout.send(&quot;#{attr}=&quot;, output.send(attr))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">      &quot;DummyStore&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a5b4193a8f28e1aea5ab2063c2b6e6b27fea99ad">
  <div class="header">
    <h3>lib/bitcoin/storage/models.rb</h3>
    <h4><span class="green">90.7 %</span> covered</h4>
    <div>
      <b>86</b> relevant lines. 
      <span class="green"><b>78</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># StorageModels defines objects that are returned from storage.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># These objects inherit from their Bitcoin::Protocol counterpart</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># and add some additional data and methods.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># * Bitcoin::Storage::Models::Block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># * Bitcoin::Storage::Models::Tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"># * Bitcoin::Storage::Models::TxIn</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"># * Bitcoin::Storage::Models::TxOut</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Models</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # Block retrieved from storage. (see Bitcoin::Protocol::Block)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  class Block &lt; Bitcoin::Protocol::Block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :ver, :prev_block, :mrkl_root, :time, :bits, :nonce, :tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :depth, :chain, :work</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="20">
          <span class="hits">1449</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="21">
          <span class="hits">1449</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="22">
          <span class="hits">1449</span>
          
          <code class="ruby">      @depth = data[:depth]</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="23">
          <span class="hits">1449</span>
          
          <code class="ruby">      @chain = data[:chain]</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="24">
          <span class="hits">1449</span>
          
          <code class="ruby">      @work = data[:work]</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="25">
          <span class="hits">1449</span>
          
          <code class="ruby">      @tx = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # get the block this one builds upon</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_prev_block</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="30">
          <span class="hits">17</span>
          
          <code class="ruby">      @store.get_block(@prev_block.reverse_hth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    # get the block that builds upon this one</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_next_block</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="35">
          <span class="hits">25</span>
          
          <code class="ruby">      @store.get_block_by_prev_hash(@hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  # Transaction retrieved from storage. (see Bitcoin::Protocol::Tx)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  class Tx &lt; Bitcoin::Protocol::Tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :ver, :lock_time, :hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :blk_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="47">
          <span class="hits">1595</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="48">
          <span class="hits">1595</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="49">
          <span class="hits">1595</span>
          
          <code class="ruby">      @blk_id = data[:blk_id]</code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="50">
          <span class="hits">1595</span>
          
          <code class="ruby">      super(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    # get the block this transaction is in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="55">
          <span class="hits">4</span>
          
          <code class="ruby">      return nil  unless @blk_id</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="56">
          <span class="hits">2</span>
          
          <code class="ruby">      @store.get_block_by_id(@blk_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    # get the number of blocks that confirm this tx in the main chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    def confirmations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      return 0  unless get_block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      @store.get_head.depth - get_block.depth + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  # Transaction input retrieved from storage. (see Bitcoin::Protocol::TxIn</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  class TxIn &lt; Bitcoin::Protocol::TxIn</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :tx_id, :tx_idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="72">
          <span class="hits">1628</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="73">
          <span class="hits">1628</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="74">
          <span class="hits">1628</span>
          
          <code class="ruby">      @tx_id = data[:tx_id]</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="75">
          <span class="hits">1628</span>
          
          <code class="ruby">      @tx_idx = data[:tx_idx]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    # get the transaction this input is in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="81">
          <span class="hits">4</span>
          
          <code class="ruby">      @store.get_tx_by_id(@tx_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    # get the previous output referenced by this input</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_prev_out</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">      prev_tx = @store.get_tx(@prev_out.reverse_hth)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">      return nil  unless prev_tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">      prev_tx.out[@prev_out_index]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  # Transaction output retrieved from storage. (see Bitcoin::Protocol::TxOut)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  class TxOut &lt; Bitcoin::Protocol::TxOut</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :tx_id, :tx_idx, :type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="99">
          <span class="hits">1657</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="100">
          <span class="hits">1657</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="101">
          <span class="hits">1657</span>
          
          <code class="ruby">      @tx_id = data[:tx_id]</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="102">
          <span class="hits">1657</span>
          
          <code class="ruby">      @tx_idx = data[:tx_idx]</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="103">
          <span class="hits">1657</span>
          
          <code class="ruby">      @type = data[:type]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">      script.get_hash160</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    # get the transaction this output is in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="112">
          <span class="hits">63</span>
          
          <code class="ruby">      @store.get_tx_by_id(@tx_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    # get the next input that references this output</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_next_in</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="117">
          <span class="hits">37</span>
          
          <code class="ruby">      @store.get_txin_for_txout(get_tx.hash, @tx_idx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    # get all addresses this txout corresponds to (if possible)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_address</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="122">
          <span class="hits">2</span>
          
          <code class="ruby">      script.get_address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    # get the single address this txout corresponds to (first for multisig tx)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_addresses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      script.get_addresses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_namecoin_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      @store.get_name_by_txout_id(@id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">    def type</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">      script.type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">    def script</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="139">
          <span class="hits">4</span>
          
          <code class="ruby">      @_script = Bitcoin::Script.new(@pk_script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">  class Name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :txout_id, :hash, :name, :value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="149">
          <span class="hits">2</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="150">
          <span class="hits">2</span>
          
          <code class="ruby">      @txout_id = data[:txout_id]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="151">
          <span class="hits">2</span>
          
          <code class="ruby">      @hash = data[:hash]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="152">
          <span class="hits">2</span>
          
          <code class="ruby">      @name = data[:name]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="153">
          <span class="hits">2</span>
          
          <code class="ruby">      @value = data[:value]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txout</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="157">
          <span class="hits">2</span>
          
          <code class="ruby">      @store.get_txout_by_id(@txout_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_address</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="161">
          <span class="hits">2</span>
          
          <code class="ruby">      get_txout.get_address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      get_txout.get_tx rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      get_tx.get_block rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">    def expires_in</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      12000 - (@store.get_depth - get_block.depth) rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_json(opts = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">      JSON.pretty_generate({ name: @name, value: @value, txid: get_tx.hash,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">          address: get_address, expires_in: expires_in }, opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f4cfbc683725977ffb9e47ff8ba1229a17889eca">
  <div class="header">
    <h3>lib/bitcoin/storage/sequel/migrations.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>64</b> relevant lines. 
      <span class="green"><b>64</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Backends::SequelMigrations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def migrate</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="6">
          <span class="hits">87</span>
          
          <code class="ruby">    binary = @db.adapter_scheme == :postgres ? :bytea : :blob</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="8">
          <span class="hits">87</span>
          
          <code class="ruby">    unless @db.tables.include?(:blk)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="9">
          <span class="hits">87</span>
          
          <code class="ruby">      @db.create_table :blk do</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="10">
          <span class="hits">87</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="11">
          <span class="hits">87</span>
          
          <code class="ruby">        column :hash, binary, :null =&gt; false, :unique =&gt; true, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="12">
          <span class="hits">87</span>
          
          <code class="ruby">        column :depth, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="13">
          <span class="hits">87</span>
          
          <code class="ruby">        column :version, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="14">
          <span class="hits">87</span>
          
          <code class="ruby">        column :prev_hash, binary, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="15">
          <span class="hits">87</span>
          
          <code class="ruby">        column :mrkl_root, binary, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="16">
          <span class="hits">87</span>
          
          <code class="ruby">        column :time, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="17">
          <span class="hits">87</span>
          
          <code class="ruby">        column :bits, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="18">
          <span class="hits">87</span>
          
          <code class="ruby">        column :nonce, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="19">
          <span class="hits">87</span>
          
          <code class="ruby">        column :blk_size, :int, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="20">
          <span class="hits">87</span>
          
          <code class="ruby">        column :chain, :int, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="21">
          <span class="hits">87</span>
          
          <code class="ruby">        column :work, binary, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="22">
          <span class="hits">87</span>
          
          <code class="ruby">        column :aux_pow, binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="26">
          <span class="hits">87</span>
          
          <code class="ruby">    unless @db.tables.include?(:tx)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="27">
          <span class="hits">87</span>
          
          <code class="ruby">      @db.create_table :tx do</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="28">
          <span class="hits">87</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="29">
          <span class="hits">87</span>
          
          <code class="ruby">        column :hash, binary, :null =&gt; false, :unique =&gt; true, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="30">
          <span class="hits">87</span>
          
          <code class="ruby">        column :version, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="31">
          <span class="hits">87</span>
          
          <code class="ruby">        column :lock_time, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="32">
          <span class="hits">87</span>
          
          <code class="ruby">        column :coinbase, :bool, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="33">
          <span class="hits">87</span>
          
          <code class="ruby">        column :tx_size, :int, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="37">
          <span class="hits">87</span>
          
          <code class="ruby">    unless @db.tables.include?(:blk_tx)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="38">
          <span class="hits">87</span>
          
          <code class="ruby">      @db.create_table :blk_tx do</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="39">
          <span class="hits">87</span>
          
          <code class="ruby">        column :blk_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="40">
          <span class="hits">87</span>
          
          <code class="ruby">        column :tx_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="41">
          <span class="hits">87</span>
          
          <code class="ruby">        column :idx, :int, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="45">
          <span class="hits">87</span>
          
          <code class="ruby">    unless @db.tables.include?(:txin)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="46">
          <span class="hits">87</span>
          
          <code class="ruby">      @db.create_table :txin do</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="47">
          <span class="hits">87</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="48">
          <span class="hits">87</span>
          
          <code class="ruby">        column :tx_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="49">
          <span class="hits">87</span>
          
          <code class="ruby">        column :tx_idx, :int, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="50">
          <span class="hits">87</span>
          
          <code class="ruby">        column :script_sig, binary, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="51">
          <span class="hits">87</span>
          
          <code class="ruby">        column :prev_out, binary, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="52">
          <span class="hits">87</span>
          
          <code class="ruby">        column :prev_out_index, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="53">
          <span class="hits">87</span>
          
          <code class="ruby">        column :sequence, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="57">
          <span class="hits">87</span>
          
          <code class="ruby">    unless @db.tables.include?(:txout)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="58">
          <span class="hits">87</span>
          
          <code class="ruby">      @db.create_table :txout do</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="59">
          <span class="hits">87</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="60">
          <span class="hits">87</span>
          
          <code class="ruby">        column :tx_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="61">
          <span class="hits">87</span>
          
          <code class="ruby">        column :tx_idx, :int, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="62">
          <span class="hits">87</span>
          
          <code class="ruby">        column :pk_script, binary, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="63">
          <span class="hits">87</span>
          
          <code class="ruby">        column :value, :bigint</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="64">
          <span class="hits">87</span>
          
          <code class="ruby">        column :type, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="68">
          <span class="hits">87</span>
          
          <code class="ruby">    unless @db.tables.include?(:addr)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="69">
          <span class="hits">87</span>
          
          <code class="ruby">      @db.create_table :addr do</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="70">
          <span class="hits">87</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="71">
          <span class="hits">87</span>
          
          <code class="ruby">        column :hash160, String, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="75">
          <span class="hits">87</span>
          
          <code class="ruby">    unless @db.tables.include?(:addr_txout)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="76">
          <span class="hits">87</span>
          
          <code class="ruby">      @db.create_table :addr_txout do</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="77">
          <span class="hits">87</span>
          
          <code class="ruby">        column :addr_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="78">
          <span class="hits">87</span>
          
          <code class="ruby">        column :txout_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="82">
          <span class="hits">87</span>
          
          <code class="ruby">    unless @db.views.include?(:unconfirmed)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="83">
          <span class="hits">87</span>
          
          <code class="ruby">      @db.create_view(:unconfirmed,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        &quot;SELECT * FROM tx WHERE NOT EXISTS &quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        &quot;(SELECT 1 FROM blk_tx WHERE blk_tx.tx_id = tx.id)&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        &quot;ORDER BY tx.id DESC&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="89">
          <span class="hits">87</span>
          
          <code class="ruby">    unless @db.tables.include?(:names)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="90">
          <span class="hits">87</span>
          
          <code class="ruby">      @db.create_table :names do</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="91">
          <span class="hits">87</span>
          
          <code class="ruby">        column :txout_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="92">
          <span class="hits">87</span>
          
          <code class="ruby">        column :hash, binary, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="93">
          <span class="hits">87</span>
          
          <code class="ruby">        column :name, binary, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="94">
          <span class="hits">87</span>
          
          <code class="ruby">        column :value, binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ff9aba8fbeb1f6439118795d4ee25ca3db6c62bc">
  <div class="header">
    <h3>lib/bitcoin/storage/sequel/sequel_store.rb</h3>
    <h4><span class="green">90.67 %</span> covered</h4>
    <div>
      <b>268</b> relevant lines. 
      <span class="green"><b>243</b> lines covered</span> and
      <span class="red"><b>25</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">Bitcoin.require_dependency :sequel, message:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  &quot;Note: You will also need an adapter for your database like sqlite3, mysql2, postgresql&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;migrations&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Backends</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # Storage backend using Sequel to connect to arbitrary SQL databases.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Inherits from StoreBase and implements its interface.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  class SequelStore &lt; StoreBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    Sequel.extension(:core_extensions, :sequel_3_dataset_methods)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # possible script types</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    SCRIPT_TYPES = [:unknown, :pubkey, :hash160, :multisig, :p2sh]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    if Bitcoin.namecoin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      [:name_new, :name_firstupdate, :name_update].each {|n| SCRIPT_TYPES &lt;&lt; n }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # name_new must have 12 confirmations before corresponding name_firstupdate is valid.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    NAMECOIN_FIRSTUPDATE_LIMIT = 12</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    # sequel database connection</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :db</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    include Bitcoin::Storage::Backends::SequelMigrations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    DEFAULT_CONFIG = { mode: :full, cache_head: false }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    # create sequel store with given +config+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize config, *args</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="33">
          <span class="hits">87</span>
          
          <code class="ruby">      @config = DEFAULT_CONFIG.merge(config)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="34">
          <span class="hits">87</span>
          
          <code class="ruby">      super config, *args</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="35">
          <span class="hits">87</span>
          
          <code class="ruby">      connect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # connect to database</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      {:sqlite =&gt; &quot;sqlite3&quot;, :postgres =&gt; &quot;pg&quot;, :mysql =&gt; &quot;mysql&quot;,</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="41">
          <span class="hits">87</span>
          
          <code class="ruby">      }.each do |adapter, name|</code>
        </li>
      
        <li class="covered" data-hits="261" data-linenumber="42">
          <span class="hits">261</span>
          
          <code class="ruby">        if @config[:db].split(&quot;:&quot;).first == adapter.to_s</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="43">
          <span class="hits">87</span>
          
          <code class="ruby">          Bitcoin.require_dependency name, gem: name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="46">
          <span class="hits">87</span>
          
          <code class="ruby">      @db = Sequel.connect(@config[:db].sub(&quot;~&quot;, ENV[&quot;HOME&quot;]))</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="47">
          <span class="hits">87</span>
          
          <code class="ruby">      @db.extend_datasets(Sequel::Sequel3DatasetMethods)</code>
        </li>
      
        <li class="covered" data-hits="88" data-linenumber="48">
          <span class="hits">88</span>
          
          <code class="ruby">      log.info { &quot;opened database #{@db.uri}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="49">
          <span class="hits">87</span>
          
          <code class="ruby">      migrate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    # reset database; delete all data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset</code>
        </li>
      
        <li class="covered" data-hits="621" data-linenumber="54">
          <span class="hits">621</span>
          
          <code class="ruby">      [:blk, :blk_tx, :tx, :txin, :txout, :addr, :addr_txout, :names].each {|table| @db[table].delete}</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="55">
          <span class="hits">69</span>
          
          <code class="ruby">      @head = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    # persist given block +blk+ to storage.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    def persist_block blk, chain, depth, prev_work = 0</code>
        </li>
      
        <li class="covered" data-hits="487" data-linenumber="60">
          <span class="hits">487</span>
          
          <code class="ruby">      @db.transaction do</code>
        </li>
      
        <li class="covered" data-hits="487" data-linenumber="61">
          <span class="hits">487</span>
          
          <code class="ruby">        attrs = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">          :hash =&gt; blk.hash.htb.blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">          :depth =&gt; depth,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">          :chain =&gt; chain,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          :version =&gt; blk.ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">          :prev_hash =&gt; blk.prev_block.reverse.blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">          :mrkl_root =&gt; blk.mrkl_root.reverse.blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">          :time =&gt; blk.time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">          :bits =&gt; blk.bits,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          :nonce =&gt; blk.nonce,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">          :blk_size =&gt; blk.to_payload.bytesize,</code>
        </li>
      
        <li class="covered" data-hits="487" data-linenumber="72">
          <span class="hits">487</span>
          
          <code class="ruby">          :work =&gt; (prev_work + blk.block_work).to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="487" data-linenumber="74">
          <span class="hits">487</span>
          
          <code class="ruby">        attrs[:aux_pow] = blk.aux_pow.to_payload.blob  if blk.aux_pow</code>
        </li>
      
        <li class="covered" data-hits="487" data-linenumber="75">
          <span class="hits">487</span>
          
          <code class="ruby">        existing = @db[:blk].filter(:hash =&gt; blk.hash.htb.blob)</code>
        </li>
      
        <li class="covered" data-hits="487" data-linenumber="76">
          <span class="hits">487</span>
          
          <code class="ruby">        if existing.any?</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="77">
          <span class="hits">65</span>
          
          <code class="ruby">          existing.update attrs</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="78">
          <span class="hits">65</span>
          
          <code class="ruby">          block_id = existing.first[:id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="80">
          <span class="hits">422</span>
          
          <code class="ruby">          block_id = @db[:blk].insert(attrs)</code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="81">
          <span class="hits">422</span>
          
          <code class="ruby">          blk_tx, new_tx, addrs, names = [], [], [], []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">          # store tx</code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="84">
          <span class="hits">422</span>
          
          <code class="ruby">          blk.tx.each.with_index do |tx, idx|</code>
        </li>
      
        <li class="covered" data-hits="439" data-linenumber="85">
          <span class="hits">439</span>
          
          <code class="ruby">            existing = @db[:tx][hash: tx.hash.htb.blob]</code>
        </li>
      
        <li class="covered" data-hits="439" data-linenumber="86">
          <span class="hits">439</span>
          
          <code class="ruby">            existing ? blk_tx[idx] = existing[:id] : new_tx &lt;&lt; [tx, idx]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="859" data-linenumber="88">
          <span class="hits">859</span>
          
          <code class="ruby">          new_tx_ids = @db[:tx].insert_multiple(new_tx.map {|tx, _| tx_data(tx) })</code>
        </li>
      
        <li class="covered" data-hits="859" data-linenumber="89">
          <span class="hits">859</span>
          
          <code class="ruby">          new_tx_ids.each.with_index {|tx_id, idx| blk_tx[new_tx[idx][1]] = tx_id }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="91">
          <span class="hits">422</span>
          
          <code class="ruby">          @db[:blk_tx].insert_multiple(blk_tx.map.with_index {|id, idx|</code>
        </li>
      
        <li class="covered" data-hits="439" data-linenumber="92">
          <span class="hits">439</span>
          
          <code class="ruby">            { blk_id: block_id, tx_id: id, idx: idx } })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">          # store txins</code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="95">
          <span class="hits">422</span>
          
          <code class="ruby">          txin_ids = @db[:txin].insert_multiple(new_tx.map.with_index {|tx, tx_idx|</code>
        </li>
      
        <li class="covered" data-hits="437" data-linenumber="96">
          <span class="hits">437</span>
          
          <code class="ruby">            tx, _ = *tx</code>
        </li>
      
        <li class="covered" data-hits="437" data-linenumber="97">
          <span class="hits">437</span>
          
          <code class="ruby">            tx.in.map.with_index {|txin, txin_idx|</code>
        </li>
      
        <li class="covered" data-hits="437" data-linenumber="98">
          <span class="hits">437</span>
          
          <code class="ruby">              txin_data(new_tx_ids[tx_idx], txin, txin_idx) } }.flatten)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">          # store txouts</code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="101">
          <span class="hits">422</span>
          
          <code class="ruby">          txout_i = 0</code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="102">
          <span class="hits">422</span>
          
          <code class="ruby">          txout_ids = @db[:txout].insert_multiple(new_tx.map.with_index {|tx, tx_idx|</code>
        </li>
      
        <li class="covered" data-hits="437" data-linenumber="103">
          <span class="hits">437</span>
          
          <code class="ruby">            tx, _ = *tx</code>
        </li>
      
        <li class="covered" data-hits="437" data-linenumber="104">
          <span class="hits">437</span>
          
          <code class="ruby">            tx.out.map.with_index {|txout, txout_idx|</code>
        </li>
      
        <li class="covered" data-hits="438" data-linenumber="105">
          <span class="hits">438</span>
          
          <code class="ruby">              script_type, a, n = *parse_script(txout, txout_i)</code>
        </li>
      
        <li class="covered" data-hits="438" data-linenumber="106">
          <span class="hits">438</span>
          
          <code class="ruby">              addrs += a; names += n; txout_i += 1</code>
        </li>
      
        <li class="covered" data-hits="438" data-linenumber="107">
          <span class="hits">438</span>
          
          <code class="ruby">              txout_data(new_tx_ids[tx_idx], txout, txout_idx, script_type) } }.flatten)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          # store addrs</code>
        </li>
      
        <li class="covered" data-hits="860" data-linenumber="110">
          <span class="hits">860</span>
          
          <code class="ruby">          persist_addrs addrs.map {|i, h| [txout_ids[i], h]}</code>
        </li>
      
        <li class="covered" data-hits="426" data-linenumber="111">
          <span class="hits">426</span>
          
          <code class="ruby">          names.each {|i, script| store_name(script, txout_ids[i]) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="487" data-linenumber="113">
          <span class="hits">487</span>
          
          <code class="ruby">        @head = wrap_block(attrs.merge(id: block_id))  if chain == MAIN</code>
        </li>
      
        <li class="covered" data-hits="487" data-linenumber="114">
          <span class="hits">487</span>
          
          <code class="ruby">        @db[:blk].where(:prev_hash =&gt; blk.hash.htb.blob, :chain =&gt; ORPHAN).each do |b|</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="115">
          <span class="hits">65</span>
          
          <code class="ruby">          log.debug { &quot;connecting orphan #{b[:hash].hth}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="116">
          <span class="hits">65</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="117">
          <span class="hits">65</span>
          
          <code class="ruby">            store_block(get_block(b[:hash].hth))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">          rescue SystemStackError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">            EM.defer { store_block(get_block(b[:hash].hth)) }  if EM.reactor_running?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="487" data-linenumber="122">
          <span class="hits">487</span>
          
          <code class="ruby">        return depth, chain</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    # update +attrs+ for block with given +hash+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    def update_blocks updates</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="128">
          <span class="hits">11</span>
          
          <code class="ruby">      @db.transaction do</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="129">
          <span class="hits">11</span>
          
          <code class="ruby">        updates.each do |blocks, attrs|</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="130">
          <span class="hits">42</span>
          
          <code class="ruby">          @db[:blk].filter(:hash =&gt; blocks.map{|h| h.htb.blob}).update(attrs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">    # parse script and collect address/txout mappings to index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_script txout, i</code>
        </li>
      
        <li class="covered" data-hits="607" data-linenumber="137">
          <span class="hits">607</span>
          
          <code class="ruby">      addrs, names = [], []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      # skip huge script in testnet3 block 54507 (998000 bytes)</code>
        </li>
      
        <li class="covered" data-hits="607" data-linenumber="139">
          <span class="hits">607</span>
          
          <code class="ruby">      return [SCRIPT_TYPES.index(:unknown), [], []]  if txout.pk_script.bytesize &gt; 10_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="607" data-linenumber="141">
          <span class="hits">607</span>
          
          <code class="ruby">      script = Bitcoin::Script.new(txout.pk_script) rescue nil</code>
        </li>
      
        <li class="covered" data-hits="607" data-linenumber="142">
          <span class="hits">607</span>
          
          <code class="ruby">      if script</code>
        </li>
      
        <li class="covered" data-hits="607" data-linenumber="143">
          <span class="hits">607</span>
          
          <code class="ruby">        if script.is_hash160? || script.is_pubkey?</code>
        </li>
      
        <li class="covered" data-hits="602" data-linenumber="144">
          <span class="hits">602</span>
          
          <code class="ruby">          addrs &lt;&lt; [i, script.get_hash160]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">        elsif script.is_multisig?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">          script.get_multisig_pubkeys.map do |pubkey|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="147">
          <span class="hits">2</span>
          
          <code class="ruby">            addrs &lt;&lt; [i, Bitcoin.hash160(pubkey.unpack(&quot;H*&quot;)[0])]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">        elsif Bitcoin.namecoin? &amp;&amp; script.is_namecoin?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="150">
          <span class="hits">4</span>
          
          <code class="ruby">          addrs &lt;&lt; [i, script.get_hash160]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="151">
          <span class="hits">4</span>
          
          <code class="ruby">          names &lt;&lt; [i, script]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">          log.warn { &quot;Unknown script type&quot;}# #{tx.hash}:#{txout_idx}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="607" data-linenumber="155">
          <span class="hits">607</span>
          
          <code class="ruby">        script_type = SCRIPT_TYPES.index(script.type)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">        log.error { &quot;Error parsing script&quot;}# #{tx.hash}:#{txout_idx}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">        script_type = SCRIPT_TYPES.index(:unknown)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="607" data-linenumber="160">
          <span class="hits">607</span>
          
          <code class="ruby">      [script_type, addrs, names]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    # bulk-store addresses and txout mappings</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    def persist_addrs addrs</code>
        </li>
      
        <li class="covered" data-hits="591" data-linenumber="165">
          <span class="hits">591</span>
          
          <code class="ruby">      addr_txouts, new_addrs = [], []</code>
        </li>
      
        <li class="covered" data-hits="1199" data-linenumber="166">
          <span class="hits">1199</span>
          
          <code class="ruby">      addrs.group_by {|_, a| a }.each do |hash160, txouts|</code>
        </li>
      
        <li class="covered" data-hits="596" data-linenumber="167">
          <span class="hits">596</span>
          
          <code class="ruby">        if existing = @db[:addr][:hash160 =&gt; hash160]</code>
        </li>
      
        <li class="covered" data-hits="358" data-linenumber="168">
          <span class="hits">358</span>
          
          <code class="ruby">          txouts.each {|id, _| addr_txouts &lt;&lt; [existing[:id], id] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="846" data-linenumber="170">
          <span class="hits">846</span>
          
          <code class="ruby">          new_addrs &lt;&lt; [hash160, txouts.map {|id, _| id }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="591" data-linenumber="173">
          <span class="hits">591</span>
          
          <code class="ruby">      new_addr_ids = @db[:addr].insert_multiple(new_addrs.map {|hash160, txout_id|</code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="174">
          <span class="hits">422</span>
          
          <code class="ruby">        { hash160: hash160 } })</code>
        </li>
      
        <li class="covered" data-hits="591" data-linenumber="175">
          <span class="hits">591</span>
          
          <code class="ruby">      new_addr_ids.each.with_index do |addr_id, idx|</code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="176">
          <span class="hits">422</span>
          
          <code class="ruby">        new_addrs[idx][1].each do |txout_id|</code>
        </li>
      
        <li class="covered" data-hits="424" data-linenumber="177">
          <span class="hits">424</span>
          
          <code class="ruby">          addr_txouts &lt;&lt; [addr_id, txout_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="591" data-linenumber="180">
          <span class="hits">591</span>
          
          <code class="ruby">      @db[:addr_txout].insert_multiple(addr_txouts.map {|addr_id, txout_id|</code>
        </li>
      
        <li class="covered" data-hits="608" data-linenumber="181">
          <span class="hits">608</span>
          
          <code class="ruby">        { addr_id: addr_id, txout_id: txout_id }})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">    # prepare transaction data for storage</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">    def tx_data tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">      { hash: tx.hash.htb.blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">        version: tx.ver, lock_time: tx.lock_time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">        coinbase: tx.in.size == 1 &amp;&amp; tx.in[0].coinbase?,</code>
        </li>
      
        <li class="covered" data-hits="522" data-linenumber="189">
          <span class="hits">522</span>
          
          <code class="ruby">        tx_size: tx.payload.bytesize }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">    # store transaction +tx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_tx(tx, validate = true)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="194">
          <span class="hits">87</span>
          
          <code class="ruby">      @log.debug { &quot;Storing tx #{tx.hash} (#{tx.to_payload.bytesize} bytes)&quot; }</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="195">
          <span class="hits">87</span>
          
          <code class="ruby">      tx.validator(self).validate(raise_errors: true)  if validate</code>
        </li>
      
        <li class="covered" data-hits="86" data-linenumber="196">
          <span class="hits">86</span>
          
          <code class="ruby">      @db.transaction do</code>
        </li>
      
        <li class="covered" data-hits="86" data-linenumber="197">
          <span class="hits">86</span>
          
          <code class="ruby">        transaction = @db[:tx][:hash =&gt; tx.hash.htb.blob]</code>
        </li>
      
        <li class="covered" data-hits="86" data-linenumber="198">
          <span class="hits">86</span>
          
          <code class="ruby">        return transaction[:id]  if transaction</code>
        </li>
      
        <li class="covered" data-hits="85" data-linenumber="199">
          <span class="hits">85</span>
          
          <code class="ruby">        tx_id = @db[:tx].insert(tx_data(tx))</code>
        </li>
      
        <li class="covered" data-hits="203" data-linenumber="200">
          <span class="hits">203</span>
          
          <code class="ruby">        tx.in.each_with_index {|i, idx| store_txin(tx_id, i, idx)}</code>
        </li>
      
        <li class="covered" data-hits="253" data-linenumber="201">
          <span class="hits">253</span>
          
          <code class="ruby">        tx.out.each_with_index {|o, idx| store_txout(tx_id, o, idx)}</code>
        </li>
      
        <li class="covered" data-hits="85" data-linenumber="202">
          <span class="hits">85</span>
          
          <code class="ruby">        tx_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">    # prepare txin data for storage</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">    def txin_data tx_id, txin, idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">      { tx_id: tx_id, tx_idx: idx,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">        script_sig: txin.script_sig.blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">        prev_out: txin.prev_out.blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        prev_out_index: txin.prev_out_index,</code>
        </li>
      
        <li class="covered" data-hits="555" data-linenumber="212">
          <span class="hits">555</span>
          
          <code class="ruby">        sequence: txin.sequence.unpack(&quot;V&quot;)[0] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">    # store input +txin+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_txin(tx_id, txin, idx)</code>
        </li>
      
        <li class="covered" data-hits="118" data-linenumber="217">
          <span class="hits">118</span>
          
          <code class="ruby">      @db[:txin].insert(txin_data(tx_id, txin, idx))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    # prepare txout data for storage</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">    def txout_data tx_id, txout, idx, script_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      { tx_id: tx_id, tx_idx: idx,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">        pk_script: txout.pk_script.blob,</code>
        </li>
      
        <li class="covered" data-hits="607" data-linenumber="224">
          <span class="hits">607</span>
          
          <code class="ruby">        value: txout.value, type: script_type }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">    # store output +txout+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_txout(tx_id, txout, idx)</code>
        </li>
      
        <li class="covered" data-hits="169" data-linenumber="229">
          <span class="hits">169</span>
          
          <code class="ruby">      script_type, addrs, names = *parse_script(txout, idx)</code>
        </li>
      
        <li class="covered" data-hits="169" data-linenumber="230">
          <span class="hits">169</span>
          
          <code class="ruby">      txout_id = @db[:txout].insert(txout_data(tx_id, txout, idx, script_type))</code>
        </li>
      
        <li class="covered" data-hits="339" data-linenumber="231">
          <span class="hits">339</span>
          
          <code class="ruby">      persist_addrs addrs.map {|i, h| [txout_id, h] }</code>
        </li>
      
        <li class="covered" data-hits="169" data-linenumber="232">
          <span class="hits">169</span>
          
          <code class="ruby">      names.each {|i, script| store_name(script, txout_id) }</code>
        </li>
      
        <li class="covered" data-hits="169" data-linenumber="233">
          <span class="hits">169</span>
          
          <code class="ruby">      txout_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">    # store address +hash160+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_addr(txout_id, hash160)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">      addr = @db[:addr][:hash160 =&gt; hash160]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">      addr_id = addr[:id]  if addr</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">      addr_id ||= @db[:addr].insert({:hash160 =&gt; hash160})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">      @db[:addr_txout].insert({:addr_id =&gt; addr_id, :txout_id =&gt; txout_id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">    # if this is a namecoin script, update the names index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="245">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_name(script, txout_id)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="246">
          <span class="hits">4</span>
          
          <code class="ruby">      if script.type == :name_new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">        log.info { &quot;name_new #{script.get_namecoin_hash}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="248">
          <span class="hits">1</span>
          
          <code class="ruby">        @db[:names].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">            :txout_id =&gt; txout_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">            :hash =&gt; script.get_namecoin_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="253">
          <span class="hits">3</span>
          
          <code class="ruby">      elsif script.type == :name_firstupdate</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="254">
          <span class="hits">2</span>
          
          <code class="ruby">        name_hash = script.get_namecoin_hash</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="255">
          <span class="hits">2</span>
          
          <code class="ruby">        name_new = @db[:names].where(:hash =&gt; name_hash).order(:txout_id).first</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="256">
          <span class="hits">2</span>
          
          <code class="ruby">        txout = @db[:txout][id: name_new[:txout_id]] if name_new</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="257">
          <span class="hits">2</span>
          
          <code class="ruby">        tx = @db[:tx][id: txout[:tx_id]] if txout</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="258">
          <span class="hits">2</span>
          
          <code class="ruby">        blk_tx = @db[:blk_tx][tx_id: tx[:id]]  if tx</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="259">
          <span class="hits">2</span>
          
          <code class="ruby">        blk = @db[:blk][id: blk_tx[:blk_id]] if blk_tx</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="260">
          <span class="hits">2</span>
          
          <code class="ruby">        unless name_new &amp;&amp; blk &amp;&amp; blk[:chain] == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">          log.warn { &quot;name_new not found: #{name_hash}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">          return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="264">
          <span class="hits">2</span>
          
          <code class="ruby">        unless blk[:depth] &lt;= get_depth - NAMECOIN_FIRSTUPDATE_LIMIT</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="265">
          <span class="hits">1</span>
          
          <code class="ruby">          log.warn { &quot;name_new not yet valid: #{name_hash}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">          return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="269">
          <span class="hits">1</span>
          
          <code class="ruby">        log.info { &quot;#{script.type}: #{script.get_namecoin_name}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="270">
          <span class="hits">1</span>
          
          <code class="ruby">        @db[:names].where(:txout_id =&gt; name_new[:txout_id], :name =&gt; nil).update({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">            :name =&gt; script.get_namecoin_name.to_s.blob })</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="272">
          <span class="hits">1</span>
          
          <code class="ruby">        @db[:names].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">            :txout_id =&gt; txout_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">            :hash =&gt; name_hash,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">            :name =&gt; script.get_namecoin_name.to_s.blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">            :value =&gt; script.get_namecoin_value.to_s.blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="278">
          <span class="hits">1</span>
          
          <code class="ruby">      elsif script.type == :name_update</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="279">
          <span class="hits">1</span>
          
          <code class="ruby">        log.info { &quot;#{script.type}: #{script.get_namecoin_name}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="280">
          <span class="hits">1</span>
          
          <code class="ruby">        @db[:names].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">            :txout_id =&gt; txout_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">            :name =&gt; script.get_namecoin_name.to_s.blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">            :value =&gt; script.get_namecoin_value.to_s.blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">    # delete transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">    # TODO: also delete blk_tx mapping</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="290">
          <span class="hits">1</span>
          
          <code class="ruby">    def delete_tx(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">      log.debug { &quot;Deleting tx #{hash} since all its outputs are spent&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">      @db.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">        tx = get_tx(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">        tx.in.each {|i| @db[:txin].where(:id =&gt; i.id).delete }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">        tx.out.each {|o| @db[:txout].where(:id =&gt; o.id).delete }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">        @db[:tx].where(:id =&gt; tx.id).delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">    # check if block +blk_hash+ exists</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="301">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_block(blk_hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="302">
          <span class="hits">2</span>
          
          <code class="ruby">      !!@db[:blk].where(:hash =&gt; blk_hash.htb.blob).get(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">    # check if transaction +tx_hash+ exists</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="306">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="307">
          <span class="hits">2</span>
          
          <code class="ruby">      !!@db[:tx].where(:hash =&gt; tx_hash.htb.blob).get(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">    # get head block (highest block from the MAIN chain)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="311">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_head</code>
        </li>
      
        <li class="covered" data-hits="446" data-linenumber="312">
          <span class="hits">446</span>
          
          <code class="ruby">      (@config[:cache_head] &amp;&amp; @head) ? @head :</code>
        </li>
      
        <li class="covered" data-hits="446" data-linenumber="313">
          <span class="hits">446</span>
          
          <code class="ruby">        @head = wrap_block(@db[:blk].filter(:chain =&gt; MAIN).order(:depth).last)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="316">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_head_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">      (@config[:cache_head] &amp;&amp; @head) ? @head.hash :</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">        @head = @db[:blk].filter(:chain =&gt; MAIN).order(:depth).last[:hash].hth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">    # get depth of MAIN chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_depth</code>
        </li>
      
        <li class="covered" data-hits="648" data-linenumber="323">
          <span class="hits">648</span>
          
          <code class="ruby">      depth = (@config[:cache_head] &amp;&amp; @head) ? @head.depth :</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">        @depth = @db[:blk].filter(:chain =&gt; MAIN).order(:depth).last[:depth] rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="648" data-linenumber="326">
          <span class="hits">648</span>
          
          <code class="ruby">      return -1  unless depth</code>
        </li>
      
        <li class="covered" data-hits="646" data-linenumber="327">
          <span class="hits">646</span>
          
          <code class="ruby">      depth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">    # get block for given +blk_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="331">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block(blk_hash)</code>
        </li>
      
        <li class="covered" data-hits="1210" data-linenumber="332">
          <span class="hits">1210</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:hash =&gt; blk_hash.htb.blob])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">    # get block by given +depth+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="336">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_depth(depth)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="337">
          <span class="hits">7</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:depth =&gt; depth, :chain =&gt; MAIN])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">    # get block by given +prev_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="341">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_prev_hash(prev_hash)</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="342">
          <span class="hits">25</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:prev_hash =&gt; prev_hash.htb.blob, :chain =&gt; MAIN])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">    # get block by given +tx_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="346">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="347">
          <span class="hits">1</span>
          
          <code class="ruby">      tx = @db[:tx][:hash =&gt; tx_hash.htb.blob]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="348">
          <span class="hits">1</span>
          
          <code class="ruby">      return nil  unless tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="349">
          <span class="hits">1</span>
          
          <code class="ruby">      parent = @db[:blk_tx][:tx_id =&gt; tx[:id]]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="350">
          <span class="hits">1</span>
          
          <code class="ruby">      return nil  unless parent</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="351">
          <span class="hits">1</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:id =&gt; parent[:blk_id]])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">    # get block by given +id+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="355">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_id(block_id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="356">
          <span class="hits">2</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:id =&gt; block_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">    # get transaction for given +tx_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="360">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="361">
          <span class="hits">27</span>
          
          <code class="ruby">      wrap_tx(@db[:tx][:hash =&gt; tx_hash.htb.blob])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">    # get transaction by given +tx_id+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="365">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx_by_id(tx_id)</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="366">
          <span class="hits">67</span>
          
          <code class="ruby">      wrap_tx(@db[:tx][:id =&gt; tx_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">    # get corresponding Models::TxIn for the txout in transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">    # +tx_hash+ with index +txout_idx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="371">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txin_for_txout(tx_hash, txout_idx)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="372">
          <span class="hits">37</span>
          
          <code class="ruby">      tx_hash = tx_hash.htb_reverse.blob</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="373">
          <span class="hits">37</span>
          
          <code class="ruby">      wrap_txin(@db[:txin][:prev_out =&gt; tx_hash, :prev_out_index =&gt; txout_idx])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="376">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txout_by_id(txout_id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="377">
          <span class="hits">2</span>
          
          <code class="ruby">      wrap_txout(@db[:txout][:id =&gt; txout_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">    # get corresponding Models::TxOut for +txin+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="381">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txout_for_txin(txin)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">      tx = @db[:tx][:hash =&gt; txin.prev_out.reverse.blob]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">      return nil  unless tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">      wrap_txout(@db[:txout][:tx_idx =&gt; txin.prev_out_index, :tx_id =&gt; tx[:id]])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">    # get all Models::TxOut matching given +script+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="388">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_pk_script(script)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="389">
          <span class="hits">1</span>
          
          <code class="ruby">      txouts = @db[:txout].filter(:pk_script =&gt; script.blob).order(:id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="390">
          <span class="hits">2</span>
          
          <code class="ruby">      txouts.map{|txout| wrap_txout(txout)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">    # get all Models::TxOut matching given +hash160+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="394">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_hash160(hash160, unconfirmed = false)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="395">
          <span class="hits">14</span>
          
          <code class="ruby">      addr = @db[:addr][:hash160 =&gt; hash160]</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="396">
          <span class="hits">14</span>
          
          <code class="ruby">      return []  unless addr</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="397">
          <span class="hits">13</span>
          
          <code class="ruby">      txouts = @db[:addr_txout].where(:addr_id =&gt; addr[:id])</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="398">
          <span class="hits">29</span>
          
          <code class="ruby">        .map{|t| @db[:txout][:id =&gt; t[:txout_id]] }</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="399">
          <span class="hits">29</span>
          
          <code class="ruby">        .map{|o| wrap_txout(o) }</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="400">
          <span class="hits">13</span>
          
          <code class="ruby">      unless unconfirmed</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="401">
          <span class="hits">34</span>
          
          <code class="ruby">        txouts.select!{|o| @db[:blk][:id =&gt; o.get_tx.blk_id][:chain] == MAIN rescue false }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="403">
          <span class="hits">13</span>
          
          <code class="ruby">      txouts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">    # get all unconfirmed Models::TxOut</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="407">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_unconfirmed_tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">      @db[:unconfirmed].map{|t| wrap_tx(t)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="411">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_name_by_txout_id txout_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">      wrap_name(@db[:names][:txout_id =&gt; txout_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="415">
          <span class="hits">1</span>
          
          <code class="ruby">    def name_show name</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="416">
          <span class="hits">3</span>
          
          <code class="ruby">      names = @db[:names].where(:name =&gt; name.blob).order(:txout_id).reverse</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="417">
          <span class="hits">3</span>
          
          <code class="ruby">      return nil  unless names.any?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="418">
          <span class="hits">2</span>
          
          <code class="ruby">      wrap_name(names.first)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="421">
          <span class="hits">1</span>
          
          <code class="ruby">    def name_history name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">      @db[:names].where(:name =&gt; name).where(&quot;value IS NOT NULL&quot;).order(:txout_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">        .map {|n| wrap_name(n) }.select {|n| n.get_tx.blk_id }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">    # wrap given +block+ into Models::Block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="427">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_block(block)</code>
        </li>
      
        <li class="covered" data-hits="2097" data-linenumber="428">
          <span class="hits">2097</span>
          
          <code class="ruby">      return nil  unless block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="430">
          <span class="hits">1449</span>
          
          <code class="ruby">      data = {:id =&gt; block[:id], :depth =&gt; block[:depth], :chain =&gt; block[:chain], :work =&gt; block[:work].to_i, :hash =&gt; block[:hash].hth}</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="431">
          <span class="hits">1449</span>
          
          <code class="ruby">      blk = Bitcoin::Storage::Models::Block.new(self, data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="433">
          <span class="hits">1449</span>
          
          <code class="ruby">      blk.ver = block[:version]</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="434">
          <span class="hits">1449</span>
          
          <code class="ruby">      blk.prev_block = block[:prev_hash].reverse</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="435">
          <span class="hits">1449</span>
          
          <code class="ruby">      blk.mrkl_root = block[:mrkl_root].reverse</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="436">
          <span class="hits">1449</span>
          
          <code class="ruby">      blk.time = block[:time].to_i</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="437">
          <span class="hits">1449</span>
          
          <code class="ruby">      blk.bits = block[:bits]</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="438">
          <span class="hits">1449</span>
          
          <code class="ruby">      blk.nonce = block[:nonce]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="440">
          <span class="hits">1449</span>
          
          <code class="ruby">      blk.aux_pow = Bitcoin::P::AuxPow.new(block[:aux_pow])  if block[:aux_pow]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">      db[:blk_tx].filter(blk_id: block[:id]).join(:tx, id: :tx_id)</code>
        </li>
      
        <li class="covered" data-hits="2952" data-linenumber="443">
          <span class="hits">2952</span>
          
          <code class="ruby">        .order(:idx).each {|tx| blk.tx &lt;&lt; wrap_tx(tx, block[:id]) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="445">
          <span class="hits">1449</span>
          
          <code class="ruby">      blk.recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="1449" data-linenumber="446">
          <span class="hits">1449</span>
          
          <code class="ruby">      blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby">    # wrap given +transaction+ into Models::Transaction</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="450">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_tx(transaction, block_id = nil)</code>
        </li>
      
        <li class="covered" data-hits="1597" data-linenumber="451">
          <span class="hits">1597</span>
          
          <code class="ruby">      return nil  unless transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">      block_id ||= @db[:blk_tx].join(:blk, id: :blk_id)</code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="454">
          <span class="hits">1595</span>
          
          <code class="ruby">        .where(tx_id: transaction[:id], chain: 0).first[:blk_id] rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="456">
          <span class="hits">1595</span>
          
          <code class="ruby">      data = {id: transaction[:id], blk_id: block_id}</code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="457">
          <span class="hits">1595</span>
          
          <code class="ruby">      tx = Bitcoin::Storage::Models::Tx.new(self, data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="459">
          <span class="hits">1595</span>
          
          <code class="ruby">      inputs = db[:txin].filter(:tx_id =&gt; transaction[:id]).order(:tx_idx)</code>
        </li>
      
        <li class="covered" data-hits="3211" data-linenumber="460">
          <span class="hits">3211</span>
          
          <code class="ruby">      inputs.each { |i| tx.add_in(wrap_txin(i)) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="462">
          <span class="hits">1595</span>
          
          <code class="ruby">      outputs = db[:txout].filter(:tx_id =&gt; transaction[:id]).order(:tx_idx)</code>
        </li>
      
        <li class="covered" data-hits="3220" data-linenumber="463">
          <span class="hits">3220</span>
          
          <code class="ruby">      outputs.each { |o| tx.add_out(wrap_txout(o)) }</code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="464">
          <span class="hits">1595</span>
          
          <code class="ruby">      tx.ver = transaction[:version]</code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="465">
          <span class="hits">1595</span>
          
          <code class="ruby">      tx.lock_time = transaction[:lock_time]</code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="466">
          <span class="hits">1595</span>
          
          <code class="ruby">      tx.hash = tx.hash_from_payload(tx.to_payload)</code>
        </li>
      
        <li class="covered" data-hits="1595" data-linenumber="467">
          <span class="hits">1595</span>
          
          <code class="ruby">      tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">    # wrap given +input+ into Models::TxIn</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="471">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txin(input)</code>
        </li>
      
        <li class="covered" data-hits="1653" data-linenumber="472">
          <span class="hits">1653</span>
          
          <code class="ruby">      return nil  unless input</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="473">
          <span class="hits">1628</span>
          
          <code class="ruby">      data = {:id =&gt; input[:id], :tx_id =&gt; input[:tx_id], :tx_idx =&gt; input[:tx_idx]}</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="474">
          <span class="hits">1628</span>
          
          <code class="ruby">      txin = Bitcoin::Storage::Models::TxIn.new(self, data)</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="475">
          <span class="hits">1628</span>
          
          <code class="ruby">      txin.prev_out = input[:prev_out]</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="476">
          <span class="hits">1628</span>
          
          <code class="ruby">      txin.prev_out_index = input[:prev_out_index]</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="477">
          <span class="hits">1628</span>
          
          <code class="ruby">      txin.script_sig_length = input[:script_sig].bytesize</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="478">
          <span class="hits">1628</span>
          
          <code class="ruby">      txin.script_sig = input[:script_sig]</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="479">
          <span class="hits">1628</span>
          
          <code class="ruby">      txin.sequence = [input[:sequence]].pack(&quot;V&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1628" data-linenumber="480">
          <span class="hits">1628</span>
          
          <code class="ruby">      txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">    # wrap given +output+ into Models::TxOut</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="484">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txout(output)</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="485">
          <span class="hits">1657</span>
          
          <code class="ruby">      return nil  unless output</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="486">
          <span class="hits">1657</span>
          
          <code class="ruby">      data = {:id =&gt; output[:id], :tx_id =&gt; output[:tx_id], :tx_idx =&gt; output[:tx_idx],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby">        :hash160 =&gt; output[:hash160], :type =&gt; SCRIPT_TYPES[output[:type]]}</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="488">
          <span class="hits">1657</span>
          
          <code class="ruby">      txout = Bitcoin::Storage::Models::TxOut.new(self, data)</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="489">
          <span class="hits">1657</span>
          
          <code class="ruby">      txout.value = output[:value]</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="490">
          <span class="hits">1657</span>
          
          <code class="ruby">      txout.pk_script = output[:pk_script]</code>
        </li>
      
        <li class="covered" data-hits="1657" data-linenumber="491">
          <span class="hits">1657</span>
          
          <code class="ruby">      txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="494">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_name(data)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="495">
          <span class="hits">2</span>
          
          <code class="ruby">      return nil  unless data</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="496">
          <span class="hits">2</span>
          
          <code class="ruby">      Bitcoin::Storage::Models::Name.new(self, data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="499">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby"># TODO: someday sequel will support #blob directly and #to_sequel_blob will be gone</code>
        </li>
      
        <li class="covered" data-hits="6747" data-linenumber="503">
          <span class="hits">6747</span>
          
          <code class="ruby">class String; def blob; to_sequel_blob; end; end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1e47ca20dcc1dba7324b2d0287e768352d49ee12">
  <div class="header">
    <h3>lib/bitcoin/storage/storage.rb</h3>
    <h4><span class="yellow">81.01 %</span> covered</h4>
    <div>
      <b>158</b> relevant lines. 
      <span class="green"><b>128</b> lines covered</span> and
      <span class="red"><b>30</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># The storage implementation supports different backends, which inherit from</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># Storage::StoreBase and implement the same interface.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># Each backend returns Storage::Models objects to easily access helper methods and metadata.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># The most stable backend is Backends::SequelStore, which uses sequel and can use all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># kinds of SQL database backends.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Models, &#39;bitcoin/storage/models&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  @log = Bitcoin::Logger.create(:storage)</code>
        </li>
      
        <li class="covered" data-hits="88" data-linenumber="14">
          <span class="hits">88</span>
          
          <code class="ruby">  def self.log; @log; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  BACKENDS = [:dummy, :sequel]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  BACKENDS.each do |name|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">    module_eval &lt;&lt;-EOS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      def self.#{name} config, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        Backends.const_get(&quot;#{name.capitalize}Store&quot;).new(config, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    EOS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  module Backends</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="27">
          <span class="hits">3</span>
          
          <code class="ruby">    BACKENDS.each {|b| autoload(&quot;#{b.to_s.capitalize}Store&quot;, &quot;bitcoin/storage/#{b}/#{b}_store.rb&quot;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # Base class for storage backends.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    # Every backend must overwrite the &quot;Not implemented&quot; methods</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    # and provide an implementation specific to the storage.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    # Also, before returning the objects, they should be wrapped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    # inside the appropriate Bitcoin::Storage::Models class.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    class StoreBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      # main branch (longest valid chain)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      MAIN = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # side branch (connected, valid, but too short)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      SIDE = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      # orphan branch (not connected to main branch / genesis block)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      ORPHAN = 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(config = {}, getblocks_callback = nil)</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="48">
          <span class="hits">87</span>
          
          <code class="ruby">        @config = config</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="49">
          <span class="hits">87</span>
          
          <code class="ruby">        if @config[:db]</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="50">
          <span class="hits">87</span>
          
          <code class="ruby">          @config[:db].sub!(&quot;~&quot;, ENV[&quot;HOME&quot;])</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="51">
          <span class="hits">87</span>
          
          <code class="ruby">          @config[:db].sub!(&quot;&lt;network&gt;&quot;, Bitcoin.network_name.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="53">
          <span class="hits">87</span>
          
          <code class="ruby">        @getblocks_callback = getblocks_callback</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="54">
          <span class="hits">87</span>
          
          <code class="ruby">        @log    = config[:log] || Bitcoin::Storage.log</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="55">
          <span class="hits">87</span>
          
          <code class="ruby">        @checkpoints = Bitcoin.network[:checkpoints] || {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # reset the store; delete all data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      def reset</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      def new_block blk</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="65">
          <span class="hits">8</span>
          
          <code class="ruby">        time = Time.now</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="66">
          <span class="hits">8</span>
          
          <code class="ruby">        res = store_block(blk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        log.info { &quot;block #{blk.hash} &quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">          &quot;[#{res[0]}, #{[&#39;main&#39;, &#39;side&#39;, &#39;orphan&#39;][res[1]]}] &quot; +</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="69">
          <span class="hits">8</span>
          
          <code class="ruby">          &quot;(#{&quot;%.4fs, %.3fkb&quot; % [(Time.now - time), blk.payload.bytesize.to_f/1000]})&quot; }  if res &amp;&amp; res[1]</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="70">
          <span class="hits">8</span>
          
          <code class="ruby">        res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      # store given block +blk+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      # determine branch/chain and dept of block. trigger reorg if side branch becomes longer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      # than current main chain and connect orpans.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">      def store_block blk</code>
        </li>
      
        <li class="covered" data-hits="497" data-linenumber="77">
          <span class="hits">497</span>
          
          <code class="ruby">        log.debug { &quot;new block #{blk.hash}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="497" data-linenumber="79">
          <span class="hits">497</span>
          
          <code class="ruby">        existing = get_block(blk.hash)</code>
        </li>
      
        <li class="covered" data-hits="497" data-linenumber="80">
          <span class="hits">497</span>
          
          <code class="ruby">        if existing &amp;&amp; existing.chain == MAIN</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="81">
          <span class="hits">3</span>
          
          <code class="ruby">          log.debug { &quot;=&gt; exists (#{existing.depth}, #{existing.chain})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="82">
          <span class="hits">3</span>
          
          <code class="ruby">          return [existing.depth]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="494" data-linenumber="85">
          <span class="hits">494</span>
          
          <code class="ruby">        prev_block = get_block(blk.prev_block.reverse_hth)</code>
        </li>
      
        <li class="covered" data-hits="494" data-linenumber="86">
          <span class="hits">494</span>
          
          <code class="ruby">        validator = blk.validator(self, prev_block)</code>
        </li>
      
        <li class="covered" data-hits="494" data-linenumber="87">
          <span class="hits">494</span>
          
          <code class="ruby">        validator.validate(rules: [:syntax], raise_errors: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="492" data-linenumber="89">
          <span class="hits">492</span>
          
          <code class="ruby">        if !prev_block || prev_block.chain == ORPHAN</code>
        </li>
      
        <li class="covered" data-hits="164" data-linenumber="90">
          <span class="hits">164</span>
          
          <code class="ruby">          if blk.hash == Bitcoin.network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="91">
          <span class="hits">98</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; genesis (0)&quot; }</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="92">
          <span class="hits">98</span>
          
          <code class="ruby">            return persist_block(blk, MAIN, 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="94">
          <span class="hits">66</span>
          
          <code class="ruby">            depth = prev_block ? prev_block.depth + 1 : 0</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="95">
          <span class="hits">66</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; orphan (#{depth})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="96">
          <span class="hits">66</span>
          
          <code class="ruby">            return [0, 2]  unless in_sync?</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="97">
          <span class="hits">66</span>
          
          <code class="ruby">            return persist_block(blk, ORPHAN, depth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="328" data-linenumber="100">
          <span class="hits">328</span>
          
          <code class="ruby">        depth = prev_block.depth + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="328" data-linenumber="102">
          <span class="hits">328</span>
          
          <code class="ruby">        checkpoint = @checkpoints[depth]</code>
        </li>
      
        <li class="covered" data-hits="328" data-linenumber="103">
          <span class="hits">328</span>
          
          <code class="ruby">        if checkpoint &amp;&amp; blk.hash != checkpoint</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          log.warn &quot;Block #{depth} doesn&#39;t match checkpoint #{checkpoint}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">          exit  if depth &gt; get_depth # TODO: handle checkpoint mismatch properly</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="328" data-linenumber="107">
          <span class="hits">328</span>
          
          <code class="ruby">        if prev_block.chain == MAIN</code>
        </li>
      
        <li class="covered" data-hits="313" data-linenumber="108">
          <span class="hits">313</span>
          
          <code class="ruby">          if prev_block == get_head</code>
        </li>
      
        <li class="covered" data-hits="307" data-linenumber="109">
          <span class="hits">307</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; main (#{depth})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="307" data-linenumber="110">
          <span class="hits">307</span>
          
          <code class="ruby">            if !@checkpoints.any? || depth &gt; @checkpoints.keys.last</code>
        </li>
      
        <li class="covered" data-hits="291" data-linenumber="111">
          <span class="hits">291</span>
          
          <code class="ruby">              validator.validate(rules: [:context], raise_errors: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="303" data-linenumber="113">
          <span class="hits">303</span>
          
          <code class="ruby">            return persist_block(blk, MAIN, depth, prev_block.work)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="115">
          <span class="hits">6</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; side (#{depth})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="116">
          <span class="hits">6</span>
          
          <code class="ruby">            return persist_block(blk, SIDE, depth, prev_block.work)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="119">
          <span class="hits">15</span>
          
          <code class="ruby">          head = get_head</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="120">
          <span class="hits">15</span>
          
          <code class="ruby">          if prev_block.work + blk.block_work  &lt;= head.work</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="121">
          <span class="hits">9</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; side (#{depth})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="122">
          <span class="hits">9</span>
          
          <code class="ruby">            validator.validate(rules: [:context], raise_errors: true)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="123">
          <span class="hits">9</span>
          
          <code class="ruby">            return persist_block(blk, SIDE, depth, prev_block.work)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="125">
          <span class="hits">6</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; reorg&quot; }</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="126">
          <span class="hits">6</span>
          
          <code class="ruby">            new_main, new_side = [], []</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="127">
          <span class="hits">6</span>
          
          <code class="ruby">            fork_block = prev_block</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="128">
          <span class="hits">6</span>
          
          <code class="ruby">            while fork_block.chain != MAIN</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="129">
          <span class="hits">15</span>
          
          <code class="ruby">              new_main &lt;&lt; fork_block.hash</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="130">
          <span class="hits">15</span>
          
          <code class="ruby">              fork_block = fork_block.get_prev_block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="132">
          <span class="hits">6</span>
          
          <code class="ruby">            b = fork_block</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="133">
          <span class="hits">6</span>
          
          <code class="ruby">            while b = b.get_next_block</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="134">
          <span class="hits">17</span>
          
          <code class="ruby">              new_side &lt;&lt; b.hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="136">
          <span class="hits">6</span>
          
          <code class="ruby">            log.debug { &quot;new main: #{new_main.inspect}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="137">
          <span class="hits">6</span>
          
          <code class="ruby">            log.debug { &quot;new side: #{new_side.inspect}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="138">
          <span class="hits">6</span>
          
          <code class="ruby">            update_blocks([[new_side, {:chain =&gt; SIDE}]])</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="139">
          <span class="hits">21</span>
          
          <code class="ruby">            new_main.each {|b| get_block(b).validator(self).validate(raise_errors: true) }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="140">
          <span class="hits">5</span>
          
          <code class="ruby">            update_blocks([[new_main, {:chain =&gt; MAIN}]])</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="141">
          <span class="hits">5</span>
          
          <code class="ruby">            return persist_block(blk, MAIN, depth, prev_block.work)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      # persist given block +blk+ to storage.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">      def persist_block(blk)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      # update +attrs+ for block with given +hash+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      # typically used to update the chain value during reorg.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">      def update_block(hash, attrs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">      def new_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">        store_tx(tx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      # store given +tx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">      def store_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      # check if block with given +blk_hash+ is already stored</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">      def has_block(blk_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      # check if tx with given +tx_hash+ is already stored</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">      def has_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">      # get the hash of the leading block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_head</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      # return depth of the head block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_depth</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">      # compute blockchain locator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_locator pointer = get_head</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">        if @locator</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">          locator, head = @locator</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">          if head == get_head</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">            return locator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="195">
          <span class="hits">1</span>
          
          <code class="ruby">        return [(&quot;\x00&quot;*32).hth]  if get_depth == -1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">        locator = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">        step = 1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">        while pointer &amp;&amp; pointer.hash != Bitcoin::network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="199">
          <span class="hits">3</span>
          
          <code class="ruby">          locator &lt;&lt; pointer.hash</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="200">
          <span class="hits">3</span>
          
          <code class="ruby">          depth = pointer.depth - step</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="201">
          <span class="hits">3</span>
          
          <code class="ruby">          break unless depth &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="202">
          <span class="hits">2</span>
          
          <code class="ruby">          prev_block = get_block_by_depth(depth) # TODO</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="203">
          <span class="hits">2</span>
          
          <code class="ruby">          break unless prev_block</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="204">
          <span class="hits">2</span>
          
          <code class="ruby">          pointer = prev_block</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="205">
          <span class="hits">2</span>
          
          <code class="ruby">          step *= 2  if locator.size &gt; 10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">        locator &lt;&lt; Bitcoin::network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">        @locator = [locator, get_head]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">        locator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      # get block with given +blk_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block(blk_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">      # get block with given +depth+ from main chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_depth(depth)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      # get block with given +prev_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_prev_hash(prev_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">      # get block that includes tx with given +tx_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">      # get block by given +block_id+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_id(block_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">      # get corresponding txin for the txout in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      # transaction +tx_hash+ with index +txout_idx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_txin_for_txout(tx_hash, txout_idx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      # get tx with given +tx_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      # get tx with given +tx_id+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_tx_by_id(tx_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">      # collect all txouts containing the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">      # given +script+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_txouts_for_pk_script(script)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">      # collect all txouts containing a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">      # standard tx to given +address+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="261">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_txouts_for_address(address, unconfirmed = false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="262">
          <span class="hits">1</span>
          
          <code class="ruby">        hash160 = Bitcoin.hash160_from_address(address)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="263">
          <span class="hits">1</span>
          
          <code class="ruby">        get_txouts_for_hash160(hash160, unconfirmed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">      # get balance for given +hash160+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="267">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_balance(hash160, unconfirmed = false)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="268">
          <span class="hits">10</span>
          
          <code class="ruby">        txouts = get_txouts_for_hash160(hash160, unconfirmed)</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="269">
          <span class="hits">32</span>
          
          <code class="ruby">        unspent = txouts.select {|o| o.get_next_in.nil?}</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="270">
          <span class="hits">17</span>
          
          <code class="ruby">        unspent.map(&amp;:value).inject {|a,b| a+=b; a} || 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">        nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">      # import satoshi bitcoind blk0001.dat blockchain file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="276">
          <span class="hits">1</span>
          
          <code class="ruby">      def import filename, max_depth = nil</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="277">
          <span class="hits">4</span>
          
          <code class="ruby">        if File.file?(filename)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="278">
          <span class="hits">4</span>
          
          <code class="ruby">          log.info { &quot;Importing #{filename}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="279">
          <span class="hits">4</span>
          
          <code class="ruby">          File.open(filename) do |file|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="280">
          <span class="hits">4</span>
          
          <code class="ruby">            until file.eof?</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="281">
          <span class="hits">8</span>
          
          <code class="ruby">              magic = file.read(4)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="282">
          <span class="hits">8</span>
          
          <code class="ruby">              raise &quot;invalid network magic&quot;  unless Bitcoin.network[:magic_head] == magic</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="283">
          <span class="hits">8</span>
          
          <code class="ruby">              size = file.read(4).unpack(&quot;L&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="284">
          <span class="hits">8</span>
          
          <code class="ruby">              blk = Bitcoin::P::Block.new(file.read(size))</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="285">
          <span class="hits">8</span>
          
          <code class="ruby">              depth, chain = new_block(blk)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="286">
          <span class="hits">8</span>
          
          <code class="ruby">              break  if max_depth &amp;&amp; depth &gt;= max_depth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">        elsif File.directory?(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">          Dir.entries(filename).sort.each do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">            next  unless file =~ /^blk.*?\.dat$/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">            import(File.join(filename, file))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">          raise &quot;Import dir/file #{filename} not found&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="299">
          <span class="hits">1</span>
          
          <code class="ruby">      def in_sync?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">        (get_head &amp;&amp; (Time.now - get_head.time).to_i &lt; 3600) ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1d2f3285b72675d82f9d16bd6660cd2e089bdc3a">
  <div class="header">
    <h3>lib/bitcoin/validation.rb</h3>
    <h4><span class="green">95.48 %</span> covered</h4>
    <div>
      <b>177</b> relevant lines. 
      <span class="green"><b>169</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Validation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # maximum size of a block (in bytes)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_BLOCK_SIZE = 1_000_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # maximum number of signature operations in a block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_BLOCK_SIGOPS = MAX_BLOCK_SIZE / 50</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # the number of base units (&quot;satoshis&quot;) that make up one bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  COIN = 100_000_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # total number of base units in existence</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_MONEY = 21_000_000 * COIN</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # maximum integer value</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  INT_MAX = 0xffffffff</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # number of confirmations required before coinbase tx can be spent</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  COINBASE_MATURITY = 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # interval (in blocks) for difficulty retarget</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  RETARGET = 2016</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # interval (in blocks) for mining reward reduction</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  REWARD_DROP = 210_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  class ValidationError &lt; StandardError</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  class Block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :block, :store, :prev_block, :error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    RULES = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      syntax: [:hash, :tx_list, :bits, :max_timestamp, :coinbase, :coinbase_scriptsig, :mrkl_root, :transactions_syntax],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      context: [:prev_hash, :difficulty, :coinbase_value, :min_timestamp, :transactions_context]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    # TODO merged mining validations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    if Bitcoin.namecoin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      RULES[:syntax] -= [:bits, :coinbase, :coinbase_scriptsig, :mrkl_root]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      RULES[:context] -= [:difficulty, :coinbase_value]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    # validate block rules. +opts+ are:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # rules:: which rulesets to validate (default: [:syntax, :context])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    # raise_errors:: whether to raise ValidationError on failure (default: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    def validate(opts = {})</code>
        </li>
      
        <li class="covered" data-hits="821" data-linenumber="51">
          <span class="hits">821</span>
          
          <code class="ruby">      return true  if KNOWN_EXCEPTIONS.include?(block.hash)</code>
        </li>
      
        <li class="covered" data-hits="820" data-linenumber="52">
          <span class="hits">820</span>
          
          <code class="ruby">      opts[:rules] ||= [:syntax, :context]</code>
        </li>
      
        <li class="covered" data-hits="820" data-linenumber="53">
          <span class="hits">820</span>
          
          <code class="ruby">      opts[:rules].each do |name|</code>
        </li>
      
        <li class="covered" data-hits="838" data-linenumber="54">
          <span class="hits">838</span>
          
          <code class="ruby">        store.log.debug { &quot;validating block #{name} #{block.hash} (#{block.to_payload.bytesize} bytes)&quot; }</code>
        </li>
      
        <li class="covered" data-hits="838" data-linenumber="55">
          <span class="hits">838</span>
          
          <code class="ruby">        RULES[name].each.with_index do |rule, i|</code>
        </li>
      
        <li class="covered" data-hits="5684" data-linenumber="56">
          <span class="hits">5684</span>
          
          <code class="ruby">          unless (res = send(rule)) &amp;&amp; res == true</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="57">
          <span class="hits">19</span>
          
          <code class="ruby">            raise ValidationError, &quot;block error: #{name} check #{i} - #{rule} failed&quot;  if opts[:raise_errors]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="58">
          <span class="hits">12</span>
          
          <code class="ruby">            @error = [rule, res]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="59">
          <span class="hits">12</span>
          
          <code class="ruby">            return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="801" data-linenumber="63">
          <span class="hits">801</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    # setup new validator for given +block+, validating context with +store+,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    # optionally passing the +prev_block+ for optimization.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize block, store, prev_block = nil</code>
        </li>
      
        <li class="covered" data-hits="408" data-linenumber="69">
          <span class="hits">408</span>
          
          <code class="ruby">      @block, @store, @error = block, store, nil</code>
        </li>
      
        <li class="covered" data-hits="408" data-linenumber="70">
          <span class="hits">408</span>
          
          <code class="ruby">      @prev_block = prev_block || store.get_block(block.prev_block.reverse_hth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    # check that block hash matches header</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash</code>
        </li>
      
        <li class="covered" data-hits="520" data-linenumber="75">
          <span class="hits">520</span>
          
          <code class="ruby">      claimed = block.hash; real = block.recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="520" data-linenumber="76">
          <span class="hits">520</span>
          
          <code class="ruby">      claimed == real || [claimed, real]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    # check that block has at least one tx (the coinbase)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    def tx_list</code>
        </li>
      
        <li class="covered" data-hits="519" data-linenumber="81">
          <span class="hits">519</span>
          
          <code class="ruby">      block.tx.any? || block.tx.size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    # check that block hash matches claimed bits</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    def bits</code>
        </li>
      
        <li class="covered" data-hits="518" data-linenumber="86">
          <span class="hits">518</span>
          
          <code class="ruby">      actual = block.hash.to_i(16)</code>
        </li>
      
        <li class="covered" data-hits="518" data-linenumber="87">
          <span class="hits">518</span>
          
          <code class="ruby">      expected = Bitcoin.decode_compact_bits(block.bits).to_i(16)</code>
        </li>
      
        <li class="covered" data-hits="518" data-linenumber="88">
          <span class="hits">518</span>
          
          <code class="ruby">      actual &lt;= expected || [actual, expected]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # check that block time is not greater than max</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    def max_timestamp</code>
        </li>
      
        <li class="covered" data-hits="517" data-linenumber="93">
          <span class="hits">517</span>
          
          <code class="ruby">      time, max = block.time, Time.now.to_i + 2*60*60</code>
        </li>
      
        <li class="covered" data-hits="517" data-linenumber="94">
          <span class="hits">517</span>
          
          <code class="ruby">      time &lt; max || [time, max]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    # check that coinbase is present</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    def coinbase</code>
        </li>
      
        <li class="covered" data-hits="1057" data-linenumber="99">
          <span class="hits">1057</span>
          
          <code class="ruby">      coinbase, *rest = block.tx.map{|t| t.inputs.size == 1 &amp;&amp; t.inputs.first.coinbase? }</code>
        </li>
      
        <li class="covered" data-hits="519" data-linenumber="100">
          <span class="hits">519</span>
          
          <code class="ruby">      (coinbase &amp;&amp; rest.none?) || [coinbase ? 1 : 0, rest.select{|r| r}.size]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    # check that coinbase scriptsig is valid</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    def coinbase_scriptsig</code>
        </li>
      
        <li class="covered" data-hits="514" data-linenumber="105">
          <span class="hits">514</span>
          
          <code class="ruby">      size = block.tx.first.in.first.script_sig.bytesize</code>
        </li>
      
        <li class="covered" data-hits="514" data-linenumber="106">
          <span class="hits">514</span>
          
          <code class="ruby">      size.between?(2,100) || [size, 2, 100]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    # check that coinbase value is valid; no more than reward + fees</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    def coinbase_value</code>
        </li>
      
        <li class="covered" data-hits="315" data-linenumber="111">
          <span class="hits">315</span>
          
          <code class="ruby">      reward = ((50.0 / (2 ** (store.get_depth / REWARD_DROP.to_f).floor)) * 1e8).to_i</code>
        </li>
      
        <li class="covered" data-hits="315" data-linenumber="112">
          <span class="hits">315</span>
          
          <code class="ruby">      fees = block.tx[1..-1].map.with_index do |t, idx|</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="113">
          <span class="hits">11</span>
          
          <code class="ruby">        val = tx_validators[idx]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        t.in.map.with_index {|i, idx|</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="115">
          <span class="hits">11</span>
          
          <code class="ruby">          val.prev_txs[idx].out[i.prev_out_index].value rescue 0</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="116">
          <span class="hits">11</span>
          
          <code class="ruby">        }.inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      end.inject(:+) || 0</code>
        </li>
      
        <li class="covered" data-hits="315" data-linenumber="118">
          <span class="hits">315</span>
          
          <code class="ruby">      coinbase_output = block.tx[0].out.map(&amp;:value).inject(:+)</code>
        </li>
      
        <li class="covered" data-hits="315" data-linenumber="119">
          <span class="hits">315</span>
          
          <code class="ruby">      coinbase_output &lt;= reward + fees || [coinbase_output, reward, fees]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    # check that merkle root matches transaction hashes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    def mrkl_root</code>
        </li>
      
        <li class="covered" data-hits="495" data-linenumber="124">
          <span class="hits">495</span>
          
          <code class="ruby">      actual, expected = block.mrkl_root.reverse_hth, Bitcoin.hash_mrkl_tree(block.tx.map(&amp;:hash))[-1]</code>
        </li>
      
        <li class="covered" data-hits="495" data-linenumber="125">
          <span class="hits">495</span>
          
          <code class="ruby">      actual == expected || [actual, expected]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">    def prev_hash</code>
        </li>
      
        <li class="covered" data-hits="318" data-linenumber="129">
          <span class="hits">318</span>
          
          <code class="ruby">      @prev_block &amp;&amp; @prev_block.hash == block.prev_block.reverse_hth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    # check that bits satisfy required difficulty</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">    def difficulty</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">      return true  if Bitcoin.network_name == :testnet3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">      block.bits == next_bits_required || [block.bits, next_bits_required]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    # check that timestamp is newer than the median of the last 11 blocks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">    def min_timestamp</code>
        </li>
      
        <li class="covered" data-hits="313" data-linenumber="140">
          <span class="hits">313</span>
          
          <code class="ruby">      return true  if store.get_depth &lt;= 11</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="141">
          <span class="hits">12</span>
          
          <code class="ruby">      d = store.get_depth</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="142">
          <span class="hits">12</span>
          
          <code class="ruby">      first = store.db[:blk][hash: block.prev_block.reverse.blob]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="143">
          <span class="hits">12</span>
          
          <code class="ruby">      times = [first[:time]]</code>
        </li>
      
        <li class="covered" data-hits="132" data-linenumber="144">
          <span class="hits">132</span>
          
          <code class="ruby">      (10).times { first = store.db[:blk][hash: first[:prev_hash].blob]</code>
        </li>
      
        <li class="covered" data-hits="120" data-linenumber="145">
          <span class="hits">120</span>
          
          <code class="ruby">        times &lt;&lt; first[:time] }</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="146">
          <span class="hits">12</span>
          
          <code class="ruby">      times.sort!</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="147">
          <span class="hits">12</span>
          
          <code class="ruby">      mid, rem = times.size.divmod(2)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="148">
          <span class="hits">12</span>
          
          <code class="ruby">      min_time = (rem == 0 ? times[mid-1, 2].inject(:+) / 2.0 : times[mid])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="150">
          <span class="hits">12</span>
          
          <code class="ruby">      block.time &gt; min_time || [block.time, min_time]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    # check transactions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    def transactions_syntax</code>
        </li>
      
        <li class="covered" data-hits="510" data-linenumber="155">
          <span class="hits">510</span>
          
          <code class="ruby">      tx_validators.all?{|v|</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="156">
          <span class="hits">21</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="157">
          <span class="hits">21</span>
          
          <code class="ruby">          v.validate(rules: [:syntax], raise_errors: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">        rescue ValidationError</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">          store.log.info { $!.message }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">    def transactions_context</code>
        </li>
      
        <li class="covered" data-hits="311" data-linenumber="166">
          <span class="hits">311</span>
          
          <code class="ruby">      tx_validators.all?{|v|</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="167">
          <span class="hits">11</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="168">
          <span class="hits">11</span>
          
          <code class="ruby">          v.validate(rules: [:context], raise_errors: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">        rescue ValidationError</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">          store.log.info { $!.message }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">    def tx_validators</code>
        </li>
      
        <li class="covered" data-hits="853" data-linenumber="177">
          <span class="hits">853</span>
          
          <code class="ruby">      @tx_validators ||= block.tx[1..-1].map {|tx| tx.validator(store, block) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">    def next_bits_required</code>
        </li>
      
        <li class="covered" data-hits="160" data-linenumber="181">
          <span class="hits">160</span>
          
          <code class="ruby">      index = (prev_block.depth + 1) / RETARGET</code>
        </li>
      
        <li class="covered" data-hits="160" data-linenumber="182">
          <span class="hits">160</span>
          
          <code class="ruby">      max_target = Bitcoin.decode_compact_bits(Bitcoin.network[:proof_of_work_limit]).to_i(16)</code>
        </li>
      
        <li class="covered" data-hits="160" data-linenumber="183">
          <span class="hits">160</span>
          
          <code class="ruby">      return Bitcoin.network[:proof_of_work_limit]  if index == 0</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="184">
          <span class="hits">17</span>
          
          <code class="ruby">      return prev_block.bits  if (prev_block.depth + 1) % RETARGET != 0</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="185">
          <span class="hits">7</span>
          
          <code class="ruby">      last = store.db[:blk][hash: prev_block.hash.htb.blob]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="186">
          <span class="hits">7</span>
          
          <code class="ruby">      first = store.db[:blk][hash: last[:prev_hash].blob]</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="187">
          <span class="hits">63</span>
          
          <code class="ruby">      (RETARGET-2).times { first = store.db[:blk][hash: first[:prev_hash].blob] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="189">
          <span class="hits">7</span>
          
          <code class="ruby">      nActualTimespan = last[:time] - first[:time]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="190">
          <span class="hits">7</span>
          
          <code class="ruby">      nTargetTimespan = RETARGET * 600</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="192">
          <span class="hits">7</span>
          
          <code class="ruby">      nActualTimespan = [nActualTimespan, nTargetTimespan/4].max</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="193">
          <span class="hits">7</span>
          
          <code class="ruby">      nActualTimespan = [nActualTimespan, nTargetTimespan*4].min</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="195">
          <span class="hits">7</span>
          
          <code class="ruby">      target = Bitcoin.decode_compact_bits(last[:bits]).to_i(16)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="196">
          <span class="hits">7</span>
          
          <code class="ruby">      new_target = [max_target, (target * nActualTimespan)/nTargetTimespan].min</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="197">
          <span class="hits">7</span>
          
          <code class="ruby">      Bitcoin.encode_compact_bits new_target.to_s(16)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">    KNOWN_EXCEPTIONS = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      Bitcoin.network[:genesis_hash], # genesis block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      &quot;00000000000a4d0a398161ffc163c503763b1f4360639393e0e4c8e300e0caec&quot;, # BIP30 exception</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      &quot;00000000000743f190a18c5577a3c2d2a1f610ae9601ac046a38084ccb7cd721&quot;, # BIP30 exception</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">  class Tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :tx, :store, :error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">    RULES = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      syntax: [:hash, :lists, :max_size, :output_values, :inputs, :lock_time, :standard],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      context: [:prev_out, :signatures, :spent, :input_values, :output_sum]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">    # validate tx rules. +opts+ are:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">    # rules:: which rulesets to validate (default: [:syntax, :context])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">    # raise_errors:: whether to raise ValidationError on failure (default: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">    def validate(opts = {})</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="220">
          <span class="hits">49</span>
          
          <code class="ruby">      return true  if KNOWN_EXCEPTIONS.include?(tx.hash)</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="221">
          <span class="hits">49</span>
          
          <code class="ruby">      opts[:rules] ||= [:syntax, :context]</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="222">
          <span class="hits">49</span>
          
          <code class="ruby">      opts[:rules].each do |name|</code>
        </li>
      
        <li class="covered" data-hits="56" data-linenumber="223">
          <span class="hits">56</span>
          
          <code class="ruby">        store.log.debug { &quot;validating tx #{name} #{tx.hash} (#{tx.to_payload.bytesize} bytes)&quot; } if store</code>
        </li>
      
        <li class="covered" data-hits="56" data-linenumber="224">
          <span class="hits">56</span>
          
          <code class="ruby">        RULES[name].each.with_index do |rule, i|</code>
        </li>
      
        <li class="covered" data-hits="292" data-linenumber="225">
          <span class="hits">292</span>
          
          <code class="ruby">          unless (res = send(rule)) &amp;&amp; res == true</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="226">
          <span class="hits">17</span>
          
          <code class="ruby">            raise ValidationError, &quot;tx error: #{name} check #{i} - #{rule} failed&quot;  if opts[:raise_errors]</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="227">
          <span class="hits">13</span>
          
          <code class="ruby">            @error = [rule, res]</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="228">
          <span class="hits">13</span>
          
          <code class="ruby">            return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="232">
          <span class="hits">32</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">    KNOWN_EXCEPTIONS = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      # p2sh with invalid inner script, accepted by old miner before 4-2012 switchover</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">      &quot;6a26d2ecb67f27d1fa5524763b49029d7106e91e3cc05743073461a719776192&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      # p2sh with invalid inner script, accepted by old miner before 4-2012 switchover (testnet)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">      &quot;b3c19d78b4953b694717a47d9852f8ea1ccd4cf93a45ba2e43a0f97d7cdb2655&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    # setup new validator for given +tx+, validating context with +store+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">    # also needs the +block+ to find prev_outs for chains of tx inside one block.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize tx, store, block = nil</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="245">
          <span class="hits">35</span>
          
          <code class="ruby">      @tx, @store, @block, @errors = tx, store, block, []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">    # check that tx hash matches data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="250">
          <span class="hits">38</span>
          
          <code class="ruby">      generated_hash = tx.generate_hash(tx.to_payload)</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="251">
          <span class="hits">38</span>
          
          <code class="ruby">      tx.hash == generated_hash || [tx.hash, generated_hash]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    # check that tx has at least one input and one output</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">    def lists</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="256">
          <span class="hits">33</span>
          
          <code class="ruby">      (tx.in.any? &amp;&amp; tx.out.any?) || [tx.in.size, tx.out.size]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    # check that tx size doesn&#39;t exceed MAX_BLOCK_SIZE.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">    def max_size</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="261">
          <span class="hits">31</span>
          
          <code class="ruby">      tx.to_payload.bytesize &lt;= MAX_BLOCK_SIZE || [tx.to_payload.bytesize, MAX_BLOCK_SIZE]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    # check that total output value doesn&#39;t exceed MAX_MONEY.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="265">
          <span class="hits">1</span>
          
          <code class="ruby">    def output_values</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="266">
          <span class="hits">61</span>
          
          <code class="ruby">      total = tx.out.inject(0) {|e, out| e + out.value }</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="267">
          <span class="hits">30</span>
          
          <code class="ruby">      total &lt;= MAX_MONEY || [total, MAX_MONEY]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">    # check that none of the inputs is coinbase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">    # (coinbase tx do not get validated)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="272">
          <span class="hits">1</span>
          
          <code class="ruby">    def inputs</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="273">
          <span class="hits">29</span>
          
          <code class="ruby">      tx.inputs.none?(&amp;:coinbase?) || [tx.inputs.index(tx.inputs.find(&amp;:coinbase?))]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">    # check that lock_time doesn&#39;t exceed INT_MAX</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="277">
          <span class="hits">1</span>
          
          <code class="ruby">    def lock_time</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="278">
          <span class="hits">28</span>
          
          <code class="ruby">      tx.lock_time &lt;= INT_MAX || [tx.lock_time, INT_MAX]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">    # check that min_size is at least 86 bytes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">    # (smaller tx can&#39;t be valid / do anything useful)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="283">
          <span class="hits">1</span>
          
          <code class="ruby">    def min_size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">      tx.to_payload.bytesize &gt;= 86 || [tx.to_payload.bytesize, 86]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">    # check that tx matches &quot;standard&quot; rules.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">    # this is currently disabled since not all miners enforce it.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="289">
          <span class="hits">1</span>
          
          <code class="ruby">    def standard</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="290">
          <span class="hits">27</span>
          
          <code class="ruby">      return true  # not enforced by all miners</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">      return false  unless min_size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">      tx.out.all? {|o| Bitcoin::Script.new(o.pk_script).is_standard? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">    # check that all prev_outs exist</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">    # (and are in a block in the main chain, or the current block; see #prev_txs)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">    def prev_out</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="298">
          <span class="hits">18</span>
          
          <code class="ruby">      missing = tx.in.reject.with_index {|txin, idx|</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="299">
          <span class="hits">18</span>
          
          <code class="ruby">        prev_txs[idx].out[txin.prev_out_index] rescue false }</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="300">
          <span class="hits">18</span>
          
          <code class="ruby">      return true  if prev_txs.size == tx.in.size &amp;&amp; missing.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="302">
          <span class="hits">5</span>
          
          <code class="ruby">      missing.each {|i| store.log.warn { &quot;prev out #{i.prev_out.reverse_hth}:#{i.prev_out_index} missing&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="303">
          <span class="hits">4</span>
          
          <code class="ruby">      missing.map {|i| [i.prev_out.reverse_hth, i.prev_out_index] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">    # TODO: validate coinbase maturity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">    # check that all input signatures are valid</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="309">
          <span class="hits">1</span>
          
          <code class="ruby">    def signatures</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="310">
          <span class="hits">32</span>
          
          <code class="ruby">      sigs = tx.in.map.with_index {|txin, idx| tx.verify_input_signature(idx, prev_txs[idx], (@block ? @block.time : 0)) }</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="311">
          <span class="hits">17</span>
          
          <code class="ruby">      sigs.all? || sigs.map.with_index {|s, i| s ? nil : i }.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">    # check that none of the prev_outs are already spent in the main chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="315">
          <span class="hits">1</span>
          
          <code class="ruby">    def spent</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="316">
          <span class="hits">15</span>
          
          <code class="ruby">      spent = tx.in.map.with_index {|txin, idx|</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="317">
          <span class="hits">15</span>
          
          <code class="ruby">        next false  if @block &amp;&amp; @block.tx.include?(prev_txs[idx])</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="318">
          <span class="hits">14</span>
          
          <code class="ruby">        next false  unless next_in = prev_txs[idx].out[txin.prev_out_index].get_next_in</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="319">
          <span class="hits">3</span>
          
          <code class="ruby">        next false  unless next_tx = next_in.get_tx</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="320">
          <span class="hits">3</span>
          
          <code class="ruby">        next false  unless next_block = next_tx.get_block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="321">
          <span class="hits">1</span>
          
          <code class="ruby">        next_block.chain == Bitcoin::Storage::Backends::StoreBase::MAIN</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="323">
          <span class="hits">16</span>
          
          <code class="ruby">      spent.none? || spent.map.with_index {|s, i| s ? i : nil }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">    # check that the total input value doesn&#39;t exceed MAX_MONEY</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="327">
          <span class="hits">1</span>
          
          <code class="ruby">    def input_values</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="328">
          <span class="hits">14</span>
          
          <code class="ruby">      total_in &lt; MAX_MONEY || [total_in, MAX_MONEY]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">    # check that the total output value doesn&#39;t exceed the total input value</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="332">
          <span class="hits">1</span>
          
          <code class="ruby">    def output_sum</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="333">
          <span class="hits">13</span>
          
          <code class="ruby">      total_in &gt;= total_out || [total_out, total_in]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">    # collect prev_txs needed to verify the inputs of this tx.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">    # only returns tx that are in a block in the main chain or the current block.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="338">
          <span class="hits">1</span>
          
          <code class="ruby">    def prev_txs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">      @prev_txs ||= tx.in.map {|i|</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="340">
          <span class="hits">17</span>
          
          <code class="ruby">        prev_tx = store.get_tx(i.prev_out.reverse_hth)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="341">
          <span class="hits">17</span>
          
          <code class="ruby">        next nil  if !prev_tx &amp;&amp; !@block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="343">
          <span class="hits">17</span>
          
          <code class="ruby">        if store.db &amp;&amp; store.db.is_a?(Sequel::Database)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="344">
          <span class="hits">17</span>
          
          <code class="ruby">          block = store.db[:blk][id: prev_tx.blk_id]  if prev_tx</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="345">
          <span class="hits">17</span>
          
          <code class="ruby">          next prev_tx  if block &amp;&amp; block[:chain] == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">          next prev_tx  if prev_tx.get_block &amp;&amp; prev_tx.get_block.chain == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="349">
          <span class="hits">2</span>
          
          <code class="ruby">        next  nil if !@block</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="350">
          <span class="hits">6</span>
          
          <code class="ruby">        @block.tx.find {|t| t.binary_hash == i.prev_out }</code>
        </li>
      
        <li class="covered" data-hits="100" data-linenumber="351">
          <span class="hits">100</span>
          
          <code class="ruby">      }.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="355">
          <span class="hits">1</span>
          
          <code class="ruby">    def total_in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby">      @total_in ||= tx.in.map.with_index {|txin, idx|</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="357">
          <span class="hits">42</span>
          
          <code class="ruby">        prev_txs[idx].out[txin.prev_out_index].value }.inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="360">
          <span class="hits">1</span>
          
          <code class="ruby">    def total_out</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="361">
          <span class="hits">14</span>
          
          <code class="ruby">      @total_out ||= tx.out.map(&amp;:value).inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="45d4f28fae6f671f74cefe8a341bf4686a58205e">
  <div class="header">
    <h3>lib/bitcoin/wallet/coinselector.rb</h3>
    <h4><span class="green">93.33 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # select unspent txouts to be used by the Wallet when creating a new transaction</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  class SimpleCoinSelector</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # create coinselector with given +txouts+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize txouts</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="10">
          <span class="hits">10</span>
          
          <code class="ruby">      @txouts = txouts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # select txouts needed to spend +value+ btc (base units)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    def select(value)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="15">
          <span class="hits">16</span>
          
          <code class="ruby">      txouts = []</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="16">
          <span class="hits">16</span>
          
          <code class="ruby">      @txouts.each do |txout|</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="17">
          <span class="hits">24</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="18">
          <span class="hits">24</span>
          
          <code class="ruby">          next  if txout.get_next_in</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="19">
          <span class="hits">22</span>
          
          <code class="ruby">          next  if Bitcoin.namecoin? &amp;&amp; txout.type.to_s =~ /^name_/</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="20">
          <span class="hits">22</span>
          
          <code class="ruby">          next  unless txout.get_address</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="21">
          <span class="hits">22</span>
          
          <code class="ruby">          next  unless txout.get_tx.get_block</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="22">
          <span class="hits">20</span>
          
          <code class="ruby">          txouts &lt;&lt; txout</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="23">
          <span class="hits">20</span>
          
          <code class="ruby">          return txouts  if txouts.map(&amp;:value).inject(:+) &gt;= value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          p $!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5b4d2b3b2b9a07acc2e0db4dcc389a361c4af330">
  <div class="header">
    <h3>lib/bitcoin/wallet/keygenerator.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>27</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # Deterministic key generator as described in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # https://bitcointalk.org/index.php?topic=11665.0.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Takes a seed and generates an arbitrary amount of keys.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # Protects against brute-force attacks by requiring the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # key hash to fit a difficulty target, much like the block chain.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  class KeyGenerator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # difficulty target (0x0000FFFF00000000000000000000000000000000000000000000000000000000)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    DEFAULT_TARGET = 0x0000FFFF00000000000000000000000000000000000000000000000000000000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :seed, :nonce, :target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # Initialize key generator with optional +seed+ and +nonce+ and +target+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # [seed] the seed data for the keygenerator (default: random)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # [nonce] the nonce required to satisfy the target (default: computed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # [target] custom difficulty target (default: DEFAULT_TARGET)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # Example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    #  g = KeyGenerator.new # random seed, computed nonce, default target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    #  KeyGenerator.new(g.seed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    #  KeyGenerator.new(g.seed, g.nonce)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    #  g.get_key(0) #=&gt; &lt;Bitcoin::Key&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # Note: When initializing without seed, you should obviously save the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    # seed once it is generated. Saving the nonce is optional; it only saves time.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize seed = nil, nonce = nil, target = nil</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="32">
          <span class="hits">15</span>
          
          <code class="ruby">      @seed = seed || OpenSSL::Random.random_bytes(64)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="33">
          <span class="hits">15</span>
          
          <code class="ruby">      @target = target || DEFAULT_TARGET</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="34">
          <span class="hits">15</span>
          
          <code class="ruby">      @nonce = check_nonce(nonce)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    # get key number +n+ from chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_key(n = 0)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="39">
          <span class="hits">24</span>
          
          <code class="ruby">      key = get_hash(@seed, @nonce)</code>
        </li>
      
        <li class="covered" data-hits="118" data-linenumber="40">
          <span class="hits">118</span>
          
          <code class="ruby">      (n + 1).times { key = sha256(key) }</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="41">
          <span class="hits">24</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="42">
          <span class="hits">24</span>
          
          <code class="ruby">      Bitcoin::Key.new(key.unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    # find a nonce that leads to the privkey satisfying the target</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    def find_nonce</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="47">
          <span class="hits">7</span>
          
          <code class="ruby">      n = 0</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="48">
          <span class="hits">7</span>
          
          <code class="ruby">      n += 1  while !check_target(get_hash(@seed, n))</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="49">
          <span class="hits">7</span>
          
          <code class="ruby">      n</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    # check the nonce; compute if missing, raise if invalid.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">    def check_nonce(nonce)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="56">
          <span class="hits">15</span>
          
          <code class="ruby">      return find_nonce  unless nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # check_target(get_hash(@seed, nonce)) ? nonce : find_nonce</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="58">
          <span class="hits">8</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Nonce invalid.&quot;  unless check_target(get_hash(@seed, nonce))</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="59">
          <span class="hits">7</span>
          
          <code class="ruby">      nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    # check if given +hash+ satisfies the difficulty target</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    def check_target(hash)</code>
        </li>
      
        <li class="covered" data-hits="5771" data-linenumber="64">
          <span class="hits">5771</span>
          
          <code class="ruby">      hash.unpack(&quot;H*&quot;)[0].to_i(16) &lt; @target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    # compute a single SHA256 hash for +d+.</code>
        </li>
      
        <li class="covered" data-hits="17480" data-linenumber="68">
          <span class="hits">17480</span>
          
          <code class="ruby">    def sha256(d); Digest::SHA256.digest(d); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    # get the hash corresponding to +seed+ and +n+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_hash(seed, n)</code>
        </li>
      
        <li class="covered" data-hits="5795" data-linenumber="72">
          <span class="hits">5795</span>
          
          <code class="ruby">      sha256( sha256(seed) + sha256(n.to_s) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="02f674ef66c656bec0454c93dca59c930de55849">
  <div class="header">
    <h3>lib/bitcoin/wallet/keystore.rb</h3>
    <h4><span class="green">92.66 %</span> covered</h4>
    <div>
      <b>109</b> relevant lines. 
      <span class="green"><b>101</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;stringio&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # JSON-file-based keystore used by the Wallet.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  class SimpleKeyStore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # Initialize keystore.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # [config] Hash of settings ({:file =&gt; &quot;/foo/bar.json&quot;})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize config</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="16">
          <span class="hits">70</span>
          
          <code class="ruby">      @config = Hash[config.map{|k,v|[k.to_sym,v]}]</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="17">
          <span class="hits">35</span>
          
          <code class="ruby">      @config[:file].sub!(&quot;~&quot;, ENV[&quot;HOME&quot;])  if @config[:file].is_a?(String)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="18">
          <span class="hits">35</span>
          
          <code class="ruby">      @keys = []</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="19">
          <span class="hits">35</span>
          
          <code class="ruby">      load_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # List all stored keys.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    def keys(need = nil)</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="24">
          <span class="hits">38</span>
          
          <code class="ruby">      @keys.select do |key|</code>
        </li>
      
        <li class="covered" data-hits="114" data-linenumber="25">
          <span class="hits">114</span>
          
          <code class="ruby">        next !(key[:hidden] &amp;&amp; key[:hidden] == &quot;true&quot;)  unless need</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="26">
          <span class="hits">30</span>
          
          <code class="ruby">        case need</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        when :label</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="28">
          <span class="hits">6</span>
          
          <code class="ruby">          !!key[:label]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        when :pub</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="30">
          <span class="hits">6</span>
          
          <code class="ruby">          !!key[:key].pub</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        when :priv</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="32">
          <span class="hits">6</span>
          
          <code class="ruby">          !!key[:key].priv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        when :hidden</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="34">
          <span class="hits">6</span>
          
          <code class="ruby">          !!key[:hidden]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        when :mine</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="36">
          <span class="hits">6</span>
          
          <code class="ruby">          !!key[:mine]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    # Get key for given +label+, +addr+ or +pubkey+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    def key(name)</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="43">
          <span class="hits">25</span>
          
          <code class="ruby">      find_key(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    # Generate and store a new key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    def new_key(label = nil)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="48">
          <span class="hits">4</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Label #{label} already in use&quot;  if label &amp;&amp; find_key(label)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="49">
          <span class="hits">3</span>
          
          <code class="ruby">      key = Bitcoin::Key.generate</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="50">
          <span class="hits">3</span>
          
          <code class="ruby">      @keys &lt;&lt; {:label =&gt; label, :addr =&gt; key.addr, :key =&gt; key}</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="51">
          <span class="hits">3</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="52">
          <span class="hits">3</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    # Add a key which can consist only of +addr+ and +label+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_key key</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="57">
          <span class="hits">4</span>
          
          <code class="ruby">      label = key[:label]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="58">
          <span class="hits">4</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Label #{label} already in use&quot;  if label &amp;&amp; find_key(label)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="59">
          <span class="hits">3</span>
          
          <code class="ruby">      addr = key[:addr]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="60">
          <span class="hits">3</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Address #{addr} is invalid&quot;  if addr &amp;&amp; !Bitcoin.valid_address?(addr)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="61">
          <span class="hits">2</span>
          
          <code class="ruby">      @keys &lt;&lt; key</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="62">
          <span class="hits">2</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="63">
          <span class="hits">2</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    def label_key(name, label)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      find_key(name) do |key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        key[:label] = label</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    def flag_key(name, flag, value)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      find_key(name, true) do |key|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">        key[flag.to_sym] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    # Delete key for given +label+, +addr+ or +pubkey+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def delete(name)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="82">
          <span class="hits">2</span>
          
          <code class="ruby">      key = find_key(name)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="83">
          <span class="hits">2</span>
          
          <code class="ruby">      @keys.delete(key)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="84">
          <span class="hits">2</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    # Export key for given +name+ to base58 format.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    # (See Bitcoin::Key#to_base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    def export(name)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="90">
          <span class="hits">3</span>
          
          <code class="ruby">      find_key(name)[:key].to_base58 rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    # Import key from given +base58+ string.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    # (See Bitcoin::Key.from_base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">    def import(base58, label = nil)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="96">
          <span class="hits">3</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Label #{label} already in use&quot;  if label &amp;&amp; find_key(label)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">      key = Bitcoin::Key.from_base58(base58)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="98">
          <span class="hits">2</span>
          
          <code class="ruby">      @keys &lt;&lt; {:label =&gt; label, :addr =&gt; key.addr, :key =&gt; key}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="99">
          <span class="hits">2</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="100">
          <span class="hits">2</span>
          
          <code class="ruby">      key.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    # Load keys from file.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    # If file is empty this will generate a new key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    # and store it, creating the file.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">    def load_keys</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="107">
          <span class="hits">35</span>
          
          <code class="ruby">      loader = proc{|keys|</code>
        </li>
      
        <li class="covered" data-hits="820" data-linenumber="108">
          <span class="hits">820</span>
          
          <code class="ruby">        keys.map!{|k| Hash[k.map{|k,v| [k.to_sym, v] }]}</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="109">
          <span class="hits">35</span>
          
          <code class="ruby">        keys.map do |key|</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="110">
          <span class="hits">145</span>
          
          <code class="ruby">          key[:key] = Bitcoin::Key.new(key[:priv], key[:pub])</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="111">
          <span class="hits">145</span>
          
          <code class="ruby">          key[:priv], key[:pub] = nil</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="112">
          <span class="hits">145</span>
          
          <code class="ruby">          @keys &lt;&lt; key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="115">
          <span class="hits">35</span>
          
          <code class="ruby">      if @config[:file].is_a?(StringIO)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="116">
          <span class="hits">35</span>
          
          <code class="ruby">        json = JSON.load(@config[:file].read)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="117">
          <span class="hits">35</span>
          
          <code class="ruby">        loader.call(json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      elsif File.exist?(@config[:file])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">        json = JSON.load(File.read(@config[:file]))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">        loader.call(json)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">        new_key; save_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    # Save keys to file.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    def save_keys</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="128">
          <span class="hits">11</span>
          
          <code class="ruby">      dumper = proc{|file|</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="129">
          <span class="hits">11</span>
          
          <code class="ruby">        keys = @keys.map do |key|</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="130">
          <span class="hits">62</span>
          
          <code class="ruby">          key = key.dup</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="131">
          <span class="hits">62</span>
          
          <code class="ruby">          if key[:key]</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="132">
          <span class="hits">60</span>
          
          <code class="ruby">            key[:priv] = key[:key].priv</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="133">
          <span class="hits">60</span>
          
          <code class="ruby">            key[:pub] = key[:key].pub</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="134">
          <span class="hits">60</span>
          
          <code class="ruby">            key.delete(:key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="136">
          <span class="hits">62</span>
          
          <code class="ruby">          key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="138">
          <span class="hits">11</span>
          
          <code class="ruby">        file.write(JSON.pretty_generate(keys))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="141">
          <span class="hits">11</span>
          
          <code class="ruby">      if @config[:file].is_a?(StringIO)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="142">
          <span class="hits">11</span>
          
          <code class="ruby">        @config[:file].reopen</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="143">
          <span class="hits">11</span>
          
          <code class="ruby">        dumper.call(@config[:file])</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="144">
          <span class="hits">11</span>
          
          <code class="ruby">        @config[:file].rewind</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">        File.open(@config[:file], &#39;w&#39;){|file| dumper.call(file) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">    def find_key(name, hidden = false)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="153">
          <span class="hits">37</span>
          
          <code class="ruby">      key = if Bitcoin.valid_address?(name)</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="154">
          <span class="hits">65</span>
          
          <code class="ruby">              @keys.find{|k| k[:addr] == name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">            elsif name.size == 130</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="156">
          <span class="hits">4</span>
          
          <code class="ruby">              @keys.find{|k| k[:key].pub == name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="158">
          <span class="hits">67</span>
          
          <code class="ruby">              @keys.find{|k| k[:label] == name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="160">
          <span class="hits">37</span>
          
          <code class="ruby">      return nil  if !key || (!hidden &amp;&amp; key[:hidden] == &quot;true&quot;)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="161">
          <span class="hits">34</span>
          
          <code class="ruby">      block_given? ? yield(key) : key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">  # Deterministic keystore.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">  class DeterministicKeyStore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :generator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    # Initialize keystore.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    # [config] Hash of settings ({:keys =&gt; 1, :seed =&gt; ..., :nonce =&gt; ...})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize config</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="174">
          <span class="hits">27</span>
          
          <code class="ruby">      @config = Hash[config.map{|k,v|[k.to_sym,v]}]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="175">
          <span class="hits">7</span>
          
          <code class="ruby">      @config[:keys] = (@config[:keys] || 1).to_i</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="176">
          <span class="hits">7</span>
          
          <code class="ruby">      @generator = Bitcoin::Wallet::KeyGenerator.new(@config[:seed], @config[:nonce])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    # List all keys upto configured limit.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">    def keys</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="181">
          <span class="hits">11</span>
          
          <code class="ruby">      1.upto(@config[:keys].to_i).map {|i| @generator.get_key(i) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">    # Get key for given +addr+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">    def key(addr)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="186">
          <span class="hits">2</span>
          
          <code class="ruby">      1.upto(@config[:keys].to_i).map do |i|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="187">
          <span class="hits">2</span>
          
          <code class="ruby">        key = @generator.get_key(i)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="188">
          <span class="hits">2</span>
          
          <code class="ruby">        return key  if key.addr == addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">    # Get new key (actually just increase the key limit).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">    def new_key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">      @config[:keys] += 1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="195">
          <span class="hits">1</span>
          
          <code class="ruby">      @generator.get_key(@config[:keys])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    # Export key for given +addr+ to base58.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">    # (See Bitcoin::Key.to_base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">    def export(addr)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">      key(addr).to_base58 rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e4537349f04bf547cb5970d59edb474b2c135d28">
  <div class="header">
    <h3>lib/bitcoin/wallet/txdp.rb</h3>
    <h4><span class="yellow">83.53 %</span> covered</h4>
    <div>
      <b>85</b> relevant lines. 
      <span class="green"><b>71</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Bitcoin::Wallet::TxDP</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :id, :tx, :inputs</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize tx = []</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="7">
          <span class="hits">6</span>
          
          <code class="ruby">    @id = Bitcoin.int_to_base58(rand(1e14))</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="8">
          <span class="hits">6</span>
          
          <code class="ruby">    @tx = tx</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="9">
          <span class="hits">6</span>
          
          <code class="ruby">    @inputs = []</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="10">
          <span class="hits">6</span>
          
          <code class="ruby">    return  unless tx.any?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    @tx[0].in.each_with_index do |input, i|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      prev_out_hash = input.prev_out.reverse_hth</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">      prev_tx = @tx[1..-1].find {|tx| tx.hash == prev_out_hash}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      raise &quot;prev tx #{prev_out_hash} not found&quot;  unless prev_tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      prev_out = prev_tx.out[input.prev_out_index]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      raise &quot;prev out ##{input.prev_out_index} not found in tx #{@tx.hash}&quot;  unless prev_out</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      out_script = Bitcoin::Script.new(prev_out.pk_script)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      out_script.get_addresses.each do |addr|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">        add_sig(i, prev_out.value, addr, input.script_sig)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_sig(in_idx, value, addr, sig)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">    sig = sig ? [[addr, sig.unpack(&quot;H*&quot;)[0]]] : []</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="26">
          <span class="hits">2</span>
          
          <code class="ruby">    @inputs[in_idx] = [value, sig]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def sign_inputs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    @inputs.each_with_index do |txin, i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      input = @tx[0].in[i]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      prev_out_hash = input.prev_out.reverse_hth</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      prev_tx = @tx[1..-1].find {|tx| tx.hash == prev_out_hash}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      raise &quot;prev tx #{prev_out_hash} not found&quot;  unless prev_tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      prev_out = prev_tx.out[input.prev_out_index]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      raise &quot;prev out ##{input.prev_out_index} not found in tx #{@tx.hash}&quot;  unless prev_out</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      out_script = Bitcoin::Script.new(prev_out.pk_script)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      out_script.get_addresses.each do |addr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        sig = yield(@tx[0], prev_tx, i, addr)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        if sig</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">          @inputs[i][1] ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          @inputs[i][1] &lt;&lt; [addr, sig]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def serialize</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="50">
          <span class="hits">4</span>
          
          <code class="ruby">    lines = []</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="51">
          <span class="hits">4</span>
          
          <code class="ruby">    lines &lt;&lt; &quot;-----BEGIN-TRANSACTION-#{@id}&quot;.ljust(80, &#39;-&#39;)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="52">
          <span class="hits">4</span>
          
          <code class="ruby">    size = [@tx.first.to_payload.bytesize].pack(&quot;C&quot;).ljust(2, &quot;\x00&quot;).reverse_hth</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="53">
          <span class="hits">4</span>
          
          <code class="ruby">    lines &lt;&lt; &quot;_TXDIST_#{Bitcoin.network[:magic_head].unpack(&quot;H*&quot;)[0]}_#{@id}_#{size}&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="54">
          <span class="hits">4</span>
          
          <code class="ruby">    tx = @tx.map(&amp;:to_payload).join.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="2864" data-linenumber="55">
          <span class="hits">2864</span>
          
          <code class="ruby">    tx_str = &quot;&quot;; tx.split(&#39;&#39;).each_with_index{|c,i| tx_str &lt;&lt; (i % 80 == 0 ? &quot;\n#{c}&quot; : c)}</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="56">
          <span class="hits">4</span>
          
          <code class="ruby">    lines &lt;&lt; tx_str.strip</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="57">
          <span class="hits">4</span>
          
          <code class="ruby">    @inputs.each_with_index do |input, idx|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="58">
          <span class="hits">4</span>
          
          <code class="ruby">      lines &lt;&lt; &quot;_TXINPUT_#{idx.to_s.rjust(2, &#39;0&#39;)}_#{&quot;%.8f&quot; % (input[0].to_f / 1e8)}&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="59">
          <span class="hits">4</span>
          
          <code class="ruby">      next  unless input[1]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="60">
          <span class="hits">3</span>
          
          <code class="ruby">      input[1].each do |sig|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="61">
          <span class="hits">3</span>
          
          <code class="ruby">        size = [sig[1]].pack(&quot;H*&quot;).bytesize</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="62">
          <span class="hits">3</span>
          
          <code class="ruby">        size = [size].pack(&quot;C&quot;).ljust(2, &quot;\x00&quot;).reverse_hth</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="63">
          <span class="hits">3</span>
          
          <code class="ruby">        lines &lt;&lt; &quot;_SIG_#{sig[0]}_#{idx.to_s.rjust(2, &#39;0&#39;)}_#{size}&quot;</code>
        </li>
      
        <li class="covered" data-hits="427" data-linenumber="64">
          <span class="hits">427</span>
          
          <code class="ruby">        sig_str = &quot;&quot;; sig[1].split(&#39;&#39;).each_with_index{|c,i| sig_str &lt;&lt; (i % 80 == 0 ? &quot;\n#{c}&quot; : c)}</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="65">
          <span class="hits">3</span>
          
          <code class="ruby">        lines &lt;&lt; sig_str.strip</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="68">
          <span class="hits">4</span>
          
          <code class="ruby">    lines &lt;&lt; &quot;-------END-TRANSACTION-#{@id}&quot;.ljust(80, &#39;-&#39;)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="69">
          <span class="hits">4</span>
          
          <code class="ruby">    lines.join(&quot;\n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse str</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="73">
          <span class="hits">5</span>
          
          <code class="ruby">    str.match(/-+BEGIN-TRANSACTION-(.*?)-+$(.*?)END-TRANSACTION-#{$1}/m) do |m|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="74">
          <span class="hits">5</span>
          
          <code class="ruby">      _, id, content = *m</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="75">
          <span class="hits">5</span>
          
          <code class="ruby">      txdist, *inputs = content.split(/_TXINPUT_/)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="76">
          <span class="hits">5</span>
          
          <code class="ruby">      @id = id</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="77">
          <span class="hits">5</span>
          
          <code class="ruby">      @txdist = parse_txdist(txdist)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="78">
          <span class="hits">11</span>
          
          <code class="ruby">      inputs.each {|input| parse_input(input) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="80">
          <span class="hits">5</span>
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_txdist txdist</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="84">
          <span class="hits">5</span>
          
          <code class="ruby">    _, magic, txdp_id, size, serialized_tx = *txdist.match(/_TXDIST_(.*?)_(.*?)_(.*?)$(.*)/m)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="85">
          <span class="hits">5</span>
          
          <code class="ruby">    raise &quot;Wrong network magic&quot;  unless [magic].pack(&quot;H*&quot;) == Bitcoin.network[:magic_head]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="86">
          <span class="hits">5</span>
          
          <code class="ruby">    tx = Bitcoin::P::Tx.new(nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="87">
          <span class="hits">5</span>
          
          <code class="ruby">    rest = [serialized_tx.gsub!(&quot;\n&quot;, &#39;&#39;)].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="88">
          <span class="hits">5</span>
          
          <code class="ruby">    while rest = tx.parse_data(rest)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="89">
          <span class="hits">11</span>
          
          <code class="ruby">      @tx &lt;&lt; tx</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="90">
          <span class="hits">11</span>
          
          <code class="ruby">      break  if rest == true</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="91">
          <span class="hits">6</span>
          
          <code class="ruby">      tx = Bitcoin::P::Tx.new(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_input input</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="96">
          <span class="hits">6</span>
          
          <code class="ruby">    m = input.match(/(\d+)_(\d+\.\d+)\n(.*)/m)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="97">
          <span class="hits">6</span>
          
          <code class="ruby">    _, idx, value, sigs = *m</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="98">
          <span class="hits">6</span>
          
          <code class="ruby">    value = (value.sub(&#39;.&#39;,&#39;&#39;).to_i)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="99">
          <span class="hits">6</span>
          
          <code class="ruby">    sigs = parse_sigs(sigs)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="100">
          <span class="hits">6</span>
          
          <code class="ruby">    @inputs[idx.to_i] = [value, sigs]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_sigs sigs</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="104">
          <span class="hits">6</span>
          
          <code class="ruby">    return nil  unless sigs[&quot;_SIG_&quot;]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="105">
          <span class="hits">4</span>
          
          <code class="ruby">    sigs = sigs.split(&quot;_SIG_&quot;).map do |s|</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="106">
          <span class="hits">8</span>
          
          <code class="ruby">      if s == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="107">
          <span class="hits">4</span>
          
          <code class="ruby">        nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="109">
          <span class="hits">4</span>
          
          <code class="ruby">        m = s.match(/(.*?)_(\d+)_(.*?)\n(.*)/m)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="110">
          <span class="hits">4</span>
          
          <code class="ruby">        [$1, $4.gsub(&quot;\n&quot;, &#39;&#39;).gsub(&#39;-&#39;, &#39;&#39;)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    end.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.parse str</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="116">
          <span class="hits">5</span>
          
          <code class="ruby">    new.parse str</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5f86fc73b1d974c21d9992a33e59689fa75b4089">
  <div class="header">
    <h3>lib/bitcoin/wallet/wallet.rb</h3>
    <h4><span class="red">58.14 %</span> covered</h4>
    <div>
      <b>129</b> relevant lines. 
      <span class="green"><b>75</b> lines covered</span> and
      <span class="red"><b>54</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># encoding: ascii-8bit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">Bitcoin.require_dependency :eventmachine, exit: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># The wallet implementation consists of several concepts:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># Wallet::             the high-level API used to manage a wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># SimpleKeyStore::     key store to manage keys/addresses/labels</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># SimpleCoinSelector:: coin selector to find unspent outputs to use when creating tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # A wallet manages a set of keys (through a +keystore+), can</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # list transactions/balances for those keys (using a Storage backend for</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # blockchain data).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # It can also create transactions with various kinds of outputs and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # connect with a CommandClient to relay those transactions through a node.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # TODO: new tx notification, keygenerators, keystore cleanup</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  class Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    include Bitcoin::Builder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # the keystore (SimpleKeyStore) managing keys/addresses/labels</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :keystore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    # the Storage which holds the blockchain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :storage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # open wallet with given +storage+ Storage backend, +keystore+ SimpleKeyStore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # and +selector+ SimpleCoinSelector</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize storage, keystore, selector</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="31">
          <span class="hits">14</span>
          
          <code class="ruby">      @storage = storage</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="32">
          <span class="hits">14</span>
          
          <code class="ruby">      @keystore = keystore</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="33">
          <span class="hits">14</span>
          
          <code class="ruby">      @selector = selector</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="34">
          <span class="hits">14</span>
          
          <code class="ruby">      @callbacks = {}</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="35">
          <span class="hits">14</span>
          
          <code class="ruby">      connect_node  if defined?(EM)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect_node</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="39">
          <span class="hits">14</span>
          
          <code class="ruby">      return  unless EM.reactor_running?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      host, port = &quot;127.0.0.1&quot;, 9999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      @node = Bitcoin::Network::CommandClient.connect(host, port, self, @storage) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        on_connected { request :monitor, &quot;block&quot;, &quot;tx&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        on_block do |block, depth|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">          EM.defer do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">            block[&#39;tx&#39;].each do |tx|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">              relevant, tx = @args[0].check_tx(tx[&#39;hash&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">              @args[0].callback(:tx, :confirmed, tx)  if relevant</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        on_tx do |response|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">          EM.defer do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">            relevant, tx = @args[0].check_tx(response[&#39;hash&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">            @args[0].callback(:tx, relevant, tx)  if relevant</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    def check_tx tx_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      relevant = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      addrs = addrs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      tx = @storage.get_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      unless tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        log.warn { &quot;Received tx #{response[&#39;hash&#39;]} but not found in storage&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">        binding.pry</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      addrs = @keystore.keys.map {|k| k[:addr] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      tx.out.each do |txout|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        return :incoming, tx  if (txout.get_addresses &amp; addrs).any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      tx.in.each do |txin|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        next unless  prev_out = txin.get_prev_out</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        return :outgoing, tx  if (prev_out.get_addresses &amp; addrs).any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      return @log  if @log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      @log = Bitcoin::Logger.create(&quot;wallet&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      @log.level = :debug</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      @log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    # call the callback specified by +name+ passing in +args+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    def callback name, *args</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      cb = @callbacks[name.to_sym]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      return  unless cb</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">      log.debug { &quot;callback: #{name}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      cb.call(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    # register callback methods</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    def method_missing(name, *args, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      if name =~ /^on_/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        @callbacks[name.to_s.split(&quot;on_&quot;)[1].to_sym] = block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        log.debug { &quot;callback #{name} registered&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        super(name, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    # get all Storage::Models::TxOut concerning any address from this wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts(unconfirmed = false)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="108">
          <span class="hits">16</span>
          
          <code class="ruby">      txouts = @keystore.keys.map {|k|</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="109">
          <span class="hits">18</span>
          
          <code class="ruby">        @storage.get_txouts_for_address(k[:addr])}.flatten.uniq</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="110">
          <span class="hits">32</span>
          
          <code class="ruby">      unconfirmed ? txouts : txouts.select {|o| !!o.get_tx.get_block}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    # get total balance for all addresses in this wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_balance(unconfirmed = false)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="115">
          <span class="hits">6</span>
          
          <code class="ruby">      values = get_txouts(unconfirmed).select{|o| !o.get_next_in}.map(&amp;:value)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="116">
          <span class="hits">3</span>
          
          <code class="ruby">      ([0] + values).inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    # list all addresses in this wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">    def addrs</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="121">
          <span class="hits">18</span>
          
          <code class="ruby">      @keystore.keys.map{|k| k[:addr]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    # add +key+ to wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_key key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      @keystore.add_key(key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    # set label for key +old+ to +new+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">    def label old, new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      @keystore.label_key(old, new)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    # set +flag+ for key +name+ to +value+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">    def flag name, flag, value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      @keystore.flag_key(name, flag, value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    # list all keys along with their balances</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    def list</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="141">
          <span class="hits">2</span>
          
          <code class="ruby">      @keystore.keys.map do |key|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="142">
          <span class="hits">2</span>
          
          <code class="ruby">        [key, @storage.get_balance(Bitcoin.hash160_from_address(key[:addr]))]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    # create new key and return its address</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_new_addr</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">      @keystore.new_key.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    # get SimpleCoinSelector with txouts for this wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_selector</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="153">
          <span class="hits">13</span>
          
          <code class="ruby">      @selector.new(get_txouts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    # create a transaction with given +outputs+, +fee+ and +change_policy+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    # outputs are of the form</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    #  [&lt;type&gt;, &lt;recipients&gt;, &lt;value&gt;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    # examples:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    #  [:address, &lt;addr&gt;, &lt;value&gt;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    #  [:multisig, 2, 3, &lt;addr&gt;, &lt;addr&gt;, &lt;addr&gt;, &lt;value&gt;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">    # inputs are selected automatically by the SimpleCoinSelector.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    # change_policy controls where the change_output is spent to.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    # see #get_change_addr</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    def new_tx outputs, fee = 0, change_policy = :back</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="169">
          <span class="hits">26</span>
          
          <code class="ruby">      output_value = outputs.map{|o| o[-1] }.inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="171">
          <span class="hits">13</span>
          
          <code class="ruby">      prev_outs = get_selector.select(output_value)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="172">
          <span class="hits">13</span>
          
          <code class="ruby">      return nil  if !prev_outs</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="173">
          <span class="hits">12</span>
          
          <code class="ruby">      if Bitcoin.namecoin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        prev_out = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">        outputs.each do |out|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">          if out[0] == :name_firstupdate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">            name_hash = Bitcoin.hash160(out[2] + out[1].hth)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">            break  if prev_out = get_txouts.find {|o|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">              o.type == :name_new &amp;&amp; o.script.get_namecoin_hash == name_hash }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">          elsif out[0] == :name_update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">            break  if prev_out = storage.name_show(out[1]).get_txout rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        if outputs.find{|o| [:name_firstupdate, :name_update].include?(o[0]) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">          raise &quot;previous name tx not found in wallet.&quot;  unless prev_out</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">          prev_outs += [prev_out]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="190">
          <span class="hits">12</span>
          
          <code class="ruby">      input_value = prev_outs.map(&amp;:value).inject(:+)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="191">
          <span class="hits">12</span>
          
          <code class="ruby">      return nil  unless input_value &gt;= (output_value + fee)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="193">
          <span class="hits">12</span>
          
          <code class="ruby">      tx = build_tx do |t|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="194">
          <span class="hits">12</span>
          
          <code class="ruby">        t.version 0x7100  if Bitcoin.namecoin? &amp;&amp; outputs.find {|o| o[0].to_s =~ /^name_/ }</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="195">
          <span class="hits">12</span>
          
          <code class="ruby">        outputs.each do |type, *addrs, value|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="196">
          <span class="hits">12</span>
          
          <code class="ruby">          t.output do |o|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="197">
          <span class="hits">12</span>
          
          <code class="ruby">            o.value value</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="198">
          <span class="hits">12</span>
          
          <code class="ruby">            o.script do |s|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="199">
          <span class="hits">12</span>
          
          <code class="ruby">              s.type type</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="200">
          <span class="hits">12</span>
          
          <code class="ruby">              s.recipient *addrs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="205">
          <span class="hits">12</span>
          
          <code class="ruby">        change_value = input_value - output_value - fee</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="206">
          <span class="hits">12</span>
          
          <code class="ruby">        if change_value &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="207">
          <span class="hits">12</span>
          
          <code class="ruby">          change_addr = get_change_addr(change_policy, prev_outs.sample.get_address)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="208">
          <span class="hits">12</span>
          
          <code class="ruby">          t.output do |o|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="209">
          <span class="hits">12</span>
          
          <code class="ruby">            o.value change_value</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="210">
          <span class="hits">12</span>
          
          <code class="ruby">            o.script do |s|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="211">
          <span class="hits">12</span>
          
          <code class="ruby">              s.type :address</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="212">
          <span class="hits">12</span>
          
          <code class="ruby">              s.recipient change_addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="217">
          <span class="hits">12</span>
          
          <code class="ruby">        prev_outs.each_with_index do |prev_out, idx|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="218">
          <span class="hits">12</span>
          
          <code class="ruby">          t.input do |i|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="219">
          <span class="hits">12</span>
          
          <code class="ruby">            prev_tx = prev_out.get_tx</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="220">
          <span class="hits">12</span>
          
          <code class="ruby">            i.prev_out prev_tx</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="221">
          <span class="hits">12</span>
          
          <code class="ruby">            i.prev_out_index prev_tx.out.index(prev_out)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="222">
          <span class="hits">12</span>
          
          <code class="ruby">            pk_script = Bitcoin::Script.new(prev_out.pk_script)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="223">
          <span class="hits">12</span>
          
          <code class="ruby">            if pk_script.is_pubkey? || pk_script.is_hash160? || pk_script.is_namecoin?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="224">
          <span class="hits">12</span>
          
          <code class="ruby">              i.signature_key @keystore.key(prev_out.get_address)[:key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">            elsif pk_script.is_multisig?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">              raise &quot;multisig not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      # TODO: spend multisig outputs again</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">      # TODO: verify signatures</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="233">
          <span class="hits">12</span>
          
          <code class="ruby">      Bitcoin::Protocol::Tx.new(tx.to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">    # get address to send change output to.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">    # +policy+ controls which address is chosen:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">    # first:: send to the first key in the wallets keystore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">    # random:: send to a random key from the wallets keystore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    # new:: send to a new key generated in the wallets keystore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">    # back:: send to the address given as +in_addr+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_change_addr(policy, in_addr)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="245">
          <span class="hits">12</span>
          
          <code class="ruby">      case policy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">      when :first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">        @keystore.keys[0].addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      when :random</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">        @keystore.keys.sample.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">      when :new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">        @keystore.new_key.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">      when :back</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="253">
          <span class="hits">10</span>
          
          <code class="ruby">        in_addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">        policy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
      </div>
    </div>
  </body>
</html>
