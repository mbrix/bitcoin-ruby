<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Bitcoin-ruby</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.5.3/jquery-1.6.2.min.js' type='text/javascript'></script>
    <script src='./assets/0.5.3/jquery.dataTables.min.js' type='text/javascript'></script>   
    <script src='./assets/0.5.3/fancybox/jquery.fancybox-1.3.1.pack.js' type='text/javascript'></script>   
    <script src='./assets/0.5.3/jquery.timeago.js' type='text/javascript'></script>   
    <script src='./assets/0.5.3/jquery.url.js' type='text/javascript'></script>   
    <script src='./assets/0.5.3/highlight.pack.js' type='text/javascript'></script>  
    <script src='./assets/0.5.3/app.js' type='text/javascript'></script>    
    <link href='./assets/0.5.3/stylesheet.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link href='./assets/0.5.3/highlight.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link href='./assets/0.5.3/fancybox/jquery.fancybox-1.3.1.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link href='./assets/0.5.3/smoothness/jquery-ui-1.8.4.custom.css' media='screen, projection, print' rel='stylesheet' type='text/css'>    
    <link rel="shortcut icon" type="image/png" href="./assets/0.5.3/favicon_green.png" />
    <link rel="icon" type="image/png" href="./assets/0.5.3/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.5.3/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2012-02-11T22:32:41+01:00">2012-02-11T22:32:41+01:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="green">91.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         175.3
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>22</b> files in total.
    <b>1523</b> relevant lines. 
    <span class="green"><b>1386</b> lines covered</span> and
    <span class="red"><b>137</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#6291547fade947731b570fd2a9162416476301a6" class="src_link" title="lib/bitcoin.rb">lib/bitcoin.rb</a></td>
        <td class="green strong">97.4 %</td>
        <td>277</td>
        <td>154</td>
        <td>150</td>
        <td>4</td>
        <td>184.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2dcb72f38404c85bd4fe44aeed3d3b7e4562fc0c" class="src_link" title="lib/bitcoin/ffi/openssl.rb">lib/bitcoin/ffi/openssl.rb</a></td>
        <td class="green strong">96.77 %</td>
        <td>96</td>
        <td>62</td>
        <td>60</td>
        <td>2</td>
        <td>14.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb82939148b5de4151cdeacc2d9ed89caee32ee5" class="src_link" title="lib/bitcoin/key.rb">lib/bitcoin/key.rb</a></td>
        <td class="green strong">97.96 %</td>
        <td>124</td>
        <td>49</td>
        <td>48</td>
        <td>1</td>
        <td>29.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5d6d97008ffec5aff3bc91103ab60ec056c27d1" class="src_link" title="lib/bitcoin/logger.rb">lib/bitcoin/logger.rb</a></td>
        <td class="red strong">67.74 %</td>
        <td>63</td>
        <td>31</td>
        <td>21</td>
        <td>10</td>
        <td>21.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#097a63ca9e1638fe6b84d7fad2f0982e08134c36" class="src_link" title="lib/bitcoin/protocol.rb">lib/bitcoin/protocol.rb</a></td>
        <td class="red strong">59.15 %</td>
        <td>124</td>
        <td>71</td>
        <td>42</td>
        <td>29</td>
        <td>252.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7232aa03263e2a301dcf3642c61bc0272ac13cbf" class="src_link" title="lib/bitcoin/protocol/address.rb">lib/bitcoin/protocol/address.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>35</td>
        <td>18</td>
        <td>18</td>
        <td>0</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b85bdf561b3dc51ecfd89215f675dc4ae6ab50a3" class="src_link" title="lib/bitcoin/protocol/block.rb">lib/bitcoin/protocol/block.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>95</td>
        <td>46</td>
        <td>46</td>
        <td>0</td>
        <td>179.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec26a72c762bc13eda908614b56e96d8669a4d80" class="src_link" title="lib/bitcoin/protocol/handler.rb">lib/bitcoin/protocol/handler.rb</a></td>
        <td class="red strong">61.11 %</td>
        <td>38</td>
        <td>18</td>
        <td>11</td>
        <td>7</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#557ee148bb367f942116155fdc327b5fa7942241" class="src_link" title="lib/bitcoin/protocol/parser.rb">lib/bitcoin/protocol/parser.rb</a></td>
        <td class="red strong">77.46 %</td>
        <td>124</td>
        <td>71</td>
        <td>55</td>
        <td>16</td>
        <td>3.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#50420e37470493cafba8f41ed05b633a062fcdf4" class="src_link" title="lib/bitcoin/protocol/tx.rb">lib/bitcoin/protocol/tx.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>216</td>
        <td>115</td>
        <td>115</td>
        <td>0</td>
        <td>498.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1535735601f850f0edb630e497ee3ca0f6253a95" class="src_link" title="lib/bitcoin/protocol/txin.rb">lib/bitcoin/protocol/txin.rb</a></td>
        <td class="red strong">64.86 %</td>
        <td>69</td>
        <td>37</td>
        <td>24</td>
        <td>13</td>
        <td>281.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#925463098a998a603cae90a61e90032defc0f861" class="src_link" title="lib/bitcoin/protocol/txout.rb">lib/bitcoin/protocol/txout.rb</a></td>
        <td class="red strong">64.29 %</td>
        <td>51</td>
        <td>28</td>
        <td>18</td>
        <td>10</td>
        <td>540.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9997f171293226ec441ccaa33d726c508ff07a39" class="src_link" title="lib/bitcoin/script.rb">lib/bitcoin/script.rb</a></td>
        <td class="green strong">93.46 %</td>
        <td>489</td>
        <td>260</td>
        <td>243</td>
        <td>17</td>
        <td>422.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3df1335f475b9f7cfa9efdfa05ebfc5a3780d534" class="src_link" title="lib/bitcoin/storage/dummy.rb">lib/bitcoin/storage/dummy.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>164</td>
        <td>101</td>
        <td>101</td>
        <td>0</td>
        <td>118.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a5b4193a8f28e1aea5ab2063c2b6e6b27fea99ad" class="src_link" title="lib/bitcoin/storage/models.rb">lib/bitcoin/storage/models.rb</a></td>
        <td class="green strong">98.0 %</td>
        <td>108</td>
        <td>50</td>
        <td>49</td>
        <td>1</td>
        <td>98.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2b02df19bf3e2d30c17039c18855058d8a44f920" class="src_link" title="lib/bitcoin/storage/sequel.rb">lib/bitcoin/storage/sequel.rb</a></td>
        <td class="green strong">95.14 %</td>
        <td>263</td>
        <td>144</td>
        <td>137</td>
        <td>7</td>
        <td>87.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#13a1bc7c31c7c9123a61b240d7b469d94bd56dc9" class="src_link" title="lib/bitcoin/storage/sequel_store/sequel_migrations.rb">lib/bitcoin/storage/sequel_store/sequel_migrations.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>70</td>
        <td>47</td>
        <td>47</td>
        <td>0</td>
        <td>28.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1e47ca20dcc1dba7324b2d0287e768352d49ee12" class="src_link" title="lib/bitcoin/storage/storage.rb">lib/bitcoin/storage/storage.rb</a></td>
        <td class="red strong">75.36 %</td>
        <td>155</td>
        <td>69</td>
        <td>52</td>
        <td>17</td>
        <td>8.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#45d4f28fae6f671f74cefe8a341bf4686a58205e" class="src_link" title="lib/bitcoin/wallet/coinselector.rb">lib/bitcoin/wallet/coinselector.rb</a></td>
        <td class="green strong">92.31 %</td>
        <td>27</td>
        <td>13</td>
        <td>12</td>
        <td>1</td>
        <td>2.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5b4d2b3b2b9a07acc2e0db4dcc389a361c4af330" class="src_link" title="lib/bitcoin/wallet/keygenerator.rb">lib/bitcoin/wallet/keygenerator.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>75</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>1068.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#02f674ef66c656bec0454c93dca59c930de55849" class="src_link" title="lib/bitcoin/wallet/keystore.rb">lib/bitcoin/wallet/keystore.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>115</td>
        <td>51</td>
        <td>51</td>
        <td>0</td>
        <td>4.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5f86fc73b1d974c21d9992a33e59689fa75b4089" class="src_link" title="lib/bitcoin/wallet/wallet.rb">lib/bitcoin/wallet/wallet.rb</a></td>
        <td class="green strong">96.72 %</td>
        <td>106</td>
        <td>61</td>
        <td>59</td>
        <td>2</td>
        <td>8.3</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
          <div class="file_list_container" id="Bitcoin">
  <h2>
    <span class="group_name">Bitcoin</span>
    (<span class="covered_percent"><span class="green">95.25%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         211.9
       </span>
    </span> hits/line)
  </h2>
  <a name="Bitcoin"></a>
  <div>
    <b>3</b> files in total.
    <b>463</b> relevant lines. 
    <span class="green"><b>441</b> lines covered</span> and
    <span class="red"><b>22</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#6291547fade947731b570fd2a9162416476301a6" class="src_link" title="lib/bitcoin.rb">lib/bitcoin.rb</a></td>
        <td class="green strong">97.4 %</td>
        <td>277</td>
        <td>154</td>
        <td>150</td>
        <td>4</td>
        <td>184.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb82939148b5de4151cdeacc2d9ed89caee32ee5" class="src_link" title="lib/bitcoin/key.rb">lib/bitcoin/key.rb</a></td>
        <td class="green strong">97.96 %</td>
        <td>124</td>
        <td>49</td>
        <td>48</td>
        <td>1</td>
        <td>29.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9997f171293226ec441ccaa33d726c508ff07a39" class="src_link" title="lib/bitcoin/script.rb">lib/bitcoin/script.rb</a></td>
        <td class="green strong">93.46 %</td>
        <td>489</td>
        <td>260</td>
        <td>243</td>
        <td>17</td>
        <td>422.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Protocol">
  <h2>
    <span class="group_name">Protocol</span>
    (<span class="covered_percent"><span class="yellow">81.44%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         219.85
       </span>
    </span> hits/line)
  </h2>
  <a name="Protocol"></a>
  <div>
    <b>8</b> files in total.
    <b>404</b> relevant lines. 
    <span class="green"><b>329</b> lines covered</span> and
    <span class="red"><b>75</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#097a63ca9e1638fe6b84d7fad2f0982e08134c36" class="src_link" title="lib/bitcoin/protocol.rb">lib/bitcoin/protocol.rb</a></td>
        <td class="red strong">59.15 %</td>
        <td>124</td>
        <td>71</td>
        <td>42</td>
        <td>29</td>
        <td>252.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7232aa03263e2a301dcf3642c61bc0272ac13cbf" class="src_link" title="lib/bitcoin/protocol/address.rb">lib/bitcoin/protocol/address.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>35</td>
        <td>18</td>
        <td>18</td>
        <td>0</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b85bdf561b3dc51ecfd89215f675dc4ae6ab50a3" class="src_link" title="lib/bitcoin/protocol/block.rb">lib/bitcoin/protocol/block.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>95</td>
        <td>46</td>
        <td>46</td>
        <td>0</td>
        <td>179.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec26a72c762bc13eda908614b56e96d8669a4d80" class="src_link" title="lib/bitcoin/protocol/handler.rb">lib/bitcoin/protocol/handler.rb</a></td>
        <td class="red strong">61.11 %</td>
        <td>38</td>
        <td>18</td>
        <td>11</td>
        <td>7</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#557ee148bb367f942116155fdc327b5fa7942241" class="src_link" title="lib/bitcoin/protocol/parser.rb">lib/bitcoin/protocol/parser.rb</a></td>
        <td class="red strong">77.46 %</td>
        <td>124</td>
        <td>71</td>
        <td>55</td>
        <td>16</td>
        <td>3.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#50420e37470493cafba8f41ed05b633a062fcdf4" class="src_link" title="lib/bitcoin/protocol/tx.rb">lib/bitcoin/protocol/tx.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>216</td>
        <td>115</td>
        <td>115</td>
        <td>0</td>
        <td>498.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1535735601f850f0edb630e497ee3ca0f6253a95" class="src_link" title="lib/bitcoin/protocol/txin.rb">lib/bitcoin/protocol/txin.rb</a></td>
        <td class="red strong">64.86 %</td>
        <td>69</td>
        <td>37</td>
        <td>24</td>
        <td>13</td>
        <td>281.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#925463098a998a603cae90a61e90032defc0f861" class="src_link" title="lib/bitcoin/protocol/txout.rb">lib/bitcoin/protocol/txout.rb</a></td>
        <td class="red strong">64.29 %</td>
        <td>51</td>
        <td>28</td>
        <td>18</td>
        <td>10</td>
        <td>540.4</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Storage">
  <h2>
    <span class="group_name">Storage</span>
    (<span class="covered_percent"><span class="green">93.92%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         68.32
       </span>
    </span> hits/line)
  </h2>
  <a name="Storage"></a>
  <div>
    <b>5</b> files in total.
    <b>411</b> relevant lines. 
    <span class="green"><b>386</b> lines covered</span> and
    <span class="red"><b>25</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#3df1335f475b9f7cfa9efdfa05ebfc5a3780d534" class="src_link" title="lib/bitcoin/storage/dummy.rb">lib/bitcoin/storage/dummy.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>164</td>
        <td>101</td>
        <td>101</td>
        <td>0</td>
        <td>118.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a5b4193a8f28e1aea5ab2063c2b6e6b27fea99ad" class="src_link" title="lib/bitcoin/storage/models.rb">lib/bitcoin/storage/models.rb</a></td>
        <td class="green strong">98.0 %</td>
        <td>108</td>
        <td>50</td>
        <td>49</td>
        <td>1</td>
        <td>98.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2b02df19bf3e2d30c17039c18855058d8a44f920" class="src_link" title="lib/bitcoin/storage/sequel.rb">lib/bitcoin/storage/sequel.rb</a></td>
        <td class="green strong">95.14 %</td>
        <td>263</td>
        <td>144</td>
        <td>137</td>
        <td>7</td>
        <td>87.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#13a1bc7c31c7c9123a61b240d7b469d94bd56dc9" class="src_link" title="lib/bitcoin/storage/sequel_store/sequel_migrations.rb">lib/bitcoin/storage/sequel_store/sequel_migrations.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>70</td>
        <td>47</td>
        <td>47</td>
        <td>0</td>
        <td>28.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1e47ca20dcc1dba7324b2d0287e768352d49ee12" class="src_link" title="lib/bitcoin/storage/storage.rb">lib/bitcoin/storage/storage.rb</a></td>
        <td class="red strong">75.36 %</td>
        <td>155</td>
        <td>69</td>
        <td>52</td>
        <td>17</td>
        <td>8.8</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Wallet">
  <h2>
    <span class="group_name">Wallet</span>
    (<span class="covered_percent"><span class="green">98.03%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         271.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Wallet"></a>
  <div>
    <b>4</b> files in total.
    <b>152</b> relevant lines. 
    <span class="green"><b>149</b> lines covered</span> and
    <span class="red"><b>3</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#45d4f28fae6f671f74cefe8a341bf4686a58205e" class="src_link" title="lib/bitcoin/wallet/coinselector.rb">lib/bitcoin/wallet/coinselector.rb</a></td>
        <td class="green strong">92.31 %</td>
        <td>27</td>
        <td>13</td>
        <td>12</td>
        <td>1</td>
        <td>2.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5b4d2b3b2b9a07acc2e0db4dcc389a361c4af330" class="src_link" title="lib/bitcoin/wallet/keygenerator.rb">lib/bitcoin/wallet/keygenerator.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>75</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>1068.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#02f674ef66c656bec0454c93dca59c930de55849" class="src_link" title="lib/bitcoin/wallet/keystore.rb">lib/bitcoin/wallet/keystore.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>115</td>
        <td>51</td>
        <td>51</td>
        <td>0</td>
        <td>4.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5f86fc73b1d974c21d9992a33e59689fa75b4089" class="src_link" title="lib/bitcoin/wallet/wallet.rb">lib/bitcoin/wallet/wallet.rb</a></td>
        <td class="green strong">96.72 %</td>
        <td>106</td>
        <td>61</td>
        <td>59</td>
        <td>2</td>
        <td>8.3</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Utilities">
  <h2>
    <span class="group_name">Utilities</span>
    (<span class="covered_percent"><span class="yellow">87.1%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         18.2
       </span>
    </span> hits/line)
  </h2>
  <a name="Utilities"></a>
  <div>
    <b>2</b> files in total.
    <b>93</b> relevant lines. 
    <span class="green"><b>81</b> lines covered</span> and
    <span class="red"><b>12</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#2dcb72f38404c85bd4fe44aeed3d3b7e4562fc0c" class="src_link" title="lib/bitcoin/ffi/openssl.rb">lib/bitcoin/ffi/openssl.rb</a></td>
        <td class="green strong">96.77 %</td>
        <td>96</td>
        <td>62</td>
        <td>60</td>
        <td>2</td>
        <td>14.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5d6d97008ffec5aff3bc91103ab60ec056c27d1" class="src_link" title="lib/bitcoin/logger.rb">lib/bitcoin/logger.rb</a></td>
        <td class="red strong">67.74 %</td>
        <td>63</td>
        <td>31</td>
        <td>21</td>
        <td>10</td>
        <td>21.6</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.5.4 
        and simplecov-html v0.5.3<br/>
        using RSpec
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="6291547fade947731b570fd2a9162416476301a6">
  <div class="header">
    <h3>lib/bitcoin.rb</h3>
    <h4><span class="green">97.4 %</span> covered</h4>
    <div>
      <b>154</b> relevant lines. 
      <span class="green"><b>150</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Bitcoin Utils and Network Protocol in Ruby.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'digest/sha2'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'digest/rmd160'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'openssl'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Connection, 'bitcoin/connection'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Protocol,   'bitcoin/protocol'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :P,          'bitcoin/protocol'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Script,     'bitcoin/script'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :VERSION,    'bitcoin/version'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Storage,    'bitcoin/storage/storage'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Logger,     'bitcoin/logger'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Key,        'bitcoin/key'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Config,     'bitcoin/config'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  module Network</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :ConnectionHandler,  'bitcoin/network/connection_handler'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :CommandHandler,     'bitcoin/network/command_handler'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Node,               'bitcoin/network/node'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  module Wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :KeyGenerator,          'bitcoin/wallet/keygenerator'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :SimpleKeyStore,        'bitcoin/wallet/keystore'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :DeterministicKeyStore, 'bitcoin/wallet/keystore'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :SimpleCoinSelector,    'bitcoin/wallet/coinselector'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Wallet,                'bitcoin/wallet/wallet'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  module Util</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="36">
          <span class="hits">128</span>
          
          <code class="ruby">    def hth(h); h.unpack(&quot;H*&quot;)[0]; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    def htb(h); [h].pack(&quot;H*&quot;); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    def address_version</code>
        </li>
      
        <li class="covered" data-hits="291" data-linenumber="40">
          <span class="hits">291</span>
          
          <code class="ruby">      Bitcoin::network[:address_version]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # hash160 is a 20 bytes (160bits) rmd610-sha256 hexdigest.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160(hex)</code>
        </li>
      
        <li class="covered" data-hits="351" data-linenumber="45">
          <span class="hits">351</span>
          
          <code class="ruby">      bytes = [hex].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="351" data-linenumber="46">
          <span class="hits">351</span>
          
          <code class="ruby">      Digest::RMD160.hexdigest Digest::SHA256.digest(bytes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    # checksum is a 4 bytes sha256-sha256 hexdigest.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    def checksum(hex)</code>
        </li>
      
        <li class="covered" data-hits="163" data-linenumber="51">
          <span class="hits">163</span>
          
          <code class="ruby">      b = [hex].pack(&quot;H*&quot;) # unpack hex</code>
        </li>
      
        <li class="covered" data-hits="163" data-linenumber="52">
          <span class="hits">163</span>
          
          <code class="ruby">      Digest::SHA256.hexdigest( Digest::SHA256.digest(b) )[0...8]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">    def address_checksum?(address)</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="56">
          <span class="hits">57</span>
          
          <code class="ruby">      a = base58_to_hex(address) rescue nil</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="57">
          <span class="hits">57</span>
          
          <code class="ruby">      return false  unless a</code>
        </li>
      
        <li class="covered" data-hits="55" data-linenumber="58">
          <span class="hits">55</span>
          
          <code class="ruby">      if address_version == &quot;00&quot;</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="59">
          <span class="hits">47</span>
          
          <code class="ruby">        Bitcoin.checksum( address_version + a[0...40] ) == a[-8..-1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="61">
          <span class="hits">8</span>
          
          <code class="ruby">        Bitcoin.checksum( a[0...42] ) == a[-8..-1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    def valid_address?(address)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="66">
          <span class="hits">11</span>
          
          <code class="ruby">      if address_version == &quot;00&quot;</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="67">
          <span class="hits">8</span>
          
          <code class="ruby">        return false if address[0] != &quot;1&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="69">
          <span class="hits">3</span>
          
          <code class="ruby">        a = base58_to_hex(address) rescue nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="70">
          <span class="hits">3</span>
          
          <code class="ruby">        return false unless a &amp;&amp; a[0..1] == address_version</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="72">
          <span class="hits">6</span>
          
          <code class="ruby">      address_checksum?(address)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160_from_address(address)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="76">
          <span class="hits">45</span>
          
          <code class="ruby">      return nil  unless address_checksum?(address)</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="77">
          <span class="hits">44</span>
          
          <code class="ruby">      a = base58_to_hex(address)</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="78">
          <span class="hits">44</span>
          
          <code class="ruby">      address_version == &quot;00&quot; ? a[0...40] : a[2...42]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def sha256(hex)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      Digest::SHA256.hexdigest([hex].pack(&quot;H*&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160_to_address(hex)</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="86">
          <span class="hits">66</span>
          
          <code class="ruby">      hex = address_version + hex</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="87">
          <span class="hits">66</span>
          
          <code class="ruby">      addr = encode_base58(hex + checksum(hex))</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="88">
          <span class="hits">66</span>
          
          <code class="ruby">      addr = &quot;1&quot; + addr  if address_version == &quot;00&quot;</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="89">
          <span class="hits">66</span>
          
          <code class="ruby">      addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    def pubkey_to_address(pubkey)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="93">
          <span class="hits">3</span>
          
          <code class="ruby">      hash160_to_address( hash160(pubkey) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    def encode_base58(hex)</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="97">
          <span class="hits">81</span>
          
          <code class="ruby">      int_to_base58( hex.to_i(16) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">    def int_to_base58(int_val)</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="101">
          <span class="hits">81</span>
          
          <code class="ruby">      alpha = &quot;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&quot;</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="102">
          <span class="hits">81</span>
          
          <code class="ruby">      base58_val, base = '', alpha.size</code>
        </li>
      
        <li class="covered" data-hits="3028" data-linenumber="103">
          <span class="hits">3028</span>
          
          <code class="ruby">      while(int_val &gt;= base)</code>
        </li>
      
        <li class="covered" data-hits="2866" data-linenumber="104">
          <span class="hits">2866</span>
          
          <code class="ruby">        mod = int_val % base</code>
        </li>
      
        <li class="covered" data-hits="2866" data-linenumber="105">
          <span class="hits">2866</span>
          
          <code class="ruby">        base58_val = alpha[mod,1] + base58_val</code>
        </li>
      
        <li class="covered" data-hits="2866" data-linenumber="106">
          <span class="hits">2866</span>
          
          <code class="ruby">        int_val = (int_val - mod)/base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="108">
          <span class="hits">81</span>
          
          <code class="ruby">      alpha[int_val,1] + base58_val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    def base58_to_int(base58_val)</code>
        </li>
      
        <li class="covered" data-hits="130" data-linenumber="112">
          <span class="hits">130</span>
          
          <code class="ruby">      alpha = &quot;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&quot;</code>
        </li>
      
        <li class="covered" data-hits="130" data-linenumber="113">
          <span class="hits">130</span>
          
          <code class="ruby">      int_val, base = 0, alpha.size</code>
        </li>
      
        <li class="covered" data-hits="130" data-linenumber="114">
          <span class="hits">130</span>
          
          <code class="ruby">      base58_val.reverse.each_char.with_index do |char,index|</code>
        </li>
      
        <li class="covered" data-hits="4761" data-linenumber="115">
          <span class="hits">4761</span>
          
          <code class="ruby">        raise ArgumentError, 'Value not a valid Base58 String.' unless char_index = alpha.index(char)</code>
        </li>
      
        <li class="covered" data-hits="4758" data-linenumber="116">
          <span class="hits">4758</span>
          
          <code class="ruby">        int_val += char_index*(base**index)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="127" data-linenumber="118">
          <span class="hits">127</span>
          
          <code class="ruby">      int_val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">    def base58_to_hex(base58_val)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      #[base58_to_int(base58_val).to_s(2).reverse].pack(&quot;b*&quot;).reverse.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="130" data-linenumber="123">
          <span class="hits">130</span>
          
          <code class="ruby">      s = base58_to_int(base58_val).to_s(16); s.bytesize.odd? ? '0'+s : s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    # target compact bits (int) to bignum hex</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    def decode_compact_bits(bits)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="128">
          <span class="hits">8</span>
          
          <code class="ruby">      bytes = Array.new(size=((bits &gt;&gt; 24) &amp; 255), 0)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="129">
          <span class="hits">8</span>
          
          <code class="ruby">      bytes[0] = (bits &gt;&gt; 16) &amp; 255 if size &gt;= 1</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="130">
          <span class="hits">8</span>
          
          <code class="ruby">      bytes[1] = (bits &gt;&gt;  8) &amp; 255 if size &gt;= 2</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="131">
          <span class="hits">8</span>
          
          <code class="ruby">      bytes[2] = (bits      ) &amp; 255 if size &gt;= 3</code>
        </li>
      
        <li class="covered" data-hits="230" data-linenumber="132">
          <span class="hits">230</span>
          
          <code class="ruby">      bytes.map{|i| &quot;%02x&quot; % [i] }.join.rjust(64, '0')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">    # target bignum hex to compact bits (int)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    def encode_compact_bits(target)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="137">
          <span class="hits">3</span>
          
          <code class="ruby">      bytes = OpenSSL::BN.new(target, 16).to_mpi</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="138">
          <span class="hits">3</span>
          
          <code class="ruby">      size = bytes.size - 4</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="139">
          <span class="hits">3</span>
          
          <code class="ruby">      nbits = size &lt;&lt; 24</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="140">
          <span class="hits">3</span>
          
          <code class="ruby">      nbits |= (bytes[4] &lt;&lt; 16) if size &gt;= 1</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="141">
          <span class="hits">3</span>
          
          <code class="ruby">      nbits |= (bytes[5] &lt;&lt;  8) if size &gt;= 2</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="142">
          <span class="hits">3</span>
          
          <code class="ruby">      nbits |= (bytes[6]      ) if size &gt;= 3</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="143">
          <span class="hits">3</span>
          
          <code class="ruby">      nbits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    def decode_target(target_bits)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">      case target_bits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      when Fixnum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">        [ decode_compact_bits(target_bits).to_i(16), target_bits ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      when String</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">        [ target_bits.to_i(16), encode_compact_bits(target_bits) ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    def bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="190" data-linenumber="156">
          <span class="hits">190</span>
          
          <code class="ruby">      ::OpenSSL::PKey::EC.new(&quot;secp256k1&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate_key</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="160">
          <span class="hits">8</span>
          
          <code class="ruby">      key = bitcoin_elliptic_curve.generate_key</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="161">
          <span class="hits">8</span>
          
          <code class="ruby">      inspect_key( key )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    def inspect_key(key)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="165">
          <span class="hits">9</span>
          
          <code class="ruby">      [ key.private_key_hex, key.public_key_hex ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate_address</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">      prvkey, pubkey = generate_key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">      [ pubkey_to_address(pubkey), prvkey, pubkey, hash160(pubkey) ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">    def bitcoin_hash(hex)</code>
        </li>
      
        <li class="covered" data-hits="731" data-linenumber="174">
          <span class="hits">731</span>
          
          <code class="ruby">      Digest::SHA256.digest(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">        Digest::SHA256.digest( [hex].pack(&quot;H*&quot;).reverse )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">      ).reverse.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="155" data-linenumber="179">
          <span class="hits">155</span>
          
          <code class="ruby">    def bitcoin_mrkl(a, b); bitcoin_hash(b + a); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_hash(prev_block, mrkl_root, time, bits, nonce, ver)</code>
        </li>
      
        <li class="covered" data-hits="577" data-linenumber="182">
          <span class="hits">577</span>
          
          <code class="ruby">      h = &quot;%08x%08x%08x%064s%064s%08x&quot; %</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">            [nonce, bits, time, mrkl_root, prev_block, ver]</code>
        </li>
      
        <li class="covered" data-hits="576" data-linenumber="184">
          <span class="hits">576</span>
          
          <code class="ruby">      bitcoin_hash(h)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash_mrkl_tree(tx)</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="188">
          <span class="hits">33</span>
          
          <code class="ruby">      chunks = [ tx.dup ]</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="189">
          <span class="hits">33</span>
          
          <code class="ruby">      while chunks.last.size &gt;= 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        chunks &lt;&lt; chunks.last.each_slice(2).map{|i|</code>
        </li>
      
        <li class="covered" data-hits="133" data-linenumber="191">
          <span class="hits">133</span>
          
          <code class="ruby">          Bitcoin.bitcoin_mrkl( i[0], i[1] || i[0] )</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="192">
          <span class="hits">18</span>
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="194">
          <span class="hits">33</span>
          
          <code class="ruby">      chunks.flatten</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">    def sign_data(key, data)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="199">
          <span class="hits">3</span>
          
          <code class="ruby">      key.dsa_sign_asn1(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">    def verify_signature(hash, signature, public_key)</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="203">
          <span class="hits">27</span>
          
          <code class="ruby">      key  = bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="204">
          <span class="hits">27</span>
          
          <code class="ruby">      key.public_key = ::OpenSSL::PKey::EC::Point.from_hex(key.group, public_key)</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="205">
          <span class="hits">26</span>
          
          <code class="ruby">      key.dsa_verify_asn1(hash, signature)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">    rescue OpenSSL::PKey::ECError, OpenSSL::PKey::EC::Point::Error</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="207">
          <span class="hits">2</span>
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    end </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="210">
          <span class="hits">1</span>
          
          <code class="ruby">    def open_key(private_key, public_key=nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="211">
          <span class="hits">5</span>
          
          <code class="ruby">      key  = bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="212">
          <span class="hits">5</span>
          
          <code class="ruby">      key.private_key = ::OpenSSL::BN.from_hex(private_key)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="213">
          <span class="hits">5</span>
          
          <code class="ruby">      public_key = regenerate_public_key(private_key) unless public_key</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="214">
          <span class="hits">5</span>
          
          <code class="ruby">      key.public_key  = ::OpenSSL::PKey::EC::Point.from_hex(key.group, public_key)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="215">
          <span class="hits">5</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">    def regenerate_public_key(private_key)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">      Bitcoin::OpenSSL_EC.regenerate_key(private_key)[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">  module ::OpenSSL</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">    class BN</code>
        </li>
      
        <li class="covered" data-hits="209" data-linenumber="225">
          <span class="hits">209</span>
          
          <code class="ruby">      def self.from_hex(hex); new(hex, 16); end</code>
        </li>
      
        <li class="covered" data-hits="206" data-linenumber="226">
          <span class="hits">206</span>
          
          <code class="ruby">      def to_hex; to_i.to_s(16); end</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="227">
          <span class="hits">4</span>
          
          <code class="ruby">      def to_mpi; to_s(0).unpack(&quot;C*&quot;); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">    class PKey::EC</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="230">
          <span class="hits">11</span>
          
          <code class="ruby">      def private_key_hex; private_key.to_hex.rjust(64, '0'); end</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="231">
          <span class="hits">11</span>
          
          <code class="ruby">      def public_key_hex;  public_key.to_hex.rjust(130, '0'); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">    class PKey::EC::Point</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hex(group, hex)</code>
        </li>
      
        <li class="covered" data-hits="136" data-linenumber="235">
          <span class="hits">136</span>
          
          <code class="ruby">        new(group, BN.from_hex(hex))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="237">
          <span class="hits">128</span>
          
          <code class="ruby">      def to_hex; to_bn.to_hex; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.bn2mpi(hex) BN.from_hex(hex).to_mpi; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="242">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :OpenSSL_EC, &quot;bitcoin/ffi/openssl&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="245">
          <span class="hits">1</span>
          
          <code class="ruby">  extend Util</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">  @network = :bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.network</code>
        </li>
      
        <li class="covered" data-hits="426" data-linenumber="250">
          <span class="hits">426</span>
          
          <code class="ruby">    NETWORKS[@network]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.network= name</code>
        </li>
      
        <li class="covered" data-hits="80" data-linenumber="254">
          <span class="hits">80</span>
          
          <code class="ruby">    @network = name.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">  NETWORKS = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">    :bitcoin =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xF9\xBE\xB4\xD9&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">      :address_version =&gt; &quot;00&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;80&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">      :default_port =&gt; 8333,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">      :dns_seeds =&gt; [&quot;bitseed.xf2.org&quot;, &quot;dnsseed.bluematt.me&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">        &quot;dnsseed.bitcoin.dashjr.org&quot;, &quot;seed.bitcoin.sipa.be&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    :testnet =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xFA\xBF\xB5\xDA&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">      :address_version =&gt; &quot;6f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;ef&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">      :default_port =&gt; 18333,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      :dns_seeds =&gt; [&quot;testseed.bitcoin.interesthings.de&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;00000007199508e34a9ff81e6ec0c477a4cccff2a4767a8eee39c11db367b008&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2dcb72f38404c85bd4fe44aeed3d3b7e4562fc0c">
  <div class="header">
    <h3>lib/bitcoin/ffi/openssl.rb</h3>
    <h4><span class="green">96.77 %</span> covered</h4>
    <div>
      <b>62</b> relevant lines. 
      <span class="green"><b>60</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># autoload when you need to re-generate a public_key from only its private_key.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># ported from: https://github.com/sipa/bitcoin/blob/2d40fe4da9ea82af4b652b691a4185431d6e47a8/key.h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  require 'ffi'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">rescue LoadError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  puts &quot;Cannot load 'ffi' for OpenSSL_EC.regenerate_key. - install with `gem install ffi`&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  exit 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">module OpenSSL_EC</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  extend FFI::Library</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  ffi_lib 'ssl'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  NID_secp256k1 = 714</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :SSL_library_init, [], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :ERR_load_crypto_strings, [], :void</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :SSL_load_error_strings, [], :void</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :RAND_poll, [], :int</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  #attach_function :BN_bin2bn, [:string, :int, :pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_bin2bn, [:pointer, :int, :pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_new_by_curve_name, [:int], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_get0_group, [:pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_new, [], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_CTX_new, [], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_GROUP_get_order, [:pointer, :pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_new, [:pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_mul, [:pointer, :pointer, :pointer, :pointer, :pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_set_private_key, [:pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_set_public_key,  [:pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_CTX_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :i2o_ECPublicKey, [:pointer, :pointer], :uint</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :i2d_ECPrivateKey, [:pointer, :pointer], :int</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # resolve public from private key, using ffi and libssl.so</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  # example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  #   keypair = Bitcoin.generate_key; Bitcoin::OpenSSL_EC.regenerate_key(keypair.first) == keypair</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.regenerate_key(private_key)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="46">
          <span class="hits">34</span>
          
          <code class="ruby">    private_key = [private_key].pack(&quot;H*&quot;) if private_key.bytesize &gt;= (32*2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    #private_key = FFI::MemoryPointer.new(:uint8, private_key.bytesize)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    #                .put_bytes(0, private_key, 0, private_key.bytesize)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="50">
          <span class="hits">34</span>
          
          <code class="ruby">    private_key = FFI::MemoryPointer.from_string(private_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"> </code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="52">
          <span class="hits">34</span>
          
          <code class="ruby">    init_ffi_ssl</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="53">
          <span class="hits">34</span>
          
          <code class="ruby">    eckey = EC_KEY_new_by_curve_name(NID_secp256k1)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="54">
          <span class="hits">34</span>
          
          <code class="ruby">    priv_key = BN_bin2bn(private_key, private_key.size-1, BN_new())</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="56">
          <span class="hits">34</span>
          
          <code class="ruby">    group, order, ctx = EC_KEY_get0_group(eckey), BN_new(), BN_CTX_new()</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="57">
          <span class="hits">34</span>
          
          <code class="ruby">    EC_GROUP_get_order(group, order, ctx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="59">
          <span class="hits">34</span>
          
          <code class="ruby">    pub_key = EC_POINT_new(group)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="60">
          <span class="hits">34</span>
          
          <code class="ruby">    EC_POINT_mul(group, pub_key, priv_key, nil, nil, ctx)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="61">
          <span class="hits">34</span>
          
          <code class="ruby">    EC_KEY_set_private_key(eckey, priv_key)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="62">
          <span class="hits">34</span>
          
          <code class="ruby">    EC_KEY_set_public_key(eckey, pub_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="64">
          <span class="hits">34</span>
          
          <code class="ruby">    BN_free(order)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="65">
          <span class="hits">34</span>
          
          <code class="ruby">    BN_CTX_free(ctx)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="66">
          <span class="hits">34</span>
          
          <code class="ruby">    EC_POINT_free(pub_key)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="67">
          <span class="hits">34</span>
          
          <code class="ruby">    BN_free(priv_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="70">
          <span class="hits">34</span>
          
          <code class="ruby">    length = i2d_ECPrivateKey(eckey, nil)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="71">
          <span class="hits">34</span>
          
          <code class="ruby">    ptr = FFI::MemoryPointer.new(:pointer)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="72">
          <span class="hits">34</span>
          
          <code class="ruby">    priv_hex = if i2d_ECPrivateKey(eckey, ptr) == length</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="73">
          <span class="hits">34</span>
          
          <code class="ruby">      ptr.read_pointer.read_string(length)[9...9+32].unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="76">
          <span class="hits">34</span>
          
          <code class="ruby">    length = i2o_ECPublicKey(eckey, nil)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="77">
          <span class="hits">34</span>
          
          <code class="ruby">    ptr = FFI::MemoryPointer.new(:pointer)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="78">
          <span class="hits">34</span>
          
          <code class="ruby">    pub_hex = if i2o_ECPublicKey(eckey, ptr) == length</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="79">
          <span class="hits">34</span>
          
          <code class="ruby">      ptr.read_pointer.read_string(length).unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="82">
          <span class="hits">34</span>
          
          <code class="ruby">    EC_KEY_free(eckey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="84">
          <span class="hits">34</span>
          
          <code class="ruby">    [ priv_hex, pub_hex ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.init_ffi_ssl</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="88">
          <span class="hits">34</span>
          
          <code class="ruby">    return if @ssl_loaded</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    SSL_library_init()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    ERR_load_crypto_strings()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">    SSL_load_error_strings()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    RAND_poll()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    @ssl_loaded = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="eb82939148b5de4151cdeacc2d9ed89caee32ee5">
  <div class="header">
    <h3>lib/bitcoin/key.rb</h3>
    <h4><span class="green">97.96 %</span> covered</h4>
    <div>
      <b>49</b> relevant lines. 
      <span class="green"><b>48</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # Elliptic Curve key as used in bitcoin.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class Key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    # Generate a new keypair.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    #  Bitcoin::Key.generate</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.generate</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="9">
          <span class="hits">7</span>
          
          <code class="ruby">      k = new; k.generate; k</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # Import private key from base58 fromat as described in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # https://en.bitcoin.it/wiki/Private_key#Base_58_Wallet_Import_format and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # https://en.bitcoin.it/wiki/Base58Check_encoding#Encoding_a_private_key.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # See also #to_base58</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.from_base58(str)</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="17">
          <span class="hits">26</span>
          
          <code class="ruby">      hex = Bitcoin.base58_to_hex(str)</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="18">
          <span class="hits">26</span>
          
          <code class="ruby">      version, key, checksum = hex.unpack(&quot;a2a64a8&quot;)</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="19">
          <span class="hits">26</span>
          
          <code class="ruby">      raise &quot;Invalid version&quot;  unless version == Bitcoin.network[:privkey_version]</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="20">
          <span class="hits">26</span>
          
          <code class="ruby">      raise &quot;Invalid checksum&quot;  unless Bitcoin.checksum(version + key) == checksum</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="21">
          <span class="hits">26</span>
          
          <code class="ruby">      new(key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    def == other</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="25">
          <span class="hits">3</span>
          
          <code class="ruby">      self.priv == other.priv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # Create a new key with given +privkey+ and +pubkey+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    #  Bitcoin::Key.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    #  Bitcoin::Key.new(privkey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    #  Bitcoin::Key.new(nil, pubkey)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize privkey = nil, pubkey = nil</code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="33">
          <span class="hits">150</span>
          
          <code class="ruby">      @key = Bitcoin.bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="34">
          <span class="hits">150</span>
          
          <code class="ruby">      set_priv(privkey)  if privkey</code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="35">
          <span class="hits">150</span>
          
          <code class="ruby">      set_pub(pubkey)  if pubkey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # Generate new priv/pub key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="40">
          <span class="hits">14</span>
          
          <code class="ruby">      @key.generate_key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # Get the private key (in hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    def priv</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="45">
          <span class="hits">69</span>
          
          <code class="ruby">      return nil  unless @key.private_key</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="46">
          <span class="hits">68</span>
          
          <code class="ruby">      @key.private_key.to_hex.rjust(64, '0')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    # Set the private key to +priv+ (in hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    def priv= priv</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      set_priv(priv)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    # Get the public key (in hex).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    # In case the key was initialized with only</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    # a private key, the public key is regenerated.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def pub</code>
        </li>
      
        <li class="covered" data-hits="119" data-linenumber="58">
          <span class="hits">119</span>
          
          <code class="ruby">      unless @key.public_key</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="59">
          <span class="hits">25</span>
          
          <code class="ruby">        if @key.private_key</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="60">
          <span class="hits">23</span>
          
          <code class="ruby">          set_pub(Bitcoin::OpenSSL_EC.regenerate_key(priv)[1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="62">
          <span class="hits">2</span>
          
          <code class="ruby">          return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="65">
          <span class="hits">117</span>
          
          <code class="ruby">      @key.public_key.to_hex.rjust(130, '0')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    # Set the public key (in hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def pub= pub</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      set_pub(pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    # Get the hash160 of the public key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="75">
          <span class="hits">50</span>
          
          <code class="ruby">      Bitcoin.hash160(pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    # Get the address corresponding to the public key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    def addr</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="80">
          <span class="hits">50</span>
          
          <code class="ruby">      Bitcoin.hash160_to_address(hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    # Sign +data+ with the key.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    #  key1 = Bitcoin::Key.generate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    #  sig = key.sign(&quot;some data&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    def sign(data)</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="87">
          <span class="hits">20</span>
          
          <code class="ruby">      @key.dsa_sign_asn1(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # Verify signature +sig+ for +data+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    #  key2 = Bitcoin::Key.new(nil, key1.pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    #  key2.verify(&quot;some data&quot;, sig)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    def verify(data, sig)</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="94">
          <span class="hits">66</span>
          
          <code class="ruby">      @key.dsa_verify_asn1(data, sig)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    # Export private key to base58 format.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    # See also Key.from_base58</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_base58</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="100">
          <span class="hits">15</span>
          
          <code class="ruby">      data = Bitcoin.network[:privkey_version] + priv</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="101">
          <span class="hits">15</span>
          
          <code class="ruby">      Bitcoin.encode_base58(data + Bitcoin.checksum(data))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    # Regenerate public key from the private key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">    def regenerate_pubkey</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      set_pub(Bitcoin::OpenSSL_EC.regenerate_key(priv)[1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    # Set +priv+ as the new private key (converting from hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">    def set_priv(priv)</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="113">
          <span class="hits">67</span>
          
          <code class="ruby">      @key.private_key = OpenSSL::BN.from_hex(priv)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    # Set +pub+ as the new public key (converting from hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">    def set_pub(pub)</code>
        </li>
      
        <li class="covered" data-hits="104" data-linenumber="118">
          <span class="hits">104</span>
          
          <code class="ruby">      @key.public_key = OpenSSL::PKey::EC::Point.from_hex(@key.group, pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f5d6d97008ffec5aff3bc91103ab60ec056c27d1">
  <div class="header">
    <h3>lib/bitcoin/logger.rb</h3>
    <h4><span class="red">67.74 %</span> covered</h4>
    <div>
      <b>31</b> relevant lines. 
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  require 'log4r'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # monkey-patch Log4r to accept level names as symbols</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  class Log4r::Logger</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    def level= l</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      @level = l.is_a?(Fixnum) ? l : Log4r::LNAMES.index(l)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">rescue LoadError</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # log4r not installed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # this is a very simple logger that is used if log4r is not available</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  module Logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    class Logger</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      LEVELS = [:debug, :info, :warn, :error, :fatal]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :level</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(name)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">        @name, @level = name, :info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      def level= level</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="27">
          <span class="hits">60</span>
          
          <code class="ruby">        @level = level.is_a?(Fixnum) ? LEVELS[level] : level.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">      LEVELS.each do |level|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="31">
          <span class="hits">5</span>
          
          <code class="ruby">        define_method(level) do |*msg, &amp;block|</code>
        </li>
      
        <li class="covered" data-hits="586" data-linenumber="32">
          <span class="hits">586</span>
          
          <code class="ruby">          return  if LEVELS.index(level.to_sym) &lt; LEVELS.index(@level.to_sym)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">          msg = block ? block.call : msg.join</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">          puts &quot;#{level.to_s.upcase.ljust(5)} #{@name} #{msg}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    # wrap a logger and prepend a special name in front of the messages</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    class LogWrapper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(name, log); @name, @log = name, log; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      def method_missing(m, *a, &amp;blk)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        @log.send(m, *a, &amp;proc{ &quot;#{@name} #{blk.call}&quot; })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    # create a logger with given +name+. if log4r is installed, the logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # will have a stdout and a fileout outputter to `log/&lt;name&gt;.log`.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    # otherwise, the internal dummy logger is used which only logs to stdout.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.create name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      if defined?(Log4r)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        @log = Log4r::Logger.new(name.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        @log.level = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        @log.outputters &lt;&lt; Log4r::Outputter.stdout</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        @log.outputters &lt;&lt; Log4r::FileOutputter.new(&quot;fout&quot;, :filename =&gt; &quot;log/#{name}.log&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">        @log = Bitcoin::Logger::Logger.new(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      @log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="097a63ca9e1638fe6b84d7fad2f0982e08134c36">
  <div class="header">
    <h3>lib/bitcoin/protocol.rb</h3>
    <h4><span class="red">59.15 %</span> covered</h4>
    <div>
      <b>71</b> relevant lines. 
      <span class="green"><b>42</b> lines covered</span> and
      <span class="red"><b>29</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'socket'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'digest/sha2'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'json'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :TxIn,    'bitcoin/protocol/txin'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :TxOut,   'bitcoin/protocol/txout'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Tx,      'bitcoin/protocol/tx'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Block,   'bitcoin/protocol/block'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Addr,    'bitcoin/protocol/address'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Handler, 'bitcoin/protocol/handler'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Parser,  'bitcoin/protocol/parser'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    VERSION = 31900</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    DNS_Seed = [ &quot;bitseed.xf2.org&quot;, &quot;bitseed.bitcoin.org.uk&quot; ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    Uniq = rand(0xffffffffffffffff)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="4867" data-linenumber="23">
          <span class="hits">4867</span>
          
          <code class="ruby">      case payload.unpack(&quot;C&quot;)[0] # TODO add test cases</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="24">
          <span class="hits">4</span>
          
          <code class="ruby">      when 0xfd; payload.unpack(&quot;xva*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      when 0xfe; payload.unpack(&quot;xVa*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      when 0xff; payload.unpack(&quot;xQa*&quot;) # TODO add little-endian version of Q</code>
        </li>
      
        <li class="covered" data-hits="4862" data-linenumber="27">
          <span class="hits">4862</span>
          
          <code class="ruby">      else;      payload.unpack(&quot;Ca*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.pack_var_int(i)</code>
        </li>
      
        <li class="covered" data-hits="8137" data-linenumber="32">
          <span class="hits">8137</span>
          
          <code class="ruby">      if    i &lt;  0xfd;                [      i].pack(&quot;C&quot;)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="33">
          <span class="hits">10</span>
          
          <code class="ruby">      elsif i &lt;= 0xffff;              [0xfd, i].pack(&quot;Cv&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      elsif i &lt;= 0xffffffff;          [0xfe, i].pack(&quot;CV&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      elsif i &lt;= 0xffffffffffffffff;  [0xff, i].pack(&quot;CQ&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      else raise &quot;int(#{i}) too large!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.pkt(command, payload)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="41">
          <span class="hits">4</span>
          
          <code class="ruby">      cmd      = command.ljust(12, &quot;\x00&quot;)[0...12]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="42">
          <span class="hits">4</span>
          
          <code class="ruby">      length   = [payload.bytesize].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="43">
          <span class="hits">4</span>
          
          <code class="ruby">      checksum = ['version', 'verack'].include?(command) ?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        &quot;&quot; : Digest::SHA256.digest(Digest::SHA256.digest(payload))[0...4]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="46">
          <span class="hits">4</span>
          
          <code class="ruby">      [Bitcoin.network[:magic_head], cmd, length, checksum, payload].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.version_pkt(from_id, from, to, last_block=nil, time=nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      payload = Protocol::VersionPkt.build_payload(from_id, from, to, last_block, time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      pkt(&quot;version&quot;, payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.verack_pkt</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      pkt(&quot;verack&quot;, &quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.getdata_pkt(type, hashes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      return if hashes.size &gt;= 256</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      t = case type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          when :tx;    1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          when :block; 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">          else         0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      pkt(&quot;getdata&quot;, [hashes.size].pack(&quot;C&quot;) +</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        hashes.map{|hash| [t].pack(&quot;I&quot;) + hash[0..32].reverse }.join)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.inv_pkt(type, hashes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      return if hashes.size &gt;= 256</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      t = case type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">          when :tx;    1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">          when :block; 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">          else         0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      pkt(&quot;inv&quot;, [hashes.size].pack(&quot;C&quot;) +</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        hashes.map{|hash| [t].pack(&quot;I&quot;) + hash[0..32].reverse }.join)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    class VersionPkt &lt; Struct.new(:version, :services, :timestamp, :to, :from, :block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      # parse packet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.parse(payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">        version, services, timestamp, to, from, block = payload.unpack(&quot;Ia8Qa26a26x9I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">        to, from = parse_ip(to), parse_ip(from)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">        new(version, services, timestamp, to, from, block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.parse_ip(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="92">
          <span class="hits">2</span>
          
          <code class="ruby">        service, ip, port = payload.unpack(&quot;Qx12a4n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="93">
          <span class="hits">2</span>
          
          <code class="ruby">        { :service =&gt; service, :ip =&gt; ip.unpack(&quot;C*&quot;), :port =&gt; port }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      # build packet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.build_address(addr_str)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        host, port = addr_str.split(&quot;:&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        port = port ? port.to_i : 8333</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        sockaddr = Socket.pack_sockaddr_in(port, host)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        #raise &quot;invalid IPv4 Address: #{addr}&quot; unless sockaddr[0...2] == &quot;\x02\x00&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        port, host = sockaddr[2...4], sockaddr[4...8]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        [[1].pack(&quot;Q&quot;), &quot;\x00&quot;*10, &quot;\xFF\xFF&quot;,  host, port].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.build_payload(from_id, from, to, last_block=nil, time=nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        ver, services, time = [Bitcoin::Protocol::VERSION, 1, time || Time.now.tv_sec].pack(&quot;IQQ&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">        payload = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">          ver, services, time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">          build_address(from),  # me</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          build_address(to),    # you</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">          [ from_id ].pack(&quot;Q&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">          &quot;\x00&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">          [last_block || 0].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        ].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">  P = Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7232aa03263e2a301dcf3642c61bc0272ac13cbf">
  <div class="header">
    <h3>lib/bitcoin/protocol/address.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>18</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class Addr &lt; Struct.new(:time, :service, :ip, :port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      # create addr from raw binary +data+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data = nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="8">
          <span class="hits">5</span>
          
          <code class="ruby">        if data</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">          self[:time], self[:service], self[:ip], self[:port] = data.unpack(&quot;IQx12a4n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">          self[:ip] = ip.unpack(&quot;C*&quot;).join(&quot;.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="12">
          <span class="hits">3</span>
          
          <code class="ruby">          self[:time], self[:service] = Time.now.to_i, 1</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="13">
          <span class="hits">3</span>
          
          <code class="ruby">          self[:ip], self[:port] = &quot;127.0.0.1&quot;, Bitcoin.network[:default_port]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # is this address alive?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      def alive?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">        (Time.now.tv_sec-7200) &lt;= self[:time]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="23">
          <span class="hits">4</span>
          
          <code class="ruby">        ip = self[:ip].split(&quot;.&quot;).map(&amp;:to_i)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="24">
          <span class="hits">4</span>
          
          <code class="ruby">        [ time, service, (&quot;\x00&quot;*10)+&quot;\xff\xff&quot;, *ip, port ].pack(&quot;IQa12C4n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.pkt(*addrs)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">        addrs = addrs.select{|i| i.is_a?(Bitcoin::Protocol::Addr) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">        length = Bitcoin::Protocol.pack_var_int(addrs.size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">        Bitcoin::Protocol.pkt(&quot;addr&quot;, length + addrs.map(&amp;:to_payload).join)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b85bdf561b3dc51ecfd89215f675dc4ae6ab50a3">
  <div class="header">
    <h3>lib/bitcoin/protocol/block.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>46</b> relevant lines. 
      <span class="green"><b>46</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class Block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :hash, :payload, :tx, :ver, :prev_block, :mrkl_root, :time, :bits, :nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      # compare to another block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="covered" data-hits="523" data-linenumber="9">
          <span class="hits">523</span>
          
          <code class="ruby">        @hash == other.hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # create block from raw binary +data+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data)</code>
        </li>
      
        <li class="covered" data-hits="328" data-linenumber="14">
          <span class="hits">328</span>
          
          <code class="ruby">        @tx = []</code>
        </li>
      
        <li class="covered" data-hits="328" data-linenumber="15">
          <span class="hits">328</span>
          
          <code class="ruby">        parse_data(data) if data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # parse raw binary data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="323" data-linenumber="20">
          <span class="hits">323</span>
          
          <code class="ruby">        @ver, @prev_block, @mrkl_root, @time, @bits, @nonce, payload = data.unpack(&quot;Ia32a32IIIa*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="323" data-linenumber="21">
          <span class="hits">323</span>
          
          <code class="ruby">        recalc_block_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="322" data-linenumber="23">
          <span class="hits">322</span>
          
          <code class="ruby">        tx_size, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="864" data-linenumber="24">
          <span class="hits">864</span>
          
          <code class="ruby">        (0...tx_size).each{  break if payload == true</code>
        </li>
      
        <li class="covered" data-hits="542" data-linenumber="25">
          <span class="hits">542</span>
          
          <code class="ruby">          t = Tx.new(nil)</code>
        </li>
      
        <li class="covered" data-hits="542" data-linenumber="26">
          <span class="hits">542</span>
          
          <code class="ruby">          payload = t.parse_data(payload)</code>
        </li>
      
        <li class="covered" data-hits="542" data-linenumber="27">
          <span class="hits">542</span>
          
          <code class="ruby">          @tx &lt;&lt; t</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="322" data-linenumber="30">
          <span class="hits">322</span>
          
          <code class="ruby">        @payload = to_payload</code>
        </li>
      
        <li class="covered" data-hits="322" data-linenumber="31">
          <span class="hits">322</span>
          
          <code class="ruby">        payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      # recalculate the block hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      def recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="572" data-linenumber="36">
          <span class="hits">572</span>
          
          <code class="ruby">        @hash = Bitcoin.block_hash(hth(@prev_block), hth(@mrkl_root), @time, @bits, @nonce, @ver)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # get the block header info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      # [&lt;version&gt;, &lt;prev_block&gt;, &lt;merkle_root&gt;, &lt;time&gt;, &lt;bits&gt;, &lt;nonce&gt;, &lt;txcount&gt;, &lt;size&gt;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      def header_info</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="42">
          <span class="hits">2</span>
          
          <code class="ruby">        [@ver, hth(@prev_block), hth(@mrkl_root), Time.at(@time), @bits, @nonce, @tx.size, @payload.size]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1211" data-linenumber="45">
          <span class="hits">1211</span>
          
          <code class="ruby">      def hth(h); h.reverse.unpack(&quot;H*&quot;)[0]; end</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="46">
          <span class="hits">9</span>
          
          <code class="ruby">      def htb(s); [s].pack('H*').reverse; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      # convert to raw binary format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="346" data-linenumber="50">
          <span class="hits">346</span>
          
          <code class="ruby">        head = [@ver, @prev_block, @mrkl_root, @time, @bits, @nonce].pack(&quot;Ia32a32III&quot;)</code>
        </li>
      
        <li class="covered" data-hits="346" data-linenumber="51">
          <span class="hits">346</span>
          
          <code class="ruby">        [head, Protocol.pack_var_int(@tx.size), @tx.map(&amp;:to_payload).join].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      # convert to ruby hash (see also #from_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">          'hash' =&gt; @hash, 'ver' =&gt; @ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">          'prev_block' =&gt; hth(@prev_block), 'mrkl_root' =&gt; hth(@mrkl_root),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">          'time' =&gt; @time, 'bits' =&gt; @bits, 'nonce' =&gt; @nonce,</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="60">
          <span class="hits">29</span>
          
          <code class="ruby">          'n_tx' =&gt; @tx.size, 'size' =&gt; (@payload||to_payload).bytesize,</code>
        </li>
      
        <li class="covered" data-hits="139" data-linenumber="61">
          <span class="hits">139</span>
          
          <code class="ruby">          'tx' =&gt; @tx.map{|i| i.to_hash },</code>
        </li>
      
        <li class="covered" data-hits="139" data-linenumber="62">
          <span class="hits">139</span>
          
          <code class="ruby">          'mrkl_tree' =&gt; Bitcoin.hash_mrkl_tree( @tx.map{|i| i.hash } )</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="63">
          <span class="hits">29</span>
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      # convert to json representation as seen in the block explorer.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      # (see also #from_json)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_json(options = {:space =&gt; ''}, *a)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="69">
          <span class="hits">4</span>
          
          <code class="ruby">        JSON.pretty_generate( to_hash, options )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      # parse ruby hash (see also #to_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash(h)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="74">
          <span class="hits">4</span>
          
          <code class="ruby">        blk = new(nil)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="75">
          <span class="hits">4</span>
          
          <code class="ruby">        blk.instance_eval{</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="76">
          <span class="hits">4</span>
          
          <code class="ruby">          @ver, @time, @bits, @nonce = h.values_at('ver', 'time', 'bits', 'nonce')</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="77">
          <span class="hits">12</span>
          
          <code class="ruby">          @prev_block, @mrkl_root = h.values_at('prev_block', 'mrkl_root').map{|i| htb(i) }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="78">
          <span class="hits">4</span>
          
          <code class="ruby">          recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="118" data-linenumber="79">
          <span class="hits">118</span>
          
          <code class="ruby">          h['tx'].each{|tx| @tx &lt;&lt; Tx.from_hash(tx) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="81">
          <span class="hits">4</span>
          
          <code class="ruby">        blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      # convert ruby hash to raw binary</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.binary_from_hash(h); from_hash(h).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      # parse json representation (see also #to_json)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="88">
          <span class="hits">5</span>
          
          <code class="ruby">      def self.from_json(json_string); from_hash( JSON.load(json_string) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      # convert json representation to raw binary</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.binary_from_json(json_string); from_json(json_string).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ec26a72c762bc13eda908614b56e96d8669a4d80">
  <div class="header">
    <h3>lib/bitcoin/protocol/handler.rb</h3>
    <h4><span class="red">61.11 %</span> covered</h4>
    <div>
      <b>18</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class Handler</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_inv_transaction(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">        p ['inv transaction', hth(hash)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_inv_block(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        p ['inv block', hth(hash)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_get_transaction(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        p ['get transaction', hth(hash)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_get_block(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        p ['get block', hth(hash)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_addr(addr)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        p ['addr', addr, addr.alive?]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        p ['tx', tx]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_block(block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        #p ['block', block]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        puts block.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="34">
          <span class="hits">6</span>
          
          <code class="ruby">      def hth(h); h.unpack(&quot;H*&quot;)[0]; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="557ee148bb367f942116155fdc327b5fa7942241">
  <div class="header">
    <h3>lib/bitcoin/protocol/parser.rb</h3>
    <h4><span class="red">77.46 %</span> covered</h4>
    <div>
      <b>71</b> relevant lines. 
      <span class="green"><b>55</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class Parser</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(handler=nil)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="6">
          <span class="hits">8</span>
          
          <code class="ruby">        @h = handler || Handler.new</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="7">
          <span class="hits">8</span>
          
          <code class="ruby">        @buf = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # handles inv/getdata packets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_inv(payload, type=:put)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="13">
          <span class="hits">5</span>
          
          <code class="ruby">        count, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="14">
          <span class="hits">5</span>
          
          <code class="ruby">        payload.each_byte.each_slice(36){|i|</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="15">
          <span class="hits">7</span>
          
          <code class="ruby">          hash = i[4..-1].reverse.pack(&quot;C32&quot;)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="16">
          <span class="hits">7</span>
          
          <code class="ruby">          case i[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">          when 1</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="18">
          <span class="hits">5</span>
          
          <code class="ruby">            if type == :put</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="19">
          <span class="hits">4</span>
          
          <code class="ruby">              @h.on_inv_transaction(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">              @h.on_get_transaction(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">          when 2</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">            if type == :put</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">              @h.on_inv_block(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">              @h.on_get_block(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">            p ['parse_inv error', i]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      def hth(h); h.unpack(&quot;H*&quot;)[0]; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_addr(payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">        count, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">        payload.each_byte.each_slice(30){|i|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">          @h.on_addr( Addr.new(i.pack(&quot;C*&quot;)) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_headers(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        count, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        idx = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        headers = count.times.map{ Block.new(payload[idx..idx+=81]) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        @h.on_headers(headers)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      def process_pkt(command, payload)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="52">
          <span class="hits">7</span>
          
          <code class="ruby">        case command</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        when 'tx';       @h.on_tx( Tx.new(payload) )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        when 'block';    @h.on_block( Block.new(payload) )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        when 'headers';  parse_headers(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="56">
          <span class="hits">3</span>
          
          <code class="ruby">        when 'inv';      parse_inv(payload, :put)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="57">
          <span class="hits">2</span>
          
          <code class="ruby">        when 'getdata';  parse_inv(payload, :get)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">        when 'addr';     parse_addr(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        when 'verack';   @h.on_handshake_complete # nop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">        when 'version';  parse_version(payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          p ['unkown-packet', command, payload]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_version(payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">        version = Bitcoin::Protocol::VersionPkt.parse(payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">        @h.on_version(version)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse(buf)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="72">
          <span class="hits">8</span>
          
          <code class="ruby">        @buf += buf</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="73">
          <span class="hits">8</span>
          
          <code class="ruby">        while parse_buffer; end</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="74">
          <span class="hits">8</span>
          
          <code class="ruby">        @buf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_buffer</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="78">
          <span class="hits">14</span>
          
          <code class="ruby">        head_magic = Bitcoin::network[:magic_head]</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="79">
          <span class="hits">14</span>
          
          <code class="ruby">        head_size  = 24</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="80">
          <span class="hits">14</span>
          
          <code class="ruby">        return false if @buf.size &lt;= head_size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="82">
          <span class="hits">8</span>
          
          <code class="ruby">        magic, cmd, length, checksum = @buf.unpack(&quot;a4A12Ia4&quot;)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="83">
          <span class="hits">8</span>
          
          <code class="ruby">        payload = @buf[head_size...head_size+length]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="85">
          <span class="hits">8</span>
          
          <code class="ruby">        unless magic == head_magic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">          handle_error(:close, &quot;head_magic not found&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">          @buf = ''</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="90">
          <span class="hits">7</span>
          
          <code class="ruby">          if ['version', 'verack'].include?(cmd)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">            head_size -= 4</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">            payload = @buf[head_size...head_size+length]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="94">
          <span class="hits">6</span>
          
          <code class="ruby">            if Digest::SHA256.digest(Digest::SHA256.digest( payload ))[0...4] != checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">              if (length &lt; 50000) &amp;&amp; (payload.size &lt; length)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">                size_info = [payload.size, length].join('/')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">                handle_error(:debug, &quot;chunked packet stream (#{size_info})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">                handle_error(:close, &quot;checksum mismatch&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">              return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="104">
          <span class="hits">7</span>
          
          <code class="ruby">          @buf = @buf[head_size+length..-1] || &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="106">
          <span class="hits">7</span>
          
          <code class="ruby">          process_pkt(cmd, payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        # not empty yet? parse more.</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="110">
          <span class="hits">8</span>
          
          <code class="ruby">        @buf[0] != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">      def handle_error(type, msg)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">        case type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">        when :close</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">          puts &quot;closing packet stream (#{msg})&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">          p [type, msg]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end # Parser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="50420e37470493cafba8f41ed05b633a062fcdf4">
  <div class="header">
    <h3>lib/bitcoin/protocol/tx.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>115</b> relevant lines. 
      <span class="green"><b>115</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'bitcoin/script'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class Tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :hash, :in, :out, :payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :ver, :lock_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # compare to another tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="covered" data-hits="221" data-linenumber="12">
          <span class="hits">221</span>
          
          <code class="ruby">        @hash == other.hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # return the tx hash in binary format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      def binary_hash</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="17">
          <span class="hits">4</span>
          
          <code class="ruby">        [@hash].pack(&quot;H*&quot;).reverse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # create tx from raw binary +data+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data=nil)</code>
        </li>
      
        <li class="covered" data-hits="910" data-linenumber="22">
          <span class="hits">910</span>
          
          <code class="ruby">        @ver, @lock_time = 1, 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="910" data-linenumber="24">
          <span class="hits">910</span>
          
          <code class="ruby">        parse_data(data) if data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      # generate the tx hash for given +payload+ in hex format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      def hash_from_payload(payload)</code>
        </li>
      
        <li class="covered" data-hits="1167" data-linenumber="29">
          <span class="hits">1167</span>
          
          <code class="ruby">        Digest::SHA256.digest(Digest::SHA256.digest( payload )).reverse.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      alias generate_hash hash_from_payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      # add an input</code>
        </li>
      
        <li class="covered" data-hits="517" data-linenumber="34">
          <span class="hits">517</span>
          
          <code class="ruby">      def add_in(input); (@in ||= []) &lt;&lt; input; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      # add an output</code>
        </li>
      
        <li class="covered" data-hits="960" data-linenumber="37">
          <span class="hits">960</span>
          
          <code class="ruby">      def add_out(output); (@out ||= []) &lt;&lt; output; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # parse raw binary data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="41">
          <span class="hits">765</span>
          
          <code class="ruby">        @ver = data.unpack(&quot;I&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="42">
          <span class="hits">765</span>
          
          <code class="ruby">        idx = 4</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="43">
          <span class="hits">765</span>
          
          <code class="ruby">        in_size, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="44">
          <span class="hits">765</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize-tmp.bytesize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        # raise &quot;unkown transaction version: #{@ver}&quot; unless @ver == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="765" data-linenumber="47">
          <span class="hits">765</span>
          
          <code class="ruby">        @in = (0...in_size).map{</code>
        </li>
      
        <li class="covered" data-hits="1037" data-linenumber="48">
          <span class="hits">1037</span>
          
          <code class="ruby">          txin = TxIn.new</code>
        </li>
      
        <li class="covered" data-hits="1037" data-linenumber="49">
          <span class="hits">1037</span>
          
          <code class="ruby">          idx += txin.parse_data(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="50">
          <span class="hits">1036</span>
          
          <code class="ruby">          txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="764" data-linenumber="53">
          <span class="hits">764</span>
          
          <code class="ruby">        out_size, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="764" data-linenumber="54">
          <span class="hits">764</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize-tmp.bytesize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="764" data-linenumber="56">
          <span class="hits">764</span>
          
          <code class="ruby">        @out = (0...out_size).map{</code>
        </li>
      
        <li class="covered" data-hits="1973" data-linenumber="57">
          <span class="hits">1973</span>
          
          <code class="ruby">          txout = TxOut.new</code>
        </li>
      
        <li class="covered" data-hits="1973" data-linenumber="58">
          <span class="hits">1973</span>
          
          <code class="ruby">          idx += txout.parse_data(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="1973" data-linenumber="59">
          <span class="hits">1973</span>
          
          <code class="ruby">          txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="764" data-linenumber="62">
          <span class="hits">764</span>
          
          <code class="ruby">        @lock_time = data[idx...idx+=4].unpack(&quot;I&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="764" data-linenumber="64">
          <span class="hits">764</span>
          
          <code class="ruby">        @payload = data[0...idx]</code>
        </li>
      
        <li class="covered" data-hits="764" data-linenumber="65">
          <span class="hits">764</span>
          
          <code class="ruby">        @hash = hash_from_payload(@payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="764" data-linenumber="67">
          <span class="hits">764</span>
          
          <code class="ruby">        if data[idx] == nil</code>
        </li>
      
        <li class="covered" data-hits="542" data-linenumber="68">
          <span class="hits">542</span>
          
          <code class="ruby">          true          # reached the end.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="222" data-linenumber="70">
          <span class="hits">222</span>
          
          <code class="ruby">          data[idx..-1] # rest of buffer.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      # output transaction in raw binary format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="1224" data-linenumber="76">
          <span class="hits">1224</span>
          
          <code class="ruby">        pin = @in.map{|i|</code>
        </li>
      
        <li class="covered" data-hits="1497" data-linenumber="77">
          <span class="hits">1497</span>
          
          <code class="ruby">          buf =  [ i.prev_out, i.prev_out_index ].pack(&quot;a32I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1497" data-linenumber="78">
          <span class="hits">1497</span>
          
          <code class="ruby">          buf &lt;&lt; Protocol.pack_var_int(i.script_sig_length)</code>
        </li>
      
        <li class="covered" data-hits="1497" data-linenumber="79">
          <span class="hits">1497</span>
          
          <code class="ruby">          buf &lt;&lt; i.script_sig if i.script_sig_length &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="1497" data-linenumber="80">
          <span class="hits">1497</span>
          
          <code class="ruby">          buf &lt;&lt; (i.sequence || &quot;\xff\xff\xff\xff&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">        }.join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1224" data-linenumber="83">
          <span class="hits">1224</span>
          
          <code class="ruby">        pout = @out.map{|o|</code>
        </li>
      
        <li class="covered" data-hits="3771" data-linenumber="84">
          <span class="hits">3771</span>
          
          <code class="ruby">          buf =  [ o.value ].pack(&quot;Q&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3771" data-linenumber="85">
          <span class="hits">3771</span>
          
          <code class="ruby">          buf &lt;&lt; Protocol.pack_var_int(o.pk_script_length)</code>
        </li>
      
        <li class="covered" data-hits="3771" data-linenumber="86">
          <span class="hits">3771</span>
          
          <code class="ruby">          buf &lt;&lt; o.pk_script if o.pk_script_length &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="3771" data-linenumber="87">
          <span class="hits">3771</span>
          
          <code class="ruby">          buf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        }.join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1224" data-linenumber="90">
          <span class="hits">1224</span>
          
          <code class="ruby">        in_size, out_size = Protocol.pack_var_int(@in.size), Protocol.pack_var_int(@out.size)</code>
        </li>
      
        <li class="covered" data-hits="1224" data-linenumber="91">
          <span class="hits">1224</span>
          
          <code class="ruby">        [[@ver].pack(&quot;I&quot;), in_size, pin, out_size, pout, [@lock_time].pack(&quot;I&quot;)].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      # generate a signature hash for input +input_idx+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      # either pass the +outpoint_tx+ or the +script_pubkey+ directly.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">      def signature_hash_for_input(input_idx, outpoint_tx, script_pubkey=nil, hash_type=nil, drop_sigs=nil, script=nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        # https://github.com/bitcoin/bitcoin/blob/e071a3f6c06f41068ad17134189a4ac3073ef76b/script.cpp#L834</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        # http://code.google.com/p/bitcoinj/source/browse/trunk/src/com/google/bitcoin/core/Script.java#318</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="99">
          <span class="hits">37</span>
          
          <code class="ruby">        pin  = @in.map.with_index{|i,idx|</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="100">
          <span class="hits">42</span>
          
          <code class="ruby">          if idx == input_idx</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="101">
          <span class="hits">37</span>
          
          <code class="ruby">            script_pubkey ||= outpoint_tx.out[ i.prev_out_index ].pk_script</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="102">
          <span class="hits">37</span>
          
          <code class="ruby">            script_pubkey = Bitcoin::Script.binary_from_string(script)                if script    # force this string a script</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="103">
          <span class="hits">37</span>
          
          <code class="ruby">            script_pubkey = Bitcoin::Script.drop_signatures(script_pubkey, drop_sigs) if drop_sigs # array of signature to drop</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="104">
          <span class="hits">37</span>
          
          <code class="ruby">            length = script_pubkey.bytesize</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="105">
          <span class="hits">37</span>
          
          <code class="ruby">            [ i.prev_out, i.prev_out_index, length, script_pubkey, i.sequence || &quot;\xff\xff\xff\xff&quot; ].pack(&quot;a32ICa#{length}a4&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="107">
          <span class="hits">5</span>
          
          <code class="ruby">            [ i.prev_out, i.prev_out_index, 0, i.sequence || &quot;\xff\xff\xff\xff&quot; ].pack(&quot;a32ICa4&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        }.join</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="110">
          <span class="hits">37</span>
          
          <code class="ruby">        pout = @out.map{|o|</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="111">
          <span class="hits">65</span>
          
          <code class="ruby">          [ o.value, o.pk_script_length, o.pk_script ].pack(&quot;QCa#{o.pk_script_length}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">        }.join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="114">
          <span class="hits">37</span>
          
          <code class="ruby">        hash_type ||= 1 # 1: ALL, 2: NONE, 3: SINGLE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="116">
          <span class="hits">37</span>
          
          <code class="ruby">        in_size, out_size = Protocol.pack_var_int(@in.size), Protocol.pack_var_int(@out.size)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="117">
          <span class="hits">37</span>
          
          <code class="ruby">        buf = [[@ver].pack(&quot;I&quot;), in_size, pin, out_size, pout, [@lock_time].pack(&quot;I&quot;)].join + [hash_type].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="118">
          <span class="hits">37</span>
          
          <code class="ruby">        Digest::SHA256.digest( Digest::SHA256.digest( buf ) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      # verify input signature +in_idx+ against the corresponding</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      # output in +outpoint_tx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">      def verify_input_signature(in_idx, outpoint_tx)</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="124">
          <span class="hits">19</span>
          
          <code class="ruby">        outpoint_idx  = @in[in_idx].prev_out_index</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="125">
          <span class="hits">19</span>
          
          <code class="ruby">        script_sig    = @in[in_idx].script_sig</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="126">
          <span class="hits">19</span>
          
          <code class="ruby">        script_pubkey = outpoint_tx.out[outpoint_idx].pk_script</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="127">
          <span class="hits">19</span>
          
          <code class="ruby">        script        = script_sig + script_pubkey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="129">
          <span class="hits">19</span>
          
          <code class="ruby">        Bitcoin::Script.new(script).run do |pubkey,sig,hash_type,drop_sigs,script|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">          # this IS the checksig callback, must return true/false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          #p ['checksig', pubkey, sig, hash_type, drop_sigs, script]</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="132">
          <span class="hits">23</span>
          
          <code class="ruby">          hash = signature_hash_for_input(in_idx, outpoint_tx, nil, hash_type, drop_sigs, script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          #hash = signature_hash_for_input(in_idx, nil, script_pubkey, hash_type, drop_sigs, script)</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="134">
          <span class="hits">23</span>
          
          <code class="ruby">          Bitcoin.verify_signature( hash, sig, pubkey.unpack(&quot;H*&quot;)[0] )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      # convert to ruby hash (see also #from_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">          'hash' =&gt; @hash, 'ver' =&gt; @ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">          'vin_sz' =&gt; @in.size, 'vout_sz' =&gt; @out.size,</code>
        </li>
      
        <li class="covered" data-hits="153" data-linenumber="143">
          <span class="hits">153</span>
          
          <code class="ruby">          'lock_time' =&gt; @lock_time, 'size' =&gt; (@payload ||= to_payload).bytesize,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">          'in' =&gt; @in.map.with_index{|i,idx|</code>
        </li>
      
        <li class="covered" data-hits="201" data-linenumber="145">
          <span class="hits">201</span>
          
          <code class="ruby">            t = { 'prev_out'  =&gt; { 'hash' =&gt; hth(i.prev_out), 'n' =&gt; i.prev_out_index } }</code>
        </li>
      
        <li class="covered" data-hits="201" data-linenumber="146">
          <span class="hits">201</span>
          
          <code class="ruby">            unless (idx == 0) &amp;&amp; i.coinbase?</code>
        </li>
      
        <li class="covered" data-hits="171" data-linenumber="147">
          <span class="hits">171</span>
          
          <code class="ruby">              t['scriptSig'] = Bitcoin::Script.new(i.script_sig).to_string</code>
        </li>
      
        <li class="covered" data-hits="171" data-linenumber="148">
          <span class="hits">171</span>
          
          <code class="ruby">              t['sequence']  = i.sequence.unpack(&quot;I&quot;)[0] unless i.sequence == &quot;\xff\xff\xff\xff&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">            else # coinbase tx</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="150">
          <span class="hits">30</span>
          
          <code class="ruby">              t['coinbase']  = i.script_sig.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="201" data-linenumber="152">
          <span class="hits">201</span>
          
          <code class="ruby">            t</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">          },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">          'out' =&gt; @out.map{|o|{</code>
        </li>
      
        <li class="covered" data-hits="666" data-linenumber="155">
          <span class="hits">666</span>
          
          <code class="ruby">            'value' =&gt; &quot;%.8f&quot; % (o.value / 100000000.0),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">            'scriptPubKey' =&gt; Bitcoin::Script.new(o.pk_script).to_string</code>
        </li>
      
        <li class="covered" data-hits="666" data-linenumber="157">
          <span class="hits">666</span>
          
          <code class="ruby">          }}</code>
        </li>
      
        <li class="covered" data-hits="153" data-linenumber="158">
          <span class="hits">153</span>
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">      def hth(s)</code>
        </li>
      
        <li class="covered" data-hits="201" data-linenumber="162">
          <span class="hits">201</span>
          
          <code class="ruby">        s.reverse.unpack('H*')[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      # generates rawblock json as seen in the block explorer.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_json(options = {:space =&gt; ''}, *a)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="167">
          <span class="hits">7</span>
          
          <code class="ruby">        JSON.pretty_generate( to_hash, options )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      # parse ruby hash (see also #to_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash(h)</code>
        </li>
      
        <li class="covered" data-hits="129" data-linenumber="172">
          <span class="hits">129</span>
          
          <code class="ruby">        tx = new(nil)</code>
        </li>
      
        <li class="covered" data-hits="129" data-linenumber="173">
          <span class="hits">129</span>
          
          <code class="ruby">        tx.ver, tx.lock_time = *h.values_at('ver', 'lock_time')</code>
        </li>
      
        <li class="covered" data-hits="129" data-linenumber="174">
          <span class="hits">129</span>
          
          <code class="ruby">        h['in'].each{|input|</code>
        </li>
      
        <li class="covered" data-hits="177" data-linenumber="175">
          <span class="hits">177</span>
          
          <code class="ruby">          txin = TxIn.new(htb(input['prev_out']['hash']), input['prev_out']['n'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="177" data-linenumber="177">
          <span class="hits">177</span>
          
          <code class="ruby">          if input['coinbase']</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="178">
          <span class="hits">5</span>
          
          <code class="ruby">            coinbase_data = [ input['coinbase'] ].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="179">
          <span class="hits">5</span>
          
          <code class="ruby">            txin.script_sig_length = coinbase_data.bytesize</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="180">
          <span class="hits">5</span>
          
          <code class="ruby">            txin.script_sig = coinbase_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="172" data-linenumber="182">
          <span class="hits">172</span>
          
          <code class="ruby">            script_data = Script.binary_from_string(input['scriptSig'])</code>
        </li>
      
        <li class="covered" data-hits="172" data-linenumber="183">
          <span class="hits">172</span>
          
          <code class="ruby">            txin.script_sig_length = script_data.bytesize</code>
        </li>
      
        <li class="covered" data-hits="172" data-linenumber="184">
          <span class="hits">172</span>
          
          <code class="ruby">            txin.script_sig = script_data</code>
        </li>
      
        <li class="covered" data-hits="172" data-linenumber="185">
          <span class="hits">172</span>
          
          <code class="ruby">            txin.sequence = [ input['sequence'] || 0xffffffff ].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">          # txin.sequence = ??</code>
        </li>
      
        <li class="covered" data-hits="177" data-linenumber="189">
          <span class="hits">177</span>
          
          <code class="ruby">          tx.add_in(txin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="129" data-linenumber="191">
          <span class="hits">129</span>
          
          <code class="ruby">        h['out'].each{|output|</code>
        </li>
      
        <li class="covered" data-hits="641" data-linenumber="192">
          <span class="hits">641</span>
          
          <code class="ruby">          value = output['value'].gsub('.','').to_i</code>
        </li>
      
        <li class="covered" data-hits="641" data-linenumber="193">
          <span class="hits">641</span>
          
          <code class="ruby">          script_data = Script.binary_from_string(output['scriptPubKey'])</code>
        </li>
      
        <li class="covered" data-hits="641" data-linenumber="194">
          <span class="hits">641</span>
          
          <code class="ruby">          tx.add_out( TxOut.new(value, script_data.bytesize, script_data) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="258" data-linenumber="197">
          <span class="hits">258</span>
          
          <code class="ruby">        tx.instance_eval{ @hash = hash_from_payload(@payload = to_payload) }</code>
        </li>
      
        <li class="covered" data-hits="129" data-linenumber="198">
          <span class="hits">129</span>
          
          <code class="ruby">        tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      # convert ruby hash to raw binary</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="202">
          <span class="hits">4</span>
          
          <code class="ruby">      def self.binary_from_hash(h); from_hash(h).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">      # parse json representation</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="205">
          <span class="hits">12</span>
          
          <code class="ruby">      def self.from_json(json_string); from_hash( JSON.load(json_string) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">      # convert json representation to raw binary</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="208">
          <span class="hits">2</span>
          
          <code class="ruby">      def self.binary_from_json(json_string); from_json(json_string).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="210">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.htb(s)</code>
        </li>
      
        <li class="covered" data-hits="177" data-linenumber="211">
          <span class="hits">177</span>
          
          <code class="ruby">        [s].pack('H*').reverse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1535735601f850f0edb630e497ee3ca0f6253a95">
  <div class="header">
    <h3>lib/bitcoin/protocol/txin.rb</h3>
    <h4><span class="red">64.86 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>24</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxIn</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :prev_out, :prev_out_index, :script_sig_length, :script_sig, :sequence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        @prev_out, @prev_out_index, @script_sig_length,</code>
        </li>
      
        <li class="covered" data-hits="1228" data-linenumber="10">
          <span class="hits">1228</span>
          
          <code class="ruby">        @script_sig, @sequence = *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      # compare to another txout</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        @prev_out == other.prev_out &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="529" data-linenumber="16">
          <span class="hits">529</span>
          
          <code class="ruby">          @prev_out_index == other.prev_out_index &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">          @script_sig == other.script_sig &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">          @sequence == other.sequence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def [] idx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        case idx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        when 0 then @prev_out</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        when 1 then @prev_out_index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        when 2 then @script_sig_length</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        when 3 then @script_sig</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        when 4 then @sequence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      def []= idx, val</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        case idx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        when 0 then @prev_out = val</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        when 1 then @prev_out_index = val</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        when 2 then @script_sig_length = val</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        when 3 then @script_sig = val</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        when 4 then @sequence = val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # parse raw binary data for transaction input</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="1037" data-linenumber="43">
          <span class="hits">1037</span>
          
          <code class="ruby">        idx = 0</code>
        </li>
      
        <li class="covered" data-hits="1037" data-linenumber="44">
          <span class="hits">1037</span>
          
          <code class="ruby">        @prev_out, @prev_out_index = data[idx...idx+=36].unpack(&quot;a32I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1037" data-linenumber="45">
          <span class="hits">1037</span>
          
          <code class="ruby">        @script_sig_length, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="46">
          <span class="hits">1036</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize - tmp.bytesize</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="47">
          <span class="hits">1036</span>
          
          <code class="ruby">        @script_sig = data[idx...idx+=@script_sig_length]</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="48">
          <span class="hits">1036</span>
          
          <code class="ruby">        @sequence = data[idx...idx+=4]</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="49">
          <span class="hits">1036</span>
          
          <code class="ruby">        idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      # previous output in hex</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      def previous_output</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        @prev_out.reverse.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">      def coinbase?</code>
        </li>
      
        <li class="covered" data-hits="343" data-linenumber="58">
          <span class="hits">343</span>
          
          <code class="ruby">        (@prev_out_index == 4294967295) &amp;&amp; (@prev_out == &quot;\x00&quot;*32)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">      def script_sig=(script_sig)</code>
        </li>
      
        <li class="covered" data-hits="518" data-linenumber="62">
          <span class="hits">518</span>
          
          <code class="ruby">        @script_sig_length = script_sig.bytesize</code>
        </li>
      
        <li class="covered" data-hits="518" data-linenumber="63">
          <span class="hits">518</span>
          
          <code class="ruby">        @script_sig = script_sig</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="925463098a998a603cae90a61e90032defc0f861">
  <div class="header">
    <h3>lib/bitcoin/protocol/txout.rb</h3>
    <h4><span class="red">64.29 %</span> covered</h4>
    <div>
      <b>28</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxOut</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :value, :pk_script_length, :pk_script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize *args</code>
        </li>
      
        <li class="covered" data-hits="2639" data-linenumber="9">
          <span class="hits">2639</span>
          
          <code class="ruby">        @value, @pk_script_length, @pk_script = *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # compare to another txout</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="covered" data-hits="645" data-linenumber="14">
          <span class="hits">645</span>
          
          <code class="ruby">        @value == other.value &amp;&amp; @pk_script == other.pk_script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      def [] idx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        case idx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        when 0 then @value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        when 1 then @pk_script_length</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        when 2 then @pk_script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      def []= idx, val</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        case idx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        when 0 then @value = val</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        when 1 then @pk_script_length = val</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        when 2 then @pk_script = val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      # parse raw binary data for transaction output</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="1973" data-linenumber="35">
          <span class="hits">1973</span>
          
          <code class="ruby">        idx = 0</code>
        </li>
      
        <li class="covered" data-hits="1973" data-linenumber="36">
          <span class="hits">1973</span>
          
          <code class="ruby">        @value = data[idx...idx+=8].unpack(&quot;Q&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="1973" data-linenumber="37">
          <span class="hits">1973</span>
          
          <code class="ruby">        @pk_script_length, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="1973" data-linenumber="38">
          <span class="hits">1973</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize - tmp.bytesize</code>
        </li>
      
        <li class="covered" data-hits="1973" data-linenumber="39">
          <span class="hits">1973</span>
          
          <code class="ruby">        @pk_script = data[idx...idx+=@pk_script_length]</code>
        </li>
      
        <li class="covered" data-hits="1973" data-linenumber="40">
          <span class="hits">1973</span>
          
          <code class="ruby">        idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.value_to_address(value, address)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        pk_script = Bitcoin::Script.to_address_script(address)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        new(value, pk_script.bytesize, pk_script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="9997f171293226ec441ccaa33d726c508ff07a39">
  <div class="header">
    <h3>lib/bitcoin/script.rb</h3>
    <h4><span class="green">93.46 %</span> covered</h4>
    <div>
      <b>260</b> relevant lines. 
      <span class="green"><b>243</b> lines covered</span> and
      <span class="red"><b>17</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'bitcoin'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class Script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_1           = 81</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_TRUE        = 81</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_0           = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_FALSE       = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_PUSHDATA1   = 76</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_PUSHDATA2   = 77</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_PUSHDATA4   = 78</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_NOP         = 97</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_DUP         = 118</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_HASH160     = 169</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_EQUAL       = 135</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_VERIFY      = 105</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_EQUALVERIFY = 136</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_CHECKSIG    = 172</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_CHECKSIGVERIFY      = 173</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_CHECKMULTISIG       = 174</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_CHECKMULTISIGVERIFY = 175</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_TOALTSTACK   = 107</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_FROMALTSTACK = 108</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_TUCK         = 125</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_SWAP         = 124</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_BOOLAND      = 154</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_ADD          = 147</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_SUB          = 148</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_GREATERTHANOREQUAL = 162</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_DROP         = 117</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_HASH256      = 170</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_SHA256       = 168</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_SHA1         = 167</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_RIPEMD160    = 166</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_EVAL         = 176</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_NOP2         = 177</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_CHECKHASHVERIFY = 177</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_CODESEPARATOR = 171</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="40">
          <span class="hits">35</span>
          
          <code class="ruby">    OPCODES = Hash[*constants.grep(/^OP_/).map{|i| [const_get(i), i.to_s] }.flatten]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    OPCODES[0] = &quot;0&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    OPCODES[81] = &quot;1&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    OPCODES_ALIAS = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      &quot;OP_TRUE&quot;  =&gt; OP_1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      &quot;OP_FALSE&quot; =&gt; OP_0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      &quot;OP_NOP1&quot; =&gt; OP_EVAL,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      &quot;OP_NOP2&quot; =&gt; OP_CHECKHASHVERIFY</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    OP_2_16 = (82..96).to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :raw, :chunks, :debug</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    # create a new script. +bytes+ is typically input_script + output_script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(bytes, offset=0)</code>
        </li>
      
        <li class="covered" data-hits="1418" data-linenumber="58">
          <span class="hits">1418</span>
          
          <code class="ruby">      @raw = bytes</code>
        </li>
      
        <li class="covered" data-hits="1418" data-linenumber="59">
          <span class="hits">1418</span>
          
          <code class="ruby">      @stack, @stack_alt = [], []</code>
        </li>
      
        <li class="covered" data-hits="1418" data-linenumber="60">
          <span class="hits">1418</span>
          
          <code class="ruby">      @chunks = parse(bytes, offset)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    # parse raw script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse(bytes, offset=0)</code>
        </li>
      
        <li class="covered" data-hits="1418" data-linenumber="65">
          <span class="hits">1418</span>
          
          <code class="ruby">      program = bytes.unpack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1418" data-linenumber="66">
          <span class="hits">1418</span>
          
          <code class="ruby">      chunks = []</code>
        </li>
      
        <li class="covered" data-hits="1418" data-linenumber="67">
          <span class="hits">1418</span>
          
          <code class="ruby">      until program.empty?</code>
        </li>
      
        <li class="covered" data-hits="5610" data-linenumber="68">
          <span class="hits">5610</span>
          
          <code class="ruby">        opcode = program.shift(1)[0]</code>
        </li>
      
        <li class="covered" data-hits="5610" data-linenumber="69">
          <span class="hits">5610</span>
          
          <code class="ruby">        if opcode &gt;= 0xf0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">          opcode = (opcode &lt;&lt; 8) | program.shift(1)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5610" data-linenumber="73">
          <span class="hits">5610</span>
          
          <code class="ruby">        if (opcode &gt; 0) &amp;&amp; (opcode &lt; OP_PUSHDATA1)</code>
        </li>
      
        <li class="covered" data-hits="1681" data-linenumber="74">
          <span class="hits">1681</span>
          
          <code class="ruby">          len = opcode</code>
        </li>
      
        <li class="covered" data-hits="1681" data-linenumber="75">
          <span class="hits">1681</span>
          
          <code class="ruby">          chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3929" data-linenumber="76">
          <span class="hits">3929</span>
          
          <code class="ruby">        elsif (opcode == OP_PUSHDATA1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">          len = program.shift(1)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">          chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3929" data-linenumber="79">
          <span class="hits">3929</span>
          
          <code class="ruby">        elsif (opcode == OP_PUSHDATA2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">          len = program.shift(2).pack(&quot;C*&quot;).unpack(&quot;n&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">          chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3929" data-linenumber="82">
          <span class="hits">3929</span>
          
          <code class="ruby">        elsif (opcode == OP_PUSHDATA4)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">          len = program.shift(4).pack(&quot;C*&quot;).unpack(&quot;N&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">          chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3929" data-linenumber="86">
          <span class="hits">3929</span>
          
          <code class="ruby">          chunks &lt;&lt; opcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1418" data-linenumber="89">
          <span class="hits">1418</span>
          
          <code class="ruby">      chunks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    # string representation of the script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_string(chunks=nil)</code>
        </li>
      
        <li class="covered" data-hits="864" data-linenumber="94">
          <span class="hits">864</span>
          
          <code class="ruby">      (chunks || @chunks).map{|i|</code>
        </li>
      
        <li class="covered" data-hits="3703" data-linenumber="95">
          <span class="hits">3703</span>
          
          <code class="ruby">        case i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        when Fixnum</code>
        </li>
      
        <li class="covered" data-hits="2659" data-linenumber="97">
          <span class="hits">2659</span>
          
          <code class="ruby">          case i</code>
        </li>
      
        <li class="covered" data-hits="2644" data-linenumber="98">
          <span class="hits">2644</span>
          
          <code class="ruby">          when *OPCODES.keys;          OPCODES[i]</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="99">
          <span class="hits">14</span>
          
          <code class="ruby">          when *OP_2_16;               (OP_2_16.index(i)+2).to_s</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">          else &quot;(opcode #{i})&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        when String</code>
        </li>
      
        <li class="covered" data-hits="1044" data-linenumber="103">
          <span class="hits">1044</span>
          
          <code class="ruby">          i.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      }.join(&quot; &quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    # script object of a string representation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.from_string(script_string)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="110">
          <span class="hits">37</span>
          
          <code class="ruby">      new(binary_from_string(script_string))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    # raw script binary of a string representation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.binary_from_string(script_string)</code>
        </li>
      
        <li class="covered" data-hits="877" data-linenumber="115">
          <span class="hits">877</span>
          
          <code class="ruby">      script_string.split(&quot; &quot;).map{|i|</code>
        </li>
      
        <li class="covered" data-hits="3937" data-linenumber="116">
          <span class="hits">3937</span>
          
          <code class="ruby">        case i</code>
        </li>
      
        <li class="covered" data-hits="29103" data-linenumber="117">
          <span class="hits">29103</span>
          
          <code class="ruby">          when *OPCODES.values;          OPCODES.find{|k,v| v == i }.first</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="118">
          <span class="hits">31</span>
          
          <code class="ruby">          when *OPCODES_ALIAS.keys;      OPCODES_ALIAS.find{|k,v| k == i }.last</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="119">
          <span class="hits">61</span>
          
          <code class="ruby">          when /^([2-9]$|1[0-7])$/;      OP_2_16[$1.to_i-2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">          when /\(opcode (\d+)\)/;       $1.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">          else </code>
        </li>
      
        <li class="covered" data-hits="1145" data-linenumber="122">
          <span class="hits">1145</span>
          
          <code class="ruby">            data = [i].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1145" data-linenumber="123">
          <span class="hits">1145</span>
          
          <code class="ruby">            size = data.bytesize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1145" data-linenumber="125">
          <span class="hits">1145</span>
          
          <code class="ruby">            head = if size &lt; OP_PUSHDATA1</code>
        </li>
      
        <li class="covered" data-hits="1145" data-linenumber="126">
          <span class="hits">1145</span>
          
          <code class="ruby">              [size].pack(&quot;C&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">            elsif size &gt; OP_PUSHDATA1 &amp;&amp; size &lt;= 0xff</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">              [OP_PUSHDATA1, size].pack(&quot;CC&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">            elsif size &gt; 0xff &amp;&amp; size &lt;= 0xffff</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">              [OP_PUSHDATA2, size].pack(&quot;Cn&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">            elsif size &gt; 0xffff &amp;&amp; size &lt;= 0xffffffff</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">              [OP_PUSHDATA4, size].pack(&quot;CN&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1145" data-linenumber="135">
          <span class="hits">1145</span>
          
          <code class="ruby">            head + data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      }.map{|i|</code>
        </li>
      
        <li class="covered" data-hits="3937" data-linenumber="138">
          <span class="hits">3937</span>
          
          <code class="ruby">        i.is_a?(Fixnum) ? [i].pack(&quot;C*&quot;) : i # TODO yikes, implement/pack 2 byte opcodes.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      }.join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">    def invalid?</code>
        </li>
      
        <li class="covered" data-hits="362" data-linenumber="143">
          <span class="hits">362</span>
          
          <code class="ruby">      @script_invalid ||= false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    # Does nothing</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_nop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    # Duplicates the top stack item.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_dup</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="152">
          <span class="hits">20</span>
          
          <code class="ruby">      @stack &lt;&lt; (@stack[-1].dup rescue @stack[-1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">    # The input is hashed using SHA-256.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_sha256</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">      buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">      @stack &lt;&lt; Digest::SHA256.digest(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    # The input is hashed using SHA-1.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_sha1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">      buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">      @stack &lt;&lt; Digest::SHA1.digest(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    # The input is hashed twice: first with SHA-256 and then with RIPEMD-160.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_hash160</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="169">
          <span class="hits">16</span>
          
          <code class="ruby">      buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="170">
          <span class="hits">16</span>
          
          <code class="ruby">      @stack &lt;&lt; Digest::RMD160.digest(Digest::SHA256.digest(buf))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">    # The input is hashed using RIPEMD-160.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_ripemd160</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">      buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">      @stack &lt;&lt; Digest::RMD160.digest(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    # The input is hashed two times with SHA-256.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_hash256</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">      buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">      @stack &lt;&lt; Digest::SHA256.digest(Digest::SHA256.digest(buf))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    # Puts the input onto the top of the alt stack. Removes it from the main stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_toaltstack</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">      @stack_alt &lt;&lt; @stack.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    # Puts the input onto the top of the main stack. Removes it from the alt stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_fromaltstack</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">      @stack &lt;&lt; @stack_alt.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    # The item at the top of the stack is copied and inserted before the second-to-top item.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_tuck</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">      @stack[-2..-1] = [ @stack[-1], *@stack[-2..-1] ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    # The top two items on the stack are swapped.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_swap</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">      @stack[-2..-1] = @stack[-2..-1].reverse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">    # If both a and b are not 0, the output is 1. Otherwise 0.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_booland</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="207">
          <span class="hits">4</span>
          
          <code class="ruby">      a, b = @stack.pop(2)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="208">
          <span class="hits">10</span>
          
          <code class="ruby">      @stack &lt;&lt; (![a,b].any?{|n| n == 0 } ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">    # a is added to b.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_add</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="213">
          <span class="hits">3</span>
          
          <code class="ruby">      a, b = @stack.pop(2).reverse</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="214">
          <span class="hits">3</span>
          
          <code class="ruby">      @stack &lt;&lt; a + b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">    # b is subtracted from a.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_sub</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="219">
          <span class="hits">3</span>
          
          <code class="ruby">      a, b = @stack.pop(2).reverse</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="220">
          <span class="hits">3</span>
          
          <code class="ruby">      @stack &lt;&lt; a - b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">    # Returns 1 if a is greater than or equal to b, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_greaterthanorequal</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="225">
          <span class="hits">3</span>
          
          <code class="ruby">      a, b = @stack.pop(2).reverse</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="226">
          <span class="hits">3</span>
          
          <code class="ruby">      @stack &lt;&lt; (a &gt;= b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">    # Removes the top stack item.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_drop</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="231">
          <span class="hits">12</span>
          
          <code class="ruby">      @stack.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">    # Returns 1 if the inputs are exactly equal, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_equal</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="236">
          <span class="hits">23</span>
          
          <code class="ruby">      a, b = @stack.pop(2).reverse</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="237">
          <span class="hits">23</span>
          
          <code class="ruby">      @stack &lt;&lt; (a == b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">    # Marks transaction as invalid if top stack value is not true. True is removed, but false is not.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_verify</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="242">
          <span class="hits">19</span>
          
          <code class="ruby">      res = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="243">
          <span class="hits">19</span>
          
          <code class="ruby">      if res != 1</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="244">
          <span class="hits">2</span>
          
          <code class="ruby">        @stack &lt;&lt; res</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="245">
          <span class="hits">2</span>
          
          <code class="ruby">        @script_invalid = true # raise 'transaction invalid' ?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="247">
          <span class="hits">17</span>
          
          <code class="ruby">        @script_invalid = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">    # Same as OP_EQUAL, but runs OP_VERIFY afterward.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="252">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_equalverify</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="253">
          <span class="hits">17</span>
          
          <code class="ruby">      op_equal; op_verify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">    # An empty array of bytes is pushed onto the stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_0</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="258">
          <span class="hits">24</span>
          
          <code class="ruby">      @stack &lt;&lt; &quot;&quot; # []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">    # The number 1 is pushed onto the stack. Same as OP_TRUE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="262">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_1</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="263">
          <span class="hits">14</span>
          
          <code class="ruby">      @stack &lt;&lt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    # https://en.bitcoin.it/wiki/BIP_0017  (old OP_NOP2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    # TODO: don't rely on it yet. add guards from wikipage too.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="268">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_checkhashverify</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="269">
          <span class="hits">7</span>
          
          <code class="ruby">      unless @checkhash &amp;&amp; (@checkhash == @stack[-1].unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="270">
          <span class="hits">1</span>
          
          <code class="ruby">        @script_invalid = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">    # All of the signature checking words will only match signatures to the data after the most recently-executed OP_CODESEPARATOR.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="275">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_codeseparator</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="276">
          <span class="hits">8</span>
          
          <code class="ruby">      @codehash_start = @chunks.size - @chunks.reverse.index(OP_CODESEPARATOR)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">    # do a CHECKSIG operation on the current stack,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">    # asking +check_callback+ to do the actual signature verification.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">    # This is used by Protocol::Tx#verify_input_signature</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_checksig(check_callback)</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="283">
          <span class="hits">29</span>
          
          <code class="ruby">      return invalid if @stack.size &lt; 2</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="284">
          <span class="hits">28</span>
          
          <code class="ruby">      pubkey = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="285">
          <span class="hits">28</span>
          
          <code class="ruby">      drop_sigs      = [@stack[-1].unpack(&quot;H*&quot;)[0]]</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="286">
          <span class="hits">28</span>
          
          <code class="ruby">      sig, hash_type = parse_sig(@stack.pop)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="288">
          <span class="hits">28</span>
          
          <code class="ruby">      if @chunks.include?(OP_CHECKHASHVERIFY)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">        # Subset of script starting at the most recent codeseparator to OP_CHECKSIG</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="290">
          <span class="hits">3</span>
          
          <code class="ruby">        script_code, @checkhash = codehash_script(OP_CHECKSIG)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="292">
          <span class="hits">25</span>
          
          <code class="ruby">        script_code, drop_sigs = nil, nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="295">
          <span class="hits">28</span>
          
          <code class="ruby">      if check_callback == nil # for tests</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="296">
          <span class="hits">1</span>
          
          <code class="ruby">        @stack &lt;&lt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">      else # real signature check callback</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">        @stack &lt;&lt;</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="299">
          <span class="hits">27</span>
          
          <code class="ruby">          ((check_callback.call(pubkey, sig, hash_type, drop_sigs, script_code) == true) ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="303">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_checksigverify(check_callback)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">      op_checksig(check_callback)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">      p @stack</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">      op_verify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">    # do a CHECKMULTISIG operation on the current stack,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">    # asking +check_callback+ to do the actual signature verification.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">    # CHECKMULTISIG does a m-of-n signatures verification on scripts of the form:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">    #  0 &lt;sig1&gt; &lt;sig2&gt; | 2 &lt;pub1&gt; &lt;pub2&gt; 2 OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">    #  0 &lt;sig1&gt; &lt;sig2&gt; | 2 &lt;pub1&gt; &lt;pub2&gt; &lt;pub3&gt; 3 OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">    #  0 &lt;sig1&gt; &lt;sig2&gt; &lt;sig3&gt; | 3 &lt;pub1&gt; &lt;pub2&gt; &lt;pub3&gt; 3 OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">    # see https://en.bitcoin.it/wiki/BIP_0011 for details.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">    # see https://github.com/bitcoin/bitcoin/blob/master/src/script.cpp#L931</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">    # TODO: validate signature order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">    # TODO: take global opcode count</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">    def op_checkmultisig(check_callback)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="323">
          <span class="hits">22</span>
          
          <code class="ruby">      n_pubkeys = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="324">
          <span class="hits">22</span>
          
          <code class="ruby">      return invalid  unless (0..20).include?(n_pubkeys)</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="325">
          <span class="hits">70</span>
          
          <code class="ruby">      return invalid  unless @stack.last(n_pubkeys).all?{|e| e.is_a?(String) &amp;&amp; e != '' }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">      #return invalid  if ((@op_count ||= 0) += n_pubkeys) &gt; 201</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="327">
          <span class="hits">19</span>
          
          <code class="ruby">      pubkeys = @stack.pop(n_pubkeys)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="329">
          <span class="hits">19</span>
          
          <code class="ruby">      n_sigs = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="330">
          <span class="hits">19</span>
          
          <code class="ruby">      return invalid  unless (0..n_pubkeys).include?(n_sigs)</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="331">
          <span class="hits">41</span>
          
          <code class="ruby">      return invalid  unless @stack.last(n_sigs).all?{|e| e.is_a?(String) &amp;&amp; e != '' }</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="332">
          <span class="hits">41</span>
          
          <code class="ruby">      sigs = (drop_sigs = @stack.pop(n_sigs)).map{|s| parse_sig(s) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="334">
          <span class="hits">15</span>
          
          <code class="ruby">      @stack.pop if @stack[-1] == '' # remove OP_NOP from stack</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="336">
          <span class="hits">15</span>
          
          <code class="ruby">      if @chunks.include?(OP_CHECKHASHVERIFY)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">        # Subset of script starting at the most recent codeseparator to OP_CHECKMULTISIG</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="338">
          <span class="hits">4</span>
          
          <code class="ruby">        script_code, @checkhash = codehash_script(OP_CHECKMULTISIG)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="339">
          <span class="hits">8</span>
          
          <code class="ruby">        drop_sigs.map!{|i| i.unpack(&quot;H*&quot;)[0] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="341">
          <span class="hits">11</span>
          
          <code class="ruby">        script_code, drop_sigs = nil, nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="344">
          <span class="hits">15</span>
          
          <code class="ruby">      valid_sigs = 0</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="345">
          <span class="hits">41</span>
          
          <code class="ruby">      sigs.each{|sig, hash_type| pubkeys.each{|pubkey|</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="346">
          <span class="hits">68</span>
          
          <code class="ruby">        valid_sigs += 1  if check_callback.call(pubkey, sig, hash_type, drop_sigs, script_code)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">      }}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="349">
          <span class="hits">15</span>
          
          <code class="ruby">      @stack &lt;&lt; ((valid_sigs == n_sigs) ? 1 : (invalid; 0))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="355">
          <span class="hits">1</span>
          
          <code class="ruby">    OPCODES_METHOD = Hash[*instance_methods.grep(/^op_/).map{|m|</code>
        </li>
      
        <li class="covered" data-hits="525" data-linenumber="356">
          <span class="hits">525</span>
          
          <code class="ruby">      [ (OPCODES.find{|k,v| v == m.to_s.upcase }.first rescue nil), m ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">    }.flatten]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="358">
          <span class="hits">1</span>
          
          <code class="ruby">    OPCODES_METHOD[0]  = :op_0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="359">
          <span class="hits">1</span>
          
          <code class="ruby">    OPCODES_METHOD[81] = :op_1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    # run the script. +check_callback+ is called for OP_CHECKSIG operations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="363">
          <span class="hits">1</span>
          
          <code class="ruby">    def run(&amp;check_callback)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="364">
          <span class="hits">48</span>
          
          <code class="ruby">      @debug = []</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="365">
          <span class="hits">48</span>
          
          <code class="ruby">      @chunks.each{|chunk|</code>
        </li>
      
        <li class="covered" data-hits="360" data-linenumber="366">
          <span class="hits">360</span>
          
          <code class="ruby">        break if invalid?</code>
        </li>
      
        <li class="covered" data-hits="1361" data-linenumber="367">
          <span class="hits">1361</span>
          
          <code class="ruby">        @debug &lt;&lt; @stack.map{|i| i.unpack(&quot;H*&quot;) rescue i}</code>
        </li>
      
        <li class="covered" data-hits="358" data-linenumber="368">
          <span class="hits">358</span>
          
          <code class="ruby">        case chunk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">        when Fixnum</code>
        </li>
      
        <li class="covered" data-hits="197" data-linenumber="370">
          <span class="hits">197</span>
          
          <code class="ruby">          case chunk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">          when *OPCODES_METHOD.keys</code>
        </li>
      
        <li class="covered" data-hits="158" data-linenumber="373">
          <span class="hits">158</span>
          
          <code class="ruby">            m = method( n=OPCODES_METHOD[chunk] )</code>
        </li>
      
        <li class="covered" data-hits="158" data-linenumber="374">
          <span class="hits">158</span>
          
          <code class="ruby">            @debug &lt;&lt; n.to_s.upcase</code>
        </li>
      
        <li class="covered" data-hits="158" data-linenumber="375">
          <span class="hits">158</span>
          
          <code class="ruby">            (m.arity == 1) ? m.call(check_callback) : m.call  # invoke opcode method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">          when *OP_2_16</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="378">
          <span class="hits">39</span>
          
          <code class="ruby">            @stack &lt;&lt; OP_2_16.index(chunk) + 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">            name = OPCODES[chunk] || chunk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">            raise &quot;opcode #{name} unkown or not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">        when String</code>
        </li>
      
        <li class="covered" data-hits="161" data-linenumber="385">
          <span class="hits">161</span>
          
          <code class="ruby">          @debug &lt;&lt; &quot;PUSH DATA #{chunk.unpack(&quot;H*&quot;)[0]}&quot;</code>
        </li>
      
        <li class="covered" data-hits="161" data-linenumber="386">
          <span class="hits">161</span>
          
          <code class="ruby">          @stack &lt;&lt; chunk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="389">
          <span class="hits">126</span>
          
          <code class="ruby">      @debug &lt;&lt; @stack.map{|i| i.unpack(&quot;H*&quot;) rescue i }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="391">
          <span class="hits">48</span>
          
          <code class="ruby">      if @script_invalid</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="392">
          <span class="hits">11</span>
          
          <code class="ruby">        @stack &lt;&lt; 0</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="393">
          <span class="hits">11</span>
          
          <code class="ruby">        @debug &lt;&lt; &quot;INVALID TRANSACTION&quot;</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="394">
          <span class="hits">11</span>
          
          <code class="ruby">        require 'pp'; pp @debug</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="397">
          <span class="hits">48</span>
          
          <code class="ruby">      @debug &lt;&lt; &quot;RESULT&quot;</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="398">
          <span class="hits">48</span>
          
          <code class="ruby">      @stack.pop == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="401">
          <span class="hits">1</span>
          
          <code class="ruby">    def invalid</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="402">
          <span class="hits">11</span>
          
          <code class="ruby">      @script_invalid = true; nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="405">
          <span class="hits">1</span>
          
          <code class="ruby">    def codehash_script(opcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">      # CScript scriptCode(pbegincodehash, pend);</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="407">
          <span class="hits">7</span>
          
          <code class="ruby">      script    = to_string(@chunks[(@codehash_start||0)...@chunks.size-@chunks.reverse.index(opcode)])</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="408">
          <span class="hits">7</span>
          
          <code class="ruby">      checkhash = Bitcoin.hash160(Bitcoin::Script.binary_from_string(script).unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="409">
          <span class="hits">7</span>
          
          <code class="ruby">      [script, checkhash]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="412">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.drop_signatures(script_pubkey, drop_signatures)</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="413">
          <span class="hits">33</span>
          
          <code class="ruby">      script = new(script_pubkey).to_string.split(&quot; &quot;).delete_if{|c| drop_signatures.include?(c) }.join(&quot; &quot;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="414">
          <span class="hits">5</span>
          
          <code class="ruby">      script_pubkey = binary_from_string(script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">    # check if script is in one of the recognized standard formats</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="418">
          <span class="hits">1</span>
          
          <code class="ruby">    def is_standard?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">      is_pubkey? || is_hash160?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">    # is this a send-to-ip (pubkey) tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="423">
          <span class="hits">1</span>
          
          <code class="ruby">    def is_send_to_ip?</code>
        </li>
      
        <li class="covered" data-hits="579" data-linenumber="424">
          <span class="hits">579</span>
          
          <code class="ruby">      return false if @chunks.size != 2</code>
        </li>
      
        <li class="covered" data-hits="569" data-linenumber="425">
          <span class="hits">569</span>
          
          <code class="ruby">      (@chunks[1] == OP_CHECKSIG) &amp;&amp; @chunks[0].size &gt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="427">
          <span class="hits">1</span>
          
          <code class="ruby">    alias :is_pubkey? :is_send_to_ip?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby">    # is this a hash160 (address) tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="430">
          <span class="hits">1</span>
          
          <code class="ruby">    def is_hash160?</code>
        </li>
      
        <li class="covered" data-hits="487" data-linenumber="431">
          <span class="hits">487</span>
          
          <code class="ruby">      return false  if @chunks.size != 5</code>
        </li>
      
        <li class="covered" data-hits="203" data-linenumber="432">
          <span class="hits">203</span>
          
          <code class="ruby">      (@chunks[0..1] + @chunks[-2..-1]) ==</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">        [OP_DUP, OP_HASH160, OP_EQUALVERIFY, OP_CHECKSIG] &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="203" data-linenumber="434">
          <span class="hits">203</span>
          
          <code class="ruby">        @chunks[2].is_a?(String) &amp;&amp; @chunks[2].bytesize == 20</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby">    # get the public key for this script (in generation scripts)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="438">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_pubkey</code>
        </li>
      
        <li class="covered" data-hits="285" data-linenumber="439">
          <span class="hits">285</span>
          
          <code class="ruby">      return @chunks[0].unpack(&quot;H*&quot;)[0] if @chunks.size == 1</code>
        </li>
      
        <li class="covered" data-hits="285" data-linenumber="440">
          <span class="hits">285</span>
          
          <code class="ruby">      is_pubkey? ? @chunks[0].unpack(&quot;H*&quot;)[0] : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">    # get the address for the public key (in generation scripts)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="444">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_pubkey_address</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="445">
          <span class="hits">2</span>
          
          <code class="ruby">      Bitcoin.pubkey_to_address(get_pubkey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby">    # get the hash160 for this script (in standard address scripts)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="449">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_hash160</code>
        </li>
      
        <li class="covered" data-hits="478" data-linenumber="450">
          <span class="hits">478</span>
          
          <code class="ruby">      return @chunks[2..-3][0].unpack(&quot;H*&quot;)[0]  if is_hash160?</code>
        </li>
      
        <li class="covered" data-hits="283" data-linenumber="451">
          <span class="hits">283</span>
          
          <code class="ruby">      return Bitcoin.hash160(get_pubkey)        if is_pubkey?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby">    # get the address for the script hash160 (in standard address scripts)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="455">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_hash160_address</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="456">
          <span class="hits">6</span>
          
          <code class="ruby">      Bitcoin.hash160_to_address(get_hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">    # get address this script corresponds to (if possible)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="460">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_address</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="461">
          <span class="hits">7</span>
          
          <code class="ruby">      return get_pubkey_address  if is_pubkey?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="462">
          <span class="hits">6</span>
          
          <code class="ruby">      return get_hash160_address if is_hash160?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">    # generate standard transaction script for given +address+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="466">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.to_address_script(address)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="467">
          <span class="hits">35</span>
          
          <code class="ruby">      hash160 = Bitcoin.hash160_from_address(address)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="468">
          <span class="hits">35</span>
          
          <code class="ruby">      return nil  unless hash160</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby">      #  DUP   HASH160  length  hash160    EQUALVERIFY  CHECKSIG</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="470">
          <span class="hits">34</span>
          
          <code class="ruby">      [ [&quot;76&quot;, &quot;a9&quot;,    &quot;14&quot;,   hash160,   &quot;88&quot;,        &quot;ac&quot;].join ].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="473">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.to_signature_pubkey_script(signature, pubkey)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="474">
          <span class="hits">15</span>
          
          <code class="ruby">      hash_type = &quot;\x01&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">      #pubkey = [pubkey].pack(&quot;H*&quot;) if pubkey.bytesize != 65</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="476">
          <span class="hits">15</span>
          
          <code class="ruby">      raise &quot;pubkey is not in binary form&quot; unless pubkey.bytesize == 65  &amp;&amp; pubkey[0] == &quot;\x04&quot;</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="477">
          <span class="hits">15</span>
          
          <code class="ruby">      [ [signature.bytesize+1].pack(&quot;C&quot;), signature, hash_type, [pubkey.bytesize].pack(&quot;C&quot;), pubkey ].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="478">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="480">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="482">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_sig(sig)</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="483">
          <span class="hits">54</span>
          
          <code class="ruby">      hash_type = sig[-1].unpack(&quot;C&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="484">
          <span class="hits">54</span>
          
          <code class="ruby">      sig = sig[0...-1]</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="485">
          <span class="hits">54</span>
          
          <code class="ruby">      return sig, hash_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3df1335f475b9f7cfa9efdfa05ebfc5a3780d534">
  <div class="header">
    <h3>lib/bitcoin/storage/dummy.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>101</b> relevant lines. 
      <span class="green"><b>101</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Backends</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class DummyStore &lt; StoreBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :blk, :tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize *args</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="7">
          <span class="hits">30</span>
          
          <code class="ruby">      reset</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="8">
          <span class="hits">30</span>
          
          <code class="ruby">      super(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="12">
          <span class="hits">62</span>
          
          <code class="ruby">      @blk, @tx = [], {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_block(blk)</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="16">
          <span class="hits">128</span>
          
          <code class="ruby">      return false  unless blk</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="17">
          <span class="hits">128</span>
          
          <code class="ruby">      if block = get_block(blk.hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">        log.info { &quot;Block already stored; skipping&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="127" data-linenumber="22">
          <span class="hits">127</span>
          
          <code class="ruby">      prev_block = get_block(Bitcoin::hth(blk.prev_block.reverse))</code>
        </li>
      
        <li class="covered" data-hits="127" data-linenumber="23">
          <span class="hits">127</span>
          
          <code class="ruby">      unless prev_block</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="24">
          <span class="hits">31</span>
          
          <code class="ruby">        unless blk.hash == Bitcoin.network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">          log.warn { &quot;INVALID BLOCK: #{blk.hash}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="252" data-linenumber="30">
          <span class="hits">252</span>
          
          <code class="ruby">      blk.tx.each {|tx| store_tx(tx) }</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="31">
          <span class="hits">126</span>
          
          <code class="ruby">      @blk &lt;&lt; blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="33">
          <span class="hits">126</span>
          
          <code class="ruby">      log.info { &quot;NEW HEAD: #{blk.hash} DEPTH: #{get_depth}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="34">
          <span class="hits">126</span>
          
          <code class="ruby">      get_depth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_tx(tx)</code>
        </li>
      
        <li class="covered" data-hits="201" data-linenumber="38">
          <span class="hits">201</span>
          
          <code class="ruby">      if @tx.keys.include?(tx.hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">        log.info { &quot;Tx already stored; skipping&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">        return tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="200" data-linenumber="42">
          <span class="hits">200</span>
          
          <code class="ruby">      @tx[tx.hash] = tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_block(blk_hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="46">
          <span class="hits">2</span>
          
          <code class="ruby">      !!get_block(blk_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="50">
          <span class="hits">2</span>
          
          <code class="ruby">      !!get_tx(tx_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_depth</code>
        </li>
      
        <li class="covered" data-hits="131" data-linenumber="54">
          <span class="hits">131</span>
          
          <code class="ruby">      @blk.size - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_head</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="58">
          <span class="hits">2</span>
          
          <code class="ruby">      wrap_block(@blk[-1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_depth(depth)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="62">
          <span class="hits">5</span>
          
          <code class="ruby">      wrap_block(@blk[depth])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_prev_hash(hash)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="66">
          <span class="hits">8</span>
          
          <code class="ruby">      wrap_block(@blk.find {|blk| blk.prev_block == [hash].pack(&quot;H*&quot;).reverse})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block(blk_hash)</code>
        </li>
      
        <li class="covered" data-hits="731" data-linenumber="70">
          <span class="hits">731</span>
          
          <code class="ruby">      wrap_block(@blk.find {|blk| blk.hash == blk_hash})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_id(blk_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      wrap_block(@blk[blk_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="78">
          <span class="hits">6</span>
          
          <code class="ruby">      wrap_block(@blk.find {|blk| blk.tx.map(&amp;:hash).include?(tx_hash) })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="134" data-linenumber="82">
          <span class="hits">134</span>
          
          <code class="ruby">      transaction = @tx[tx_hash]</code>
        </li>
      
        <li class="covered" data-hits="134" data-linenumber="83">
          <span class="hits">134</span>
          
          <code class="ruby">      return nil  unless transaction</code>
        </li>
      
        <li class="covered" data-hits="132" data-linenumber="84">
          <span class="hits">132</span>
          
          <code class="ruby">      wrap_tx(transaction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx_by_id(tx_id)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="88">
          <span class="hits">5</span>
          
          <code class="ruby">      wrap_tx(@tx[tx_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txin_for_txout(tx_hash, txout_idx)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="92">
          <span class="hits">3</span>
          
          <code class="ruby">      txin = @tx.values.map(&amp;:in).flatten.find {|i| i.prev_out_index == txout_idx &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="93">
          <span class="hits">28</span>
          
          <code class="ruby">        i.prev_out == [tx_hash].pack(&quot;H*&quot;).reverse }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="94">
          <span class="hits">3</span>
          
          <code class="ruby">      wrap_txin(txin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_pk_script(script)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="98">
          <span class="hits">10</span>
          
          <code class="ruby">      txouts = @tx.values.map(&amp;:out).flatten.select {|o| o.pk_script == script}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="99">
          <span class="hits">2</span>
          
          <code class="ruby">      txouts.map {|o| wrap_txout(o) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_hash160(hash160)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="103">
          <span class="hits">5</span>
          
          <code class="ruby">      @tx.values.map(&amp;:out).flatten.map {|o|</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="104">
          <span class="hits">50</span>
          
          <code class="ruby">        o = wrap_txout(o)</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="105">
          <span class="hits">50</span>
          
          <code class="ruby">        o.hash160 == hash160 ? o : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      }.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_block(block)</code>
        </li>
      
        <li class="covered" data-hits="284" data-linenumber="110">
          <span class="hits">284</span>
          
          <code class="ruby">      return nil  unless block</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="111">
          <span class="hits">122</span>
          
          <code class="ruby">      data = {:id =&gt; @blk.index(block), :depth =&gt; @blk.index(block)}</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="112">
          <span class="hits">122</span>
          
          <code class="ruby">      blk = Bitcoin::Storage::Models::Block.new(self, data)</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="113">
          <span class="hits">122</span>
          
          <code class="ruby">      [:ver, :prev_block, :mrkl_root, :time, :bits, :nonce].each do |attr|</code>
        </li>
      
        <li class="covered" data-hits="732" data-linenumber="114">
          <span class="hits">732</span>
          
          <code class="ruby">        blk.send(&quot;#{attr}=&quot;, block.send(attr))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="116">
          <span class="hits">122</span>
          
          <code class="ruby">      block.tx.each do |tx|</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="117">
          <span class="hits">122</span>
          
          <code class="ruby">        blk.tx &lt;&lt; get_tx(tx.hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="119">
          <span class="hits">122</span>
          
          <code class="ruby">      blk.recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="120">
          <span class="hits">122</span>
          
          <code class="ruby">      blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_tx(transaction)</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="124">
          <span class="hits">137</span>
          
          <code class="ruby">      return nil  unless transaction</code>
        </li>
      
        <li class="covered" data-hits="472" data-linenumber="125">
          <span class="hits">472</span>
          
          <code class="ruby">      blk = @blk.find{|b| b.tx.include?(transaction)}</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="126">
          <span class="hits">137</span>
          
          <code class="ruby">      data = {:id =&gt; transaction.hash, :blk_id =&gt; @blk.index(blk)}</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="127">
          <span class="hits">137</span>
          
          <code class="ruby">      tx = Bitcoin::Storage::Models::Tx.new(self, data)</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="128">
          <span class="hits">137</span>
          
          <code class="ruby">      tx.ver = transaction.ver</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="129">
          <span class="hits">137</span>
          
          <code class="ruby">      tx.lock_time = transaction.lock_time</code>
        </li>
      
        <li class="covered" data-hits="301" data-linenumber="130">
          <span class="hits">301</span>
          
          <code class="ruby">      transaction.in.each {|i| tx.add_in(wrap_txin(i))}</code>
        </li>
      
        <li class="covered" data-hits="284" data-linenumber="131">
          <span class="hits">284</span>
          
          <code class="ruby">      transaction.out.each {|o| tx.add_out(wrap_txout(o))}</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="132">
          <span class="hits">137</span>
          
          <code class="ruby">      tx.hash = tx.hash_from_payload(tx.to_payload)</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="133">
          <span class="hits">137</span>
          
          <code class="ruby">      tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txin(input)</code>
        </li>
      
        <li class="covered" data-hits="167" data-linenumber="137">
          <span class="hits">167</span>
          
          <code class="ruby">      return nil  unless input</code>
        </li>
      
        <li class="covered" data-hits="749" data-linenumber="138">
          <span class="hits">749</span>
          
          <code class="ruby">      tx = @tx.values.find{|t| t.in.include?(input)}</code>
        </li>
      
        <li class="covered" data-hits="165" data-linenumber="139">
          <span class="hits">165</span>
          
          <code class="ruby">      data = {:tx_id =&gt; tx.hash, :tx_idx =&gt; tx.in.index(input)}</code>
        </li>
      
        <li class="covered" data-hits="165" data-linenumber="140">
          <span class="hits">165</span>
          
          <code class="ruby">      txin = Bitcoin::Storage::Models::TxIn.new(self, data)</code>
        </li>
      
        <li class="covered" data-hits="165" data-linenumber="141">
          <span class="hits">165</span>
          
          <code class="ruby">      [:prev_out, :prev_out_index, :script_sig_length, :script_sig, :sequence].each do |attr|</code>
        </li>
      
        <li class="covered" data-hits="825" data-linenumber="142">
          <span class="hits">825</span>
          
          <code class="ruby">        txin.send(&quot;#{attr}=&quot;, input.send(attr))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="165" data-linenumber="144">
          <span class="hits">165</span>
          
          <code class="ruby">      txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txout(output)</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="148">
          <span class="hits">198</span>
          
          <code class="ruby">      return nil  unless output</code>
        </li>
      
        <li class="covered" data-hits="893" data-linenumber="149">
          <span class="hits">893</span>
          
          <code class="ruby">      tx = @tx.values.find{|t| t.out.include?(output)}</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="150">
          <span class="hits">198</span>
          
          <code class="ruby">      data = {:tx_id =&gt; tx.hash, :tx_idx =&gt; tx.out.index(output),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        :hash160 =&gt; Bitcoin::Script.new(output.pk_script).get_hash160 }</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="152">
          <span class="hits">198</span>
          
          <code class="ruby">      txout = Bitcoin::Storage::Models::TxOut.new(self, data)</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="153">
          <span class="hits">198</span>
          
          <code class="ruby">      [:value, :pk_script_length, :pk_script].each do |attr|</code>
        </li>
      
        <li class="covered" data-hits="594" data-linenumber="154">
          <span class="hits">594</span>
          
          <code class="ruby">        txout.send(&quot;#{attr}=&quot;, output.send(attr))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="156">
          <span class="hits">198</span>
          
          <code class="ruby">      txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_s</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="160">
          <span class="hits">61</span>
          
          <code class="ruby">      &quot;DummyStore&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a5b4193a8f28e1aea5ab2063c2b6e6b27fea99ad">
  <div class="header">
    <h3>lib/bitcoin/storage/models.rb</h3>
    <h4><span class="green">98.0 %</span> covered</h4>
    <div>
      <b>50</b> relevant lines. 
      <span class="green"><b>49</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># StorageModels defines objects that are returned from storage.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># These objects inherit from their Bitcoin::Protocol counterpart</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># and add some additional data and methods.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Models</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Block retrieved from storage.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  class Block &lt; Bitcoin::Protocol::Block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :ver, :prev_block, :mrkl_root, :time, :bits, :nonce, :tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :depth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="245" data-linenumber="13">
          <span class="hits">245</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="245" data-linenumber="14">
          <span class="hits">245</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="245" data-linenumber="15">
          <span class="hits">245</span>
          
          <code class="ruby">      @depth = data[:depth]</code>
        </li>
      
        <li class="covered" data-hits="245" data-linenumber="16">
          <span class="hits">245</span>
          
          <code class="ruby">      @tx = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # get the block this one builds upon</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_prev_block</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="21">
          <span class="hits">4</span>
          
          <code class="ruby">      @store.get_block(hth(@prev_block))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    # get the block that builds upon this one</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_next_block</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="26">
          <span class="hits">4</span>
          
          <code class="ruby">      @store.get_block_by_prev_hash(@hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # Transaction retrieved from storage.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  class Tx &lt; Bitcoin::Protocol::Tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :ver, :lock_time, :hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :blk_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="274" data-linenumber="38">
          <span class="hits">274</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="274" data-linenumber="39">
          <span class="hits">274</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="274" data-linenumber="40">
          <span class="hits">274</span>
          
          <code class="ruby">      @blk_id = data[:blk_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # get the block this transaction is in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="45">
          <span class="hits">2</span>
          
          <code class="ruby">      return nil  unless @blk_id</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="46">
          <span class="hits">2</span>
          
          <code class="ruby">      @store.get_block_by_id(@blk_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  # Transaction input retrieved from storage.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  class TxIn &lt; Bitcoin::Protocol::TxIn</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :tx_id, :tx_idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="327" data-linenumber="57">
          <span class="hits">327</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="327" data-linenumber="58">
          <span class="hits">327</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="327" data-linenumber="59">
          <span class="hits">327</span>
          
          <code class="ruby">      @tx_id = data[:tx_id]</code>
        </li>
      
        <li class="covered" data-hits="327" data-linenumber="60">
          <span class="hits">327</span>
          
          <code class="ruby">      @tx_idx = data[:tx_idx]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    # get the transaction this input is in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="66">
          <span class="hits">2</span>
          
          <code class="ruby">      @store.get_tx_by_id(@tx_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    # get the previous output referenced by this input</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_prev_out</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="71">
          <span class="hits">2</span>
          
          <code class="ruby">      prev_tx = @store.get_tx(@prev_out.reverse.unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="72">
          <span class="hits">2</span>
          
          <code class="ruby">      return nil  unless prev_tx</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="73">
          <span class="hits">2</span>
          
          <code class="ruby">      prev_tx.out[@prev_out_index]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  # Transaction output retrieved from storage.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  class TxOut &lt; Bitcoin::Protocol::TxOut</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :tx_id, :tx_idx, :hash160</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="349" data-linenumber="84">
          <span class="hits">349</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="349" data-linenumber="85">
          <span class="hits">349</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="349" data-linenumber="86">
          <span class="hits">349</span>
          
          <code class="ruby">      @tx_id = data[:tx_id]</code>
        </li>
      
        <li class="covered" data-hits="349" data-linenumber="87">
          <span class="hits">349</span>
          
          <code class="ruby">      @tx_idx = data[:tx_idx]</code>
        </li>
      
        <li class="covered" data-hits="349" data-linenumber="88">
          <span class="hits">349</span>
          
          <code class="ruby">      @hash160 = data[:hash160]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # get the transaction this output is in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="93">
          <span class="hits">8</span>
          
          <code class="ruby">      @store.get_tx_by_id(@tx_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    # get the next input that references this output</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_next_in</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="98">
          <span class="hits">6</span>
          
          <code class="ruby">      @store.get_txin_for_txout(get_tx.hash, @tx_idx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    # get the address this txout corresponds to (if possible)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      Bitcoin::Script.new(@pk_script).get_address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2b02df19bf3e2d30c17039c18855058d8a44f920">
  <div class="header">
    <h3>lib/bitcoin/storage/sequel.rb</h3>
    <h4><span class="green">95.14 %</span> covered</h4>
    <div>
      <b>144</b> relevant lines. 
      <span class="green"><b>137</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  require 'sequel'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">rescue LoadError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  puts &quot;Cannot load 'sequel' - install with `gem install sequel`&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  puts &quot;Note: You will also need an adapter for your database like sqlite3, mysql2, postgresql&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  exit 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">require 'bitcoin/storage/sequel_store/sequel_migrations'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Backends</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  class SequelStore &lt; StoreBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :db</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    include Bitcoin::Storage::Backends::SequelMigrations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize config</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="19">
          <span class="hits">30</span>
          
          <code class="ruby">      @config = config</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="20">
          <span class="hits">30</span>
          
          <code class="ruby">      connect</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="21">
          <span class="hits">30</span>
          
          <code class="ruby">      super config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="25">
          <span class="hits">30</span>
          
          <code class="ruby">      @db = Sequel.connect(@config[:db])</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="26">
          <span class="hits">30</span>
          
          <code class="ruby">      migrate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="30">
          <span class="hits">192</span>
          
          <code class="ruby">      [:blk, :blk_tx, :tx, :txin, :txout].each {|table| @db[table].delete}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_block(blk)</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="34">
          <span class="hits">128</span>
          
          <code class="ruby">      @log.debug { &quot;Storing tx #{blk.hash} (#{blk.to_payload.bytesize} bytes)&quot; }</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="35">
          <span class="hits">128</span>
          
          <code class="ruby">      @db.transaction do</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="36">
          <span class="hits">128</span>
          
          <code class="ruby">        block = @db[:blk][:hash =&gt; htb(blk.hash).to_sequel_blob]</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="37">
          <span class="hits">128</span>
          
          <code class="ruby">        if block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">          @log.info { &quot;skipping already existing block: #{blk.hash}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="127" data-linenumber="42">
          <span class="hits">127</span>
          
          <code class="ruby">        prev_block = get_block(hth(blk.prev_block.reverse))</code>
        </li>
      
        <li class="covered" data-hits="127" data-linenumber="43">
          <span class="hits">127</span>
          
          <code class="ruby">        if !prev_block &amp;&amp; blk.hash != Bitcoin::network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">          log.warn { &quot;Invalid Block: #{blk.hash} - prev_block not found&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="47">
          <span class="hits">126</span>
          
          <code class="ruby">        if prev_block</code>
        </li>
      
        <li class="covered" data-hits="96" data-linenumber="48">
          <span class="hits">96</span>
          
          <code class="ruby">          depth = prev_block.depth + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="50">
          <span class="hits">30</span>
          
          <code class="ruby">          depth = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="52">
          <span class="hits">126</span>
          
          <code class="ruby">        block_id = @db[:blk].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">            :hash =&gt; htb(blk.hash).to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">            :depth =&gt; depth,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">            :version =&gt; blk.ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">            :prev_hash =&gt; blk.prev_block.reverse.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">            :mrkl_root =&gt; blk.mrkl_root.reverse.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">            :time =&gt; blk.time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">            :bits =&gt; blk.bits,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">            :nonce =&gt; blk.nonce,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">            :blk_size =&gt; blk.payload.bytesize,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="63">
          <span class="hits">126</span>
          
          <code class="ruby">        blk.tx.each_with_index do |tx, idx|</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="64">
          <span class="hits">126</span>
          
          <code class="ruby">          tx_id = store_tx(tx)</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="65">
          <span class="hits">126</span>
          
          <code class="ruby">          raise &quot;Error saving tx #{tx.hash} in block #{blk.hash}&quot;  unless tx_id</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="66">
          <span class="hits">126</span>
          
          <code class="ruby">          @db[:blk_tx].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">              :blk_id =&gt; block_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">              :tx_id =&gt; tx_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">              :idx =&gt; idx,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">            })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="73">
          <span class="hits">126</span>
          
          <code class="ruby">        log.info { &quot;new head #{blk.hash} - #{get_depth}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="74">
          <span class="hits">126</span>
          
          <code class="ruby">        depth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_tx(tx)</code>
        </li>
      
        <li class="covered" data-hits="201" data-linenumber="79">
          <span class="hits">201</span>
          
          <code class="ruby">      @log.debug { &quot;Storing tx #{tx.hash} (#{tx.to_payload.bytesize} bytes)&quot; }</code>
        </li>
      
        <li class="covered" data-hits="201" data-linenumber="80">
          <span class="hits">201</span>
          
          <code class="ruby">      @db.transaction do</code>
        </li>
      
        <li class="covered" data-hits="201" data-linenumber="81">
          <span class="hits">201</span>
          
          <code class="ruby">        transaction = @db[:tx][:hash =&gt; htb(tx.hash).to_sequel_blob]</code>
        </li>
      
        <li class="covered" data-hits="201" data-linenumber="82">
          <span class="hits">201</span>
          
          <code class="ruby">        return transaction[:id]  if transaction</code>
        </li>
      
        <li class="covered" data-hits="200" data-linenumber="83">
          <span class="hits">200</span>
          
          <code class="ruby">        tx_id = @db[:tx].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">            :hash =&gt; htb(tx.hash).to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">            :version =&gt; tx.ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">            :lock_time =&gt; tx.lock_time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">            :coinbase =&gt; tx.in.size==1 &amp;&amp; tx.in[0].coinbase?,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">            :tx_size =&gt; tx.payload.bytesize,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="covered" data-hits="430" data-linenumber="90">
          <span class="hits">430</span>
          
          <code class="ruby">        tx.in.each_with_index {|i, idx| store_txin(tx_id, i, idx)}</code>
        </li>
      
        <li class="covered" data-hits="472" data-linenumber="91">
          <span class="hits">472</span>
          
          <code class="ruby">        tx.out.each_with_index {|o, idx| store_txout(tx_id, o, idx)}</code>
        </li>
      
        <li class="covered" data-hits="200" data-linenumber="92">
          <span class="hits">200</span>
          
          <code class="ruby">        tx_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_txin(tx_id, txin, idx)</code>
        </li>
      
        <li class="covered" data-hits="230" data-linenumber="97">
          <span class="hits">230</span>
          
          <code class="ruby">      @db[:txin].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          :tx_id =&gt; tx_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">          :tx_idx =&gt; idx,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">          :script_sig =&gt; txin.script_sig.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          :prev_out =&gt; txin.prev_out.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">          :prev_out_index =&gt; txin.prev_out_index,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">          :sequence =&gt; txin.sequence.unpack(&quot;I&quot;)[0],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_txout(tx_id, txout, idx)</code>
        </li>
      
        <li class="covered" data-hits="272" data-linenumber="108">
          <span class="hits">272</span>
          
          <code class="ruby">      @db[:txout].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          :tx_id =&gt; tx_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">          :tx_idx =&gt; idx,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">          :pk_script =&gt; txout.pk_script.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">          :value =&gt; txout.value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          :hash160 =&gt; Bitcoin::Script.new(txout.pk_script).get_hash160</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_block(blk_hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="119">
          <span class="hits">2</span>
          
          <code class="ruby">      !!@db[:blk].where(:hash =&gt; htb(blk_hash).to_sequel_blob).get(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="123">
          <span class="hits">2</span>
          
          <code class="ruby">      !!@db[:tx].where(:hash =&gt; htb(tx_hash).to_sequel_blob).get(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_head</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="127">
          <span class="hits">5</span>
          
          <code class="ruby">      wrap_block(@db[:blk].order(:depth).last)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_depth</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="131">
          <span class="hits">5</span>
          
          <code class="ruby">      return -1  if @db[:blk].count == 0</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="132">
          <span class="hits">3</span>
          
          <code class="ruby">      @db[:blk][:hash =&gt; htb(get_head.hash).to_sequel_blob][:depth]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block(blk_hash)</code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="136">
          <span class="hits">143</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:hash =&gt; htb(blk_hash).to_sequel_blob])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_depth(depth)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="140">
          <span class="hits">5</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:depth =&gt; depth])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_prev_hash(prev_hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="144">
          <span class="hits">2</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:prev_hash =&gt; htb(prev_hash).to_sequel_blob])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">      tx = @db[:tx][:hash =&gt; htb(tx_hash).to_sequel_blob]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">      return nil  unless tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">      parent = @db[:blk_tx][:tx_id =&gt; tx[:id]]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">      return nil  unless parent</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:id =&gt; parent[:blk_id]])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_id(block_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:id =&gt; block_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="160">
          <span class="hits">10</span>
          
          <code class="ruby">      wrap_tx(@db[:tx][:hash =&gt; htb(tx_hash).to_sequel_blob])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx_by_id(tx_id)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="164">
          <span class="hits">5</span>
          
          <code class="ruby">      wrap_tx(@db[:tx][:id =&gt; tx_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txin_for_txout(tx_hash, txout_idx)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="168">
          <span class="hits">3</span>
          
          <code class="ruby">      tx_hash = htb(tx_hash).reverse.to_sequel_blob</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="169">
          <span class="hits">3</span>
          
          <code class="ruby">      wrap_txin(@db[:txin][:prev_out =&gt; tx_hash, :prev_out_index =&gt; txout_idx])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txout_for_txin(txin)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      tx = @db[:tx][:hash =&gt; txin.prev_out.reverse.to_sequel_blob]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      return nil  unless tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      wrap_txout(@db[:txout][:tx_idx =&gt; txin.prev_out_index, :tx_id =&gt; tx[:id]])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_pk_script(script)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">      txouts = @db[:txout].filter(:pk_script =&gt; script.to_sequel_blob).order(:id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="180">
          <span class="hits">2</span>
          
          <code class="ruby">      txouts.map{|txout| wrap_txout(txout)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_hash160(hash160)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="184">
          <span class="hits">9</span>
          
          <code class="ruby">      @db[:txout].where(:hash160 =&gt; hash160).map{|o| wrap_txout(o) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_unconfirmed_tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      @db[:unconfirmed].map{|t| wrap_tx(t)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_block(block)</code>
        </li>
      
        <li class="covered" data-hits="157" data-linenumber="192">
          <span class="hits">157</span>
          
          <code class="ruby">      return nil  unless block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="194">
          <span class="hits">123</span>
          
          <code class="ruby">      data = {:id =&gt; block[:id], :depth =&gt; block[:depth]}</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="195">
          <span class="hits">123</span>
          
          <code class="ruby">      blk = Bitcoin::Storage::Models::Block.new(self, data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="197">
          <span class="hits">123</span>
          
          <code class="ruby">      blk.ver = block[:version]</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="198">
          <span class="hits">123</span>
          
          <code class="ruby">      blk.prev_block = block[:prev_hash].reverse</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="199">
          <span class="hits">123</span>
          
          <code class="ruby">      blk.mrkl_root = block[:mrkl_root].reverse</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="200">
          <span class="hits">123</span>
          
          <code class="ruby">      blk.time = block[:time].to_i</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="201">
          <span class="hits">123</span>
          
          <code class="ruby">      blk.bits = block[:bits]</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="202">
          <span class="hits">123</span>
          
          <code class="ruby">      blk.nonce = block[:nonce]</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="203">
          <span class="hits">123</span>
          
          <code class="ruby">      parents = db[:blk_tx].filter(:blk_id =&gt; block[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">        .order(:idx) rescue []</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="205">
          <span class="hits">123</span>
          
          <code class="ruby">      parents.each do |parent|</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="206">
          <span class="hits">123</span>
          
          <code class="ruby">        transaction = db[:tx][:id =&gt; parent[:tx_id]]</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="207">
          <span class="hits">123</span>
          
          <code class="ruby">        blk.tx &lt;&lt; wrap_tx(transaction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="210">
          <span class="hits">123</span>
          
          <code class="ruby">      blk.recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="211">
          <span class="hits">123</span>
          
          <code class="ruby">      blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_tx(transaction)</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="215">
          <span class="hits">138</span>
          
          <code class="ruby">      return nil  unless transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="217">
          <span class="hits">137</span>
          
          <code class="ruby">      parent = @db[:blk_tx][:tx_id =&gt; transaction[:id]]</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="218">
          <span class="hits">137</span>
          
          <code class="ruby">      block_id = parent ? parent[:blk_id] : nil</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="219">
          <span class="hits">137</span>
          
          <code class="ruby">      data = {:id =&gt; transaction[:id], :blk_id =&gt; block_id}</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="220">
          <span class="hits">137</span>
          
          <code class="ruby">      tx = Bitcoin::Storage::Models::Tx.new(self, data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="222">
          <span class="hits">137</span>
          
          <code class="ruby">      inputs = db[:txin].filter(:tx_id =&gt; transaction[:id]).order(:tx_idx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="298" data-linenumber="224">
          <span class="hits">298</span>
          
          <code class="ruby">      inputs.each { |i| tx.add_in(wrap_txin(i)) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="226">
          <span class="hits">137</span>
          
          <code class="ruby">      outputs = db[:txout].filter(:tx_id =&gt; transaction[:id]).order(:tx_idx)</code>
        </li>
      
        <li class="covered" data-hits="283" data-linenumber="227">
          <span class="hits">283</span>
          
          <code class="ruby">      outputs.each { |o| tx.add_out(wrap_txout(o)) }</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="228">
          <span class="hits">137</span>
          
          <code class="ruby">      tx.ver = transaction[:version]</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="229">
          <span class="hits">137</span>
          
          <code class="ruby">      tx.lock_time = transaction[:lock_time]</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="230">
          <span class="hits">137</span>
          
          <code class="ruby">      tx.hash = tx.hash_from_payload(tx.to_payload)</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="231">
          <span class="hits">137</span>
          
          <code class="ruby">      tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txin(input)</code>
        </li>
      
        <li class="covered" data-hits="164" data-linenumber="235">
          <span class="hits">164</span>
          
          <code class="ruby">      return nil  unless input</code>
        </li>
      
        <li class="covered" data-hits="162" data-linenumber="236">
          <span class="hits">162</span>
          
          <code class="ruby">      data = {:id =&gt; input[:id], :tx_id =&gt; input[:tx_id], :tx_idx =&gt; input[:tx_idx]}</code>
        </li>
      
        <li class="covered" data-hits="162" data-linenumber="237">
          <span class="hits">162</span>
          
          <code class="ruby">      txin = Bitcoin::Storage::Models::TxIn.new(self, data)</code>
        </li>
      
        <li class="covered" data-hits="162" data-linenumber="238">
          <span class="hits">162</span>
          
          <code class="ruby">      txin.prev_out = input[:prev_out]</code>
        </li>
      
        <li class="covered" data-hits="162" data-linenumber="239">
          <span class="hits">162</span>
          
          <code class="ruby">      txin.prev_out_index = input[:prev_out_index]</code>
        </li>
      
        <li class="covered" data-hits="162" data-linenumber="240">
          <span class="hits">162</span>
          
          <code class="ruby">      txin.script_sig_length = input[:script_sig].bytesize</code>
        </li>
      
        <li class="covered" data-hits="162" data-linenumber="241">
          <span class="hits">162</span>
          
          <code class="ruby">      txin.script_sig = input[:script_sig]</code>
        </li>
      
        <li class="covered" data-hits="162" data-linenumber="242">
          <span class="hits">162</span>
          
          <code class="ruby">      txin.sequence = [input[:sequence]].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="162" data-linenumber="243">
          <span class="hits">162</span>
          
          <code class="ruby">      txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txout(output)</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="247">
          <span class="hits">151</span>
          
          <code class="ruby">      return nil  unless output</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="248">
          <span class="hits">151</span>
          
          <code class="ruby">      data = {:id =&gt; output[:id], :tx_id =&gt; output[:tx_id], :tx_idx =&gt; output[:tx_idx],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">        :hash160 =&gt; output[:hash160]}</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="250">
          <span class="hits">151</span>
          
          <code class="ruby">      txout = Bitcoin::Storage::Models::TxOut.new(self, data)</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="251">
          <span class="hits">151</span>
          
          <code class="ruby">      txout.value = output[:value]</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="252">
          <span class="hits">151</span>
          
          <code class="ruby">      txout.pk_script_length = output[:pk_script].bytesize</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="253">
          <span class="hits">151</span>
          
          <code class="ruby">      txout.pk_script = output[:pk_script]</code>
        </li>
      
        <li class="covered" data-hits="151" data-linenumber="254">
          <span class="hits">151</span>
          
          <code class="ruby">      txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="258">
          <span class="hits">128</span>
          
          <code class="ruby">    def hth(bin); bin.unpack(&quot;H*&quot;)[0]; end</code>
        </li>
      
        <li class="covered" data-hits="822" data-linenumber="259">
          <span class="hits">822</span>
          
          <code class="ruby">    def htb(hex); [hex].pack(&quot;H*&quot;); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="13a1bc7c31c7c9123a61b240d7b469d94bd56dc9">
  <div class="header">
    <h3>lib/bitcoin/storage/sequel_store/sequel_migrations.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>47</b> relevant lines. 
      <span class="green"><b>47</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Backends::SequelMigrations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  def migrate</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="4">
          <span class="hits">30</span>
          
          <code class="ruby">    unless @db.tables.include?(:blk)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="5">
          <span class="hits">30</span>
          
          <code class="ruby">      @db.create_table :blk do</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="6">
          <span class="hits">30</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="7">
          <span class="hits">30</span>
          
          <code class="ruby">        column :hash, :bytea, :null =&gt; false, :unique =&gt; true, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="8">
          <span class="hits">30</span>
          
          <code class="ruby">        column :depth, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="9">
          <span class="hits">30</span>
          
          <code class="ruby">        column :version, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="10">
          <span class="hits">30</span>
          
          <code class="ruby">        column :prev_hash, :bytea, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="11">
          <span class="hits">30</span>
          
          <code class="ruby">        column :mrkl_root, :bytea, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="12">
          <span class="hits">30</span>
          
          <code class="ruby">        column :time, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="13">
          <span class="hits">30</span>
          
          <code class="ruby">        column :bits, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="14">
          <span class="hits">30</span>
          
          <code class="ruby">        column :nonce, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="15">
          <span class="hits">30</span>
          
          <code class="ruby">        column :blk_size, :int, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="19">
          <span class="hits">30</span>
          
          <code class="ruby">    unless @db.tables.include?(:tx)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="20">
          <span class="hits">30</span>
          
          <code class="ruby">      @db.create_table :tx do</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="21">
          <span class="hits">30</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="22">
          <span class="hits">30</span>
          
          <code class="ruby">        column :hash, :bytea, :null =&gt; false, :unique =&gt; true, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="23">
          <span class="hits">30</span>
          
          <code class="ruby">        column :version, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="24">
          <span class="hits">30</span>
          
          <code class="ruby">        column :lock_time, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="25">
          <span class="hits">30</span>
          
          <code class="ruby">        column :coinbase, :bool, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="26">
          <span class="hits">30</span>
          
          <code class="ruby">        column :tx_size, :int, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="30">
          <span class="hits">30</span>
          
          <code class="ruby">    unless @db.tables.include?(:blk_tx)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="31">
          <span class="hits">30</span>
          
          <code class="ruby">      @db.create_table :blk_tx do</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="32">
          <span class="hits">30</span>
          
          <code class="ruby">        column :blk_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="33">
          <span class="hits">30</span>
          
          <code class="ruby">        column :tx_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="34">
          <span class="hits">30</span>
          
          <code class="ruby">        column :idx, :int, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="38">
          <span class="hits">30</span>
          
          <code class="ruby">    unless @db.tables.include?(:txin)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="39">
          <span class="hits">30</span>
          
          <code class="ruby">      @db.create_table :txin do</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="40">
          <span class="hits">30</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="41">
          <span class="hits">30</span>
          
          <code class="ruby">        column :tx_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="42">
          <span class="hits">30</span>
          
          <code class="ruby">        column :tx_idx, :int, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="43">
          <span class="hits">30</span>
          
          <code class="ruby">        column :script_sig, :bytea, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="44">
          <span class="hits">30</span>
          
          <code class="ruby">        column :prev_out, :bytea, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="45">
          <span class="hits">30</span>
          
          <code class="ruby">        column :prev_out_index, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="46">
          <span class="hits">30</span>
          
          <code class="ruby">        column :sequence, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="50">
          <span class="hits">30</span>
          
          <code class="ruby">    unless @db.tables.include?(:txout)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="51">
          <span class="hits">30</span>
          
          <code class="ruby">      @db.create_table :txout do</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="52">
          <span class="hits">30</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="53">
          <span class="hits">30</span>
          
          <code class="ruby">        column :tx_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="54">
          <span class="hits">30</span>
          
          <code class="ruby">        column :tx_idx, :int, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="55">
          <span class="hits">30</span>
          
          <code class="ruby">        column :pk_script, :bytea, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="56">
          <span class="hits">30</span>
          
          <code class="ruby">        column :value, :bigint</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="57">
          <span class="hits">30</span>
          
          <code class="ruby">        column :hash160, String</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="58">
          <span class="hits">30</span>
          
          <code class="ruby">        index :hash160</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="62">
          <span class="hits">30</span>
          
          <code class="ruby">    unless @db.views.include?(:unconfirmed)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="63">
          <span class="hits">30</span>
          
          <code class="ruby">      @db.create_view(:unconfirmed,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        &quot;SELECT * FROM tx WHERE NOT EXISTS &quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        &quot;(SELECT 1 FROM blk_tx WHERE blk_tx.tx_id = tx.id)&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        &quot;ORDER BY tx.id DESC&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1e47ca20dcc1dba7324b2d0287e768352d49ee12">
  <div class="header">
    <h3>lib/bitcoin/storage/storage.rb</h3>
    <h4><span class="red">75.36 %</span> covered</h4>
    <div>
      <b>69</b> relevant lines. 
      <span class="green"><b>52</b> lines covered</span> and
      <span class="red"><b>17</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Models, 'bitcoin/storage/models'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  @log = Bitcoin::Logger.create(&quot;storage&quot;)</code>
        </li>
      
        <li class="covered" data-hits="121" data-linenumber="6">
          <span class="hits">121</span>
          
          <code class="ruby">  def self.log; @log; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  BACKENDS = [:dummy, :sequel, :activerecord]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  BACKENDS.each do |name|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    module_eval &lt;&lt;-EOS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      def self.#{name} config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">        Backends.const_get(&quot;#{name.capitalize}Store&quot;).new(config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="14">
          <span class="hits">3</span>
          
          <code class="ruby">    EOS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  module Backends</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="19">
          <span class="hits">4</span>
          
          <code class="ruby">    BACKENDS.each {|b| autoload(&quot;#{b.to_s.capitalize}Store&quot;, &quot;bitcoin/storage/#{b}&quot;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # Base class for storage backends.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # Every backend must overwrite the &quot;Not implemented&quot; methods</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # and provide an implementation specific to the storage.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    # Also, before returning the objects, they should be wrapped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    # inside the appropriate Bitcoin::Storage::Models class.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    class StoreBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(config = {})</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="29">
          <span class="hits">60</span>
          
          <code class="ruby">        @config = config</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="30">
          <span class="hits">60</span>
          
          <code class="ruby">        @log    = config[:log] || Bitcoin::Storage.log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      # get the storage logger</code>
        </li>
      
        <li class="covered" data-hits="257" data-linenumber="34">
          <span class="hits">257</span>
          
          <code class="ruby">      def log; @log; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      # reset the store; delete all data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      def reset</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # store given +block+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      def store_block(blk)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      # store given +tx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      def store_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      # check if block with given +blk_hash+ is already stored</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      def has_block(blk_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      # check if tx with given +tx_hash+ is already stored</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">      def has_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      # get the hash of the leading block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_head</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      # return depth of the head block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_depth</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      # compute blockchain locator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_locator</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="73">
          <span class="hits">2</span>
          
          <code class="ruby">        return [Bitcoin::hth(&quot;\x00&quot;*32)]  if get_depth == -1</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="74">
          <span class="hits">2</span>
          
          <code class="ruby">        locator = []</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="75">
          <span class="hits">2</span>
          
          <code class="ruby">        pointer = get_head</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="76">
          <span class="hits">2</span>
          
          <code class="ruby">        step = 1</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="77">
          <span class="hits">2</span>
          
          <code class="ruby">        while pointer &amp;&amp; pointer.hash != Bitcoin::network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="78">
          <span class="hits">6</span>
          
          <code class="ruby">          locator &lt;&lt; pointer.hash</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="79">
          <span class="hits">6</span>
          
          <code class="ruby">          depth = pointer.depth - step</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="80">
          <span class="hits">6</span>
          
          <code class="ruby">          break unless depth &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="81">
          <span class="hits">4</span>
          
          <code class="ruby">          prev_block = get_block_by_depth(depth) # TODO</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="82">
          <span class="hits">4</span>
          
          <code class="ruby">          break unless prev_block</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="83">
          <span class="hits">4</span>
          
          <code class="ruby">          pointer = prev_block</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="84">
          <span class="hits">4</span>
          
          <code class="ruby">          step *= 2  if locator.size &gt; 10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="86">
          <span class="hits">2</span>
          
          <code class="ruby">        locator &lt;&lt; Bitcoin::network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="87">
          <span class="hits">2</span>
          
          <code class="ruby">        locator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      # get block with given +blk_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block(blk_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      # get block with given +depth+ from main chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_depth(depth)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      # get block with given +prev_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_prev_hash(prev_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      # get block that includes tx with given +tx_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      # get block by given +block_id+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_id(block_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      # get corresponding txin for the txout in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      # transaction +tx_hash+ with index +txout_idx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_txin_for_txout(tx_hash, txout_idx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      # get tx with given +tx_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      # get tx with given +tx_id+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_tx_by_id(tx_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      # collect all txouts containing the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      # given +script+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_txouts_for_pk_script(script)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      # collect all txouts containing a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      # standard tx to given +address+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_txouts_for_address(address)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="140">
          <span class="hits">2</span>
          
          <code class="ruby">        hash160 = Bitcoin.hash160_from_address(address)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="141">
          <span class="hits">2</span>
          
          <code class="ruby">        get_txouts_for_hash160(hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      # get balance for given +hash160+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_balance(hash160)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="146">
          <span class="hits">6</span>
          
          <code class="ruby">        txouts = get_txouts_for_hash160(hash160)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="147">
          <span class="hits">10</span>
          
          <code class="ruby">        unspent = txouts.select {|o| o.get_next_in.nil?}</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="148">
          <span class="hits">6</span>
          
          <code class="ruby">        unspent.map(&amp;:value).inject {|a,b| a+=b; a} || 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">        nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="45d4f28fae6f671f74cefe8a341bf4686a58205e">
  <div class="header">
    <h3>lib/bitcoin/wallet/coinselector.rb</h3>
    <h4><span class="green">92.31 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  class SimpleCoinSelector</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize txouts</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      @txouts = txouts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    def select(value)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">      txouts = []</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">      @txouts.each do |txout|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="12">
          <span class="hits">6</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="13">
          <span class="hits">6</span>
          
          <code class="ruby">          next  if txout.get_next_in</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="14">
          <span class="hits">5</span>
          
          <code class="ruby">          next  unless txout.get_address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">          # next  unless txout.get_tx.get_block</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="16">
          <span class="hits">5</span>
          
          <code class="ruby">          txouts &lt;&lt; txout</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="17">
          <span class="hits">5</span>
          
          <code class="ruby">          return txouts  if txouts.map(&amp;:value).inject(:+) &gt;= value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">          p $!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5b4d2b3b2b9a07acc2e0db4dcc389a361c4af330">
  <div class="header">
    <h3>lib/bitcoin/wallet/keygenerator.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>27</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # Deterministic key generator as described in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # https://bitcointalk.org/index.php?topic=11665.0.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Takes a seed and generates an arbitrary amount of keys.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Protects against brute-force attacks by requiring the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # key hash to fit a difficulty target, much like the block chain.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  class KeyGenerator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # difficulty target (0x0000FFFF00000000000000000000000000000000000000000000000000000000)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    DEFAULT_TARGET = 0x0000FFFF00000000000000000000000000000000000000000000000000000000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :seed, :nonce, :target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # Initialize key generator with optional +seed+ and +nonce+ and +target+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # [seed] the seed data for the keygenerator (default: random)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # [nonce] the nonce required to satisfy the target (default: computed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # [target] custom difficulty target (default: DEFAULT_TARGET)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # Example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    #  g = KeyGenerator.new # random seed, computed nonce, default target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    #  KeyGenerator.new(g.seed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    #  KeyGenerator.new(g.seed, g.nonce)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    #  g.get_key(0) #=&gt; &lt;Bitcoin::Key&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # Note: When initializing without seed, you should obviously save the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # seed once it is generated. Saving the nonce is optional; it only saves time.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize seed = nil, nonce = nil, target = nil</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="30">
          <span class="hits">15</span>
          
          <code class="ruby">      @seed = seed || OpenSSL::Random.random_bytes(64)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="31">
          <span class="hits">15</span>
          
          <code class="ruby">      @target = target || DEFAULT_TARGET</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="32">
          <span class="hits">15</span>
          
          <code class="ruby">      @nonce = check_nonce(nonce)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    # get key number +n+ from chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_key(n = 0)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="37">
          <span class="hits">24</span>
          
          <code class="ruby">      key = get_hash(@seed, @nonce)</code>
        </li>
      
        <li class="covered" data-hits="118" data-linenumber="38">
          <span class="hits">118</span>
          
          <code class="ruby">      (n + 1).times { key = sha256(key) }</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="39">
          <span class="hits">24</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="40">
          <span class="hits">24</span>
          
          <code class="ruby">      Bitcoin::Key.new(key.unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # find a nonce that leads to the privkey satisfying the target</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    def find_nonce</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="45">
          <span class="hits">7</span>
          
          <code class="ruby">      n = 0</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="46">
          <span class="hits">7</span>
          
          <code class="ruby">      n += 1  while !check_target(get_hash(@seed, n))</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="47">
          <span class="hits">7</span>
          
          <code class="ruby">      n</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    # check the nonce; compute if missing, raise if invalid.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    def check_nonce(nonce)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="54">
          <span class="hits">15</span>
          
          <code class="ruby">      return find_nonce  unless nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      # check_target(get_hash(@seed, nonce)) ? nonce : find_nonce</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="56">
          <span class="hits">8</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Nonce invalid.&quot;  unless check_target(get_hash(@seed, nonce))</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="57">
          <span class="hits">7</span>
          
          <code class="ruby">      nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    # check if given +hash+ satisfies the difficulty target</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    def check_target(hash)</code>
        </li>
      
        <li class="covered" data-hits="5671" data-linenumber="62">
          <span class="hits">5671</span>
          
          <code class="ruby">      hash.unpack(&quot;H*&quot;)[0].to_i(16) &lt; @target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    # compute a single SHA256 hash for +d+.</code>
        </li>
      
        <li class="covered" data-hits="17180" data-linenumber="66">
          <span class="hits">17180</span>
          
          <code class="ruby">    def sha256(d); Digest::SHA256.digest(d); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    # get the hash corresponding to +seed+ and +n+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_hash(seed, n)</code>
        </li>
      
        <li class="covered" data-hits="5695" data-linenumber="70">
          <span class="hits">5695</span>
          
          <code class="ruby">      sha256( sha256(seed) + sha256(n.to_s) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="02f674ef66c656bec0454c93dca59c930de55849">
  <div class="header">
    <h3>lib/bitcoin/wallet/keystore.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>51</b> relevant lines. 
      <span class="green"><b>51</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'json'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # JSON-file-based keystore.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  class SimpleKeyStore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # Initialize keystore.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # [config] Hash of settings ({:file =&gt; &quot;/foo/bar.json&quot;})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize config</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="11">
          <span class="hits">24</span>
          
          <code class="ruby">      @config = Hash[config.map{|k,v|[k.to_sym,v]}]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="12">
          <span class="hits">12</span>
          
          <code class="ruby">      @keys = {}</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="13">
          <span class="hits">12</span>
          
          <code class="ruby">      load_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # List all stored keys.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    def keys</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="18">
          <span class="hits">8</span>
          
          <code class="ruby">      @keys.values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # Get key for given +addr+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    def key(addr)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="23">
          <span class="hits">2</span>
          
          <code class="ruby">      @keys[addr]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    # Generate and store a new key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    def new_key</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="28">
          <span class="hits">3</span>
          
          <code class="ruby">      key = Bitcoin::Key.generate</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="29">
          <span class="hits">3</span>
          
          <code class="ruby">      @keys[key.addr] = key</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="30">
          <span class="hits">3</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="31">
          <span class="hits">3</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    def delete(addr)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="35">
          <span class="hits">2</span>
          
          <code class="ruby">      @keys.delete(addr)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    # Export key for given +addr+ to base58 format.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    # (See Bitcoin::Key#to_base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    def export(addr)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      @keys[addr].to_base58</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    # Import key from given +base58+ string.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    # (See Bitcoin::Key.from_base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    def import(base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">      key = Bitcoin::Key.from_base58(base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">      @keys[key.addr] = key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      key.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    # Load keys from file.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    # If file is emty this will generate a new key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    # and store it, creating the file.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def load_keys</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="58">
          <span class="hits">12</span>
          
          <code class="ruby">      if File.exist?(@config[:file])</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="59">
          <span class="hits">10</span>
          
          <code class="ruby">        data = JSON.load(File.read(@config[:file]))</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="60">
          <span class="hits">21</span>
          
          <code class="ruby">        data.map {|a, k| @keys[a] = Bitcoin::Key.from_base58(k)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="62">
          <span class="hits">2</span>
          
          <code class="ruby">        new_key; save_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    # Save keys to file.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    def save_keys</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="68">
          <span class="hits">9</span>
          
          <code class="ruby">      File.open(@config[:file], 'w') do |file|</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="69">
          <span class="hits">20</span>
          
          <code class="ruby">        file.write(Hash[@keys.map {|a, k| [a, k.to_base58]}].to_json)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  # Deterministic keystore.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  class DeterministicKeyStore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :generator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    # Initialize keystore.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    # [config] Hash of settings ({:keys =&gt; 1, :seed =&gt; ..., :nonce =&gt; ...})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize config</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="83">
          <span class="hits">27</span>
          
          <code class="ruby">      @config = Hash[config.map{|k,v|[k.to_sym,v]}]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="84">
          <span class="hits">7</span>
          
          <code class="ruby">      @config[:keys] = (@config[:keys] || 1).to_i</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="85">
          <span class="hits">7</span>
          
          <code class="ruby">      @generator = Bitcoin::Wallet::KeyGenerator.new(@config[:seed], @config[:nonce])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    # List all keys upto configured limit.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    def keys</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="90">
          <span class="hits">11</span>
          
          <code class="ruby">      1.upto(@config[:keys].to_i).map {|i| @generator.get_key(i) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    # Get key for given +addr+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">    def key(addr)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="95">
          <span class="hits">2</span>
          
          <code class="ruby">      1.upto(@config[:keys].to_i).map do |i|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="96">
          <span class="hits">2</span>
          
          <code class="ruby">        key = @generator.get_key(i)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">        return key  if key.addr == addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    # Get new key (actually just increase the key limit).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    def new_key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">      @config[:keys] += 1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">      @generator.get_key(@config[:keys])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    # Export key for given +addr+ to base58.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    # (See Bitcoin::Key.to_base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    def export(addr)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">      key(addr).to_base58 rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5f86fc73b1d974c21d9992a33e59689fa75b4089">
  <div class="header">
    <h3>lib/bitcoin/wallet/wallet.rb</h3>
    <h4><span class="green">96.72 %</span> covered</h4>
    <div>
      <b>61</b> relevant lines. 
      <span class="green"><b>59</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  class Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :keystore</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize storage, keystore, selector</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="7">
          <span class="hits">12</span>
          
          <code class="ruby">      @storage = storage</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="8">
          <span class="hits">12</span>
          
          <code class="ruby">      @keystore = keystore</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="9">
          <span class="hits">12</span>
          
          <code class="ruby">      @selector = selector</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="13">
          <span class="hits">15</span>
          
          <code class="ruby">      @keystore.keys.map {|k|</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="14">
          <span class="hits">16</span>
          
          <code class="ruby">        @storage.get_txouts_for_address(k.addr)}.flatten</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_balance</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="18">
          <span class="hits">6</span>
          
          <code class="ruby">      values = get_txouts.select{|o| !o.get_next_in}.map(&amp;:value)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="19">
          <span class="hits">3</span>
          
          <code class="ruby">      ([0] + values).inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    def addrs</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="23">
          <span class="hits">19</span>
          
          <code class="ruby">      @keystore.keys.map{|k| k.addr}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    def list</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="27">
          <span class="hits">2</span>
          
          <code class="ruby">      @keystore.keys.map do |key|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">        [key.addr, @storage.get_balance(Bitcoin.hash160_from_address(key.addr))]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_new_addr</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">      @keystore.new_key.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_selector</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="37">
          <span class="hits">12</span>
          
          <code class="ruby">      @selector.new(get_txouts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    # outputs = [&lt;addr&gt;, &lt;value&gt;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    def tx outputs, fee = 0, change_policy = :back</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="42">
          <span class="hits">24</span>
          
          <code class="ruby">      prev_outs = get_selector.select(outputs.map{|o| o[1]}.inject(:+))</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="43">
          <span class="hits">12</span>
          
          <code class="ruby">      return nil  if !prev_outs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="45">
          <span class="hits">12</span>
          
          <code class="ruby">      tx = Bitcoin::Protocol::Tx.new(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="47">
          <span class="hits">12</span>
          
          <code class="ruby">      input_value = prev_outs.map(&amp;:value).inject(:+)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="48">
          <span class="hits">24</span>
          
          <code class="ruby">      output_value = outputs.map{|o|o[1]}.inject(:+)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="49">
          <span class="hits">12</span>
          
          <code class="ruby">      return nil  unless input_value &gt;= (output_value + fee)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="51">
          <span class="hits">11</span>
          
          <code class="ruby">      outputs.each do |addr, value|</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="52">
          <span class="hits">11</span>
          
          <code class="ruby">        script = Bitcoin::Script.to_address_script(addr)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="53">
          <span class="hits">11</span>
          
          <code class="ruby">        txout = Bitcoin::Protocol::TxOut.new(value, script.bytesize, script)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="54">
          <span class="hits">11</span>
          
          <code class="ruby">        tx.add_out(txout)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="57">
          <span class="hits">11</span>
          
          <code class="ruby">      change_value = input_value - output_value - fee</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="58">
          <span class="hits">11</span>
          
          <code class="ruby">      if change_value &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="59">
          <span class="hits">11</span>
          
          <code class="ruby">        change_addr = get_change_addr(change_policy,prev_outs.sample.get_address)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="60">
          <span class="hits">11</span>
          
          <code class="ruby">        pk_script = Bitcoin::Script.to_address_script(change_addr)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="61">
          <span class="hits">11</span>
          
          <code class="ruby">        change = Bitcoin::Protocol::TxOut.new(input_value - output_value - fee,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">          pk_script.bytesize, pk_script)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="63">
          <span class="hits">11</span>
          
          <code class="ruby">        tx.add_out(change)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="66">
          <span class="hits">11</span>
          
          <code class="ruby">      prev_outs.each_with_index do |prev_out, idx|</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="67">
          <span class="hits">11</span>
          
          <code class="ruby">        prev_tx = prev_out.get_tx</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="68">
          <span class="hits">11</span>
          
          <code class="ruby">        txin = Bitcoin::Protocol::TxIn.new(prev_tx.binary_hash,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">          prev_tx.out.index(prev_out), 0)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="70">
          <span class="hits">11</span>
          
          <code class="ruby">        tx.add_in(txin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="73">
          <span class="hits">11</span>
          
          <code class="ruby">      prev_outs.each_with_index do |prev_out, idx|</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="74">
          <span class="hits">11</span>
          
          <code class="ruby">        prev_tx = prev_out.get_tx</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="75">
          <span class="hits">11</span>
          
          <code class="ruby">        key = @keystore.key(prev_out.get_address)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="76">
          <span class="hits">11</span>
          
          <code class="ruby">        sig_hash = tx.signature_hash_for_input(idx, prev_tx)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="77">
          <span class="hits">11</span>
          
          <code class="ruby">        sig = key.sign(sig_hash)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="78">
          <span class="hits">11</span>
          
          <code class="ruby">        script_sig = Bitcoin::Script.to_signature_pubkey_script(sig, [key.pub].pack(&quot;H*&quot;))</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="79">
          <span class="hits">11</span>
          
          <code class="ruby">        tx.in[idx].script_sig_length = script_sig.bytesize</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="80">
          <span class="hits">11</span>
          
          <code class="ruby">        tx.in[idx].script_sig = script_sig</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="81">
          <span class="hits">11</span>
          
          <code class="ruby">        raise &quot;Signature error&quot;  unless tx.verify_input_signature(idx, prev_tx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="84">
          <span class="hits">11</span>
          
          <code class="ruby">      Bitcoin::Protocol::Tx.new(tx.to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_change_addr(policy, in_addr)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="90">
          <span class="hits">11</span>
          
          <code class="ruby">      case policy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      when :first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">        @keystore.keys[0].addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      when :random</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        @keystore.keys.sample.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      when :new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">        @keystore.new_key.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      when :back</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="98">
          <span class="hits">9</span>
          
          <code class="ruby">        in_addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">        policy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
      </div>
    </div>
  </body>
</html>
