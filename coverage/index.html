<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Bitcoin-ruby</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.5.3/jquery-1.6.2.min.js' type='text/javascript'></script>
    <script src='./assets/0.5.3/jquery.dataTables.min.js' type='text/javascript'></script>   
    <script src='./assets/0.5.3/fancybox/jquery.fancybox-1.3.1.pack.js' type='text/javascript'></script>   
    <script src='./assets/0.5.3/jquery.timeago.js' type='text/javascript'></script>   
    <script src='./assets/0.5.3/jquery.url.js' type='text/javascript'></script>   
    <script src='./assets/0.5.3/highlight.pack.js' type='text/javascript'></script>  
    <script src='./assets/0.5.3/app.js' type='text/javascript'></script>    
    <link href='./assets/0.5.3/stylesheet.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link href='./assets/0.5.3/highlight.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link href='./assets/0.5.3/fancybox/jquery.fancybox-1.3.1.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link href='./assets/0.5.3/smoothness/jquery-ui-1.8.4.custom.css' media='screen, projection, print' rel='stylesheet' type='text/css'>    
    <link rel="shortcut icon" type="image/png" href="./assets/0.5.3/favicon_yellow.png" />
    <link rel="icon" type="image/png" href="./assets/0.5.3/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.5.3/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2012-10-03T19:05:22+02:00">2012-10-03T19:05:22+02:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="yellow">88.16%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         346.59
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>28</b> files in total.
    <b>2415</b> relevant lines. 
    <span class="green"><b>2129</b> lines covered</span> and
    <span class="red"><b>286</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#6291547fade947731b570fd2a9162416476301a6" class="src_link" title="lib/bitcoin.rb">lib/bitcoin.rb</a></td>
        <td class="green strong">95.83 %</td>
        <td>404</td>
        <td>216</td>
        <td>207</td>
        <td>9</td>
        <td>3388.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6ad895c6fd6140cbd279d839c3cab431fd71d2a7" class="src_link" title="lib/bitcoin/builder.rb">lib/bitcoin/builder.rb</a></td>
        <td class="green strong">91.2 %</td>
        <td>266</td>
        <td>125</td>
        <td>114</td>
        <td>11</td>
        <td>483.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2dcb72f38404c85bd4fe44aeed3d3b7e4562fc0c" class="src_link" title="lib/bitcoin/ffi/openssl.rb">lib/bitcoin/ffi/openssl.rb</a></td>
        <td class="green strong">98.67 %</td>
        <td>121</td>
        <td>75</td>
        <td>74</td>
        <td>1</td>
        <td>109.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb82939148b5de4151cdeacc2d9ed89caee32ee5" class="src_link" title="lib/bitcoin/key.rb">lib/bitcoin/key.rb</a></td>
        <td class="green strong">98.0 %</td>
        <td>125</td>
        <td>50</td>
        <td>49</td>
        <td>1</td>
        <td>70.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5d6d97008ffec5aff3bc91103ab60ec056c27d1" class="src_link" title="lib/bitcoin/logger.rb">lib/bitcoin/logger.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>65</td>
        <td>35</td>
        <td>28</td>
        <td>7</td>
        <td>11.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#097a63ca9e1638fe6b84d7fad2f0982e08134c36" class="src_link" title="lib/bitcoin/protocol.rb">lib/bitcoin/protocol.rb</a></td>
        <td class="red strong">75.0 %</td>
        <td>137</td>
        <td>80</td>
        <td>60</td>
        <td>20</td>
        <td>339.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7232aa03263e2a301dcf3642c61bc0272ac13cbf" class="src_link" title="lib/bitcoin/protocol/address.rb">lib/bitcoin/protocol/address.rb</a></td>
        <td class="green strong">95.0 %</td>
        <td>48</td>
        <td>20</td>
        <td>19</td>
        <td>1</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7d06569f2eaac3f62f37ef5987a9d46ed2181b70" class="src_link" title="lib/bitcoin/protocol/alert.rb">lib/bitcoin/protocol/alert.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>47</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b85bdf561b3dc51ecfd89215f675dc4ae6ab50a3" class="src_link" title="lib/bitcoin/protocol/block.rb">lib/bitcoin/protocol/block.rb</a></td>
        <td class="green strong">92.31 %</td>
        <td>175</td>
        <td>78</td>
        <td>72</td>
        <td>6</td>
        <td>352.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec26a72c762bc13eda908614b56e96d8669a4d80" class="src_link" title="lib/bitcoin/protocol/handler.rb">lib/bitcoin/protocol/handler.rb</a></td>
        <td class="red strong">58.82 %</td>
        <td>37</td>
        <td>17</td>
        <td>10</td>
        <td>7</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#557ee148bb367f942116155fdc327b5fa7942241" class="src_link" title="lib/bitcoin/protocol/parser.rb">lib/bitcoin/protocol/parser.rb</a></td>
        <td class="red strong">72.83 %</td>
        <td>154</td>
        <td>92</td>
        <td>67</td>
        <td>25</td>
        <td>4.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#50420e37470493cafba8f41ed05b633a062fcdf4" class="src_link" title="lib/bitcoin/protocol/tx.rb">lib/bitcoin/protocol/tx.rb</a></td>
        <td class="green strong">94.83 %</td>
        <td>244</td>
        <td>116</td>
        <td>110</td>
        <td>6</td>
        <td>420.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1535735601f850f0edb630e497ee3ca0f6253a95" class="src_link" title="lib/bitcoin/protocol/txin.rb">lib/bitcoin/protocol/txin.rb</a></td>
        <td class="green strong">97.96 %</td>
        <td>96</td>
        <td>49</td>
        <td>48</td>
        <td>1</td>
        <td>696.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#925463098a998a603cae90a61e90032defc0f861" class="src_link" title="lib/bitcoin/protocol/txout.rb">lib/bitcoin/protocol/txout.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>73</td>
        <td>40</td>
        <td>40</td>
        <td>0</td>
        <td>1253.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#64138ab3345824464f68bf4ae98e60bd0dbb4ca8" class="src_link" title="lib/bitcoin/protocol/version.rb">lib/bitcoin/protocol/version.rb</a></td>
        <td class="green strong">96.77 %</td>
        <td>72</td>
        <td>31</td>
        <td>30</td>
        <td>1</td>
        <td>2.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9997f171293226ec441ccaa33d726c508ff07a39" class="src_link" title="lib/bitcoin/script.rb">lib/bitcoin/script.rb</a></td>
        <td class="green strong">96.26 %</td>
        <td>656</td>
        <td>348</td>
        <td>335</td>
        <td>13</td>
        <td>532.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3df1335f475b9f7cfa9efdfa05ebfc5a3780d534" class="src_link" title="lib/bitcoin/storage/dummy.rb">lib/bitcoin/storage/dummy.rb</a></td>
        <td class="red strong">25.74 %</td>
        <td>164</td>
        <td>101</td>
        <td>26</td>
        <td>75</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a5b4193a8f28e1aea5ab2063c2b6e6b27fea99ad" class="src_link" title="lib/bitcoin/storage/models.rb">lib/bitcoin/storage/models.rb</a></td>
        <td class="green strong">93.65 %</td>
        <td>137</td>
        <td>63</td>
        <td>59</td>
        <td>4</td>
        <td>285.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2b02df19bf3e2d30c17039c18855058d8a44f920" class="src_link" title="lib/bitcoin/storage/sequel.rb">lib/bitcoin/storage/sequel.rb</a></td>
        <td class="green strong">97.14 %</td>
        <td>349</td>
        <td>175</td>
        <td>170</td>
        <td>5</td>
        <td>352.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#13a1bc7c31c7c9123a61b240d7b469d94bd56dc9" class="src_link" title="lib/bitcoin/storage/sequel_store/sequel_migrations.rb">lib/bitcoin/storage/sequel_store/sequel_migrations.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>84</td>
        <td>55</td>
        <td>55</td>
        <td>0</td>
        <td>59.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1e47ca20dcc1dba7324b2d0287e768352d49ee12" class="src_link" title="lib/bitcoin/storage/storage.rb">lib/bitcoin/storage/storage.rb</a></td>
        <td class="yellow strong">83.58 %</td>
        <td>264</td>
        <td>134</td>
        <td>112</td>
        <td>22</td>
        <td>42.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1d2f3285b72675d82f9d16bd6660cd2e089bdc3a" class="src_link" title="lib/bitcoin/validation.rb">lib/bitcoin/validation.rb</a></td>
        <td class="green strong">97.76 %</td>
        <td>327</td>
        <td>134</td>
        <td>131</td>
        <td>3</td>
        <td>118.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0385197f5a931438685a32169b01ce2549a5ad96" class="src_link" title="lib/bitcoin/version.rb">lib/bitcoin/version.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#45d4f28fae6f671f74cefe8a341bf4686a58205e" class="src_link" title="lib/bitcoin/wallet/coinselector.rb">lib/bitcoin/wallet/coinselector.rb</a></td>
        <td class="green strong">92.86 %</td>
        <td>30</td>
        <td>14</td>
        <td>13</td>
        <td>1</td>
        <td>5.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5b4d2b3b2b9a07acc2e0db4dcc389a361c4af330" class="src_link" title="lib/bitcoin/wallet/keygenerator.rb">lib/bitcoin/wallet/keygenerator.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>75</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>1098.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#02f674ef66c656bec0454c93dca59c930de55849" class="src_link" title="lib/bitcoin/wallet/keystore.rb">lib/bitcoin/wallet/keystore.rb</a></td>
        <td class="green strong">91.74 %</td>
        <td>203</td>
        <td>109</td>
        <td>100</td>
        <td>9</td>
        <td>24.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e4537349f04bf547cb5970d59edb474b2c135d28" class="src_link" title="lib/bitcoin/wallet/txdp.rb">lib/bitcoin/wallet/txdp.rb</a></td>
        <td class="yellow strong">83.53 %</td>
        <td>116</td>
        <td>85</td>
        <td>71</td>
        <td>14</td>
        <td>41.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5f86fc73b1d974c21d9992a33e59689fa75b4089" class="src_link" title="lib/bitcoin/wallet/wallet.rb">lib/bitcoin/wallet/wallet.rb</a></td>
        <td class="red strong">62.39 %</td>
        <td>243</td>
        <td>117</td>
        <td>73</td>
        <td>44</td>
        <td>5.2</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
          <div class="file_list_container" id="Bitcoin">
  <h2>
    <span class="group_name">Bitcoin</span>
    (<span class="covered_percent"><span class="green">96.25%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         1330.4
       </span>
    </span> hits/line)
  </h2>
  <a name="Bitcoin"></a>
  <div>
    <b>3</b> files in total.
    <b>614</b> relevant lines. 
    <span class="green"><b>591</b> lines covered</span> and
    <span class="red"><b>23</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#6291547fade947731b570fd2a9162416476301a6" class="src_link" title="lib/bitcoin.rb">lib/bitcoin.rb</a></td>
        <td class="green strong">95.83 %</td>
        <td>404</td>
        <td>216</td>
        <td>207</td>
        <td>9</td>
        <td>3388.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb82939148b5de4151cdeacc2d9ed89caee32ee5" class="src_link" title="lib/bitcoin/key.rb">lib/bitcoin/key.rb</a></td>
        <td class="green strong">98.0 %</td>
        <td>125</td>
        <td>50</td>
        <td>49</td>
        <td>1</td>
        <td>70.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9997f171293226ec441ccaa33d726c508ff07a39" class="src_link" title="lib/bitcoin/script.rb">lib/bitcoin/script.rb</a></td>
        <td class="green strong">96.26 %</td>
        <td>656</td>
        <td>348</td>
        <td>335</td>
        <td>13</td>
        <td>532.6</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Protocol">
  <h2>
    <span class="group_name">Protocol</span>
    (<span class="covered_percent"><span class="yellow">87.82%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         307.35
       </span>
    </span> hits/line)
  </h2>
  <a name="Protocol"></a>
  <div>
    <b>10</b> files in total.
    <b>550</b> relevant lines. 
    <span class="green"><b>483</b> lines covered</span> and
    <span class="red"><b>67</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#097a63ca9e1638fe6b84d7fad2f0982e08134c36" class="src_link" title="lib/bitcoin/protocol.rb">lib/bitcoin/protocol.rb</a></td>
        <td class="red strong">75.0 %</td>
        <td>137</td>
        <td>80</td>
        <td>60</td>
        <td>20</td>
        <td>339.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7232aa03263e2a301dcf3642c61bc0272ac13cbf" class="src_link" title="lib/bitcoin/protocol/address.rb">lib/bitcoin/protocol/address.rb</a></td>
        <td class="green strong">95.0 %</td>
        <td>48</td>
        <td>20</td>
        <td>19</td>
        <td>1</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7d06569f2eaac3f62f37ef5987a9d46ed2181b70" class="src_link" title="lib/bitcoin/protocol/alert.rb">lib/bitcoin/protocol/alert.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>47</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b85bdf561b3dc51ecfd89215f675dc4ae6ab50a3" class="src_link" title="lib/bitcoin/protocol/block.rb">lib/bitcoin/protocol/block.rb</a></td>
        <td class="green strong">92.31 %</td>
        <td>175</td>
        <td>78</td>
        <td>72</td>
        <td>6</td>
        <td>352.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec26a72c762bc13eda908614b56e96d8669a4d80" class="src_link" title="lib/bitcoin/protocol/handler.rb">lib/bitcoin/protocol/handler.rb</a></td>
        <td class="red strong">58.82 %</td>
        <td>37</td>
        <td>17</td>
        <td>10</td>
        <td>7</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#557ee148bb367f942116155fdc327b5fa7942241" class="src_link" title="lib/bitcoin/protocol/parser.rb">lib/bitcoin/protocol/parser.rb</a></td>
        <td class="red strong">72.83 %</td>
        <td>154</td>
        <td>92</td>
        <td>67</td>
        <td>25</td>
        <td>4.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#50420e37470493cafba8f41ed05b633a062fcdf4" class="src_link" title="lib/bitcoin/protocol/tx.rb">lib/bitcoin/protocol/tx.rb</a></td>
        <td class="green strong">94.83 %</td>
        <td>244</td>
        <td>116</td>
        <td>110</td>
        <td>6</td>
        <td>420.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1535735601f850f0edb630e497ee3ca0f6253a95" class="src_link" title="lib/bitcoin/protocol/txin.rb">lib/bitcoin/protocol/txin.rb</a></td>
        <td class="green strong">97.96 %</td>
        <td>96</td>
        <td>49</td>
        <td>48</td>
        <td>1</td>
        <td>696.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#925463098a998a603cae90a61e90032defc0f861" class="src_link" title="lib/bitcoin/protocol/txout.rb">lib/bitcoin/protocol/txout.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>73</td>
        <td>40</td>
        <td>40</td>
        <td>0</td>
        <td>1253.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#64138ab3345824464f68bf4ae98e60bd0dbb4ca8" class="src_link" title="lib/bitcoin/protocol/version.rb">lib/bitcoin/protocol/version.rb</a></td>
        <td class="green strong">96.77 %</td>
        <td>72</td>
        <td>31</td>
        <td>30</td>
        <td>1</td>
        <td>2.2</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Storage">
  <h2>
    <span class="group_name">Storage</span>
    (<span class="covered_percent"><span class="red">79.92%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         147.9
       </span>
    </span> hits/line)
  </h2>
  <a name="Storage"></a>
  <div>
    <b>5</b> files in total.
    <b>528</b> relevant lines. 
    <span class="green"><b>422</b> lines covered</span> and
    <span class="red"><b>106</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#3df1335f475b9f7cfa9efdfa05ebfc5a3780d534" class="src_link" title="lib/bitcoin/storage/dummy.rb">lib/bitcoin/storage/dummy.rb</a></td>
        <td class="red strong">25.74 %</td>
        <td>164</td>
        <td>101</td>
        <td>26</td>
        <td>75</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a5b4193a8f28e1aea5ab2063c2b6e6b27fea99ad" class="src_link" title="lib/bitcoin/storage/models.rb">lib/bitcoin/storage/models.rb</a></td>
        <td class="green strong">93.65 %</td>
        <td>137</td>
        <td>63</td>
        <td>59</td>
        <td>4</td>
        <td>285.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2b02df19bf3e2d30c17039c18855058d8a44f920" class="src_link" title="lib/bitcoin/storage/sequel.rb">lib/bitcoin/storage/sequel.rb</a></td>
        <td class="green strong">97.14 %</td>
        <td>349</td>
        <td>175</td>
        <td>170</td>
        <td>5</td>
        <td>352.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#13a1bc7c31c7c9123a61b240d7b469d94bd56dc9" class="src_link" title="lib/bitcoin/storage/sequel_store/sequel_migrations.rb">lib/bitcoin/storage/sequel_store/sequel_migrations.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>84</td>
        <td>55</td>
        <td>55</td>
        <td>0</td>
        <td>59.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1e47ca20dcc1dba7324b2d0287e768352d49ee12" class="src_link" title="lib/bitcoin/storage/storage.rb">lib/bitcoin/storage/storage.rb</a></td>
        <td class="yellow strong">83.58 %</td>
        <td>264</td>
        <td>134</td>
        <td>112</td>
        <td>22</td>
        <td>42.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Wallet">
  <h2>
    <span class="group_name">Wallet</span>
    (<span class="covered_percent"><span class="yellow">80.68%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         235.04
       </span>
    </span> hits/line)
  </h2>
  <a name="Wallet"></a>
  <div>
    <b>5</b> files in total.
    <b>352</b> relevant lines. 
    <span class="green"><b>284</b> lines covered</span> and
    <span class="red"><b>68</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#45d4f28fae6f671f74cefe8a341bf4686a58205e" class="src_link" title="lib/bitcoin/wallet/coinselector.rb">lib/bitcoin/wallet/coinselector.rb</a></td>
        <td class="green strong">92.86 %</td>
        <td>30</td>
        <td>14</td>
        <td>13</td>
        <td>1</td>
        <td>5.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5b4d2b3b2b9a07acc2e0db4dcc389a361c4af330" class="src_link" title="lib/bitcoin/wallet/keygenerator.rb">lib/bitcoin/wallet/keygenerator.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>75</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>1098.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#02f674ef66c656bec0454c93dca59c930de55849" class="src_link" title="lib/bitcoin/wallet/keystore.rb">lib/bitcoin/wallet/keystore.rb</a></td>
        <td class="green strong">91.74 %</td>
        <td>203</td>
        <td>109</td>
        <td>100</td>
        <td>9</td>
        <td>24.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e4537349f04bf547cb5970d59edb474b2c135d28" class="src_link" title="lib/bitcoin/wallet/txdp.rb">lib/bitcoin/wallet/txdp.rb</a></td>
        <td class="yellow strong">83.53 %</td>
        <td>116</td>
        <td>85</td>
        <td>71</td>
        <td>14</td>
        <td>41.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5f86fc73b1d974c21d9992a33e59689fa75b4089" class="src_link" title="lib/bitcoin/wallet/wallet.rb">lib/bitcoin/wallet/wallet.rb</a></td>
        <td class="red strong">62.39 %</td>
        <td>243</td>
        <td>117</td>
        <td>73</td>
        <td>44</td>
        <td>5.2</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Utilities">
  <h2>
    <span class="group_name">Utilities</span>
    (<span class="covered_percent"><span class="green">92.73%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         60.8
       </span>
    </span> hits/line)
  </h2>
  <a name="Utilities"></a>
  <div>
    <b>2</b> files in total.
    <b>110</b> relevant lines. 
    <span class="green"><b>102</b> lines covered</span> and
    <span class="red"><b>8</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#2dcb72f38404c85bd4fe44aeed3d3b7e4562fc0c" class="src_link" title="lib/bitcoin/ffi/openssl.rb">lib/bitcoin/ffi/openssl.rb</a></td>
        <td class="green strong">98.67 %</td>
        <td>121</td>
        <td>75</td>
        <td>74</td>
        <td>1</td>
        <td>109.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5d6d97008ffec5aff3bc91103ab60ec056c27d1" class="src_link" title="lib/bitcoin/logger.rb">lib/bitcoin/logger.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>65</td>
        <td>35</td>
        <td>28</td>
        <td>7</td>
        <td>11.9</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent"><span class="green">94.64%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         201.17
       </span>
    </span> hits/line)
  </h2>
  <a name="Ungrouped"></a>
  <div>
    <b>3</b> files in total.
    <b>261</b> relevant lines. 
    <span class="green"><b>247</b> lines covered</span> and
    <span class="red"><b>14</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#6ad895c6fd6140cbd279d839c3cab431fd71d2a7" class="src_link" title="lib/bitcoin/builder.rb">lib/bitcoin/builder.rb</a></td>
        <td class="green strong">91.2 %</td>
        <td>266</td>
        <td>125</td>
        <td>114</td>
        <td>11</td>
        <td>483.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1d2f3285b72675d82f9d16bd6660cd2e089bdc3a" class="src_link" title="lib/bitcoin/validation.rb">lib/bitcoin/validation.rb</a></td>
        <td class="green strong">97.76 %</td>
        <td>327</td>
        <td>134</td>
        <td>131</td>
        <td>3</td>
        <td>118.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0385197f5a931438685a32169b01ce2549a5ad96" class="src_link" title="lib/bitcoin/version.rb">lib/bitcoin/version.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.6.4 
        and simplecov-html v0.5.3<br/>
        using RSpec
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="6291547fade947731b570fd2a9162416476301a6">
  <div class="header">
    <h3>lib/bitcoin.rb</h3>
    <h4><span class="green">95.83 %</span> covered</h4>
    <div>
      <b>216</b> relevant lines. 
      <span class="green"><b>207</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Bitcoin Utils and Network Protocol in Ruby.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'digest/sha2'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require 'digest/rmd160'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require 'openssl'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Connection, 'bitcoin/connection'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Protocol,   'bitcoin/protocol'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :P,          'bitcoin/protocol'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Script,     'bitcoin/script'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :VERSION,    'bitcoin/version'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Storage,    'bitcoin/storage/storage'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Logger,     'bitcoin/logger'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Key,        'bitcoin/key'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Config,     'bitcoin/config'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Builder,    'bitcoin/builder'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Validation, 'bitcoin/validation'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  module Network</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :ConnectionHandler,  'bitcoin/network/connection_handler'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :CommandHandler,     'bitcoin/network/command_handler'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :CommandClient,     'bitcoin/network/command_client'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Node,               'bitcoin/network/node'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  module Wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :KeyGenerator,          'bitcoin/wallet/keygenerator'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :SimpleKeyStore,        'bitcoin/wallet/keystore'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :DeterministicKeyStore, 'bitcoin/wallet/keystore'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :SimpleCoinSelector,    'bitcoin/wallet/coinselector'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Wallet,                'bitcoin/wallet/wallet'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :TxDP,                'bitcoin/wallet/txdp'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  module Gui</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Gui,        'bitcoin/gui/gui'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Connection, 'bitcoin/gui/connection'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.require_dependency name, opts = {}</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="44">
          <span class="hits">66</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="45">
          <span class="hits">66</span>
          
          <code class="ruby">      require name.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    rescue LoadError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      print &quot;Cannot load #{opts[:exit] == false ? 'optional' : 'required'} dependency '#{name}'&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      (opts[:gem] == false) ? puts(&quot;&quot;) :</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        puts(&quot; - install with `gem install #{opts[:gem] || name}`&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      puts opts[:message]  if opts[:message]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      exit 1  unless opts[:exit] == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="54">
          <span class="hits">66</span>
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  module Util</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3858" data-linenumber="59">
          <span class="hits">3858</span>
          
          <code class="ruby">    def address_version; Bitcoin.network[:address_version]; end</code>
        </li>
      
        <li class="covered" data-hits="1945" data-linenumber="60">
          <span class="hits">1945</span>
          
          <code class="ruby">    def p2sh_version; Bitcoin.network[:p2sh_version]; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    # hash160 is a 20 bytes (160bits) rmd610-sha256 hexdigest.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160(hex)</code>
        </li>
      
        <li class="covered" data-hits="2005" data-linenumber="64">
          <span class="hits">2005</span>
          
          <code class="ruby">      bytes = [hex].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2005" data-linenumber="65">
          <span class="hits">2005</span>
          
          <code class="ruby">      Digest::RMD160.hexdigest Digest::SHA256.digest(bytes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    # checksum is a 4 bytes sha256-sha256 hexdigest.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def checksum(hex)</code>
        </li>
      
        <li class="covered" data-hits="3762" data-linenumber="70">
          <span class="hits">3762</span>
          
          <code class="ruby">      b = [hex].pack(&quot;H*&quot;) # unpack hex</code>
        </li>
      
        <li class="covered" data-hits="3762" data-linenumber="71">
          <span class="hits">3762</span>
          
          <code class="ruby">      Digest::SHA256.hexdigest( Digest::SHA256.digest(b) )[0...8]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    # verify base58 checksum for given +base58+ data.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    def base58_checksum?(base58)</code>
        </li>
      
        <li class="covered" data-hits="1940" data-linenumber="76">
          <span class="hits">1940</span>
          
          <code class="ruby">      hex = decode_base58(base58) rescue nil</code>
        </li>
      
        <li class="covered" data-hits="1940" data-linenumber="77">
          <span class="hits">1940</span>
          
          <code class="ruby">      return false unless hex</code>
        </li>
      
        <li class="covered" data-hits="1938" data-linenumber="78">
          <span class="hits">1938</span>
          
          <code class="ruby">      Bitcoin.checksum( hex[0...42] ) == hex[-8..-1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    alias :address_checksum? :base58_checksum?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    # check if given +address+ is valid.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    # this means having a correct version byte, length and checksum.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">    def valid_address?(address)</code>
        </li>
      
        <li class="covered" data-hits="1966" data-linenumber="85">
          <span class="hits">1966</span>
          
          <code class="ruby">      hex = decode_base58(address) rescue nil</code>
        </li>
      
        <li class="covered" data-hits="1966" data-linenumber="86">
          <span class="hits">1966</span>
          
          <code class="ruby">      return false unless hex &amp;&amp; hex.bytesize == 50</code>
        </li>
      
        <li class="covered" data-hits="1941" data-linenumber="87">
          <span class="hits">1941</span>
          
          <code class="ruby">      return false unless [address_version, p2sh_version].include?(hex[0...2])</code>
        </li>
      
        <li class="covered" data-hits="1934" data-linenumber="88">
          <span class="hits">1934</span>
          
          <code class="ruby">      address_checksum?(address)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # get hash160 for given +address+. returns nil if address is invalid.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160_from_address(address)</code>
        </li>
      
        <li class="covered" data-hits="966" data-linenumber="93">
          <span class="hits">966</span>
          
          <code class="ruby">      return nil  unless valid_address?(address)</code>
        </li>
      
        <li class="covered" data-hits="964" data-linenumber="94">
          <span class="hits">964</span>
          
          <code class="ruby">      decode_base58(address)[2...42]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    # get type of given +address+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    def address_type(address)</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="99">
          <span class="hits">145</span>
          
          <code class="ruby">      return nil unless valid_address?(address)</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="100">
          <span class="hits">142</span>
          
          <code class="ruby">      case decode_base58(address)[0...2]</code>
        </li>
      
        <li class="covered" data-hits="139" data-linenumber="101">
          <span class="hits">139</span>
          
          <code class="ruby">      when address_version; :hash160</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="102">
          <span class="hits">3</span>
          
          <code class="ruby">      when p2sh_version;    :p2sh</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">    def sha256(hex)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      Digest::SHA256.hexdigest([hex].pack(&quot;H*&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160_to_address(hex)</code>
        </li>
      
        <li class="covered" data-hits="1774" data-linenumber="111">
          <span class="hits">1774</span>
          
          <code class="ruby">      hex = address_version + hex</code>
        </li>
      
        <li class="covered" data-hits="1774" data-linenumber="112">
          <span class="hits">1774</span>
          
          <code class="ruby">      encode_base58(hex + checksum(hex))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    def pubkey_to_address(pubkey)</code>
        </li>
      
        <li class="covered" data-hits="805" data-linenumber="116">
          <span class="hits">805</span>
          
          <code class="ruby">      hash160_to_address( hash160(pubkey) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    def int_to_base58(int_val, leading_zero_bytes=0)</code>
        </li>
      
        <li class="covered" data-hits="1798" data-linenumber="120">
          <span class="hits">1798</span>
          
          <code class="ruby">      alpha = &quot;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&quot;</code>
        </li>
      
        <li class="covered" data-hits="1798" data-linenumber="121">
          <span class="hits">1798</span>
          
          <code class="ruby">      base58_val, base = '', alpha.size</code>
        </li>
      
        <li class="covered" data-hits="1798" data-linenumber="122">
          <span class="hits">1798</span>
          
          <code class="ruby">      while int_val &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="59872" data-linenumber="123">
          <span class="hits">59872</span>
          
          <code class="ruby">        int_val, remainder = int_val.divmod(base)</code>
        </li>
      
        <li class="covered" data-hits="59872" data-linenumber="124">
          <span class="hits">59872</span>
          
          <code class="ruby">        base58_val = alpha[remainder] + base58_val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1798" data-linenumber="126">
          <span class="hits">1798</span>
          
          <code class="ruby">      base58_val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    def base58_to_int(base58_val)</code>
        </li>
      
        <li class="covered" data-hits="5068" data-linenumber="130">
          <span class="hits">5068</span>
          
          <code class="ruby">      alpha = &quot;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&quot;</code>
        </li>
      
        <li class="covered" data-hits="5068" data-linenumber="131">
          <span class="hits">5068</span>
          
          <code class="ruby">      int_val, base = 0, alpha.size</code>
        </li>
      
        <li class="covered" data-hits="5068" data-linenumber="132">
          <span class="hits">5068</span>
          
          <code class="ruby">      base58_val.reverse.each_char.with_index do |char,index|</code>
        </li>
      
        <li class="covered" data-hits="172001" data-linenumber="133">
          <span class="hits">172001</span>
          
          <code class="ruby">        raise ArgumentError, 'Value not a valid Base58 String.' unless char_index = alpha.index(char)</code>
        </li>
      
        <li class="covered" data-hits="171994" data-linenumber="134">
          <span class="hits">171994</span>
          
          <code class="ruby">        int_val += char_index*(base**index)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="5061" data-linenumber="136">
          <span class="hits">5061</span>
          
          <code class="ruby">      int_val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">    def encode_base58(hex)</code>
        </li>
      
        <li class="covered" data-hits="1786" data-linenumber="140">
          <span class="hits">1786</span>
          
          <code class="ruby">      leading_zero_bytes  = (hex.match(/^([0]+)/) ? $1 : '').size / 2</code>
        </li>
      
        <li class="covered" data-hits="1786" data-linenumber="141">
          <span class="hits">1786</span>
          
          <code class="ruby">      (&quot;1&quot;*leading_zero_bytes) + int_to_base58( hex.to_i(16) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">    def decode_base58(base58_val)</code>
        </li>
      
        <li class="covered" data-hits="5067" data-linenumber="146">
          <span class="hits">5067</span>
          
          <code class="ruby">      s = base58_to_int(base58_val).to_s(16); s = (s.bytesize.odd? ? '0'+s : s)</code>
        </li>
      
        <li class="covered" data-hits="5060" data-linenumber="147">
          <span class="hits">5060</span>
          
          <code class="ruby">      s = '' if s == '00'</code>
        </li>
      
        <li class="covered" data-hits="5060" data-linenumber="148">
          <span class="hits">5060</span>
          
          <code class="ruby">      leading_zero_bytes = (base58_val.match(/^([1]+)/) ? $1 : '').size</code>
        </li>
      
        <li class="covered" data-hits="5060" data-linenumber="149">
          <span class="hits">5060</span>
          
          <code class="ruby">      s = (&quot;00&quot;*leading_zero_bytes) + s  if leading_zero_bytes &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="5060" data-linenumber="150">
          <span class="hits">5060</span>
          
          <code class="ruby">      s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">    alias_method :base58_to_hex, :decode_base58</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">    # target compact bits (int) to bignum hex</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    def decode_compact_bits(bits)</code>
        </li>
      
        <li class="covered" data-hits="351" data-linenumber="156">
          <span class="hits">351</span>
          
          <code class="ruby">      bytes = Array.new(size=((bits &gt;&gt; 24) &amp; 255), 0)</code>
        </li>
      
        <li class="covered" data-hits="351" data-linenumber="157">
          <span class="hits">351</span>
          
          <code class="ruby">      bytes[0] = (bits &gt;&gt; 16) &amp; 255 if size &gt;= 1</code>
        </li>
      
        <li class="covered" data-hits="351" data-linenumber="158">
          <span class="hits">351</span>
          
          <code class="ruby">      bytes[1] = (bits &gt;&gt;  8) &amp; 255 if size &gt;= 2</code>
        </li>
      
        <li class="covered" data-hits="351" data-linenumber="159">
          <span class="hits">351</span>
          
          <code class="ruby">      bytes[2] = (bits      ) &amp; 255 if size &gt;= 3</code>
        </li>
      
        <li class="covered" data-hits="351" data-linenumber="160">
          <span class="hits">351</span>
          
          <code class="ruby">      bytes.pack(&quot;C*&quot;).unpack(&quot;H*&quot;)[0].rjust(64, '0')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    # target bignum hex to compact bits (int)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    def encode_compact_bits(target)</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="165">
          <span class="hits">82</span>
          
          <code class="ruby">      bytes = OpenSSL::BN.new(target, 16).to_mpi</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="166">
          <span class="hits">82</span>
          
          <code class="ruby">      size = bytes.size - 4</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="167">
          <span class="hits">82</span>
          
          <code class="ruby">      nbits = size &lt;&lt; 24</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="168">
          <span class="hits">82</span>
          
          <code class="ruby">      nbits |= (bytes[4] &lt;&lt; 16) if size &gt;= 1</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="169">
          <span class="hits">82</span>
          
          <code class="ruby">      nbits |= (bytes[5] &lt;&lt;  8) if size &gt;= 2</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="170">
          <span class="hits">82</span>
          
          <code class="ruby">      nbits |= (bytes[6]      ) if size &gt;= 3</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="171">
          <span class="hits">82</span>
          
          <code class="ruby">      nbits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">    def decode_target(target_bits)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      case target_bits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">      when Fixnum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">        [ decode_compact_bits(target_bits).to_i(16), target_bits ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      when String</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">        [ target_bits.to_i(16), encode_compact_bits(target_bits) ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">    def bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="1559" data-linenumber="184">
          <span class="hits">1559</span>
          
          <code class="ruby">      ::OpenSSL::PKey::EC.new(&quot;secp256k1&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate_key</code>
        </li>
      
        <li class="covered" data-hits="1053" data-linenumber="188">
          <span class="hits">1053</span>
          
          <code class="ruby">      key = bitcoin_elliptic_curve.generate_key</code>
        </li>
      
        <li class="covered" data-hits="1053" data-linenumber="189">
          <span class="hits">1053</span>
          
          <code class="ruby">      inspect_key( key )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">    def inspect_key(key)</code>
        </li>
      
        <li class="covered" data-hits="1054" data-linenumber="193">
          <span class="hits">1054</span>
          
          <code class="ruby">      [ key.private_key_hex, key.public_key_hex ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate_address</code>
        </li>
      
        <li class="covered" data-hits="801" data-linenumber="197">
          <span class="hits">801</span>
          
          <code class="ruby">      prvkey, pubkey = generate_key</code>
        </li>
      
        <li class="covered" data-hits="801" data-linenumber="198">
          <span class="hits">801</span>
          
          <code class="ruby">      [ pubkey_to_address(pubkey), prvkey, pubkey, hash160(pubkey) ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">    def bitcoin_hash(hex)</code>
        </li>
      
        <li class="covered" data-hits="19956" data-linenumber="202">
          <span class="hits">19956</span>
          
          <code class="ruby">      Digest::SHA256.digest(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">        Digest::SHA256.digest( [hex].pack(&quot;H*&quot;).reverse )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">      ).reverse.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="195" data-linenumber="207">
          <span class="hits">195</span>
          
          <code class="ruby">    def bitcoin_mrkl(a, b); bitcoin_hash(b + a); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_hash(prev_block, mrkl_root, time, bits, nonce, ver)</code>
        </li>
      
        <li class="covered" data-hits="19762" data-linenumber="210">
          <span class="hits">19762</span>
          
          <code class="ruby">      h = &quot;%08x%08x%08x%064s%064s%08x&quot; %</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">            [nonce, bits, time, mrkl_root, prev_block, ver]</code>
        </li>
      
        <li class="covered" data-hits="19761" data-linenumber="212">
          <span class="hits">19761</span>
          
          <code class="ruby">      bitcoin_hash(h)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash_mrkl_tree(tx)</code>
        </li>
      
        <li class="covered" data-hits="431" data-linenumber="216">
          <span class="hits">431</span>
          
          <code class="ruby">      return [nil]  if tx != tx.uniq</code>
        </li>
      
        <li class="covered" data-hits="429" data-linenumber="217">
          <span class="hits">429</span>
          
          <code class="ruby">      chunks = [ tx.dup ]</code>
        </li>
      
        <li class="covered" data-hits="429" data-linenumber="218">
          <span class="hits">429</span>
          
          <code class="ruby">      while chunks.last.size &gt;= 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">        chunks &lt;&lt; chunks.last.each_slice(2).map{|i|</code>
        </li>
      
        <li class="covered" data-hits="173" data-linenumber="220">
          <span class="hits">173</span>
          
          <code class="ruby">          Bitcoin.bitcoin_mrkl( i[0], i[1] || i[0] )</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="221">
          <span class="hits">52</span>
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="429" data-linenumber="223">
          <span class="hits">429</span>
          
          <code class="ruby">      chunks.flatten</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">    def sign_data(key, data)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="228">
          <span class="hits">3</span>
          
          <code class="ruby">      key.dsa_sign_asn1(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="231">
          <span class="hits">1</span>
          
          <code class="ruby">    def verify_signature(hash, signature, public_key)</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="232">
          <span class="hits">84</span>
          
          <code class="ruby">      key  = bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="84" data-linenumber="233">
          <span class="hits">84</span>
          
          <code class="ruby">      key.public_key = ::OpenSSL::PKey::EC::Point.from_hex(key.group, public_key)</code>
        </li>
      
        <li class="covered" data-hits="83" data-linenumber="234">
          <span class="hits">83</span>
          
          <code class="ruby">      key.dsa_verify_asn1(hash, signature)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">    rescue OpenSSL::PKey::ECError, OpenSSL::PKey::EC::Point::Error</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="236">
          <span class="hits">2</span>
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">    end </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">    def open_key(private_key, public_key=nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="240">
          <span class="hits">5</span>
          
          <code class="ruby">      key  = bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="241">
          <span class="hits">5</span>
          
          <code class="ruby">      key.private_key = ::OpenSSL::BN.from_hex(private_key)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="242">
          <span class="hits">5</span>
          
          <code class="ruby">      public_key = regenerate_public_key(private_key) unless public_key</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="243">
          <span class="hits">5</span>
          
          <code class="ruby">      key.public_key  = ::OpenSSL::PKey::EC::Point.from_hex(key.group, public_key)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="244">
          <span class="hits">5</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">    def regenerate_public_key(private_key)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="248">
          <span class="hits">1</span>
          
          <code class="ruby">      Bitcoin::OpenSSL_EC.regenerate_key(private_key)[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="252">
          <span class="hits">1</span>
          
          <code class="ruby">    RETARGET_INTERVAL = 2016</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    # block count when the next retarget will take place.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_next_retarget(block_height)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="256">
          <span class="hits">3</span>
          
          <code class="ruby">      (block_height + (RETARGET_INTERVAL-block_height.divmod(RETARGET_INTERVAL).last)) - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    # current difficulty as a multiple of the minimum difficulty (highest target).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_difficulty(target_nbits)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      # max_target      = 0x00000000ffff0000000000000000000000000000000000000000000000000000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">      # current_target  = Bitcoin.decode_compact_bits(target_nbits).to_i(16)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">      # &quot;%.7f&quot; % (max_target / current_target.to_f)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">      bits, max_body, scaland = target_nbits, Math.log(0x00ffff), Math.log(256)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="265">
          <span class="hits">1</span>
          
          <code class="ruby">      &quot;%.7f&quot; % Math.exp(max_body - Math.log(bits&amp;0x00ffffff) + scaland * (0x1d - ((bits&amp;0xff000000)&gt;&gt;24)))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">    # average number of hashes required to win a block with the current target. (nbits)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="269">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_hashes_to_win(target_nbits)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="270">
          <span class="hits">2</span>
          
          <code class="ruby">      current_target  = Bitcoin.decode_compact_bits(target_nbits).to_i(16)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="271">
          <span class="hits">2</span>
          
          <code class="ruby">      0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff / current_target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">    # probability of a single hash solving a block with the current difficulty.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="275">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_probability(target_nbits)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="276">
          <span class="hits">1</span>
          
          <code class="ruby">      current_target  = Bitcoin.decode_compact_bits(target_nbits).to_i(16)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="277">
          <span class="hits">1</span>
          
          <code class="ruby">      &quot;%.55f&quot; % (current_target.to_f / 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">    # average time to find a block in seconds with the current target. (nbits)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="281">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_average_hashing_time(target_nbits, hashes_per_second)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">      block_hashes_to_win(target_nbits) / hashes_per_second</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    # shows the total number of Bitcoins in circulation, reward era and reward in that era.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="286">
          <span class="hits">1</span>
          
          <code class="ruby">    def blockchain_total_btc(height)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="287">
          <span class="hits">6</span>
          
          <code class="ruby">      reward, interval = 5000000000, 210000</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="288">
          <span class="hits">6</span>
          
          <code class="ruby">      total_btc = reward</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="289">
          <span class="hits">6</span>
          
          <code class="ruby">      reward_era, remainder = (height).divmod(interval)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="290">
          <span class="hits">6</span>
          
          <code class="ruby">      reward_era.times{</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="291">
          <span class="hits">12</span>
          
          <code class="ruby">        total_btc += interval * reward</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="292">
          <span class="hits">12</span>
          
          <code class="ruby">        reward = reward / 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="294">
          <span class="hits">6</span>
          
          <code class="ruby">      total_btc += remainder * reward</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="295">
          <span class="hits">6</span>
          
          <code class="ruby">      [total_btc, reward_era+1, reward, height]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="298">
          <span class="hits">1</span>
          
          <code class="ruby">    def block_creation_reward(block_height)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="299">
          <span class="hits">6</span>
          
          <code class="ruby">      5000000000 / (2 ** (block_height / 210000.0).floor)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="303">
          <span class="hits">1</span>
          
          <code class="ruby">  extend Util</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="306">
          <span class="hits">1</span>
          
          <code class="ruby">  module  BinaryExtensions</code>
        </li>
      
        <li class="covered" data-hits="43125" data-linenumber="307">
          <span class="hits">43125</span>
          
          <code class="ruby">    def hth; unpack(&quot;H*&quot;)[0]; end</code>
        </li>
      
        <li class="covered" data-hits="43049" data-linenumber="308">
          <span class="hits">43049</span>
          
          <code class="ruby">    def reverse_hth; reverse.hth; end</code>
        </li>
      
        <li class="covered" data-hits="3284" data-linenumber="309">
          <span class="hits">3284</span>
          
          <code class="ruby">    def htb; [self].pack(&quot;H*&quot;); end</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="310">
          <span class="hits">65</span>
          
          <code class="ruby">    def htb_reverse; htb.reverse; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="313">
          <span class="hits">1</span>
          
          <code class="ruby">  class ::String</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="314">
          <span class="hits">1</span>
          
          <code class="ruby">    include Bitcoin::BinaryExtensions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="318">
          <span class="hits">1</span>
          
          <code class="ruby">  module ::OpenSSL</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">    class BN</code>
        </li>
      
        <li class="covered" data-hits="441" data-linenumber="320">
          <span class="hits">441</span>
          
          <code class="ruby">      def self.from_hex(hex); new(hex, 16); end</code>
        </li>
      
        <li class="covered" data-hits="2509" data-linenumber="321">
          <span class="hits">2509</span>
          
          <code class="ruby">      def to_hex; to_i.to_s(16); end</code>
        </li>
      
        <li class="covered" data-hits="83" data-linenumber="322">
          <span class="hits">83</span>
          
          <code class="ruby">      def to_mpi; to_s(0).unpack(&quot;C*&quot;); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="324">
          <span class="hits">1</span>
          
          <code class="ruby">    class PKey::EC</code>
        </li>
      
        <li class="covered" data-hits="1056" data-linenumber="325">
          <span class="hits">1056</span>
          
          <code class="ruby">      def private_key_hex; private_key.to_hex.rjust(64, '0'); end</code>
        </li>
      
        <li class="covered" data-hits="1056" data-linenumber="326">
          <span class="hits">1056</span>
          
          <code class="ruby">      def public_key_hex;  public_key.to_hex.rjust(130, '0'); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="328">
          <span class="hits">1</span>
          
          <code class="ruby">    class PKey::EC::Point</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="329">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hex(group, hex)</code>
        </li>
      
        <li class="covered" data-hits="294" data-linenumber="330">
          <span class="hits">294</span>
          
          <code class="ruby">        new(group, BN.from_hex(hex))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1349" data-linenumber="332">
          <span class="hits">1349</span>
          
          <code class="ruby">      def to_hex; to_bn.to_hex; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="333">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.bn2mpi(hex) BN.from_hex(hex).to_mpi; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="337">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :OpenSSL_EC, &quot;bitcoin/ffi/openssl&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="339">
          <span class="hits">1</span>
          
          <code class="ruby">  @network = :bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="341">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.network</code>
        </li>
      
        <li class="covered" data-hits="6780" data-linenumber="342">
          <span class="hits">6780</span>
          
          <code class="ruby">    NETWORKS[@network]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="345">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.network= name</code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="346">
          <span class="hits">150</span>
          
          <code class="ruby">    @network = name.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="349">
          <span class="hits">1</span>
          
          <code class="ruby">  CENT =   1_000_000</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="350">
          <span class="hits">1</span>
          
          <code class="ruby">  COIN = 100_000_000</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="351">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_MONEY = 21_000_000 * COIN</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="352">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_BLOCK_SIZE = 1_000_000</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="353">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_BLOCK_SIZE_GEN = MAX_BLOCK_SIZE/2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="354">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_BLOCK_SIGOPS = MAX_BLOCK_SIZE/50</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="355">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_ORPHAN_TRANSACTIONS = MAX_BLOCK_SIZE/100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="357">
          <span class="hits">1</span>
          
          <code class="ruby">  MIN_FEE_MODE     = [ :block, :relay, :send ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="358">
          <span class="hits">1</span>
          
          <code class="ruby">  MIN_TX_FEE       = 50_000</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="359">
          <span class="hits">1</span>
          
          <code class="ruby">  MIN_RELAY_TX_FEE = 10_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="361">
          <span class="hits">1</span>
          
          <code class="ruby">  NETWORKS = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    :bitcoin =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xF9\xBE\xB4\xD9&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">      :address_version =&gt; &quot;00&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;05&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;80&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">      :default_port =&gt; 8333,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">      :dns_seeds =&gt; [&quot;bitseed.xf2.org&quot;, &quot;dnsseed.bluematt.me&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">        &quot;dnsseed.bitcoin.dashjr.org&quot;, &quot;seed.bitcoin.sipa.be&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0x1d00ffff,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">      :known_nodes =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">        'relay.eligius.st',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">        'mining.bitcoin.cz',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">        'bitcoins.lc',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">        'blockchain.info',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">        'blockexplorer.com',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">      ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">    :testnet =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\xFA\xBF\xB5\xDA&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">      :address_version =&gt; &quot;6f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;c4&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;ef&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">      :default_port =&gt; 18333,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">      :dns_seeds =&gt; [&quot;testseed.bitcoin.interesthings.de&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;00000007199508e34a9ff81e6ec0c477a4cccff2a4767a8eee39c11db367b008&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0x1d07fff8,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">      :known_nodes =&gt; []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">    :testnet3 =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">      :magic_head =&gt; &quot;\x0b\x11\x09\x07&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">      :address_version =&gt; &quot;6f&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">      :p2sh_version =&gt; &quot;c4&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">      :privkey_version =&gt; &quot;ef&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">      :default_port =&gt; 18333,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">      :dns_seeds =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">      :genesis_hash =&gt; &quot;000000000933ea01ad0ee984209779baaec3ced90fa3f408719526f8d77f4943&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">      :proof_of_work_limit =&gt; 0x1d07fff8,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">      :known_nodes =&gt; []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6ad895c6fd6140cbd279d839c3cab431fd71d2a7">
  <div class="header">
    <h3>lib/bitcoin/builder.rb</h3>
    <h4><span class="green">91.2 %</span> covered</h4>
    <div>
      <b>125</b> relevant lines. 
      <span class="green"><b>114</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # Optional DSL to help create blocks and transactions.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # see also BlockBuilder, TxBuilder, TxInBuilder, TxOutBuilder, ScriptBuilder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  module Builder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # build a Bitcoin::Protocol::Block matching the given +target+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # see BlockBuilder for details.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    def blk(target = &quot;00&quot;.ljust(64, 'f'))</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="11">
          <span class="hits">68</span>
          
          <code class="ruby">      c = BlockBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="12">
          <span class="hits">68</span>
          
          <code class="ruby">      yield c</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="13">
          <span class="hits">68</span>
          
          <code class="ruby">      c.block(target)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # build a Bitcoin::Protocol::Tx.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # see TxBuilder for details.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    def tx</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="19">
          <span class="hits">33</span>
          
          <code class="ruby">      c = TxBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="20">
          <span class="hits">33</span>
          
          <code class="ruby">      yield c</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="21">
          <span class="hits">33</span>
          
          <code class="ruby">      c.tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    # build a Bitcoin::Script.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    # see ScriptBuilder for details.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    def script</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="27">
          <span class="hits">3</span>
          
          <code class="ruby">      c = ScriptBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="28">
          <span class="hits">3</span>
          
          <code class="ruby">      yield c</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="29">
          <span class="hits">3</span>
          
          <code class="ruby">      c.script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    # DSL to create a Bitcoin::Protocol::Block used by Builder#blk.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    #  block = blk(&quot;00&quot;.ljust(32, 'f')) do |b|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    #    b.prev_block &quot;\x00&quot;*32</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    #    b.tx do |t|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    #      t.input {|i| i.coinbase }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    #      t.output do |o|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    #        o.value 5000000000;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    #        o.script do |s|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    #          s.type :address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    #          s.recipient Bitcoin::Key.generate.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    #        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    #      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    #    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    #  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    class BlockBuilder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="49">
          <span class="hits">68</span>
          
          <code class="ruby">        @block = Bitcoin::P::Block.new(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      # specify block version. this is usually not necessary. defaults to 1.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      def version v</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        @version = v</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # set the hash of the previous block.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">      def prev_block hash</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="59">
          <span class="hits">68</span>
          
          <code class="ruby">        @prev_block = hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      # add transactions to the block (see TxBuilder).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">      def tx</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="64">
          <span class="hits">77</span>
          
          <code class="ruby">        c = TxBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="65">
          <span class="hits">77</span>
          
          <code class="ruby">        yield c</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="66">
          <span class="hits">77</span>
          
          <code class="ruby">        @block.tx &lt;&lt; c.tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      # create the block according to values specified via DSL.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      def block target</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="71">
          <span class="hits">68</span>
          
          <code class="ruby">        @block.ver = @version || 1</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="72">
          <span class="hits">68</span>
          
          <code class="ruby">        @block.prev_block = [@prev_block].pack(&quot;H*&quot;).reverse</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="73">
          <span class="hits">68</span>
          
          <code class="ruby">        @block.mrkl_root = @mrkl_root</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="74">
          <span class="hits">68</span>
          
          <code class="ruby">        @block.time = Time.now.to_i</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="75">
          <span class="hits">68</span>
          
          <code class="ruby">        @block.nonce = 0</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="76">
          <span class="hits">68</span>
          
          <code class="ruby">        @block.mrkl_root = [Bitcoin.hash_mrkl_tree(@block.tx.map {|t|</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="77">
          <span class="hits">77</span>
          
          <code class="ruby">              t.hash }).last].pack(&quot;H*&quot;).reverse</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="78">
          <span class="hits">68</span>
          
          <code class="ruby">        find_hash(target)</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="79">
          <span class="hits">68</span>
          
          <code class="ruby">        Bitcoin::P::Block.new(@block.to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      # increment nonce/time to find a block hash matching the +target+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">      def find_hash target</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="86">
          <span class="hits">68</span>
          
          <code class="ruby">        @block.bits = Bitcoin.encode_compact_bits(target)</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="87">
          <span class="hits">68</span>
          
          <code class="ruby">        t = Time.now</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="88">
          <span class="hits">68</span>
          
          <code class="ruby">        @block.recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="89">
          <span class="hits">68</span>
          
          <code class="ruby">        until @block.hash &lt; target</code>
        </li>
      
        <li class="covered" data-hits="18193" data-linenumber="90">
          <span class="hits">18193</span>
          
          <code class="ruby">          @block.nonce += 1</code>
        </li>
      
        <li class="covered" data-hits="18193" data-linenumber="91">
          <span class="hits">18193</span>
          
          <code class="ruby">          @block.recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="18193" data-linenumber="92">
          <span class="hits">18193</span>
          
          <code class="ruby">          if @block.nonce == 100000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">            if t</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">              tt = 1 / ((Time.now - t) / 100000) / 1000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">              print &quot;\r%.2f khash/s&quot; % tt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">            t = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">            @block.time = Time.now.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">            @block.nonce = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">            $stdout.flush</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    # DSL to create Bitcoin::Protocol::Tx used by Builder#tx.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    # tx = tx do |t|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    #   t.input do |i|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    #     i.prev_out prev_tx  # previous transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    #     i.prev_out_index 0  # index of previous output</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    #     i.signature_key key # Bitcoin::Key used to sign the input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    #   t.output do |o|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    #     o.value 12345 # 0.00012345 BTC</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    #     o.script {|s| s.type :address; s.recipient key.addr }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxBuilder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="122">
          <span class="hits">110</span>
          
          <code class="ruby">        @tx = Bitcoin::P::Tx.new(nil)</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="123">
          <span class="hits">110</span>
          
          <code class="ruby">        @tx.ver, @tx.lock_time = 1, 0</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="124">
          <span class="hits">110</span>
          
          <code class="ruby">        @ins, @outs = [], []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      # specify tx version. this is usually not necessary. defaults to 1.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">      def version n</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">        @tx.ver = n</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      # specify tx lock_time. this is usually not necessary. defaults to 0.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">      def lock_time n</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        @tx.lock_time = n</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      # add an input to the transaction (see TxInBuilder).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">      def input</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="139">
          <span class="hits">110</span>
          
          <code class="ruby">        c = TxInBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="140">
          <span class="hits">110</span>
          
          <code class="ruby">        yield c</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="141">
          <span class="hits">110</span>
          
          <code class="ruby">        @ins &lt;&lt; c</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      # add an output to the transaction (see TxOutBuilder).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">      def output</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="146">
          <span class="hits">123</span>
          
          <code class="ruby">        c = TxOutBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="147">
          <span class="hits">123</span>
          
          <code class="ruby">        yield c</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="148">
          <span class="hits">123</span>
          
          <code class="ruby">        @outs &lt;&lt; c</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      # create the transaction according to values specified via DSL and sign inputs.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">      def tx</code>
        </li>
      
        <li class="covered" data-hits="220" data-linenumber="153">
          <span class="hits">220</span>
          
          <code class="ruby">        @ins.each {|i| @tx.add_in(i.txin) }</code>
        </li>
      
        <li class="covered" data-hits="233" data-linenumber="154">
          <span class="hits">233</span>
          
          <code class="ruby">        @outs.each {|o| @tx.add_out(o.txout) }</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="155">
          <span class="hits">110</span>
          
          <code class="ruby">        @ins.each_with_index do |inc, i|</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="156">
          <span class="hits">110</span>
          
          <code class="ruby">          if @tx.in[i].coinbase?</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="157">
          <span class="hits">68</span>
          
          <code class="ruby">            script_sig = [inc.coinbase_data].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="158">
          <span class="hits">68</span>
          
          <code class="ruby">            @tx.in[i].script_sig_length = script_sig.bytesize</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="159">
          <span class="hits">68</span>
          
          <code class="ruby">            @tx.in[i].script_sig = script_sig</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="160">
          <span class="hits">68</span>
          
          <code class="ruby">            next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="162">
          <span class="hits">42</span>
          
          <code class="ruby">          prev_tx = inc.instance_variable_get(:@prev_out)</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="163">
          <span class="hits">42</span>
          
          <code class="ruby">          sig_hash = @tx.signature_hash_for_input(i, prev_tx)</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="164">
          <span class="hits">42</span>
          
          <code class="ruby">          sig = inc.key.sign(sig_hash)</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="165">
          <span class="hits">42</span>
          
          <code class="ruby">          script_sig = Bitcoin::Script.to_signature_pubkey_script(sig, [inc.key.pub].pack(&quot;H*&quot;))</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="166">
          <span class="hits">42</span>
          
          <code class="ruby">          @tx.in[i].script_sig_length = script_sig.bytesize</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="167">
          <span class="hits">42</span>
          
          <code class="ruby">          @tx.in[i].script_sig = script_sig</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="168">
          <span class="hits">42</span>
          
          <code class="ruby">          raise &quot;Signature error&quot;  unless @tx.verify_input_signature(i, prev_tx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="170">
          <span class="hits">110</span>
          
          <code class="ruby">        Bitcoin::P::Tx.new(@tx.to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    # create a Bitcoin::Protocol::TxIn used by TxBuilder#input.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    # inputs can be either 'coinbase', in which case they only need to specify #coinbase,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    # or they have to define a #prev_out, #prev_out_index and #signature key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxInBuilder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :key, :coinbase_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="182">
          <span class="hits">110</span>
          
          <code class="ruby">        @txin = Bitcoin::P::TxIn.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">      # previous transaction that contains the output we want to use.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">      def prev_out tx</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="187">
          <span class="hits">42</span>
          
          <code class="ruby">        @prev_out = tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">      # index of the output in the #prev_out transaction.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">      def prev_out_index i</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="192">
          <span class="hits">42</span>
          
          <code class="ruby">        @prev_out_index = i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">      # specify sequence. this is usually not needed.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">      def sequence s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">        @sequence = s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      # Bitcoin::Key used to sign the signature_hash for the input.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      # see Bitcoin::Script.signature_hash_for_input and Bitcoin::Key.sign.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">      def signature_key key</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="203">
          <span class="hits">42</span>
          
          <code class="ruby">        @key = key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">      # specify that this is a coinbase input. optionally set +data+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">      def coinbase data = nil</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="208">
          <span class="hits">68</span>
          
          <code class="ruby">        @coinbase_data = data || OpenSSL::Random.random_bytes(32)</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="209">
          <span class="hits">68</span>
          
          <code class="ruby">        @prev_out = nil</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="210">
          <span class="hits">68</span>
          
          <code class="ruby">        @prev_out_index = 4294967295</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      # create the txin according to values specified via DSL</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">      def txin</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="215">
          <span class="hits">110</span>
          
          <code class="ruby">        @txin.prev_out = (@prev_out ? @prev_out.binary_hash : &quot;\x00&quot;*32)</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="216">
          <span class="hits">110</span>
          
          <code class="ruby">        @txin.prev_out_index = @prev_out_index</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="217">
          <span class="hits">110</span>
          
          <code class="ruby">        @txin.sequence = @sequence || &quot;\xff\xff\xff\xff&quot;</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="218">
          <span class="hits">110</span>
          
          <code class="ruby">        @txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    # create a Bitcoin::Script used by TxOutBuilder#script.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">    class ScriptBuilder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="226">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="227">
          <span class="hits">126</span>
          
          <code class="ruby">        @type = :address</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="228">
          <span class="hits">126</span>
          
          <code class="ruby">        @script = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      # script type (:pubkey, :address/hash160, :multisig).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">      def type type</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="233">
          <span class="hits">29</span>
          
          <code class="ruby">        @type = type.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      # recipient(s) of the script.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">      # depending on the #type, either an address, hash160 pubkey, etc.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">      def recipient *data</code>
        </li>
      
        <li class="covered" data-hits="126" data-linenumber="239">
          <span class="hits">126</span>
          
          <code class="ruby">        @script = Bitcoin::Script.send(&quot;to_#{@type}_script&quot;, *data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">    # create a Bitcoin::Protocol::TxOut used by TxBuilder#output.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxOutBuilder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="245">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="248">
          <span class="hits">123</span>
          
          <code class="ruby">        @txout = Bitcoin::P::TxOut.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      # set output value (in base units / &quot;satoshis&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="252">
          <span class="hits">1</span>
          
          <code class="ruby">      def value value</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="253">
          <span class="hits">123</span>
          
          <code class="ruby">        @txout.value = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">      # add a script to the output (see ScriptBuilder).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">      def script &amp;block</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="258">
          <span class="hits">123</span>
          
          <code class="ruby">        c = ScriptBuilder.new</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="259">
          <span class="hits">123</span>
          
          <code class="ruby">        yield c</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="260">
          <span class="hits">123</span>
          
          <code class="ruby">        @txout.pk_script = c.script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2dcb72f38404c85bd4fe44aeed3d3b7e4562fc0c">
  <div class="header">
    <h3>lib/bitcoin/ffi/openssl.rb</h3>
    <h4><span class="green">98.67 %</span> covered</h4>
    <div>
      <b>75</b> relevant lines. 
      <span class="green"><b>74</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># autoload when you need to re-generate a public_key from only its private_key.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># ported from: https://github.com/sipa/bitcoin/blob/2d40fe4da9ea82af4b652b691a4185431d6e47a8/key.h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">Bitcoin.require_dependency :ffi, exit: false, message:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  &quot;Skipping FFI needed for OpenSSL_EC.regenerate_key.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">module OpenSSL_EC</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  extend FFI::Library</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  ffi_lib 'ssl'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  NID_secp256k1 = 714</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :SSL_library_init, [], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :ERR_load_crypto_strings, [], :void</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :SSL_load_error_strings, [], :void</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :RAND_poll, [], :int</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  #attach_function :BN_bin2bn, [:string, :int, :pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_bin2bn, [:pointer, :int, :pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_new_by_curve_name, [:int], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_get0_group, [:pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_new, [], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_CTX_new, [], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_GROUP_get_order, [:pointer, :pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_new, [:pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_mul, [:pointer, :pointer, :pointer, :pointer, :pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_set_private_key, [:pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_set_public_key,  [:pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_POINT_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_CTX_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_free, [:pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :i2o_ECPublicKey, [:pointer, :pointer], :uint</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :i2d_ECPrivateKey, [:pointer, :pointer], :int</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :d2i_ECPrivateKey, [:pointer, :pointer, :long], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :EC_KEY_get0_private_key, [:pointer], :pointer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  attach_function :BN_bn2bin, [:pointer, :pointer], :void</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # resolve public from private key, using ffi and libssl.so</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  #   keypair = Bitcoin.generate_key; Bitcoin::OpenSSL_EC.regenerate_key(keypair.first) == keypair</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.regenerate_key(private_key)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="45">
          <span class="hits">282</span>
          
          <code class="ruby">    private_key = [private_key].pack(&quot;H*&quot;) if private_key.bytesize &gt;= (32*2)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="46">
          <span class="hits">282</span>
          
          <code class="ruby">    private_key_hex = private_key.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    #private_key = FFI::MemoryPointer.new(:uint8, private_key.bytesize)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    #                .put_bytes(0, private_key, 0, private_key.bytesize)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="50">
          <span class="hits">282</span>
          
          <code class="ruby">    private_key = FFI::MemoryPointer.from_string(private_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"> </code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="52">
          <span class="hits">282</span>
          
          <code class="ruby">    init_ffi_ssl</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="53">
          <span class="hits">282</span>
          
          <code class="ruby">    eckey = EC_KEY_new_by_curve_name(NID_secp256k1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    #priv_key = BN_bin2bn(private_key, private_key.size, BN_new())</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="55">
          <span class="hits">282</span>
          
          <code class="ruby">    priv_key = BN_bin2bn(private_key, private_key.size-1, BN_new())</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="57">
          <span class="hits">282</span>
          
          <code class="ruby">    group, order, ctx = EC_KEY_get0_group(eckey), BN_new(), BN_CTX_new()</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="58">
          <span class="hits">282</span>
          
          <code class="ruby">    EC_GROUP_get_order(group, order, ctx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="60">
          <span class="hits">282</span>
          
          <code class="ruby">    pub_key = EC_POINT_new(group)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="61">
          <span class="hits">282</span>
          
          <code class="ruby">    EC_POINT_mul(group, pub_key, priv_key, nil, nil, ctx)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="62">
          <span class="hits">282</span>
          
          <code class="ruby">    EC_KEY_set_private_key(eckey, priv_key)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="63">
          <span class="hits">282</span>
          
          <code class="ruby">    EC_KEY_set_public_key(eckey, pub_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="65">
          <span class="hits">282</span>
          
          <code class="ruby">    BN_free(order)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="66">
          <span class="hits">282</span>
          
          <code class="ruby">    BN_CTX_free(ctx)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="67">
          <span class="hits">282</span>
          
          <code class="ruby">    EC_POINT_free(pub_key)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="68">
          <span class="hits">282</span>
          
          <code class="ruby">    BN_free(priv_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="71">
          <span class="hits">282</span>
          
          <code class="ruby">    length = i2d_ECPrivateKey(eckey, nil)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="72">
          <span class="hits">282</span>
          
          <code class="ruby">    ptr = FFI::MemoryPointer.new(:pointer)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="73">
          <span class="hits">282</span>
          
          <code class="ruby">    priv_hex = if i2d_ECPrivateKey(eckey, ptr) == length</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="74">
          <span class="hits">282</span>
          
          <code class="ruby">      size = ptr.read_pointer.get_array_of_uint8(8, 1)[0]</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="75">
          <span class="hits">282</span>
          
          <code class="ruby">      ptr.read_pointer.get_array_of_uint8(9, size).pack(&quot;C*&quot;).rjust(32, &quot;\x00&quot;).unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      #der_to_private_key( ptr.read_pointer.read_string(length).unpack(&quot;H*&quot;)[0] )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="79">
          <span class="hits">282</span>
          
          <code class="ruby">    if priv_hex != private_key_hex</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">      raise &quot;regenerated wrong private_key, raise here before generating a faulty public_key too!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="84">
          <span class="hits">282</span>
          
          <code class="ruby">    length = i2o_ECPublicKey(eckey, nil)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="85">
          <span class="hits">282</span>
          
          <code class="ruby">    ptr = FFI::MemoryPointer.new(:pointer)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="86">
          <span class="hits">282</span>
          
          <code class="ruby">    pub_hex = if i2o_ECPublicKey(eckey, ptr) == length</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="87">
          <span class="hits">282</span>
          
          <code class="ruby">      ptr.read_pointer.read_string(length).unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="90">
          <span class="hits">282</span>
          
          <code class="ruby">    EC_KEY_free(eckey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="92">
          <span class="hits">282</span>
          
          <code class="ruby">    [ priv_hex, pub_hex ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  # extract private key from uncompressed DER format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.der_to_private_key(der_hex)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    init_ffi_ssl</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    #k  = EC_KEY_new_by_curve_name(NID_secp256k1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    #kp = FFI::MemoryPointer.new(:pointer).put_pointer(0, eckey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">    buf = FFI::MemoryPointer.from_string([der_hex].pack(&quot;H*&quot;))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    ptr = FFI::MemoryPointer.new(:pointer).put_pointer(0, buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    #ec_key = d2i_ECPrivateKey(kp, ptr, buf.size-1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    ec_key = d2i_ECPrivateKey(nil, ptr, buf.size-1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">    return nil if ec_key.null?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">    bn = EC_KEY_get0_private_key(ec_key)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">    BN_bn2bin(bn, buf)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    buf.read_string(32).unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.init_ffi_ssl</code>
        </li>
      
        <li class="covered" data-hits="283" data-linenumber="113">
          <span class="hits">283</span>
          
          <code class="ruby">    return if @ssl_loaded</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">    SSL_library_init()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    ERR_load_crypto_strings()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">    SSL_load_error_strings()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">    RAND_poll()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">    @ssl_loaded = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="eb82939148b5de4151cdeacc2d9ed89caee32ee5">
  <div class="header">
    <h3>lib/bitcoin/key.rb</h3>
    <h4><span class="green">98.0 %</span> covered</h4>
    <div>
      <b>50</b> relevant lines. 
      <span class="green"><b>49</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # Elliptic Curve key as used in bitcoin.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class Key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    # Generate a new keypair.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    #  Bitcoin::Key.generate</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.generate</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="9">
          <span class="hits">63</span>
          
          <code class="ruby">      k = new; k.generate; k</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # Import private key from base58 fromat as described in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # https://en.bitcoin.it/wiki/Private_key#Base_58_Wallet_Import_format and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # https://en.bitcoin.it/wiki/Base58Check_encoding#Encoding_a_private_key.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # See also #to_base58</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.from_base58(str)</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="17">
          <span class="hits">43</span>
          
          <code class="ruby">      hex = Bitcoin.decode_base58(str)</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="18">
          <span class="hits">43</span>
          
          <code class="ruby">      version, key, checksum = hex.unpack(&quot;a2a64a8&quot;)</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="19">
          <span class="hits">43</span>
          
          <code class="ruby">      raise &quot;Invalid version&quot;   unless version == Bitcoin.network[:privkey_version]</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="20">
          <span class="hits">43</span>
          
          <code class="ruby">      raise &quot;Invalid checksum&quot;  unless Bitcoin.checksum(version + key) == checksum</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="21">
          <span class="hits">43</span>
          
          <code class="ruby">      new(key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    def == other</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="25">
          <span class="hits">7</span>
          
          <code class="ruby">      self.priv == other.priv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # Create a new key with given +privkey+ and +pubkey+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    #  Bitcoin::Key.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    #  Bitcoin::Key.new(privkey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    #  Bitcoin::Key.new(nil, pubkey)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize privkey = nil, pubkey = nil</code>
        </li>
      
        <li class="covered" data-hits="417" data-linenumber="33">
          <span class="hits">417</span>
          
          <code class="ruby">      @key = Bitcoin.bitcoin_elliptic_curve</code>
        </li>
      
        <li class="covered" data-hits="417" data-linenumber="34">
          <span class="hits">417</span>
          
          <code class="ruby">      set_priv(privkey)  if privkey</code>
        </li>
      
        <li class="covered" data-hits="417" data-linenumber="35">
          <span class="hits">417</span>
          
          <code class="ruby">      set_pub(pubkey)  if pubkey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # Generate new priv/pub key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="40">
          <span class="hits">71</span>
          
          <code class="ruby">      @key.generate_key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # Get the private key (in hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    def priv</code>
        </li>
      
        <li class="covered" data-hits="153" data-linenumber="45">
          <span class="hits">153</span>
          
          <code class="ruby">      return nil  unless @key.private_key</code>
        </li>
      
        <li class="covered" data-hits="105" data-linenumber="46">
          <span class="hits">105</span>
          
          <code class="ruby">      @key.private_key.to_hex.rjust(64, '0')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    # Set the private key to +priv+ (in hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    def priv= priv</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      set_priv(priv)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    # Get the public key (in hex).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    # In case the key was initialized with only</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    # a private key, the public key is regenerated.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def pub</code>
        </li>
      
        <li class="covered" data-hits="354" data-linenumber="58">
          <span class="hits">354</span>
          
          <code class="ruby">      unless @key.public_key</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="59">
          <span class="hits">87</span>
          
          <code class="ruby">        if @key.private_key</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="60">
          <span class="hits">26</span>
          
          <code class="ruby">          set_pub(Bitcoin::OpenSSL_EC.regenerate_key(priv)[1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="62">
          <span class="hits">61</span>
          
          <code class="ruby">          return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="293" data-linenumber="65">
          <span class="hits">293</span>
          
          <code class="ruby">      @key.public_key.to_hex.rjust(130, '0')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    # Set the public key (in hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def pub= pub</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      set_pub(pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    # Get the hash160 of the public key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160</code>
        </li>
      
        <li class="covered" data-hits="155" data-linenumber="75">
          <span class="hits">155</span>
          
          <code class="ruby">      Bitcoin.hash160(pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    # Get the address corresponding to the public key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    def addr</code>
        </li>
      
        <li class="covered" data-hits="155" data-linenumber="80">
          <span class="hits">155</span>
          
          <code class="ruby">      Bitcoin.hash160_to_address(hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    # Sign +data+ with the key.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    #  key1 = Bitcoin::Key.generate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    #  sig = key.sign(&quot;some data&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    def sign(data)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="87">
          <span class="hits">52</span>
          
          <code class="ruby">      @key.dsa_sign_asn1(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # Verify signature +sig+ for +data+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    #  key2 = Bitcoin::Key.new(nil, key1.pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    #  key2.verify(&quot;some data&quot;, sig)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    def verify(data, sig)</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="94">
          <span class="hits">70</span>
          
          <code class="ruby">      @key.dsa_verify_asn1(data, sig)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    # Export private key to base58 format.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    # See also Key.from_base58</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_base58</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="100">
          <span class="hits">6</span>
          
          <code class="ruby">      data = Bitcoin.network[:privkey_version] + priv</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="101">
          <span class="hits">6</span>
          
          <code class="ruby">      hex  = data + Bitcoin.checksum(data)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="102">
          <span class="hits">6</span>
          
          <code class="ruby">      Bitcoin.int_to_base58( hex.to_i(16) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    # Regenerate public key from the private key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">    def regenerate_pubkey</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">      set_pub(Bitcoin::OpenSSL_EC.regenerate_key(priv)[1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    # Set +priv+ as the new private key (converting from hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">    def set_priv(priv)</code>
        </li>
      
        <li class="covered" data-hits="141" data-linenumber="114">
          <span class="hits">141</span>
          
          <code class="ruby">      @key.private_key = OpenSSL::BN.from_hex(priv)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    # Set +pub+ as the new public key (converting from hex).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">    def set_pub(pub)</code>
        </li>
      
        <li class="covered" data-hits="205" data-linenumber="119">
          <span class="hits">205</span>
          
          <code class="ruby">      @key.public_key = OpenSSL::PKey::EC::Point.from_hex(@key.group, pub)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f5d6d97008ffec5aff3bc91103ab60ec056c27d1">
  <div class="header">
    <h3>lib/bitcoin/logger.rb</h3>
    <h4><span class="red">80.0 %</span> covered</h4>
    <div>
      <b>35</b> relevant lines. 
      <span class="green"><b>28</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">if Bitcoin.require_dependency :log4r, exit: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # monkey-patch Log4r to accept level names as symbols</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  class Log4r::Logger</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    def level= l = 0</code>
        </li>
      
        <li class="covered" data-hits="64" data-linenumber="5">
          <span class="hits">64</span>
          
          <code class="ruby">      _level = l.is_a?(Fixnum) ? l : Log4r::LNAMES.index(l.to_s.upcase)</code>
        </li>
      
        <li class="covered" data-hits="64" data-linenumber="6">
          <span class="hits">64</span>
          
          <code class="ruby">      Log4r::Log4rTools.validate_level(_level)</code>
        </li>
      
        <li class="covered" data-hits="64" data-linenumber="7">
          <span class="hits">64</span>
          
          <code class="ruby">      @level = _level</code>
        </li>
      
        <li class="covered" data-hits="64" data-linenumber="8">
          <span class="hits">64</span>
          
          <code class="ruby">      LoggerFactory.define_methods(self)</code>
        </li>
      
        <li class="covered" data-hits="64" data-linenumber="9">
          <span class="hits">64</span>
          
          <code class="ruby">      Log4r::Logger.log_internal {&quot;Logger '#{@fullname}' set to #{LNAMES[@level]}&quot;}</code>
        </li>
      
        <li class="covered" data-hits="64" data-linenumber="10">
          <span class="hits">64</span>
          
          <code class="ruby">      @level</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # this is a very simple logger that is used if log4r is not available</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  module Logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    class Logger</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      LEVELS = [:debug, :info, :warn, :error, :fatal]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :level</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        @name, @level = name, :info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      def level= level</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        @level = level.is_a?(Fixnum) ? LEVELS[level] : level.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      LEVELS.each do |level|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="33">
          <span class="hits">5</span>
          
          <code class="ruby">        define_method(level) do |*msg, &amp;block|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">          return  if LEVELS.index(level.to_sym) &lt; LEVELS.index(@level.to_sym)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">          msg = block ? block.call : msg.join</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">          puts &quot;#{level.to_s.upcase.ljust(5)} #{@name}: #{msg}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    # wrap a logger and prepend a special name in front of the messages</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    class LogWrapper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(name, log); @name, @log = name, log; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">      def method_missing(m, *a, &amp;blk)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        @log.send(m, *a, &amp;proc{ &quot;#{@name} #{blk.call}&quot; })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    # create a logger with given +name+. if log4r is installed, the logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    # will have a stdout and a fileout outputter to `log/&lt;name&gt;.log`.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    # otherwise, the internal dummy logger is used which only logs to stdout.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.create name, level = :info</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">      if defined?(Log4r)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="54">
          <span class="hits">2</span>
          
          <code class="ruby">        @log = Log4r::Logger.new(name.to_s)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="55">
          <span class="hits">2</span>
          
          <code class="ruby">        @log.level = level</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="56">
          <span class="hits">2</span>
          
          <code class="ruby">        @log.outputters &lt;&lt; Log4r::Outputter.stdout</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="57">
          <span class="hits">2</span>
          
          <code class="ruby">        @log.outputters &lt;&lt; Log4r::FileOutputter.new(&quot;fout&quot;, :filename =&gt; &quot;log/#{name}.log&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        @log = Bitcoin::Logger::Logger.new(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="61">
          <span class="hits">2</span>
          
          <code class="ruby">      @log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="097a63ca9e1638fe6b84d7fad2f0982e08134c36">
  <div class="header">
    <h3>lib/bitcoin/protocol.rb</h3>
    <h4><span class="red">75.0 %</span> covered</h4>
    <div>
      <b>80</b> relevant lines. 
      <span class="green"><b>60</b> lines covered</span> and
      <span class="red"><b>20</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'socket'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'digest/sha2'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'json'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :TxIn,    'bitcoin/protocol/txin'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :TxOut,   'bitcoin/protocol/txout'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Tx,      'bitcoin/protocol/tx'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Block,   'bitcoin/protocol/block'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Addr,    'bitcoin/protocol/address'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Alert,   'bitcoin/protocol/alert'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Version, 'bitcoin/protocol/version'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Handler, 'bitcoin/protocol/handler'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    autoload :Parser,  'bitcoin/protocol/parser'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    VERSION = 60001</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    DNS_Seed = [ &quot;bitseed.xf2.org&quot;, &quot;bitseed.bitcoin.org.uk&quot; ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    Uniq = rand(0xffffffffffffffff)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="4875" data-linenumber="25">
          <span class="hits">4875</span>
          
          <code class="ruby">      case payload.unpack(&quot;C&quot;)[0] # TODO add test cases</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="26">
          <span class="hits">7</span>
          
          <code class="ruby">      when 0xfd; payload.unpack(&quot;xva*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      when 0xfe; payload.unpack(&quot;xVa*&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      when 0xff; payload.unpack(&quot;xQa*&quot;) # TODO add little-endian version of Q</code>
        </li>
      
        <li class="covered" data-hits="4867" data-linenumber="29">
          <span class="hits">4867</span>
          
          <code class="ruby">      else;      payload.unpack(&quot;Ca*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.pack_var_int(i)</code>
        </li>
      
        <li class="covered" data-hits="16500" data-linenumber="34">
          <span class="hits">16500</span>
          
          <code class="ruby">      if    i &lt;  0xfd;                [      i].pack(&quot;C&quot;)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="35">
          <span class="hits">24</span>
          
          <code class="ruby">      elsif i &lt;= 0xffff;              [0xfd, i].pack(&quot;Cv&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      elsif i &lt;= 0xffffffff;          [0xfe, i].pack(&quot;CV&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      elsif i &lt;= 0xffffffffffffffff;  [0xff, i].pack(&quot;CQ&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      else raise &quot;int(#{i}) too large!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_string(payload)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="43">
          <span class="hits">12</span>
          
          <code class="ruby">      size, payload = unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="44">
          <span class="hits">12</span>
          
          <code class="ruby">      size &gt; 0 ? (string, payload = payload.unpack(&quot;a#{size}a*&quot;)) : [nil, payload]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.pack_var_string(payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">      pack_var_int(payload.bytesize) + payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_string_array(payload) # unpacks set&lt;string&gt;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="52">
          <span class="hits">2</span>
          
          <code class="ruby">      size, payload = unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">      return [nil, payload] if size == 0</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="54">
          <span class="hits">4</span>
          
          <code class="ruby">      [(0...size).map{ s, payload = unpack_var_string(payload); s }, payload]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.unpack_var_int_array(payload) # unpacks set&lt;int&gt;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="58">
          <span class="hits">2</span>
          
          <code class="ruby">      size, payload = unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">      return [nil, payload] if size == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      [(0...size).map{ i, payload = unpack_var_int(payload); i }, payload]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.pkt(command, payload)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="65">
          <span class="hits">14</span>
          
          <code class="ruby">      cmd      = command.ljust(12, &quot;\x00&quot;)[0...12]</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="66">
          <span class="hits">14</span>
          
          <code class="ruby">      length   = [payload.bytesize].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="67">
          <span class="hits">14</span>
          
          <code class="ruby">      checksum = Digest::SHA256.digest(Digest::SHA256.digest(payload))[0...4]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="69">
          <span class="hits">14</span>
          
          <code class="ruby">      [Bitcoin.network[:magic_head], cmd, length, checksum, payload].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.version_pkt(from_id, from=nil, to=nil, last_block=nil, time=nil, user_agent=nil, version=nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      opts = if from_id.is_a?(Hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        from_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        STDERR.puts &quot;Bitcoin::Protocol.version_pkt - API deprecated. please change it soon..&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          :nonce =&gt; from_id, :from =&gt; from, :to =&gt; to, :last_block =&gt; last_block,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">          :time =&gt; time, :user_agent =&gt; user_agent, :version =&gt; version</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      version = Protocol::Version.new(opts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      version.to_pkt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.ping_pkt(nonce = rand(0xffffffff))</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="87">
          <span class="hits">2</span>
          
          <code class="ruby">      pkt(&quot;ping&quot;, [nonce].pack(&quot;Q&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.pong_pkt(nonce)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">      pkt(&quot;pong&quot;, [nonce].pack(&quot;Q&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.verack_pkt</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      pkt(&quot;verack&quot;, &quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    TypeLookup = Hash[:tx, 1, :block, 2, nil, 0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.getdata_pkt(type, hashes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      return if hashes.size &gt;= 256</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">      t = [ TypeLookup[type] ].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      pkt(&quot;getdata&quot;, [hashes.size].pack(&quot;C&quot;) + hashes.map{|hash| t + hash[0..32].reverse }.join)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.inv_pkt(type, hashes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      return if hashes.size &gt;= 256</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      t = [ TypeLookup[type] ].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">      pkt(&quot;inv&quot;, [hashes.size].pack(&quot;C&quot;) + hashes.map{|hash| t + hash[0..32].reverse }.join)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">    DEFAULT_STOP_HASH = &quot;00&quot;*32</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.locator_payload(locator_hashes, stop_hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="115">
          <span class="hits">2</span>
          
          <code class="ruby">      payload = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        Bitcoin.network[:magic_head],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        pack_var_int(locator_hashes.size),</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="118">
          <span class="hits">4</span>
          
          <code class="ruby">        locator_hashes.map{|l| l.htb_reverse }.join,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        stop_hash.htb_reverse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      ].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.getblocks_pkt(locator_hashes, stop_hash=DEFAULT_STOP_HASH)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="124">
          <span class="hits">2</span>
          
          <code class="ruby">      pkt &quot;getblocks&quot;,  locator_payload(locator_hashes, stop_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.getheaders_pkt(locator_hashes, stop_hash=DEFAULT_STOP_HASH)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      pkt &quot;getheaders&quot;, locator_payload(locator_hashes, stop_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.read_binary_file(path)</code>
        </li>
      
        <li class="covered" data-hits="762" data-linenumber="132">
          <span class="hits">762</span>
          
          <code class="ruby">      File.open(path, 'rb'){|f| f.read }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">  P = Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7232aa03263e2a301dcf3642c61bc0272ac13cbf">
  <div class="header">
    <h3>lib/bitcoin/protocol/address.rb</h3>
    <h4><span class="green">95.0 %</span> covered</h4>
    <div>
      <b>20</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class Addr &lt; Struct.new(:time, :service, :ip, :port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      # # IP Address / Port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      # attr_reader :ip, :port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      # # Time the node was last active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # attr_reader :time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # # Services supported by this node</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      # attr_reader :service</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # create addr from raw binary +data+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data = nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="17">
          <span class="hits">5</span>
          
          <code class="ruby">        if data</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">          self[:time], self[:service], self[:ip], self[:port] = data.unpack(&quot;IQx12a4n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">          self[:ip] = ip.unpack(&quot;C*&quot;).join(&quot;.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="21">
          <span class="hits">3</span>
          
          <code class="ruby">          self[:time], self[:service] = Time.now.to_i, 1</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="22">
          <span class="hits">3</span>
          
          <code class="ruby">          self[:ip], self[:port] = &quot;127.0.0.1&quot;, Bitcoin.network[:default_port]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # is this address alive?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      def alive?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">        (Time.now.tv_sec-7200) &lt;= self[:time]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="32">
          <span class="hits">4</span>
          
          <code class="ruby">        ip = self[:ip].split(&quot;.&quot;).map(&amp;:to_i)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="33">
          <span class="hits">4</span>
          
          <code class="ruby">        [ time, service, (&quot;\x00&quot;*10)+&quot;\xff\xff&quot;, *ip, port ].pack(&quot;IQa12C4n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      def string</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        &quot;#{self[:ip]}:#{self[:port]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.pkt(*addrs)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="41">
          <span class="hits">2</span>
          
          <code class="ruby">        addrs = addrs.select{|i| i.is_a?(Bitcoin::Protocol::Addr) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">        length = Bitcoin::Protocol.pack_var_int(addrs.size)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">        Bitcoin::Protocol.pkt(&quot;addr&quot;, length + addrs.map(&amp;:to_payload).join)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7d06569f2eaac3f62f37ef5987a9d46ed2181b70">
  <div class="header">
    <h3>lib/bitcoin/protocol/alert.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>27</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  class Alert &lt; Struct.new(:version, :relay_until, :expiration, :id, :cancel, :set_cancel,</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">                           :min_ver, :max_ver, :set_sub_ver, :priority, :comment, :status_bar, :reserved)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :payload, :signature</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(values, alert_payload=nil, alert_signature=nil)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">      @payload, @signature = alert_payload, alert_signature</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">      super(*values)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    Valid_Keys = [ &quot;04fc9702847840aaf195de8442ebecedf5b095cdbb9bc716bda9110971b28a49e0ead8564ff0db22209e0374782c093bb899692d524e9d6a6956e7c5ecbcd68284&quot; ] </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    def valid_signature?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">      return false unless @payload &amp;&amp; @signature</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">      hash = Digest::SHA256.digest(Digest::SHA256.digest(@payload))</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="20">
          <span class="hits">4</span>
          
          <code class="ruby">      Valid_Keys.any?{|public_key| Bitcoin.verify_signature(hash, @signature, public_key) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.parse(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">      count,             payload = Bitcoin::Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="26">
          <span class="hits">2</span>
          
          <code class="ruby">      alert_payload,     payload = payload.unpack(&quot;a#{count}a*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="27">
          <span class="hits">2</span>
          
          <code class="ruby">      count,             payload = Bitcoin::Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">      alert_signature,   payload = payload.unpack(&quot;a#{count}a*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="30">
          <span class="hits">2</span>
          
          <code class="ruby">      version, relay_until, expiration, id, cancel, payload = alert_payload.unpack(&quot;VQQVVa*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="32">
          <span class="hits">2</span>
          
          <code class="ruby">      set_cancel,        payload = Bitcoin::Protocol.unpack_var_int_array(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="33">
          <span class="hits">2</span>
          
          <code class="ruby">      min_ver, max_ver,  payload = payload.unpack(&quot;VVa*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="34">
          <span class="hits">2</span>
          
          <code class="ruby">      set_sub_ver,       payload = Bitcoin::Protocol.unpack_var_string_array(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="35">
          <span class="hits">2</span>
          
          <code class="ruby">      priority,          payload = payload.unpack(&quot;Va*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">      comment,           payload = Bitcoin::Protocol.unpack_var_string(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="37">
          <span class="hits">2</span>
          
          <code class="ruby">      status_bar,        payload = Bitcoin::Protocol.unpack_var_string(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="38">
          <span class="hits">2</span>
          
          <code class="ruby">      reserved,          payload = Bitcoin::Protocol.unpack_var_string(payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="40">
          <span class="hits">2</span>
          
          <code class="ruby">      values = [ version, relay_until, expiration, id, cancel, set_cancel, min_ver, max_ver, set_sub_ver, priority, comment, status_bar, reserved ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="42">
          <span class="hits">2</span>
          
          <code class="ruby">      new(values, alert_payload, alert_signature)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b85bdf561b3dc51ecfd89215f675dc4ae6ab50a3">
  <div class="header">
    <h3>lib/bitcoin/protocol/block.rb</h3>
    <h4><span class="green">92.31 %</span> covered</h4>
    <div>
      <b>78</b> relevant lines. 
      <span class="green"><b>72</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class Block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      # block hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      # previous block hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :prev_block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # transactions (Array of Tx)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # merkle root</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :mrkl_root</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # block generation time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      # difficulty target bits</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :bits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      # nonce (number counted when searching for block hash matching target)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      # version (usually 1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :ver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      # raw protocol payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :transactions :tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      # compare to another block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="covered" data-hits="314" data-linenumber="37">
          <span class="hits">314</span>
          
          <code class="ruby">        @hash == other.hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      def binary_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        [@hash].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      # create block from raw binary +data+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data)</code>
        </li>
      
        <li class="covered" data-hits="373" data-linenumber="46">
          <span class="hits">373</span>
          
          <code class="ruby">        @tx = []</code>
        </li>
      
        <li class="covered" data-hits="373" data-linenumber="47">
          <span class="hits">373</span>
          
          <code class="ruby">        parse_data(data) if data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      # parse raw binary data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="295" data-linenumber="52">
          <span class="hits">295</span>
          
          <code class="ruby">        @ver, @prev_block, @mrkl_root, @time, @bits, @nonce, payload = data.unpack(&quot;Ia32a32IIIa*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="295" data-linenumber="53">
          <span class="hits">295</span>
          
          <code class="ruby">        recalc_block_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="294" data-linenumber="55">
          <span class="hits">294</span>
          
          <code class="ruby">        tx_size, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="824" data-linenumber="56">
          <span class="hits">824</span>
          
          <code class="ruby">        (0...tx_size).each{  break if payload == true</code>
        </li>
      
        <li class="covered" data-hits="530" data-linenumber="57">
          <span class="hits">530</span>
          
          <code class="ruby">          t = Tx.new(nil)</code>
        </li>
      
        <li class="covered" data-hits="530" data-linenumber="58">
          <span class="hits">530</span>
          
          <code class="ruby">          payload = t.parse_data(payload)</code>
        </li>
      
        <li class="covered" data-hits="530" data-linenumber="59">
          <span class="hits">530</span>
          
          <code class="ruby">          @tx &lt;&lt; t</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="294" data-linenumber="62">
          <span class="hits">294</span>
          
          <code class="ruby">        @payload = to_payload</code>
        </li>
      
        <li class="covered" data-hits="294" data-linenumber="63">
          <span class="hits">294</span>
          
          <code class="ruby">        payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      # recalculate the block hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">      def recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="19757" data-linenumber="68">
          <span class="hits">19757</span>
          
          <code class="ruby">        @hash = Bitcoin.block_hash(@prev_block.reverse_hth, @mrkl_root.reverse_hth, @time, @bits, @nonce, @ver)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      # verify mrkl tree</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">      def verify_mrkl_root</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="73">
          <span class="hits">3</span>
          
          <code class="ruby">        @mrkl_root.reverse_hth == Bitcoin.hash_mrkl_tree( @tx.map(&amp;:hash) ).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      # get the block header info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      # [&lt;version&gt;, &lt;prev_block&gt;, &lt;merkle_root&gt;, &lt;time&gt;, &lt;bits&gt;, &lt;nonce&gt;, &lt;txcount&gt;, &lt;size&gt;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">      def header_info</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="79">
          <span class="hits">2</span>
          
          <code class="ruby">        [@ver, @prev_block.reverse_hth, @mrkl_root.reverse_hth, Time.at(@time), @bits, @nonce, @tx.size, @payload.size]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      # convert to raw binary format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="793" data-linenumber="84">
          <span class="hits">793</span>
          
          <code class="ruby">        head = [@ver, @prev_block, @mrkl_root, @time, @bits, @nonce].pack(&quot;Ia32a32III&quot;)</code>
        </li>
      
        <li class="covered" data-hits="793" data-linenumber="85">
          <span class="hits">793</span>
          
          <code class="ruby">        [head, Protocol.pack_var_int(@tx.size), @tx.map(&amp;:to_payload).join].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      # convert to ruby hash (see also #from_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">          'hash' =&gt; @hash, 'ver' =&gt; @ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">          'prev_block' =&gt; @prev_block.reverse_hth, 'mrkl_root' =&gt; @mrkl_root.reverse_hth,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">          'time' =&gt; @time, 'bits' =&gt; @bits, 'nonce' =&gt; @nonce,</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="94">
          <span class="hits">19</span>
          
          <code class="ruby">          'n_tx' =&gt; @tx.size, 'size' =&gt; (@payload||to_payload).bytesize,</code>
        </li>
      
        <li class="covered" data-hits="129" data-linenumber="95">
          <span class="hits">129</span>
          
          <code class="ruby">          'tx' =&gt; @tx.map{|i| i.to_hash },</code>
        </li>
      
        <li class="covered" data-hits="129" data-linenumber="96">
          <span class="hits">129</span>
          
          <code class="ruby">          'mrkl_tree' =&gt; Bitcoin.hash_mrkl_tree( @tx.map{|i| i.hash } )</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="97">
          <span class="hits">19</span>
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">      def hextarget</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        Bitcoin.decode_compact_bits(@bits)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">      def decimaltarget</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        Bitcoin.decode_compact_bits(@bits).to_i(16)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">      def difficulty</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        Bitcoin.block_difficulty(@bits)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">      # introduced in block version 2 by BIP_0034</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      # blockchain height as seen by the block itself.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      # do not trust this value, instead verify with chain storage.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">      def bip34_block_height</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="116">
          <span class="hits">2</span>
          
          <code class="ruby">        return nil unless @ver &gt;= 2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">        coinbase = @tx.first.inputs.first.script_sig</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">        coinbase.unpack(&quot;xH#{ coinbase.unpack(&quot;C&quot;)[0]*2 }&quot;)[0].to_i(16)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">        nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      # convert to json representation as seen in the block explorer.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      # (see also #from_json)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_json(options = {:space =&gt; ''}, *a)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="126">
          <span class="hits">5</span>
          
          <code class="ruby">        JSON.pretty_generate( to_hash, options )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      # write json representation to a file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      # (see also #to_json)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_json_file(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">        File.open(path, 'wb'){|f| f.print to_json; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      # parse ruby hash (see also #to_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash(h)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="137">
          <span class="hits">9</span>
          
          <code class="ruby">        blk = new(nil)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="138">
          <span class="hits">9</span>
          
          <code class="ruby">        blk.instance_eval{</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="139">
          <span class="hits">9</span>
          
          <code class="ruby">          @ver, @time, @bits, @nonce = h.values_at('ver', 'time', 'bits', 'nonce')</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="140">
          <span class="hits">27</span>
          
          <code class="ruby">          @prev_block, @mrkl_root = h.values_at('prev_block', 'mrkl_root').map{|i| i.htb_reverse }</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="141">
          <span class="hits">9</span>
          
          <code class="ruby">          recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="300" data-linenumber="142">
          <span class="hits">300</span>
          
          <code class="ruby">          h['tx'].each{|tx| @tx &lt;&lt; Tx.from_hash(tx) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="144">
          <span class="hits">9</span>
          
          <code class="ruby">        blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      # convert ruby hash to raw binary</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.binary_from_hash(h); from_hash(h).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      # parse json representation (see also #to_json)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="151">
          <span class="hits">10</span>
          
          <code class="ruby">      def self.from_json(json_string); from_hash( JSON.load(json_string) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      # convert json representation to raw binary</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.binary_from_json(json_string); from_json(json_string).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">      # convert header to json representation.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">      def header_to_json(options = {:space =&gt; ''})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">        h = to_hash</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="159">
          <span class="hits">3</span>
          
          <code class="ruby">        %w[tx mrkl_tree].each{|k| h.delete(k) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">        JSON.pretty_generate( h, options )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      # read binary block from a file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_file(path); new( Bitcoin::Protocol.read_binary_file(path) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      # read json block from a file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_json_file(path); from_json( Bitcoin::Protocol.read_binary_file(path) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">      def validator(store, prev_block = nil)</code>
        </li>
      
        <li class="covered" data-hits="434" data-linenumber="170">
          <span class="hits">434</span>
          
          <code class="ruby">        @validator ||= Bitcoin::Validation::Block.new(self, store, prev_block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ec26a72c762bc13eda908614b56e96d8669a4d80">
  <div class="header">
    <h3>lib/bitcoin/protocol/handler.rb</h3>
    <h4><span class="red">58.82 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class Handler</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_inv_transaction(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">        p ['inv transaction', hash.hth]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_inv_block(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        p ['inv block', hash.hth]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_get_transaction(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        p ['get transaction', hash.hth]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_get_block(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        p ['get block', hash.hth]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_addr(addr)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        p ['addr', addr, addr.alive?]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        p ['tx', tx]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      def on_block(block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        #p ['block', block]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        puts block.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="557ee148bb367f942116155fdc327b5fa7942241">
  <div class="header">
    <h3>lib/bitcoin/protocol/parser.rb</h3>
    <h4><span class="red">72.83 %</span> covered</h4>
    <div>
      <b>92</b> relevant lines. 
      <span class="green"><b>67</b> lines covered</span> and
      <span class="red"><b>25</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class Parser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(handler=nil)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="7">
          <span class="hits">18</span>
          
          <code class="ruby">        @h = handler || Handler.new</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="8">
          <span class="hits">18</span>
          
          <code class="ruby">        @buf = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      def log</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">        @log ||= Bitcoin::Logger.create(&quot;parser&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # handles inv/getdata packets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_inv(payload, type=:put)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="18">
          <span class="hits">5</span>
          
          <code class="ruby">        count, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="19">
          <span class="hits">5</span>
          
          <code class="ruby">        payload.each_byte.each_slice(36){|i|</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="20">
          <span class="hits">7</span>
          
          <code class="ruby">          hash = i[4..-1].reverse.pack(&quot;C32&quot;)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="21">
          <span class="hits">7</span>
          
          <code class="ruby">          case i[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          when 1</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="23">
          <span class="hits">5</span>
          
          <code class="ruby">            if type == :put</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="24">
          <span class="hits">4</span>
          
          <code class="ruby">              @h.on_inv_transaction(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">              @h.on_get_transaction(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">          when 2</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="29">
          <span class="hits">2</span>
          
          <code class="ruby">            if type == :put</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">              @h.on_inv_block(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">              @h.on_get_block(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">            p ['parse_inv error', i]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_addr(payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">        count, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">        payload.each_byte.each_slice(30){|i|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">            addr = Addr.new(i.pack(&quot;C*&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">          rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">            puts &quot;Error parsing addr: #{i.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">          @h.on_addr( addr )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_headers(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        count, payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        idx = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        headers = count.times.map{ Block.new(payload[idx..idx+=81]) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        @h.on_headers(headers)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_getblocks(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">        version, payload = payload.unpack('a4a*')</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="61">
          <span class="hits">2</span>
          
          <code class="ruby">        count,   payload = Protocol.unpack_var_int(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="62">
          <span class="hits">2</span>
          
          <code class="ruby">        buf,     payload = payload.unpack(&quot;a#{count*32}a*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="63">
          <span class="hits">6</span>
          
          <code class="ruby">        hashes    = buf.each_byte.each_slice(32).map{|i| hash = i.reverse.pack(&quot;C32&quot;).hth }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="64">
          <span class="hits">2</span>
          
          <code class="ruby">        stop_hash = payload[0..32].reverse_hth</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="65">
          <span class="hits">2</span>
          
          <code class="ruby">        [version, hashes, stop_hash]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      def process_pkt(command, payload)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="69">
          <span class="hits">17</span>
          
          <code class="ruby">        case command</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        when 'tx';       @h.on_tx( Tx.new(payload) )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        when 'block';    @h.on_block( Block.new(payload) )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        when 'headers';  parse_headers(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="73">
          <span class="hits">3</span>
          
          <code class="ruby">        when 'inv';      parse_inv(payload, :put)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="74">
          <span class="hits">2</span>
          
          <code class="ruby">        when 'getdata';  parse_inv(payload, :get)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">        when 'addr';     parse_addr(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        when 'verack';   @h.on_handshake_complete # nop</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="77">
          <span class="hits">3</span>
          
          <code class="ruby">        when 'version';  parse_version(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        when 'alert';    parse_alert(payload)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="79">
          <span class="hits">4</span>
          
          <code class="ruby">        when 'ping';     @h.on_ping(payload.unpack(&quot;Q&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="80">
          <span class="hits">2</span>
          
          <code class="ruby">        when 'pong';     @h.on_pong(payload.unpack(&quot;Q&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="81">
          <span class="hits">2</span>
          
          <code class="ruby">        when 'getblocks';   @h.on_getblocks(*parse_getblocks(payload))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">        when 'getheaders';  @h.on_getheaders(*parse_getblocks(payload))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        when 'mempool';  handle_mempool_request(payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">          p ['unkown-packet', command, payload]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_version(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="90">
          <span class="hits">3</span>
          
          <code class="ruby">        @version = Bitcoin::Protocol::Version.parse(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="91">
          <span class="hits">3</span>
          
          <code class="ruby">        @h.on_version(@version)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_alert(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        return unless @h.respond_to?(:on_alert)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        @h.on_alert Bitcoin::Protocol::Alert.parse(payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      # https://en.bitcoin.it/wiki/BIP_0035</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">      def handle_mempool_request(payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        return unless @version[:version] &gt;= 60002           # Protocol version &gt;= 60002</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        return unless (@version[:services] &amp; (1 &lt;&lt; 0)) == 1 # NODE_NETWORK bit set in Services</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        @h.on_mempool if @h.respond_to?(:on_mempool)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse(buf)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="107">
          <span class="hits">18</span>
          
          <code class="ruby">        @buf += buf</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="108">
          <span class="hits">18</span>
          
          <code class="ruby">        while parse_buffer; end</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="109">
          <span class="hits">18</span>
          
          <code class="ruby">        @buf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_buffer</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="113">
          <span class="hits">30</span>
          
          <code class="ruby">        head_magic = Bitcoin::network[:magic_head]</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="114">
          <span class="hits">30</span>
          
          <code class="ruby">        head_size  = 24</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="115">
          <span class="hits">30</span>
          
          <code class="ruby">        return false if @buf.size &lt;= head_size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="117">
          <span class="hits">18</span>
          
          <code class="ruby">        magic, cmd, length, checksum = @buf.unpack(&quot;a4A12Ia4&quot;)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="118">
          <span class="hits">18</span>
          
          <code class="ruby">        payload = @buf[head_size...head_size+length]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="120">
          <span class="hits">18</span>
          
          <code class="ruby">        unless magic == head_magic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">          handle_stream_error(:close, &quot;head_magic not found&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">          @buf = ''</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="125">
          <span class="hits">17</span>
          
          <code class="ruby">          if Digest::SHA256.digest(Digest::SHA256.digest( payload ))[0...4] != checksum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">            if (length &lt; 50000) &amp;&amp; (payload.size &lt; length)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">              size_info = [payload.size, length].join('/')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">              handle_stream_error(:debug, &quot;chunked packet stream (#{size_info})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">              handle_stream_error(:close, &quot;checksum mismatch&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">            return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="134">
          <span class="hits">17</span>
          
          <code class="ruby">          @buf = @buf[head_size+length..-1] || &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="136">
          <span class="hits">17</span>
          
          <code class="ruby">          process_pkt(cmd, payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        # not empty yet? parse more.</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="140">
          <span class="hits">18</span>
          
          <code class="ruby">        @buf[0] != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">      def handle_stream_error(type, msg)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">        case type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">        when :close</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">          log.debug {&quot;closing packet stream (#{msg})&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">          log.debug { [type, msg] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    end # Parser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="50420e37470493cafba8f41ed05b633a062fcdf4">
  <div class="header">
    <h3>lib/bitcoin/protocol/tx.rb</h3>
    <h4><span class="green">94.83 %</span> covered</h4>
    <div>
      <b>116</b> relevant lines. 
      <span class="green"><b>110</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'bitcoin/script'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class Tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      # transaction hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      # inputs (Array of TxIn)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # outputs (Array of TxOut)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # raw protocol payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # version (usually 1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :ver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      # lock time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :lock_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :inputs  :in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :outputs :out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      # compare to another tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="31">
          <span class="hits">36</span>
          
          <code class="ruby">        @hash == other.hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      # return the tx hash in binary format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      def binary_hash</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="36">
          <span class="hits">38</span>
          
          <code class="ruby">        [@hash].pack(&quot;H*&quot;).reverse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # create tx from raw binary +data+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data=nil)</code>
        </li>
      
        <li class="covered" data-hits="2235" data-linenumber="41">
          <span class="hits">2235</span>
          
          <code class="ruby">        @ver, @lock_time, @in, @out = 1, 0, [], []</code>
        </li>
      
        <li class="covered" data-hits="2235" data-linenumber="42">
          <span class="hits">2235</span>
          
          <code class="ruby">        parse_data(data) if data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      # generate the tx hash for given +payload+ in hex format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">      def hash_from_payload(payload)</code>
        </li>
      
        <li class="covered" data-hits="2165" data-linenumber="47">
          <span class="hits">2165</span>
          
          <code class="ruby">        Digest::SHA256.digest(Digest::SHA256.digest( payload )).reverse_hth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">      alias generate_hash hash_from_payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      # add an input</code>
        </li>
      
        <li class="covered" data-hits="1830" data-linenumber="52">
          <span class="hits">1830</span>
          
          <code class="ruby">      def add_in(input); (@in ||= []) &lt;&lt; input; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      # add an output</code>
        </li>
      
        <li class="covered" data-hits="2566" data-linenumber="55">
          <span class="hits">2566</span>
          
          <code class="ruby">      def add_out(output); (@out ||= []) &lt;&lt; output; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # parse raw binary data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="799" data-linenumber="59">
          <span class="hits">799</span>
          
          <code class="ruby">        @ver = data.unpack(&quot;I&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="799" data-linenumber="60">
          <span class="hits">799</span>
          
          <code class="ruby">        idx = 4</code>
        </li>
      
        <li class="covered" data-hits="799" data-linenumber="61">
          <span class="hits">799</span>
          
          <code class="ruby">        in_size, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="799" data-linenumber="62">
          <span class="hits">799</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize-tmp.bytesize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        # raise &quot;unkown transaction version: #{@ver}&quot; unless @ver == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="799" data-linenumber="65">
          <span class="hits">799</span>
          
          <code class="ruby">        @in = (0...in_size).map{</code>
        </li>
      
        <li class="covered" data-hits="999" data-linenumber="66">
          <span class="hits">999</span>
          
          <code class="ruby">          txin = TxIn.new</code>
        </li>
      
        <li class="covered" data-hits="999" data-linenumber="67">
          <span class="hits">999</span>
          
          <code class="ruby">          idx += txin.parse_data(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="998" data-linenumber="68">
          <span class="hits">998</span>
          
          <code class="ruby">          txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="798" data-linenumber="71">
          <span class="hits">798</span>
          
          <code class="ruby">        out_size, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="798" data-linenumber="72">
          <span class="hits">798</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize-tmp.bytesize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="798" data-linenumber="74">
          <span class="hits">798</span>
          
          <code class="ruby">        @out = (0...out_size).map{</code>
        </li>
      
        <li class="covered" data-hits="1957" data-linenumber="75">
          <span class="hits">1957</span>
          
          <code class="ruby">          txout = TxOut.new</code>
        </li>
      
        <li class="covered" data-hits="1957" data-linenumber="76">
          <span class="hits">1957</span>
          
          <code class="ruby">          idx += txout.parse_data(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="1957" data-linenumber="77">
          <span class="hits">1957</span>
          
          <code class="ruby">          txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="798" data-linenumber="80">
          <span class="hits">798</span>
          
          <code class="ruby">        @lock_time = data[idx...idx+=4].unpack(&quot;I&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="798" data-linenumber="82">
          <span class="hits">798</span>
          
          <code class="ruby">        @payload = data[0...idx]</code>
        </li>
      
        <li class="covered" data-hits="798" data-linenumber="83">
          <span class="hits">798</span>
          
          <code class="ruby">        @hash = hash_from_payload(@payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="798" data-linenumber="85">
          <span class="hits">798</span>
          
          <code class="ruby">        if data[idx] == nil</code>
        </li>
      
        <li class="covered" data-hits="554" data-linenumber="86">
          <span class="hits">554</span>
          
          <code class="ruby">          true          # reached the end.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="244" data-linenumber="88">
          <span class="hits">244</span>
          
          <code class="ruby">          data[idx..-1] # rest of buffer.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      # output transaction in raw binary format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="2855" data-linenumber="94">
          <span class="hits">2855</span>
          
          <code class="ruby">        pin  =  @in.map(&amp;:to_payload).join</code>
        </li>
      
        <li class="covered" data-hits="2855" data-linenumber="95">
          <span class="hits">2855</span>
          
          <code class="ruby">        pout = @out.map(&amp;:to_payload).join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2855" data-linenumber="97">
          <span class="hits">2855</span>
          
          <code class="ruby">        in_size, out_size = Protocol.pack_var_int(@in.size), Protocol.pack_var_int(@out.size)</code>
        </li>
      
        <li class="covered" data-hits="2855" data-linenumber="98">
          <span class="hits">2855</span>
          
          <code class="ruby">        [[@ver].pack(&quot;I&quot;), in_size, pin, out_size, pout, [@lock_time].pack(&quot;I&quot;)].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">      SIGHASH_TYPE = { all: 1, none: 2, single: 3, anyonecanpay: 128 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      # generate a signature hash for input +input_idx+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      # either pass the +outpoint_tx+ or the +script_pubkey+ directly.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">      def signature_hash_for_input(input_idx, outpoint_tx, script_pubkey=nil, hash_type=nil, drop_sigs=nil, script=nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        # https://github.com/bitcoin/bitcoin/blob/e071a3f6c06f41068ad17134189a4ac3073ef76b/script.cpp#L834</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        # http://code.google.com/p/bitcoinj/source/browse/trunk/src/com/google/bitcoin/core/Script.java#318</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        # https://en.bitcoin.it/wiki/OP_CHECKSIG#How_it_works</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        # https://github.com/bitcoin/bitcoin/blob/c2e8c8acd8ae0c94c70b59f55169841ad195bb99/src/script.cpp#L1058</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        # https://en.bitcoin.it/wiki/OP_CHECKSIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="113">
          <span class="hits">123</span>
          
          <code class="ruby">        hash_type ||= SIGHASH_TYPE[:all]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="115">
          <span class="hits">123</span>
          
          <code class="ruby">        pin  = @in.map.with_index{|input,idx|</code>
        </li>
      
        <li class="covered" data-hits="139" data-linenumber="116">
          <span class="hits">139</span>
          
          <code class="ruby">          if idx == input_idx</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="117">
          <span class="hits">123</span>
          
          <code class="ruby">            script_pubkey ||= outpoint_tx.out[ input.prev_out_index ].pk_script</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="118">
          <span class="hits">123</span>
          
          <code class="ruby">            script_pubkey = Bitcoin::Script.binary_from_string(script)                if script    # force this string a script</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="119">
          <span class="hits">123</span>
          
          <code class="ruby">            script_pubkey = Bitcoin::Script.drop_signatures(script_pubkey, drop_sigs) if drop_sigs # array of signature to drop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">            #p Bitcoin::Script.new(script_pubkey).to_string</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="121">
          <span class="hits">123</span>
          
          <code class="ruby">            input.to_payload(script_pubkey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="123">
          <span class="hits">16</span>
          
          <code class="ruby">            case hash_type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">            when SIGHASH_TYPE[:none]; input.to_payload(&quot;&quot;, &quot;\x00\x00\x00\x00&quot;)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="125">
          <span class="hits">16</span>
          
          <code class="ruby">            else;                     input.to_payload(&quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        }.join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="130">
          <span class="hits">123</span>
          
          <code class="ruby">        pout = @out.map(&amp;:to_payload).join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="132">
          <span class="hits">123</span>
          
          <code class="ruby">        case hash_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">        when SIGHASH_TYPE[:none]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">          pout = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">          in_size, out_size = Protocol.pack_var_int(@in.size), Protocol.pack_var_int(0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="137">
          <span class="hits">123</span>
          
          <code class="ruby">          in_size, out_size = Protocol.pack_var_int(@in.size), Protocol.pack_var_int(@out.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="140">
          <span class="hits">123</span>
          
          <code class="ruby">        buf = [ [@ver].pack(&quot;I&quot;), in_size, pin, out_size, pout, [@lock_time, hash_type].pack(&quot;II&quot;) ].join</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="141">
          <span class="hits">123</span>
          
          <code class="ruby">        Digest::SHA256.digest( Digest::SHA256.digest( buf ) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      # verify input signature +in_idx+ against the corresponding</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      # output in +outpoint_tx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">      def verify_input_signature(in_idx, outpoint_tx)</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="147">
          <span class="hits">74</span>
          
          <code class="ruby">        outpoint_idx  = @in[in_idx].prev_out_index</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="148">
          <span class="hits">74</span>
          
          <code class="ruby">        script_sig    = @in[in_idx].script_sig</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="149">
          <span class="hits">74</span>
          
          <code class="ruby">        script_pubkey = outpoint_tx.out[outpoint_idx].pk_script</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="150">
          <span class="hits">74</span>
          
          <code class="ruby">        script        = script_sig + script_pubkey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="152">
          <span class="hits">74</span>
          
          <code class="ruby">        Bitcoin::Script.new(script).run do |pubkey,sig,hash_type,drop_sigs,script|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">          # this IS the checksig callback, must return true/false</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="154">
          <span class="hits">78</span>
          
          <code class="ruby">          hash = signature_hash_for_input(in_idx, outpoint_tx, nil, hash_type, drop_sigs, script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">          #hash = signature_hash_for_input(in_idx, nil, script_pubkey, hash_type, drop_sigs, script)</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="156">
          <span class="hits">78</span>
          
          <code class="ruby">          Bitcoin.verify_signature( hash, sig, pubkey.unpack(&quot;H*&quot;)[0] )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      # convert to ruby hash (see also #from_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash</code>
        </li>
      
        <li class="covered" data-hits="146" data-linenumber="162">
          <span class="hits">146</span>
          
          <code class="ruby">        @hash ||= hash_from_payload(to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">          'hash' =&gt; @hash, 'ver' =&gt; @ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">          'vin_sz' =&gt; @in.size, 'vout_sz' =&gt; @out.size,</code>
        </li>
      
        <li class="covered" data-hits="146" data-linenumber="166">
          <span class="hits">146</span>
          
          <code class="ruby">          'lock_time' =&gt; @lock_time, 'size' =&gt; (@payload ||= to_payload).bytesize,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">          'in'  =&gt;  @in.map(&amp;:to_hash),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">          'out' =&gt; @out.map(&amp;:to_hash)</code>
        </li>
      
        <li class="covered" data-hits="146" data-linenumber="169">
          <span class="hits">146</span>
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">      # generates rawblock json as seen in the block explorer.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_json(options = {:space =&gt; ''}, *a)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="174">
          <span class="hits">10</span>
          
          <code class="ruby">        JSON.pretty_generate( to_hash, options )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">      # write json representation to a file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      # (see also #to_json)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_json_file(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">        File.open(path, 'wb'){|f| f.print to_json; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      # parse ruby hash (see also #to_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash(h)</code>
        </li>
      
        <li class="covered" data-hits="319" data-linenumber="185">
          <span class="hits">319</span>
          
          <code class="ruby">        tx = new(nil)</code>
        </li>
      
        <li class="covered" data-hits="319" data-linenumber="186">
          <span class="hits">319</span>
          
          <code class="ruby">        tx.ver, tx.lock_time = *h.values_at('ver', 'lock_time')</code>
        </li>
      
        <li class="covered" data-hits="1011" data-linenumber="187">
          <span class="hits">1011</span>
          
          <code class="ruby">        h['in'] .each{|input|   tx.add_in  TxIn.from_hash(input)   }</code>
        </li>
      
        <li class="covered" data-hits="1712" data-linenumber="188">
          <span class="hits">1712</span>
          
          <code class="ruby">        h['out'].each{|output|  tx.add_out TxOut.from_hash(output) }</code>
        </li>
      
        <li class="covered" data-hits="638" data-linenumber="189">
          <span class="hits">638</span>
          
          <code class="ruby">        tx.instance_eval{ @hash = hash_from_payload(@payload = to_payload) }</code>
        </li>
      
        <li class="covered" data-hits="319" data-linenumber="190">
          <span class="hits">319</span>
          
          <code class="ruby">        tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      # convert ruby hash to raw binary</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="194">
          <span class="hits">4</span>
          
          <code class="ruby">      def self.binary_from_hash(h); from_hash(h).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      # parse json representation</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="197">
          <span class="hits">25</span>
          
          <code class="ruby">      def self.from_json(json_string); from_hash( JSON.load(json_string) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      # convert json representation to raw binary</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="200">
          <span class="hits">2</span>
          
          <code class="ruby">      def self.binary_from_json(json_string); from_json(json_string).to_payload; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      # read binary block from a file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_file(path); new( Bitcoin::Protocol.read_binary_file(path) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      # read json block from a file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_json_file(path); from_json( Bitcoin::Protocol.read_binary_file(path) ); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">      def validator(store, block = nil)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="209">
          <span class="hits">35</span>
          
          <code class="ruby">        @validator ||= Bitcoin::Validation::Tx.new(self, store, block)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="212">
          <span class="hits">3</span>
          
          <code class="ruby">      def minimum_relay_fee; calculate_minimum_fee(1_000, true, :relay); end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="213">
          <span class="hits">3</span>
          
          <code class="ruby">      def minimum_block_fee; calculate_minimum_fee(1_000, true, :block); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">      def calculate_minimum_fee(block_size=1, allow_free=true, mode=:block)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="216">
          <span class="hits">4</span>
          
          <code class="ruby">        base_fee       = (mode == :relay) ? Bitcoin::MIN_RELAY_TX_FEE : Bitcoin::MIN_TX_FEE</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="217">
          <span class="hits">4</span>
          
          <code class="ruby">        tx_size        = to_payload.bytesize</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="218">
          <span class="hits">4</span>
          
          <code class="ruby">        new_block_size = block_size + tx_size</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="219">
          <span class="hits">4</span>
          
          <code class="ruby">        min_fee       = (1 + tx_size / 1_000) * base_fee</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="221">
          <span class="hits">4</span>
          
          <code class="ruby">        if allow_free</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="222">
          <span class="hits">4</span>
          
          <code class="ruby">          if block_size == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">            min_fee = 0 if tx_size &lt; 10_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="225">
          <span class="hits">4</span>
          
          <code class="ruby">            min_fee = 0 if new_block_size &lt; 27_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="229">
          <span class="hits">4</span>
          
          <code class="ruby">        if min_fee &lt; base_fee</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="230">
          <span class="hits">10</span>
          
          <code class="ruby">          outputs.each{|output| (min_fee = base_fee; break) if output.value &lt; Bitcoin::CENT }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="233">
          <span class="hits">4</span>
          
          <code class="ruby">        if block_size != 1 &amp;&amp; new_block_size &gt;= (Bitcoin::MAX_BLOCK_SIZE_GEN/2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">          #return Bitcoin::MAX_MONEY if new_block_size &gt;= Bitcoin::MAX_BLOCK_SIZE_GEN</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">          min_fee *= Bitcoin::MAX_BLOCK_SIZE_GEN / (Bitcoin::MAX_BLOCK_SIZE_GEN - new_block_size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="238">
          <span class="hits">4</span>
          
          <code class="ruby">        min_fee = Bitcoin::MAX_MONEY unless min_fee.between?(0, Bitcoin::MAX_MONEY)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="239">
          <span class="hits">4</span>
          
          <code class="ruby">        min_fee</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1535735601f850f0edb630e497ee3ca0f6253a95">
  <div class="header">
    <h3>lib/bitcoin/protocol/txin.rb</h3>
    <h4><span class="green">97.96 %</span> covered</h4>
    <div>
      <b>49</b> relevant lines. 
      <span class="green"><b>48</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxIn</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      # previous output hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :prev_out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      # previous output index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :prev_out_index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # script_sig input Script (signature)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :script_sig, :script_sig_length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # sequence</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :sequence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      DEFAULT_SEQUENCE = &quot;\xff\xff\xff\xff&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        @prev_out, @prev_out_index, @script_sig_length,</code>
        </li>
      
        <li class="covered" data-hits="1804" data-linenumber="22">
          <span class="hits">1804</span>
          
          <code class="ruby">        @script_sig, @sequence = *args</code>
        </li>
      
        <li class="covered" data-hits="1804" data-linenumber="23">
          <span class="hits">1804</span>
          
          <code class="ruby">        @sequence ||= DEFAULT_SEQUENCE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # compare to another txout</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        @prev_out == other.prev_out &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">          @prev_out_index == other.prev_out_index &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">          @script_sig == other.script_sig &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">          @sequence == other.sequence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      # parse raw binary data for transaction input</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="999" data-linenumber="36">
          <span class="hits">999</span>
          
          <code class="ruby">        idx = 0</code>
        </li>
      
        <li class="covered" data-hits="999" data-linenumber="37">
          <span class="hits">999</span>
          
          <code class="ruby">        @prev_out, @prev_out_index = data[idx...idx+=36].unpack(&quot;a32I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="999" data-linenumber="38">
          <span class="hits">999</span>
          
          <code class="ruby">        @script_sig_length, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="998" data-linenumber="39">
          <span class="hits">998</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize - tmp.bytesize</code>
        </li>
      
        <li class="covered" data-hits="998" data-linenumber="40">
          <span class="hits">998</span>
          
          <code class="ruby">        @script_sig = data[idx...idx+=@script_sig_length]</code>
        </li>
      
        <li class="covered" data-hits="998" data-linenumber="41">
          <span class="hits">998</span>
          
          <code class="ruby">        @sequence = data[idx...idx+=4]</code>
        </li>
      
        <li class="covered" data-hits="998" data-linenumber="42">
          <span class="hits">998</span>
          
          <code class="ruby">        idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :parse_payload :parse_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload(script=@script_sig, sequence=@sequence)</code>
        </li>
      
        <li class="covered" data-hits="3563" data-linenumber="48">
          <span class="hits">3563</span>
          
          <code class="ruby">        buf =  [ @prev_out, @prev_out_index ].pack(&quot;a32I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3563" data-linenumber="49">
          <span class="hits">3563</span>
          
          <code class="ruby">        buf &lt;&lt; Protocol.pack_var_int(script.bytesize)</code>
        </li>
      
        <li class="covered" data-hits="3563" data-linenumber="50">
          <span class="hits">3563</span>
          
          <code class="ruby">        buf &lt;&lt; script if script.bytesize &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="3563" data-linenumber="51">
          <span class="hits">3563</span>
          
          <code class="ruby">        buf &lt;&lt; (sequence || DEFAULT_SEQUENCE)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="55">
          <span class="hits">198</span>
          
          <code class="ruby">        t = { 'prev_out'  =&gt; { 'hash' =&gt; @prev_out.reverse_hth, 'n' =&gt; @prev_out_index } }</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="56">
          <span class="hits">198</span>
          
          <code class="ruby">        if coinbase?</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="57">
          <span class="hits">21</span>
          
          <code class="ruby">          t['coinbase']  = @script_sig.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        else # coinbase tx</code>
        </li>
      
        <li class="covered" data-hits="177" data-linenumber="59">
          <span class="hits">177</span>
          
          <code class="ruby">          t['scriptSig'] = Bitcoin::Script.new(@script_sig).to_string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="61">
          <span class="hits">198</span>
          
          <code class="ruby">        t['sequence']  = @sequence.unpack(&quot;I&quot;)[0] unless @sequence == &quot;\xff\xff\xff\xff&quot;</code>
        </li>
      
        <li class="covered" data-hits="198" data-linenumber="62">
          <span class="hits">198</span>
          
          <code class="ruby">        t</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash(input)</code>
        </li>
      
        <li class="covered" data-hits="692" data-linenumber="66">
          <span class="hits">692</span>
          
          <code class="ruby">        txin = TxIn.new([ input['prev_out']['hash'] ].pack('H*').reverse, input['prev_out']['n'])</code>
        </li>
      
        <li class="covered" data-hits="692" data-linenumber="67">
          <span class="hits">692</span>
          
          <code class="ruby">        if input['coinbase']</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="68">
          <span class="hits">12</span>
          
          <code class="ruby">          txin.script_sig = [ input['coinbase'] ].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="680" data-linenumber="70">
          <span class="hits">680</span>
          
          <code class="ruby">          txin.script_sig = Script.binary_from_string(input['scriptSig'])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="692" data-linenumber="72">
          <span class="hits">692</span>
          
          <code class="ruby">        txin.sequence = [ input['sequence'] || 0xffffffff ].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="692" data-linenumber="73">
          <span class="hits">692</span>
          
          <code class="ruby">        txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      # previous output in hex</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">      def previous_output</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        @prev_out.reverse_hth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      # check if input is coinbase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">      def coinbase?</code>
        </li>
      
        <li class="covered" data-hits="1132" data-linenumber="83">
          <span class="hits">1132</span>
          
          <code class="ruby">        (@prev_out_index == 4294967295) &amp;&amp; (@prev_out == &quot;\x00&quot;*32)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      # set script_sig and script_sig_length</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">      def script_sig=(script_sig)</code>
        </li>
      
        <li class="covered" data-hits="1844" data-linenumber="88">
          <span class="hits">1844</span>
          
          <code class="ruby">        @script_sig_length = script_sig.bytesize</code>
        </li>
      
        <li class="covered" data-hits="1844" data-linenumber="89">
          <span class="hits">1844</span>
          
          <code class="ruby">        @script_sig = script_sig</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :script= :script_sig=</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="925463098a998a603cae90a61e90032defc0f861">
  <div class="header">
    <h3>lib/bitcoin/protocol/txout.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>40</b> relevant lines. 
      <span class="green"><b>40</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class TxOut</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      # output value (in base units; &quot;satoshi&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      # pk_script output Script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_accessor :pk_script, :pk_script_length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize *args</code>
        </li>
      
        <li class="covered" data-hits="3477" data-linenumber="13">
          <span class="hits">3477</span>
          
          <code class="ruby">        if args.size == 2</code>
        </li>
      
        <li class="covered" data-hits="1397" data-linenumber="14">
          <span class="hits">1397</span>
          
          <code class="ruby">          @value, @pk_script_length, @pk_script = args[0], args[1].bytesize, args[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="2080" data-linenumber="16">
          <span class="hits">2080</span>
          
          <code class="ruby">          @value, @pk_script_length, @pk_script = *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      def ==(other)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="21">
          <span class="hits">4</span>
          
          <code class="ruby">        @value == other.value &amp;&amp; @pk_script == other.pk_script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      # parse raw binary data for transaction output</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_data(data)</code>
        </li>
      
        <li class="covered" data-hits="1957" data-linenumber="26">
          <span class="hits">1957</span>
          
          <code class="ruby">        idx = 0</code>
        </li>
      
        <li class="covered" data-hits="1957" data-linenumber="27">
          <span class="hits">1957</span>
          
          <code class="ruby">        @value = data[idx...idx+=8].unpack(&quot;Q&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="1957" data-linenumber="28">
          <span class="hits">1957</span>
          
          <code class="ruby">        @pk_script_length, tmp = Protocol.unpack_var_int(data[idx..-1])</code>
        </li>
      
        <li class="covered" data-hits="1957" data-linenumber="29">
          <span class="hits">1957</span>
          
          <code class="ruby">        idx += data[idx..-1].bytesize - tmp.bytesize</code>
        </li>
      
        <li class="covered" data-hits="1957" data-linenumber="30">
          <span class="hits">1957</span>
          
          <code class="ruby">        @pk_script = data[idx...idx+=@pk_script_length]</code>
        </li>
      
        <li class="covered" data-hits="1957" data-linenumber="31">
          <span class="hits">1957</span>
          
          <code class="ruby">        idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :parse_payload :parse_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="6184" data-linenumber="37">
          <span class="hits">6184</span>
          
          <code class="ruby">        buf =  [ @value ].pack(&quot;Q&quot;)</code>
        </li>
      
        <li class="covered" data-hits="6184" data-linenumber="38">
          <span class="hits">6184</span>
          
          <code class="ruby">        buf &lt;&lt; Protocol.pack_var_int(@pk_script_length)</code>
        </li>
      
        <li class="covered" data-hits="6184" data-linenumber="39">
          <span class="hits">6184</span>
          
          <code class="ruby">        buf &lt;&lt; @pk_script if @pk_script_length &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="6184" data-linenumber="40">
          <span class="hits">6184</span>
          
          <code class="ruby">        buf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_hash</code>
        </li>
      
        <li class="covered" data-hits="659" data-linenumber="44">
          <span class="hits">659</span>
          
          <code class="ruby">        { 'value' =&gt; &quot;%.8f&quot; % (@value / 100000000.0),</code>
        </li>
      
        <li class="covered" data-hits="659" data-linenumber="45">
          <span class="hits">659</span>
          
          <code class="ruby">          'scriptPubKey' =&gt; Bitcoin::Script.new(@pk_script).to_string }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.from_hash(output)</code>
        </li>
      
        <li class="covered" data-hits="1393" data-linenumber="49">
          <span class="hits">1393</span>
          
          <code class="ruby">        amount = output['value'].gsub('.','').to_i</code>
        </li>
      
        <li class="covered" data-hits="1393" data-linenumber="50">
          <span class="hits">1393</span>
          
          <code class="ruby">        script = Script.binary_from_string(output['scriptPubKey'])</code>
        </li>
      
        <li class="covered" data-hits="1393" data-linenumber="51">
          <span class="hits">1393</span>
          
          <code class="ruby">        new(amount, script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      # set pk_script and pk_script_length</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">      def pk_script=(script)</code>
        </li>
      
        <li class="covered" data-hits="1200" data-linenumber="55">
          <span class="hits">1200</span>
          
          <code class="ruby">        @pk_script_length, @pk_script = script.bytesize, script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :amount   :value</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :amount=  :value=</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :script   :pk_script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">      alias :script=  :pk_script=</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      # create output spending +value+ btc (base units) to +address+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.value_to_address(value, address)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="66">
          <span class="hits">2</span>
          
          <code class="ruby">        pk_script = Bitcoin::Script.to_address_script(address)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="67">
          <span class="hits">2</span>
          
          <code class="ruby">        new(value, pk_script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="64138ab3345824464f68bf4ae98e60bd0dbb4ca8">
  <div class="header">
    <h3>lib/bitcoin/protocol/version.rb</h3>
    <h4><span class="green">96.77 %</span> covered</h4>
    <div>
      <b>31</b> relevant lines. 
      <span class="green"><b>30</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Protocol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    class Version</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :fields</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(opts={})</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="7">
          <span class="hits">4</span>
          
          <code class="ruby">        @fields = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">          :version    =&gt; Bitcoin::Protocol::VERSION,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">          :services   =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">          :time       =&gt; Time.now.tv_sec,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">          :from       =&gt; &quot;127.0.0.1:8333&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">          :to         =&gt; &quot;127.0.0.1:8333&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">          :nonce      =&gt; Bitcoin::Protocol::Uniq,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">          :user_agent =&gt; &quot;/bitcoin-ruby:#{Bitcoin::VERSION}/&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">          :last_block =&gt; 0 # 188617</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="16">
          <span class="hits">5</span>
          
          <code class="ruby">        }.merge( opts.reject{|k,v| v == nil } )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">        payload = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">          @fields.values_at(:version, :services, :time).pack(&quot;IQQ&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          pack_address_field(@fields[:from]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">          pack_address_field(@fields[:to]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          @fields.values_at(:nonce).pack(&quot;Q&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">          Protocol.pack_var_string(@fields[:user_agent]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">          @fields.values_at(:last_block).pack(&quot;I&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        ].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_pkt</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">        Bitcoin::Protocol.pkt(&quot;version&quot;, to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="35">
          <span class="hits">3</span>
          
          <code class="ruby">        version, services, timestamp, to, from, nonce, payload = payload.unpack(&quot;Ia8Qa26a26Qa*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="36">
          <span class="hits">3</span>
          
          <code class="ruby">        to, from = unpack_address_field(to), unpack_address_field(from)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="37">
          <span class="hits">3</span>
          
          <code class="ruby">        user_agent, payload = Protocol.unpack_var_string(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="38">
          <span class="hits">3</span>
          
          <code class="ruby">        last_block = payload.unpack(&quot;I&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="40">
          <span class="hits">3</span>
          
          <code class="ruby">        @fields = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">         :version =&gt; version, :services =&gt; services, :time =&gt; timestamp,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">         :from =&gt; from, :to =&gt; to, :nonce =&gt; nonce,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">         :user_agent =&gt; user_agent.to_s, :last_block =&gt; last_block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="45">
          <span class="hits">3</span>
          
          <code class="ruby">        self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">      def unpack_address_field(payload)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="49">
          <span class="hits">6</span>
          
          <code class="ruby">        ip, port = payload.unpack(&quot;x8x12a4n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="50">
          <span class="hits">6</span>
          
          <code class="ruby">        &quot;#{ip.unpack(&quot;C*&quot;).join(&quot;.&quot;)}:#{port}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      def pack_address_field(addr_str)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="54">
          <span class="hits">2</span>
          
          <code class="ruby">        host, port = addr_str.split(&quot;:&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="55">
          <span class="hits">2</span>
          
          <code class="ruby">        port = port ? port.to_i : 8333</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="56">
          <span class="hits">2</span>
          
          <code class="ruby">        sockaddr = Socket.pack_sockaddr_in(port, host)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        #raise &quot;invalid IPv4 Address: #{addr}&quot; unless sockaddr[0...2] == &quot;\x02\x00&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="58">
          <span class="hits">2</span>
          
          <code class="ruby">        port, host = sockaddr[2...4], sockaddr[4...8]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">        [[1].pack(&quot;Q&quot;), &quot;\x00&quot;*10, &quot;\xFF\xFF&quot;,  host, port].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      def uptime</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        @fields[:time] - Time.now.tv_sec</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      def method_missing(*a); @fields[a.first]  or super(*a); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="68">
          <span class="hits">4</span>
          
          <code class="ruby">      def self.parse(payload); new.parse(payload); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="9997f171293226ec441ccaa33d726c508ff07a39">
  <div class="header">
    <h3>lib/bitcoin/script.rb</h3>
    <h4><span class="green">96.26 %</span> covered</h4>
    <div>
      <b>348</b> relevant lines. 
      <span class="green"><b>335</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'bitcoin'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Bitcoin::Script</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_1           = 81</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_TRUE        = 81</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_0           = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_FALSE       = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_PUSHDATA1   = 76</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_PUSHDATA2   = 77</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_PUSHDATA4   = 78</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP         = 97</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_DUP         = 118</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_HASH160     = 169</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_EQUAL       = 135</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_VERIFY      = 105</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_EQUALVERIFY = 136</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CHECKSIG    = 172</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CHECKSIGVERIFY      = 173</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CHECKMULTISIG       = 174</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CHECKMULTISIGVERIFY = 175</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_TOALTSTACK   = 107</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_FROMALTSTACK = 108</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_TUCK         = 125</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_SWAP         = 124</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_BOOLAND      = 154</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_ADD          = 147</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_SUB          = 148</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_GREATERTHANOREQUAL = 162</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_DROP         = 117</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_HASH256      = 170</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_SHA256       = 168</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_SHA1         = 167</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_RIPEMD160    = 166</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_EVAL         = 176</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_NOP2         = 177</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CHECKHASHVERIFY = 177</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_CODESEPARATOR = 171</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_MIN          = 163</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_MAX          = 164</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_2OVER        = 112</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_2SWAP        = 114</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_IFDUP        = 115</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_DEPTH        = 116</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_1NEGATE      = 79</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # OP_IF           = 99</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  # OP_NOTIF        = 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  # OP_ELSE         = 103</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  # OP_ENDIF        = 104</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="51">
          <span class="hits">42</span>
          
          <code class="ruby">  OPCODES = Hash[*constants.grep(/^OP_/).map{|i| [const_get(i), i.to_s] }.flatten]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES[0] = &quot;0&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES[81] = &quot;1&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES_ALIAS = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    &quot;OP_TRUE&quot;  =&gt; OP_1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    &quot;OP_FALSE&quot; =&gt; OP_0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    &quot;OP_NOP1&quot; =&gt; OP_EVAL,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    &quot;OP_NOP2&quot; =&gt; OP_CHECKHASHVERIFY</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  OP_2_16 = (82..96).to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_reader :raw, :chunks, :debug</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  # create a new script. +bytes+ is typically input_script + output_script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(bytes, offset=0)</code>
        </li>
      
        <li class="covered" data-hits="1620" data-linenumber="68">
          <span class="hits">1620</span>
          
          <code class="ruby">    @raw = bytes</code>
        </li>
      
        <li class="covered" data-hits="1620" data-linenumber="69">
          <span class="hits">1620</span>
          
          <code class="ruby">    @stack, @stack_alt = [], []</code>
        </li>
      
        <li class="covered" data-hits="1620" data-linenumber="70">
          <span class="hits">1620</span>
          
          <code class="ruby">    @chunks = parse(bytes, offset)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  # parse raw script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse(bytes, offset=0)</code>
        </li>
      
        <li class="covered" data-hits="1620" data-linenumber="75">
          <span class="hits">1620</span>
          
          <code class="ruby">    program = bytes.unpack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1620" data-linenumber="76">
          <span class="hits">1620</span>
          
          <code class="ruby">    chunks = []</code>
        </li>
      
        <li class="covered" data-hits="1620" data-linenumber="77">
          <span class="hits">1620</span>
          
          <code class="ruby">    until program.empty?</code>
        </li>
      
        <li class="covered" data-hits="6862" data-linenumber="78">
          <span class="hits">6862</span>
          
          <code class="ruby">      opcode = program.shift(1)[0]</code>
        </li>
      
        <li class="covered" data-hits="6862" data-linenumber="79">
          <span class="hits">6862</span>
          
          <code class="ruby">      if opcode &gt;= 0xf0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        opcode = (opcode &lt;&lt; 8) | program.shift(1)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6862" data-linenumber="83">
          <span class="hits">6862</span>
          
          <code class="ruby">      if (opcode &gt; 0) &amp;&amp; (opcode &lt; OP_PUSHDATA1)</code>
        </li>
      
        <li class="covered" data-hits="2065" data-linenumber="84">
          <span class="hits">2065</span>
          
          <code class="ruby">        len = opcode</code>
        </li>
      
        <li class="covered" data-hits="2065" data-linenumber="85">
          <span class="hits">2065</span>
          
          <code class="ruby">        chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="4797" data-linenumber="86">
          <span class="hits">4797</span>
          
          <code class="ruby">      elsif (opcode == OP_PUSHDATA1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">        len = program.shift(1)[0]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">        chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="4796" data-linenumber="89">
          <span class="hits">4796</span>
          
          <code class="ruby">      elsif (opcode == OP_PUSHDATA2)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="90">
          <span class="hits">7</span>
          
          <code class="ruby">        len = program.shift(2).pack(&quot;C*&quot;).unpack(&quot;n&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="91">
          <span class="hits">7</span>
          
          <code class="ruby">        chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="4789" data-linenumber="92">
          <span class="hits">4789</span>
          
          <code class="ruby">      elsif (opcode == OP_PUSHDATA4)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        len = program.shift(4).pack(&quot;C*&quot;).unpack(&quot;N&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        chunks &lt;&lt; program.shift(len).pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="4789" data-linenumber="96">
          <span class="hits">4789</span>
          
          <code class="ruby">        chunks &lt;&lt; opcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1620" data-linenumber="99">
          <span class="hits">1620</span>
          
          <code class="ruby">    chunks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  # string representation of the script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_string(chunks=nil)</code>
        </li>
      
        <li class="covered" data-hits="884" data-linenumber="104">
          <span class="hits">884</span>
          
          <code class="ruby">    (chunks || @chunks).map{|i|</code>
        </li>
      
        <li class="covered" data-hits="3822" data-linenumber="105">
          <span class="hits">3822</span>
          
          <code class="ruby">      case i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      when Fixnum</code>
        </li>
      
        <li class="covered" data-hits="2711" data-linenumber="107">
          <span class="hits">2711</span>
          
          <code class="ruby">        case i</code>
        </li>
      
        <li class="covered" data-hits="2684" data-linenumber="108">
          <span class="hits">2684</span>
          
          <code class="ruby">        when *OPCODES.keys;          OPCODES[i]</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="109">
          <span class="hits">26</span>
          
          <code class="ruby">        when *OP_2_16;               (OP_2_16.index(i)+2).to_s</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">        else &quot;(opcode #{i})&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">      when String</code>
        </li>
      
        <li class="covered" data-hits="1111" data-linenumber="113">
          <span class="hits">1111</span>
          
          <code class="ruby">        i.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    }.join(&quot; &quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_binary(chunks=nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="119">
          <span class="hits">5</span>
          
          <code class="ruby">    (chunks || @chunks).map{|chunk|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="120">
          <span class="hits">6</span>
          
          <code class="ruby">      case chunk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      when Fixnum; [chunk].pack(&quot;C*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="122">
          <span class="hits">6</span>
          
          <code class="ruby">      when String; self.class.pack_pushdata(chunk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    }.join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">  alias :to_payload :to_binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.pack_pushdata(data)</code>
        </li>
      
        <li class="covered" data-hits="2994" data-linenumber="129">
          <span class="hits">2994</span>
          
          <code class="ruby">    size = data.bytesize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2994" data-linenumber="131">
          <span class="hits">2994</span>
          
          <code class="ruby">    head = if size &lt; OP_PUSHDATA1</code>
        </li>
      
        <li class="covered" data-hits="2987" data-linenumber="132">
          <span class="hits">2987</span>
          
          <code class="ruby">             [size].pack(&quot;C&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">           elsif size &gt; OP_PUSHDATA1 &amp;&amp; size &lt;= 0xff</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">             [OP_PUSHDATA1, size].pack(&quot;CC&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">           elsif size &gt; 0xff &amp;&amp; size &lt;= 0xffff</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="136">
          <span class="hits">6</span>
          
          <code class="ruby">             [OP_PUSHDATA2, size].pack(&quot;Cv&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">           elsif size &gt; 0xffff &amp;&amp; size &lt;= 0xffffffff</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">             [OP_PUSHDATA4, size].pack(&quot;CV&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">           end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2994" data-linenumber="141">
          <span class="hits">2994</span>
          
          <code class="ruby">    head + data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  # script object of a string representation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.from_string(script_string)</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="146">
          <span class="hits">60</span>
          
          <code class="ruby">    new(binary_from_string(script_string))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">  class ScriptOpcodeError &lt; StandardError; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  # raw script binary of a string representation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.binary_from_string(script_string)</code>
        </li>
      
        <li class="covered" data-hits="2176" data-linenumber="153">
          <span class="hits">2176</span>
          
          <code class="ruby">    script_string.split(&quot; &quot;).map{|i|</code>
        </li>
      
        <li class="covered" data-hits="8816" data-linenumber="154">
          <span class="hits">8816</span>
          
          <code class="ruby">      case i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      when /^OP_PUSHDATA[124]$/;     # skip</code>
        </li>
      
        <li class="covered" data-hits="60653" data-linenumber="156">
          <span class="hits">60653</span>
          
          <code class="ruby">      when *OPCODES.values;          OPCODES.find{|k,v| v == i }.first</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="157">
          <span class="hits">36</span>
          
          <code class="ruby">      when *OPCODES_ALIAS.keys;      OPCODES_ALIAS.find{|k,v| k == i }.last</code>
        </li>
      
        <li class="covered" data-hits="86" data-linenumber="158">
          <span class="hits">86</span>
          
          <code class="ruby">      when /^([2-9]|1[0-6])$/;       OP_2_16[$1.to_i-2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">      when /\(opcode (\d+)\)/;       $1.to_i</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">      when /OP_(.+)$/;               raise ScriptOpcodeError, &quot;#{i} not defined!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      else </code>
        </li>
      
        <li class="covered" data-hits="2988" data-linenumber="162">
          <span class="hits">2988</span>
          
          <code class="ruby">        data = [i].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2988" data-linenumber="163">
          <span class="hits">2988</span>
          
          <code class="ruby">        pack_pushdata(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    }.map{|i|</code>
        </li>
      
        <li class="covered" data-hits="8814" data-linenumber="166">
          <span class="hits">8814</span>
          
          <code class="ruby">      i.is_a?(Fixnum) ? [i].pack(&quot;C*&quot;) : i # TODO yikes, implement/pack 2 byte opcodes.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    }.join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">  def invalid?</code>
        </li>
      
        <li class="covered" data-hits="748" data-linenumber="171">
          <span class="hits">748</span>
          
          <code class="ruby">    @script_invalid ||= false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  # run the script. +check_callback+ is called for OP_CHECKSIG operations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">  def run(&amp;check_callback)</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="176">
          <span class="hits">113</span>
          
          <code class="ruby">    return pay_to_script_hash(check_callback)  if is_p2sh?</code>
        </li>
      
        <li class="covered" data-hits="107" data-linenumber="177">
          <span class="hits">107</span>
          
          <code class="ruby">    @debug = []</code>
        </li>
      
        <li class="covered" data-hits="107" data-linenumber="178">
          <span class="hits">107</span>
          
          <code class="ruby">    @chunks.each{|chunk|</code>
        </li>
      
        <li class="covered" data-hits="746" data-linenumber="179">
          <span class="hits">746</span>
          
          <code class="ruby">      break if invalid?</code>
        </li>
      
        <li class="covered" data-hits="2556" data-linenumber="180">
          <span class="hits">2556</span>
          
          <code class="ruby">      @debug &lt;&lt; @stack.map{|i| i.unpack(&quot;H*&quot;) rescue i}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="covered" data-hits="743" data-linenumber="182">
          <span class="hits">743</span>
          
          <code class="ruby">      case chunk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      when Fixnum</code>
        </li>
      
        <li class="covered" data-hits="411" data-linenumber="184">
          <span class="hits">411</span>
          
          <code class="ruby">        case chunk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        when *OPCODES_METHOD.keys</code>
        </li>
      
        <li class="covered" data-hits="369" data-linenumber="187">
          <span class="hits">369</span>
          
          <code class="ruby">          m = method( n=OPCODES_METHOD[chunk] )</code>
        </li>
      
        <li class="covered" data-hits="369" data-linenumber="188">
          <span class="hits">369</span>
          
          <code class="ruby">          @debug &lt;&lt; n.to_s.upcase</code>
        </li>
      
        <li class="covered" data-hits="369" data-linenumber="189">
          <span class="hits">369</span>
          
          <code class="ruby">          (m.arity == 1) ? m.call(check_callback) : m.call  # invoke opcode method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        when *OP_2_16</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="192">
          <span class="hits">42</span>
          
          <code class="ruby">          @stack &lt;&lt; OP_2_16.index(chunk) + 2</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="193">
          <span class="hits">42</span>
          
          <code class="ruby">          @debug &lt;&lt; &quot;OP_#{chunk-80}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">          name = OPCODES[chunk] || chunk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">          raise &quot;opcode #{name} unkown or not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      when String</code>
        </li>
      
        <li class="covered" data-hits="332" data-linenumber="199">
          <span class="hits">332</span>
          
          <code class="ruby">        @debug &lt;&lt; &quot;PUSH DATA #{chunk.unpack(&quot;H*&quot;)[0]}&quot;</code>
        </li>
      
        <li class="covered" data-hits="332" data-linenumber="200">
          <span class="hits">332</span>
          
          <code class="ruby">        @stack &lt;&lt; chunk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="250" data-linenumber="203">
          <span class="hits">250</span>
          
          <code class="ruby">    @debug &lt;&lt; @stack.map{|i| i.unpack(&quot;H*&quot;) rescue i }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="107" data-linenumber="205">
          <span class="hits">107</span>
          
          <code class="ruby">    if @script_invalid</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="206">
          <span class="hits">12</span>
          
          <code class="ruby">      @stack &lt;&lt; 0</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="207">
          <span class="hits">12</span>
          
          <code class="ruby">      @debug &lt;&lt; &quot;INVALID TRANSACTION&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="107" data-linenumber="210">
          <span class="hits">107</span>
          
          <code class="ruby">    @debug &lt;&lt; &quot;RESULT&quot;</code>
        </li>
      
        <li class="covered" data-hits="107" data-linenumber="211">
          <span class="hits">107</span>
          
          <code class="ruby">    return false if @stack.empty?</code>
        </li>
      
        <li class="covered" data-hits="107" data-linenumber="212">
          <span class="hits">107</span>
          
          <code class="ruby">    return false if @stack.pop == 0</code>
        </li>
      
        <li class="covered" data-hits="92" data-linenumber="213">
          <span class="hits">92</span>
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">  def invalid</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="217">
          <span class="hits">11</span>
          
          <code class="ruby">    @script_invalid = true; nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">  def codehash_script(opcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">    # CScript scriptCode(pbegincodehash, pend);</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="222">
          <span class="hits">7</span>
          
          <code class="ruby">    script    = to_string(@chunks[(@codehash_start||0)...@chunks.size-@chunks.reverse.index(opcode)])</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="223">
          <span class="hits">7</span>
          
          <code class="ruby">    checkhash = Bitcoin.hash160(Bitcoin::Script.binary_from_string(script).unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="224">
          <span class="hits">7</span>
          
          <code class="ruby">    [script, checkhash]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.drop_signatures(script_pubkey, drop_signatures)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="228">
          <span class="hits">71</span>
          
          <code class="ruby">    script = new(script_pubkey).to_string.split(&quot; &quot;).delete_if{|c| drop_signatures.include?(c) }.join(&quot; &quot;)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="229">
          <span class="hits">10</span>
          
          <code class="ruby">    script_pubkey = binary_from_string(script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">  # pay_to_script_hash: https://en.bitcoin.it/wiki/BIP_0016</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">  # &lt;sig&gt; {&lt;pub&gt; OP_CHECKSIG} | OP_HASH160 &lt;script_hash&gt; OP_EQUAL</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">  def pay_to_script_hash(check_callback)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="236">
          <span class="hits">6</span>
          
          <code class="ruby">    return false if @chunks.size &lt; 4</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="237">
          <span class="hits">5</span>
          
          <code class="ruby">    *rest, script, _, script_hash, _ = @chunks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="239">
          <span class="hits">15</span>
          
          <code class="ruby">    return false unless [script, script_hash].all?{|i| i.is_a?(String) }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="240">
          <span class="hits">5</span>
          
          <code class="ruby">    return false unless Bitcoin.hash160(script.unpack(&quot;H*&quot;)[0]) == script_hash.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="241">
          <span class="hits">5</span>
          
          <code class="ruby">    rest.delete_at(0) if rest[0] == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="243">
          <span class="hits">5</span>
          
          <code class="ruby">    script = self.class.new(to_binary(rest) + script).inner_p2sh!</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="244">
          <span class="hits">5</span>
          
          <code class="ruby">    script.run(&amp;check_callback)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="247">
          <span class="hits">6</span>
          
          <code class="ruby">  def inner_p2sh!; @inner_p2sh = true; self; end</code>
        </li>
      
        <li class="covered" data-hits="93" data-linenumber="248">
          <span class="hits">93</span>
          
          <code class="ruby">  def inner_p2sh?; @inner_p2sh; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="250">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_pay_to_script_hash?</code>
        </li>
      
        <li class="covered" data-hits="119" data-linenumber="251">
          <span class="hits">119</span>
          
          <code class="ruby">    @chunks.size &gt;= 3 &amp;&amp; @chunks[-3] == OP_HASH160 &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">      @chunks[-2].bytesize == 20 &amp;&amp; @chunks[-1] == OP_EQUAL</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">  alias :is_p2sh? :is_pay_to_script_hash?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">  # check if script is in one of the recognized standard formats</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_standard?</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="258">
          <span class="hits">5</span>
          
          <code class="ruby">    is_pubkey? || is_hash160? || is_multisig? || is_p2sh?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">  # is this a pubkey tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="262">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_pubkey?</code>
        </li>
      
        <li class="covered" data-hits="926" data-linenumber="263">
          <span class="hits">926</span>
          
          <code class="ruby">    return false if @chunks.size != 2</code>
        </li>
      
        <li class="covered" data-hits="887" data-linenumber="264">
          <span class="hits">887</span>
          
          <code class="ruby">    (@chunks[1] == OP_CHECKSIG) &amp;&amp; @chunks[0].size &gt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">  alias :is_send_to_ip? :is_pubkey?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">  # is this a hash160 (address) tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="269">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_hash160?</code>
        </li>
      
        <li class="covered" data-hits="1643" data-linenumber="270">
          <span class="hits">1643</span>
          
          <code class="ruby">    return false  if @chunks.size != 5</code>
        </li>
      
        <li class="covered" data-hits="976" data-linenumber="271">
          <span class="hits">976</span>
          
          <code class="ruby">    (@chunks[0..1] + @chunks[-2..-1]) ==</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      [OP_DUP, OP_HASH160, OP_EQUALVERIFY, OP_CHECKSIG] &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="976" data-linenumber="273">
          <span class="hits">976</span>
          
          <code class="ruby">      @chunks[2].is_a?(String) &amp;&amp; @chunks[2].bytesize == 20</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">  # is this a multisig tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="277">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_multisig?</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="278">
          <span class="hits">19</span>
          
          <code class="ruby">    return false  if @chunks.size &gt; 6 || @chunks.size &lt; 4</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="279">
          <span class="hits">13</span>
          
          <code class="ruby">    @chunks[-1] == OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">  def type</code>
        </li>
      
        <li class="covered" data-hits="540" data-linenumber="283">
          <span class="hits">540</span>
          
          <code class="ruby">       if is_hash160?;   :hash160</code>
        </li>
      
        <li class="covered" data-hits="225" data-linenumber="284">
          <span class="hits">225</span>
          
          <code class="ruby">    elsif is_pubkey?;    :pubkey</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="285">
          <span class="hits">5</span>
          
          <code class="ruby">    elsif is_multisig?;  :multisig</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="286">
          <span class="hits">2</span>
          
          <code class="ruby">    elsif is_p2sh?;      :p2sh</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">    else;                :unknown</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">  # get the public key for this pubkey script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="292">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_pubkey</code>
        </li>
      
        <li class="covered" data-hits="224" data-linenumber="293">
          <span class="hits">224</span>
          
          <code class="ruby">    return @chunks[0].unpack(&quot;H*&quot;)[0] if @chunks.size == 1</code>
        </li>
      
        <li class="covered" data-hits="224" data-linenumber="294">
          <span class="hits">224</span>
          
          <code class="ruby">    is_pubkey? ? @chunks[0].unpack(&quot;H*&quot;)[0] : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">  # get the pubkey address for this pubkey script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="298">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_pubkey_address</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="299">
          <span class="hits">4</span>
          
          <code class="ruby">    Bitcoin.pubkey_to_address(get_pubkey)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">  # get the hash160 for this hash160 script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="303">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_hash160</code>
        </li>
      
        <li class="covered" data-hits="541" data-linenumber="304">
          <span class="hits">541</span>
          
          <code class="ruby">    return @chunks[2..-3][0].unpack(&quot;H*&quot;)[0]  if is_hash160?</code>
        </li>
      
        <li class="covered" data-hits="220" data-linenumber="305">
          <span class="hits">220</span>
          
          <code class="ruby">    return Bitcoin.hash160(get_pubkey)        if is_pubkey?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">  # get the hash160 address for this hash160 script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="309">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_hash160_address</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="310">
          <span class="hits">7</span>
          
          <code class="ruby">    Bitcoin.hash160_to_address(get_hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">  # get the public keys for this multisig script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="314">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_multisig_pubkeys</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="315">
          <span class="hits">32</span>
          
          <code class="ruby">    1.upto(@chunks[-2] - 80).map {|i| @chunks[i]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">  # get the pubkey addresses for this multisig script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_multisig_addresses</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="320">
          <span class="hits">21</span>
          
          <code class="ruby">    get_multisig_pubkeys.map {|p| Bitcoin::Key.new(nil, p.unpack(&quot;H*&quot;)[0]).addr}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">  # get all addresses this script corresponds to (if possible)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="324">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_addresses</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="325">
          <span class="hits">14</span>
          
          <code class="ruby">    return [get_pubkey_address]  if is_pubkey?</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="326">
          <span class="hits">11</span>
          
          <code class="ruby">    return [get_hash160_address] if is_hash160?</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="327">
          <span class="hits">5</span>
          
          <code class="ruby">    return get_multisig_addresses  if is_multisig?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  # get single address, or first for multisig script</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="331">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_address</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="332">
          <span class="hits">10</span>
          
          <code class="ruby">    addrs = get_addresses</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="333">
          <span class="hits">10</span>
          
          <code class="ruby">    addrs.is_a?(Array) ? addrs[0] : addrs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">  # generate pubkey tx script for given +pubkey+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="337">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_pubkey_script(pubkey)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="338">
          <span class="hits">3</span>
          
          <code class="ruby">    pk = [pubkey].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="339">
          <span class="hits">3</span>
          
          <code class="ruby">    [[pk.bytesize].pack(&quot;C&quot;), pk, &quot;\xAC&quot;].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">  # generate hash160 tx for given +address+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="343">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_hash160_script(hash160)</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="344">
          <span class="hits">138</span>
          
          <code class="ruby">    return nil  unless hash160</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">    #  DUP   HASH160  length  hash160    EQUALVERIFY  CHECKSIG</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="346">
          <span class="hits">138</span>
          
          <code class="ruby">    [ [&quot;76&quot;, &quot;a9&quot;,    &quot;14&quot;,   hash160,   &quot;88&quot;,        &quot;ac&quot;].join ].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="349">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_p2sh_script(p2sh)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="350">
          <span class="hits">3</span>
          
          <code class="ruby">    return nil  unless p2sh</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">    # HASH160  length  hash  EQUAL</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="352">
          <span class="hits">3</span>
          
          <code class="ruby">    [ [&quot;a9&quot;,   &quot;14&quot;,   p2sh, &quot;87&quot;].join ].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="355">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_address_script(address)</code>
        </li>
      
        <li class="covered" data-hits="139" data-linenumber="356">
          <span class="hits">139</span>
          
          <code class="ruby">    hash160 = Bitcoin.hash160_from_address(address)</code>
        </li>
      
        <li class="covered" data-hits="139" data-linenumber="357">
          <span class="hits">139</span>
          
          <code class="ruby">    case Bitcoin.address_type(address)</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="358">
          <span class="hits">137</span>
          
          <code class="ruby">    when :hash160; to_hash160_script(hash160)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="359">
          <span class="hits">1</span>
          
          <code class="ruby">    when :p2sh;    to_p2sh_script(hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">  # generate multisig tx for given +pubkeys+, expecting +m+ signatures</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="364">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_multisig_script(m, *pubkeys)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="365">
          <span class="hits">16</span>
          
          <code class="ruby">    pubs = pubkeys.map{|pk|p=[pk].pack(&quot;H*&quot;); [p.bytesize].pack(&quot;C&quot;) + p}</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="366">
          <span class="hits">5</span>
          
          <code class="ruby">    [ [80 + m.to_i].pack(&quot;C&quot;), *pubs, [80 + pubs.size].pack(&quot;C&quot;), &quot;\xAE&quot;].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">  # generate pubkey script sig for given +signature+ and +pubkey+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="370">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_pubkey_script_sig(signature, pubkey)</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="371">
          <span class="hits">46</span>
          
          <code class="ruby">    hash_type = &quot;\x01&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">    #pubkey = [pubkey].pack(&quot;H*&quot;) if pubkey.bytesize != 65</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="373">
          <span class="hits">46</span>
          
          <code class="ruby">    raise &quot;pubkey is not in binary form&quot; unless pubkey.bytesize == 65  &amp;&amp; pubkey[0] == &quot;\x04&quot;</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="374">
          <span class="hits">46</span>
          
          <code class="ruby">    [ [signature.bytesize+1].pack(&quot;C&quot;), signature, hash_type, [pubkey.bytesize].pack(&quot;C&quot;), pubkey ].join</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">  # alias for #to_pubkey_script_sig</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="378">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_signature_pubkey_script(*a)</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="379">
          <span class="hits">42</span>
          
          <code class="ruby">    to_pubkey_script_sig(*a)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="382">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_multisig_script_sig(*sigs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">    from_string(&quot;0 #{sigs.map{|s|s.unpack('H*')[0]}.join(' ')}&quot;).raw</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="386">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_signatures_required</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">    return false unless is_multisig?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">    @chunks[0] - 80</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">  ## OPCODES</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">  # Does nothing</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="394">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_nop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">  # Duplicates the top stack item.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="398">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_dup</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="399">
          <span class="hits">69</span>
          
          <code class="ruby">    @stack &lt;&lt; (@stack[-1].dup rescue @stack[-1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">  # The input is hashed using SHA-256.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="403">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_sha256</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="404">
          <span class="hits">1</span>
          
          <code class="ruby">    buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="405">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; Digest::SHA256.digest(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">  # The input is hashed using SHA-1.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="409">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_sha1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="410">
          <span class="hits">1</span>
          
          <code class="ruby">    buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="411">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; Digest::SHA1.digest(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">  # The input is hashed twice: first with SHA-256 and then with RIPEMD-160.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="415">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_hash160</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="416">
          <span class="hits">65</span>
          
          <code class="ruby">    buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="417">
          <span class="hits">65</span>
          
          <code class="ruby">    @stack &lt;&lt; Digest::RMD160.digest(Digest::SHA256.digest(buf))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">  # The input is hashed using RIPEMD-160.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="421">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_ripemd160</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="422">
          <span class="hits">1</span>
          
          <code class="ruby">    buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="423">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; Digest::RMD160.digest(buf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">  # The input is hashed two times with SHA-256.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="427">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_hash256</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="428">
          <span class="hits">1</span>
          
          <code class="ruby">    buf = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="429">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; Digest::SHA256.digest(Digest::SHA256.digest(buf))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">  # Puts the input onto the top of the alt stack. Removes it from the main stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="433">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_toaltstack</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="434">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack_alt &lt;&lt; @stack.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby">  # Puts the input onto the top of the main stack. Removes it from the alt stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="438">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_fromaltstack</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="439">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; @stack_alt.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">  # The item at the top of the stack is copied and inserted before the second-to-top item.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="443">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_tuck</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="444">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack[-2..-1] = [ @stack[-1], *@stack[-2..-1] ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">  # The top two items on the stack are swapped.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="448">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_swap</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="449">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack[-2..-1] = @stack[-2..-1].reverse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">  # If both a and b are not 0, the output is 1. Otherwise 0.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="453">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_booland</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="454">
          <span class="hits">4</span>
          
          <code class="ruby">    a, b = @stack.pop(2)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="455">
          <span class="hits">10</span>
          
          <code class="ruby">    @stack &lt;&lt; (![a,b].any?{|n| n == 0 } ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby">  # a is added to b.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="459">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_add</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="460">
          <span class="hits">3</span>
          
          <code class="ruby">    a, b = @stack.pop(2).reverse</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="461">
          <span class="hits">3</span>
          
          <code class="ruby">    @stack &lt;&lt; a + b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">  # b is subtracted from a.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="465">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_sub</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="466">
          <span class="hits">3</span>
          
          <code class="ruby">    a, b = @stack.pop(2).reverse</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="467">
          <span class="hits">3</span>
          
          <code class="ruby">    @stack &lt;&lt; a - b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">  # Returns 1 if a is greater than or equal to b, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="471">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_greaterthanorequal</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="472">
          <span class="hits">3</span>
          
          <code class="ruby">    a, b = @stack.pop(2).reverse</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="473">
          <span class="hits">3</span>
          
          <code class="ruby">    @stack &lt;&lt; (a &gt;= b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby">  # Removes the top stack item.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="477">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_drop</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="478">
          <span class="hits">12</span>
          
          <code class="ruby">    @stack.pop</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="480">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby">  # Returns 1 if the inputs are exactly equal, 0 otherwise.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="482">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_equal</code>
        </li>
      
        <li class="covered" data-hits="73" data-linenumber="483">
          <span class="hits">73</span>
          
          <code class="ruby">    a, b = @stack.pop(2).reverse</code>
        </li>
      
        <li class="covered" data-hits="73" data-linenumber="484">
          <span class="hits">73</span>
          
          <code class="ruby">    @stack &lt;&lt; (a == b ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby">  # Marks transaction as invalid if top stack value is not true. True is removed, but false is not.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="488">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_verify</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="489">
          <span class="hits">68</span>
          
          <code class="ruby">    res = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="490">
          <span class="hits">68</span>
          
          <code class="ruby">    if res == 0</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="491">
          <span class="hits">3</span>
          
          <code class="ruby">      @stack &lt;&lt; res</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="492">
          <span class="hits">3</span>
          
          <code class="ruby">      @script_invalid = true # raise 'transaction invalid' ?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="494">
          <span class="hits">65</span>
          
          <code class="ruby">      @script_invalid = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="496">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby">  # Same as OP_EQUAL, but runs OP_VERIFY afterward.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="499">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_equalverify</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="500">
          <span class="hits">66</span>
          
          <code class="ruby">    op_equal; op_verify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="503">
          
          
          <code class="ruby">  # An empty array of bytes is pushed onto the stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="504">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_0</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="505">
          <span class="hits">26</span>
          
          <code class="ruby">    @stack &lt;&lt; &quot;&quot; # []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="506">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="507">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">  # The number 1 is pushed onto the stack. Same as OP_TRUE</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="509">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_1</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="510">
          <span class="hits">18</span>
          
          <code class="ruby">    @stack &lt;&lt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="511">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby">  # Returns the smaller of a and b.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="514">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_min</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="515">
          <span class="hits">15</span>
          
          <code class="ruby">    @stack &lt;&lt; @stack.pop(2).map{|i| (i.is_a?(String) &amp;&amp; i.bytesize == 1) ? i.ord : i }.min</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="518">
          
          
          <code class="ruby">  # Returns the larger of a and b.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="519">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_max</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="520">
          <span class="hits">12</span>
          
          <code class="ruby">    @stack &lt;&lt; @stack.pop(2).map{|i| (i.is_a?(String) &amp;&amp; i.bytesize == 1) ? i.ord : i }.max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="521">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="522">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="523">
          
          
          <code class="ruby">  # Copies the pair of items two spaces back in the stack to the front.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="524">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_2over</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="525">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; @stack[-4]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="526">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; @stack[-4]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="527">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="528">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="529">
          
          
          <code class="ruby">  # Swaps the top two pairs of items.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="530">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_2swap</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="531">
          <span class="hits">1</span>
          
          <code class="ruby">    p1 = @stack.pop(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="532">
          <span class="hits">1</span>
          
          <code class="ruby">    p2 = @stack.pop(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="533">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack += p1 += p2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="534">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="535">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="536">
          
          
          <code class="ruby">  # If the input is true, duplicate it.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="537">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_ifdup</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="538">
          <span class="hits">3</span>
          
          <code class="ruby">    if @stack.last != 0</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="539">
          <span class="hits">2</span>
          
          <code class="ruby">      @stack &lt;&lt; @stack.last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="540">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="541">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="542">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby">  # The number -1 is pushed onto the stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="544">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_1negate</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="545">
          <span class="hits">1</span>
          
          <code class="ruby">    @stack &lt;&lt; -1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="546">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="547">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="548">
          
          
          <code class="ruby">  # Puts the number of stack items onto the stack.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="549">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_depth</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="550">
          <span class="hits">2</span>
          
          <code class="ruby">    @stack &lt;&lt; @stack.size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="551">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="552">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="553">
          
          
          <code class="ruby">  # https://en.bitcoin.it/wiki/BIP_0017  (old OP_NOP2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="554">
          
          
          <code class="ruby">  # TODO: don't rely on it yet. add guards from wikipage too.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="555">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_checkhashverify</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="556">
          <span class="hits">7</span>
          
          <code class="ruby">    unless @checkhash &amp;&amp; (@checkhash == @stack[-1].unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="557">
          <span class="hits">1</span>
          
          <code class="ruby">      @script_invalid = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="558">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="559">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="560">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="561">
          
          
          <code class="ruby">  # All of the signature checking words will only match signatures</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="562">
          
          
          <code class="ruby">  # to the data after the most recently-executed OP_CODESEPARATOR.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="563">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_codeseparator</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="564">
          <span class="hits">8</span>
          
          <code class="ruby">    @codehash_start = @chunks.size - @chunks.reverse.index(OP_CODESEPARATOR)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="565">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="566">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="567">
          
          
          <code class="ruby">  # do a CHECKSIG operation on the current stack,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="568">
          
          
          <code class="ruby">  # asking +check_callback+ to do the actual signature verification.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby">  # This is used by Protocol::Tx#verify_input_signature</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="570">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_checksig(check_callback)</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="571">
          <span class="hits">82</span>
          
          <code class="ruby">    return invalid if @stack.size &lt; 2</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="572">
          <span class="hits">81</span>
          
          <code class="ruby">    pubkey = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="573">
          <span class="hits">81</span>
          
          <code class="ruby">    drop_sigs      = [@stack[-1].unpack(&quot;H*&quot;)[0]]</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="574">
          <span class="hits">81</span>
          
          <code class="ruby">    sig, hash_type = parse_sig(@stack.pop)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="575">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="576">
          <span class="hits">81</span>
          
          <code class="ruby">    if @chunks.include?(OP_CHECKHASHVERIFY)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="577">
          
          
          <code class="ruby">      # Subset of script starting at the most recent codeseparator to OP_CHECKSIG</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="578">
          <span class="hits">3</span>
          
          <code class="ruby">      script_code, @checkhash = codehash_script(OP_CHECKSIG)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="579">
          
          
          <code class="ruby">    elsif inner_p2sh?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="580">
          <span class="hits">3</span>
          
          <code class="ruby">      script_code = to_string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="582">
          <span class="hits">75</span>
          
          <code class="ruby">      script_code, drop_sigs = nil, nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="583">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="584">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="585">
          <span class="hits">81</span>
          
          <code class="ruby">    if check_callback == nil # for tests</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="586">
          <span class="hits">1</span>
          
          <code class="ruby">      @stack &lt;&lt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="587">
          
          
          <code class="ruby">    else # real signature check callback</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="588">
          
          
          <code class="ruby">      @stack &lt;&lt;</code>
        </li>
      
        <li class="covered" data-hits="80" data-linenumber="589">
          <span class="hits">80</span>
          
          <code class="ruby">        ((check_callback.call(pubkey, sig, hash_type, drop_sigs, script_code) == true) ? 1 : 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="590">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="591">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="593">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_checksigverify(check_callback)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="594">
          
          
          <code class="ruby">    op_checksig(check_callback)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="595">
          
          
          <code class="ruby">    op_verify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="596">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="597">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="598">
          
          
          <code class="ruby">  # do a CHECKMULTISIG operation on the current stack,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="599">
          
          
          <code class="ruby">  # asking +check_callback+ to do the actual signature verification.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="600">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="601">
          
          
          <code class="ruby">  # CHECKMULTISIG does a m-of-n signatures verification on scripts of the form:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="602">
          
          
          <code class="ruby">  #  0 &lt;sig1&gt; &lt;sig2&gt; | 2 &lt;pub1&gt; &lt;pub2&gt; 2 OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="603">
          
          
          <code class="ruby">  #  0 &lt;sig1&gt; &lt;sig2&gt; | 2 &lt;pub1&gt; &lt;pub2&gt; &lt;pub3&gt; 3 OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="604">
          
          
          <code class="ruby">  #  0 &lt;sig1&gt; &lt;sig2&gt; &lt;sig3&gt; | 3 &lt;pub1&gt; &lt;pub2&gt; &lt;pub3&gt; 3 OP_CHECKMULTISIG</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="605">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="606">
          
          
          <code class="ruby">  # see https://en.bitcoin.it/wiki/BIP_0011 for details.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="607">
          
          
          <code class="ruby">  # see https://github.com/bitcoin/bitcoin/blob/master/src/script.cpp#L931</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="608">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="609">
          
          
          <code class="ruby">  # TODO: validate signature order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="610">
          
          
          <code class="ruby">  # TODO: take global opcode count</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="611">
          <span class="hits">1</span>
          
          <code class="ruby">  def op_checkmultisig(check_callback)</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="612">
          <span class="hits">25</span>
          
          <code class="ruby">    n_pubkeys = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="613">
          <span class="hits">25</span>
          
          <code class="ruby">    return invalid  unless (0..20).include?(n_pubkeys)</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="614">
          <span class="hits">77</span>
          
          <code class="ruby">    return invalid  unless @stack.last(n_pubkeys).all?{|e| e.is_a?(String) &amp;&amp; e != '' }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="615">
          
          
          <code class="ruby">    #return invalid  if ((@op_count ||= 0) += n_pubkeys) &gt; 201</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="616">
          <span class="hits">22</span>
          
          <code class="ruby">    pubkeys = @stack.pop(n_pubkeys)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="617">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="618">
          <span class="hits">22</span>
          
          <code class="ruby">    n_sigs = @stack.pop</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="619">
          <span class="hits">22</span>
          
          <code class="ruby">    return invalid  unless (0..n_pubkeys).include?(n_sigs)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="620">
          <span class="hits">48</span>
          
          <code class="ruby">    return invalid  unless @stack.last(n_sigs).all?{|e| e.is_a?(String) &amp;&amp; e != '' }</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="621">
          <span class="hits">48</span>
          
          <code class="ruby">    sigs = (drop_sigs = @stack.pop(n_sigs)).map{|s| parse_sig(s) }</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="622">
          <span class="hits">48</span>
          
          <code class="ruby">    drop_sigs.map!{|i| i.unpack(&quot;H*&quot;)[0] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="624">
          <span class="hits">18</span>
          
          <code class="ruby">    @stack.pop if @stack[-1] == '' # remove OP_NOP from stack</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="625">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="626">
          <span class="hits">18</span>
          
          <code class="ruby">    if @chunks.include?(OP_CHECKHASHVERIFY)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="627">
          
          
          <code class="ruby">      # Subset of script starting at the most recent codeseparator to OP_CHECKMULTISIG</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="628">
          <span class="hits">4</span>
          
          <code class="ruby">      script_code, @checkhash = codehash_script(OP_CHECKMULTISIG)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="629">
          
          
          <code class="ruby">    elsif inner_p2sh?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="630">
          <span class="hits">2</span>
          
          <code class="ruby">      script_code = to_string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="632">
          <span class="hits">12</span>
          
          <code class="ruby">      script_code, drop_sigs = nil, nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="633">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="634">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="635">
          <span class="hits">18</span>
          
          <code class="ruby">    valid_sigs = 0</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="636">
          <span class="hits">48</span>
          
          <code class="ruby">    sigs.each{|sig, hash_type| pubkeys.each{|pubkey|</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="637">
          <span class="hits">74</span>
          
          <code class="ruby">        valid_sigs += 1  if check_callback.call(pubkey, sig, hash_type, drop_sigs, script_code)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="638">
          
          
          <code class="ruby">      }}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="639">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="640">
          <span class="hits">18</span>
          
          <code class="ruby">    @stack &lt;&lt; ((valid_sigs == n_sigs) ? 1 : (invalid; 0))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="641">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="642">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="643">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES_METHOD = Hash[*instance_methods.grep(/^op_/).map{|m|</code>
        </li>
      
        <li class="covered" data-hits="791" data-linenumber="644">
          <span class="hits">791</span>
          
          <code class="ruby">      [ (OPCODES.find{|k,v| v == m.to_s.upcase }.first rescue nil), m ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="645">
          
          
          <code class="ruby">    }.flatten]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="646">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES_METHOD[0]  = :op_0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="647">
          <span class="hits">1</span>
          
          <code class="ruby">  OPCODES_METHOD[81] = :op_1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="648">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="649">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="650">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="651">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_sig(sig)</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="652">
          <span class="hits">111</span>
          
          <code class="ruby">    hash_type = sig[-1].unpack(&quot;C&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="653">
          <span class="hits">111</span>
          
          <code class="ruby">    sig = sig[0...-1]</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="654">
          <span class="hits">111</span>
          
          <code class="ruby">    return sig, hash_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="655">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="656">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3df1335f475b9f7cfa9efdfa05ebfc5a3780d534">
  <div class="header">
    <h3>lib/bitcoin/storage/dummy.rb</h3>
    <h4><span class="red">25.74 %</span> covered</h4>
    <div>
      <b>101</b> relevant lines. 
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>75</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Backends</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class DummyStore &lt; StoreBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :blk, :tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize *args</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      reset</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      super(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      @blk, @tx = [], {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_block(blk)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      return false  unless blk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      if block = get_block(blk.hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        log.info { &quot;Block already stored; skipping&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      prev_block = get_block(blk.prev_block.reverse_hth)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      unless prev_block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        unless blk.hash == Bitcoin.network[:genesis_hash]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          log.warn { &quot;INVALID BLOCK: #{blk.hash}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      blk.tx.each {|tx| store_tx(tx) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      @blk &lt;&lt; blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      log.info { &quot;NEW HEAD: #{blk.hash} DEPTH: #{get_depth}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      get_depth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      if @tx.keys.include?(tx.hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        log.info { &quot;Tx already stored; skipping&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        return tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      @tx[tx.hash] = tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_block(blk_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      !!get_block(blk_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      !!get_tx(tx_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_depth</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      @blk.size - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_head</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      wrap_block(@blk[-1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_depth(depth)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      wrap_block(@blk[depth])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_prev_hash(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      wrap_block(@blk.find {|blk| blk.prev_block == [hash].pack(&quot;H*&quot;).reverse})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block(blk_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      wrap_block(@blk.find {|blk| blk.hash == blk_hash})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_id(blk_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      wrap_block(@blk[blk_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      wrap_block(@blk.find {|blk| blk.tx.map(&amp;:hash).include?(tx_hash) })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      transaction = @tx[tx_hash]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      return nil  unless transaction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      wrap_tx(transaction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx_by_id(tx_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      wrap_tx(@tx[tx_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txin_for_txout(tx_hash, txout_idx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">      txin = @tx.values.map(&amp;:in).flatten.find {|i| i.prev_out_index == txout_idx &amp;&amp;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        i.prev_out == [tx_hash].pack(&quot;H*&quot;).reverse }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      wrap_txin(txin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_pk_script(script)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      txouts = @tx.values.map(&amp;:out).flatten.select {|o| o.pk_script == script}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      txouts.map {|o| wrap_txout(o) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_hash160(hash160)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      @tx.values.map(&amp;:out).flatten.map {|o|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        o = wrap_txout(o)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        o.hash160 == hash160 ? o : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      }.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_block(block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      return nil  unless block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">      data = {:id =&gt; @blk.index(block), :depth =&gt; @blk.index(block)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">      blk = Bitcoin::Storage::Models::Block.new(self, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">      [:ver, :prev_block, :mrkl_root, :time, :bits, :nonce].each do |attr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">        blk.send(&quot;#{attr}=&quot;, block.send(attr))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">      block.tx.each do |tx|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        blk.tx &lt;&lt; get_tx(tx.hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      blk.recalc_block_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">      blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_tx(transaction)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      return nil  unless transaction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      blk = @blk.find{|b| b.tx.include?(transaction)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      data = {:id =&gt; transaction.hash, :blk_id =&gt; @blk.index(blk)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      tx = Bitcoin::Storage::Models::Tx.new(self, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      tx.ver = transaction.ver</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      tx.lock_time = transaction.lock_time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      transaction.in.each {|i| tx.add_in(wrap_txin(i))}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      transaction.out.each {|o| tx.add_out(wrap_txout(o))}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      tx.hash = tx.hash_from_payload(tx.to_payload)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txin(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">      return nil  unless input</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">      tx = @tx.values.find{|t| t.in.include?(input)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">      data = {:tx_id =&gt; tx.hash, :tx_idx =&gt; tx.in.index(input)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      txin = Bitcoin::Storage::Models::TxIn.new(self, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      [:prev_out, :prev_out_index, :script_sig_length, :script_sig, :sequence].each do |attr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        txin.send(&quot;#{attr}=&quot;, input.send(attr))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txout(output)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">      return nil  unless output</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      tx = @tx.values.find{|t| t.out.include?(output)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      data = {:tx_id =&gt; tx.hash, :tx_idx =&gt; tx.out.index(output),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        :hash160 =&gt; Bitcoin::Script.new(output.pk_script).get_hash160 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      txout = Bitcoin::Storage::Models::TxOut.new(self, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">      [:value, :pk_script_length, :pk_script].each do |attr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">        txout.send(&quot;#{attr}=&quot;, output.send(attr))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">      &quot;DummyStore&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a5b4193a8f28e1aea5ab2063c2b6e6b27fea99ad">
  <div class="header">
    <h3>lib/bitcoin/storage/models.rb</h3>
    <h4><span class="green">93.65 %</span> covered</h4>
    <div>
      <b>63</b> relevant lines. 
      <span class="green"><b>59</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># StorageModels defines objects that are returned from storage.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># These objects inherit from their Bitcoin::Protocol counterpart</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># and add some additional data and methods.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># * Bitcoin::Storage::Models::Block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># * Bitcoin::Storage::Models::Tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># * Bitcoin::Storage::Models::TxIn</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># * Bitcoin::Storage::Models::TxOut</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Models</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # Block retrieved from storage. (see Bitcoin::Protocol::Block)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  class Block &lt; Bitcoin::Protocol::Block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :ver, :prev_block, :mrkl_root, :time, :bits, :nonce, :tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :depth, :chain</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="18">
          <span class="hits">841</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="19">
          <span class="hits">841</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="20">
          <span class="hits">841</span>
          
          <code class="ruby">      @depth = data[:depth]</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="21">
          <span class="hits">841</span>
          
          <code class="ruby">      @chain = data[:chain]</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="22">
          <span class="hits">841</span>
          
          <code class="ruby">      @tx = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    # get the block this one builds upon</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_prev_block</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="27">
          <span class="hits">9</span>
          
          <code class="ruby">      @store.get_block(@prev_block.reverse_hth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    # get the block that builds upon this one</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_next_block</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="32">
          <span class="hits">14</span>
          
          <code class="ruby">      @store.get_block_by_prev_hash(@hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # Transaction retrieved from storage. (see Bitcoin::Protocol::Tx)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  class Tx &lt; Bitcoin::Protocol::Tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :ver, :lock_time, :hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :blk_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="44">
          <span class="hits">1003</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="45">
          <span class="hits">1003</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="46">
          <span class="hits">1003</span>
          
          <code class="ruby">      @blk_id = data[:blk_id]</code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="47">
          <span class="hits">1003</span>
          
          <code class="ruby">      super(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    # get the block this transaction is in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="52">
          <span class="hits">29</span>
          
          <code class="ruby">      return nil  unless @blk_id</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="53">
          <span class="hits">24</span>
          
          <code class="ruby">      @store.get_block_by_id(@blk_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    # get the number of blocks that confirm this tx in the main chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def confirmations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      return 0  unless get_block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      @store.get_head.depth - get_block.depth + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  # Transaction input retrieved from storage. (see Bitcoin::Protocol::TxIn</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  class TxIn &lt; Bitcoin::Protocol::TxIn</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :tx_id, :tx_idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="69">
          <span class="hits">1036</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="70">
          <span class="hits">1036</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="71">
          <span class="hits">1036</span>
          
          <code class="ruby">      @tx_id = data[:tx_id]</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="72">
          <span class="hits">1036</span>
          
          <code class="ruby">      @tx_idx = data[:tx_idx]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    # get the transaction this input is in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="78">
          <span class="hits">4</span>
          
          <code class="ruby">      @store.get_tx_by_id(@tx_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    # get the previous output referenced by this input</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_prev_out</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">      prev_tx = @store.get_tx(@prev_out.reverse_hth)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">      return nil  unless prev_tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">      prev_tx.out[@prev_out_index]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  # Transaction output retrieved from storage. (see Bitcoin::Protocol::TxOut)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  class TxOut &lt; Bitcoin::Protocol::TxOut</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :store, :id, :tx_id, :tx_idx, :type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize store, data</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="96">
          <span class="hits">1076</span>
          
          <code class="ruby">      @store = store</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="97">
          <span class="hits">1076</span>
          
          <code class="ruby">      @id = data[:id]</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="98">
          <span class="hits">1076</span>
          
          <code class="ruby">      @tx_id = data[:tx_id]</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="99">
          <span class="hits">1076</span>
          
          <code class="ruby">      @tx_idx = data[:tx_idx]</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="100">
          <span class="hits">1076</span>
          
          <code class="ruby">      @type = data[:type]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash160</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">      script.get_hash160</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    # get the transaction this output is in</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="109">
          <span class="hits">66</span>
          
          <code class="ruby">      @store.get_tx_by_id(@tx_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    # get the next input that references this output</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_next_in</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="114">
          <span class="hits">40</span>
          
          <code class="ruby">      @store.get_txin_for_txout(get_tx.hash, @tx_idx)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    # get all addresses this txout corresponds to (if possible)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      script.get_address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    # get the single address this txout corresponds to (first for multisig tx)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_addresses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      script.get_addresses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    def type</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">      script.type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">    def script</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="132">
          <span class="hits">2</span>
          
          <code class="ruby">      @_script = Bitcoin::Script.new(@pk_script)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2b02df19bf3e2d30c17039c18855058d8a44f920">
  <div class="header">
    <h3>lib/bitcoin/storage/sequel.rb</h3>
    <h4><span class="green">97.14 %</span> covered</h4>
    <div>
      <b>175</b> relevant lines. 
      <span class="green"><b>170</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">Bitcoin.require_dependency :sequel, message:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  &quot;Note: You will also need an adapter for your database like sqlite3, mysql2, postgresql&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require 'bitcoin/storage/sequel_store/sequel_migrations'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Backends</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Storage backend using Sequel to connect to arbitrary SQL databases.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Inherits from StoreBase and implements its interface.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  class SequelStore &lt; StoreBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # possible script types</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    SCRIPT_TYPES = [:unknown, :pubkey, :hash160, :multisig, :p2sh]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # sequel database connection</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :db</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    include Bitcoin::Storage::Backends::SequelMigrations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    DEFAULT_CONFIG = {mode: :full}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # create sequel store with given +config+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize config, *args</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="24">
          <span class="hits">62</span>
          
          <code class="ruby">      @config = DEFAULT_CONFIG.merge(config)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="25">
          <span class="hits">62</span>
          
          <code class="ruby">      connect</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="26">
          <span class="hits">62</span>
          
          <code class="ruby">      super config, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # connect to database</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      {:sqlite =&gt; &quot;sqlite3&quot;, :postgres =&gt; &quot;pg&quot;, :mysql =&gt; &quot;mysql&quot;,</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="32">
          <span class="hits">62</span>
          
          <code class="ruby">      }.each do |adapter, name|</code>
        </li>
      
        <li class="covered" data-hits="186" data-linenumber="33">
          <span class="hits">186</span>
          
          <code class="ruby">        if @config[:db].split(&quot;:&quot;).first == adapter.to_s</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="34">
          <span class="hits">62</span>
          
          <code class="ruby">          Bitcoin.require_dependency name, gem: name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="38">
          <span class="hits">62</span>
          
          <code class="ruby">      @db = Sequel.connect(@config[:db])</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="39">
          <span class="hits">62</span>
          
          <code class="ruby">      migrate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    # reset database; delete all data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset</code>
        </li>
      
        <li class="covered" data-hits="396" data-linenumber="44">
          <span class="hits">396</span>
          
          <code class="ruby">      [:blk, :blk_tx, :tx, :txin, :txout].each {|table| @db[table].delete}</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="45">
          <span class="hits">66</span>
          
          <code class="ruby">      @head = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # persist given block +blk+ to storage.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    def persist_block blk, chain, depth</code>
        </li>
      
        <li class="covered" data-hits="413" data-linenumber="50">
          <span class="hits">413</span>
          
          <code class="ruby">      @db.transaction do</code>
        </li>
      
        <li class="covered" data-hits="413" data-linenumber="51">
          <span class="hits">413</span>
          
          <code class="ruby">        attrs = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">          :hash =&gt; blk.hash.htb.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">          :depth =&gt; depth,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">          :chain =&gt; chain,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">          :version =&gt; blk.ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">          :prev_hash =&gt; blk.prev_block.reverse.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">          :mrkl_root =&gt; blk.mrkl_root.reverse.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">          :time =&gt; blk.time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">          :bits =&gt; blk.bits,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">          :nonce =&gt; blk.nonce,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">          :blk_size =&gt; blk.to_payload.bytesize,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="413" data-linenumber="63">
          <span class="hits">413</span>
          
          <code class="ruby">        existing = @db[:blk].filter(:hash =&gt; blk.hash.htb.to_sequel_blob)</code>
        </li>
      
        <li class="covered" data-hits="413" data-linenumber="64">
          <span class="hits">413</span>
          
          <code class="ruby">        if existing.any?</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="65">
          <span class="hits">65</span>
          
          <code class="ruby">          existing.update attrs</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="66">
          <span class="hits">65</span>
          
          <code class="ruby">          block_id = existing.first[:id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="348" data-linenumber="68">
          <span class="hits">348</span>
          
          <code class="ruby">          block_id = @db[:blk].insert(attrs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="348" data-linenumber="70">
          <span class="hits">348</span>
          
          <code class="ruby">          blk.tx.each_with_index do |tx, idx|</code>
        </li>
      
        <li class="covered" data-hits="364" data-linenumber="71">
          <span class="hits">364</span>
          
          <code class="ruby">            tx_id = store_tx(tx, false)</code>
        </li>
      
        <li class="covered" data-hits="364" data-linenumber="72">
          <span class="hits">364</span>
          
          <code class="ruby">            raise &quot;Error saving tx #{tx.hash} in block #{blk.hash}&quot;  unless tx_id</code>
        </li>
      
        <li class="covered" data-hits="364" data-linenumber="73">
          <span class="hits">364</span>
          
          <code class="ruby">            @db[:blk_tx].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">                :blk_id =&gt; block_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">                :tx_id =&gt; tx_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">                :idx =&gt; idx,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">              })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="413" data-linenumber="80">
          <span class="hits">413</span>
          
          <code class="ruby">        @head = wrap_block(attrs.merge(id: block_id))  if chain == MAIN</code>
        </li>
      
        <li class="covered" data-hits="413" data-linenumber="81">
          <span class="hits">413</span>
          
          <code class="ruby">        @db[:blk].where(:prev_hash =&gt; blk.hash.htb.to_sequel_blob, :chain =&gt; ORPHAN).each do |b|</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="82">
          <span class="hits">65</span>
          
          <code class="ruby">          log.debug { &quot;re-org orphan #{b[:hash].hth}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="83">
          <span class="hits">65</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="84">
          <span class="hits">65</span>
          
          <code class="ruby">            store_block(get_block(b[:hash].hth))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">          rescue SystemStackError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">            EM.defer { store_block(get_block(b[:hash].hth)) }  if EM.reactor_running?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="413" data-linenumber="89">
          <span class="hits">413</span>
          
          <code class="ruby">        log.info { &quot;block #{blk.hash} (#{depth}, #{['main', 'side', 'orphan'][chain]})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="413" data-linenumber="90">
          <span class="hits">413</span>
          
          <code class="ruby">        return depth, chain</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    # update +attrs+ for block with given +hash+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">    def update_blocks updates</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="96">
          <span class="hits">9</span>
          
          <code class="ruby">      @db.transaction do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="97">
          <span class="hits">9</span>
          
          <code class="ruby">        updates.each do |blocks, attrs|</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="98">
          <span class="hits">22</span>
          
          <code class="ruby">          @db[:blk].filter(:hash =&gt; blocks.map{|h| h.htb.to_sequel_blob}).update(attrs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    # store transaction +tx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_tx(tx, validate = true)</code>
        </li>
      
        <li class="covered" data-hits="451" data-linenumber="105">
          <span class="hits">451</span>
          
          <code class="ruby">      @log.debug { &quot;Storing tx #{tx.hash} (#{tx.to_payload.bytesize} bytes)&quot; }</code>
        </li>
      
        <li class="covered" data-hits="451" data-linenumber="106">
          <span class="hits">451</span>
          
          <code class="ruby">      tx.validator(self).validate(raise_errors: true)  if validate</code>
        </li>
      
        <li class="covered" data-hits="450" data-linenumber="107">
          <span class="hits">450</span>
          
          <code class="ruby">      @db.transaction do</code>
        </li>
      
        <li class="covered" data-hits="450" data-linenumber="108">
          <span class="hits">450</span>
          
          <code class="ruby">        transaction = @db[:tx][:hash =&gt; tx.hash.htb.to_sequel_blob]</code>
        </li>
      
        <li class="covered" data-hits="450" data-linenumber="109">
          <span class="hits">450</span>
          
          <code class="ruby">        return transaction[:id]  if transaction</code>
        </li>
      
        <li class="covered" data-hits="446" data-linenumber="110">
          <span class="hits">446</span>
          
          <code class="ruby">        tx_id = @db[:tx].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">            :hash =&gt; tx.hash.htb.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">            :version =&gt; tx.ver,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">            :lock_time =&gt; tx.lock_time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">            :coinbase =&gt; tx.in.size==1 &amp;&amp; tx.in[0].coinbase?,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">            :tx_size =&gt; tx.payload.bytesize,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="covered" data-hits="925" data-linenumber="117">
          <span class="hits">925</span>
          
          <code class="ruby">        tx.in.each_with_index {|i, idx| store_txin(tx_id, i, idx)}</code>
        </li>
      
        <li class="covered" data-hits="977" data-linenumber="118">
          <span class="hits">977</span>
          
          <code class="ruby">        tx.out.each_with_index {|o, idx| store_txout(tx_id, o, idx)}</code>
        </li>
      
        <li class="covered" data-hits="446" data-linenumber="119">
          <span class="hits">446</span>
          
          <code class="ruby">        tx_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    # store input +txin+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_txin(tx_id, txin, idx)</code>
        </li>
      
        <li class="covered" data-hits="479" data-linenumber="125">
          <span class="hits">479</span>
          
          <code class="ruby">      @db[:txin].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">          :tx_id =&gt; tx_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">          :tx_idx =&gt; idx,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">          :script_sig =&gt; txin.script_sig.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">          :prev_out =&gt; txin.prev_out.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">          :prev_out_index =&gt; txin.prev_out_index,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          :sequence =&gt; txin.sequence.unpack(&quot;I&quot;)[0],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="479" data-linenumber="134">
          <span class="hits">479</span>
          
          <code class="ruby">      if @config[:mode] == :pruned</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">        # delete previous transaction if all its outputs are spent now</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="136">
          <span class="hits">8</span>
          
          <code class="ruby">        prev_tx = @db[:tx][:hash =&gt; txin.prev_out.reverse.to_sequel_blob]</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="137">
          <span class="hits">8</span>
          
          <code class="ruby">        return  unless prev_tx</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="138">
          <span class="hits">3</span>
          
          <code class="ruby">        if @db[:txout].where(:tx_id =&gt; prev_tx[:id]).map.with_index{|o, i|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="139">
          <span class="hits">5</span>
          
          <code class="ruby">            @db[:txin].where(:prev_out =&gt; prev_tx[:hash].reverse.to_sequel_blob, :prev_out_index =&gt; i).any? }.all?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="140">
          <span class="hits">2</span>
          
          <code class="ruby">          delete_tx(prev_tx[:hash].hth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    # store output +txout+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_txout(tx_id, txout, idx)</code>
        </li>
      
        <li class="covered" data-hits="532" data-linenumber="147">
          <span class="hits">532</span>
          
          <code class="ruby">      script = Bitcoin::Script.new(txout.pk_script)</code>
        </li>
      
        <li class="covered" data-hits="532" data-linenumber="148">
          <span class="hits">532</span>
          
          <code class="ruby">      txout_id = @db[:txout].insert({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">          :tx_id =&gt; tx_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">          :tx_idx =&gt; idx,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">          :pk_script =&gt; txout.pk_script.to_sequel_blob,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">          :value =&gt; txout.value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">          :type =&gt; SCRIPT_TYPES.index(script.type)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">        })</code>
        </li>
      
        <li class="covered" data-hits="532" data-linenumber="155">
          <span class="hits">532</span>
          
          <code class="ruby">      if script.is_hash160? || script.is_pubkey?</code>
        </li>
      
        <li class="covered" data-hits="531" data-linenumber="156">
          <span class="hits">531</span>
          
          <code class="ruby">        store_addr(txout_id, script.get_hash160)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      elsif script.is_multisig?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">        script.get_multisig_pubkeys.map do |pubkey|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="159">
          <span class="hits">2</span>
          
          <code class="ruby">          store_addr(txout_id, Bitcoin.hash160(pubkey.unpack(&quot;H*&quot;)[0]))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="532" data-linenumber="162">
          <span class="hits">532</span>
          
          <code class="ruby">      txout_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    # store address +hash160+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_addr(txout_id, hash160)</code>
        </li>
      
        <li class="covered" data-hits="533" data-linenumber="167">
          <span class="hits">533</span>
          
          <code class="ruby">      addr = @db[:addr][:hash160 =&gt; hash160]</code>
        </li>
      
        <li class="covered" data-hits="533" data-linenumber="168">
          <span class="hits">533</span>
          
          <code class="ruby">      addr_id = addr[:id]  if addr</code>
        </li>
      
        <li class="covered" data-hits="533" data-linenumber="169">
          <span class="hits">533</span>
          
          <code class="ruby">      addr_id ||= @db[:addr].insert({:hash160 =&gt; hash160})</code>
        </li>
      
        <li class="covered" data-hits="533" data-linenumber="170">
          <span class="hits">533</span>
          
          <code class="ruby">      @db[:addr_txout].insert({:addr_id =&gt; addr_id, :txout_id =&gt; txout_id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">    def delete_tx(hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="174">
          <span class="hits">2</span>
          
          <code class="ruby">      log.debug { &quot;Deleting tx #{hash} since all its outputs are spent&quot; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="175">
          <span class="hits">2</span>
          
          <code class="ruby">      @db.transaction do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="176">
          <span class="hits">2</span>
          
          <code class="ruby">        tx = get_tx(hash)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="177">
          <span class="hits">4</span>
          
          <code class="ruby">        tx.in.each {|i| @db[:txin].where(:id =&gt; i.id).delete }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="178">
          <span class="hits">5</span>
          
          <code class="ruby">        tx.out.each {|o| @db[:txout].where(:id =&gt; o.id).delete }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="179">
          <span class="hits">2</span>
          
          <code class="ruby">        @db[:tx].where(:id =&gt; tx.id).delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">    # check if block +blk_hash+ exists</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_block(blk_hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="185">
          <span class="hits">2</span>
          
          <code class="ruby">      !!@db[:blk].where(:hash =&gt; blk_hash.htb.to_sequel_blob).get(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">    # check if transaction +tx_hash+ exists</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="190">
          <span class="hits">2</span>
          
          <code class="ruby">      !!@db[:tx].where(:hash =&gt; tx_hash.htb.to_sequel_blob).get(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">    # get head block (highest block from the MAIN chain)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_head</code>
        </li>
      
        <li class="covered" data-hits="838" data-linenumber="195">
          <span class="hits">838</span>
          
          <code class="ruby">      @head ||= wrap_block(@db[:blk].filter(:chain =&gt; MAIN).order(:depth).last)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    # get depth of MAIN chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_depth</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="200">
          <span class="hits">259</span>
          
          <code class="ruby">      return -1  unless get_head</code>
        </li>
      
        <li class="covered" data-hits="257" data-linenumber="201">
          <span class="hits">257</span>
          
          <code class="ruby">      get_head.depth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    # get block for given +blk_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block(blk_hash)</code>
        </li>
      
        <li class="covered" data-hits="1015" data-linenumber="206">
          <span class="hits">1015</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:hash =&gt; blk_hash.htb.to_sequel_blob])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    # get block by given +depth+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="210">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_depth(depth)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="211">
          <span class="hits">6</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:depth =&gt; depth, :chain =&gt; MAIN])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    # get block by given +prev_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_prev_hash(prev_hash)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="216">
          <span class="hits">14</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:prev_hash =&gt; prev_hash.htb.to_sequel_blob, :chain =&gt; MAIN])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">    # get block by given +tx_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">      tx = @db[:tx][:hash =&gt; tx_hash.htb.to_sequel_blob]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="222">
          <span class="hits">1</span>
          
          <code class="ruby">      return nil  unless tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">      parent = @db[:blk_tx][:tx_id =&gt; tx[:id]]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">      return nil  unless parent</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:id =&gt; parent[:blk_id]])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">    # get block by given +id+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_block_by_id(block_id)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="230">
          <span class="hits">24</span>
          
          <code class="ruby">      wrap_block(@db[:blk][:id =&gt; block_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">    # get transaction for given +tx_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx(tx_hash)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="235">
          <span class="hits">37</span>
          
          <code class="ruby">      wrap_tx(@db[:tx][:hash =&gt; tx_hash.htb.to_sequel_blob])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">    # get transaction by given +tx_id+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_tx_by_id(tx_id)</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="240">
          <span class="hits">70</span>
          
          <code class="ruby">      wrap_tx(@db[:tx][:id =&gt; tx_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">    # get corresponding Models::TxIn for the txout in transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">    # +tx_hash+ with index +txout_idx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="245">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txin_for_txout(tx_hash, txout_idx)</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="246">
          <span class="hits">40</span>
          
          <code class="ruby">      tx_hash = tx_hash.htb_reverse.to_sequel_blob</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="247">
          <span class="hits">40</span>
          
          <code class="ruby">      wrap_txin(@db[:txin][:prev_out =&gt; tx_hash, :prev_out_index =&gt; txout_idx])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">    # get corresponding Models::TxOut for +txin+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txout_for_txin(txin)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">      tx = @db[:tx][:hash =&gt; txin.prev_out.reverse.to_sequel_blob]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">      return nil  unless tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">      wrap_txout(@db[:txout][:tx_idx =&gt; txin.prev_out_index, :tx_id =&gt; tx[:id]])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">    # get all Models::TxOut matching given +script+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_pk_script(script)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="259">
          <span class="hits">1</span>
          
          <code class="ruby">      txouts = @db[:txout].filter(:pk_script =&gt; script.to_sequel_blob).order(:id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="260">
          <span class="hits">2</span>
          
          <code class="ruby">      txouts.map{|txout| wrap_txout(txout)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">    # get all Models::TxOut matching given +hash160+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts_for_hash160(hash160, unconfirmed = false)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="265">
          <span class="hits">14</span>
          
          <code class="ruby">      addr = @db[:addr][:hash160 =&gt; hash160]</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="266">
          <span class="hits">14</span>
          
          <code class="ruby">      return []  unless addr</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="267">
          <span class="hits">13</span>
          
          <code class="ruby">      txouts = @db[:addr_txout].where(:addr_id =&gt; addr[:id])</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="268">
          <span class="hits">29</span>
          
          <code class="ruby">        .map{|t| @db[:txout][:id =&gt; t[:txout_id]] }</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="269">
          <span class="hits">29</span>
          
          <code class="ruby">        .map{|o| wrap_txout(o) }</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="270">
          <span class="hits">13</span>
          
          <code class="ruby">      unless unconfirmed</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="271">
          <span class="hits">34</span>
          
          <code class="ruby">        txouts.select!{|o| o.get_tx.get_block.chain == MAIN rescue false }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="273">
          <span class="hits">13</span>
          
          <code class="ruby">      txouts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">    # get all unconfirmed Models::TxOut</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="277">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_unconfirmed_tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">      @db[:unconfirmed].map{|t| wrap_tx(t)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">    # wrap given +block+ into Models::Block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_block(block)</code>
        </li>
      
        <li class="covered" data-hits="1402" data-linenumber="283">
          <span class="hits">1402</span>
          
          <code class="ruby">      return nil  unless block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="285">
          <span class="hits">841</span>
          
          <code class="ruby">      data = {:id =&gt; block[:id], :depth =&gt; block[:depth], :chain =&gt; block[:chain]}</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="286">
          <span class="hits">841</span>
          
          <code class="ruby">      blk = Bitcoin::Storage::Models::Block.new(self, data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="288">
          <span class="hits">841</span>
          
          <code class="ruby">      blk.ver = block[:version]</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="289">
          <span class="hits">841</span>
          
          <code class="ruby">      blk.prev_block = block[:prev_hash].reverse</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="290">
          <span class="hits">841</span>
          
          <code class="ruby">      blk.mrkl_root = block[:mrkl_root].reverse</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="291">
          <span class="hits">841</span>
          
          <code class="ruby">      blk.time = block[:time].to_i</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="292">
          <span class="hits">841</span>
          
          <code class="ruby">      blk.bits = block[:bits]</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="293">
          <span class="hits">841</span>
          
          <code class="ruby">      blk.nonce = block[:nonce]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="295">
          <span class="hits">841</span>
          
          <code class="ruby">      db[:blk_tx].filter(blk_id: block[:id]).join(:tx, id: :tx_id)</code>
        </li>
      
        <li class="covered" data-hits="900" data-linenumber="296">
          <span class="hits">900</span>
          
          <code class="ruby">        .order(:idx).each {|tx| blk.tx &lt;&lt; wrap_tx(tx, block[:id]) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="298">
          <span class="hits">841</span>
          
          <code class="ruby">      blk.recalc_block_hash</code>
        </li>
      
        <li class="covered" data-hits="841" data-linenumber="299">
          <span class="hits">841</span>
          
          <code class="ruby">      blk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">    # wrap given +transaction+ into Models::Transaction</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="303">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_tx(transaction, block_id = nil)</code>
        </li>
      
        <li class="covered" data-hits="1007" data-linenumber="304">
          <span class="hits">1007</span>
          
          <code class="ruby">      return nil  unless transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">      block_id ||= @db[:blk_tx].join(:blk, id: :blk_id)</code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="307">
          <span class="hits">1003</span>
          
          <code class="ruby">        .where(tx_id: transaction[:id], chain: 0).first[:blk_id] rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="309">
          <span class="hits">1003</span>
          
          <code class="ruby">      data = {id: transaction[:id], blk_id: block_id}</code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="310">
          <span class="hits">1003</span>
          
          <code class="ruby">      tx = Bitcoin::Storage::Models::Tx.new(self, data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="312">
          <span class="hits">1003</span>
          
          <code class="ruby">      inputs = db[:txin].filter(:tx_id =&gt; transaction[:id]).order(:tx_idx)</code>
        </li>
      
        <li class="covered" data-hits="2027" data-linenumber="313">
          <span class="hits">2027</span>
          
          <code class="ruby">      inputs.each { |i| tx.add_in(wrap_txin(i)) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="315">
          <span class="hits">1003</span>
          
          <code class="ruby">      outputs = db[:txout].filter(:tx_id =&gt; transaction[:id]).order(:tx_idx)</code>
        </li>
      
        <li class="covered" data-hits="2049" data-linenumber="316">
          <span class="hits">2049</span>
          
          <code class="ruby">      outputs.each { |o| tx.add_out(wrap_txout(o)) }</code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="317">
          <span class="hits">1003</span>
          
          <code class="ruby">      tx.ver = transaction[:version]</code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="318">
          <span class="hits">1003</span>
          
          <code class="ruby">      tx.lock_time = transaction[:lock_time]</code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="319">
          <span class="hits">1003</span>
          
          <code class="ruby">      tx.hash = tx.hash_from_payload(tx.to_payload)</code>
        </li>
      
        <li class="covered" data-hits="1003" data-linenumber="320">
          <span class="hits">1003</span>
          
          <code class="ruby">      tx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">    # wrap given +input+ into Models::TxIn</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="324">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txin(input)</code>
        </li>
      
        <li class="covered" data-hits="1064" data-linenumber="325">
          <span class="hits">1064</span>
          
          <code class="ruby">      return nil  unless input</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="326">
          <span class="hits">1036</span>
          
          <code class="ruby">      data = {:id =&gt; input[:id], :tx_id =&gt; input[:tx_id], :tx_idx =&gt; input[:tx_idx]}</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="327">
          <span class="hits">1036</span>
          
          <code class="ruby">      txin = Bitcoin::Storage::Models::TxIn.new(self, data)</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="328">
          <span class="hits">1036</span>
          
          <code class="ruby">      txin.prev_out = input[:prev_out]</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="329">
          <span class="hits">1036</span>
          
          <code class="ruby">      txin.prev_out_index = input[:prev_out_index]</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="330">
          <span class="hits">1036</span>
          
          <code class="ruby">      txin.script_sig_length = input[:script_sig].bytesize</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="331">
          <span class="hits">1036</span>
          
          <code class="ruby">      txin.script_sig = input[:script_sig]</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="332">
          <span class="hits">1036</span>
          
          <code class="ruby">      txin.sequence = [input[:sequence]].pack(&quot;I&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1036" data-linenumber="333">
          <span class="hits">1036</span>
          
          <code class="ruby">      txin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">    # wrap given +output+ into Models::TxOut</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="337">
          <span class="hits">1</span>
          
          <code class="ruby">    def wrap_txout(output)</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="338">
          <span class="hits">1076</span>
          
          <code class="ruby">      return nil  unless output</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="339">
          <span class="hits">1076</span>
          
          <code class="ruby">      data = {:id =&gt; output[:id], :tx_id =&gt; output[:tx_id], :tx_idx =&gt; output[:tx_idx],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">        :hash160 =&gt; output[:hash160], :type =&gt; SCRIPT_TYPES[output[:type]]}</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="341">
          <span class="hits">1076</span>
          
          <code class="ruby">      txout = Bitcoin::Storage::Models::TxOut.new(self, data)</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="342">
          <span class="hits">1076</span>
          
          <code class="ruby">      txout.value = output[:value]</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="343">
          <span class="hits">1076</span>
          
          <code class="ruby">      txout.pk_script = output[:pk_script]</code>
        </li>
      
        <li class="covered" data-hits="1076" data-linenumber="344">
          <span class="hits">1076</span>
          
          <code class="ruby">      txout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="13a1bc7c31c7c9123a61b240d7b469d94bd56dc9">
  <div class="header">
    <h3>lib/bitcoin/storage/sequel_store/sequel_migrations.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>55</b> relevant lines. 
      <span class="green"><b>55</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage::Backends::SequelMigrations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  def migrate</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="4">
          <span class="hits">62</span>
          
          <code class="ruby">    unless @db.tables.include?(:blk)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="5">
          <span class="hits">62</span>
          
          <code class="ruby">      @db.create_table :blk do</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="6">
          <span class="hits">62</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="7">
          <span class="hits">62</span>
          
          <code class="ruby">        column :hash, :bytea, :null =&gt; false, :unique =&gt; true, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="8">
          <span class="hits">62</span>
          
          <code class="ruby">        column :depth, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="9">
          <span class="hits">62</span>
          
          <code class="ruby">        column :version, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="10">
          <span class="hits">62</span>
          
          <code class="ruby">        column :prev_hash, :bytea, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="11">
          <span class="hits">62</span>
          
          <code class="ruby">        column :mrkl_root, :bytea, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="12">
          <span class="hits">62</span>
          
          <code class="ruby">        column :time, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="13">
          <span class="hits">62</span>
          
          <code class="ruby">        column :bits, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="14">
          <span class="hits">62</span>
          
          <code class="ruby">        column :nonce, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="15">
          <span class="hits">62</span>
          
          <code class="ruby">        column :blk_size, :int, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="16">
          <span class="hits">62</span>
          
          <code class="ruby">        column :chain, :int, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="20">
          <span class="hits">62</span>
          
          <code class="ruby">    unless @db.tables.include?(:tx)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="21">
          <span class="hits">62</span>
          
          <code class="ruby">      @db.create_table :tx do</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="22">
          <span class="hits">62</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="23">
          <span class="hits">62</span>
          
          <code class="ruby">        column :hash, :bytea, :null =&gt; false, :unique =&gt; true, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="24">
          <span class="hits">62</span>
          
          <code class="ruby">        column :version, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="25">
          <span class="hits">62</span>
          
          <code class="ruby">        column :lock_time, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="26">
          <span class="hits">62</span>
          
          <code class="ruby">        column :coinbase, :bool, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="27">
          <span class="hits">62</span>
          
          <code class="ruby">        column :tx_size, :int, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="31">
          <span class="hits">62</span>
          
          <code class="ruby">    unless @db.tables.include?(:blk_tx)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="32">
          <span class="hits">62</span>
          
          <code class="ruby">      @db.create_table :blk_tx do</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="33">
          <span class="hits">62</span>
          
          <code class="ruby">        column :blk_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="34">
          <span class="hits">62</span>
          
          <code class="ruby">        column :tx_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="35">
          <span class="hits">62</span>
          
          <code class="ruby">        column :idx, :int, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="39">
          <span class="hits">62</span>
          
          <code class="ruby">    unless @db.tables.include?(:txin)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="40">
          <span class="hits">62</span>
          
          <code class="ruby">      @db.create_table :txin do</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="41">
          <span class="hits">62</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="42">
          <span class="hits">62</span>
          
          <code class="ruby">        column :tx_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="43">
          <span class="hits">62</span>
          
          <code class="ruby">        column :tx_idx, :int, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="44">
          <span class="hits">62</span>
          
          <code class="ruby">        column :script_sig, :bytea, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="45">
          <span class="hits">62</span>
          
          <code class="ruby">        column :prev_out, :bytea, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="46">
          <span class="hits">62</span>
          
          <code class="ruby">        column :prev_out_index, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="47">
          <span class="hits">62</span>
          
          <code class="ruby">        column :sequence, :bigint, :null =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="51">
          <span class="hits">62</span>
          
          <code class="ruby">    unless @db.tables.include?(:txout)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="52">
          <span class="hits">62</span>
          
          <code class="ruby">      @db.create_table :txout do</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="53">
          <span class="hits">62</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="54">
          <span class="hits">62</span>
          
          <code class="ruby">        column :tx_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="55">
          <span class="hits">62</span>
          
          <code class="ruby">        column :tx_idx, :int, :null =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="56">
          <span class="hits">62</span>
          
          <code class="ruby">        column :pk_script, :bytea, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="57">
          <span class="hits">62</span>
          
          <code class="ruby">        column :value, :bigint</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="58">
          <span class="hits">62</span>
          
          <code class="ruby">        column :type, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="62">
          <span class="hits">62</span>
          
          <code class="ruby">    unless @db.tables.include?(:addr)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="63">
          <span class="hits">62</span>
          
          <code class="ruby">      @db.create_table :addr do</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="64">
          <span class="hits">62</span>
          
          <code class="ruby">        primary_key :id</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="65">
          <span class="hits">62</span>
          
          <code class="ruby">        column :hash160, String, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="69">
          <span class="hits">62</span>
          
          <code class="ruby">    unless @db.tables.include?(:addr_txout)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="70">
          <span class="hits">62</span>
          
          <code class="ruby">      @db.create_table :addr_txout do</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="71">
          <span class="hits">62</span>
          
          <code class="ruby">        column :addr_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="72">
          <span class="hits">62</span>
          
          <code class="ruby">        column :txout_id, :int, :null =&gt; false, :index =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="76">
          <span class="hits">62</span>
          
          <code class="ruby">    unless @db.views.include?(:unconfirmed)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="77">
          <span class="hits">62</span>
          
          <code class="ruby">      @db.create_view(:unconfirmed,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        &quot;SELECT * FROM tx WHERE NOT EXISTS &quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        &quot;(SELECT 1 FROM blk_tx WHERE blk_tx.tx_id = tx.id)&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        &quot;ORDER BY tx.id DESC&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1e47ca20dcc1dba7324b2d0287e768352d49ee12">
  <div class="header">
    <h3>lib/bitcoin/storage/storage.rb</h3>
    <h4><span class="yellow">83.58 %</span> covered</h4>
    <div>
      <b>134</b> relevant lines. 
      <span class="green"><b>112</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># The storage implementation supports different backends, which inherit from</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Storage::StoreBase and implement the same interface.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Each backend returns Storage::Models objects to easily access helper methods and metadata.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># The most stable backend is Backends::SequelStore, which uses sequel and can use all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># kinds of SQL database backends.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Storage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  autoload :Models, 'bitcoin/storage/models'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  @log = Bitcoin::Logger.create(:storage)</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="12">
          <span class="hits">98</span>
          
          <code class="ruby">  def self.log; @log; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  BACKENDS = [:dummy, :sequel]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  BACKENDS.each do |name|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    module_eval &lt;&lt;-EOS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      def self.#{name} config, *args</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        Backends.const_get(&quot;#{name.capitalize}Store&quot;).new(config, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">    EOS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  module Backends</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="25">
          <span class="hits">3</span>
          
          <code class="ruby">    BACKENDS.each {|b| autoload(&quot;#{b.to_s.capitalize}Store&quot;, &quot;bitcoin/storage/#{b}&quot;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # Base class for storage backends.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # Every backend must overwrite the &quot;Not implemented&quot; methods</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # and provide an implementation specific to the storage.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    # Also, before returning the objects, they should be wrapped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    # inside the appropriate Bitcoin::Storage::Models class.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    class StoreBase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      # main branch (longest valid chain)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      MAIN = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      # side branch (connected, valid, but too short)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">      SIDE = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      # orphan branch (not connected to main branch / genesis block)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      ORPHAN = 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(config = {}, getblocks_callback = nil)</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="46">
          <span class="hits">62</span>
          
          <code class="ruby">        @config = config</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="47">
          <span class="hits">62</span>
          
          <code class="ruby">        @getblocks_callback = getblocks_callback</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="48">
          <span class="hits">62</span>
          
          <code class="ruby">        @log    = config[:log] || Bitcoin::Storage.log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      # reset the store; delete all data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      def reset</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      # store given block +blk+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # determine branch/chain and dept of block. trigger reorg if side branch becomes longer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # than current main chain and connect orpans.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      def store_block blk</code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="60">
          <span class="hits">422</span>
          
          <code class="ruby">        log.debug { &quot;new block #{blk.hash}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="62">
          <span class="hits">422</span>
          
          <code class="ruby">        existing = get_block(blk.hash)</code>
        </li>
      
        <li class="covered" data-hits="422" data-linenumber="63">
          <span class="hits">422</span>
          
          <code class="ruby">        if existing &amp;&amp; existing.chain == MAIN</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="64">
          <span class="hits">4</span>
          
          <code class="ruby">          log.debug { &quot;=&gt; exists (#{existing.depth}, #{existing.chain})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="65">
          <span class="hits">4</span>
          
          <code class="ruby">          return [existing.depth, existing.chain]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="418" data-linenumber="68">
          <span class="hits">418</span>
          
          <code class="ruby">        prev_block = get_block(blk.prev_block.reverse_hth)</code>
        </li>
      
        <li class="covered" data-hits="418" data-linenumber="69">
          <span class="hits">418</span>
          
          <code class="ruby">        validator = blk.validator(self, prev_block)</code>
        </li>
      
        <li class="covered" data-hits="418" data-linenumber="70">
          <span class="hits">418</span>
          
          <code class="ruby">        validator.validate(rules: [:syntax], raise_errors: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="416" data-linenumber="72">
          <span class="hits">416</span>
          
          <code class="ruby">        if !prev_block || prev_block.chain == ORPHAN</code>
        </li>
      
        <li class="covered" data-hits="158" data-linenumber="73">
          <span class="hits">158</span>
          
          <code class="ruby">          if blk.hash == Bitcoin.network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="92" data-linenumber="74">
          <span class="hits">92</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; genesis (0)&quot; }</code>
        </li>
      
        <li class="covered" data-hits="92" data-linenumber="75">
          <span class="hits">92</span>
          
          <code class="ruby">            return persist_block(blk, MAIN, 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="77">
          <span class="hits">66</span>
          
          <code class="ruby">            depth = prev_block ? prev_block.depth + 1 : 0</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="78">
          <span class="hits">66</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; orphan (#{depth})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="79">
          <span class="hits">66</span>
          
          <code class="ruby">            return  unless in_sync?</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="80">
          <span class="hits">66</span>
          
          <code class="ruby">            return persist_block(blk, ORPHAN, depth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="258" data-linenumber="83">
          <span class="hits">258</span>
          
          <code class="ruby">        depth = prev_block.depth + 1</code>
        </li>
      
        <li class="covered" data-hits="258" data-linenumber="84">
          <span class="hits">258</span>
          
          <code class="ruby">        if prev_block.chain == MAIN</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="85">
          <span class="hits">251</span>
          
          <code class="ruby">          if prev_block == get_head</code>
        </li>
      
        <li class="covered" data-hits="246" data-linenumber="86">
          <span class="hits">246</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; main (#{depth})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="246" data-linenumber="87">
          <span class="hits">246</span>
          
          <code class="ruby">            validator.validate(rules: [:context], raise_errors: true)</code>
        </li>
      
        <li class="covered" data-hits="244" data-linenumber="88">
          <span class="hits">244</span>
          
          <code class="ruby">            return persist_block(blk, MAIN, depth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="90">
          <span class="hits">5</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; side (#{depth})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="91">
          <span class="hits">5</span>
          
          <code class="ruby">            return persist_block(blk, SIDE, depth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="94">
          <span class="hits">7</span>
          
          <code class="ruby">          head = get_head</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="95">
          <span class="hits">7</span>
          
          <code class="ruby">          if prev_block.depth + 1 &lt;= head.depth</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="96">
          <span class="hits">2</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; side (#{depth})&quot; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">            return persist_block(blk, SIDE, depth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="99">
          <span class="hits">5</span>
          
          <code class="ruby">            log.debug { &quot;=&gt; reorg&quot; }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="100">
          <span class="hits">5</span>
          
          <code class="ruby">            new_main, new_side = [], []</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="101">
          <span class="hits">5</span>
          
          <code class="ruby">            fork_block = prev_block</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="102">
          <span class="hits">5</span>
          
          <code class="ruby">            while fork_block.chain != MAIN</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="103">
          <span class="hits">7</span>
          
          <code class="ruby">              new_main &lt;&lt; fork_block.hash</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="104">
          <span class="hits">7</span>
          
          <code class="ruby">              fork_block = fork_block.get_prev_block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="106">
          <span class="hits">5</span>
          
          <code class="ruby">            b = fork_block</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="107">
          <span class="hits">5</span>
          
          <code class="ruby">            while b = b.get_next_block</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="108">
          <span class="hits">7</span>
          
          <code class="ruby">              new_side &lt;&lt; b.hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="110">
          <span class="hits">5</span>
          
          <code class="ruby">            log.debug { &quot;new main: #{new_main.inspect}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="111">
          <span class="hits">5</span>
          
          <code class="ruby">            log.debug { &quot;new side: #{new_side.inspect}&quot; }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="112">
          <span class="hits">5</span>
          
          <code class="ruby">            update_blocks([[new_side, {:chain =&gt; SIDE}]])</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="113">
          <span class="hits">12</span>
          
          <code class="ruby">            new_main.each {|b| get_block(b).validator(self).validate(raise_errors: true) }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="114">
          <span class="hits">4</span>
          
          <code class="ruby">            update_blocks([[new_main, {:chain =&gt; MAIN}]])</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="115">
          <span class="hits">4</span>
          
          <code class="ruby">            return persist_block(blk, MAIN, depth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      # persist given block +blk+ to storage.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">      def persist_block(blk)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      # update +attrs+ for block with given +hash+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      # typically used to update chain.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">      def update_block(hash, attrs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      # store given +tx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">      def store_tx(tx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      # check if block with given +blk_hash+ is already stored</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">      def has_block(blk_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      # check if tx with given +tx_hash+ is already stored</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">      def has_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      # get the hash of the leading block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_head</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      # return depth of the head block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_depth</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">      # compute blockchain locator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_locator pointer = get_head</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">        if @locator</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">          locator, head = @locator</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">          if head == get_head</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">            return locator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">        return [(&quot;\x00&quot;*32).hth]  if get_depth == -1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">        locator = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">        step = 1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">        while pointer &amp;&amp; pointer.hash != Bitcoin::network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="169">
          <span class="hits">3</span>
          
          <code class="ruby">          locator &lt;&lt; pointer.hash</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="170">
          <span class="hits">3</span>
          
          <code class="ruby">          depth = pointer.depth - step</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="171">
          <span class="hits">3</span>
          
          <code class="ruby">          break unless depth &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="172">
          <span class="hits">2</span>
          
          <code class="ruby">          prev_block = get_block_by_depth(depth) # TODO</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="173">
          <span class="hits">2</span>
          
          <code class="ruby">          break unless prev_block</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="174">
          <span class="hits">2</span>
          
          <code class="ruby">          pointer = prev_block</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="175">
          <span class="hits">2</span>
          
          <code class="ruby">          step *= 2  if locator.size &gt; 10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">        locator &lt;&lt; Bitcoin::network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">        @locator = [locator, get_head]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">        locator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      # get block with given +blk_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block(blk_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">      # get block with given +depth+ from main chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_depth(depth)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">      # get block with given +prev_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_prev_hash(prev_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      # get block that includes tx with given +tx_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      # get block by given +block_id+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_block_by_id(block_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">      # get corresponding txin for the txout in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">      # transaction +tx_hash+ with index +txout_idx+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_txin_for_txout(tx_hash, txout_idx)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      # get tx with given +tx_hash+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">      # get tx with given +tx_id+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_tx_by_id(tx_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">      # collect all txouts containing the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">      # given +script+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_txouts_for_pk_script(script)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">        raise &quot;Not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      # collect all txouts containing a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      # standard tx to given +address+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="231">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_txouts_for_address(address, unconfirmed = false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">        hash160 = Bitcoin.hash160_from_address(address)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">        get_txouts_for_hash160(hash160, unconfirmed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      # get balance for given +hash160+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_balance(hash160, unconfirmed = false)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="238">
          <span class="hits">10</span>
          
          <code class="ruby">        txouts = get_txouts_for_hash160(hash160, unconfirmed)</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="239">
          <span class="hits">32</span>
          
          <code class="ruby">        unspent = txouts.select {|o| o.get_next_in.nil?}</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="240">
          <span class="hits">17</span>
          
          <code class="ruby">        unspent.map(&amp;:value).inject {|a,b| a+=b; a} || 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">        nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      # import satoshi bitcoind blk0001.dat blockchain file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">      def import filename, max_depth = nil</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="247">
          <span class="hits">4</span>
          
          <code class="ruby">        File.open(filename) do |file|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="248">
          <span class="hits">4</span>
          
          <code class="ruby">          until file.eof?</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="249">
          <span class="hits">8</span>
          
          <code class="ruby">            magic = file.read(4)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="250">
          <span class="hits">8</span>
          
          <code class="ruby">            raise &quot;invalid network magic&quot;  unless Bitcoin.network[:magic_head] == magic</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="251">
          <span class="hits">8</span>
          
          <code class="ruby">            size = file.read(4).unpack(&quot;L&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="252">
          <span class="hits">8</span>
          
          <code class="ruby">            blk = Bitcoin::P::Block.new(file.read(size))</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="253">
          <span class="hits">8</span>
          
          <code class="ruby">            depth, chain = store_block(blk)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="254">
          <span class="hits">8</span>
          
          <code class="ruby">            break  if max_depth &amp;&amp; depth &gt;= max_depth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="259">
          <span class="hits">1</span>
          
          <code class="ruby">      def in_sync?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">        (get_head &amp;&amp; (Time.now - get_head.time).to_i &lt; 3600) ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1d2f3285b72675d82f9d16bd6660cd2e089bdc3a">
  <div class="header">
    <h3>lib/bitcoin/validation.rb</h3>
    <h4><span class="green">97.76 %</span> covered</h4>
    <div>
      <b>134</b> relevant lines. 
      <span class="green"><b>131</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Validation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # maximum size of a block (in bytes)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_BLOCK_SIZE = 1_000_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # maximum number of signature operations in a block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_BLOCK_SIGOPS = MAX_BLOCK_SIZE / 50</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # the number of base units (&quot;satoshis&quot;) that make up one bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  COIN = 100_000_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # total number of base units in existence</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_MONEY = 21_000_000 * COIN</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # maximum integer value</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  INT_MAX = 0xffffffff</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # number of confirmations required before coinbase tx can be spent</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  COINBASE_MATURITY = 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # interval (in blocks) for difficulty retarget</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  RETARGET = 2016</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # interval (in blocks) for mining reward reduction</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  REWARD_DROP = 210_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  class ValidationError &lt; StandardError</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  class Block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :block, :store, :prev_block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    RULES = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      syntax: [:hash, :tx_list, :bits, :max_timestamp, :coinbase, :coinbase_scriptsig, :mrkl_root, :transactions_syntax],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      context: [:prev_hash, :difficulty, :coinbase_value, :min_timestamp, :transactions_context]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    # validate block rules. +opts+ are:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    # rules:: which rulesets to validate (default: [:syntax, :context])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    # raise_errors:: whether to raise ValidationError on failure (default: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    def validate(opts = {})</code>
        </li>
      
        <li class="covered" data-hits="680" data-linenumber="43">
          <span class="hits">680</span>
          
          <code class="ruby">      return true if block.hash == Bitcoin.network[:genesis_hash]</code>
        </li>
      
        <li class="covered" data-hits="588" data-linenumber="44">
          <span class="hits">588</span>
          
          <code class="ruby">      opts[:rules] ||= [:syntax, :context]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="588" data-linenumber="46">
          <span class="hits">588</span>
          
          <code class="ruby">      opts[:rules].each do |name|</code>
        </li>
      
        <li class="covered" data-hits="595" data-linenumber="47">
          <span class="hits">595</span>
          
          <code class="ruby">        store.log.info { &quot;validating block #{name} #{block.hash} (#{block.to_payload.bytesize} bytes)&quot; }</code>
        </li>
      
        <li class="covered" data-hits="595" data-linenumber="48">
          <span class="hits">595</span>
          
          <code class="ruby">        RULES[name].each.with_index do |rule, i|</code>
        </li>
      
        <li class="covered" data-hits="3963" data-linenumber="49">
          <span class="hits">3963</span>
          
          <code class="ruby">          unless send(rule)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="50">
          <span class="hits">14</span>
          
          <code class="ruby">            raise ValidationError, &quot;block error: #{name} check #{i} - #{rule} failed&quot;  if opts[:raise_errors]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">            return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="574" data-linenumber="55">
          <span class="hits">574</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    # setup new validator for given +block+, validating context with +store+,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    # optionally passing the +prev_block+ for optimization.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize block, store, prev_block = nil</code>
        </li>
      
        <li class="covered" data-hits="321" data-linenumber="61">
          <span class="hits">321</span>
          
          <code class="ruby">      @block, @store = block, store</code>
        </li>
      
        <li class="covered" data-hits="321" data-linenumber="62">
          <span class="hits">321</span>
          
          <code class="ruby">      @prev_block = prev_block || store.get_block(block.prev_block.reverse_hth)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    # check that block hash matches header</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash</code>
        </li>
      
        <li class="covered" data-hits="342" data-linenumber="67">
          <span class="hits">342</span>
          
          <code class="ruby">      block.hash == block.recalc_block_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    # check that block has at least one tx (the coinbase)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    def tx_list</code>
        </li>
      
        <li class="covered" data-hits="341" data-linenumber="72">
          <span class="hits">341</span>
          
          <code class="ruby">      block.tx.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    # check that block hash matches claimed bits</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    def bits</code>
        </li>
      
        <li class="covered" data-hits="340" data-linenumber="77">
          <span class="hits">340</span>
          
          <code class="ruby">      block.hash.to_i(16) &lt;= Bitcoin.decode_compact_bits(block.bits).to_i(16)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    # check that block time is not greater than max</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def max_timestamp</code>
        </li>
      
        <li class="covered" data-hits="339" data-linenumber="82">
          <span class="hits">339</span>
          
          <code class="ruby">      Time.at(block.time) &lt; Time.now + 2*60*60</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    # check that coinbase is present</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    def coinbase</code>
        </li>
      
        <li class="covered" data-hits="700" data-linenumber="87">
          <span class="hits">700</span>
          
          <code class="ruby">      coinbase, *rest = block.tx.map{|t| t.inputs.size == 1 &amp;&amp; t.inputs.first.coinbase? }</code>
        </li>
      
        <li class="covered" data-hits="338" data-linenumber="88">
          <span class="hits">338</span>
          
          <code class="ruby">      coinbase &amp;&amp; rest.none?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # check that coinbase scriptsig is valid</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    def coinbase_scriptsig</code>
        </li>
      
        <li class="covered" data-hits="336" data-linenumber="93">
          <span class="hits">336</span>
          
          <code class="ruby">      block.tx.first.in.first.script_sig.bytesize.between?(2,100)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    # check that coinbase value is valid; no more than reward + fees</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    def coinbase_value</code>
        </li>
      
        <li class="covered" data-hits="253" data-linenumber="98">
          <span class="hits">253</span>
          
          <code class="ruby">      reward = ((50.0 / (2 ** (store.get_depth / REWARD_DROP.to_f).floor)) * 1e8).to_i</code>
        </li>
      
        <li class="covered" data-hits="253" data-linenumber="99">
          <span class="hits">253</span>
          
          <code class="ruby">      fees = block.tx[1..-1].map.with_index do |t, idx|</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="100">
          <span class="hits">14</span>
          
          <code class="ruby">        val = tx_validators[idx]</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="101">
          <span class="hits">14</span>
          
          <code class="ruby">        t.in.map.with_index {|i, idx|</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="102">
          <span class="hits">14</span>
          
          <code class="ruby">          val.prev_txs[idx].out[i.prev_out_index].value rescue 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        }.inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      end.inject(:+) || 0</code>
        </li>
      
        <li class="covered" data-hits="253" data-linenumber="105">
          <span class="hits">253</span>
          
          <code class="ruby">      coinbase_output = block.tx[0].out.map(&amp;:value).inject(:+)</code>
        </li>
      
        <li class="covered" data-hits="253" data-linenumber="106">
          <span class="hits">253</span>
          
          <code class="ruby">      coinbase_output &lt;= reward + fees</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    # check that merkle root matches transaction hashes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    def mrkl_root</code>
        </li>
      
        <li class="covered" data-hits="334" data-linenumber="111">
          <span class="hits">334</span>
          
          <code class="ruby">      block.mrkl_root.reverse_hth == Bitcoin.hash_mrkl_tree(block.tx.map(&amp;:hash))[-1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">    def prev_hash</code>
        </li>
      
        <li class="covered" data-hits="253" data-linenumber="115">
          <span class="hits">253</span>
          
          <code class="ruby">      @prev_block &amp;&amp; @prev_block.hash == block.prev_block.reverse_hth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    # check that bits satisfy required difficulty</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    def difficulty</code>
        </li>
      
        <li class="covered" data-hits="253" data-linenumber="120">
          <span class="hits">253</span>
          
          <code class="ruby">      true # next_bits_required == block.bits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    # check that timestamp is not too old</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    def min_timestamp</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="125">
          <span class="hits">251</span>
          
          <code class="ruby">      true # TODO</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    # check transactions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    def transactions_syntax</code>
        </li>
      
        <li class="covered" data-hits="332" data-linenumber="130">
          <span class="hits">332</span>
          
          <code class="ruby">      tx_validators.all?{|v|</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="131">
          <span class="hits">20</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="132">
          <span class="hits">20</span>
          
          <code class="ruby">          v.validate(rules: [:syntax], raise_errors: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">        rescue ValidationError</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">          store.log.info { $!.message }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    def transactions_context</code>
        </li>
      
        <li class="covered" data-hits="251" data-linenumber="141">
          <span class="hits">251</span>
          
          <code class="ruby">      tx_validators.all?{|v|</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="142">
          <span class="hits">14</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="143">
          <span class="hits">14</span>
          
          <code class="ruby">          v.validate(rules: [:context], raise_errors: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">        rescue ValidationError</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">          store.log.info { $!.message }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">          return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">    def tx_validators</code>
        </li>
      
        <li class="covered" data-hits="617" data-linenumber="154">
          <span class="hits">617</span>
          
          <code class="ruby">      @tx_validators ||= block.tx[1..-1].map {|tx| tx.validator(store, block) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    # def next_bits_required</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    #   limit = Bitcoin.network[:proof_of_work_limit]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    #   return limit  if prev_block.hash == Bitcoin.network[:genesis_hash]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    #   return block.bits  if (prev_block.depth + 1) % RETARGET != 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    #   target = 2 * 60 * 60 * 24</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    #   min = target / 4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">    #   max = target * 4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    #   diff = prev_block.time - store.get_block_by_depth(prev_block.depth - RETARGET + 1).time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    #   diff = min  if diff &lt; min</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    #   diff = max  if diff &gt; max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    #   retarget = Bitcoin.decode_compact_bits(prev_block.bits).to_i(16) * diff / target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    #   if retarget &gt; Bitcoin.decode_compact_bits(limit).to_i(16)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    #     limit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">    #   else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    #     Bitcoin.encode_compact_bits(retarget.to_s(16))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">    KNOWN_EXCEPTIONS = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      &quot;00000000000a4d0a398161ffc163c503763b1f4360639393e0e4c8e300e0caec&quot;, # BIP30 exception</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      &quot;00000000000743f190a18c5577a3c2d2a1f610ae9601ac046a38084ccb7cd721&quot;, # BIP30 exception</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">  class Tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :tx, :store</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">    RULES = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      syntax: [:hash, :lists, :max_size, :output_values, :inputs, :lock_time, :min_size, :standard],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">      context: [:prev_out, :signatures, :spent, :input_values, :output_sum]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">    # validate tx rules. +opts+ are:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    # rules:: which rulesets to validate (default: [:syntax, :context])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    # raise_errors:: whether to raise ValidationError on failure (default: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">    def validate(opts = {})</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="197">
          <span class="hits">51</span>
          
          <code class="ruby">      return true  if matches_known_exception</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="198">
          <span class="hits">51</span>
          
          <code class="ruby">      opts[:rules] ||= [:syntax, :context]</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="199">
          <span class="hits">51</span>
          
          <code class="ruby">      opts[:rules].each do |name|</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="200">
          <span class="hits">58</span>
          
          <code class="ruby">        store.log.info { &quot;validating tx #{name} #{tx.hash} (#{tx.to_payload.bytesize} bytes)&quot; }</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="201">
          <span class="hits">58</span>
          
          <code class="ruby">        RULES[name].each.with_index do |rule, i|</code>
        </li>
      
        <li class="covered" data-hits="326" data-linenumber="202">
          <span class="hits">326</span>
          
          <code class="ruby">          unless send(rule)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="203">
          <span class="hits">17</span>
          
          <code class="ruby">            raise ValidationError, &quot;tx error: #{name} check #{i} - #{rule} failed&quot;  if opts[:raise_errors]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="204">
          <span class="hits">1</span>
          
          <code class="ruby">            return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="208">
          <span class="hits">34</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">    KNOWN_EXCEPTIONS = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      # p2sh with invalid inner script, accepted by old miner before 4-2012 switchover</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      &quot;6a26d2ecb67f27d1fa5524763b49029d7106e91e3cc05743073461a719776192&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">    # setup new validator for given +tx+, validating context with +store+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">    # also needs the +block+ to find prev_outs for chains of tx inside one block.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize tx, store, block = nil</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="219">
          <span class="hits">34</span>
          
          <code class="ruby">      @tx, @store, @block = tx, store, block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    # check if hash matches one of the KNOWN_EXCEPTIONS.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">    def matches_known_exception</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="224">
          <span class="hits">51</span>
          
          <code class="ruby">      KNOWN_EXCEPTIONS.include?(@tx.hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">    # check that tx hash matches data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">    def hash</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="229">
          <span class="hits">37</span>
          
          <code class="ruby">      tx.hash == tx.generate_hash(tx.to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">    # check that tx has at least one input and one output</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">    def lists</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="234">
          <span class="hits">32</span>
          
          <code class="ruby">      tx.in.any? &amp;&amp; tx.out.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">    # check that tx size doesn't exceed MAX_BLOCK_SIZE.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">    def max_size</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="239">
          <span class="hits">30</span>
          
          <code class="ruby">      tx.to_payload.bytesize &lt;= MAX_BLOCK_SIZE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    # check that total output value doesn't exceed MAX_MONEY.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="243">
          <span class="hits">1</span>
          
          <code class="ruby">    def output_values</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="244">
          <span class="hits">60</span>
          
          <code class="ruby">      tx.out.inject(0) {|e, out| e + out.value } &lt;= MAX_MONEY</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">    # check that none of the inputs is coinbase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">    # (coinbase tx do not get validated)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">    def inputs</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="250">
          <span class="hits">28</span>
          
          <code class="ruby">      tx.inputs.none?(&amp;:coinbase?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">    # check that lock_time doesn't exceed INT_MAX</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">    def lock_time</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="255">
          <span class="hits">27</span>
          
          <code class="ruby">      tx.lock_time &lt;= INT_MAX</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">    # check that min_size is at least 86 bytes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    # (smaller tx can't be valid / do anything useful)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">    def min_size</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="261">
          <span class="hits">26</span>
          
          <code class="ruby">      tx.to_payload.bytesize &gt;= 86</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    # check that tx matches &quot;standard&quot; rules.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">    # this is currently disabled since not all miners enforce it.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">    def standard</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="267">
          <span class="hits">26</span>
          
          <code class="ruby">      return true  # not enforced by all miners</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">      tx.out.all? {|o| Bitcoin::Script.new(o.pk_script).is_standard? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">    # check that all prev_outs exist</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">    # (and are in a block in the main chain, or the current block; see #prev_txs)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="273">
          <span class="hits">1</span>
          
          <code class="ruby">    def prev_out</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="274">
          <span class="hits">21</span>
          
          <code class="ruby">      return false  unless prev_txs.size == tx.in.size</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="275">
          <span class="hits">40</span>
          
          <code class="ruby">      tx.in.reject.with_index {|txin, idx| prev_txs[idx].out[txin.prev_out_index] rescue false }.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">    # TODO: validate coinbase maturity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">    # check that all input signatures are valid</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="281">
          <span class="hits">1</span>
          
          <code class="ruby">    def signatures</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="282">
          <span class="hits">38</span>
          
          <code class="ruby">      tx.in.map.with_index {|txin, idx| tx.verify_input_signature(idx, prev_txs[idx]) }.all?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    # check that none of the prev_outs are already spent in the main chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="286">
          <span class="hits">1</span>
          
          <code class="ruby">    def spent</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="287">
          <span class="hits">18</span>
          
          <code class="ruby">      tx.in.map.with_index {|txin, idx|</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="288">
          <span class="hits">18</span>
          
          <code class="ruby">        next false  if @block &amp;&amp; @block.tx.include?(prev_txs[idx])</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="289">
          <span class="hits">17</span>
          
          <code class="ruby">        next false  unless next_in = prev_txs[idx].out[txin.prev_out_index].get_next_in</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="290">
          <span class="hits">3</span>
          
          <code class="ruby">        next false  unless next_tx = next_in.get_tx</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="291">
          <span class="hits">3</span>
          
          <code class="ruby">        next false  unless next_block = next_tx.get_block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="292">
          <span class="hits">1</span>
          
          <code class="ruby">        next_block.chain == Bitcoin::Storage::Backends::StoreBase::MAIN</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">      }.none?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">    # check that the total input value doesn't exceed MAX_MONEY</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">    def input_values</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="298">
          <span class="hits">17</span>
          
          <code class="ruby">      tx.in.map.with_index {|txin, idx| prev_txs[idx].out[txin.prev_out_index].value }</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="299">
          <span class="hits">17</span>
          
          <code class="ruby">        .inject(:+) &lt; MAX_MONEY</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">    # check that the total output value doesn't exceed the total input value</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="303">
          <span class="hits">1</span>
          
          <code class="ruby">    def output_sum</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="304">
          <span class="hits">16</span>
          
          <code class="ruby">      tx.in.map.with_index {|txin, idx| prev_txs[idx].out[txin.prev_out_index].value }</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="305">
          <span class="hits">16</span>
          
          <code class="ruby">        .inject(:+) &gt;= tx.out.map(&amp;:value).inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">    # collect prev_txs needed to verify the inputs of this tx.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">    # only returns tx that are in a block in the main chain or the current block.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="310">
          <span class="hits">1</span>
          
          <code class="ruby">    def prev_txs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">      @prev_txs ||= tx.in.map {|i|</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="312">
          <span class="hits">20</span>
          
          <code class="ruby">        prev_tx = store.get_tx(i.prev_out.reverse_hth)</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="313">
          <span class="hits">20</span>
          
          <code class="ruby">        next nil  if !prev_tx &amp;&amp; !@block</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="315">
          <span class="hits">20</span>
          
          <code class="ruby">        if store.db &amp;&amp; store.db.is_a?(Sequel::Database)</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="316">
          <span class="hits">20</span>
          
          <code class="ruby">          block = store.db[:blk][id: prev_tx.blk_id]  if prev_tx</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="317">
          <span class="hits">20</span>
          
          <code class="ruby">          next prev_tx  if block &amp;&amp; block[:chain] == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">          next prev_tx  if prev_tx.get_block &amp;&amp; prev_tx.get_block.chain == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="321">
          <span class="hits">2</span>
          
          <code class="ruby">        next  nil if !@block</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="322">
          <span class="hits">6</span>
          
          <code class="ruby">        @block.tx.find {|t| t.binary_hash == i.prev_out }</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="323">
          <span class="hits">137</span>
          
          <code class="ruby">      }.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0385197f5a931438685a32169b01ce2549a5ad96">
  <div class="header">
    <h3>lib/bitcoin/version.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  VERSION = &quot;0.0.1&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="45d4f28fae6f671f74cefe8a341bf4686a58205e">
  <div class="header">
    <h3>lib/bitcoin/wallet/coinselector.rb</h3>
    <h4><span class="green">92.86 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # select unspent txouts to be used by the Wallet when creating a new transaction</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class SimpleCoinSelector</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    # create coinselector with given +txouts+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize txouts</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">      @txouts = txouts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # select txouts needed to spend +value+ btc (base units)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    def select(value)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="13">
          <span class="hits">4</span>
          
          <code class="ruby">      txouts = []</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="14">
          <span class="hits">4</span>
          
          <code class="ruby">      @txouts.each do |txout|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="15">
          <span class="hits">12</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="16">
          <span class="hits">12</span>
          
          <code class="ruby">          next  if txout.get_next_in</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="17">
          <span class="hits">10</span>
          
          <code class="ruby">          next  unless txout.get_address</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="18">
          <span class="hits">10</span>
          
          <code class="ruby">          next  unless txout.get_tx.get_block</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="19">
          <span class="hits">8</span>
          
          <code class="ruby">          txouts &lt;&lt; txout</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="20">
          <span class="hits">8</span>
          
          <code class="ruby">          return txouts  if txouts.map(&amp;:value).inject(:+) &gt;= value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">          p $!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5b4d2b3b2b9a07acc2e0db4dcc389a361c4af330">
  <div class="header">
    <h3>lib/bitcoin/wallet/keygenerator.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>27</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # Deterministic key generator as described in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # https://bitcointalk.org/index.php?topic=11665.0.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Takes a seed and generates an arbitrary amount of keys.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Protects against brute-force attacks by requiring the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # key hash to fit a difficulty target, much like the block chain.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  class KeyGenerator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # difficulty target (0x0000FFFF00000000000000000000000000000000000000000000000000000000)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    DEFAULT_TARGET = 0x0000FFFF00000000000000000000000000000000000000000000000000000000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :seed, :nonce, :target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # Initialize key generator with optional +seed+ and +nonce+ and +target+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # [seed] the seed data for the keygenerator (default: random)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # [nonce] the nonce required to satisfy the target (default: computed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # [target] custom difficulty target (default: DEFAULT_TARGET)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # Example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    #  g = KeyGenerator.new # random seed, computed nonce, default target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    #  KeyGenerator.new(g.seed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    #  KeyGenerator.new(g.seed, g.nonce)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    #  g.get_key(0) #=&gt; &lt;Bitcoin::Key&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # Note: When initializing without seed, you should obviously save the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # seed once it is generated. Saving the nonce is optional; it only saves time.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize seed = nil, nonce = nil, target = nil</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="30">
          <span class="hits">15</span>
          
          <code class="ruby">      @seed = seed || OpenSSL::Random.random_bytes(64)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="31">
          <span class="hits">15</span>
          
          <code class="ruby">      @target = target || DEFAULT_TARGET</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="32">
          <span class="hits">15</span>
          
          <code class="ruby">      @nonce = check_nonce(nonce)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    # get key number +n+ from chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_key(n = 0)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="37">
          <span class="hits">24</span>
          
          <code class="ruby">      key = get_hash(@seed, @nonce)</code>
        </li>
      
        <li class="covered" data-hits="118" data-linenumber="38">
          <span class="hits">118</span>
          
          <code class="ruby">      (n + 1).times { key = sha256(key) }</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="39">
          <span class="hits">24</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="40">
          <span class="hits">24</span>
          
          <code class="ruby">      Bitcoin::Key.new(key.unpack(&quot;H*&quot;)[0])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # find a nonce that leads to the privkey satisfying the target</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    def find_nonce</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="45">
          <span class="hits">7</span>
          
          <code class="ruby">      n = 0</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="46">
          <span class="hits">7</span>
          
          <code class="ruby">      n += 1  while !check_target(get_hash(@seed, n))</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="47">
          <span class="hits">7</span>
          
          <code class="ruby">      n</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    # check the nonce; compute if missing, raise if invalid.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    def check_nonce(nonce)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="54">
          <span class="hits">15</span>
          
          <code class="ruby">      return find_nonce  unless nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      # check_target(get_hash(@seed, nonce)) ? nonce : find_nonce</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="56">
          <span class="hits">8</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Nonce invalid.&quot;  unless check_target(get_hash(@seed, nonce))</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="57">
          <span class="hits">7</span>
          
          <code class="ruby">      nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    # check if given +hash+ satisfies the difficulty target</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    def check_target(hash)</code>
        </li>
      
        <li class="covered" data-hits="5835" data-linenumber="62">
          <span class="hits">5835</span>
          
          <code class="ruby">      hash.unpack(&quot;H*&quot;)[0].to_i(16) &lt; @target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    # compute a single SHA256 hash for +d+.</code>
        </li>
      
        <li class="covered" data-hits="17672" data-linenumber="66">
          <span class="hits">17672</span>
          
          <code class="ruby">    def sha256(d); Digest::SHA256.digest(d); end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    # get the hash corresponding to +seed+ and +n+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_hash(seed, n)</code>
        </li>
      
        <li class="covered" data-hits="5859" data-linenumber="70">
          <span class="hits">5859</span>
          
          <code class="ruby">      sha256( sha256(seed) + sha256(n.to_s) )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="02f674ef66c656bec0454c93dca59c930de55849">
  <div class="header">
    <h3>lib/bitcoin/wallet/keystore.rb</h3>
    <h4><span class="green">91.74 %</span> covered</h4>
    <div>
      <b>109</b> relevant lines. 
      <span class="green"><b>100</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require 'json'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require 'stringio'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # JSON-file-based keystore used by the Wallet.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  class SimpleKeyStore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # Initialize keystore.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # [config] Hash of settings ({:file =&gt; &quot;/foo/bar.json&quot;})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize config</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="14">
          <span class="hits">70</span>
          
          <code class="ruby">      @config = Hash[config.map{|k,v|[k.to_sym,v]}]</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="15">
          <span class="hits">35</span>
          
          <code class="ruby">      @keys = []</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="16">
          <span class="hits">35</span>
          
          <code class="ruby">      load_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # List all stored keys.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    def keys(need = nil)</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="21">
          <span class="hits">38</span>
          
          <code class="ruby">      @keys.select do |key|</code>
        </li>
      
        <li class="covered" data-hits="114" data-linenumber="22">
          <span class="hits">114</span>
          
          <code class="ruby">        next !(key[:hidden] &amp;&amp; key[:hidden] == &quot;true&quot;)  unless need</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="23">
          <span class="hits">30</span>
          
          <code class="ruby">        case need</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        when :label</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="25">
          <span class="hits">6</span>
          
          <code class="ruby">          !!key[:label]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        when :pub</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="27">
          <span class="hits">6</span>
          
          <code class="ruby">          !!key[:key].pub</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        when :priv</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="29">
          <span class="hits">6</span>
          
          <code class="ruby">          !!key[:key].priv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        when :hidden</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="31">
          <span class="hits">6</span>
          
          <code class="ruby">          !!key[:hidden]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        when :mine</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="33">
          <span class="hits">6</span>
          
          <code class="ruby">          !!key[:mine]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # Get key for given +label+, +addr+ or +pubkey+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    def key(name)</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="40">
          <span class="hits">25</span>
          
          <code class="ruby">      find_key(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # Generate and store a new key.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    def new_key(label = nil)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="45">
          <span class="hits">4</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Label #{label} already in use&quot;  if label &amp;&amp; find_key(label)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="46">
          <span class="hits">3</span>
          
          <code class="ruby">      key = Bitcoin::Key.generate</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="47">
          <span class="hits">3</span>
          
          <code class="ruby">      @keys &lt;&lt; {:label =&gt; label, :addr =&gt; key.addr, :key =&gt; key}</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="48">
          <span class="hits">3</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="49">
          <span class="hits">3</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    # Add a key which can consist only of +addr+ and +label+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_key key</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="54">
          <span class="hits">4</span>
          
          <code class="ruby">      label = key[:label]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="55">
          <span class="hits">4</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Label #{label} already in use&quot;  if label &amp;&amp; find_key(label)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="56">
          <span class="hits">3</span>
          
          <code class="ruby">      addr = key[:addr]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="57">
          <span class="hits">3</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Address #{addr} is invalid&quot;  if addr &amp;&amp; !Bitcoin.valid_address?(addr)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="58">
          <span class="hits">2</span>
          
          <code class="ruby">      @keys &lt;&lt; key</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">      key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    def label_key(name, label)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      find_key(name) do |key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        key[:label] = label</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">    def flag_key(name, flag, value)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">      find_key(name, true) do |key|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">        key[flag.to_sym] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    # Delete key for given +label+, +addr+ or +pubkey+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">    def delete(name)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="79">
          <span class="hits">2</span>
          
          <code class="ruby">      key = find_key(name)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="80">
          <span class="hits">2</span>
          
          <code class="ruby">      @keys.delete(key)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="81">
          <span class="hits">2</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    # Export key for given +name+ to base58 format.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    # (See Bitcoin::Key#to_base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    def export(name)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="87">
          <span class="hits">3</span>
          
          <code class="ruby">      find_key(name)[:key].to_base58 rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # Import key from given +base58+ string.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # (See Bitcoin::Key.from_base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    def import(base58, label = nil)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="93">
          <span class="hits">3</span>
          
          <code class="ruby">      raise ArgumentError, &quot;Label #{label} already in use&quot;  if label &amp;&amp; find_key(label)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="94">
          <span class="hits">2</span>
          
          <code class="ruby">      key = Bitcoin::Key.from_base58(base58)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="95">
          <span class="hits">2</span>
          
          <code class="ruby">      @keys &lt;&lt; {:label =&gt; label, :addr =&gt; key.addr, :key =&gt; key}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="96">
          <span class="hits">2</span>
          
          <code class="ruby">      save_keys</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">      key.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    # Load keys from file.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    # If file is empty this will generate a new key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    # and store it, creating the file.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">    def load_keys</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="104">
          <span class="hits">35</span>
          
          <code class="ruby">      loader = proc{|keys|</code>
        </li>
      
        <li class="covered" data-hits="820" data-linenumber="105">
          <span class="hits">820</span>
          
          <code class="ruby">        keys.map!{|k| Hash[k.map{|k,v| [k.to_sym, v] }]}</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="106">
          <span class="hits">35</span>
          
          <code class="ruby">        keys.map do |key|</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="107">
          <span class="hits">145</span>
          
          <code class="ruby">          key[:key] = Bitcoin::Key.new(key[:priv], key[:pub])</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="108">
          <span class="hits">145</span>
          
          <code class="ruby">          key[:priv], key[:pub] = nil</code>
        </li>
      
        <li class="covered" data-hits="145" data-linenumber="109">
          <span class="hits">145</span>
          
          <code class="ruby">          @keys &lt;&lt; key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="112">
          <span class="hits">35</span>
          
          <code class="ruby">      if @config[:file].is_a?(StringIO)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="113">
          <span class="hits">35</span>
          
          <code class="ruby">        json = JSON.load(@config[:file].read)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="114">
          <span class="hits">35</span>
          
          <code class="ruby">        loader.call(json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      elsif File.exist?(@config[:file])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">        json = JSON.load(File.read(@config[:file]))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        loader.call(json)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">        new_key; save_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    # Save keys to file.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    def save_keys</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="125">
          <span class="hits">11</span>
          
          <code class="ruby">      dumper = proc{|file|</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="126">
          <span class="hits">11</span>
          
          <code class="ruby">        keys = @keys.map do |key|</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="127">
          <span class="hits">62</span>
          
          <code class="ruby">          key = key.dup</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="128">
          <span class="hits">62</span>
          
          <code class="ruby">          if key[:key]</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="129">
          <span class="hits">60</span>
          
          <code class="ruby">            key[:priv] = key[:key].priv</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="130">
          <span class="hits">60</span>
          
          <code class="ruby">            key[:pub] = key[:key].pub</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="131">
          <span class="hits">60</span>
          
          <code class="ruby">            key.delete(:key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="133">
          <span class="hits">62</span>
          
          <code class="ruby">          key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="135">
          <span class="hits">11</span>
          
          <code class="ruby">        file.write(JSON.pretty_generate(keys))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="138">
          <span class="hits">11</span>
          
          <code class="ruby">      if @config[:file].is_a?(StringIO)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="139">
          <span class="hits">11</span>
          
          <code class="ruby">        @config[:file].reopen</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="140">
          <span class="hits">11</span>
          
          <code class="ruby">        dumper.call(@config[:file])</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="141">
          <span class="hits">11</span>
          
          <code class="ruby">        @config[:file].rewind</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      elsif File.exists?(@config[:file])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">        File.open(@config[:file], 'w'){|file| dumper.call(file) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    def find_key(name, hidden = false)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="150">
          <span class="hits">37</span>
          
          <code class="ruby">      key = if Bitcoin.valid_address?(name)</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="151">
          <span class="hits">65</span>
          
          <code class="ruby">              @keys.find{|k| k[:addr] == name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">            elsif name.size == 130</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="153">
          <span class="hits">4</span>
          
          <code class="ruby">              @keys.find{|k| k[:key].pub == name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="155">
          <span class="hits">67</span>
          
          <code class="ruby">              @keys.find{|k| k[:label] == name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="157">
          <span class="hits">37</span>
          
          <code class="ruby">      return nil  if !key || (!hidden &amp;&amp; key[:hidden] == &quot;true&quot;)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="158">
          <span class="hits">34</span>
          
          <code class="ruby">      block_given? ? yield(key) : key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  # Deterministic keystore.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">  class DeterministicKeyStore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :generator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    # Initialize keystore.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    # [config] Hash of settings ({:keys =&gt; 1, :seed =&gt; ..., :nonce =&gt; ...})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize config</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="171">
          <span class="hits">27</span>
          
          <code class="ruby">      @config = Hash[config.map{|k,v|[k.to_sym,v]}]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="172">
          <span class="hits">7</span>
          
          <code class="ruby">      @config[:keys] = (@config[:keys] || 1).to_i</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="173">
          <span class="hits">7</span>
          
          <code class="ruby">      @generator = Bitcoin::Wallet::KeyGenerator.new(@config[:seed], @config[:nonce])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    # List all keys upto configured limit.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">    def keys</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="178">
          <span class="hits">11</span>
          
          <code class="ruby">      1.upto(@config[:keys].to_i).map {|i| @generator.get_key(i) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    # Get key for given +addr+.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">    def key(addr)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="183">
          <span class="hits">2</span>
          
          <code class="ruby">      1.upto(@config[:keys].to_i).map do |i|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="184">
          <span class="hits">2</span>
          
          <code class="ruby">        key = @generator.get_key(i)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="185">
          <span class="hits">2</span>
          
          <code class="ruby">        return key  if key.addr == addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">    # Get new key (actually just increase the key limit).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">    def new_key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">      @config[:keys] += 1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">      @generator.get_key(@config[:keys])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    # Export key for given +addr+ to base58.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    # (See Bitcoin::Key.to_base58)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">    def export(addr)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">      key(addr).to_base58 rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e4537349f04bf547cb5970d59edb474b2c135d28">
  <div class="header">
    <h3>lib/bitcoin/wallet/txdp.rb</h3>
    <h4><span class="yellow">83.53 %</span> covered</h4>
    <div>
      <b>85</b> relevant lines. 
      <span class="green"><b>71</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Bitcoin::Wallet::TxDP</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :id, :tx, :inputs</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize tx = []</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="5">
          <span class="hits">6</span>
          
          <code class="ruby">    @id = Bitcoin.int_to_base58(rand(1e14))</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="6">
          <span class="hits">6</span>
          
          <code class="ruby">    @tx = tx</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="7">
          <span class="hits">6</span>
          
          <code class="ruby">    @inputs = []</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="8">
          <span class="hits">6</span>
          
          <code class="ruby">    return  unless tx.any?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    @tx[0].in.each_with_index do |input, i|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">      prev_out_hash = input.prev_out.reverse_hth</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">      prev_tx = @tx[1..-1].find {|tx| tx.hash == prev_out_hash}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      raise &quot;prev tx #{prev_out_hash} not found&quot;  unless prev_tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      prev_out = prev_tx.out[input.prev_out_index]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      raise &quot;prev out ##{input.prev_out_index} not found in tx #{@tx.hash}&quot;  unless prev_out</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      out_script = Bitcoin::Script.new(prev_out.pk_script)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      out_script.get_addresses.each do |addr|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">        add_sig(i, prev_out.value, addr, input.script_sig)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_sig(in_idx, value, addr, sig)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="23">
          <span class="hits">2</span>
          
          <code class="ruby">    sig = sig ? [[addr, sig.unpack(&quot;H*&quot;)[0]]] : []</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">    @inputs[in_idx] = [value, sig]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def sign_inputs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    @inputs.each_with_index do |txin, i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      input = @tx[0].in[i]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      prev_out_hash = input.prev_out.reverse_hth</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      prev_tx = @tx[1..-1].find {|tx| tx.hash == prev_out_hash}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      raise &quot;prev tx #{prev_out_hash} not found&quot;  unless prev_tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      prev_out = prev_tx.out[input.prev_out_index]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      raise &quot;prev out ##{input.prev_out_index} not found in tx #{@tx.hash}&quot;  unless prev_out</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      out_script = Bitcoin::Script.new(prev_out.pk_script)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      out_script.get_addresses.each do |addr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        sig = yield(@tx[0], prev_tx, i, addr)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        if sig</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">          @inputs[i][1] ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">          @inputs[i][1] &lt;&lt; [addr, sig]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">          break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def serialize</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="48">
          <span class="hits">4</span>
          
          <code class="ruby">    lines = []</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="49">
          <span class="hits">4</span>
          
          <code class="ruby">    lines &lt;&lt; &quot;-----BEGIN-TRANSACTION-#{@id}&quot;.ljust(80, '-')</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="50">
          <span class="hits">4</span>
          
          <code class="ruby">    size = [@tx.first.to_payload.bytesize].pack(&quot;C&quot;).ljust(2, &quot;\x00&quot;).reverse_hth</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="51">
          <span class="hits">4</span>
          
          <code class="ruby">    lines &lt;&lt; &quot;_TXDIST_#{Bitcoin.network[:magic_head].unpack(&quot;H*&quot;)[0]}_#{@id}_#{size}&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="52">
          <span class="hits">4</span>
          
          <code class="ruby">    tx = @tx.map(&amp;:to_payload).join.unpack(&quot;H*&quot;)[0]</code>
        </li>
      
        <li class="covered" data-hits="2864" data-linenumber="53">
          <span class="hits">2864</span>
          
          <code class="ruby">    tx_str = &quot;&quot;; tx.split('').each_with_index{|c,i| tx_str &lt;&lt; (i % 80 == 0 ? &quot;\n#{c}&quot; : c)}</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="54">
          <span class="hits">4</span>
          
          <code class="ruby">    lines &lt;&lt; tx_str.strip</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="55">
          <span class="hits">4</span>
          
          <code class="ruby">    @inputs.each_with_index do |input, idx|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="56">
          <span class="hits">4</span>
          
          <code class="ruby">      lines &lt;&lt; &quot;_TXINPUT_#{idx.to_s.rjust(2, '0')}_#{&quot;%.8f&quot; % (input[0].to_f / 1e8)}&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="57">
          <span class="hits">4</span>
          
          <code class="ruby">      next  unless input[1]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="58">
          <span class="hits">3</span>
          
          <code class="ruby">      input[1].each do |sig|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="59">
          <span class="hits">3</span>
          
          <code class="ruby">        size = [sig[1]].pack(&quot;H*&quot;).bytesize</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="60">
          <span class="hits">3</span>
          
          <code class="ruby">        size = [size].pack(&quot;C&quot;).ljust(2, &quot;\x00&quot;).reverse_hth</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="61">
          <span class="hits">3</span>
          
          <code class="ruby">        lines &lt;&lt; &quot;_SIG_#{sig[0]}_#{idx.to_s.rjust(2, '0')}_#{size}&quot;</code>
        </li>
      
        <li class="covered" data-hits="427" data-linenumber="62">
          <span class="hits">427</span>
          
          <code class="ruby">        sig_str = &quot;&quot;; sig[1].split('').each_with_index{|c,i| sig_str &lt;&lt; (i % 80 == 0 ? &quot;\n#{c}&quot; : c)}</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="63">
          <span class="hits">3</span>
          
          <code class="ruby">        lines &lt;&lt; sig_str.strip</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="66">
          <span class="hits">4</span>
          
          <code class="ruby">    lines &lt;&lt; &quot;-------END-TRANSACTION-#{@id}&quot;.ljust(80, '-')</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="67">
          <span class="hits">4</span>
          
          <code class="ruby">    lines.join(&quot;\n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse str</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="71">
          <span class="hits">5</span>
          
          <code class="ruby">    str.match(/-+BEGIN-TRANSACTION-(.*?)-+$(.*?)END-TRANSACTION-#{$1}/m) do |m|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="72">
          <span class="hits">5</span>
          
          <code class="ruby">      _, id, content = *m</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="73">
          <span class="hits">5</span>
          
          <code class="ruby">      txdist, *inputs = content.split(/_TXINPUT_/)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="74">
          <span class="hits">5</span>
          
          <code class="ruby">      @id = id</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="75">
          <span class="hits">5</span>
          
          <code class="ruby">      @txdist = parse_txdist(txdist)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="76">
          <span class="hits">11</span>
          
          <code class="ruby">      inputs.each {|input| parse_input(input) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="78">
          <span class="hits">5</span>
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_txdist txdist</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="82">
          <span class="hits">5</span>
          
          <code class="ruby">    _, magic, txdp_id, size, serialized_tx = *txdist.match(/_TXDIST_(.*?)_(.*?)_(.*?)$(.*)/m)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="83">
          <span class="hits">5</span>
          
          <code class="ruby">    raise &quot;Wrong network magic&quot;  unless [magic].pack(&quot;H*&quot;) == Bitcoin.network[:magic_head]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="84">
          <span class="hits">5</span>
          
          <code class="ruby">    tx = Bitcoin::P::Tx.new(nil)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="85">
          <span class="hits">5</span>
          
          <code class="ruby">    rest = [serialized_tx.gsub!(&quot;\n&quot;, '')].pack(&quot;H*&quot;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="86">
          <span class="hits">5</span>
          
          <code class="ruby">    while rest = tx.parse_data(rest)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="87">
          <span class="hits">11</span>
          
          <code class="ruby">      @tx &lt;&lt; tx</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="88">
          <span class="hits">11</span>
          
          <code class="ruby">      break  if rest == true</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="89">
          <span class="hits">6</span>
          
          <code class="ruby">      tx = Bitcoin::P::Tx.new(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_input input</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="94">
          <span class="hits">6</span>
          
          <code class="ruby">    m = input.match(/(\d+)_(\d+\.\d+)\n(.*)/m)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="95">
          <span class="hits">6</span>
          
          <code class="ruby">    _, idx, value, sigs = *m</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="96">
          <span class="hits">6</span>
          
          <code class="ruby">    value = (value.sub('.','').to_i)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="97">
          <span class="hits">6</span>
          
          <code class="ruby">    sigs = parse_sigs(sigs)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="98">
          <span class="hits">6</span>
          
          <code class="ruby">    @inputs[idx.to_i] = [value, sigs]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_sigs sigs</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="102">
          <span class="hits">6</span>
          
          <code class="ruby">    return nil  unless sigs[&quot;_SIG_&quot;]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="103">
          <span class="hits">4</span>
          
          <code class="ruby">    sigs = sigs.split(&quot;_SIG_&quot;).map do |s|</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="104">
          <span class="hits">8</span>
          
          <code class="ruby">      if s == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="105">
          <span class="hits">4</span>
          
          <code class="ruby">        nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="107">
          <span class="hits">4</span>
          
          <code class="ruby">        m = s.match(/(.*?)_(\d+)_(.*?)\n(.*)/m)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="108">
          <span class="hits">4</span>
          
          <code class="ruby">        [$1, $4.gsub(&quot;\n&quot;, '').gsub('-', '')]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.parse str</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="114">
          <span class="hits">5</span>
          
          <code class="ruby">    new.parse str</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5f86fc73b1d974c21d9992a33e59689fa75b4089">
  <div class="header">
    <h3>lib/bitcoin/wallet/wallet.rb</h3>
    <h4><span class="red">62.39 %</span> covered</h4>
    <div>
      <b>117</b> relevant lines. 
      <span class="green"><b>73</b> lines covered</span> and
      <span class="red"><b>44</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">Bitcoin.require_dependency :eventmachine, exit: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># The wallet implementation consists of several concepts:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># Wallet::             the high-level API used to manage a wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># SimpleKeyStore::     key store to manage keys/addresses/labels</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># SimpleCoinSelector:: coin selector to find unspent outputs to use when creating tx</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">module Bitcoin::Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # A wallet manages a set of keys (through a +keystore+), can</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # list transactions/balances for those keys (using a Storage backend for</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # blockchain data).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # It can also create transactions with various kinds of outputs and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # connect with a CommandClient to relay those transactions through a node.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # TODO: new tx notification, keygenerators, keystore cleanup</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  class Wallet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    include Bitcoin::Builder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # the keystore (SimpleKeyStore) managing keys/addresses/labels</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :keystore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # the Storage which holds the blockchain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :storage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    # open wallet with given +storage+ Storage backend, +keystore+ SimpleKeyStore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # and +selector+ SimpleCoinSelector</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize storage, keystore, selector</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="29">
          <span class="hits">14</span>
          
          <code class="ruby">      @storage = storage</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="30">
          <span class="hits">14</span>
          
          <code class="ruby">      @keystore = keystore</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="31">
          <span class="hits">14</span>
          
          <code class="ruby">      @selector = selector</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="32">
          <span class="hits">14</span>
          
          <code class="ruby">      @callbacks = {}</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="33">
          <span class="hits">14</span>
          
          <code class="ruby">      connect_node  if defined?(EM)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect_node</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="37">
          <span class="hits">14</span>
          
          <code class="ruby">      return  unless EM.reactor_running?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      host, port = &quot;127.0.0.1&quot;, 9999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      @node = Bitcoin::Network::CommandClient.connect(host, port, self, @storage) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        on_connected { request :monitor, &quot;block&quot;, &quot;tx&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        on_block do |block, depth|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          EM.defer do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">            block['tx'].each do |tx|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">              relevant, tx = @args[0].check_tx(tx['hash'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">              @args[0].callback(:tx, :confirmed, tx)  if relevant</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        on_tx do |response|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">          EM.defer do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">            relevant, tx = @args[0].check_tx(response['hash'])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">            @args[0].callback(:tx, relevant, tx)  if relevant</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    def check_tx tx_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      relevant = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      addrs = addrs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      tx = @storage.get_tx(tx_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      unless tx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        log.warn { &quot;Received tx #{response['hash']} but not found in storage&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        binding.pry</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      addrs = @keystore.keys.map {|k| k[:addr] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      tx.out.each do |txout|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        return :incoming, tx  if (txout.get_addresses &amp; addrs).any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      tx.in.each do |txin|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        next unless  prev_out = txin.get_prev_out</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        return :outgoing, tx  if (prev_out.get_addresses &amp; addrs).any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    def log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">      return @log  if @log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      @log = Bitcoin::Logger.create(&quot;wallet&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      @log.level = :debug</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      @log</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    # call the callback specified by +name+ passing in +args+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    def callback name, *args</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      cb = @callbacks[name.to_sym]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      return  unless cb</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      log.debug { &quot;callback: #{name}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      cb.call(*args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    # register callback methods</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">    def method_missing(name, *args, &amp;block)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      if name =~ /^on_/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        @callbacks[name.to_s.split(&quot;on_&quot;)[1].to_sym] = block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        log.debug { &quot;callback #{name} registered&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        super(name, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    # get all Storage::Models::TxOut concerning any address from this wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_txouts(unconfirmed = false)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="106">
          <span class="hits">16</span>
          
          <code class="ruby">      txouts = @keystore.keys.map {|k|</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="107">
          <span class="hits">18</span>
          
          <code class="ruby">        @storage.get_txouts_for_address(k[:addr])}.flatten.uniq</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="108">
          <span class="hits">32</span>
          
          <code class="ruby">      unconfirmed ? txouts : txouts.select {|o| !!o.get_tx.get_block}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    # get total balance for all addresses in this wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_balance(unconfirmed = false)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="113">
          <span class="hits">6</span>
          
          <code class="ruby">      values = get_txouts(unconfirmed).select{|o| !o.get_next_in}.map(&amp;:value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="115">
          <span class="hits">3</span>
          
          <code class="ruby">      ([0] + values).inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    # list all addresses in this wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    def addrs</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="120">
          <span class="hits">18</span>
          
          <code class="ruby">      @keystore.keys.map{|k| k[:addr]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    # add +key+ to wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_key key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      @keystore.add_key(key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    # set label for key +old+ to +new+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    def label old, new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      @keystore.label_key(old, new)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    # set +flag+ for key +name+ to +value+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">    def flag name, flag, value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">      @keystore.flag_key(name, flag, value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    # list all keys along with their balances</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">    def list</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="140">
          <span class="hits">2</span>
          
          <code class="ruby">      @keystore.keys.map do |key|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="141">
          <span class="hits">2</span>
          
          <code class="ruby">        [key, @storage.get_balance(Bitcoin.hash160_from_address(key[:addr]))]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    # create new key and return its address</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_new_addr</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">      @keystore.new_key.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    # get SimpleCoinSelector with txouts for this wallet</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_selector</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="152">
          <span class="hits">13</span>
          
          <code class="ruby">      @selector.new(get_txouts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">    # create a transaction with given +outputs+, +fee+ and +change_policy+.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    # outputs are of the form</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    #  [&lt;type&gt;, &lt;recipients&gt;, &lt;value&gt;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    # examples:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    #  [:address, &lt;addr&gt;, &lt;value&gt;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    #  [:multisig, 2, 3, &lt;addr&gt;, &lt;addr&gt;, &lt;addr&gt;, &lt;value&gt;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    # inputs are selected automatically by the SimpleCoinSelector.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">    # </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    # change_policy controls where the change_output is spent to.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    # see #get_change_addr</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">    def new_tx outputs, fee = 0, change_policy = :back</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="168">
          <span class="hits">26</span>
          
          <code class="ruby">      output_value = outputs.map{|o|o[-1]}.inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="170">
          <span class="hits">13</span>
          
          <code class="ruby">      prev_outs = get_selector.select(output_value)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="171">
          <span class="hits">13</span>
          
          <code class="ruby">      return nil  if !prev_outs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="173">
          <span class="hits">13</span>
          
          <code class="ruby">      input_value = prev_outs.map(&amp;:value).inject(:+)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="174">
          <span class="hits">13</span>
          
          <code class="ruby">      return nil  unless input_value &gt;= (output_value + fee)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="176">
          <span class="hits">12</span>
          
          <code class="ruby">      tx = tx do |t|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="177">
          <span class="hits">12</span>
          
          <code class="ruby">        outputs.each do |type, *addrs, value|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="178">
          <span class="hits">12</span>
          
          <code class="ruby">          t.output do |o|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="179">
          <span class="hits">12</span>
          
          <code class="ruby">            o.value value</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="180">
          <span class="hits">12</span>
          
          <code class="ruby">            o.script do |s|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="181">
          <span class="hits">12</span>
          
          <code class="ruby">              s.type type</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="182">
          <span class="hits">12</span>
          
          <code class="ruby">              s.recipient *addrs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="187">
          <span class="hits">12</span>
          
          <code class="ruby">        change_value = input_value - output_value - fee</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="188">
          <span class="hits">12</span>
          
          <code class="ruby">        if change_value &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="189">
          <span class="hits">12</span>
          
          <code class="ruby">          change_addr = get_change_addr(change_policy, prev_outs.sample.get_address)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="190">
          <span class="hits">12</span>
          
          <code class="ruby">          t.output do |o|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="191">
          <span class="hits">12</span>
          
          <code class="ruby">            o.value change_value</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="192">
          <span class="hits">12</span>
          
          <code class="ruby">            o.script do |s|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="193">
          <span class="hits">12</span>
          
          <code class="ruby">              s.type :address</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="194">
          <span class="hits">12</span>
          
          <code class="ruby">              s.recipient change_addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="199">
          <span class="hits">12</span>
          
          <code class="ruby">        prev_outs.each_with_index do |prev_out, idx|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="200">
          <span class="hits">12</span>
          
          <code class="ruby">          t.input do |i|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="201">
          <span class="hits">12</span>
          
          <code class="ruby">            prev_tx = prev_out.get_tx</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="202">
          <span class="hits">12</span>
          
          <code class="ruby">            i.prev_out prev_tx</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="203">
          <span class="hits">12</span>
          
          <code class="ruby">            i.prev_out_index prev_tx.out.index(prev_out)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="204">
          <span class="hits">12</span>
          
          <code class="ruby">            pk_script = Bitcoin::Script.new(prev_out.pk_script)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="205">
          <span class="hits">12</span>
          
          <code class="ruby">            if pk_script.is_pubkey? || pk_script.is_hash160?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="206">
          <span class="hits">12</span>
          
          <code class="ruby">              i.signature_key @keystore.key(prev_out.get_address)[:key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">            elsif pk_script.is_multisig?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">              raise &quot;multisig not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      # TODO: spend multisig outputs again</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">      # TODO: verify signatures</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="215">
          <span class="hits">12</span>
          
          <code class="ruby">      Bitcoin::Protocol::Tx.new(tx.to_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    # get address to send change output to.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">    # +policy+ controls which address is chosen:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    # first:: send to the first key in the wallets keystore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">    # random:: send to a random key from the wallets keystore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">    # new:: send to a new key generated in the wallets keystore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    # back:: send to the address given as +in_addr+</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="226">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_change_addr(policy, in_addr)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="227">
          <span class="hits">12</span>
          
          <code class="ruby">      case policy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">      when :first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">        @keystore.keys[0].addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      when :random</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">        @keystore.keys.sample.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">      when :new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">        @keystore.new_key.addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">      when :back</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="235">
          <span class="hits">10</span>
          
          <code class="ruby">        in_addr</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">        policy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
      </div>
    </div>
  </body>
</html>
