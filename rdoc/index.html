<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body>
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./COPYING.html">COPYING</a>
  
    <li class="file"><a href="./README.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./Bitcoin.html">Bitcoin</a>
  
    <li><a href="./Bitcoin/Connection.html">Bitcoin::Connection</a>
  
    <li><a href="./Bitcoin/ConnectionHandler.html">Bitcoin::ConnectionHandler</a>
  
    <li><a href="./Bitcoin/Key.html">Bitcoin::Key</a>
  
    <li><a href="./Bitcoin/KeyGenerator.html">Bitcoin::KeyGenerator</a>
  
    <li><a href="./Bitcoin/Logger.html">Bitcoin::Logger</a>
  
    <li><a href="./Bitcoin/Logger/LogWrapper.html">Bitcoin::Logger::LogWrapper</a>
  
    <li><a href="./Bitcoin/Logger/Logger.html">Bitcoin::Logger::Logger</a>
  
    <li><a href="./Bitcoin/Network.html">Bitcoin::Network</a>
  
    <li><a href="./Bitcoin/Network/CommandHandler.html">Bitcoin::Network::CommandHandler</a>
  
    <li><a href="./Bitcoin/Network/ConnectionHandler.html">Bitcoin::Network::ConnectionHandler</a>
  
    <li><a href="./Bitcoin/Network/Node.html">Bitcoin::Network::Node</a>
  
    <li><a href="./Bitcoin/OpenSSL_EC.html">Bitcoin::OpenSSL_EC</a>
  
    <li><a href="./Bitcoin/Protocol.html">Bitcoin::P</a>
  
    <li><a href="./Bitcoin/Protocol.html">Bitcoin::Protocol</a>
  
    <li><a href="./Bitcoin/Protocol/Addr.html">Bitcoin::Protocol::Addr</a>
  
    <li><a href="./Bitcoin/Protocol/Block.html">Bitcoin::Protocol::Block</a>
  
    <li><a href="./Bitcoin/Protocol/Handler.html">Bitcoin::Protocol::Handler</a>
  
    <li><a href="./Bitcoin/Protocol/Parser.html">Bitcoin::Protocol::Parser</a>
  
    <li><a href="./Bitcoin/Protocol/Tx.html">Bitcoin::Protocol::Tx</a>
  
    <li><a href="./Bitcoin/Protocol/TxIn.html">Bitcoin::Protocol::TxIn</a>
  
    <li><a href="./Bitcoin/Protocol/TxOut.html">Bitcoin::Protocol::TxOut</a>
  
    <li><a href="./Bitcoin/Protocol/VersionPkt.html">Bitcoin::Protocol::VersionPkt</a>
  
    <li><a href="./Bitcoin/Script.html">Bitcoin::Script</a>
  
    <li><a href="./Bitcoin/Storage.html">Bitcoin::Storage</a>
  
    <li><a href="./Bitcoin/Storage/Backends.html">Bitcoin::Storage::Backends</a>
  
    <li><a href="./Bitcoin/Storage/Backends/ActiverecordStore.html">Bitcoin::Storage::Backends::ActiverecordStore</a>
  
    <li><a href="./Bitcoin/Storage/Backends/ActiverecordStore/Base.html">Bitcoin::Storage::Backends::ActiverecordStore::Base</a>
  
    <li><a href="./Bitcoin/Storage/Backends/ActiverecordStore/Block.html">Bitcoin::Storage::Backends::ActiverecordStore::Block</a>
  
    <li><a href="./Bitcoin/Storage/Backends/ActiverecordStore/Input.html">Bitcoin::Storage::Backends::ActiverecordStore::Input</a>
  
    <li><a href="./Bitcoin/Storage/Backends/ActiverecordStore/Output.html">Bitcoin::Storage::Backends::ActiverecordStore::Output</a>
  
    <li><a href="./Bitcoin/Storage/Backends/ActiverecordStore/Transaction.html">Bitcoin::Storage::Backends::ActiverecordStore::Transaction</a>
  
    <li><a href="./Bitcoin/Storage/Backends/ActiverecordStore/TransactionsParent.html">Bitcoin::Storage::Backends::ActiverecordStore::TransactionsParent</a>
  
    <li><a href="./Bitcoin/Storage/Backends/DummyStore.html">Bitcoin::Storage::Backends::DummyStore</a>
  
    <li><a href="./Bitcoin/Storage/Backends/SequelMigrations.html">Bitcoin::Storage::Backends::SequelMigrations</a>
  
    <li><a href="./Bitcoin/Storage/Backends/SequelStore.html">Bitcoin::Storage::Backends::SequelStore</a>
  
    <li><a href="./Bitcoin/Storage/Backends/StorageModel.html">Bitcoin::Storage::Backends::StorageModel</a>
  
    <li><a href="./Bitcoin/Storage/Backends/StoreBase.html">Bitcoin::Storage::Backends::StoreBase</a>
  
    <li><a href="./Bitcoin/Storage/Models.html">Bitcoin::Storage::Models</a>
  
    <li><a href="./Bitcoin/Storage/Models/Block.html">Bitcoin::Storage::Models::Block</a>
  
    <li><a href="./Bitcoin/Storage/Models/Tx.html">Bitcoin::Storage::Models::Tx</a>
  
    <li><a href="./Bitcoin/Storage/Models/TxIn.html">Bitcoin::Storage::Models::TxIn</a>
  
    <li><a href="./Bitcoin/Storage/Models/TxOut.html">Bitcoin::Storage::Models::TxOut</a>
  
    <li><a href="./Bitcoin/Util.html">Bitcoin::Util</a>
  
    <li><a href="./OpenSSL.html">OpenSSL</a>
  
    <li><a href="./OpenSSL/BN.html">OpenSSL::BN</a>
  
    <li><a href="./OpenSSL/PKey.html">OpenSSL::PKey</a>
  
    <li><a href="./OpenSSL/PKey/EC.html">OpenSSL::PKey::EC</a>
  
    <li><a href="./OpenSSL/PKey/EC/Point.html">OpenSSL::PKey::EC::Point</a>
  
    <li><a href="./Log4r.html">Log4r</a>
  
    <li><a href="./Log4r/Logger.html">Log4r::Logger</a>
  
    <li><a href="./Array.html">Array</a>
  
    <li><a href="./Chain.html">Chain</a>
  
    <li><a href="./Hash.html">Hash</a>
  
    <li><a href="./InventoryRequest.html">InventoryRequest</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation" class="description">
  
<h1 id="label-Bitcoin-ruby">Bitcoin-ruby</h1>

<p>This is a ruby library for interacting with the bitcoin protocol/network.
It can parse and generate protocol messages, run basic scripts, connect to
other peers and download and store the blockchain (WITHOUT verification
yet!).</p>

<h2 id="label-Installation">Installation</h2>

<p>We assume you already have a ruby 1.9 compatible interpreter and rubygems
environment.</p>

<pre>git clone https://github.com/lian/bitcoin-ruby.git; cd bitcoin-ruby
ruby -Ilib bin/bitcoin_connect</pre>

<p>Note that some aspects of the library (such as networking, or storage) may
need additional dependencies which are not specified in the gemspec. You’ll
find out what’s missing once it fails when you try to use it ;)</p>

<h2 id="label-Demos">Demos</h2>

<p>There are a few demo scripts you can run to try things out:</p>

<h3 id="label-bin%2Fbitcoin_connect">bin/bitcoin_connect</h3>

<p>Connect to a network node and chat a little.</p>

<h3 id="label-bin%2Fbitcoin_blockchain">bin/bitcoin_blockchain</h3>

<p>Connect to a node and download the whole blockchain into storage.</p>

<pre>./bin/bitcoin_blockchain # connects to testnet using dummy store
./bin/bitcoin_blockchain -n bitcoin -s sequel::postgres///bitcoin
./bin/bitcoin_blockchain -h</pre>

<h3 id="label-bin%2Fbitcoin_verify_tx">bin/bitcoin_verify_tx</h3>

<p>Fetch a transaction and all its prev_outs from local storage and verify the
signatures.</p>

<pre>./bin/bitcoin_verify_tx [options] &lt;tx_hash&gt;
./bin/bitcoin_verify_tx -s sequel::postgres:///bitcoin 0f6741210a02e196ca5f5ad17f684968623546c1accdbcb701a668a51a7ba9fd</pre>

<p>Note: For this to work, you obviously need to have the transactions in your
storage.</p>

<h3 id="label-bin%2Fbbe_verify_tx">bin/bbe_verify_tx</h3>

<p>In case you don’t have a local storage, this script fetches a transaction
and all its prev_outs from blockexplorer.com and verifies the signatures.</p>

<pre>./bin/bbe_verify_tx &lt;tx_hash&gt; [testnet]</pre>

<h3 id="label-bin%2Fbitcoin_balance">bin/bitcoin_balance</h3>

<p>Collect transactions and display balance for an address.</p>

<pre>./bin/bitcoin_balance -s sequel::postgres:///bitcoin -l moz14kFmgHPszRvS6rvhfEVYmx4RbcNMfH</pre>

<h3 id="label-bin%2Fbitcoin_shell">bin/bitcoin_shell</h3>

<p>Launches an irb session with bitcoin loaded where you can try stuff out.</p>

<h3 id="label-Storage+Backends">Storage Backends</h3>

<p>For examples that require storage backends, you can specify them using a
string containing the backend name and a configuration string. The default
backend is always ‘dummy’ which needs no configuration</p>

<pre>dummy
sequel::sqlite:///tmp/bitcoin.db
sequel::postgres:///bitcoin
sequel::postgres://user:pass@host/database</pre>

<h2 id="label-Library+Usage">Library Usage</h2>

<p>There are different aspects to the library which can be used separately or
in combination. Here are some examples of what you could do.</p>

<h3 id="label-Keys+%2F+Addresses">Keys / Addresses</h3>

<p>Generate a key:</p>

<pre class="ruby"><span class="ruby-identifier">key</span> = <span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-identifier">generate_key</span>
<span class="ruby-identifier">key</span> <span class="ruby-comment">#=&gt; [&lt;privkey&gt;, &lt;pubkey&gt;]</span>
</pre>

<p>Get the address from a public key</p>

<pre class="ruby"><span class="ruby-identifier">address</span> = <span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-identifier">pubkey_to_address</span>(<span class="ruby-identifier">key</span>[<span class="ruby-value">1</span>])
<span class="ruby-identifier">address</span> <span class="ruby-comment">#=&gt; &lt;bitcoin address&gt;</span>
</pre>

<p>Check if an address is valid</p>

<pre class="ruby"><span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-identifier">valid_address?</span>(<span class="ruby-identifier">address</span>) <span class="ruby-comment">#=&gt; true</span>
</pre>

<h3 id="label-Blocks+%2F+Transactions+parsing">Blocks / Transactions parsing</h3>

<p>Parse a block</p>

<pre class="ruby"><span class="ruby-identifier">raw_block</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">'spec/bitcoin/fixtures/rawblock-0.bin'</span>, <span class="ruby-string">'rb'</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>}
<span class="ruby-identifier">blk</span> = <span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-constant">Protocol</span><span class="ruby-operator">::</span><span class="ruby-constant">Block</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">raw_block</span>)
<span class="ruby-identifier">blk</span>.<span class="ruby-identifier">hash</span> <span class="ruby-comment">#=&gt; 00000000839a8e6886ab5951d76f411475428afc90947ee320161bbf18eb6048</span>
<span class="ruby-identifier">blk</span>.<span class="ruby-identifier">tx</span>.<span class="ruby-identifier">count</span> <span class="ruby-comment">#=&gt; 1</span>
<span class="ruby-identifier">blk</span>.<span class="ruby-identifier">to_hash</span> <span class="ruby-comment">#=&gt; ...</span>
<span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-constant">Protocol</span><span class="ruby-operator">::</span><span class="ruby-constant">Block</span>.<span class="ruby-identifier">from_json</span>( <span class="ruby-identifier">blk</span>.<span class="ruby-identifier">to_json</span> )
</pre>

<p>Parse a transaction</p>

<pre class="ruby"><span class="ruby-identifier">raw_tx</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">'spec/bitcoin/fixtures/rawtx-01.bin'</span>, <span class="ruby-string">'rb'</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>}
<span class="ruby-identifier">tx</span> = <span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-constant">Protocol</span><span class="ruby-operator">::</span><span class="ruby-constant">Tx</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">raw_tx</span>)
<span class="ruby-identifier">tx</span>.<span class="ruby-identifier">hash</span> <span class="ruby-comment">#=&gt; 6e9dd16625b62cfcd4bf02edb89ca1f5a8c30c4b1601507090fb28e59f2d02b4</span>
<span class="ruby-identifier">tx</span>.<span class="ruby-identifier">in</span>.<span class="ruby-identifier">size</span> <span class="ruby-comment">#=&gt; 1</span>
<span class="ruby-identifier">tx</span>.<span class="ruby-identifier">out</span>.<span class="ruby-identifier">size</span> <span class="ruby-comment">#=&gt; 2</span>
<span class="ruby-identifier">tx</span>.<span class="ruby-identifier">to_hash</span> <span class="ruby-comment">#=&gt; ...</span>
<span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-constant">Protocol</span><span class="ruby-operator">::</span><span class="ruby-constant">Tx</span>.<span class="ruby-identifier">from_json</span>( <span class="ruby-identifier">tx</span>.<span class="ruby-identifier">to_json</span> )

<span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-constant">Script</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">tx</span>.<span class="ruby-identifier">out</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">pk_script</span>).<span class="ruby-identifier">to_string</span>
<span class="ruby-comment">#=&gt; &quot;OP_DUP OP_HASH160 b2e21c1db922e3bdc529de7b38b4c401399e9afd OP_EQUALVERIFY OP_CHECKSIG&quot;</span>
</pre>

<h3 id="label-Transaction+verification+%2F+Scripts">Transaction verification / Scripts</h3>

<p>Get the matching transactions (in this example tx1 is the spending
transaction)</p>

<pre class="ruby"><span class="ruby-identifier">rawtx1</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;spec/bitcoin/fixtures/rawtx-f4184fc596403b9d638783cf57adfe4c75c605f6356fbc91338530e9831e9e16.bin&quot;</span>, <span class="ruby-string">'rb'</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>}
<span class="ruby-identifier">rawtx2</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;spec/bitcoin/fixtures/rawtx-0437cd7f8525ceed2324359c2d0ba26006d92d856a9c20fa0241106ee5a597c9.bin&quot;</span>, <span class="ruby-string">'rb'</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>}
<span class="ruby-identifier">tx1</span> = <span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-constant">Protocol</span><span class="ruby-operator">::</span><span class="ruby-constant">Tx</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">rawtx1</span>)
<span class="ruby-identifier">tx2</span> = <span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-constant">Protocol</span><span class="ruby-operator">::</span><span class="ruby-constant">Tx</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">rawtx2</span>)
</pre>

<p>Then simply ask the transaction to verify an input</p>

<pre class="ruby"><span class="ruby-identifier">tx1</span>.<span class="ruby-identifier">verify_input_signature</span>(<span class="ruby-value">0</span>, <span class="ruby-identifier">tx2</span>) <span class="ruby-comment">#=&gt; true</span>
</pre>

<p>Or, if you want to control the script yourself</p>

<pre class="ruby"><span class="ruby-identifier">txin</span> = <span class="ruby-identifier">tx1</span>.<span class="ruby-identifier">in</span>.<span class="ruby-identifier">first</span>
<span class="ruby-identifier">txout</span> = <span class="ruby-identifier">tx2</span>.<span class="ruby-identifier">out</span>[<span class="ruby-identifier">txin</span>.<span class="ruby-identifier">prev_out_index</span>]
<span class="ruby-identifier">script</span> = <span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-constant">Script</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">txin</span>.<span class="ruby-identifier">script_sig</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">txout</span>.<span class="ruby-identifier">pk_script</span>)

<span class="ruby-identifier">result</span> = <span class="ruby-identifier">script</span>.<span class="ruby-identifier">run</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pubkey</span>, <span class="ruby-identifier">sig</span>, <span class="ruby-identifier">hash_type</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">hash</span> = <span class="ruby-identifier">tx1</span>.<span class="ruby-identifier">signature_hash_for_input</span>(<span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">txout</span>.<span class="ruby-identifier">pk_script</span>)
  <span class="ruby-constant">Bitcoin</span>.<span class="ruby-identifier">verify_signature</span>(<span class="ruby-identifier">hash</span>, <span class="ruby-identifier">sig</span>, <span class="ruby-identifier">pubkey</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-string">&quot;H*&quot;</span>)[<span class="ruby-value">0</span>])
<span class="ruby-keyword">end</span>
<span class="ruby-identifier">result</span> <span class="ruby-comment">#=&gt; true</span>
</pre>

<h3 id="label-Node+%2F+Network+connections">Node / Network connections</h3>

<p>The networking part is still work in progress. For now, you’ll probably
want to roll your own; see connection.rb or network/node.rb for examples.</p>

<h3 id="label-Storage+%2F+Database+backends">Storage / Database backends</h3>

<p>There are multiple database backends available, currently an in-memory
dummy and  and activerecord/postgres backend.</p>

<pre class="ruby"><span class="ruby-identifier">store</span> = <span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-constant">Storage</span>.<span class="ruby-identifier">dummy</span>  <span class="ruby-comment"># or:</span>
<span class="ruby-identifier">store</span> = <span class="ruby-constant">Bitcoin</span><span class="ruby-operator">::</span><span class="ruby-constant">Storage</span>.<span class="ruby-identifier">sequel</span>(:<span class="ruby-identifier">db</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;postgres:///bitcoin&quot;</span>)
<span class="ruby-identifier">store</span>.<span class="ruby-identifier">store_block</span>(<span class="ruby-constant">Bitcoin</span>.<span class="ruby-identifier">network</span>[:<span class="ruby-identifier">genesis_block</span>])
<span class="ruby-identifier">store</span>.<span class="ruby-identifier">get_block</span>(<span class="ruby-constant">Bitcoin</span>.<span class="ruby-identifier">network</span>[:<span class="ruby-identifier">genesis_hash</span>])
<span class="ruby-identifier">store</span>.<span class="ruby-identifier">get_head</span> <span class="ruby-comment">#=&gt; Bitcoin.network[:genesis_hash]</span>
</pre>

<h2 id="label-Documentation">Documentation</h2>

<p>Still needs some love, but you can generate RDoc documentation</p>

<pre>rake rdoc</pre>

<p>The specs are also a good place to see how something works.</p>

<h2 id="label-Specs">Specs</h2>

<p>The specs can be run with</p>

<pre>rake bacon</pre>

<p>or, if you want to run a single spec</p>

<pre>ruby spec/bitcoin/bitcoin_spec.rb</pre>

<p>If you make changes to the code or add functionality, please also add
specs.</p>

<h2 id="label-Development">Development</h2>

<p>If you are curious or like to participate in development, drop by
#bitcoin-ruby on irc.freenode.net!</p>

</div>


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

